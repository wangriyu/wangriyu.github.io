<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>Jenkins + Ansible 实现 Golang 自动化编译部署</title>
      <link href="/2018/08-Jenkins.html"/>
      <url>/2018/08-Jenkins.html</url>
      <content type="html"><![CDATA[<blockquote><p>环境:</p><blockquote><ul><li>本机(local): Mac OS 10.13</li><li>跳板机(jenkins): Ubuntu 14.04</li><li>目标机(servers): Ubuntu 14.04</li></ul></blockquote></blockquote><h2 id="项目说明"><a href="#项目说明" class="headerlink" title="项目说明"></a>项目说明</h2><p>项目目录下至少需要三块文件:</p><ul><li>hosts: 用于指定 ansible 插件作用的目标服务器</li></ul><p>比如下面指定了两组服务器，在 jenkins 的 servers 参数中可以选择某一组(‘dev’、’prod’)也可以用 ‘all’ 或 ‘*’ 代表所有服务器</p><pre class="line-numbers language-plain"><code class="language-plain">[dev] // 组名10.9.X.A ansible_connection=ssh ansible_ssh_user=work[prod]10.42.X.B ansible_connection=ssh ansible_ssh_user=work10.42.X.C ansible_connection=ssh ansible_ssh_user=work<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>pm2.json: 用于在目标服务器上设置 pm2 守护程序</li></ul><p>比如</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"sandiego"</span><span class="token punctuation">,</span> // 项目名  <span class="token property">"script"</span><span class="token operator">:</span> <span class="token string">"sandiego"</span><span class="token punctuation">,</span> // 运行文件，因为最后一般是把可执行文件和 pm2.json 放在同一目录，指定编译后的文件名即可，需要和 jenkins 当中的参数一致  <span class="token property">"error_file"</span><span class="token operator">:</span> <span class="token string">"log/error.log"</span><span class="token punctuation">,</span>  <span class="token property">"out_file"</span><span class="token operator">:</span> <span class="token string">"log/out.log"</span><span class="token punctuation">,</span>  <span class="token property">"instances"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"exec_interpreter"</span><span class="token operator">:</span> <span class="token string">"none"</span><span class="token punctuation">,</span>  <span class="token property">"exec_mode"</span><span class="token operator">:</span> <span class="token string">"fork"</span><span class="token punctuation">,</span>  <span class="token property">"merge_logs"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>vendor 目录: 在 jenkins 服务器上编译时需要此目录中的依赖，请保证项目编译所需均在此并上传 git 远程仓库。可以用 dep 命令解决</li></ul><blockquote><p>注意事项: 最好在项目根目录有一个编译入口文件，比如 main.go，编译时会在项目根目录 build；另外如果代码中引用相对路径的文件，最好是同级或子目录里的，如果出现 “../path/config.file” 这样的上层目录引用，后面处理会麻烦点</p></blockquote><p>比如:</p><pre class="line-numbers language-bash"><code class="language-bash">$ tree <span class="token variable">$GOPATH</span>/src/sandiego├── cgo│   ├── cgo.go│   ├── demo.cpp│   └── demo.h├── Gopkg.lock├── Gopkg.toml├── main.go├── hosts├── pm2.json└── vendor/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果项目结构不是这样，则需要适当修改 jenkins 的编译和部署脚本</p><h2 id="跳板机安装-JDK-如果有则跳过"><a href="#跳板机安装-JDK-如果有则跳过" class="headerlink" title="跳板机安装 JDK (如果有则跳过)"></a>跳板机安装 JDK (如果有则跳过)</h2><p>添加源</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> add-apt-repository ppa:webupd8team/java$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>安装 jdk8</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> oracle-java8-installer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>设置系统默认 jdk</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> update-java-alternatives -s java-8-oracle<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>测试 jdk</p><pre class="line-numbers language-bash"><code class="language-bash">$ java -version$ javac -version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="安装-Jenkins"><a href="#安装-Jenkins" class="headerlink" title="安装 Jenkins"></a>安装 Jenkins</h2><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">wget</span> -q -O - http://pkg.jenkins-ci.org/debian/jenkins-ci.org.key <span class="token operator">|</span> <span class="token function">sudo</span> apt-key add -$ <span class="token function">sudo</span> sh -c <span class="token string">'echo deb http://pkg.jenkins-ci.org/debian binary/ > /etc/apt/sources.list.d/jenkins.list'</span>$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> jenkins<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>访问端口：8080</li><li>安装目录：/var/lib/jenkins</li><li>日志目录：/var/log/jenkins/jenkins.log</li></ul><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 开启</span>$ <span class="token function">sudo</span> <span class="token function">service</span> jenkins start <span class="token comment" spellcheck="true"># sudo /etc/init.d/jenkins start</span><span class="token comment" spellcheck="true"># 关闭</span>$ <span class="token function">sudo</span> <span class="token function">service</span> jenkins stop <span class="token comment" spellcheck="true"># sudo /etc/init.d/jenkins stop</span><span class="token comment" spellcheck="true"># 重启</span>$ <span class="token function">sudo</span> <span class="token function">service</span> jenkins restart <span class="token comment" spellcheck="true"># sudo /etc/init.d/jenkins restart</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>更改 jenkins 目录(可选)</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">chown</span> -R jenkins:jenkins /home/work/jenkins$ <span class="token function">sudo</span> <span class="token function">vi</span> /etc/profile 中添加 <span class="token function">export</span> JENKINS_HOME<span class="token operator">=</span>/home/work/jenkins$ <span class="token function">sudo</span> <span class="token function">service</span> jenkins restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="设置-Jenkins"><a href="#设置-Jenkins" class="headerlink" title="设置 Jenkins"></a>设置 Jenkins</h2><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>访问 ip:8080 访问配置页面，初始化时需要传入初始管理员密钥，可以到跳板机上查看 <code>/var/log/jenkins/jenkins.log</code> 或者 <code>/var/lib/jenkins/secrets/initialAdminPassword</code> 获取</p><h3 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h3><p>配置完管理员账号后进入主页面，点击 manage jenkins &gt; manage plugins 进入插件安装页面</p><p><img src="https://src.wangriyu.wang/images/blog/jenkins/plugins.png" alt="plugins"></p><p>搜索并安装 <strong>Go 插件</strong>、<strong>Ansible 插件</strong>、<strong>AnsiColor 插件</strong>、<strong>Blue Ocean 插件</strong>，最后重启一下 Jenkins 服务</p><h3 id="配置插件"><a href="#配置插件" class="headerlink" title="配置插件"></a>配置插件</h3><p>1、点击 manage jenkins &gt; global tool configuration 找到 Go 插件配置:</p><p><img src="https://src.wangriyu.wang/images/blog/jenkins/configure-go.png" alt="configure-go"></p><p>添加相应版本的 GOSDK，这里可以设置多个不同版本，之后项目中可以通过 name 选择</p><hr><p>2、在跳板机上执行 <code>ssh-keygen -t rsa</code> 生成密钥对，默认会放在 <code>~/.ssh/</code> 里，将公钥 id_rsa.pub 的内容追加进所有目标机的 <code>~/.ssh/authorized_keys</code> 文件中（可以使用 <a href="https://www.ssh.com/ssh/copy-id" target="_blank" rel="noopener">ssh-copy-id</a> 命令实现）</p><p>测试在跳板机上是否可以用 ssh 直连目标服务器，如果可以说明密钥生效</p><p>在跳板机上安装 Ansible:</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> software-properties-common$ <span class="token function">sudo</span> apt-add-repository ppa:ansible/ansible$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> ansible<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>3、点击 manage jenkins &gt; global tool configuration 找到 Ansible 插件配置:</p><p><img src="https://src.wangriyu.wang/images/blog/jenkins/configure-ansible.png" alt="configure-ansible"></p><p>4、我之前使用的部署插件是 Publish Over SSH，但是 pos 只能一个一个添加目标服务器的配置，太麻烦，后来就换成 Ansible 了，这里也贴一下 pos 的配置:</p><p><img src="https://src.wangriyu.wang/images/blog/jenkins/configure-ssh-servers.png" alt="configure-ssh-servers"></p><p><img src="https://src.wangriyu.wang/images/blog/jenkins/deploy-shell.png" alt="deploy-shell"></p><h3 id="添加-golang-模板项目"><a href="#添加-golang-模板项目" class="headerlink" title="添加 golang 模板项目"></a>添加 golang 模板项目</h3><p>点击 new item 进入项目配置页，填入项目名，选择 Freestyle Project。</p><p>然后是项目详情设置</p><p><img src="https://src.wangriyu.wang/images/blog/jenkins/configure-job.png" alt="project"></p><p>1 ~ 4、<strong>General</strong> 一栏中选上 This project is parameterized，然后添加四个参数: tag（用于选择 git 分支）、gitRepo（用于拉取项目）、filename（编译和部署时用的文件名）、servers（Ansible 插件作用的目标服务器组）</p><p>5、源码选择 <strong>Git</strong>，填入 https://$gitRepo，如果是私有仓库，还要添加凭证(可以使用账号密码也可以用密钥)</p><p>代码默认会克隆到当前项目的工作目录中，默认是 <code>/var/lib/jenkins/workspace/项目名/</code>，如果像图中一样设置 check out to a sub-directory，则会克隆到 <code>/var/lib/jenkins/workspace/项目名/sub-directory/</code> 中</p><p>6、<strong>Build Environment</strong> 选上 golang 工具，并选择一个 GOSDK 版本</p><p>7、<strong>Build</strong> 部分添加一个 Execute shell，填入你想执行编译的脚本，比如图中是</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">export</span> GOPATH<span class="token operator">=</span><span class="token variable">$WORKSPACE</span>/gopath<span class="token function">export</span> PATH<span class="token operator">=</span><span class="token variable">$GOPATH</span><span class="token keyword">:</span><span class="token variable">$PATH</span>FilePath<span class="token operator">=</span><span class="token variable">$gitRepo</span><span class="token function">mkdir</span> -p <span class="token variable">$GOPATH</span>/bin<span class="token function">mkdir</span> -p <span class="token variable">$GOPATH</span>/src/<span class="token variable">$FilePath</span><span class="token function">rm</span> -rf <span class="token variable">$GOPATH</span>/src/<span class="token variable">$FilePath</span>/*<span class="token function">cp</span> -R git-repo/* <span class="token variable">$GOPATH</span>/src/<span class="token variable">$FilePath</span><span class="token function">cd</span> <span class="token variable">$GOPATH</span>/src/<span class="token variable">$FilePath</span>go build -o <span class="token variable">$filename</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>需要注意的是 jenkins 需要我们临时声明 \$GOPATH，这里是设置工作目录下的 gopath 文件夹为 \$GOPATH，代码目录需要按仓库的路径添加，避免之后导包出现错误</p><p>8、添加一个 Ansible file 指令，在目标服务器上创建目录</p><pre class="line-numbers language-kv"><code class="language-kv">dest=~/$filename/log/ mode=755 owner=work group=work state=directory<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Inventory 选择项目中指定的 hosts 文件</p><p>Credentials 需要刚才生成的密钥对中的私钥 id_rsa 的内容和你要登录目标服务器的用户</p><p>点击 Advanced 按钮，将 <code>Number of parallel processes</code> 设为 0，并选上 <code>Disable the host SSH key check</code> 和 <code>Colorized stdout</code></p><p>下面的指令也是相同的设置</p><p>9、添加一个 Ansible copy 指令，将第 7 步编译出来的文件上传到目标服务器</p><pre class="line-numbers language-kv"><code class="language-kv">src=$WORKSPACE/gopath/src/$gitRepo/$filename dest=~/$filename/log/ owner=work group=work mode=755<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>10、添加一个 Ansible copy 指令，将项目中的 pm2.json 文件上传到目标服务器</p><pre class="line-numbers language-kv"><code class="language-kv">src=$WORKSPACE/gopath/src/$gitRepo/pm2.json dest=~/$filename/log/ owner=work group=work mode=644<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>11、添加一个 Ansible shell 指令，在目标服务器上执行脚本实现部署更替</p><pre class="line-numbers language-kv"><code class="language-kv">cd ~/$filename;mv $filename last_version;mv log/$filename log/pm2.json .;pm2 startOrRestart pm2.json;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="添加新的-Job"><a href="#添加新的-Job" class="headerlink" title="添加新的 Job"></a>添加新的 Job</h3><p>当有新的项目时，只需要点击 new item 进入项目配置页，填入项目名，然后选择最下方的 Copy from，从模板项目中拷贝配置信息。</p><p>然后修改前面四个参数和使用的凭证即可。</p><h3 id="执行编译"><a href="#执行编译" class="headerlink" title="执行编译"></a>执行编译</h3><p>创建好项目后点击 build with parameters 执行编译部署任务，可以进入 build history 查看具体控制台输出</p><p><img src="https://src.wangriyu.wang/images/blog/jenkins/jenkins-console.png" alt="project"></p><p>也可以点击侧边栏中的 Open Blue Ocean 后进入相应 job，点击 Run 并查看输出</p><p><img src="https://src.wangriyu.wang/images/blog/jenkins/Blue-Ocean.png" alt="project"></p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>完整的 CICD 流程还应该再加上 git hook，这样 push 后能直接触发编译部署；</p><p>而且编译前应该先执行测试脚本，测试完后再继续下一步，我这里没有加单元测试，所以略过了；</p><p>最后还可以添加一个反馈机制，比如 Jenkins 自带邮件模块，不管流程失败还是成功都会发送邮件给你，方便查看结果。</p><h2 id="Jenkins-环境变量说明"><a href="#Jenkins-环境变量说明" class="headerlink" title="Jenkins 环境变量说明"></a>Jenkins 环境变量说明</h2><p>自己定义的参数（Parameter）在调用时可以直接用 <code>$参数名</code>，比如 \$tag;<br>设置的环境变量可以用 \${环境变量名} 调用。</p><ul><li><p>BRANCH_NAME:<br>对于多分支项目，这将被设置为正在构建的分支的名称，例如，如果您希望从 master 部署到生产环境而不是从 feature 分支部署；如果对应某种更改请求，则该名称通常是任意的（请参阅下面的CHANGE_ID和CHANGE_TARGET）</p></li><li><p>CHANGE_ID:<br>对于与某种更改请求相对应的多分支项目，这将被设置为更改 ID，例如拉取请求编号（如果支持）</p></li><li><p>CHANGE_URL:<br>对于与某种更改请求相对应的多分支项目，这将被设置为更改 URL (如果支持)</p></li><li><p>CHANGE_TITLE:<br>对于与某种更改请求相对应的多分支项目，这将被设置为更改的标题（如果支持）</p></li><li><p>CHANGE_AUTHOR:<br>对于与某种更改请求相对应的多分支项目，这将被设置为建议更改的作者的用户名（如果支持）</p></li><li><p>CHANGE_AUTHOR_DISPLAY_NAME:<br>对于与某种更改请求相对应的多分支项目，这将被设置为建议更改的作者的人名（如果支持）</p></li><li><p>CHANGE_AUTHOR_EMAIL:<br>对于与某种更改请求相对应的多分支项目，这将被设置为建议更改的作者的 Email 地址（如果支持）</p></li><li><p>CHANGE_TARGET:<br>对于与某种更改请求相对应的多分支项目，这将被设置为合并到的目标或者基础分支（如果支持）</p></li><li><p>BUILD_NUMBER: 当前构建的编号，例如 “4674” 等</p></li><li><p>BUILD_ID: 当前构建的版本 ID，与构建的 BUILD_NUMBER 相同</p></li><li><p>BUILD_DISPLAY_NAME: 当前版本的显示名称，默认为 “#4674”，即 BUILD_NUMBER</p></li><li><p>JOB_NAME: 即此版本的项目名称，例如 “foo” 或 “foo/bar”</p></li><li><p>JOB_BASE_NAME: 此构建的项目的短名称剥离文件夹路径，例如 “bar/foo” 的 “foo”</p></li><li><p>BUILD_TAG:<br>“jenkins - ${JOB_NAME} - ${BUILD_NUMBER}” 的字符串。JOB_NAME 中的所有正斜杠（/）都用破折号（-）替换。方便地放入资源文件，jar文件等，以便于识别</p></li><li><p>EXECUTOR_NUMBER:<br>唯一编号，用于标识执行此构建的当前执行程序（在同一台计算机的执行程序中）。这是您在“构建执行程序状态”中看到的数字，但数字从 0 开始，而不是从 1 开始</p></li><li><p>NODE_NAME:<br>如果构建在代理上，则代理的名称; 如果在主版本上运行，则为 “MASTER”</p></li><li><p>NODE_LABELS: 节点分配的空白分隔的标签列表</p></li><li><p>WORKSPACE: 作为工作空间分配给构建的目录的绝对路径</p></li><li><p>JENKINS_HOME: Jenkins 用于存储数据的主节点上分配的目录的绝对路径</p></li><li><p>JENKINS_URL:<br>Jenkins 的完整URL，如 <a href="http://server:port/jenkins/（注意" target="_blank" rel="noopener">http://server:port/jenkins/（注意</a>: 仅在系统配置中设置 Jenkins URL 时可用）</p></li><li><p>BUILD_URL:<br>此版本的完整 URL，例如 <a href="http://server:port/jenkins/job/foo/15/（必须设置" target="_blank" rel="noopener">http://server:port/jenkins/job/foo/15/（必须设置</a> Jenkins URL）</p></li><li><p>JOB_URL:<br>该任务的完整 URL，例如 <a href="http://server:port/jenkins/job/foo/（必须设置" target="_blank" rel="noopener">http://server:port/jenkins/job/foo/（必须设置</a> Jenkins URL）</p></li><li><p>GIT_COMMIT: The commit hash being checked out</p></li><li><p>GIT_PREVIOUS_COMMIT: The hash of the commit last built on this branch, if any</p></li><li><p>GIT_PREVIOUS_SUCCESSFUL_COMMIT: The hash of the commit last successfully built on this branch, if any</p></li><li><p>GIT_BRANCH: 远程分支名称，如果有的话</p></li><li><p>GIT_LOCAL_BRANCH: 本地分支名称，如果有的话</p></li><li><p>GIT_URL: 远程 git 仓库的 URL。如果有多个，将会是 GIT_URL_1、GIT_URL_2 等</p></li><li><p>GIT_COMMITTER_NAME: 配置的 Git 提交者名称（如果有的话）</p></li><li><p>GIT_AUTHOR_NAME: 配置的 Git 作者姓名（如果有的话）</p></li><li><p>GIT_COMMITTER_EMAIL: 配置的 Git 提交者电子邮件（如果有的话）</p></li><li><p>GIT_AUTHOR_EMAIL: 已配置的 Git 作者电子邮件（如果有）</p></li><li><p>SVN_REVISION: 当前工作区的 Subversion 版本号，例如“12345”</p></li><li><p>SVN_URL: 当前工作区的 Subversion 版本号，例如“12345”</p></li></ul>]]></content>
      
      <categories>
          
          <category> Services </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Jenkins </tag>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>从零开始搭建一套日志收集分析系统</title>
      <link href="/2018/08-ELK.html"/>
      <url>/2018/08-ELK.html</url>
      <content type="html"><![CDATA[<h2 id="系统模型"><a href="#系统模型" class="headerlink" title="系统模型"></a>系统模型</h2><p>前段时间折腾了一下 ELK，将现有系统的日志重新进行收集分析的工作，最后成型的系统大致如下:</p><p><img src="https://src.wangriyu.wang/images/blog/ELK/ELK-Stack.svg" alt="ELK-Stack"></p><p>日志来源主要分两类，一类是新系统的日志，比如 golang 项目可以直接使用 logrus + kafka hook 将日志打到 kafka 消息队列中；<br>还有一类是旧系统的日志，因为这部分日志是存在机器上的 log 文件，在不改动原有实现的情况下只能采用第三方工具异步采集日志数据再打到 kafka 中，原先是用 rsyslog 采集日志数据，后面替换为 Filebeat，因为 Filebeat 可以记录日志源采集的偏移量，哪怕系统重启了也可以接着上一次的位置读取。</p><p>中间使用 Kafka 作为消息队列，一方面可以将数据持久化，另一方面可以作为缓冲。</p><p>后面使用 ELK 栈，logstash 订阅消费数据，ES 集群负责索引存储，最后 Kibana 聚合数据展示</p><h2 id="搭建过程"><a href="#搭建过程" class="headerlink" title="搭建过程"></a>搭建过程</h2><h3 id="logrus-kafka-hook"><a href="#logrus-kafka-hook" class="headerlink" title="logrus kafka hook"></a>logrus kafka hook</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"os"</span>    <span class="token string">"log"</span>    <span class="token string">"time"</span>    <span class="token string">"strings"</span>    <span class="token string">"math/rand"</span>    <span class="token string">"crypto/tls"</span>    <span class="token string">"github.com/sirupsen/logrus"</span>    <span class="token string">"github.com/Shopify/sarama"</span><span class="token punctuation">)</span><span class="token keyword">type</span> KafkaHook <span class="token keyword">struct</span> <span class="token punctuation">{</span>    Topic       <span class="token builtin">string</span>    AddHostname <span class="token builtin">bool</span>    Hostname    <span class="token builtin">string</span>    levels      <span class="token punctuation">[</span><span class="token punctuation">]</span>logrus<span class="token punctuation">.</span>Level    Formatter   logrus<span class="token punctuation">.</span>Formatter    Producer    sarama<span class="token punctuation">.</span>AsyncProducer<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">NewKafakaHook</span><span class="token punctuation">(</span>levels <span class="token punctuation">[</span><span class="token punctuation">]</span>logrus<span class="token punctuation">.</span>Level<span class="token punctuation">,</span> formatter logrus<span class="token punctuation">.</span>Formatter<span class="token punctuation">,</span> topic <span class="token builtin">string</span><span class="token punctuation">,</span> brokers <span class="token builtin">string</span><span class="token punctuation">,</span> addHostname <span class="token builtin">bool</span><span class="token punctuation">,</span> tls <span class="token operator">*</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>KafkaHook<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> <span class="token punctuation">(</span>        err <span class="token builtin">error</span>        producer sarama<span class="token punctuation">.</span>AsyncProducer    <span class="token punctuation">)</span>    config <span class="token operator">:=</span> sarama<span class="token punctuation">.</span><span class="token function">NewConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    config<span class="token punctuation">.</span>Producer<span class="token punctuation">.</span>RequiredAcks <span class="token operator">=</span> sarama<span class="token punctuation">.</span>WaitForLocal    <span class="token comment" spellcheck="true">// config.Producer.Compression = sarama.CompressionSnappy</span>    config<span class="token punctuation">.</span>Producer<span class="token punctuation">.</span>Flush<span class="token punctuation">.</span>Frequency <span class="token operator">=</span> <span class="token number">500</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond    config<span class="token punctuation">.</span>Producer<span class="token punctuation">.</span>Timeout <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second    <span class="token keyword">if</span> tls <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        config<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>TLS<span class="token punctuation">.</span>Enable <span class="token operator">=</span> <span class="token boolean">true</span>        config<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>TLS<span class="token punctuation">.</span>Config <span class="token operator">=</span> tls    <span class="token punctuation">}</span>    producer<span class="token punctuation">,</span> err <span class="token operator">=</span> sarama<span class="token punctuation">.</span><span class="token function">NewAsyncProducer</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>brokers<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        errs <span class="token operator">:=</span> producer<span class="token punctuation">.</span><span class="token function">Errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> <span class="token punctuation">{</span>            <span class="token keyword">select</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>errs<span class="token punctuation">:</span>                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                    log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Failed to send log entry to Kafka: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    hostname<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Hostname</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        hostname <span class="token operator">=</span> <span class="token string">"localhost"</span>    <span class="token punctuation">}</span>    hook <span class="token operator">:=</span> <span class="token operator">&amp;</span>KafkaHook<span class="token punctuation">{</span>        topic<span class="token punctuation">,</span>        addHostname<span class="token punctuation">,</span>        hostname<span class="token punctuation">,</span>        levels<span class="token punctuation">,</span>        formatter<span class="token punctuation">,</span>        producer<span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> hook<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>kh <span class="token operator">*</span>KafkaHook<span class="token punctuation">)</span> <span class="token function">Fire</span><span class="token punctuation">(</span>entry <span class="token operator">*</span>logrus<span class="token punctuation">.</span>Entry<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> <span class="token punctuation">(</span>        bt <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>        err <span class="token builtin">error</span>    <span class="token punctuation">)</span>    <span class="token keyword">if</span> bt<span class="token punctuation">,</span> err <span class="token operator">=</span> entry<span class="token punctuation">.</span>Time<span class="token punctuation">.</span><span class="token function">MarshalBinary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    <span class="token keyword">if</span> kh<span class="token punctuation">.</span>AddHostname <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> entry<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token string">"host"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>            entry<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token string">"host"</span><span class="token punctuation">]</span> <span class="token operator">=</span> kh<span class="token punctuation">.</span>Hostname        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> bt<span class="token punctuation">,</span> err <span class="token operator">=</span> kh<span class="token punctuation">.</span>Formatter<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    value <span class="token operator">:=</span> sarama<span class="token punctuation">.</span><span class="token function">ByteEncoder</span><span class="token punctuation">(</span>bt<span class="token punctuation">)</span>    kh<span class="token punctuation">.</span>Producer<span class="token punctuation">.</span><span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>sarama<span class="token punctuation">.</span>ProducerMessage<span class="token punctuation">{</span>        Topic<span class="token punctuation">:</span> kh<span class="token punctuation">.</span>Topic<span class="token punctuation">,</span>        Value<span class="token punctuation">:</span> value<span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>kh <span class="token operator">*</span>KafkaHook<span class="token punctuation">)</span> <span class="token function">Levels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>logrus<span class="token punctuation">.</span>Level <span class="token punctuation">{</span>    <span class="token keyword">return</span> kh<span class="token punctuation">.</span>levels<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   hook<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewKafakaHook</span><span class="token punctuation">(</span>      <span class="token punctuation">[</span><span class="token punctuation">]</span>logrus<span class="token punctuation">.</span>Level<span class="token punctuation">{</span>         logrus<span class="token punctuation">.</span>DebugLevel<span class="token punctuation">,</span>         logrus<span class="token punctuation">.</span>InfoLevel<span class="token punctuation">,</span>         logrus<span class="token punctuation">.</span>ErrorLevel<span class="token punctuation">,</span>         logrus<span class="token punctuation">.</span>WarnLevel<span class="token punctuation">,</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token operator">&amp;</span>logrus<span class="token punctuation">.</span>JSONFormatter<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token string">"log-dev"</span><span class="token punctuation">,</span>      <span class="token string">"10.9.X.A:9092,10.9.X.B:9092,10.9.X.C:9092"</span><span class="token punctuation">,</span>      <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token boolean">nil</span><span class="token punctuation">,</span>   <span class="token punctuation">)</span>   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>      log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>   <span class="token punctuation">}</span>   logger <span class="token operator">:=</span> logrus<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   logger<span class="token punctuation">.</span><span class="token function">SetLevel</span><span class="token punctuation">(</span>logrus<span class="token punctuation">.</span>DebugLevel<span class="token punctuation">)</span>   logger<span class="token punctuation">.</span>Hooks<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span>   n <span class="token operator">:=</span> <span class="token number">0</span>   <span class="token keyword">for</span> <span class="token punctuation">{</span>      n<span class="token operator">++</span>      r <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">)</span>      time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token keyword">switch</span> <span class="token punctuation">{</span>      <span class="token keyword">case</span> r <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">:</span> logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"this is an info message "</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token keyword">case</span> r <span class="token operator">>=</span> <span class="token number">512</span> <span class="token operator">&amp;&amp;</span> r <span class="token operator">&lt;</span> <span class="token number">869</span><span class="token punctuation">:</span> logger<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"this is a warn message "</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token keyword">case</span> r <span class="token operator">>=</span> <span class="token number">869</span> <span class="token operator">&amp;&amp;</span> r <span class="token operator">&lt;</span> <span class="token number">985</span><span class="token punctuation">:</span> logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"this is a debug message "</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token keyword">case</span> r <span class="token operator">>=</span> <span class="token number">985</span><span class="token punctuation">:</span> logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"this is an error message "</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token keyword">default</span><span class="token punctuation">:</span>         logger<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"unexpected message"</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Filebeat"><a href="#Filebeat" class="headerlink" title="Filebeat"></a>Filebeat</h3><p>在需要抓取日志的机器上安装并配置 Filebeat</p><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p><a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation.html</a></p><p>以 ubuntu 为例:</p><pre class="line-numbers language-bash"><code class="language-bash">$ curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.3.2-amd64.deb$ <span class="token function">sudo</span> dpkg -i filebeat-6.3.2-amd64.deb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>最好使用 6.3 版本，我试过升级到 6.4 结果原先的配置会出问题</p></blockquote><p>启动和停止</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">service</span> filebeat start <span class="token comment" spellcheck="true"># sudo /etc/init.d/filebeat start</span>$ <span class="token function">sudo</span> <span class="token function">service</span> filebeat restart <span class="token comment" spellcheck="true"># sudo /etc/init.d/filebeat restart</span>$ <span class="token function">sudo</span> <span class="token function">service</span> filebeat stop <span class="token comment" spellcheck="true"># sudo /etc/init.d/filebeat stop</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>目录: <a href="https://www.elastic.co/guide/en/beats/filebeat/current/directory-layout.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/directory-layout.html</a></p><p>默认路径:</p><ul><li>home: /usr/share/filebeat</li><li>bin: /usr/share/filebeat/bin</li><li>config: /etc/filebeat</li><li>data: /var/lib/filebeat</li><li>logs: /var/log/filebeat</li></ul><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>编辑 filebeat.yml 文件添加输入、输出等配置，比如</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">vi</span> /etc/filebeat/filebeat.yml<span class="token comment" spellcheck="true">## Log Input 相关属性设置: https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-log.html</span>filebeat.inputs:  - type: log    enabled: <span class="token boolean">true</span>    paths:      - /var/log/req/req-worker-*.log <span class="token comment" spellcheck="true"># 文件名和目录名都可以用通配符，不过 path/*/*.log 不包括 path 根目录的文件</span>    fields: <span class="token comment" spellcheck="true"># 添加额外的字段</span>      log_topic: <span class="token string">"log-test"</span>      service: <span class="token string">"backend-req"</span>    fields_under_root: <span class="token boolean">true</span> <span class="token comment" spellcheck="true"># field 字段会放在根索引下，否则会放在 fields 字段下</span>    ignore_older: 24h <span class="token comment" spellcheck="true"># 忽略 24 小时前的文件</span>    scan_frequency: 11s <span class="token comment" spellcheck="true"># 设置不同的时间，这样可以错开扫描高峰</span>    max_backoff: 11s    backoff: 11s    harvester_buffer_size: 51200 <span class="token comment" spellcheck="true"># 采集的 buffer 大小</span>    close_timeout: 1h <span class="token comment" spellcheck="true"># 因为我这里的文件是一个小时产生一个，所以直接设置采集器默认 1 小时关闭</span>    clean_inactive: 25h <span class="token comment" spellcheck="true"># 需要大于 ignore_older + scan_frequency，有效地清理可以减小 registry 文件的大小和当中记录的文件条目数量</span>    harvester_limit: 10 <span class="token comment" spellcheck="true"># 限制最多爬取个数，默认不限制，如果碰到文件数很多一开始会占用大量 cpu</span>  - type: log    enabled: <span class="token boolean">true</span>    paths:      - /var/log/push/push-worker-*.log    fields:      log_topic: <span class="token string">"log-test"</span>      service: <span class="token string">"backend-push"</span>    fields_under_root: <span class="token boolean">true</span>    ignore_older: 24h    scan_frequency: 19s    max_backoff: 19s    backoff: 19s    harvester_buffer_size: 51200    close_timeout: 1h    clean_inactive: 25h    harvester_limit: 10  - type: log    enabled: <span class="token boolean">true</span>    paths:      - /var/log/send/send-worker-*.log    fields:      log_topic: <span class="token string">"log-test"</span>      service: <span class="token string">"backend-send"</span>    fields_under_root: <span class="token boolean">true</span>    ignore_older: 24h    scan_frequency: 13s    max_backoff: 13s    backoff: 13s    harvester_buffer_size: 51200    close_timeout: 1h    clean_inactive: 25h    harvester_limit: 10  - type: log    enabled: <span class="token boolean">true</span>    paths:      - /var/log/sync/sync-worker-*.log    fields:      log_topic: <span class="token string">"log-test"</span>      service: <span class="token string">"backend-sync"</span>    fields_under_root: <span class="token boolean">true</span>    ignore_older: 24h    scan_frequency: 17s    max_backoff: 17s    backoff: 17s    harvester_buffer_size: 51200    close_timeout: 1h    clean_inactive: 25h    harvester_limit: 10  - type: log    enabled: <span class="token boolean">true</span>    paths:      - /var/log/delete/delete-worker-*.log    fields:      log_topic: <span class="token string">"log-test"</span>      service: <span class="token string">"backend-delete"</span>    fields_under_root: <span class="token boolean">true</span>    ignore_older: 24h    scan_frequency: 71s    max_backoff: 71s    backoff: 71s    harvester_buffer_size: 51200    close_timeout: 1h    clean_inactive: 25h    harvester_limit: 10  - type: log    enabled: <span class="token boolean">true</span>    paths:        - /var/log/php/error.log    fields:        log_topic: <span class="token string">"log-im"</span>        service: <span class="token string">"backend-php-error"</span>    fields_under_root: <span class="token boolean">true</span>    ignore_older: 24h    scan_frequency: 23s    max_backoff: 23s    backoff: 23s    clean_inactive: 25h    close_renamed: <span class="token boolean">true</span> <span class="token comment" spellcheck="true"># 因为这个日志文件会定期重命名并压缩，所以设置 close_renamed 可以关闭采集器</span>    multiline.pattern: <span class="token string">'^\[[0-9]{2}-[A-Z]{1}[a-z]{2}-[0-9]{4}'</span> <span class="token comment" spellcheck="true"># 合并多行日志，将类似 [06-Sep-2018 ... 开头的日志向后合并</span>    multiline.negate: <span class="token boolean">true</span>    multiline.match: after    harvester_limit: 10<span class="token comment" spellcheck="true">## Kafka Output 相关属性设置: https://www.elastic.co/guide/en/beats/filebeat/current/kafka-output.html</span>output.kafka:  enabled: <span class="token boolean">true</span>  hosts: <span class="token punctuation">[</span><span class="token string">"10.10.X.A:9092"</span>, <span class="token string">"10.10.X.B:9092"</span>, <span class="token string">"10.10.X.C:9092"</span><span class="token punctuation">]</span>  topic: <span class="token string">'%{[log_topic]}'</span>  codec.format:    string: <span class="token string">'%{[beat][hostname]} %{[service]} %{[message]}'</span> <span class="token comment" spellcheck="true"># 传给 logstash 时可以用 grok 过滤插件设置 `match => { "message" => "^%{DATA:hostname} %{DATA:service} (?&lt;message>.*)"}` 解析</span>    <span class="token comment" spellcheck="true"># 如果设成 ‘%{[message]}’，则是原样转发消息</span>  partition.round_robin:    reachable_only: <span class="token boolean">false</span>  required_acks: 1  compression: none <span class="token comment" spellcheck="true"># 默认是 gzip，如果像节省开销可以设成 none</span>  bulk_max_size: 100  max_message_bytes: 1000000 <span class="token comment" spellcheck="true"># 不要超过 kafka server 端设置的 message.max.size，否则超过的部分会被丢弃</span>output.file:  enabled: <span class="token boolean">false</span>  path: /home/ubuntu/test-log  filename: output.log  permissions: 0644  codec.format:    string: <span class="token string">'%{[message]}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><a href="https://cloud.tencent.com/developer/article/1006051" target="_blank" rel="noopener">Filebeat 配置详解</a></p></blockquote><p>假设 Filebeat 要抓取的是非结构化日志格式:</p><pre class="line-numbers language-log"><code class="language-log">Mon Sep 10 2018 12:06:16 GMT+0800 (CST) - info: type: SyncSessionRangeService  uid:9182093812301298392103{}18-09-07 08:19:43 - info: GRPC REQUEST & RESPONSE{        "uid": 1290381298494,        "type": "SyncSessionRangeService",        "data": {            "session_id": 123456,            "session_type": 2,            "start_id": 0,            "stop_id": 3        },        "localId": 349058034598,        "result": {            "type": 5,            "is_sync": true,            "is_ack": true,            "require_ack": false,            "error": 0,            "continue": false,            "sync_local_id": 0,            "messages": []        }    }18-09-06 22:07:33 - info: type: SyncSessionRangeService  uid:20373933{}18-09-07 08:19:43 - info: GRPC REQUEST & RESPONSE{            "uid": 5792715,            "type": "SyncSessionRangeService",            "data": {                "session_id": 13416794,                "session_type": 2,                "start_id": 0,                "stop_id": 3            },            "localId": 1536279501,            "result": {                "type": 5,                "is_sync": true,                "is_ack": true,                "require_ack": false,                "error": 0,                "continue": false,                "sync_local_id": 0,                "messages": []            }        }[08/Sep/2018:01:49:55 +0800] check photo https://sgchatfiles.bldimg.com/2018/9/8/1/49/16263641_1536342594629.jpg[08/Sep/2018:01:49:55 +0800] check "result": {    "type": 5,    "is_sync": true,    "is_ack": true,    "require_ack": false,    "error": 0,    "continue": false,    "sync_local_id": 0,    "messages": []}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对于多行日志，使用 multiline.pattern 处理: <a href="https://www.elastic.co/guide/en/beats/filebeat/current/multiline-examples.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/multiline-examples.html</a></p><p>比如:</p><ul><li>Mon Sep 10 2018 12:06:16 GMT+0800 (CST) -&gt; ‘[T|M|W|S|F]{1}[a-z]{2} [J|F|M|A|S|O|N|D]{1}[a-z]{2} [0-9]{2} [0-9]{4} [0-9]{2}:[0-9]{2}:[0-9]{2} [GMT+]{4}[0-9]{4} [(CST)]{5}’</li><li>[06-Sep-2018 … -&gt; ‘^[[0-9]{2}-[A-Z]{1}[a-z]{2}-[0-9]{4}’</li><li>18-09-07 08:19:43 -&gt; ‘^[0-9]{2}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}’</li></ul><blockquote><p>更新文件记录: <a href="https://www.elastic.co/guide/en/beats/filebeat/current/migration-registry-file.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/migration-registry-file.html</a></p><p>常见问题（特别是 “Too many open file handlers” 问题的相关配置）: <a href="https://www.elastic.co/guide/en/beats/filebeat/current/faq.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/faq.html</a></p></blockquote><h3 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h3><p>kafka 集群我是用的现有的集群，自己并没有试过，搭建过程大概可以参看 <a href="http://dearcharles.cn/2017/11/23/%E5%9F%BA%E4%BA%8EDocker%E6%90%AD%E5%BB%BA%E5%88%86%E5%B8%83%E5%BC%8F%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97Kafka/" target="_blank" rel="noopener">http://dearcharles.cn/2017/11/23/%E5%9F%BA%E4%BA%8EDocker%E6%90%AD%E5%BB%BA%E5%88%86%E5%B8%83%E5%BC%8F%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97Kafka/</a></p><p>我就先不详细写了，怕出现偏差</p><h3 id="ELK"><a href="#ELK" class="headerlink" title="ELK"></a>ELK</h3><p>ELK 主要是以 <a href="https://github.com/deviantony/docker-elk" target="_blank" rel="noopener">docker-elk</a> 为模板进行搭建，选择的版本是 6.3</p><p>不过该项目是搭建在单节点上的配置，如果是用在生产环境的多主机上要修改很多地方，这是我修改的 <a href="https://github.com/wangriyu/docker-elk" target="_blank" rel="noopener">docker-elk</a></p><p>文件目录</p><pre class="line-numbers language-bash"><code class="language-bash">$ tree <span class="token keyword">.</span><span class="token keyword">.</span>├── docker-compose.yml├── elasticsearch│   ├── config│   │   └── elasticsearch.yml│   └── Dockerfile├── extensions│   ├── curator│   │   ├── config│   │   │   ├── curator.yml│   │   │   └── delete_log_files_curator.yml│   │   ├── curator-compose.yml│   │   ├── Dockerfile│   │   ├── entrypoint.sh│   │   └── README.md│   ├── logspout│   │   ├── build.sh│   │   ├── Dockerfile│   │   ├── logspout-compose.yml│   │   ├── modules.go│   │   └── README.md│   └── README.md├── kibana│   ├── config│   │   └── kibana.yml│   └── Dockerfile├── LICENSE├── logstash│   ├── config│   │   └── logstash.yml│   ├── Dockerfile│   └── pipeline│       └── logstash.conf└── README.md<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h4><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2.2'</span> <span class="token comment" spellcheck="true"># version 2.2 以上加 docker-compose 1.16+ 才支持 cpus 的设置项</span><span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>    <span class="token key atrule">build</span><span class="token punctuation">:</span>      <span class="token key atrule">context</span><span class="token punctuation">:</span> elasticsearch/    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> elasticsearch    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> /data/elasticsearch/data<span class="token punctuation">:</span>/usr/share/elasticsearch/data <span class="token comment" spellcheck="true"># 设置 es 数据存放目录</span>      <span class="token punctuation">-</span> ./elasticsearch/config/elasticsearch.yml<span class="token punctuation">:</span>/usr/share/elasticsearch/config/elasticsearch.yml<span class="token punctuation">:</span>ro    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"9200:9200"</span>      <span class="token punctuation">-</span> <span class="token string">"9300:9300"</span>    <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token number">1.5 </span><span class="token comment" spellcheck="true"># 限制 cpu 的使用，两核的处理器设置 1.5 代表最多占用 1.5/2 (75%) 的 cpu</span>    <span class="token key atrule">mem_limit</span><span class="token punctuation">:</span> 6g <span class="token comment" spellcheck="true"># 限制容器最多占用 6g 内存</span>    <span class="token key atrule">ulimits</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 必须设置此项 bootstrap.memory_lock 才能生效</span>      <span class="token key atrule">memlock</span><span class="token punctuation">:</span>        <span class="token key atrule">soft</span><span class="token punctuation">:</span> <span class="token number">-1</span>        <span class="token key atrule">hard</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token key atrule">ES_JAVA_OPTS</span><span class="token punctuation">:</span> <span class="token string">"-Xmx3g -Xms3g"</span> <span class="token comment" spellcheck="true"># 设置 Java 堆内存大小，最好设置成主机的一半但也不能超过 32g</span>      <span class="token key atrule">PUBLISH_HOST</span><span class="token punctuation">:</span> <span class="token string">"10.0.X.A"</span> <span class="token comment" spellcheck="true"># host ip</span>      <span class="token key atrule">NODE_NAME</span><span class="token punctuation">:</span> <span class="token string">"es-node-1"</span>    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always    <span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"host"</span>  <span class="token key atrule">logstash</span><span class="token punctuation">:</span>    <span class="token key atrule">build</span><span class="token punctuation">:</span>      <span class="token key atrule">context</span><span class="token punctuation">:</span> logstash/    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> logstash    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ./logstash/config/logstash.yml<span class="token punctuation">:</span>/usr/share/logstash/config/logstash.yml<span class="token punctuation">:</span>ro      <span class="token punctuation">-</span> ./logstash/pipeline<span class="token punctuation">:</span>/usr/share/logstash/pipeline<span class="token punctuation">:</span>ro    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"5000:5000"</span>    <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token number">1.5</span>    <span class="token key atrule">mem_limit</span><span class="token punctuation">:</span> 1g    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token key atrule">LS_JAVA_OPTS</span><span class="token punctuation">:</span> <span class="token string">"-Xmx512m -Xms512m"</span>    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always    <span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"host"</span>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> elasticsearch  <span class="token key atrule">kibana</span><span class="token punctuation">:</span>    <span class="token key atrule">build</span><span class="token punctuation">:</span>      <span class="token key atrule">context</span><span class="token punctuation">:</span> kibana/    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> kibana    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ./kibana/config/<span class="token punctuation">:</span>/usr/share/kibana/config<span class="token punctuation">:</span>ro    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"5601:5601"</span>    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always    <span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"host"</span>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> elasticsearch  <span class="token key atrule">cerebro</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> yannart/cerebro    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> cerebro    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"9000:9000"</span>    <span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"host"</span>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> elasticsearch  <span class="token key atrule">curator</span><span class="token punctuation">:</span>    <span class="token key atrule">build</span><span class="token punctuation">:</span>      <span class="token key atrule">context</span><span class="token punctuation">:</span> extensions/curator/    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> curator    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token key atrule">ELASTICSEARCH_HOST</span><span class="token punctuation">:</span> <span class="token string">"10.0.X.A"</span> <span class="token comment" spellcheck="true"># host ip</span>      <span class="token key atrule">CRON</span><span class="token punctuation">:</span> <span class="token string">"30 0 * * *"</span> <span class="token comment" spellcheck="true"># 每日 0 点 30 分清理 ${UNIT_COUNT} 天前的索引，详见 extension/curator/</span>      <span class="token key atrule">CONFIG_FILE</span><span class="token punctuation">:</span> /usr/share/curator/config/curator.yml      <span class="token key atrule">COMMAND</span><span class="token punctuation">:</span> /usr/share/curator/config/delete_log_files_curator.yml <span class="token comment" spellcheck="true"># 按需修改 extension/curator/config/delete_log_files_curator.yml</span>      <span class="token key atrule">UNIT_COUNT</span><span class="token punctuation">:</span> <span class="token number">7</span>    <span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"host"</span>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> elasticsearch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="logstash"><a href="#logstash" class="headerlink" title="logstash"></a>logstash</h4><p>logstash 的配置都一样，在这里只是作为同一个 group 里的消费者，按一定方式分摊消费 kafka 队列中的消息</p><p>logstash.conf:</p><pre class="line-numbers language-javascript"><code class="language-javascript">input <span class="token punctuation">{</span>    kafka <span class="token punctuation">{</span>        bootstrap_servers <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.10.X.A:9092,10.10.X.B:9092,10.10.X.C:9092"</span>        consumer_threads <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6</span> # 一般设为 Partition 的数目即可        decorate_events <span class="token operator">=</span><span class="token operator">></span> <span class="token boolean">false</span>        topics <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"log-im"</span><span class="token punctuation">]</span>        group_id <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"group-log-im"</span>        type <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"log-im"</span>    <span class="token punctuation">}</span>    kafka <span class="token punctuation">{</span>        bootstrap_servers <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.9.X.A:9092,10.9.X.B:9092,10.9.X.C:9092"</span>        consumer_threads <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8</span>        decorate_events <span class="token operator">=</span><span class="token operator">></span> <span class="token boolean">false</span>        topics <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"log-dev"</span><span class="token punctuation">]</span>        group_id <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"group-log-dev"</span>        type <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"log-dev"</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>## Add your filters <span class="token operator">/</span> logstash plugins configuration herefilter <span class="token punctuation">{</span>    mutate <span class="token punctuation">{</span>        remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"@version"</span> <span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"log-im"</span> <span class="token punctuation">{</span>        # grok 插件可以将非结构化日志解析成结构化的        # 测试工具<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>grokdebug<span class="token punctuation">.</span>herokuapp<span class="token punctuation">.</span>com        # 推荐阅读<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>elastic<span class="token punctuation">.</span>co<span class="token operator">/</span>blog<span class="token operator">/</span><span class="token keyword">do</span><span class="token operator">-</span>you<span class="token operator">-</span>grok<span class="token operator">-</span>grok        grok <span class="token punctuation">{</span>            match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"^%{DATA:hostname} %{DATA:service} (?&lt;message>.*)"</span> <span class="token punctuation">}</span>            overwrite <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"message"</span> <span class="token punctuation">]</span>        <span class="token punctuation">}</span>        grok <span class="token punctuation">{</span>            match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>                    <span class="token string">"^\[%{DATA:time}\] (?&lt;message>.*)"</span><span class="token punctuation">,</span>                    <span class="token string">"^(?&lt;time>[T|M|W|S|F]{1}[a-z]{2} [J|F|M|A|S|O|N|D]{1}[a-z]{2} [0-9]{2} [0-9]{4} [0-9]{2}:[0-9]{2}:[0-9]{2} [GMT+]{4}[0-9]{4} [(CST)]{5}) - %{LOGLEVEL:level}: (?&lt;message>.*)"</span><span class="token punctuation">,</span>                    <span class="token string">"^(?&lt;time>[0-9]{2}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}) - %{LOGLEVEL:level}: (?&lt;message>.*)"</span><span class="token punctuation">,</span>                    <span class="token string">"^(?&lt;message>.*)"</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span>            overwrite <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"message"</span> <span class="token punctuation">]</span>        <span class="token punctuation">}</span>        json <span class="token punctuation">{</span>            source <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"message"</span>            skip_on_invalid_json <span class="token operator">=</span><span class="token operator">></span> <span class="token boolean">true</span>            remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"message"</span> <span class="token punctuation">]</span>        <span class="token punctuation">}</span>        date <span class="token punctuation">{</span>            match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"time"</span><span class="token punctuation">,</span> <span class="token string">"ISO8601"</span><span class="token punctuation">,</span> <span class="token string">"EEE MMM dd yyyy HH:mm:ss 'GMT'Z '(CST)'"</span><span class="token punctuation">,</span> <span class="token string">"dd/MMM/yyyy:HH:mm:ss Z"</span><span class="token punctuation">,</span> <span class="token string">"yy-MM-dd HH:mm:ss"</span><span class="token punctuation">,</span> <span class="token string">"dd-MMM-yyyy HH:mm:ss ZZZ"</span><span class="token punctuation">,</span> <span class="token string">"yyyy-MM-dd HH:mm:ss ZZ"</span><span class="token punctuation">,</span> <span class="token string">"yyyy-MM-dd HH:mm ZZ"</span> <span class="token punctuation">]</span>            remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"time"</span> <span class="token punctuation">]</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">[</span>service<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"backend-php-error"</span> <span class="token punctuation">{</span>            mutate <span class="token punctuation">{</span>                add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token string">"level"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"error"</span> <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>output <span class="token punctuation">{</span>    ## 根据 type 区分不同的 topic 日志，然后存入不同的 index 中，方便 Kibana 聚合    <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"log-im"</span> <span class="token punctuation">{</span>        elasticsearch <span class="token punctuation">{</span>            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"localhost:9200"</span><span class="token punctuation">,</span> <span class="token string">"10.42.75.252:9200"</span><span class="token punctuation">,</span> <span class="token string">"10.42.111.182:9200"</span><span class="token punctuation">]</span>            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%{type}-%{+YYYY.MM.dd}"</span> # 最好使用日期，一天一个索引，这样方便删除旧索引        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"log-dev-2"</span> <span class="token punctuation">{</span>        elasticsearch <span class="token punctuation">{</span>            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"localhost:9200"</span><span class="token punctuation">,</span> <span class="token string">"10.42.75.252:9200"</span><span class="token punctuation">,</span> <span class="token string">"10.42.111.182:9200"</span><span class="token punctuation">]</span>            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"log-dev-2"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>logstash.yml:</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">## Default Logstash configuration from logstash-docker.</span><span class="token comment" spellcheck="true">## from https://github.com/elastic/logstash-docker/blob/master/build/logstash/config/logstash-oss.yml</span><span class="token key atrule">http.host</span><span class="token punctuation">:</span> <span class="token string">"0.0.0.0"</span><span class="token key atrule">path.config</span><span class="token punctuation">:</span> /usr/share/logstash/pipeline<span class="token key atrule">pipeline.workers</span><span class="token punctuation">:</span> <span class="token number">4 </span><span class="token comment" spellcheck="true"># 设置成 cpu 核数或者其倍数</span><span class="token key atrule">pipeline.output.workers</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token key atrule">pipeline.batch.size</span><span class="token punctuation">:</span> <span class="token number">1000</span><span class="token key atrule">pipeline.batch.delay</span><span class="token punctuation">:</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h4><p>ES 的集群设置会麻烦点，ES 节点有很多种角色，比如常见的 master、data、injest 节点，我这里是将三个节点作为 master 和 injest，另外三个作为 data 节点。</p><p>关于不同节点的作用和脑裂选项见 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html</a></p><p>重要配置项: <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/important-configuration-changes.html" target="_blank" rel="noopener">https://www.elastic.co/guide/cn/elasticsearch/guide/current/important-configuration-changes.html</a></p><p>参考配置项: <a href="https://github.com/wangriyu/docker-elk/blob/master/elasticsearch/config/reference.md" target="_blank" rel="noopener">https://github.com/wangriyu/docker-elk/blob/master/elasticsearch/config/reference.md</a></p><p>elasticsearch.yml:</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">## Default Elasticsearch configuration from elasticsearch-docker.</span><span class="token comment" spellcheck="true">## from https://github.com/elastic/elasticsearch-docker/blob/master/build/elasticsearch/elasticsearch.yml</span><span class="token key atrule">cluster.name</span><span class="token punctuation">:</span> <span class="token string">"elk-cluster"</span><span class="token key atrule">node.name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>NODE_NAME<span class="token punctuation">}</span><span class="token key atrule">node.master</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">network.host</span><span class="token punctuation">:</span> 0.0.0.0<span class="token key atrule">network.publish_host</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>PUBLISH_HOST<span class="token punctuation">}</span><span class="token comment" spellcheck="true">## https://www.elastic.co/guide/en/elasticsearch/reference/6.3/setup-configuration-memory.html</span><span class="token comment" spellcheck="true">## 最好按照官方说的关闭内存交换并设置此项为 true，容器的话需要设置 ulimit</span><span class="token key atrule">bootstrap.memory_lock</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token comment" spellcheck="true">## 集群单播 ip</span><span class="token key atrule">discovery.zen.ping.unicast.hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"10.42.X.A:9300"</span><span class="token punctuation">,</span> <span class="token string">"10.42.X.B:9300"</span><span class="token punctuation">,</span> <span class="token string">"10.42.X.C:9300"</span><span class="token punctuation">]</span><span class="token key atrule">discovery.zen.fd.ping_timeout</span><span class="token punctuation">:</span> 120s<span class="token key atrule">discovery.zen.fd.ping_retries</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token key atrule">discovery.zen.fd.ping_interval</span><span class="token punctuation">:</span> 30s<span class="token comment" spellcheck="true">## 设置此项，当 fielddata 达到预设值时会清除旧数据，有利于新数据的写入</span><span class="token key atrule">indices.fielddata.cache.size</span><span class="token punctuation">:</span> 30%<span class="token comment" spellcheck="true">## 避免集群整个重启时频繁交换分片的问题</span><span class="token key atrule">gateway.recover_after_nodes</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token key atrule">gateway.expected_nodes</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token key atrule">gateway.recover_after_time</span><span class="token punctuation">:</span> 5m<span class="token comment" spellcheck="true"># 防止脑裂，推荐设成: 候选主节点数除二加一</span><span class="token comment" spellcheck="true"># recommend set: (masters) / 2 + 1</span><span class="token key atrule">discovery.zen.minimum_master_nodes</span><span class="token punctuation">:</span> <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Cerebro 是一套 webUI，可以查看 ES 集群和节点的信息:</p><p><img src="https://src.wangriyu.wang/images/blog/ELK/Cerebro-Overview.png" alt="Cerebro"></p><p><img src="https://src.wangriyu.wang/images/blog/ELK/Cerebro-Nodes.png" alt="Cerebro"></p><h4 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h4><p>Kibana 默认访问同一主机上的 ES 节点即可</p><p>kibana.yml:</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">## Default Kibana configuration from kibana-docker.</span><span class="token comment" spellcheck="true">## from https://github.com/elastic/kibana-docker/blob/master/build/kibana/config/kibana.yml</span><span class="token key atrule">server.name</span><span class="token punctuation">:</span> kibana<span class="token key atrule">server.host</span><span class="token punctuation">:</span> <span class="token string">"0"</span><span class="token key atrule">elasticsearch.url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">9200</span><span class="token key atrule">elasticsearch.requestTimeout</span><span class="token punctuation">:</span> <span class="token number">90000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Kibana 使用说明:</p><p>第一次访问 5601 端口页面时首先点击侧边栏 Management，然后点击 Index Patterns，获取日志源.</p><p><img src="https://src.wangriyu.wang/images/blog/ELK/Kibana-1.png" alt="Kibana-1"></p><p>之后也可以在这里添加新的源，当日志字段更新，点击右上角刷新字段，否则筛选时可能找不到未匹配的字段。</p><p><img src="https://src.wangriyu.wang/images/blog/ELK/Kibana-2.png" alt="Kibana-2"></p><p>获取日志源后点击侧边栏 Discover，查看日志流，如果数据不动，将右上角 Auto Refresh 设置为 5s，并点击其右边选择一段 Time Range。</p><p><img src="https://src.wangriyu.wang/images/blog/ELK/Kibana-3.png" alt="Kibana-3"></p><p>顶部搜索栏支持过滤，比如 level:error 等，也可以点击 add filter 进行筛选，支持自定义查询语句</p><p>点击侧边栏 Visualize，可以进行数据可视化操作，比如下图设置 info 日志的折线图:</p><p><img src="https://src.wangriyu.wang/images/blog/ELK/Kibana-4.png" alt="Kibana-4"></p><p>设置好图表后点击顶部的 save 命名保存。</p><p>点击侧边栏的 Dashboard，可以添加展示面板，然后把我们上一步设置的图表放上去。</p><p><img src="https://src.wangriyu.wang/images/blog/ELK/Kibana-5.png" alt="Kibana-5"></p><blockquote><p>最后可以用 nginx 做个负载均衡，将三个 Kibana 加到 upstream 中，即使一个不可访问也可以访问其他节点的，Kibana 设置的图形和面板是共享的</p></blockquote><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://www.elastic.co/guide/en/logstash/6.3/index.html" target="_blank" rel="noopener">Logstash Reference 6.3</a></li><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/index.html" target="_blank" rel="noopener">Elasticsearch Reference 6.3</a></li><li><a href="https://www.elastic.co/guide/en/kibana/6.3/index.html" target="_blank" rel="noopener">Kibana User Guide 6.3</a></li><li><a href="https://www.elastic.co/guide/en/beats/filebeat/6.3/index.html" target="_blank" rel="noopener">Filebeat Reference 6.3</a></li></ul>]]></content>
      
      <categories>
          
          <category> Services </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
            <tag> Log </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>解决 Linux “GLIBCXX_* not found” 问题</title>
      <link href="/2018/08-Linux_libc.html"/>
      <url>/2018/08-Linux_libc.html</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>现在有个需求是搭建一套 golang 的自动化编译部署方案，最好是少量配置一键完成，刚开始我是先自己用代码实现了一套，大体思路是把代码 cp 进含 golang 环境的镜像中打包，再用脚本实现创建容器并执行编译并将编译好的文件导出来，和 pm2.json 一起上传到目标服务器上，再用 golang.org/x/crypto/ssh 连接服务器执行更替部署等任务。</p><p>这里用容器编译是因为 cgo 代码不支持交叉编译，在本地 Mac 的环境下动态链接库会出问题。</p><p>正常情况下，这套方案已经可以工作了，但是我尝试了一下含 cgo 的代码时文件在服务器上执行时抛出 “./executable_app: /usr/lib/x86_64-linux-gnu/libstdc++.so.6: version `GLIBCXX_3.4.21’ not found (required by ./executable_app)” 错误，服务器 libc 版本跟不上…</p><p>接下来就是解决这个问题的过程了</p><h2 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h2><p>刚开始服务器都是 Ubuntu 14.04，我上传文件执行会抛出这个问题</p><p>先是看一下报错的文件</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">ls</span> -l /usr/lib/x86_64-linux-gnu <span class="token operator">|</span> <span class="token function">grep</span> libstdc++.so.6lrwxrwxrwx 1 root root       19 Feb 14 11:49 libstdc++.so.6 -<span class="token operator">></span> libstdc++.so.6.0.19-rw-r--r-- 1 root root   979056 Feb 14 12:25 libstdc++.so.6.0.19<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再看一下 GLIBCXX 版本</p><pre class="line-numbers language-bash"><code class="language-bash">$ strings /usr/lib/x86_64-linux-gnu/libstdc++.so.6 <span class="token operator">|</span> <span class="token function">grep</span> GLIBCXXGLIBCXX_3.4GLIBCXX_3.4.1GLIBCXX_3.4.2GLIBCXX_3.4.3GLIBCXX_3.4.4GLIBCXX_3.4.5GLIBCXX_3.4.6GLIBCXX_3.4.7GLIBCXX_3.4.8GLIBCXX_3.4.9GLIBCXX_3.4.10GLIBCXX_3.4.11GLIBCXX_3.4.12GLIBCXX_3.4.13GLIBCXX_3.4.14GLIBCXX_3.4.15GLIBCXX_3.4.16GLIBCXX_3.4.17GLIBCXX_3.4.18GLIBCXX_3.4.19GLIBCXX_DEBUG_MESSAGE_LENGTH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>发现服务器上最大版本是 GLIBCXX_3.4.19，而执行文件需要 GLIBCXX_3.4.21</p><p>解决办法就是更新 libstdc++.so.6 链接的文件</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">find</span> / -name libstdc++.so.6*/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.19-gdb.py/usr/lib/x86_64-linux-gnu/libstdc++.so.6/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.19/data/docker/aufs/diff/0039106da7d10e4e6d803cc04044dc12686f0ea0e2fb70efaaaf53b103c7f815/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.21-gdb.py/data/docker/aufs/diff/0039106da7d10e4e6d803cc04044dc12686f0ea0e2fb70efaaaf53b103c7f815/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.21/data/docker/aufs/diff/0039106da7d10e4e6d803cc04044dc12686f0ea0e2fb70efaaaf53b103c7f815/usr/lib/x86_64-linux-gnu/libstdc++.so.6/data/docker/aufs/diff/11d70867975233caf7b9c507b9ceabf6a233d6dd0070b2ae61ec2047db81955e/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.20-gdb.py/data/docker/aufs/diff/11d70867975233caf7b9c507b9ceabf6a233d6dd0070b2ae61ec2047db81955e/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.20/data/docker/aufs/diff/11d70867975233caf7b9c507b9ceabf6a233d6dd0070b2ae61ec2047db81955e/usr/lib/x86_64-linux-gnu/libstdc++.so.6/data/docker/aufs/diff/9b7dfc62d11331833041039704da391bee2e875e0e2f36a0193ff7bf824a7d4e/usr/lib64/libstdc++.so.6.0.19/data/docker/aufs/diff/9b7dfc62d11331833041039704da391bee2e875e0e2f36a0193ff7bf824a7d4e/usr/lib64/libstdc++.so.6/data/docker/aufs/diff/9b7dfc62d11331833041039704da391bee2e875e0e2f36a0193ff7bf824a7d4e/usr/share/gdb/auto-load/usr/lib64/libstdc++.so.6.0.19-gdb.pyc/data/docker/aufs/diff/9b7dfc62d11331833041039704da391bee2e875e0e2f36a0193ff7bf824a7d4e/usr/share/gdb/auto-load/usr/lib64/libstdc++.so.6.0.19-gdb.py/data/docker/aufs/diff/9b7dfc62d11331833041039704da391bee2e875e0e2f36a0193ff7bf824a7d4e/usr/share/gdb/auto-load/usr/lib64/libstdc++.so.6.0.19-gdb.pyo/data/docker/aufs/diff/0197a1011d6776a0acbf37dde7abe7fb16c57600920c5bd901ecb87f4c2cd566/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.19-gdb.py/data/docker/aufs/diff/0197a1011d6776a0acbf37dde7abe7fb16c57600920c5bd901ecb87f4c2cd566/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.19/data/docker/aufs/diff/0197a1011d6776a0acbf37dde7abe7fb16c57600920c5bd901ecb87f4c2cd566/usr/lib/x86_64-linux-gnu/libstdc++.so.6/data/docker/aufs/diff/e85d386ce1c51a2947230b1a68022eeb185ae007d5a81116463f69c1d7cce83a/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.21-gdb.py/data/docker/aufs/diff/e85d386ce1c51a2947230b1a68022eeb185ae007d5a81116463f69c1d7cce83a/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.21/data/docker/aufs/diff/e85d386ce1c51a2947230b1a68022eeb185ae007d5a81116463f69c1d7cce83a/usr/lib/x86_64-linux-gnu/libstdc++.so.6/data/docker/aufs/diff/fd016d77ce56dc026a2d4e900738d77aba22576d88a2d0862fd2a71ef2c851db/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.22-gdb.py/data/docker/aufs/diff/fd016d77ce56dc026a2d4e900738d77aba22576d88a2d0862fd2a71ef2c851db/usr/lib/x86_64-linux-gnu/libstdc++.so.6/data/docker/aufs/diff/fd016d77ce56dc026a2d4e900738d77aba22576d88a2d0862fd2a71ef2c851db/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.22/data/docker/aufs/diff/139097aa22fa2eafb30728f121d77b5105c4d37351f7c3bc8fec833f235bf57d/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.22-gdb.py/data/docker/aufs/diff/139097aa22fa2eafb30728f121d77b5105c4d37351f7c3bc8fec833f235bf57d/usr/lib/x86_64-linux-gnu/libstdc++.so.6/data/docker/aufs/diff/139097aa22fa2eafb30728f121d77b5105c4d37351f7c3bc8fec833f235bf57d/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.22/data/docker/aufs/mnt/56e9f10df36b6d08d75f2373ba8ff1bbba747cf0bdd368c49a3ffde835816fb9/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.19-gdb.py/data/docker/aufs/mnt/56e9f10df36b6d08d75f2373ba8ff1bbba747cf0bdd368c49a3ffde835816fb9/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.19/data/docker/aufs/mnt/56e9f10df36b6d08d75f2373ba8ff1bbba747cf0bdd368c49a3ffde835816fb9/usr/lib/x86_64-linux-gnu/libstdc++.so.6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>先在服务器上找一下有没有更高版本的，发现有并且含 GLIBCXX_3.4.21</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> strings /data/docker/aufs/diff/0039106da7d10e4e6d803cc04044dc12686f0ea0e2fb70efaaaf53b103c7f815/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.21 <span class="token operator">|</span> <span class="token function">grep</span> GLIBCXXGLIBCXX_3.4GLIBCXX_3.4.1GLIBCXX_3.4.2GLIBCXX_3.4.3GLIBCXX_3.4.4GLIBCXX_3.4.5GLIBCXX_3.4.6GLIBCXX_3.4.7GLIBCXX_3.4.8GLIBCXX_3.4.9GLIBCXX_3.4.10GLIBCXX_3.4.11GLIBCXX_3.4.12GLIBCXX_3.4.13GLIBCXX_3.4.14GLIBCXX_3.4.15GLIBCXX_3.4.16GLIBCXX_3.4.17GLIBCXX_3.4.18GLIBCXX_3.4.19GLIBCXX_3.4.20GLIBCXX_3.4.21GLIBCXX_DEBUG_MESSAGE_LENGTH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后就是替换 libstdc++.so.6 链接对象</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">cp</span> /usr/lib/x86_64-linux-gnu/libstdc++.so.6 /usr/lib/x86_64-linux-gnu/libstdc++.so.6-origin$ <span class="token function">sudo</span> <span class="token function">cp</span> /data/docker/aufs/diff/0039106da7d10e4e6d803cc04044dc12686f0ea0e2fb70efaaaf53b103c7f815/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.21 /usr/lib/x86_64-linux-gnu$ <span class="token function">sudo</span> <span class="token function">ln</span> -s /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.21 /usr/lib/x86_64-linux-gnu/libstdc++.so.6$ <span class="token function">ls</span> -l /usr/lib/x86_64-linux-gnu <span class="token operator">|</span> <span class="token function">grep</span> libstdc++.so.6lrwxrwxrwx 1 root root       19 Aug 10 10:56 libstdc++.so.6 -<span class="token operator">></span> libstdc++.so.6.0.21-rw-r--r-- 1 root root   979056 Feb 14 12:25 libstdc++.so.6.0.19-rw-r--r-- 1 root root  1566440 Aug 10 10:55 libstdc++.so.6.0.21lrwxrwxrwx 1 root root       19 Feb 14 11:49 libstdc++.so.6-origin -<span class="token operator">></span> libstdc++.so.6.0.19<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再查看 libstdc++.so.6 就能正常工作了</p><pre class="line-numbers language-bash"><code class="language-bash">strings /usr/lib/x86_64-linux-gnu/libstdc++.so.6 <span class="token operator">|</span> <span class="token function">grep</span> GLIBCXXGLIBCXX_3.4GLIBCXX_3.4.1GLIBCXX_3.4.2GLIBCXX_3.4.3GLIBCXX_3.4.4GLIBCXX_3.4.5GLIBCXX_3.4.6GLIBCXX_3.4.7GLIBCXX_3.4.8GLIBCXX_3.4.9GLIBCXX_3.4.10GLIBCXX_3.4.11GLIBCXX_3.4.12GLIBCXX_3.4.13GLIBCXX_3.4.14GLIBCXX_3.4.15GLIBCXX_3.4.16GLIBCXX_3.4.17GLIBCXX_3.4.18GLIBCXX_3.4.19GLIBCXX_3.4.20GLIBCXX_3.4.21GLIBCXX_DEBUG_MESSAGE_LENGTH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ubuntu 至此就没问题了，不过 centos 可能会出现另一个问题</p><h2 id="CentOS"><a href="#CentOS" class="headerlink" title="CentOS"></a>CentOS</h2><p>后面我又试了下在我自己的服务器上运行那个编译文件，系统是 CentOS 7.4 的，也有相同的问题，不过解决过程更麻烦一点，还差点掉坑里</p><pre class="line-numbers language-bash"><code class="language-bash">$ ./sandiego_linux_amd64./sandiego_linux_amd64: /lib64/libstdc++.so.6: version `GLIBCXX_3.4.21' not found <span class="token punctuation">(</span>required by ./sandiego_linux_amd64<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>我也是按照上面的流程修复了 libstdc++.so.6</p><pre class="line-numbers language-bash"><code class="language-bash">$ strings /lib64/libstdc++.so.6 <span class="token operator">|</span> <span class="token function">grep</span> GLIBCXXGLIBCXX_3.4GLIBCXX_3.4.1GLIBCXX_3.4.2GLIBCXX_3.4.3GLIBCXX_3.4.4GLIBCXX_3.4.5GLIBCXX_3.4.6GLIBCXX_3.4.7GLIBCXX_3.4.8GLIBCXX_3.4.9GLIBCXX_3.4.10GLIBCXX_3.4.11GLIBCXX_3.4.12GLIBCXX_3.4.13GLIBCXX_3.4.14GLIBCXX_3.4.15GLIBCXX_3.4.16GLIBCXX_3.4.17GLIBCXX_3.4.18GLIBCXX_3.4.19GLIBCXX_DEBUG_MESSAGE_LENGTH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">find</span> / -name libstdc++.so.6\*/usr/lib64/libstdc++.so.6.0.19/usr/lib64/libstdc++.so.6/usr/share/gdb/auto-load/usr/lib64/libstdc++.so.6.0.19-gdb.py/usr/share/gdb/auto-load/usr/lib64/libstdc++.so.6.0.19-gdb.pyo/usr/share/gdb/auto-load/usr/lib64/libstdc++.so.6.0.19-gdb.pyc/var/lib/docker/overlay2/a684a171c4a4128e7417e8a6e99711a6c1e8695b28c79f7ac04853b4c791a8f8/diff/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.22/var/lib/docker/overlay2/a684a171c4a4128e7417e8a6e99711a6c1e8695b28c79f7ac04853b4c791a8f8/diff/usr/lib/x86_64-linux-gnu/libstdc++.so.6/var/lib/docker/overlay2/a684a171c4a4128e7417e8a6e99711a6c1e8695b28c79f7ac04853b4c791a8f8/diff/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.22-gdb.py/var/lib/docker/overlay2/fa428337aa603033a75ff741800ffef75acff1ba104fe044f9ca7638a619603f/diff/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.20/var/lib/docker/overlay2/fa428337aa603033a75ff741800ffef75acff1ba104fe044f9ca7638a619603f/diff/usr/lib/x86_64-linux-gnu/libstdc++.so.6/var/lib/docker/overlay2/fa428337aa603033a75ff741800ffef75acff1ba104fe044f9ca7638a619603f/diff/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.20-gdb.py/var/lib/docker/overlay2/f264ff978011ceb0913e9b52945cc0d4c078420e21142c109f64bcf6b201834b/diff/usr/lib/libstdc++.so.6.0.22/var/lib/docker/overlay2/f264ff978011ceb0913e9b52945cc0d4c078420e21142c109f64bcf6b201834b/diff/usr/lib/libstdc++.so.6/var/lib/docker/overlay2/89238692efa754a079f6e717e168cb48f2f8adac8e63292d262e01785e91d460/merged/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.20/var/lib/docker/overlay2/89238692efa754a079f6e717e168cb48f2f8adac8e63292d262e01785e91d460/merged/usr/lib/x86_64-linux-gnu/libstdc++.so.6/var/lib/docker/overlay2/89238692efa754a079f6e717e168cb48f2f8adac8e63292d262e01785e91d460/merged/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.20-gdb.py/var/lib/docker/overlay2/eb1f84e1a57c8265bb7fbafa30bc0981288b0c0aa847798f1b0a39c38febd2ef/merged/usr/lib/libstdc++.so.6.0.22/var/lib/docker/overlay2/eb1f84e1a57c8265bb7fbafa30bc0981288b0c0aa847798f1b0a39c38febd2ef/merged/usr/lib/libstdc++.so.6/var/lib/docker/overlay2/7fbe72e3e9edf981e086ad156989a803f163f8571d39dad8b637a10426b58851/merged/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.22/var/lib/docker/overlay2/7fbe72e3e9edf981e086ad156989a803f163f8571d39dad8b637a10426b58851/merged/usr/lib/x86_64-linux-gnu/libstdc++.so.6/var/lib/docker/overlay2/7fbe72e3e9edf981e086ad156989a803f163f8571d39dad8b637a10426b58851/merged/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.22-gdb.py/var/lib/docker/overlay2/8a41168be743b65c43f8b0342b801fce9ba1bd54ed01e352495760c83f8b7849/diff/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.22/var/lib/docker/overlay2/8a41168be743b65c43f8b0342b801fce9ba1bd54ed01e352495760c83f8b7849/diff/usr/lib/x86_64-linux-gnu/libstdc++.so.6/var/lib/docker/overlay2/8a41168be743b65c43f8b0342b801fce9ba1bd54ed01e352495760c83f8b7849/diff/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.22-gdb.py/var/lib/docker/overlay2/b64f28f6eb7ec7e168852defcca0a96bff8f83eb7cb09aad03a8b61354c79109/diff/usr/lib/libstdc++.so.6.0.22/var/lib/docker/overlay2/b64f28f6eb7ec7e168852defcca0a96bff8f83eb7cb09aad03a8b61354c79109/diff/usr/lib/libstdc++.so.6/var/lib/docker/overlay2/a7d90ff54666e6643a5a8022eab09de4f6673f6310a22b33d3cd4a426e9a5522/diff/usr/lib/libstdc++.so.6.0.22/var/lib/docker/overlay2/a7d90ff54666e6643a5a8022eab09de4f6673f6310a22b33d3cd4a426e9a5522/diff/usr/lib/libstdc++.so.6/var/lib/docker/overlay2/7b3bd089203729781d7babc38748ea6e91a48bdf09858273ce64db53b32c0b20/merged/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.22/var/lib/docker/overlay2/7b3bd089203729781d7babc38748ea6e91a48bdf09858273ce64db53b32c0b20/merged/usr/lib/x86_64-linux-gnu/libstdc++.so.6/var/lib/docker/overlay2/7b3bd089203729781d7babc38748ea6e91a48bdf09858273ce64db53b32c0b20/merged/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.22-gdb.py/var/lib/docker/overlay2/c3b0fa0a437340abf590624f28339b85868d1918587356f119c2375f9ebc0006/merged/usr/lib/libstdc++.so.6.0.22/var/lib/docker/overlay2/c3b0fa0a437340abf590624f28339b85868d1918587356f119c2375f9ebc0006/merged/usr/lib/libstdc++.so.6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash">$ strings /var/lib/docker/overlay2/a684a171c4a4128e7417e8a6e99711a6c1e8695b28c79f7ac04853b4c791a8f8/diff/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.22 <span class="token operator">|</span> <span class="token function">grep</span> GLIBCXXGLIBCXX_3.4GLIBCXX_3.4.1GLIBCXX_3.4.2GLIBCXX_3.4.3GLIBCXX_3.4.4GLIBCXX_3.4.5GLIBCXX_3.4.6GLIBCXX_3.4.7GLIBCXX_3.4.8GLIBCXX_3.4.9GLIBCXX_3.4.10GLIBCXX_3.4.11GLIBCXX_3.4.12GLIBCXX_3.4.13GLIBCXX_3.4.14GLIBCXX_3.4.15GLIBCXX_3.4.16GLIBCXX_3.4.17GLIBCXX_3.4.18GLIBCXX_3.4.19GLIBCXX_3.4.20GLIBCXX_3.4.21GLIBCXX_3.4.22GLIBCXX_DEBUG_MESSAGE_LENGTH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>找到并替换了文件，但是执行文件后又抛出另一个错误 “GLIBC_2.18’ not found”</p><pre class="line-numbers language-bash"><code class="language-bash">$ ./sandiego_linux_amd64./sandiego_linux_amd64: /lib64/libc.so.6: version `GLIBC_2.18' not found <span class="token punctuation">(</span>required by /lib64/libstdc++.so.6<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>刚开始我以为这个文件和 libstdc++.so.6 一样找到新版本重链接就行，结果差点掉坑里</p><p>先是看了看文件信息</p><pre class="line-numbers language-bash"><code class="language-bash">$ ll /lib64/ <span class="token operator">|</span> <span class="token function">grep</span> libc.so.6lrwxrwxrwx   1 root root   12 Aug 13 14:34 libc.so.6 -<span class="token operator">></span> libc-2.17.so$ strings /usr/lib64/libc.so.6 <span class="token operator">|</span> <span class="token function">grep</span> ^GLIBC_GLIBC_2.2.5GLIBC_2.2.6GLIBC_2.3GLIBC_2.3.2GLIBC_2.3.3GLIBC_2.3.4GLIBC_2.4GLIBC_2.5GLIBC_2.6GLIBC_2.7GLIBC_2.8GLIBC_2.9GLIBC_2.10GLIBC_2.11GLIBC_2.12GLIBC_2.13GLIBC_2.14GLIBC_2.15GLIBC_2.16GLIBC_2.17GLIBC_PRIVATEGLIBC_PRIVATEGLIBC_2.8GLIBC_2.3GLIBC_2.5GLIBC_2.4GLIBC_2.9GLIBC_2.7GLIBC_2.6GLIBC_2.3.2GLIBC_2.3.4GLIBC_2.3.3GLIBC_2.15GLIBC_2.14GLIBC_2.11GLIBC_2.16GLIBC_2.10GLIBC_2.17GLIBC_2.12GLIBC_2.13GLIBC_2.2.5GLIBC_2.2.6$ ldd --versionldd <span class="token punctuation">(</span>GNU libc<span class="token punctuation">)</span> 2.17Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> 2012 Free Software Foundation, Inc.This is <span class="token function">free</span> software<span class="token punctuation">;</span> see the <span class="token function">source</span> <span class="token keyword">for</span> copying conditions.  There is NOwarranty<span class="token punctuation">;</span> not even <span class="token keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.Written by Roland McGrath and Ulrich Drepper.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后找</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">find</span> / -name libc-2.\*/usr/lib64/libc-2.17.so/var/lib/docker/overlay2/a684a171c4a4128e7417e8a6e99711a6c1e8695b28c79f7ac04853b4c791a8f8/diff/lib/x86_64-linux-gnu/libc-2.24.so/var/lib/docker/overlay2/fa428337aa603033a75ff741800ffef75acff1ba104fe044f9ca7638a619603f/diff/lib/x86_64-linux-gnu/libc-2.19.so/var/lib/docker/overlay2/89238692efa754a079f6e717e168cb48f2f8adac8e63292d262e01785e91d460/merged/lib/x86_64-linux-gnu/libc-2.19.so/var/lib/docker/overlay2/7fbe72e3e9edf981e086ad156989a803f163f8571d39dad8b637a10426b58851/merged/lib/x86_64-linux-gnu/libc-2.24.so/var/lib/docker/overlay2/8a41168be743b65c43f8b0342b801fce9ba1bd54ed01e352495760c83f8b7849/diff/lib/x86_64-linux-gnu/libc-2.24.so/var/lib/docker/overlay2/7b3bd089203729781d7babc38748ea6e91a48bdf09858273ce64db53b32c0b20/merged/lib/x86_64-linux-gnu/libc-2.24.so<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我把其中一个 libc-2.24.so 替换了原来的，结果出大麻烦了，把原来的 libc.so.6 移动或者重命名后，什么指令都报错</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">ls</span> -l <span class="token operator">|</span> <span class="token function">grep</span> libc.sols: error <span class="token keyword">while</span> loading shared libraries: libc.so.6: cannot <span class="token function">open</span> shared object file: No such <span class="token function">file</span> or directorygrep: error <span class="token keyword">while</span> loading shared libraries: libc.so.6: cannot <span class="token function">open</span> shared object file: No such <span class="token function">file</span> or directorydate: error <span class="token keyword">while</span> loading shared libraries: libc.so.6: cannot <span class="token function">open</span> shared object file: No such <span class="token function">file</span> or directoryenv: error <span class="token keyword">while</span> loading shared libraries: libc.so.6: cannot <span class="token function">open</span> shared object file: No such <span class="token function">file</span> or directory<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个 libc.so.6 文件是系统底层链接库，移动后，其他依托于这个文件的命令都没法正常运行了，甚至我想把文件重新弄回去也没办法了，因为 mv、cp 都失效了，那时候我已经觉得凉凉~，可能要重装系统了，gg</p><p>先是上网查了一下看看有没有解决办法，找了一圈在 Stack Overflow 上找了几个答案，有一个特别好用:</p><pre class="line-numbers language-bash"><code class="language-bash">$ ldconfig -l -v /lib64/libc-2.17.so    libc.so.6 -<span class="token operator">></span> libc-2.17.so <span class="token punctuation">(</span>changed<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这个 ldconfig 可以直接改回去，命令就恢复正常了，呼~</p><p>所以 CentOS 不能按照 libstdc++.so.6 那一套解决版本问题，升级 libc.so.6 需要另外的方法:</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">wget</span> https://mirrors.tuna.tsinghua.edu.cn/gnu/glibc/glibc-2.20.tar.gz$ <span class="token function">tar</span> -zxvf glibc-2.20.tar.gz$ <span class="token function">mkdir</span> glibcbuild$ <span class="token function">cd</span> glibcbuild$ <span class="token punctuation">..</span>/glibc-2.20/configure  --prefix<span class="token operator">=</span>/usr --disable-profile --enable-add-ons --with-headers<span class="token operator">=</span>/usr/include --with-binutils<span class="token operator">=</span>/usr/bin$ <span class="token function">make</span>$ <span class="token function">make</span> <span class="token function">install</span>$ ldd --versionldd <span class="token punctuation">(</span>GNU libc<span class="token punctuation">)</span> 2.20Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> 2014 Free Software Foundation, Inc.This is <span class="token function">free</span> software<span class="token punctuation">;</span> see the <span class="token function">source</span> <span class="token keyword">for</span> copying conditions.  There is NOwarranty<span class="token punctuation">;</span> not even <span class="token keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.Written by Roland McGrath and Ulrich Drepper.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>安装过程比较缓慢，耐心等待会好，libc 升级完，原来的编译文件就可以运行了</p><p>最后 golang 的自动编译部署方案弃用了这一套，因为每个服务器都得这么折腾一遍太麻烦，我后来用 Jenkins 搭建了一套自动化编译部署的流程，过程更快效果更好</p>]]></content>
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CGO </tag>
            
            <tag> libc </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Mac 系统如何解锁、root、刷 Android 手机</title>
      <link href="/2018/07-root.html"/>
      <url>/2018/07-root.html</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我的设备是 ZUK Z2 (渣又卡) 绝版手机，使用了快两年了，一直没有解锁 root 刷机啥的，最近突然想备份部分单机游戏的存档，发现没有<code>钛备份</code>估计做不了，可是使用钛备份又要 root，root 前又要解锁，解锁又要清空手机数据，这特么无解啊！但是好在论坛上看到有办法实现解锁不清除数据，然后我就试了一下…</p><h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h2><p>第一步千万记得备份，以我以往的刷机经验(血的教训)来看，虽然你照着别人教程一步步弄下来了，但是总会出现不一致的问题，然后误操作很容易失败，最后可能没办法取回数据，所以做这些操作前先把重要的文件保存到其他地方，比如用一些电脑端的手机助手的备份恢复功能就可以，这里如果没有 root 是没法备份应用数据的。</p><h2 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h2><p>安卓手机的解锁、root、刷机都是用 Android SDK 里 platform-tools 里的工具实现的，比如后文要用到的 adb、fastboot 等。</p><p>如果做过移动开发，而且电脑里已经配置了 Android 的相关环境，那么可以跳过这一步。</p><p>如果没有相关环境，即你的 terminal 里输入以下命令是会报错的:</p><pre class="line-numbers language-bash"><code class="language-bash">$ adb --version$ fastboot --version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>那么需要到 <a href="https://developer.android.google.cn/studio/releases/platform-tools" target="_blank" rel="noopener">https://developer.android.google.cn/studio/releases/platform-tools</a> 下载 platform-tools</p><p>比如 mac 下载链接是 <a href="https://dl.google.com/android/repository/platform-tools-latest-darwin.zip" target="_blank" rel="noopener">https://dl.google.com/android/repository/platform-tools-latest-darwin.zip</a></p><pre class="line-numbers language-bash"><code class="language-bash">// 下载$ <span class="token function">wget</span> https://dl.google.com/android/repository/platform-tools-latest-darwin.zip// 解压$ unzip platform-tools-latest-darwin.zip<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>下载解压后得到如下文件 (Mac 版本的):</p><p><img src="https://src.wangriyu.wang/images/blog/root/platform-tools.png" alt="image"></p><p>然后将 adb 和 fastboot 弄到环境目录里，比如 mac:</p><pre class="line-numbers language-bash"><code class="language-bash">// 转到刚才解压出来的目录$ <span class="token function">cd</span> platform-tools// 复制文件到 /usr/bin/$ <span class="token function">sudo</span> <span class="token function">cp</span> adb /usr/bin/adb$ <span class="token function">sudo</span> <span class="token function">cp</span> fastboot /usr/bin/fastboot<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在终端再输入 <code>adb --version</code> 和 <code>fastboot --version</code> 应该能正常输出信息了</p><h2 id="解锁"><a href="#解锁" class="headerlink" title="解锁"></a>解锁</h2><p>部分国产手机需要先解锁才能进入下一步，如果你的手机不需要解锁可以跳过。</p><p>一般官方都会给出解锁通道和解锁方法，按步骤输入命令就行，比如 ZUK 的就是 <a href="http://developer.zuk.com/bootloader_3" target="_blank" rel="noopener">http://developer.zuk.com/bootloader_3</a></p><blockquote><p>⚠️ 注意解锁后不再支持保修</p></blockquote><p>ZUK Z2 的解锁步骤如下，可供参考:</p><p>下载解锁文件 unlock_bootloader.img</p><p>保持手机开机状态且已开启开发者模式，通过 USB 线连接到电脑并确保已信任电脑，在电脑终端中输入如下命令:</p><pre class="line-numbers language-bash"><code class="language-bash">// 输入 adb devices 检测手机是否已连接，如果 List of devices attached 后面没有显示设备就是没识别$ adb devices  List of devices attached  9e6bf666    device// adb <span class="token function">reboot</span> 可以接 <span class="token punctuation">[</span>bootloader<span class="token operator">|</span>recovery<span class="token operator">|</span>sideload<span class="token operator">|</span>sideload-auto-reboot<span class="token punctuation">]</span>$ adb <span class="token function">reboot</span> bootloader // 手机会重启进入 fastboot 模式，屏幕上会出现以下信息:  FASTBOOT MODE  Press volume key to select, and press power key to <span class="token keyword">select</span>  FASTBOOT MODE  PRODUCT_NAME - MSM8996  VARIANT - MTP eMMC  BOOTLOADER VERSION -  BASEBAND VERSION -  SERIAL NUMBER - 2d8b7c81  SECURE BOOT - enabled  DEVICE STATE - locked // locked 代表已锁，unlocked 代表解锁// 在电脑上切换到 unlock_bootloader.img 所在的目录，并输入如下命令开始正式解锁$ fastboot flash unlock unlock_bootloader.img// 命令正确执行后，界面内容没变，对于 Z2、Z2 Pro、Z2 Edge 手机，此时 unlock 的 bootloader.img 已经烧录到手机，但未生效，还需要执行 fastboot oem unlock 命令，执行后按照界面说明，按音量键上下选择 YES 后，按电源键确认继续$ fastboot oem unlock  Unlock bootloader?  If you unlock the bootloader,you will be able to <span class="token function">install</span> custom operating system on this phone.  A custom OS is not subject to the same testing as the original OS,and can cause your phone and installed applications to stop working properly.  To prevent unauthorized access to your personal data,unlocking the bootloader will also delete all personal data from your phone<span class="token punctuation">(</span>a <span class="token string">"factory data reset"</span><span class="token punctuation">)</span>  Press the Volume Up/Down buttons to <span class="token keyword">select</span> Yes or No. Then press Power button to continue.  Yes  Unlock bootloader<span class="token punctuation">(</span>may void warranty<span class="token punctuation">)</span>  NO  Do not unlock bootloader and restart phone此时手机会重启并擦除用户数据<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>需要注意的是这一步，解锁后会自动重启，这时开机第一屏变成了解锁后的提示，需要等待五秒或者手动按电源键才会正常开机。在这个时候按音量键就会选择引导(进入 recovery 或者 fastboot 等)，然后选择 fastboot 模式就回到了之前解锁的那个界面 (fastboot 模式)，这个界面中可以刷入第三方 recovery，命令是 fastboot flash recovery recovery.img，刷完后重启到 recovery，你会看到有命令一闪而过，那就是格式化 data 分区的命令，但是在第三方 recovery 中不会成功执行，这样可以实现解锁不清空数据，但是我第一次弄得时候看到那个英文提示没反应过来，结果五秒后就自动执行擦除数据的程序了，所以一定要注意时间，最好解锁后重启发生界面变化时直接按音量键选择引导方式避免超时自动进入擦除程序。</p><h2 id="刷入第三方-recovery"><a href="#刷入第三方-recovery" class="headerlink" title="刷入第三方 recovery"></a>刷入第三方 recovery</h2><p>去与自己手机相关的论坛上找一找，会找到 rec 相关的帖子，比如我找的帖子就是 <a href="https://club.lenovo.com.cn/thread-3016821-1-1.html" target="_blank" rel="noopener">https://club.lenovo.com.cn/thread-3016821-1-1.html</a></p><p>下载他的文件重命名为 recover.img，放到当前目录中，执行如下命令:</p><pre class="line-numbers language-bash"><code class="language-bash">// 确保手机是在 fastboot 模式中，如果不是可以 adb <span class="token function">reboot</span> bootloader 进入$ fastboot flash recovery recovery.img// 重启进入 recovery$ fastboot boot recovery.img<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果手机能进入第三方 rec 说明成功</p><p><img src="https://src.wangriyu.wang/images/blog/root/ScreenShot-1.png" alt="image"></p><p><img src="https://src.wangriyu.wang/images/blog/root/ScreenShot-2.png" alt="image"></p><h2 id="root"><a href="#root" class="headerlink" title="root"></a>root</h2><p>我刷入的 recovery 自带 root 功能，直接再高级选项里点击 root 就行，如果你刷的 rec 没有可以再找 root 方法，现在已经解锁并刷入第三方 rec，后续很多操作都会方便很多</p><h2 id="刷机"><a href="#刷机" class="headerlink" title="刷机"></a>刷机</h2><p>我这次并没有刷机，因为真正好用的第三方系统不多，如果想刷机，去论坛找自己想要的刷机包，进入 recovery 双清刷入即可，不出意外应该刷入完后就能开机进入新系统了</p>]]></content>
      
      <categories>
          
          <category> 搞机 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> root </tag>
            
            <tag> 刷机 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>分布式相关理论和分布式事务</title>
      <link href="/2018/06-Distribution.html"/>
      <url>/2018/06-Distribution.html</url>
      <content type="html"><![CDATA[<h1 id="分布式系统理论"><a href="#分布式系统理论" class="headerlink" title="分布式系统理论"></a>分布式系统理论</h1><h2 id="CAP-定理"><a href="#CAP-定理" class="headerlink" title="CAP 定理"></a>CAP 定理</h2><p><a href="https://zh.wikipedia.org/wiki/CAP%E5%AE%9A%E7%90%86" target="_blank" rel="noopener">CAP 定理</a>指出对于一个分布式系统来说，不可能同时满足以下三点:</p><ul><li><strong>一致性</strong> (Consistence): 等同于所有节点访问同一份最新的数据副本 (强一致性)</li><li><strong>可用性</strong> (Availability): 每次请求都能获取到非错的响应，但是不保证获取的数据为最新数据</li><li><strong>分区容错性</strong> (Partition tolerance): 系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，此时必须在 C 和 A 之间做出取舍</li></ul><blockquote><p>一个分布式系统里面，节点组成的网络本来应该是连通的。然而可能因为一些故障或者延时，使得有些节点之间不连通了，整个网络就分成了几块区域。数据就散布在了这些不连通的区域中，这就叫分区。当你一个数据项只在一个节点中保存，那么分区出现后，和这个节点不连通的部分就访问不到这个数据了。这时分区就是无法容忍的。提高分区容忍性的办法就是将一个数据项复制到多个节点上，那么出现分区之后，这一数据项就可能分布到各个区里，容忍性就提高了。然而，要把数据复制到多个节点，就会带来一致性的问题，就是多个节点上面的数据可能是不一致的。要保证一致，每次写操作就都要等待全部节点写成功，而这等待又会带来可用性的问题。总的来说就是，数据存在的节点越多，分区容忍性越高，但要复制更新的数据就越多，一致性就越难保证。为了保证一致性，更新所有节点数据所需要的时间就越长，可用性就会降低 – 来自知乎邬江的回答</p></blockquote><p>CAP 理论实际想表达的是任何分布式系统不能同时满足强一致性、高可用性和较好的分区容错性</p><p><img src="https://src.wangriyu.wang/images/blog/distribution/CAP.svg" alt="CAP"></p><blockquote><p>RDBMS: Relational Database Management System，关系型数据库管理系统</p></blockquote><p>由 CAP 定理可知数据库的设计需要权衡取舍，所以可以把数据库大致分为三类:</p><ul><li>CA: 单点集群，满足一致性，可用性的系统，通常在可扩展性上不太强大</li><li>CP: 满足一致性，分区容忍性的系统，通常性能不是特别高</li><li>AP: 满足可用性，分区容忍性的系统，通常可能对一致性要求低一些</li></ul><blockquote><p>分布式和集群的区别:</p><blockquote><p>分布式: 不同的多台服务器上面部署不同的服务模块，他们之间通过 Rpc/HTTP 等方式进行通信和调用，对外提供服务和组内协作</p></blockquote><blockquote><p>集群: 不同的多台服务器上面部署相同的服务模块，通过分布式调度软件进行统一的调度，对外提供服务和访问</p></blockquote></blockquote><h2 id="ACID-和-BASE"><a href="#ACID-和-BASE" class="headerlink" title="ACID 和 BASE"></a>ACID 和 BASE</h2><h3 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h3><p><a href="https://zh.wikipedia.org/wiki/ACID" target="_blank" rel="noopener">ACID</a> 指的是传统数据库中事务操作所具备的四个特性:</p><ul><li>原子性 (Atomicity): 一个事务 (transaction) 中的所有操作作为一个基本单元，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样</li><li>一致性 (Consistency): 在事务开始之前和事务结束以后，数据库的完整性没有被破坏。一个事务能够正确地将数据库从一个一致性状态变换为另一个一致性状态</li><li>隔离性 (Isolation): 也可以称作独立性，数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交 (Read uncommitted)、读提交 (read committed)、可重复读 (repeatable read) 和串行化 (Serializable)</li><li>持久性 (Durability): 事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失</li></ul><h3 id="BASE"><a href="#BASE" class="headerlink" title="BASE"></a>BASE</h3><p>BASE 理论是对 CAP 理论的延伸，核心思想是虽然无法做到强一致性 (Strong Consistency)，但可以采用适合的方式达到最终一致性 (Eventual Consitency)</p><p>BASE 包含三部分:</p><ul><li>基本可用 (Basically Available): 指分布式系统在出现故障的时候，允许损失部分可用性，保证核心可用</li><li>软状态 (Soft State): 指允许系统存在中间状态，而该中间状态不会影响系统整体可用性。分布式存储中一般一份数据至少会有三个副本，允许不同节点间副本同步的延时就是软状态的体现。mysql replication 的异步复制也是一种体现</li><li>最终一致性 (Eventual Consistency): 指系统中的所有数据副本经过一定时间后，最终能够达到一致的状态。最终一致性是弱一致性的一种特殊情况</li></ul><h3 id="两者区别"><a href="#两者区别" class="headerlink" title="两者区别"></a>两者区别</h3><p>ACID 隶属于 CA，是传统数据库常用的设计理念，追求强一致性模型</p><p>BASE 隶属于 AP，支持的是大型分布式系统，提出通过牺牲强一致性获得高可用性</p><p>但在实际的分布式场景中，不同业务单元和组件对数据一致性的要求是不同的，因此在具体的分布式系统架构设计过程中，ACID 特性与 BASE 理论往往会结合在一起使用。比如整体满足 BASE，局部满足 ACID。</p><h2 id="一致性模型"><a href="#一致性模型" class="headerlink" title="一致性模型"></a>一致性模型</h2><ul><li>强一致性: 当更新操作完成之后，任何多个后续进程或者线程的访问都会返回最新的更新过的值。这种是对用户最友好的，就是用户上一次写什么，下一次就保证能读到什么。但是这种实现对性能影响较大，因为这意味着，只要上次的操作没有处理完，就不能让用户读取数据</li><li>弱一致性: 系统并不保证进程或者线程的访问都会返回最新的更新过的值。系统在数据写入成功之后，不承诺立即可以读到最新写入的值，也不会具体的承诺多久之后可以读到。但会尽可能保证在某个时间级别（比如秒级别）之后，可以让数据达到一致性状态<ul><li>最终一致性: 弱一致性的特定形式。系统保证在没有后续更新的前提下，系统最终返回上一次更新操作的值。在没有故障发生的前提下，不一致窗口的时间主要受通信延迟，系统负载和复制副本的个数影响。DNS 是一个典型的最终一致性系统<ul><li>因果一致性: 如果 A 进程在更新之后向 B 进程通知更新的完成，那么 B 的访问操作将会返回更新的值。如果没有因果关系的 C 进程将会遵循最终一致性的规则</li><li>读己所写一致性: 因果一致性的特定形式。一个进程总可以读到自己更新的数据</li><li>会话一致性: 读己所写一致性的特定形式。进程在访问存储系统同一个会话内，系统保证该进程读己之所写</li><li>单调读一致性: 如果一个进程已经读取到一个特定值，那么该进程不会读取到该值旧版本的任何值</li><li>单调写一致性: 系统保证对同一个进程的写操作串行化</li></ul></li></ul></li></ul><p>上述最终一致性的不同方式可以进行组合，例如单调读一致性和读己之所写一致性就可以组合实现。并且从实践的角度来看，这两者的组合，读取自己更新的数据，和一旦读取到最新的版本不会再读取旧版本，对于此架构上的程序开发来说，会少很多额外的烦恼。</p><p>从服务端角度，如何尽快将更新后的数据分布到整个系统，降低达到最终一致性的时间窗口，是提高系统的可用度和用户体验非常重要的方面。</p><p>为了解决分布式的一致性问题，出现了很多一致性协议和算法，比如二阶段提交协议，三阶段提交协议和 Paxos 算法</p><h2 id="FLP-不可能定理"><a href="#FLP-不可能定理" class="headerlink" title="FLP 不可能定理"></a>FLP 不可能定理</h2><p>在<strong>异步</strong>通信场景，即使只有一个进程失败了，也没有任何算法能保证非失败进程能够达到一致性。</p><p>异步通信与同步通信的最大区别是没有时钟、不能时间同步、不能使用超时、不能探测失败、消息可任意延迟、消息可乱序</p><blockquote><p><a href="http://danielw.cn/FLP-proof" target="_blank" rel="noopener">FLP Impossibility 的证明</a></p></blockquote><h1 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h1><p><a href="https://en.wikipedia.org/wiki/Distributed_transaction" target="_blank" rel="noopener">分布式事务</a>用于在分布式系统中保证不同节点之间的数据一致性，通常会涉及到多个数据库。分布式事务处理的关键是必须有一种方法可以知道事务在任何地方所做的所有动作，提交或回滚事务的决定必须产生统一的结果(全部提交或全部回滚)。</p><blockquote><p>DRDA: Distributed Relational Database Architecture，分布式关系数据库架构</p></blockquote><h2 id="XA-规范"><a href="#XA-规范" class="headerlink" title="XA 规范"></a>XA 规范</h2><p>XA 规范是 X/Open 组织(即现在的 Open Group) 关于分布式事务处理 (DTP) 模型的处理规范。</p><p>DTP 模型包括<strong>应用程序 AP</strong>、<strong>事务管理器 TM</strong>、<strong>资源管理器 RM</strong>、<strong>通信资源管理器 CRM</strong> 四部分。常见的事务管理器 TM 是交易中间件，常见的资源管理器 RM 是数据库，常见的通信资源管理器 CRM 是消息中间件。交易中间件是必需的，由它通知和协调相关数据库的提交或回滚。</p><p>规范描述了全局的事务管理器与局部的资源管理器之间的接口。XA 规范的目的是允许的多个资源（如数据库，应用服务器，消息队列，等等）在同一事务中访问，这样可以使 ACID 属性跨越应用程序而保持有效。</p><p>XA 使用两阶段提交或三阶段提交来保证所有资源同时提交或回滚任何特定的事务</p><h3 id="两阶段提交-2PC"><a href="#两阶段提交-2PC" class="headerlink" title="两阶段提交-2PC"></a>两阶段提交-2PC</h3><p>当一个事务跨越多个节点时，为了保持事务的 ACID 特性，需要引入一个作为协调者的组件来统一掌控所有节点(称作参与者)的操作结果并最终指示这些节点是否要把操作结果进行真正的提交。所以<a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4" target="_blank" rel="noopener">两阶段提交 (Two-phase Commit)</a> 的算法思路可以概括为: 参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈情报决定各参与者是否要提交操作还是中止操作。</p><p>两阶段提交需要的条件:</p><ol><li>分布式系统中，存在一个节点作为协调者 (Coordinator)，其他节点作为参与者 (Cohorts)，且节点之间可以进行网络通信</li><li>所有节点都采用预写式日志，且日志被写入后即被保持在可靠的存储设备上，即使节点损坏不会导致日志数据的消失</li><li>所有节点不会永久性损坏，即使损坏后仍然可以恢复</li></ol><p>两个阶段分别为:</p><ol><li>准备阶段(投票阶段)</li><li>提交阶段(执行阶段)</li></ol><h4 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h4><ol><li>事务协调者(事务管理器)给每个参与者(资源管理器)发送 Prepare 消息，询问是否可以执行提交操作，并开始等待各参与者节点的响应</li><li>参与者执行事务操作，并将 Undo 信息和 Redo 信息写入日志</li><li>各参与者节点响应协调者节点发起的询问。如果参与者节点的事务操作实际执行成功，则它返回一个”同意” (agreement) 消息；如果参与者节点的事务操作实际执行失败，则它返回一个”中止” (Abort) 消息</li></ol><p><img src="https://src.wangriyu.wang/images/blog/distribution/2PC_Prepare.svg" alt="Prepare"></p><p>第一阶段也被称作投票阶段，即各参与者投票是否要继续接下来的提交操作</p><h4 id="提交阶段"><a href="#提交阶段" class="headerlink" title="提交阶段"></a>提交阶段</h4><ul><li>当协调者节点从所有参与者节点获得的响应消息都为”同意”时<ol><li>协调者节点向所有参与者节点发出”正式提交”的请求</li><li>参与者节点正式完成操作，并释放在整个事务期间内占用的资源</li><li>参与者节点向协调者节点发送”完成”消息</li><li>协调者节点收到所有参与者节点反馈的”完成”消息后，完成事务</li></ol></li></ul><p><img src="https://src.wangriyu.wang/images/blog/distribution/2PC_Commit_Done.svg" alt="Commit-Done"></p><ul><li>如果任一参与者节点在第一阶段返回的响应消息为”中止”，或者协调者节点在第一阶段的询问超时之前无法获取所有参与者节点的响应消息时<ol><li>协调者节点向所有参与者节点发出”回滚操作”的请求</li><li>参与者节点利用之前写入的 Undo 信息执行回滚，并释放在整个事务期间内占用的资源</li><li>参与者节点向协调者节点发送”回滚完成”消息</li><li>协调者节点收到所有参与者节点反馈的”回滚完成”消息后，取消事务</li></ol></li></ul><p><img src="https://src.wangriyu.wang/images/blog/distribution/2PC_Commit_Failed.svg" alt="Commit-Failed"></p><p>不管最后结果如何，第二阶段都会结束当前事务</p><h4 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h4><p>1、同步阻塞问题。执行过程中，所有参与节点都是事务阻塞型的。当参与者占有公共资源时，其他第三方节点访问公共资源都将处于阻塞状态</p><p>2、单点故障。由于协调者的重要性，一旦协调者发生故障。参与者会一直阻塞下去。尤其在第二阶段，协调者发生故障，那么所有的参与者还都处于锁定事务资源的状态中，而无法继续完成事务操作。（如果是协调者挂掉，可以重新选举一个协调者，但是无法解决因为协调者宕机导致的参与者处于阻塞状态的问题）</p><p>3、数据不一致。在第二阶段中，当协调者向参与者发送 commit 请求之后，发生了局部网络异常或者在发送 commit 请求过程中协调者发生了故障，这会导致只有一部分参与者接受到了 commit 请求。而在这部分参与者接到 commit 请求之后就会执行 commit 操作。但是其他部分未接到 commit 请求的机器则无法执行事务提交，于是整个分布式系统便出现了数据不一致的现象</p><p>4、二阶段提交存在一个无法解决的问题:</p><p>对于现有模型，可能会出现的错误和相应的措施如下</p><ul><li>协调者出错，参与者不出错<ul><li>可以通过快速创建一个新的协调者来解决(或者原本就有备用协调者)</li></ul></li><li>协调者不出错，参与者出错<ul><li>如果参与者是第一阶段一开始就挂了，那么投票失败，协调者取消事务即可</li><li>如果参与者是投完票才挂的，那么投票依旧有效，协调者会下达最终的事务操作指令，正常节点都会完成最后的事务提交或回滚，而挂掉的参与者恢复后只要询问协调者并执行相同的操作即可</li></ul></li><li>协调者出错，参与者也出错<ul><li>这种情况就比较复杂了，需要单独讲</li></ul></li></ul><p>关于第三个问题的详细描述如下:</p><p><img src="https://src.wangriyu.wang/images/blog/distribution/2PC_Failed_0.svg" alt="2PC_Failed_0"></p><p>协调者挂了，RM3 也挂了，此时分两种情况，RM3 是否执行了最后的事务操作:</p><ul><li>RM3 挂之前不管收没收到指令，只要没有执行事务操作，都是不影响最终一致性的，因为 RM3 挂了但它的事务尚未作出最后的提交或回滚时，新的协调者和其他正常节点不管最后是做了提交还是回滚，只要 RM3 恢复后询问新协调者采取相同的操作即可保证全局一致</li><li>严重的问题是挂掉的 RM3 挂之前执行了事务的最终操作:<ul><li>协调者第二阶段发出一条指令后挂了，而 RM3 收到这条指令后对事物做了操作后也跟着挂了，等新的协调者出现时，没有人知道之前原协调者发送的是 Commit 还是 Rollback，也不清楚 RM3 是执行了提交还是回滚；新的协调者出现后会询问各节点状态，如果有节点回复的是 No，那么发送回滚指令，如果各节点都回复 Yes，则发送提交指令；比如上图中新协调者和其他正常节点应该会投票成功然后执行了 Commit 指令，而 RM3 恢复正常后，整体是否一致很难确定，因为 RM3 可能在第一阶段回复的是 Abort，然后原协调者发送了 Rollback，挂之前 RM3 已经回滚，那么此时全局就不一致了(此时需要不一致的 RM3 通过其他方式恢复一致，但完成之前系统整体是不一致的)</li></ul></li></ul><p>最后这个问题就是 2PC 无法解决的问题，但 3PC 可以一定程度上解决</p><h3 id="三阶段提交-3PC"><a href="#三阶段提交-3PC" class="headerlink" title="三阶段提交-3PC"></a>三阶段提交-3PC</h3><p>三阶段提交 (Three-phase Commit) 是针对两阶段缺点而设计的改进型，相比较两阶段提交，做出以下两点改动:</p><ol><li>引入超时机制。同时在协调者和参与者中都引入超时机制(2PC 只有协调者设置了超时机制)，超时后可以默认执行 Commit 或者 Abort，这一点可以避免事务资源长时间被阻塞</li><li>在第一阶段和第二阶段中插入一个准备阶段。保证了在最后提交阶段之前各参与节点的状态是一致的</li></ol><p>三个阶段分为:</p><ol><li>CanCommit</li><li>PreCommit</li><li>DoCommit</li></ol><h4 id="CanCommit"><a href="#CanCommit" class="headerlink" title="CanCommit"></a>CanCommit</h4><ol><li>协调者向参与者发送 CanCommit 请求。询问是否可以执行事务提交操作。然后开始等待参与者的响应</li><li>参与者接到 CanCommit 请求之后，正常情况下，如果其自身认为可以顺利执行事务，则返回 Yes 响应，并进入预备状态。否则反馈 No</li></ol><p><img src="https://src.wangriyu.wang/images/blog/distribution/3PC_CanCommit.svg" alt="CanCommit"></p><h4 id="PreCommit"><a href="#PreCommit" class="headerlink" title="PreCommit"></a>PreCommit</h4><ul><li>假如协调者从所有的参与者获得的反馈都是 Yes 响应，那么就会执行事务的预执行:<ol><li>发送预提交请求协调者向参与者发送 PreCommit 请求，并进入 Prepared 阶段</li><li>事务预提交参与者接收到 PreCommit 请求后，会执行事务操作，并将 Undo 和 Redo 信息记录到事务日志中</li><li>如果参与者成功的执行了事务操作，则返回 ACK 响应，同时开始等待最终指令</li></ol></li></ul><p><img src="https://src.wangriyu.wang/images/blog/distribution/3PC_PreCommit_Yes.svg" alt="3PC_PreCommit_Yes"></p><blockquote><p>此图中如果某条 PreCommit 消息未到达或者超时，RM 应该中断自己本地的事务，就跟下图中 Abort 超时一样</p></blockquote><ul><li>假如有任何一个参与者向协调者发送了 No 响应，或者等待超时之后，协调者都没有接到参与者的响应，那么就执行事务的中断:<ol><li>发送中断请求协调者向所有参与者发送 Abort 请求</li><li>参与者收到来自协调者的 Abort 请求之后（或超时之后，仍未收到协调者的请求），执行事务的中断</li></ol></li></ul><p><img src="https://src.wangriyu.wang/images/blog/distribution/3PC_Precommit_Abort.svg" alt="3PC_Precommit_Abort"></p><h4 id="DoCommit"><a href="#DoCommit" class="headerlink" title="DoCommit"></a>DoCommit</h4><p>根据情况分为两种情形:</p><ul><li>正常响应后执行提交操作完成事务:<ol><li>协调者接收到 PreCommit 阶段中参与者发送的 ACK 响应，那么他将从预提交状态进入到提交状态，并向所有参与者发送 DoCommit 请求</li><li>参与者接收到 DoCommit 请求之后，执行正式的事务提交，并在完成事务提交之后释放所有事务资源</li><li>事务提交完之后，向协调者发送 ACK 响应</li><li>协调者接收到所有参与者的 ACK 响应之后，完成事务</li></ol></li></ul><p><img src="https://src.wangriyu.wang/images/blog/distribution/3PC_DoCommit_Done.svg" alt="3PC_DoCommit_Done"></p><ul><li>协调者没有接收到参与者发送的 ACK 响应（可能是接受者发送的不是 ACK 响应，也可能响应超时），那么就会执行中断事务:<ol><li>协调者向所有参与者发送 Abort 请求</li><li>参与者接收到 Abort 请求之后，利用其在阶段二记录的 Undo 信息来执行事务的回滚操作，并在完成回滚之后释放所有的事务资源。</li><li>参与者完成事务回滚之后，向协调者发送 ACK 消息</li><li>协调者接收到参与者反馈的 ACK 消息之后，结束事务</li></ol></li></ul><p><img src="https://src.wangriyu.wang/images/blog/distribution/3PC_DoCommit_Failed.svg" alt="3PC_DoCommit_Failed"></p><p>图中 RM3 在第二阶段未正常响应 ACK，可能有如下情况:</p><ul><li>比如 RM3 未正常接收 PreCommit 消息，在第二阶段就取消了本地事务，所以没有返回 ACK，则第三阶段接收 Abort 时并不需要做什么</li><li>也可能是 RM3 收到了 PreCommit 消息并执行了事务操作，但是 ACK 消息发送超时，则第三阶段接收 Abort 时也是同其他节点一样执行 Undo 回滚</li><li>如果是第二阶段 RM3 挂了，如果是持久性挂了，那就挂了吧，现阶段就不管它了，等恢复了再做数据同步；如果挂了之后又恢复了，需要询问 TM 现在的事务状态来进行判断是否取消本地事务还是继续完成事务</li></ul><blockquote><p>在第三阶段，如果<strong>参与者</strong>无法及时接收到来自协调者的 DoCommit 或者 Abort 请求时，会在<strong>等待超时之后，会继续进行事务的提交</strong></p><p>这么做是有一定考究的，因为能进入第三阶段，说明协调者肯定在第二阶段发起了 PreCommit 请求，而发起 PreCommit 请求的前提是第一阶段所有参与者都响应了 Yes，这表明所有参与者当时的状态都是乐观的，那么第三阶段参与者就算没有<strong>按时</strong>收到来自协调者的 DoCommit 请求，也继续完成本地事务的提交，这样完成全局事务的可能性还是很大的，这一点是针对 2PC 数据不一致问题的</p><p>但是这一点也会造成 3PC 的一致性缺陷: 如果此时是协调者对某个 RM 发出的 Abort 请求超时，而那个 RM 继续完成本地事务的提交，这就会造成与其他进行回滚操作的节点数据不一致(这种情况概率较小)</p></blockquote><h4 id="缺陷-1"><a href="#缺陷-1" class="headerlink" title="缺陷"></a>缺陷</h4><p>对应 2PC 的缺陷，我们可以看到 3PC 解决了不少问题，一方面默认的超时机制可以避免单点故障造成的资源长久阻塞的问题；另一方面状态确认和默认超时提交也可以解决 2PC 的数据不一致问题(虽然这会造成 3PC 自己的不一致问题，但是因为 3PC 的机制，这种概率更小)</p><p>至于前面提到的 2PC 无法解决的问题，3PC 又是怎么解决的呢?</p><p>我们可以回想 2PC 的问题，冲突的条件就是 RM3 第一阶段投了反对票，而这件事只有原协调者知道，挂掉的两者执行了回滚操作，而新协调者和正常节点会执行提交操作；但是 3PC 将准备阶段分为两步可以确保最终事务操作之前，大家都知道投票结果，描述如下:</p><ul><li>假如同样是第二阶段协调者和 RM3 挂了</li></ul><p><img src="https://src.wangriyu.wang/images/blog/distribution/3PC_Failed_0.svg" alt="3PC_Failed_0"></p><p>其实只要没有执行事务最终的提交或者回滚都不影响最终结果，只要后面 RM3 恢复后查询协调者并执行相同的操作即可</p><ul><li>假如是进入第三阶段协调者和 RM3 挂了，而且 RM3 已经执行了最终操作</li></ul><p><img src="https://src.wangriyu.wang/images/blog/distribution/3PC_Failed_1.svg" alt="3PC_Failed_1"></p><p>这时候新协调者出现后，只要查看正常节点的状态就可以知道发送提交还是回滚指令: 如果都是 Commited 或者 PreCommit 状态，说明第一轮投票结果都是 Yes，否则不可能进入 PreCommit 状态，所以新协调者发送提交指令即可；如果存在节点的状态是 Cancel，说明第一轮投票结果有反对票，那么新协调者发送回滚指令即可。可能这里会有个疑问，讲 DoCommit 的时候我们说过第二阶段参与者的 ACK 可能无法正常响应协调者，如果是 RM3 第一轮投了支持票后面进入 PreCommit 状态时没有把 ACK 正常响应给协调者，因此协调者发送了 Abort 指令给 RM3 后挂了，RM3 收到指令后也挂了，此时还是会造成 RM3 回滚，而新协调者和正常节点执行提交的状况，这里其实 3PC 好像也没法解决，但是这种情况的概率你可以估算一下，本来协调者发送指令挂了然后某些参与者执行后也挂了的概率本身就低了，还要满足挂的协调者在投完支持票后响应超时引起协调者发送 Abort 指令的概率，那就更小了</p><h3 id="理解-2PC-和-3PC"><a href="#理解-2PC-和-3PC" class="headerlink" title="理解 2PC 和 3PC"></a>理解 2PC 和 3PC</h3><p>我们用一个实际生活的例子来说明并理解这个过程:</p><p>假设协调者是牧师，而参与者是一男一女，他们来到教堂单独跟牧师见面并传达是否想跟另一方建立更深的关系的信息</p><h4 id="2PC"><a href="#2PC" class="headerlink" title="2PC"></a>2PC</h4><p>第一步男女双方给牧师递了小纸条，上面写着是否想跟另一方建立更深的关系，并且各自准备好了信物 (Undo&amp;Redo)</p><p>第二步牧师看过之后，如果双方都写“是”，那么告知双方交换信物表示可以继续深交；如果有一方写“否”，那么告知双方分手吧，信物也撤了吧</p><p>但是这里 2PC 无法解决一个问题: 假如男方写的纸条信息是“否”，而牧师看过之后先告诉男方你把信物撤了吧，你们不合适，但是牧师紧接着心脏病犯了住院了，而男方收到消息后也撤了信物准备分手，可是男方突然被人打了住院昏迷；新牧师出现，继续询问女方的意见，因为不知道男方的意见，他们可能会促成一桩不美满的关系</p><h4 id="3PC"><a href="#3PC" class="headerlink" title="3PC"></a>3PC</h4><p>第一步男女双方还是递了小纸条，表示自己的意愿</p><p>第二步牧师看过之后，如果双方都写“是”，那么先告知双方准备信物；如果有一方写“否”，那么告知双方不用准备信物了；双方收到消息后再回应说自己知道了</p><p>第三步牧师确认双方的回应后，告知双方最后是否在一起，是否交换信物</p><p>在这里假如第三步牧师也是先告知男方后突发心脏病住院，而男方也是收到消息后被打昏迷，此时新牧师出现后可以查看女方是否准备了信物而完成最后的决定，因为假如男方原本是不同意，那么第二步双方肯定是没有准备信物的，而假如男方是同意的，那么双方肯定是准备了信物的，那么新牧师可以放心宣布双方可以在一起</p><p>3PC 还对双方都引入了超时，2PC 中只有牧师没收到消息时会取消事务，而 3PC 中如果男女双方长时间没有收到牧师消息后也会执行自己的决定，避免了 2PC 中同样情形时男女双方在这里一直耗着(阻塞)而错过了下一任。只不过我们提到了如果第三步牧师是因为长时间没有收到男方的消息时也取消了事务，虽然这时候男女双方都是同意的，但是还是会被取消事务，这也可能造成新的不一致问题，但是相对来说概率就小得多了</p><h3 id="解决不一致问题"><a href="#解决不一致问题" class="headerlink" title="解决不一致问题"></a>解决不一致问题</h3><p>通过上述过程可知最后无论是二阶段提交还是三阶段提交都无法彻底解决分布式的一致性问题，如果系统正常运行都能满足强一致性，但是如果出现意外还是会导致不一致，不过可以通过其他手段达到一致性，比如分区数据恢复或者事务补偿机制或者采用其他一致性算法</p><h4 id="分区数据恢复"><a href="#分区数据恢复" class="headerlink" title="分区数据恢复"></a>分区数据恢复</h4><p><img src="https://src.wangriyu.wang/images/blog/distribution/Partition-Recover.png" alt="Partition-Recover"></p><p>复杂的数据恢复可以参见 SVN 的版本控制，可能可以自动合并，也可能会发生冲突然后需要人工干预</p><p>简单的数据恢复可以参见 Mysql 的主从同步，数据可以自动从主库导到从库</p><p>合并分区数据达成一致并不是最困难的，更困难的是处理分区过程中产生的错误。当分区操作引起错误，可以通过事务补偿补救错误，这可能是人工的也可能是自动的</p><h4 id="分区事务补偿"><a href="#分区事务补偿" class="headerlink" title="分区事务补偿"></a>分区事务补偿</h4><p>比如 MQ 消息事务和 TCC 事务协议就是一种补偿机制:</p><ul><li>MQ 事务: 利用消息中间件来异步完成事务的后一半更新，实现系统的最终一致性</li><li>TCC 事务: TCC 是阿里巴巴提出的协议，将一个事务分为 Try、Commit、Cancel 三部分，也可以达到最终一致性</li></ul><h4 id="其他一致性算法"><a href="#其他一致性算法" class="headerlink" title="其他一致性算法"></a>其他一致性算法</h4><ul><li><a href="https://zh.wikipedia.org/wiki/Paxos%E7%AE%97%E6%B3%95" target="_blank" rel="noopener">Paxos 算法</a>: 一种基于消息传递且具有高度容错特性的一致性算法<ul><li><a href="https://zh.wikipedia.org/wiki/Raft" target="_blank" rel="noopener">Raft 算法</a>: Raft 是一个共识算法，用于取代 Paxos。Raft 的目标是提供更好理解的算法，并且证明可以提供与 Paxos 相同的容错性以及性能</li><li><a href="https://distributedalgorithm.wordpress.com/2015/06/20/architecture-of-zab-zookeeper-atomic-broadcast-protocol/" target="_blank" rel="noopener">Zab</a>: Zookeeper atomic broadcast protocol，是 Zookeeper 内部用到的一致性协议。相比 Paxos，Zab 最大的特点是保证强一致性 (strong consistency，或叫线性一致性 linearizable consistency)</li></ul></li></ul><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="http://www.hollischuang.com/archives/666" target="_blank" rel="noopener">分布式系统的 CAP 理论</a></li><li><a href="http://www.yunweipai.com/archives/8432.html" target="_blank" rel="noopener">CAP 理论</a></li><li><a href="http://www.hollischuang.com/archives/1580" target="_blank" rel="noopener">深入理解分布式系统的 2PC 和 3PC</a></li><li><a href="https://www.jianshu.com/p/1156151e20c8" target="_blank" rel="noopener">分布式服务化系统一致性的“最佳实干”</a></li><li><a href="https://draveness.me/consensus" target="_blank" rel="noopener">分布式一致性与共识算法</a></li></ul>]]></content>
      
      <categories>
          
          <category> 分布式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 两阶段提交 </tag>
            
            <tag> 三阶段提交 </tag>
            
            <tag> 分布式理论 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>浏览器的 Copy 事件</title>
      <link href="/2018/06-share.html"/>
      <url>/2018/06-share.html</url>
      <content type="html"><![CDATA[<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>很多分享都有一个点击复制当前链接的功能，所以我们需要一个按钮，点击出现弹框并显示已复制的链接</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="第一版"><a href="#第一版" class="headerlink" title="第一版"></a>第一版</h3><p>根据网上关于浏览器的 Copy 事件实现第一版的复制按钮，点击会出现弹框，并显示已复制到剪切板的链接:</p><p><a href="/pages/share/index-1.html">点击我查看</a></p><h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>copyBtn<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>iconfont icon-link<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>social_name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>CopyButton 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript"><code class="language-javascript">document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'copyBtn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">'copy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'modal-container'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> <span class="token string">'sketch'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'copyBtn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>oncopy <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">-</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>clipboardData<span class="token punctuation">)</span> <span class="token punctuation">{</span>            window<span class="token punctuation">.</span>clipboardData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">'Text'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>            document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> window<span class="token punctuation">.</span>clipboardData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">'Text'</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>clipboardData<span class="token punctuation">)</span> <span class="token punctuation">{</span>            event<span class="token punctuation">.</span>clipboardData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">'text/plain'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>            document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> event<span class="token punctuation">.</span>clipboardData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>Chrome 上一切正常，Perfect !!</p><p>但是拿到 Safari 上试了一下，发现不行，没有触发复制事件，Oh My God !!</p><h3 id="第二版"><a href="#第二版" class="headerlink" title="第二版"></a>第二版</h3><p>经过再三查询与尝试找到了 Safari 不能复制的原因，Safari 需要先选中某部分文本才能触发 Copy 事件</p><p>修改实现第二版:</p><p><a href="/pages/share/index-2.html">点击我查看</a></p><h4 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h4><pre class="line-numbers language-diff"><code class="language-diff"><span class="token deleted">&lt;span id="copyBtn" class="item"></span>    &lt;i class="iconfont icon-link">&lt;/i>    &lt;span class="social_name">CopyButton 1&lt;/span><span class="token inserted">+   &lt;textarea id="selection" style="display: none">window.location.href&lt;/textarea></span><span class="token deleted">&lt;/span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-diff"><code class="language-diff">document.getElementById('copyBtn').onclick = function () {<span class="token inserted">+   document.getElementById('selection').select();</span>    document.execCommand('copy');    document.getElementById('modal-container').setAttribute('class', 'sketch')}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>现在 Chrome 和 Safari 都表现正常，试下移动端</p><p>发现安卓正常，至少我测试的几个浏览器还算正常</p><p>但是!! ios 的 Safari 浏览器又出现未触发复制事件的问题</p><h3 id="第三版"><a href="#第三版" class="headerlink" title="第三版"></a>第三版</h3><p>又一次再三查询与尝试，发现移动端的 Safari 浏览器并不能触发 oncopy 事件，需要使用 setSelectionRange 选中复制的文本，而且这个文本区域必须可见，且不能被其他元素遮挡…</p><p>上面针对桌面端实现的代码中我加了一个 textarea 标签用于选中，但是设置 <code>display: none</code> 为不可见，因为我并不需要这个选中文本，只是为了选中后能触发 Copy 事件；</p><p>而移动端如果设置这个文本区域不可见的话无法选中并复制，经过尝试需要使用 setSelectionRange 和一个随用随删的 input 标签来实现复制</p><p>修改后效果，也是最终效果:</p><p><a href="/pages/share/index-3.html">点击我查看</a></p><h4 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h4><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>copyBtn<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>iconfont icon-link<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>social_name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>CopyButton 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>selection<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">display</span><span class="token punctuation">:</span> none</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>url<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript"><code class="language-javascript">document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'copyBtn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> input <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    input<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'readonly'</span><span class="token punctuation">,</span> <span class="token string">'readonly'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    input<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/\(i[^;]+;( U;)? CPU.+Mac OS X/</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// fix ios safari copy event</span>        input<span class="token punctuation">.</span><span class="token function">setSelectionRange</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// fix desktop safari copy event</span>        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'selection'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    document<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">"copy"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"link"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">"Failed！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'modal-container'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> <span class="token string">'sketch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'copyBtn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>oncopy <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">-</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>clipboardData<span class="token punctuation">)</span> <span class="token punctuation">{</span>            window<span class="token punctuation">.</span>clipboardData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">'Text'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>            document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> window<span class="token punctuation">.</span>clipboardData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">'Text'</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>clipboardData<span class="token punctuation">)</span> <span class="token punctuation">{</span>            event<span class="token punctuation">.</span>clipboardData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">'text/plain'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>            document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> event<span class="token punctuation">.</span>clipboardData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h4><p>第三版在主流浏览器上都能满足需求了</p>]]></content>
      
      <categories>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Copy </tag>
            
            <tag> 浏览器 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>数据结构 - 哈希</title>
      <link href="/2018/06-Hash.html"/>
      <url>/2018/06-Hash.html</url>
      <content type="html"><![CDATA[<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>在 MySQL 中，主要有四种类型的索引，分别为：B-Tree 索引，Hash 索引，Fulltext 索引和 R-Tree 索引。前一节已经讲了 B 类树的结构特点，这次讲哈希索引，至于后面的<a href="https://en.wikipedia.org/wiki/Full-text_search" target="_blank" rel="noopener">全文索引</a>和 <a href="https://zh.wikipedia.org/wiki/R%E6%A0%91" target="_blank" rel="noopener">R 树索引</a>感兴趣自己看吧。</p><p>之前讲 B 树时提到过哈希索引可以支持动态长度，而且由于 Hash 索引结构的特殊性，其检索效率非常高，最好的情况可以一次定位，查询效率远大于 B 树，但是实际运用中主要还是用 B 树做索引，因为哈希索引有以下局限性:</p><blockquote><p>（1）Hash 索引适合定值查询，不能做范围查询</p><p>由于 Hash 索引比较的是进行 Hash 运算之后的 Hash 值，所以它只能用于等值的过滤，不能用于基于范围的过滤，因为经过相应的 Hash 算法处理之后的 Hash 值的大小关系，并不能保证和 Hash 运算前完全一样。</p><p>（2）Hash 索引无法用于排序操作</p><p>由于 Hash 索引中存放的是经过 Hash 计算之后的 Hash 值，而且 Hash 值的大小关系并不一定和 Hash 运算前的键值完全一样，所以数据库无法利用索引的数据来进行任何排序运算；</p><p>（3）Hash 索引不能利用部分索引键查询</p><p>比如 (a,b,c) 形式的组合索引，查询中只用到了 a 和 b 也是可以查询的，如果使用 hash 表，组合索引会将几个字段合并 hash，没办法支持部分索引</p><p>（4）Hash 索引遇到大量 Hash 值相等的情况后性能并不一定就会比 B-Tree 索引高</p><p>数据库支持非唯一的 Hash 索引，如果遇到非唯一值，存储引擎会将他们链接到同一个 hash 键值下以一个链表的形式存在，然后在取得实际键值的时候再过滤不符合的键</p></blockquote><p>Hash 索引在 MySQL 中使用的并不是很多，目前主要是 Memory 和 NDB 引擎会使用；而常用的 Innodb 存储引擎和 MyISAM 引擎使用的索引还是 B+ 树为主</p><h2 id="哈希表"><a href="#哈希表" class="headerlink" title="哈希表"></a>哈希表</h2><p><a href="https://zh.wikipedia.org/wiki/%E5%93%88%E5%B8%8C%E8%A1%A8" target="_blank" rel="noopener">哈希表 (Hash Table)</a>，也叫散列表，是根据键（Key）转换而直接访问在存储地址的数据结构。</p><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>比如我们有关键字 k，则其值存放在 f(k) 的存储位置上，因此不需要比较就可以找到记录。这个映射关系 f(x) 称为<strong>哈希函数(散列函数)</strong>，以此建立的表就是<strong>哈希表</strong>。</p><p>哈希表中存着的是包含存储单元的数组，这些存储单元我们称作<strong>槽 (slot)</strong> 或者<strong>桶 (bucket)</strong> ，每个存储单元可以容纳一个或多个关键字信息。理想情况下，完美的散列函数能为关键字找到唯一的独占的桶，但大多数情况下用到的散列函数都是不完美的，会存在冲突；</p><p>对不同的关键字可能得到同一散列地址，即 k1 != k2，而 f(k1) == f(k2)，这种现象称为<strong>冲突</strong> (Collision)。具有相同函数值的关键字对该散列函数来说称做<strong>同义词</strong>。</p><p>若对于关键字集合中的任一个关键字，经散列函数映象到地址集合中任何一个地址的概率是相等的，则称此类散列函数为<strong>均匀散列函数</strong>（Uniform Hash function），这就是使关键字经过散列函数得到一个“随机的地址”，从而减少冲突</p><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><img src="https://src.wangriyu.wang/images/blog/hash/hash-principle-0.svg" alt="image"></p><p>输入一个关键字 “lies”，经过散列得到值 9，对应哈希表得到我们要的地址 20</p><p>从关键字到索引值的转换过程使用的就是散列函数，散列函数有很多种，比如一种简单的散列方式如下:</p><p><img src="https://src.wangriyu.wang/images/blog/hash/hash-principle-1.svg" alt="image"></p><p>取关键字每个字符的 ASCII 码，相加，即 lies -&gt; 108+105+101+115 -&gt; 429</p><p>但是我们的表只有 30 项，那么可以再把上面的值模 30: 429 mod 30 = 9</p><p>一个散列就完成了</p><p>但是继续输入发现:</p><p><img src="https://src.wangriyu.wang/images/blog/hash/hash-principle-2.svg" alt="image"></p><p>关键字 “foes” 散列后也对应表下标 9，这就是冲突，”lies” 和 “foes” 是同义词</p><p>每种哈希表实现都要有处理冲突的方法，处理冲突也有很多方式，比如这里可以用简单的链表来处理:</p><p><img src="https://src.wangriyu.wang/images/blog/hash/hash-principle-3.svg" alt="image"></p><p>之前哈希表中索引对应的就是具体的地址，而现在改成一个指向链表的指针，所有同义词都存在相应链表中</p><p>但是我们怎么直到链表哪个是 “lies” 哪个是 “foes” 呢，可以在链表每个节点中添加关键字信息:</p><p><img src="https://src.wangriyu.wang/images/blog/hash/hash-principle-4.svg" alt="image"></p><p>这样冲突就算处理了，但是这种哈希表结构的最坏情况是 O(n)，不同于之前 O(1)。因为假如大部分关键字都是冲突的，那么这些关键字就变为链表查询了。</p><p>因此一个<strong>均匀的散列函数</strong>和一个高效的<strong>处理冲突的方法</strong>对哈希表来说至关重要</p><p>下面会介绍一些常见的哈希函数和处理冲突的方法</p><h3 id="哈希函数"><a href="#哈希函数" class="headerlink" title="哈希函数"></a>哈希函数</h3><ol><li>直接定址法：取关键字或关键字的某个线性函数值为散列地址。即 hash(k) = k 或 hash(k) = a * k + b，其中 a, b 为常数（这种散列函数叫做自身函数）</li><li>数字分析法：假设关键字是以 r 为基的数，并且哈希表中可能出现的关键字都是事先知道的，则可取关键字的若干数位组成哈希地址</li><li>平方取中法：取关键字平方后的中间几位为哈希地址。通常在选定哈希函数时不一定能知道关键字的全部情况，取其中的哪几位也不一定合适，而一个数平方后的中间几位数和数的每一位都相关，由此使随机分布的关键字得到的哈希地址也是随机的。取的位数由表长决定。比如 {421，423，436}，平方之后的结果为{177241，178929，190096}，那么可以取中间的两位数{72，89，00}作为 Hash 地址</li><li>折叠法：将关键字分割成位数相同的几部分（最后一部分的位数可以不同），然后取这几部分的叠加和（舍去进位）作为哈希地址。比如图书的 ISBN 号为 8903-241-23，可以将 address(key)=89+03+24+12+3 作为 Hash 地址。</li><li>随机数法</li><li>除留余数法：取关键字被某个不大于散列表表长 m 的数 p 除后所得的余数为散列地址。即 hash(k) = k mod p, p &lt;= m。不仅可以对关键字直接取模，也可在折叠法、平方取中法等运算之后取模。对 p 的选择很重要，一般取素数或 m，若 p 选择不好，也容易产生冲突</li></ol><h3 id="冲突"><a href="#冲突" class="headerlink" title="冲突"></a>冲突</h3><h4 id="影响因素"><a href="#影响因素" class="headerlink" title="影响因素"></a>影响因素</h4><p>影响产生冲突多少有以下三个因素：</p><ul><li>散列函数是否均匀</li><li>处理冲突的方法</li><li>散列表的负载因子</li></ul><p>散列表的负载因子定义为：α = 填入表中的元素个数 / 散列表的长度。α 是散列表装满程度的标志因子。<br>由于表长是定值，α 与“填入表中的元素个数”成正比，所以 α 越大，表明填入表中的元素越多，产生冲突的可能性就越大。</p><h4 id="处理方法"><a href="#处理方法" class="headerlink" title="处理方法"></a>处理方法</h4><p>1、<a href="https://en.wikipedia.org/wiki/Open_addressing" target="_blank" rel="noopener">开放寻址 (open addressing/closed hashing)</a>: 一旦发生了冲突，通过<strong>探测</strong>寻找其他空的位置，然后插入。</p><p>$ hash_i = (hash(k) + d_i) $ mod m, i = 1, 2, 3…m-1, 其中 hash(k) 为散列函数，$ d_i $ 是增量序列，m 为哈希表长，i 为已发生冲突的次数。</p><p>hash(k) 是初始的探测位置，之后的探测位置 $ hash _1, hash_2, hash_3…hash _{m-1} $ 形成一个探测序列。</p><p>如果 $ d_i $ = i = 1, 2, 3…m-1，则为<strong>线性探测</strong>，相当于逐一往下找表空闲位置</p><p>如果 $ d_i = \pm1^2, \pm2^2, \pm3^2…\pm k^2 $，则为<strong>二次探测(或者叫平方探测)</strong>，相当于探测间隔为 $ \pm i^2 $</p><p>如果 $ d_i = i * rehash(k) $，rehash 是另一个哈希函数，则为<strong>双散列探测</strong></p><p>如果 $ d_i $ = 伪随机数序列，则为<strong>伪随机探测</strong></p><p>对开放寻址散列表性能的关键影响是载荷因子。随着载荷系数增加到 100％，可能需要查找或插入给定关键字的探针数量急剧增加。一旦表格变满，探测算法甚至可能无法终止。即使具有良好的散列函数，也应严格限制载荷因子在 0.7-0.8 以下，比如 Java 的系统库限制了荷载因子为 0.75，超过此值将动态调整散列表大小。</p><p>2、单独链表法。即上述原理用到的方法，也叫<strong>拉链法</strong>，链表的使用方式可以分很多种，可以见 <a href="https://en.wikipedia.org/wiki/Hash_table#Separate_chaining" target="_blank" rel="noopener">WikiPedia 的事例</a>，另外算法导论里提到一种完全散列的方式，相当于二维哈希表，每个槽对应的是另一个哈希列表，也值得借鉴</p><p>3、再散列: $ hash_i = rehash_i(k), i = 1, 2, 3…k $, 在发生冲突时，使用其他散列函数计算哈希值，直到冲突不再发生。这种方法不易产生“聚集”，但增加了计算时间。</p><p>4、建立一个公共溢出区</p><h3 id="动态哈希"><a href="#动态哈希" class="headerlink" title="动态哈希"></a>动态哈希</h3><p>前面的问题都是以哈希表定长为基础的，但是当关键字较多时，哈希表出现<strong>聚集</strong>时，性能会急剧下降。</p><p>即散列表的载荷因子较大时需要考虑扩充哈希表大小，如果是静态 hash，则需要新建一张更大的表，然后将所有关键字重新散列到新的表中，之后删除旧表</p><p>而动态散列可以在哈希表元素增长的同时，动态的调整 hash 桶的数目，动态 hash 不需要对原有元素进行重新插入(重组)，而是在原基础上，进行动态的桶扩展。</p><p>有以下三种方法可以实现动态 hash:</p><ul><li>多 hash 表</li><li>可扩展的动态散列</li><li>线性散列</li></ul><h4 id="多-hash-表"><a href="#多-hash-表" class="headerlink" title="多 hash 表"></a>多 hash 表</h4><p>多 hash 表就是采用多张哈希表来扩充原哈希表。</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Hash-0.svg" alt="hash table"></p><p>如图，哈希函数为 hash(k) = k % 5，每个桶最多含 4 个关键字</p><p>当我们要插入关键字 5 时，hash 值为 0，应该插入 Bucket 1 中，而且 Bucket 1 有空闲位置，直接插入即可；</p><p>当我们要插入关键字 3 时，hash 值为 3，应该插入 Bucket 3 中，但是 Bucket 3 已经满了，此时新建一张 hash 表来完成插入</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Hash-1.svg" alt="hash table"></p><p>对于此种方式，执行插入、查找、删除操作时，均需先求得 hash 值 x。</p><ul><li>插入时，得到当前的 hash 表的个数，并分别取得各个 hash 表的 x 位置上的索引项，若其中某个项指向的桶存在空闲位置，则插入之。同时，在插入时，可保持多个 hash 表在某个索引项上桶中元素的个数近似相等。若不存在空闲位置，则简单的进行表扩充，即新建一个 hash 表，如上所示</li><li>查找时，由于某个记录值可能存在当前 hash 结构的多个表中，因此需同时在多个 hash 表的同一位置上进行查找操作，等待所有的查找结束后，方可判定该元素是否存在。由于该种结构需进行多次查找，当表元素非常多时，为提高效率，在多处理器上可采用多线程，并发执行查找操作</li><li>删除操作，与上述过程基本类似。需要注意的是，若删除操作导致某个 hash 表元素为空，这时可将该表从结构中剔除</li></ul><p>这种方式的优点是设计和实现比较简单的。缺点是占用空间大，而且关键字较密集时空间利用率低。</p><h4 id="可扩展的动态散列"><a href="#可扩展的动态散列" class="headerlink" title="可扩展的动态散列"></a>可扩展的动态散列</h4><p>引入一个仅存储桶指针的索引数组，用翻倍的索引项数来取代翻倍的桶的数目，且每次只分裂有溢出的桶，从而减小翻倍的代价。</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Extendible-hashing-0.svg" alt="Extendible hashing"></p><p>如图所示哈希表有一个标识表示全局位深度 (Global Depth)，全局位深度表示取哈希值的低几位作为索引，比如 hash(k4) = 0100，全局位深度为 2，则取低两位 00 归属到 00 索引的桶中，而且哈希表索引项数始终等于 2 ^ Global Depth；桶中有一个本地位深度 (Local Depth)，本地位深度表示当前桶中元素的低几位是一样的；图中给出的桶中元素表示哈希后的值，比如桶 1 中 4 表示哈希值为 0100 的关键字 k4</p><ul><li>插入时，计算出哈希值再根据全局位深度匹配索引项，如果找到的桶未满，则直接插入即可；如果桶已满，则判断当前桶的本地位深度 L 与全局位深度 G 的大小关系: 如果 L = G，此时只有一个指针指向当前桶，则扩展索引，本地位深度和全局位深度均加一，索引项翻倍，重组当前桶的元素；如果 L &lt; G，此时不止一个指针指向当前桶，故不需要翻倍索引项，只需分裂出一个桶，将本地位深度加一然后重组当前桶元素即可</li><li>查找时，对于需要查找的关键字 x，hash(x) = y，根据当前 hash 表的全局位深度，决定对 y 取其后 G 位，位数不够用 0 填充，找到对应的索引项，从而找到对应的桶，在桶中逐一进行比较</li><li>删除时，和查找操作类似，先定位元素，删除之。若删除时发现桶为空，则可以考虑将该桶与其兄弟桶进行合并，并使局部位深度减一</li></ul><p>插入实例:</p><p>当我们插入某个关键字 k13，hash(k13) = 1101，对应索引 01 的桶 Bucket 2，桶未满直接插入即可；</p><p>再插入某个关键字 k20，hash(k20) = 10100，对应索引 00 的桶 Bucket 1，桶已满而且本地位深度等于全局位深度，需要扩展索引，全局位深度和本地位深度均加一，并重组当前桶的元素，变为下图:</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Extendible-hashing-1.svg" alt="Extendible hashing"></p><p>继续插入某个关键字 k25，hash(k25) = 11001，对应索引 001 的桶 Bucket 2，桶已满而且本地位深度小于全局位深度，当前桶存在两个指针，只需要分裂出一个桶即可并将桶的本地位深度加一，如图:</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Extendible-hashing-2.svg" alt="Extendible hashing"></p><p>这种方式的优点是可以可动态进行桶的增长，且增长的同时，用索引项的翻倍代替桶数翻倍的传统做法，可用性更好。缺点是当散列的数据分布不均或偏斜较大时，会使得索引项的数目很大，数据桶的利用率很低；还有索引的增长速度，是指数级增长，扩展较快</p><h4 id="线性散列"><a href="#线性散列" class="headerlink" title="线性散列"></a>线性散列</h4><p><a href="https://zh.wikipedia.org/wiki/%E7%BA%BF%E6%80%A7%E6%95%A3%E5%88%97" target="_blank" rel="noopener">线性散列</a>能随数据的插入和删除，适当的对 hash 桶数进行调整，一次只分裂一个桶，线性散列不需要存放数据桶指针的专门索引项。</p><p>定义:</p><table><thead><tr><th>标识符</th><th>描述</th></tr></thead><tbody><tr><td>$h_0,h_1,h_2$…</td><td>一系列哈希函数，后者的范围总是前者的两倍，i 为下标，$h_i(key) = hash(key) mod (N*2^i)$</td></tr><tr><td>N</td><td>桶的初始个数，必须是 2 的幂次方</td></tr><tr><td>$d_i$</td><td>多少比特位用于表示 N，N = $2^{d_i}$</td></tr><tr><td>Level</td><td>当前轮数，每轮的初始桶数等于 $N*2^{Level}$</td></tr><tr><td>Next</td><td>一个指针指向需要分裂的桶，每次发生分裂的桶总是由 Next 决定，与当前值被插入的桶已满或溢出无关</td></tr><tr><td>Load Factor</td><td>负载因子，当桶中记录数达到该值时进行分裂；也可选择当桶满时才进行分裂</td></tr></tbody></table><p>当某个桶发生溢出时，可以将溢出元素以链表的形式链在桶后；<br>可以监控整张哈希表或者桶的负载因子，视情况选择是否分裂，比如全表的负载达到 0.75 可以对当前桶进行分裂，也可以选择只有桶满了才分裂；</p><p>实例:</p><p>初始状态 N = 4, Level = 0, Next 指向第一个桶</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Linear-hashing-0.svg" alt="Linear-hashing"></p><p>插入某个关键字 k37，hash(k37) = 37 = 100101，$h_0(k37)$ = 01(取低两位)，对应编号 1 的桶，此时桶未满直接插入即可:</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Linear-hashing-1.svg" alt="Linear-hashing"></p><p>插入某个关键字 k43，hash(k43) = 43 = 101011，$h_0(k43)$ = 11(取低两位)，对应编号 3 的桶，此时桶已满需要分裂:<br>首先把 43 链在桶 3 后面，然后分裂 Next 指向的桶 0，产生一个新桶，新桶编号 = N + Next = 4 + 0 = 100，Next 指向下一个桶；最后把桶 0 的元素按 h1 散列重组</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Linear-hashing-2.svg" alt="Linear-hashing"></p><p>继续插入某个关键字 k29，hash(k29) = 29 = 11101，$h_0(k29)$ = 01，对应编号 1 的桶，此时桶已满需要分裂:<br>也是按刚才的步骤处理，不过这次 Next 指向的桶就是当前桶</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Linear-hashing-3.svg" alt="Linear-hashing"></p><p>向桶 1 中连续插入 17，33，41，引起分裂:</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Linear-hashing-4.svg" alt="Linear-hashing"></p><p>继续向桶 1 插入 57，引起分裂，需要注意的是这时 Next 指针已经遍历过初始的四个桶，第一轮已结束，Level 加一，Next 指向第一个桶，第二轮初始为八个桶(即 N = 8):</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Linear-hashing-5.svg" alt="Linear-hashing"></p><p>插入就是如上形式进行，接下来看怎么查找:</p><p>假如要查找某个关键字 key 对应的位置，如果 $Next \leq h _{Level}(key) \leq N-1$，则查询 $h _{Level}$ 列的与低 $d_i$ 位对应的桶，否则查询 $ h _{Level+1} $ 列的与低 $d_i$ +1 位对应的桶。</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Linear-hashing-3.svg" alt="Linear-hashing"></p><p>在此图中 N = 4，Level = 0，Next = 2，$d_0$ = 2</p><p>比如查询 k44，$h_0(k44)$ = 00，00(= 0) 不在 2 和 3 之间，则查询 h1 列与 k44 低三位 (100) 对应的桶，找到编号为 4 的桶，再从桶找到对应位置；</p><p>假如查询的是 k7，$h_0(k7)$ = 11，11(= 3) 在 2 和 3 之间，则查询 h0 列与 k7 低两位 (11) 对应的桶，找到编号为 3 的桶，再从桶中找到对应位置</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Linear-hashing-5.svg" alt="Linear-hashing"></p><p>在此图中 N = 8，Level = 1，Next = 0，$d_1$ = 3</p><p>假如查询 k44，$h_1(k44)$ = 100，100(= 4) 在 0 和 7 之间，所以查询 h1 列与 100 对应的桶，即编号为 4 的桶；</p><p>其他关键字的 h1 值都是在范围 [Next, N] 内的，所以都是找 h1 列的</p><p>线性散列的删除操作是插入操作的逆操作，若溢出块为空，则可释放。若删除导致某个桶元素变空，则 Next 指向上一个桶。当 Next 减少到 0，且最后一个桶也是空时，则 Next 指向 N/2 - 1 的位置，同时 Level 值减 1。</p><p>线性散列比可扩展动态散列更灵活，且不需要存放数据桶指针的专门索引项，节省了空间；但如果数据散列后分布不均匀，导致的问题可能会比可扩展散列还严重</p><h2 id="分布式哈希"><a href="#分布式哈希" class="headerlink" title="分布式哈希"></a>分布式哈希</h2><p><a href="https://zh.wikipedia.org/wiki/%E5%88%86%E6%95%A3%E5%BC%8F%E9%9B%9C%E6%B9%8A%E8%A1%A8" target="_blank" rel="noopener">分布式哈希表 - DHT</a>增加或移除节点只改变邻近节点所拥有的关键值集合，而其他节点的则不会被改变。传统的散列表，若增加或移除一个位置，则整个关键值空间必须重新散列。</p><p>其中<a href="https://en.wikipedia.org/wiki/Consistent_hashing" target="_blank" rel="noopener">一致性哈希</a>算法非常适用于分布式哈希表，一致性哈希允许任意顺序插入或删除存储桶，不同于线性散列那样需要顺序处理。</p><h3 id="一致性哈希"><a href="#一致性哈希" class="headerlink" title="一致性哈希"></a>一致性哈希</h3><h4 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h4><p>有 N 台服务器提供缓存服务，需要对服务器进行负载均衡，将请求平均分发到每台服务器上，每台机器负责 1/N 的服务。</p><p>常用的算法是对 hash 结果模 N 取余，比如 N = 5，hash = 103，余数为 3 则分发到编号为 3 的服务器上。但是这样的算法存在严重问题，如果有某台机器宕机或者新添加服务器，都会造成大量缓存请求失效或者需要转移重组数据。</p><p>而使用一致性哈希后，同样增加或者删除服务器节点只会对少量数据产生影响，不需要大规模迁移数据。比如分布式缓存系统节点数多，而且容易变动，非常适合使用一致性哈希</p><h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h4><p>假设一致性哈希算法的结果是 32 位的 Key 值，将这 2^32 个数值映射在一个环形空间上，则对应有 2^32 个缓存区。比如下图中五个 Key 值分布在环形空间上</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Consistent-hashing-0.svg" alt="Consistent-hashing"></p><p>每一个缓存节点（Shard）也遵循同样的 Hash 算法，比如利用 IP 做 Hash，映射到环形空间当中</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Consistent-hashing-1.svg" alt="Consistent-hashing"></p><p>然后按顺时针将 Key 归属到最近的节点上，比如 K5、K1 归属为节点 N1 上</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Consistent-hashing-2.svg" alt="Consistent-hashing"></p><p>增加节点 N4 时，我们只需要改变 K5 的归属即可，不会对其他节点和数据造成影响</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Consistent-hashing-3.svg" alt="Consistent-hashing"></p><p>删除节点 N1 时，我们只需要将 K1 归属到 N2 上就行</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Consistent-hashing-4.svg" alt="Consistent-hashing"></p><p>但是仍会有分布不均的情况，特别是服务器节点较少时，比如下图大部分键值都流向某个单一节点</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Consistent-hashing-5.svg" alt="Consistent-hashing"></p><p>为了应对这种情况，引入了虚拟节点的概念，将原来的一个物理节点映射出多个子节点，让子节点代替物理节点放置在环形空间中</p><p><img src="https://src.wangriyu.wang/images/blog/hash/Consistent-hashing-6.svg" alt="Consistent-hashing"></p><p>比如原本的物理节点 N1 使用的关键字是自己的 IP 192.168.1.109，其位置是 hash(“192.168.1.109”)。现在为其创建两个虚拟节点 N1_1 和 N1_2，两个子节点可以使用 IP + 编号 的方式计算哈希，比如 hash(“192.168.1.109#1”) 和 hash(“192.168.1.109#2”)，同理为 N2 也创建了两个虚拟节点，</p><p>创建虚拟节点的好处是分布更均匀</p><h2 id="其他常见散列函数"><a href="#其他常见散列函数" class="headerlink" title="其他常见散列函数"></a>其他常见散列函数</h2><h3 id="MD5"><a href="#MD5" class="headerlink" title="MD5"></a>MD5</h3><p><a href="https://zh.wikipedia.org/wiki/MD5" target="_blank" rel="noopener">Message-Digest Algorithm 5 - 消息摘要算法</a>，一种被广泛使用的密码散列函数，可以产生出一个 128 位的散列值</p><p>可以应用于文件校验，例如，服务器预先提供一个 MD5 校验和，用户下载完文件以后，用 MD5 算法计算下载文件的 MD5 校验和，然后通过检查这两个校验和是否一致，就能判断下载的文件是否出错</p><p>MD5 是输入不定长度信息，输出固定长度 128 位的算法。经过程序流程，生成四个 32 位数据，最后联合起来成为一个 128 位散列。基本方式为，求余、取余、调整长度、与链接变量进行循环运算，得出结果。</p><p>但是 MD5 可以被破解，不适合高度安全性的场景，比如不能用于密钥认证和数字签名</p><h3 id="SHA"><a href="#SHA" class="headerlink" title="SHA"></a>SHA</h3><p><a href="https://zh.wikipedia.org/wiki/SHA%E5%AE%B6%E6%97%8F" target="_blank" rel="noopener">Secure Hash Algorithm - 安全散列算法</a>是一个密码散列函数家族，也能计算出一个数字消息所对应到的，长度固定的字符串（又称消息摘要）的算法。安全性高于 MD5，比如数字签名常用的就是 SHA-256。</p><p>SHA 分为 SHA-0、SHA-1、SHA-2、SHA-3 四个大版本，其中 SHA-0 和 SHA-1 输出的散列值为 160 位；SHA-2 细分为多种，比如 SHA-256 输出的是 256 位散列值，另外还有 SHA-224、SHA-384、SHA-512 等等；SHA-3 是 2015 年正式发布的，SHA-3 并不是要取代 SHA-2，因为 SHA-2 目前并没有出现明显的弱点，由于对 MD5 出现成功的破解，以及对 SHA-0 和 SHA-1 出现理论上破解的方法，<a href="https://zh.wikipedia.org/wiki/%E5%9C%8B%E5%AE%B6%E6%A8%99%E6%BA%96%E6%8A%80%E8%A1%93%E7%A0%94%E7%A9%B6%E6%89%80" target="_blank" rel="noopener">NIST</a> 感觉需要一个与之前算法不同的，可替换的加密散列算法，也就是现在的 SHA-3</p><h3 id="CRC"><a href="#CRC" class="headerlink" title="CRC"></a>CRC</h3><p><a href="https://zh.wikipedia.org/wiki/%E5%BE%AA%E7%92%B0%E5%86%97%E9%A4%98%E6%A0%A1%E9%A9%97" target="_blank" rel="noopener">Cyclic redundancy check - 循环冗余校验</a>是一种根据网络数据包或计算机文件等数据产生简短固定位数校验码的一种散列函数，主要用来检测或校验数据传输或者保存后可能出现的错误。一般来说，循环冗余校验的值都是 32 位的整数。</p><p>CRC 的计算过程网络课程便讲过，不算复杂，这里不深入。WikiPedia 上提供了一些 CRC 变体的描述，感兴趣可以了解一下。</p><p>尽管在错误检测中非常有用，CRC 并不能可靠地校验数据完整性，因为 CRC 多项式是线性结构，可以非常容易地故意改变量据而维持 CRC 不变。一般使用<a href="https://zh.wikipedia.org/wiki/%E8%A8%8A%E6%81%AF%E9%91%91%E5%88%A5%E7%A2%BC" target="_blank" rel="noopener">Message authentication code</a>校验数据完整性</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://en.wikipedia.org/wiki/Hash_table" target="_blank" rel="noopener">Hash Table - WikiPedia</a></li><li><a href="https://www.interviewcake.com/article/python/data-structures-coding-interview?course=dsa#hash-tables" target="_blank" rel="noopener">Data Structures for Coding Interviews - Hash Table</a></li><li><a href="http://blog.sina.com.cn/s/blog_5e4516af01019frj.html" target="_blank" rel="noopener">动态 hash 思想方法</a></li><li><a href="https://en.wikipedia.org/wiki/Extendible_hashing" target="_blank" rel="noopener">Extendible hashing - WikiPedia</a></li><li><a href="https://www.youtube.com/watch?v=h37Jhr21ByQ&amp;t=61s" target="_blank" rel="noopener">Linear Hashing - Youtube</a></li><li><a href="https://mp.weixin.qq.com/s/yimfkNYF_tIJJqUIzV7TFA" target="_blank" rel="noopener">漫画：什么是一致性哈希？</a></li><li><a href="https://zh.wikipedia.org/wiki/%E9%9B%AA%E5%B4%A9%E6%95%88%E5%BA%94" target="_blank" rel="noopener">雪崩效应 - WikiPedia</a></li></ul>]]></content>
      
      <categories>
          
          <category> 数据结构和算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 哈希 </tag>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>数据结构 - 树</title>
      <link href="/2018/06-Tree.html"/>
      <url>/2018/06-Tree.html</url>
      <content type="html"><![CDATA[<p>与数据库相关的树结构主要为 B 类树，B 类树通常用于数据库和操作系统的文件系统</p><p>在学习 B 类树之前先复习一下二叉查找树的概念和红黑树</p><h2 id="二叉树"><a href="#二叉树" class="headerlink" title="二叉树"></a>二叉树</h2><p><a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%8F%89%E6%A0%91" target="_blank" rel="noopener">二叉树 - Binary Tree</a> 是每个节点最多只有两个分支（即不存在分支度大于 2 的节点）的树结构。</p><h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><ul><li>完美二叉树 (Perfect Binary Tree): 除了叶子结点之外的每一个结点都有两个孩子，每一层(当然包含最后一层)都被完全填充</li><li>完全二叉树 (Complete Binary Tree): 除了最后一层之外的其他每一层都被完全填充，并且所有结点都保持向左对齐</li><li>满二叉树 (Full/Strictly Binary Tree): 除了叶子结点之外的每一个结点都有两个孩子结点</li></ul><h3 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h3><ul><li>前序遍历: 首先访问根结点然后遍历左子树，最后遍历右子树。在遍历左、右子树时，仍然先访问根结点，然后遍历左子树，最后遍历右子树</li><li>中序遍历: 首先遍历左子树，然后访问根结点，最后遍历右子树。在遍历左、右子树时，仍然先遍历左子树，再访问根结点，最后遍历右子树</li><li>后序遍历: 首先遍历左子树，然后遍历右子树，最后访问根结点。在遍历左、右子树时，仍然先遍历左子树，然后遍历右子树，最后遍历根结点</li></ul><ul><li>深度优先搜索: 顾名思义，查找时深度优先，从根结点访问最远的结点直到找到所有节点。前序，中序和后序遍历都是深度优先遍历的特例</li><li>广度优先搜索: 广度优先遍历会先访问离根节点最近的节点，二叉树的广度优先遍历又称按层次遍历。算法借助队列实现</li></ul><h2 id="二叉查找树"><a href="#二叉查找树" class="headerlink" title="二叉查找树"></a>二叉查找树</h2><p><a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%85%83%E6%90%9C%E5%B0%8B%E6%A8%B9" target="_blank" rel="noopener">二叉查找树 - Binary Search Tree</a>: 也称二叉搜索树、有序二叉树。对于根树和所有子树都满足，每个节点都大于左子树元素，而小于右子树元素，<strong>且没有键值相等的结点</strong></p><p>搜索、插入、删除的复杂度等于<strong>树高</strong>，期望 $O(\log_2^n)$，最坏 O(n)（数列有序，树退化成线性表）</p><blockquote><p>二叉查找树动态展示: <a href="https://visualgo.net/zh/bst" target="_blank" rel="noopener">https://visualgo.net/zh/bst</a></p></blockquote><h3 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h3><p>当数据基本有序时，二叉查找树会退化成线性表，查找效率严重下降</p><p>所以后面出现了很多改进的<a href="https://zh.wikipedia.org/wiki/%E5%B9%B3%E8%A1%A1%E6%A0%91" target="_blank" rel="noopener">平衡树</a>结构以满足树高最坏也为 $O(\log_2^n)$，<br>如<a href="https://zh.wikipedia.org/wiki/%E4%BC%B8%E5%B1%95%E6%A0%91" target="_blank" rel="noopener">伸展树 (Splay Tree)</a>、平衡二叉树 (SBT)、<a href="https://zh.wikipedia.org/wiki/AVL%E6%A0%91" target="_blank" rel="noopener">AVL 树</a>、红黑树等</p><h2 id="红黑树"><a href="#红黑树" class="headerlink" title="红黑树"></a>红黑树</h2><p><a href="https://zh.wikipedia.org/wiki/%E7%BA%A2%E9%BB%91%E6%A0%91" target="_blank" rel="noopener">红黑树 - Red–black tree</a> 是一种自平衡二叉查找树，除了符合二叉查找树的性质外，它还满足以下五条性质:</p><ol><li>每个结点要么是红的，要么是黑的</li><li>根结点是黑的</li><li>每个叶子结点是黑的（叶子结点指树尾端 NIL 指针或 NULL 结点，不包含数据，只充当树在此结束的指示）</li><li>如果一个结点是红的，那么它的两个子节点都是黑的 (从根到每个叶子的所有路径上不能有两个连续的红色节点)</li><li>对于任一结点而言，其到叶结点树尾端 NIL 指针的每一条路径都包含相同数目的黑结点</li></ol><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-tree-0.svg" alt="一棵红黑树"></p><h3 id="平衡优势"><a href="#平衡优势" class="headerlink" title="平衡优势"></a>平衡优势</h3><p>上述约束确保了红黑树的关键特性: <strong>从根到叶子的最长路径不会超过最短路径的两倍</strong></p><p>证明: 主要看性质 4 和 性质 5，假设从根到叶子的最短路径 a 上有黑色节点 n 个，最长路径 b 肯定是交替的红色和黑色节点，而根据性质 5 可知从根到叶子的所有路径都有相同数目的黑色节点，<br>这就表明 b 的黑色节点也为 n 个，但 b 出现的红色节点不可能超过黑色节点个数，否则会破坏性质 4 (抽屉原理)，所以从根到叶子的最长路径不会超过最短路径的两倍</p><h3 id="调整"><a href="#调整" class="headerlink" title="调整"></a>调整</h3><p>因为每一个红黑树也是一个特化的二叉查找树，因此红黑树上的只读操作与普通二叉查找树上的只读操作相同。然而，在红黑树上进行插入操作和删除操作会导致不再匹配红黑树的性质。<br>恢复红黑树的性质需要少量 $O(\log_2^n)$ 的颜色变更（实际是非常快速的）和不超过三次树旋转（对于插入操作是两次）。虽然插入和删除很复杂，但操作时间仍可以保持为 $O(\log_2^n)$ 次。</p><p>红黑树发生变更时需要 [变色] 和 [旋转] 来调整，其中旋转又分 [左旋] 和 [右旋]。</p><ul><li>变色就是更改颜色</li><li>左旋: 以 X 为支点<code>逆时针</code>旋转红黑树的两个节点 X-Y，使得父节点被自己的右孩子取代，而自己下降为左孩子</li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/left.svg" alt="左旋"></p><ul><li>右旋: 以 X 为支点<code>顺时针</code>旋转红黑树的两个节点 X-Y，使得父节点被自己的左孩子取代，而自己下降为右孩子</li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/right.svg" alt="右旋"></p><p>旋转过程中只需要做三次指针变更就行</p><h3 id="插入和删除"><a href="#插入和删除" class="headerlink" title="插入和删除"></a>插入和删除</h3><h4 id="插入节点"><a href="#插入节点" class="headerlink" title="插入节点"></a>插入节点</h4><p>插入节点的位置跟二叉查找树的寻找方法基本一致，如果插入结点 z 小于当前遍历到的结点，则到当前结点的左子树中继续查找，如果 z 大于当前结点，则到当前结点的右子树中继续查找，<br>如果 z 依然比此刻遍历到的新的当前结点小，则 z 作为当前结点的左孩子，否则作为当前结点的右孩子。而红黑树插入节点后，为了保持约束还需要进行调整修复(变色加旋转)。</p><p>所以插入步骤如下: 红黑树按二叉查找树的规则找到位置后插入新节点 z，z 的左孩子、右孩子都是叶子结点 nil， z 结点初始都为红色，再根据下述情形进行变色旋转等操作，最后达到平衡。</p><ul><li>情形 1: 如果<strong>当前节点是根结点</strong>，为满足性质 2，所以直接把此结点 z 涂为黑色</li><li>情形 2: 如果<strong>当前结点的父结点是黑色</strong>，由于不违反性质 2 和性质 4，红黑树没有被破坏，所以此时也是什么也不做</li></ul><p>比如上图插入 12 时满足情形 2:</p><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-tree-1.svg" alt="插入 12"></p><p>以下情形需要作出额外调整:</p><ul><li>情形 3: 如果<strong>当前结点的父结点是红色</strong>且<strong>祖父结点的另一个子结点(叔叔结点)是红色</strong></li><li>情形 4: <strong>当前结点的父结点是红色</strong>，<strong>叔叔结点是黑色</strong>或者 nil，当前结点相对其父结点的位置和父节点相对祖父节点的位置<strong>不在同侧</strong></li><li>情形 5: <strong>当前结点的父结点是红色</strong>，<strong>叔叔结点是黑色</strong>或者 nil，当前结点相对其父结点的位置和父节点相对祖父节点的位置<strong>在同侧</strong></li></ul><p>下面着重讲讲后三种情况如何调整</p><h5 id="情形-3"><a href="#情形-3" class="headerlink" title="情形 3"></a>情形 3</h5><p><code>当前结点的父结点是红色且祖父结点的另一个子结点(叔叔结点)是红色</code></p><blockquote><p>因为当前节点的父节点是红色，所以父节点不可能是根节点，当前节点肯定有祖父节点，也就有叔叔节点</p></blockquote><p><strong>解决步骤</strong>: 将当前结点的父结点和叔叔结点涂黑，祖父结点涂红，再把祖父结点当做新节点(即当前节点的指针指向祖父节点)重新检查各种情形进行调整</p><p>由于对称性，不管父结点是祖父结点的左子还是右子，当前结点是其父结点的左子还是右子，处理都是一样的</p><p>我们插入 21 这个元素，当前节点指向 21：</p><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-tree-2.svg" alt="插入 21"></p><p>此时会发现 21、22 两个红色相连与性质 4 冲突，但 21 节点满足情形 3，修复后:</p><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-tree-3.svg" alt="调整情形 3"></p><p>此时当前节点指向 21 的祖父节点，即 25。而 25 节点同样遇到情形 3 的问题，继续修复:</p><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-tree-4.svg" alt="继续调整情形 3"></p><p>此时当前节点指向根节点，满足情形 1，将 14 节点涂黑即可恢复红黑树平衡</p><h5 id="情形-4"><a href="#情形-4" class="headerlink" title="情形 4"></a>情形 4</h5><p><code>当前结点的父结点是红色，叔叔结点是黑色或者 nil，当前结点相对其父结点的位置和父节点相对祖父节点的位置不在同侧</code></p><p><strong>解决步骤</strong>:</p><ul><li>如果当前节点是父节点的右子，父节点是祖父节点的左子，以当前结点的父结点做为新结点(即当前节点的指针指向父节点)，并作为支点左旋</li><li>如果当前节点是父节点的左子，父节点是祖父节点的右子，以当前结点的父结点做为新结点(即当前节点的指针指向父节点)，并作为支点右旋</li></ul><p>在上图的基础上我们继续插入 5 这个元素:</p><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-tree-5.svg" alt="插入 5"></p><p>可以看出 5 是父节点的左子，而父节点是祖父节点的右子，不同侧则为情形 4，将当前节点指向 5 的父节点 6，并以 6 为支点进行右旋:</p><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-tree-6.svg" alt="插入情形 4"></p><p>此时当前节点是 6，而 6 是父节点 5 的右子，父节点 5 也是祖父节点 1 的右子，同侧则转为情形 5，继续往下看</p><h5 id="情形-5"><a href="#情形-5" class="headerlink" title="情形 5"></a>情形 5</h5><p><code>当前结点的父结点是红色，叔叔结点是黑色或者 nil，当前结点相对其父结点的位置和父节点相对祖父节点的位置在同侧</code></p><p><strong>解决步骤</strong>:</p><ul><li>首先把父结点变为黑色，祖父结点变为红色</li><li>如果当前节点是父节点的左子，父节点是祖父节点的左子，以祖父结点为支点右旋</li><li>如果当前节点是父节点的右子，父节点是祖父节点的右子，以祖父结点为支点左旋</li></ul><p>在上一张图的基础上修改节点 5 为黑色，节点 1 为红色，再以 1 为支点左旋:</p><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-tree-7.svg" alt="插入情形 5"></p><p>此时便恢复平衡</p><h4 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h4><p>删除节点 X 时第一步先判断两个孩子是否都是非空的，如果都非空，就先按二叉查找树的规则处理:</p><p>在删除带有两个非空子树的节点 X 的时候，我们可以找到左子树中的最大元素(或者右子树中的最小元素)，并把这个最值<strong>复制</strong>给 X 节点，只代替原来要删除的值，不改变节点颜色。</p><p>然后我们只要删除那个被复制出值的那个节点就行，因为是最值节点所以它的孩子不可能都非空。</p><p>因为只是复制了一个值，不违反任何性质，这就把原问题转化为<strong>如何删除最多有一个非空子树的节点的问题</strong>。它不关心这个节点是最初要删除的节点还是被复制出值的那个节点。</p><p>我们以图为例，图中三角形代表可能为空的子树:</p><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-removal-0.svg" alt="取值复制"></p><p>节点 X 是要删除的节点，发现它的两个子树非空，我们可以找左子树中最大的元素 Max (也可以找右子树中最小的元素 Min)，把 Max 值(或者 Min 值)复制到 X 上覆盖原来的值，不修改其他属性，然后删除 Max 节点(或 Min 节点)即可，可以很清楚的看到最值节点最多只会有一个非空子树</p><hr><p>接下来就是如何处理删除最多有一个非空子树的节点 X 的问题</p><p>简单情形:</p><ol><li>如果 X 的两个儿子都为空，即均为叶子，我们将其中任意一个看作它的儿子</li><li>如果 <strong>X 是一个红色节点</strong>，它的父亲和儿子一定是黑色的，所以简单的<strong>用它的黑色儿子替换它</strong>就行，这并不会破坏性质 3 和性质 4，通过被删除节点的所有路径只是少了一个红色节点，这样可以继续保证性质 5</li><li>如果 <strong>X 是黑色而它的儿子是红色</strong>，如果只是删除这个黑色节点，<strong>用它的红色儿子代替</strong>的话，会破坏性质 5，我们可以<strong>重绘它的儿子为黑色</strong>，则曾经通过 X 的所有路径将通过它的黑色儿子，这样可以继续保持性质 5</li></ol><p>如果 X 和它的儿子都是黑色，这是一种复杂的情况，我们单拎出来讲</p><p>我们首先把要删除的节点 X 替换为它的儿子。出于方便，称呼这个新上位的儿子为 N，称呼它的兄弟为 S，使用 P 称呼 N 的新父亲，SL 称呼 S 的左儿子，SR 称呼 S 的右儿子</p><p>有以下六种情形需要考虑:</p><h5 id="情形-1"><a href="#情形-1" class="headerlink" title="情形 1"></a>情形 1</h5><p>N 是新的根</p><p>我们不需要做什么，因为所有路径都去除了一个黑色节点，而新根也是黑色的，所以性质都保持着</p><blockquote><p>情形 2、5、6 涉及到左右不同的情况，只取一种处理</p></blockquote><h5 id="情形-2"><a href="#情形-2" class="headerlink" title="情形 2"></a>情形 2</h5><p>S 是红色</p><ul><li>交换兄弟 S 和父亲 P 的颜色</li><li>如果 N 是其父亲的左节点，我们在 N 的父亲上做左旋，把红色兄弟转换成 N 的祖父</li><li>如果 N 是其父亲的右节点，我们在 N 的父亲上做右旋，把红色兄弟转换成 N 的祖父</li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-removal-2.svg" alt="删除情形 2"></p><p>完成这两个操作后，尽管所有路径上黑色节点的数目没有改变，但现在 N 有了一个黑色的兄弟和一个红色的父亲，所以我们可以接下去按情形 4、情形 5 或情形 6 来处理</p><h5 id="情形-3-1"><a href="#情形-3-1" class="headerlink" title="情形 3"></a>情形 3</h5><p>N 的父亲、S 和 S 的儿子都是黑色的</p><ul><li>重绘 S 为红色</li><li>将 P 作为新的 N，从情形 1 开始，在 P 上做平衡处理</li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-removal-3.svg" alt="删除情形 3"></p><p>在这种情形下，我们简单的重绘 S 为红色。结果是通过 S 的所有路径都少了一个黑色节点。这与删除 N 的初始父亲 X 造成通过 N 的所有路径少了一个黑色节点达成平衡。但是，通过 P 的所有路径现在比不通过 P 的路径少了一个黑色节点，所以仍然违反性质 5。要修正这个问题，我们要从情形 1 开始，在 P 上做重新平衡处理</p><h5 id="情形-4-1"><a href="#情形-4-1" class="headerlink" title="情形 4"></a>情形 4</h5><p>S 和 S 的儿子都是黑色，但是 N 的父亲是红色</p><ul><li>交换 N 的兄弟 S 和父亲 P 的颜色</li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-removal-4.svg" alt="删除情形 4"></p><p>在这种情形下，我们简单的交换 N 的兄弟和父亲的颜色。这不影响不通过 N 的路径的黑色节点的数目，但是它在通过 N 的路径上对黑色节点数目增加了一，添补了在这些路径上删除的黑色节点</p><h5 id="情形-5-1"><a href="#情形-5-1" class="headerlink" title="情形 5"></a>情形 5</h5><p>S 是黑色，S 的其中一个儿子是红色，且红色儿子的位置与 N 相对于父亲的位置处于<strong>同侧</strong></p><ul><li>如果 N 是其父亲的左节点，S 的左儿子是红色，右儿子是黑色，则在 S 上做右旋转</li><li>如果 N 是其父亲的右节点，S 的左儿子是黑色，右儿子是红色，则在 S 上做左旋转</li><li>将 S 和它之前的红色儿子交换颜色</li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-removal-5.svg" alt="删除情形 5"></p><p>所有路径仍有同样数目的黑色节点，但是现在 N 有了一个黑色兄弟，且兄弟的一个儿子仍为红色的，其位置与 N 相对于父亲的位置处于不同侧，进入情形 6</p><blockquote><p>情形 5、6 中父节点 P 的颜色可以为黑色也可以是红色</p></blockquote><h5 id="情形-6"><a href="#情形-6" class="headerlink" title="情形 6"></a>情形 6</h5><p>S 是黑色，S 的其中一个儿子是红色，且其位置与 N 相对于父亲的位置处于<strong>不同侧</strong></p><ul><li>交换 N 的父亲 P 和 S 的颜色</li><li>如果 N 是其父亲的右节点，S 的左儿子是红色，右儿子是黑色，则在 N 的父亲上做右旋转，并使 S 的左儿子涂黑</li><li>如果 N 是其父亲的左节点，S 的左儿子是黑色，右儿子是红色，则在 N 的父亲上做左旋转，并使 S 的右儿子涂黑</li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-removal-6.svg" alt="删除情形 6"></p><p>交换前 N 的父亲可以是红色也可以是黑色，交换后，N 增加了一个黑色祖先，所以通过 N 的路径都增加了一个黑色节点，S 的右子树黑色节点个数也没有变化，达到平衡</p><h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><p>还是以之前的图为例</p><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-tree-7.svg" alt="删除"></p><p>我们自下而上开始尝试删除每一个节点:</p><ul><li><p>假如要删除元素 1，根据简单情形中的第二条，我们直接删除 1，并用一个 nil 节点代替即可，元素 6、12、21 的处理与此相同</p></li><li><p>假如要删除元素 5，因为左右子树均不为空，所以找左子树的最大值 1 (或者右子树的最小值 6)，用找到的值代替 5 (这里只是值替换，其他均不变)，然后去删除 1 节点，这就转到问题 1 上了</p></li><li><p>假如要删除元素 11，根据简单情形的第三条，我们直接删除 11，并用子节点 12 代替，同时把 12 涂黑即可，元素 22 的处理与此相同</p></li><li><p>假如要删除元素 25，因为左右子树均不为空，所以找左子树的最大值 22 (或者右子树的最小值 27)，我们这里用值 22 代替 25，颜色不变。然后去删除 22 节点，这变成上一个问题了</p></li><li><p>假如要删除元素 27，黑色的 nil 叶子节点代替 27 节点，因为兄弟节点 22 有一个红色孩子，且在左边，和 nil 节点相对父亲 25 的位置不同侧，属于情形 6，所以第一步交换 22 和 25 的颜色，再以 25 为支点做右旋转，然后将 21 节点涂黑即可</p></li><li><p>假如要删除元素 8，选择右子树最小值 11 替换 8。然后去删除节点 11，对应问题 3</p></li><li><p>假如要删除元素 17，选择左子树最大值 15 替换 17。然后去删除节点 15，过程看下一个问题</p></li><li><p>假如要删除元素 15，删除的元素和替代的元素都是黑色，这属于复杂情形。检查其类型可以匹配到情形 2，元素 15 是被移除的 X，代替它的是 nil 节点，即为 N，17 为 P，25 为 S，根据上文可知第一步先交换 P 和 S 的颜色，然后以 P 为支点进行左旋，此时 N 多了一个黑色的兄弟 22 和红色的父亲 17:</p></li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-example-0.svg" alt="删除 15"></p><p>此时 N 的兄弟 S 变为 22，P 变为 17，S 的左孩子是红色的 21，属于情形 5。S 做右旋转，并交换 22 和 21 的颜色:</p><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-example-1.svg" alt="删除 15"></p><p>此时 N 的兄弟 S 变为黑色的 21，但 21 的红色孩子节点 22 变为右侧，进入情形 6</p><p><img src="https://src.wangriyu.wang/images/blog/tree/RB-example-2.svg" alt="删除 15"></p><p>P 节点 17 做左旋转，并将 S 的右节点涂黑，此时树恢复平衡</p><ul><li>假如要删除根节点 14，取左子树最大值 12 代替 14。然后去删除节点 12，对应问题 1</li></ul><p>至此，我们已经把节点都删了个遍，相信你对红黑树的删除操作应该了解了</p><blockquote><p>红黑树动态展示: <a href="https://www.cs.usfca.edu/~galles/visualization/RedBlack.html" target="_blank" rel="noopener">https://www.cs.usfca.edu/~galles/visualization/RedBlack.html</a></p></blockquote><h2 id="实际问题"><a href="#实际问题" class="headerlink" title="实际问题"></a>实际问题</h2><p>红黑树还是典型的二叉搜索树结构，主要应用在一些 map 和 set 类型的实现上，比如 Java 中的 TreeMap 和 C++ 的 set/map/multimap 等。其查找的时间复杂度 $O(\log_2^n)$ 与树的深度相关，降低树的深度可以提高查找效率。</p><blockquote><p>Java 的 hashmap 和 golang 的 map 是用哈希实现的</p></blockquote><p>但是大规模数据存储中，实现索引查询这样一个实际背景下，树节点存储的元素数量是有限的（如果元素数量非常多的话，查找就退化成节点内部的线性查找了），<br>这样导致二叉查找树结构由于树的深度过大而造成磁盘 I/O 读写过于频繁，进而导致查询效率低下，因此我们该想办法降低树的深度，从而减少磁盘查找存取的次数。</p><p>一个基本的思想就是：采用<code>多叉树结构</code>，所以出现了下述的平衡多路查找树</p><h2 id="B-树-B-Tree"><a href="#B-树-B-Tree" class="headerlink" title="B 树 (B - Tree)"></a>B 树 (B - Tree)</h2><blockquote><p>B-树，即为 B 树，不要读作 B 减树</p></blockquote><p>B 树与红黑树最大的不同在于，B 树的结点可以有许多子女，从几个到几千个。</p><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><blockquote><p>B 树的定义有两种，一种以阶数为限制的 B 树(下文所述的)，一种以度数为限制的 B 树(算法导论所描述的)，两者原理类似，这里以阶数来定义</p></blockquote><p><a href="https://zh.wikipedia.org/wiki/B%E6%A0%91" target="_blank" rel="noopener">B 树</a>属于平衡多路查找树。一棵 m 阶(m 阶即代表树中任一结点最多含有 m 个孩子)的 B 树的特性如下:</p><ol><li>除根节点外所有节点关键字个数范围: [$\lceil\frac m2\rceil$-1, m-1]</li><li>若非叶子节点含 n 个关键字，则子树有 n+1 个，由关键字范围可知子树的个数范围: [$\lceil\frac m2\rceil$, m]</li><li>根节点至少包含一个关键字，至少有两个孩子(除非 B 树只存在一个节点: 根结点)，即根节点关键字个数范围: [1, m-1]，孩子数范围: [2, m]</li><li>所有叶子节点都处在同一层，即高度都一样</li><li>每个节点中的关键字从小到大排列，节点当中 k-1 个元素正好是 k 个孩子包含的元素的值域划分</li></ol><p><img src="https://src.wangriyu.wang/images/blog/tree/BTree-0.svg" alt="2-3-4 树"></p><p>如图是一个典型的 <a href="https://zh.wikipedia.org/wiki/2-3-4%E6%A0%91" target="_blank" rel="noopener">2-3-4 树</a>结构，也是阶为 4 的 B 树。从图中查询元素最多只需要 3 次磁盘 I/O 就可以访问到我们需要的数据节点，将节点数据块读入内存后再查找指定元素会很快。如果同样的数据用红黑树表示，树高会增长很多，造成遍历节点的次数增多，访问磁盘的次数增多，查找性能会下降。</p><p>对于一棵包含 n 个元素、高度为 h 、阶数为 m 的 B 树:<br>影响 B 树高度的是每个结点所包含的子树数，如果尽可能使结点孩子数都等于 $\lceil\frac m2\rceil$，则层数最多，为最坏情况；如果尽可能使结点孩子数都等于 m，则层数最少，为最好情况。所以有</p><p>$$ \log _m{(n + 1)} \leq h \leq \log _{\lceil\frac m2\rceil}{(\frac{n + 1}{2})} + 1 $$</p><p>底数 $\lceil\frac m2\rceil$ 可以取很大，比如 m 可以达到几千，从而在关键字数一定的情况下，使得最终的 h 值尽量比较小，树的高度比较低。</p><p>实际运用中 B 树中的每个结点根据实际情况可以包含大量的关键字信息和分支(但不能超过磁盘块的大小，根据磁盘驱动的不同，一般块的大小在 1k~4k 左右)；这样树的深度降低了，意味着查找一个元素只要很少的结点从外存磁盘中读入内存，就可以很快地访问到要查找的数据</p><h3 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h3><p>一个节点的结构可以定义为:</p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">type</span> BTNode <span class="token keyword">struct</span> <span class="token punctuation">{</span>  KeyNum   <span class="token builtin">int</span>       <span class="token comment" spellcheck="true">// 关键字个数，math.Ceil(m/2)-1 &lt;= KeyNum &lt; 阶数 m</span>  Parent   <span class="token operator">*</span>BTNode   <span class="token comment" spellcheck="true">// 指向父节点的指针</span>  IsLeaf   <span class="token builtin">bool</span>      <span class="token comment" spellcheck="true">// 是否为叶子，叶子节点 children 为 nil</span>  Key      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>     <span class="token comment" spellcheck="true">// 关键字切片，长度为 KeyNum</span>  Children <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>BTNode <span class="token comment" spellcheck="true">// 子节点指针切片，长度为 KeyNum+1</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上面 2-3-4 树的根节点为例：</p><p><img src="https://src.wangriyu.wang/images/blog/tree/BTNode.svg" alt="B 树节点"></p><p> 所有数据以块的方式存储在外磁盘中，我们通过 B 树来查找数据时，每遍历到一个节点，便将其读入内存，比较其中的关键字，若能匹配到我们要找的元素，便返回；若未能找到，通过比较确定在哪两个关键字的值域区间， 即可确定子树的节点指针，继续往下找，把下一个节点的数据读入内存，重复以上步骤</p><h3 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h3><p>对于一棵 m 阶的 B 树来说，插入一个元素(或者叫关键字)时，首先判断在 B 树中是否已存在，如果存在则不插入；如果不存在，则在对应叶子结点中插入新的元素，需要判断是否会超出关键字个数限制(m-1)</p><p>插入步骤:</p><ol><li>根据元素大小查找插入位置，肯定是最底层的叶子节点，将元素插入到该节点中</li><li>如果叶子节点的关键字个数小于等于 m-1，说明未超出限制，插入结束；否则进入下一步</li><li>如果叶子节点的关键字个数大于 m-1 个，以结点中间的关键字为中心分裂成左右两部分，然后将这个中间的关键字插入到父结点中，这个关键字的左子树指向分裂后的左半部分，这个关键字的右子树指向分裂后的右半部分。</li><li>然后将当前结点指向父结点，如果插入刚才的中间关键字后父节点的关键字个数也超出限制，继续进行第 3 步；否则结束插入</li></ol><p>还是以上面的 2-3-4 树(阶数 m = 4)为例，我们依次插入元素</p><ul><li>首先插入 1、2、3，因为关键字个数均未超过 m-1，所以直接插入即可:</li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/BT-insert-0.svg" alt="插入 1 2 3"></p><ul><li>当插入 4 时，该节点关键字个数达到 m，需要分裂，这里可以选 3 (也可以选 2) 作为中间字，分裂后:</li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/BT-insert-1.svg" alt="插入 4"></p><ul><li>继续插入 5、7，对应 4 所在的叶子节点:</li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/BT-insert-2.svg" alt="插入 5 7"></p><ul><li>当插入 8 时，也需要分裂，将中间字 5 上移至父节点，4 成为 5 的左区间子树，7 8 成为 5 的右区间子树:</li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/BT-insert-3.svg" alt="插入 8"></p><p>之后的步骤类似，不再一一叙述</p><h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>删除操作是指删除 B 树中的某个节点中的指定关键字</p><p>删除步骤:</p><ol><li>如果当前要删除的关键字位于非叶子结点 N 上，则用后继最小关键字(找前继最大关键字也可以)覆盖要删除的关键字，然后在后继关键字所在的子树中删除该后继关键字。此后继关键字一定位于叶子结点上，这个过程和二叉搜索树删除结点的方式类似。删除这个后继关键字后进入第 2 步，如果原本要删除的关键字本身就位于叶子上同样删除关键字后进入第二步</li><li>该结点(假设为 M)关键字个数大于等于 math.Ceil(m/2)-1，结束删除操作，否则进入第 3 步</li><li>此时结点 M 关键字个数小于 math.Ceil(m/2)-1<ul><li>如果相邻兄弟结点(左右都可以)关键字个数大于 math.Ceil(m/2)-1，则父结点中取一个临近的关键字下移到 M，兄弟结点中取一个临近关键字上移至父节点，删除操作结束；</li><li>如果相邻的兄弟节点关键字个数都不大于 math.Ceil(m/2)-1，将父结点中临近的关键字 key 下移至 M，合并 M 和它的兄弟节点形成一个新的结点。原父结点中的 key 的两个孩子指针就变成一个孩子指针，指向这个新结点。然后当前结点的指针指向父结点，重复第 2 步</li></ul></li></ol><p>以上面的 2-3-4 树为例</p><p><img src="https://src.wangriyu.wang/images/blog/tree/BTree-0.svg" alt="2-3-4 树"></p><p>阶数为 4，节点关键字个数范围应该是 [1, 3]，即 math.Ceil(m/2)-1 = 1</p><ul><li>删除关键字 2 或者 8，不影响节点</li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/BT-removal-0.svg" alt="删除 2 和 8"></p><ul><li>删除关键字 4，该叶子节点 X 关键字个数变为 0 小于范围下界，同时左右两个相邻兄弟的关键字个数都不大于 1，需要合并节点。<ul><li>第一步，将父节点的 5 下移到 X 上</li><li>第二步，合并 X 和右兄弟节点 7 形成一个包含 5、7 的新节点</li><li>第三步，父节点中原本 5 的左右两个孩子指针变为一个并指向这个新节点</li></ul></li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/BT-removal-1.svg" alt="删除 4"></p><p>这里第一步也可以选择下移 3，然后第二步跟左兄弟合并成 1、3 节点</p><ul><li>继续删除 1，此时与上一个问题不同，该叶子节点的兄弟有富余的关键字，我们只需要把父节点的临近的一个关键字下移到该叶子节点代替删除的元素，然后把兄弟节点的一个临近关键字上移至父节点即可，这个操作有点类似红黑树的左旋操作</li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/BT-removal-2.svg" alt="删除 1"></p><ul><li>现在尝试删除非叶子节点 5，用后继最小关键字 7 代替 5，然后删除 7 所在的叶子节点。<ul><li>此时会引起连锁反应，7 所在的叶子节点现在为空，而兄弟节点关键字又不大于 1，需要合并</li><li>将关键字 7 又从父节点移至原来的叶子上，合并成含 3、7 的新节点，假设新节点为 N，父节点的孩子指针变为一个并指向 N</li><li>而父节点现在关键字是空的，而且其兄弟(N 的叔叔)关键字也不大于 1，也需要合并</li><li>根节点取出关键字 9 下移到 N 的父节点上，合并 N 的父节点和叔叔节点，产生一个包含 9、15 的新节点，根节点的孩子指针减少一个且左子树指向这个新节点</li></ul></li></ul><p><img src="https://src.wangriyu.wang/images/blog/tree/BT-removal-3.svg" alt="删除 5"></p><p>删除操作就演示到这，B 树的内容讲完</p><blockquote><p>B 树动态展示: <a href="https://www.cs.usfca.edu/~galles/visualization/BTree.html" target="_blank" rel="noopener">https://www.cs.usfca.edu/~galles/visualization/BTree.html</a></p></blockquote><h2 id="B-树-B-Tree-1"><a href="#B-树-B-Tree-1" class="headerlink" title="B+ 树 (B+ - Tree)"></a>B+ 树 (B+ - Tree)</h2><p><a href="https://zh.wikipedia.org/wiki/B%2B%E6%A0%91" target="_blank" rel="noopener">B+ 树</a> 是基于 B 树的变体，查找性能更好</p><p>同为 m 阶的 B+ 树与 B 树的不同点:</p><ol><li>所有非叶子节点，每个节点最多有 m 个关键字，最少有 $\lceil\frac m2\rceil$ 个关键字(比 B 树的限制多一个)，其中每个关键字对应一棵子树</li><li>所有的非叶子结点可以看成是索引部分，结点中仅含有其子树根结点中最大(或最小)关键字，不包含关键字数据的指针(B 树是包含这个指针的)</li><li>所有的叶子结点中包含了全部关键字的信息，及指向含这些关键字记录的指针，且叶子结点本身依关键字的大小自小到大顺序链接.(而 B 树的全部关键字信息分散在各个节点中)</li></ol><p><img src="https://src.wangriyu.wang/images/blog/tree/B+Tree-0.svg" alt="B+ 树"></p><p>如图所示的是将之前的 2-3-4 树的数据存到 B+ 树结构中的示意图，叶子节点保存了所有关键字信息并且叶子节点之间也用指针连接起来(一个顺序链表)，而所有非叶子节点只包含子树根节点中对应的最大关键字，其作用只是用于索引</p><blockquote><p>B+ 树还可以用另一种形式定义:</p><p>中间节点最多有 m-1 个关键字，最少有 $\lceil\frac m2\rceil-1$ 个关键字，与 B 树相同；<br>但是非叶子节点的关键字是左子树的最大关键字(或者右子树的最小关键字)，与刚才的情形不同</p></blockquote><p>比如同样的数据此定义的 B+ 树表现形式如下:</p><p><img src="https://src.wangriyu.wang/images/blog/tree/B+Tree-1.svg" alt="B+ 树"></p><p>这种形式中间节点占用更少，可能更常见一点，不过下面的讲解是按第一种定义来</p><h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><p>B+ 树比 B 树更适合实际应用中操作系统的文件索引和数据库索引</p><ol><li>B+ 树索引节点可以存储更多的关键字，磁盘 I/O 可以更少</li></ol><blockquote><p>数据库中关键字可能只是某个数据列的索引信息(比如以 ID 列创建的索引)，而索引指向的数据记录(某个 ID 对应的数据行)我们称作<strong>卫星数据</strong>，推荐看下博文 <a href="http://www.ruanyifeng.com/blog/2014/07/database_implementation.html" target="_blank" rel="noopener">数据库的最简单实现</a> 和 <a href="http://blog.codinglabs.org/articles/theory-of-mysql-index.html" target="_blank" rel="noopener">MySQL索引背后的数据结构及算法原理</a></p><p>B- 树中间节点和叶子节点都会带有关键字和卫星数据的指针，B+ 树中间节点只带有关键字，而卫星数据的指针均放在叶子节点中</p></blockquote><p>因为没有卫星数据的指针，所以 B+ 树内部结点相对 B 树占用空间更小。如果把所有同一结点的关键字存放在同一盘块中，那么对于 B+ 树来说盘块所能容纳的关键字数量也就更多，一次性读入内存中时能查找的关键字也就更多。相对来说 IO 读写次数也就降低了，性能就提升了。</p><p>举个例子，假设磁盘中的一个盘块能容纳 16 bytes，而一个关键字占 2 bytes，一个卫星数据指针占 2bytes。对于一棵 9 阶 B 树来说，一个结点最多含 8 个关键字(8*4 bytes)，即一个内部结点需要 2 个盘块来存储。而对于 B+ 树来说，内部结点不含卫星数据的指针，所以一个内部节点只需要 1 个盘块。当需要把内部结点读入内存中的时候，B 树就比 B+ 树多一次盘块查找时间</p><ol start="2"><li>B+ 树的查询效率更加稳定</li></ol><p>由于非叶子节点并不是最终指向文件内容的结点，而只是叶子结点中关键字的索引。所以任何关键字的查找必须走一条从根结点到叶子结点的路径。所有关键字查询的路径长度相同，导致每一个数据的查询效率相当。而 B 树查找一个文件时查找到的路径长度是不一的。</p><ol start="3"><li>B+ 树对范围查询操作更友好</li></ol><p>如果是查找单一元素，B+ 树的查找过程与 B 树类似，只是每次查找都是从根查到叶</p><p>而进行范围查询的操作时，B+ 树只要遍历叶子节点就可以实现整棵树的遍历，而 B 树的范围查询要通过中序遍历，效率比较低下</p><h3 id="插入-1"><a href="#插入-1" class="headerlink" title="插入"></a>插入</h3><p>B+ 树的插入与 B 树类似，先寻找关键字对应的位置插入，需要注意的是插入比当前子树的最大关键字还大的数时要修改祖先节点对应的关键字，因为 B+ 树内部结点存的是子树的最大关键字</p><p>比如在上面给出的 B+ 树中插入 105 这个元素，因为 105 大于当前子树最大关键字 101，所以需要修改父节点和祖父节点的边界关键字:</p><p><img src="https://src.wangriyu.wang/images/blog/tree/B+T-insert-0.svg" alt="插入 105"></p><ul><li>如果插入元素的节点未超出上界限制，则结束；否则将节点分裂，中间节点上移到父节点中，再判断父节点是否需要调整</li></ul><p>比如刚才插入 105 的叶子节点关键字个数达到 4 个，需要分裂，这里分裂与 B 树略有不同。B 树是把节点按中间节点分成三份，再把中间节点上移；而 B+ 树是分成两份，再把左半节点的最大关键字添加进父节点</p><p><img src="https://src.wangriyu.wang/images/blog/tree/B+T-insert-1.svg" alt="分裂叶子"></p><p>此时父节点也需要分裂</p><p><img src="https://src.wangriyu.wang/images/blog/tree/B+T-insert-2.svg" alt="分裂父节点"></p><p>根节点未超出 4，结束；假如此时根节点也超出上界了，需要把根节点也分裂，生成一个新的根节点，且新的根节点的关键字为左右子树的最大关键字</p><h3 id="删除-1"><a href="#删除-1" class="headerlink" title="删除"></a>删除</h3><p>B+ 树的删除与 B 树也类似，找到要删除的关键字，如果是当前子树的最大关键字，删除该关键字后还要修改祖先节点对应的关键字；如果不是当前子树的最大关键字，直接删除；</p><p>在上一张图的基础上删除 8，这是叶子的最大关键字，所以需要修改父节点和祖父节点的边界关键字:</p><p><img src="https://src.wangriyu.wang/images/blog/tree/B+T-removal-0.svg" alt="删除 8"></p><ul><li>如果删除元素的节点未低于下界限制，则结束；否则分两种情况处理:<ul><li>如果兄弟节点有富余关键字，则从兄弟节点中移动一个关键字到当前节点，修改父节点对应边界关键字即可</li><li>如果兄弟节点关键字个数都处于下界值，不能外借元素，则合并当前节点和兄弟节点，修改父节点的孩子指针以及边界关键字，此时父节点关键字个数也少了一个，将当前节点的指针指向父节点继续判断处理</li></ul></li></ul><p>我们继续删除 7，此时该叶子节点关键字个数少于 1 需要调整，而兄弟节点有富余关键字，可以移动 5 到当前节点，修改父节点和祖父节点的边界关键字</p><p><img src="https://src.wangriyu.wang/images/blog/tree/B+T-removal-1.svg" alt="删除 7"></p><p>继续删除 5，兄弟节点的关键字个数为下界值 1，不能外借，则合并当前节点和兄弟节点，并修改父节点指针及关键字，相应的祖父节点也需要修改边界关键字</p><p><img src="https://src.wangriyu.wang/images/blog/tree/B+T-removal-2.svg" alt="删除 5"></p><blockquote><p>B+ 树动态展示: <a href="https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html" target="_blank" rel="noopener">https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html</a></p></blockquote><h2 id="B-树-B-Tree-2"><a href="#B-树-B-Tree-2" class="headerlink" title="B* 树 (B* - Tree)"></a>B* 树 (B* - Tree)</h2><p>B* 树是 B+ 树的变体，在 B+ 树的基础上(所有的叶子结点中包含了全部关键字的信息，及指向含有这些关键字记录的指针)，B* 树多了两条性质:</p><ul><li>中间结点也增加了指向兄弟的指针，即每一层节点都可以横向遍历</li><li>B* 树定义了非叶子结点关键字个数至少为 $\lceil\frac {2m}3\rceil$，即块的最低使用率为 2/3，代替 B+ 树的 1/2</li></ul><p>下图的数据与之前 B+ 树的数据一样，但分支结构有所不同(因为中间节点关键字范围变为[3, 4]，不同于之前 B+ 树的 [2, 4])，而且第二层节点之间也用指针连接起来<br><img src="https://src.wangriyu.wang/images/blog/tree/B*-Tree.svg" alt="B* 树"></p><h3 id="优势-1"><a href="#优势-1" class="headerlink" title="优势"></a>优势</h3><p>B+ 树节点满时就会分裂，而 B* 树节点满时会先检查兄弟节点是否满(因为每个节点都有指向兄弟的指针):</p><ul><li>如果兄弟节点未满则向兄弟节点转移关键字，然后修改原节点和兄弟结点的关键字以及会受最大关键字变动影响的祖先的边界关键字</li><li>如果兄弟节点已满，则从当前节点和兄弟节点各拿出 1/3 的数据创建一个新的节点出来，然后在父结点增加新结点的指针</li></ul><p>B* 树存有兄弟节点的指针，可以向兄弟节点转移关键字的特性使得 B* 树分解次数变得更少，节点空间使用率更高</p><p>因为没有找到相关的内容，关于 B* 树的插入删除这里不再讲解</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文依次介绍了二叉树 -&gt; 二叉搜索树 -&gt; 平衡二叉搜索树(红黑树) -&gt; 平衡多路查找树(B 类树)，各有特点，其中 B 类树是介绍的重点，因为实际运用中索引结构使用的是 B 类树</p><p>因为树的上面几层会反复查询，所以我们可以把树的前几层存在内存中，而底层的数据存在外部磁盘里，这样效率更高</p><p>当然 B 树也存在弊端:</p><p>因为一旦确定最大阶数，后面的使用过程中就不可以修改关键字个数的范围</p><p>那么除非完全重建数据库，否则无法改变键值的最大长度。这使得许多数据库系统将人名截断到 70 字符之内</p><p>后面一篇我们会讲解另一种 Mysql 的索引结构: 哈希索引，可以动态适应任意长度的键值</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://zh.wikipedia.org/wiki/%E7%BA%A2%E9%BB%91%E6%A0%91" target="_blank" rel="noopener">wikipedia - 红黑树</a></li><li><a href="https://mp.weixin.qq.com/s/rDCEFzoKHIjyHfI_bsz5Rw" target="_blank" rel="noopener">什么是 B-树</a></li><li>《编程之法: 面试和算法心得》</li></ul>]]></content>
      
      <categories>
          
          <category> 数据结构和算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 数据库 </tag>
            
            <tag> 树 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>使用 Aplayer 导致博客目录跳转失效</title>
      <link href="/2018/06-Aplayer.html"/>
      <url>/2018/06-Aplayer.html</url>
      <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>可以在此链接中测试 <a href="https://codepen.io/wangriyu/full/aGraGO" target="_blank" rel="noopener">https://codepen.io/wangriyu/full/aGraGO</a></p><p>加载 1.10.1 版本的 Aplayer 后，页面内带中文字符的锚标签均无法跳转，而纯英文的正常</p><h2 id="前因"><a href="#前因" class="headerlink" title="前因"></a>前因</h2><p><img src="https://src.wangriyu.wang/images/blog/aplayer/toc.png" alt="toc"></p><p>前不久的某一天，我照常打开博客浏览新发布的文章时，点击侧边栏的锚标签进行目录跳转，突然发现没反应！？</p><p><img src="https://src.wangriyu.wang/images/blog/aplayer/emoji.jpeg" alt="emoji"></p><p>难道是我打开的姿势不对？我又打开另几篇博客，试了几个目录发现都一样没反应，难道是我之前给左上角背景图片添加 <code>pointer-events: none</code> 时影响到侧边栏的点击事件了?</p><p>但是也不对啊，我试了发现<strong>只有中文标题的目录点击跳转不了，英文标题却是正常的</strong>，肯定是其他地方的锅</p><p>我的第一直觉是这个左下角的播放器，因为这是前不久添加的，而且离这些锚标签近</p><p>打开控制台，我先看了播放器是否覆盖了目录，没有！然后我看了下锚标签的点击事件</p><p><img src="https://src.wangriyu.wang/images/blog/aplayer/console-1.png" alt="console"></p><p>这个 smoothscroll 有点眼生啊，我好像没用过啊</p><p>我再试着把播放器去掉，发现目录跳转一切正常，果然是你的锅</p><h2 id="后果"><a href="#后果" class="headerlink" title="后果"></a>后果</h2><p>发现是播放器的问题之后，我继续找问题出在哪，我发现去掉播放器之后，锚标签的点击事件少了刚才的 smoothscroll，应该是这个插件的问题</p><p><img src="https://src.wangriyu.wang/images/blog/aplayer/console-0.png" alt="console"></p><p>先去 Aplayer 的仓库看了下依赖，果然使用这插件</p><p><img src="https://src.wangriyu.wang/images/blog/aplayer/smoothscroll.png" alt="smoothscroll"></p><p>再去看了下 smoothscroll 的仓库，克隆了一份做了下测试</p><p>然后我发现它处理 hash 时只测试了英文，而使用中文时，中文字符转成了 Unicode 码，下面函数的判断条件无法成立，后面的点击处理也就失效了</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> linkHandler <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ev<span class="token punctuation">.</span>defaultPrevented<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ev<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>hash <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hash<span class="token punctuation">)</span> window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hash<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// using the history api to solve issue #1 - back doesn't work</span>        <span class="token comment" spellcheck="true">// most browser don't update :target when the history api is used:</span>        <span class="token comment" spellcheck="true">// THIS IS A BUG FROM THE BROWSERS.</span>        <span class="token comment" spellcheck="true">// change the scrolling duration in this call</span>        <span class="token keyword">var</span> node <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Do not scroll to non-existing node</span>        <span class="token function">smoothScroll</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>            location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> el<span class="token punctuation">.</span>id<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// this will cause the :target to be activated.</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>需要修改的地方是对 hash 的进行 decodeURIComponent 处理，这样就能正常处理中文的标签和 location 的对应问题了</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> linkHandler <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ev<span class="token punctuation">.</span>defaultPrevented<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ev<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">)</span> window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// using the history api to solve issue #1 - back doesn't work</span>        <span class="token comment" spellcheck="true">// most browser don't update :target when the history api is used:</span>        <span class="token comment" spellcheck="true">// THIS IS A BUG FROM THE BROWSERS.</span>        <span class="token comment" spellcheck="true">// change the scrolling duration in this call</span>        <span class="token keyword">var</span> node <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token function">decodeURIComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Do not scroll to non-existing node</span>        <span class="token function">smoothScroll</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>            location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> el<span class="token punctuation">.</span>id<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// this will cause the :target to be activated.</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我已经提出了 pull request，静等官方修复</p><p>如果是使用 Aplayer 的用户，可以先自行修改依赖，重新编译一份带正常功能的 smoothscroll 的 Aplayer</p><p>我这有已经打包修复的: <a href="https://src.wangriyu.wang/lib/Aplayer/1.10.1/APlayer.min.js" target="_blank" rel="noopener">https://src.wangriyu.wang/lib/Aplayer/1.10.1/APlayer.min.js</a></p><p>现在我博客侧边栏的目录点击也是正常的了</p>]]></content>
      
      <categories>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Aplayer </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>搭建 docker 环境并用 docker 部署 nextcloud 网盘</title>
      <link href="/2018/05-server-nextcloud.html"/>
      <url>/2018/05-server-nextcloud.html</url>
      <content type="html"><![CDATA[<blockquote><p>系统环境为 CentOS 7.4，默认用户为 root</p></blockquote><h2 id="安装-docker-和-docker-compose"><a href="#安装-docker-和-docker-compose" class="headerlink" title="安装 docker 和 docker-compose"></a>安装 docker 和 docker-compose</h2><h3 id="安装-docker"><a href="#安装-docker" class="headerlink" title="安装 docker"></a>安装 docker</h3><pre class="line-numbers language-bash"><code class="language-bash">$ yum <span class="token function">install</span> docker-io -y$ docker -v // 查看版本$ systemctl start docker // 启动 docker$ systemctl <span class="token function">enable</span> docker // 设置开机自启动$ docker info // 如果已经启动 docker，会输出全局信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>设置镜像源，因为我是腾讯云服务器，所以选了腾讯云提供的源</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token keyword">echo</span> <span class="token string">"OPTIONS='--registry-mirror=https://mirror.ccs.tencentyun.com'"</span> <span class="token operator">>></span> /etc/sysconfig/docker$ systemctl daemon-reload$ <span class="token function">service</span> docker restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>现在就可使用 docker 了</p><pre class="line-numbers language-bash"><code class="language-bash">$ docker search mysql$ docker pull 镜像$ docker images // 已安装镜像$ docker <span class="token function">ps</span> -a // 已启动容器<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="安装-docker-compose"><a href="#安装-docker-compose" class="headerlink" title="安装 docker-compose"></a>安装 docker-compose</h3><pre class="line-numbers language-bash"><code class="language-bash">$ yum -y <span class="token function">install</span> epel-release$ yum -y <span class="token function">install</span> python-pip$ pip <span class="token function">install</span> --upgrade --force-reinstall pip<span class="token operator">==</span>9.0.3 // 这里如果升级最新的，比如 10.0 以上的，下面安装 docker-compose 会报错$ pip <span class="token function">install</span> docker-compose$ docker-compose --version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="部署-nextcloud"><a href="#部署-nextcloud" class="headerlink" title="部署 nextcloud"></a>部署 nextcloud</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><ul><li>需要镜像: <code>wonderfall/nextcloud</code> 和 <code>mariadb:10</code></li><li>主机需要安装 nginx</li></ul><h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">cd</span> ~$ docker pull wonderfall/nextcloud$ docker pull mariadb:10$ <span class="token function">vi</span> docker-compose.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>粘贴以下内容</p><pre class="line-numbers language-stylus"><code class="language-stylus">nextcloud<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">image</span><span class="token punctuation">:</span> wonderfall<span class="token operator">/</span>nextcloud</span>  <span class="token property-declaration"><span class="token property">container_name</span><span class="token punctuation">:</span> nextcloud_web</span>  <span class="token property-declaration"><span class="token property">links</span><span class="token punctuation">:</span>    <span class="token operator">-</span> nextcloud-db<span class="token punctuation">:</span>nextcloud-db</span>  environment<span class="token punctuation">:</span>    <span class="token property-declaration"><span class="token property">-</span> UID<span class="token operator">=</span><span class="token number">1000</span></span>    <span class="token property-declaration"><span class="token property">-</span> GID<span class="token operator">=</span><span class="token number">1000</span></span>    <span class="token property-declaration"><span class="token property">-</span> UPLOAD_MAX_SIZE<span class="token operator">=</span><span class="token number">5</span>G</span>    <span class="token property-declaration"><span class="token property">-</span> APC_SHM_SIZE<span class="token operator">=</span><span class="token number">128</span>M</span>    <span class="token property-declaration"><span class="token property">-</span> OPCACHE_MEM_SIZE<span class="token operator">=</span><span class="token number">128</span></span>    <span class="token property-declaration"><span class="token property">-</span> CRON_PERIOD<span class="token operator">=</span><span class="token number">15</span>m</span>    <span class="token property-declaration"><span class="token property">-</span> TZ<span class="token operator">=</span>Aisa<span class="token operator">/</span>Shanghai</span>    <span class="token property-declaration"><span class="token property">-</span> ADMIN_USER<span class="token operator">=</span>登录账号</span>    <span class="token property-declaration"><span class="token property">-</span> ADMIN_PASSWORD<span class="token operator">=</span>登录密码</span>    <span class="token property-declaration"><span class="token property">-</span> DOMAIN<span class="token operator">=</span>localhost</span>    <span class="token property-declaration"><span class="token property">-</span> DB_TYPE<span class="token operator">=</span>mysql</span>    <span class="token property-declaration"><span class="token property">-</span> DB_NAME<span class="token operator">=</span>nextcloud</span>    <span class="token property-declaration"><span class="token property">-</span> DB_USER<span class="token operator">=</span>nextcloud</span>    <span class="token property-declaration"><span class="token property">-</span> DB_PASSWORD<span class="token operator">=</span>数据库 nextcloud 账号密码</span>    <span class="token property-declaration"><span class="token property">-</span> DB_HOST<span class="token operator">=</span>nextcloud-db</span>  volumes<span class="token punctuation">:</span>    # 文件会放在宿主机的 `/docker/nextcloud` 目录，如果不存在会自动创建    <span class="token property-declaration"><span class="token property">-</span> <span class="token operator">/</span>docker<span class="token operator">/</span>nextcloud<span class="token operator">/</span>data<span class="token punctuation">:</span><span class="token operator">/</span>data</span>    <span class="token property-declaration"><span class="token property">-</span> <span class="token operator">/</span>docker<span class="token operator">/</span>nextcloud<span class="token operator">/</span>config<span class="token punctuation">:</span><span class="token operator">/</span>config</span>    <span class="token property-declaration"><span class="token property">-</span> <span class="token operator">/</span>docker<span class="token operator">/</span>nextcloud<span class="token operator">/</span>apps<span class="token punctuation">:</span><span class="token operator">/</span>apps2</span>    <span class="token property-declaration"><span class="token property">-</span> <span class="token operator">/</span>docker<span class="token operator">/</span>nextcloud<span class="token operator">/</span>themes<span class="token punctuation">:</span><span class="token operator">/</span>nextcloud<span class="token operator">/</span>themes</span>  <span class="token property-declaration"><span class="token property">expose</span><span class="token punctuation">:</span>    <span class="token operator">-</span> <span class="token number">8888</span></span>  ports<span class="token punctuation">:</span>    # 宿主机端口<span class="token punctuation">:</span>镜像端口    <span class="token property-declaration"><span class="token property">-</span> <span class="token number">8888</span><span class="token punctuation">:</span><span class="token number">8888</span><span class="token operator">/</span>tcp</span>  <span class="token property-declaration"><span class="token property">restart</span><span class="token punctuation">:</span> always</span>nextcloud-db<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">image</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">:</span><span class="token number">10</span></span>  <span class="token property-declaration"><span class="token property">container_name</span><span class="token punctuation">:</span> nextcloud_db</span>  volumes<span class="token punctuation">:</span>    # 数据库文件会放在宿主机的 `/docker/nextcloud/db` 目录，如果不存在会自动创建    <span class="token property-declaration"><span class="token property">-</span> <span class="token operator">/</span>docker<span class="token operator">/</span>nextcloud<span class="token operator">/</span>db<span class="token punctuation">:</span><span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql</span>  environment<span class="token punctuation">:</span>    <span class="token property-declaration"><span class="token property">-</span> MYSQL_ROOT_PASSWORD<span class="token operator">=</span>数据库 root 密码</span>    <span class="token property-declaration"><span class="token property">-</span> MYSQL_DATABASE<span class="token operator">=</span>nextcloud</span>    <span class="token property-declaration"><span class="token property">-</span> MYSQL_USER<span class="token operator">=</span>nextcloud</span>    <span class="token property-declaration"><span class="token property">-</span> MYSQL_PASSWORD<span class="token operator">=</span>数据库 nextcloud 账号密码</span>  <span class="token property-declaration"><span class="token property">restart</span><span class="token punctuation">:</span> always</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编辑完后保存退出，在 docker-compose.yml 同级目录执行:</p><pre class="line-numbers language-bash"><code class="language-bash">$ docker-compose up -dCreating nextcloud_db <span class="token punctuation">..</span>. <span class="token keyword">done</span>Creating nextcloud_web <span class="token punctuation">..</span>. <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这里要注意一下，相应容器启动后还有一段配置时间，大概几分钟到十几分钟不等。我刚开始弄的时候，起完容器就去看网页能否打开，结果打不开，以为是打开的方式不对，直到后面看了一下日志才发现需要等…</p><pre class="line-numbers language-bash"><code class="language-bash">$ docker <span class="token function">ps</span> -a // 可以看到容器已经起来$ docker logs nextcloud_db // 查看数据库配置是否完成$ docker logs nextcloud_web // 查看 nextcloud 是否配置完成<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这里推荐安装 httpie 工具，方便测试 http，如果 nextcloud 服务正常的话，应该会输出一个 login 页</p><pre class="line-numbers language-bash"><code class="language-bash">$ yum <span class="token function">install</span> httpie$ http localhost:8888<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>现在 nextcloud 网盘就搭建好了，通过 ip:8888 就可以访问网盘页面了，下一步添加域名解析</p><h3 id="添加域名"><a href="#添加域名" class="headerlink" title="添加域名"></a>添加域名</h3><p>到 DNS 解析那添加一条二级域名，比如我用 pan，解析值填服务器 IP</p><p>回到服务器上</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">cd</span> /etc/nginx/conf.d$ <span class="token function">vi</span> pan.wangriyu.wang.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>添加主机设置</p><pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">{</span>    <span class="token keyword">server_name</span>  pan<span class="token punctuation">.</span>wangriyu<span class="token punctuation">.</span>wang<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># https 设置，可以不写</span>    <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># managed by Certbot</span>    <span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>etc<span class="token operator">/</span>letsencrypt<span class="token operator">/</span>live<span class="token operator">/</span>wangriyu<span class="token punctuation">.</span>wang<span class="token operator">/</span>fullchain<span class="token punctuation">.</span>pem<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># managed by Certbot</span>    <span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>etc<span class="token operator">/</span>letsencrypt<span class="token operator">/</span>live<span class="token operator">/</span>wangriyu<span class="token punctuation">.</span>wang<span class="token operator">/</span>privkey<span class="token punctuation">.</span>pem<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># managed by Certbot</span>    <span class="token keyword">include</span> <span class="token operator">/</span>etc<span class="token operator">/</span>letsencrypt<span class="token operator">/</span>options<span class="token operator">-</span><span class="token keyword">ssl</span><span class="token operator">-</span>nginx<span class="token punctuation">.</span>conf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># managed by Certbot</span>    <span class="token keyword">ssl_dhparam</span> <span class="token operator">/</span>etc<span class="token operator">/</span>letsencrypt<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">-</span>dhparams<span class="token punctuation">.</span>pem<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># managed by Certbot</span>    <span class="token keyword">add_header</span> Strict<span class="token operator">-</span>Transport<span class="token operator">-</span>Security <span class="token string">"max-age=63072000; includeSubdomains"</span> always<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># 限制客户端最大上传大小</span>    <span class="token keyword">client_max_body_size</span> 5G<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># 反向代理</span>    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>      <span class="token keyword">proxy_redirect</span> off<span class="token punctuation">;</span>      <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token punctuation">:</span><span class="token number">8888</span><span class="token punctuation">;</span>      <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span><span class="token punctuation">.</span>htaccess <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token number">404</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">server</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true"># 非加密连接重定向到 https 上</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$host</span> <span class="token operator">=</span> pan<span class="token punctuation">.</span>wangriyu<span class="token punctuation">.</span>wang<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token number">301</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$host</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token comment" spellcheck="true"># managed by Certbot</span>    <span class="token keyword">listen</span>   <span class="token number">80</span><span class="token punctuation">;</span>    <span class="token keyword">server_name</span>  pan<span class="token punctuation">.</span>wangriyu<span class="token punctuation">.</span>wang<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">404</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># managed by Certbot</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编辑完保存退出，重载 nginx</p><pre class="line-numbers language-bash"><code class="language-bash">$ nginx -s reload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>此时我们就可以访问 <a href="https://pan.wangriyu.wang" target="_blank" rel="noopener">https://pan.wangriyu.wang</a> 了，nextcloud 还有客户端，好好享受你的个人网盘吧</p>]]></content>
      
      <categories>
          
          <category> Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> nextcloud </tag>
            
            <tag> 个人网盘 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>CentOS 搭建 FTP 服务</title>
      <link href="/2018/05-server-ftp.html"/>
      <url>/2018/05-server-ftp.html</url>
      <content type="html"><![CDATA[<blockquote><p>系统环境为 CentOS 7.4，默认用户为 root</p></blockquote><h2 id="安装并启动-FTP-服务"><a href="#安装并启动-FTP-服务" class="headerlink" title="安装并启动 FTP 服务"></a>安装并启动 FTP 服务</h2><h3 id="安装-VSFTPD"><a href="#安装-VSFTPD" class="headerlink" title="安装 VSFTPD"></a>安装 VSFTPD</h3><p>官网介绍: <a href="https://security.appspot.com/vsftpd.html#about" target="_blank" rel="noopener">https://security.appspot.com/vsftpd.html#about</a></p><pre class="line-numbers language-bash"><code class="language-bash">$ yum <span class="token function">install</span> vsftpd -y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="启动-VSFTPD"><a href="#启动-VSFTPD" class="headerlink" title="启动 VSFTPD"></a>启动 VSFTPD</h3><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">service</span> vsftpd start$ systemctl <span class="token function">enable</span> vsftpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ftp 协议默认使用的是 21 端口，如果服务正常启动了，此命令应该会输出占用对象为 vsftpd</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">netstat</span> -nltp <span class="token operator">|</span> <span class="token function">grep</span> 21<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>此时访问 <code>ftp://服务器 IP 地址</code> 就可以浏览服务器上的 /var/ftp 目录了</p><h3 id="配置-FTP-权限"><a href="#配置-FTP-权限" class="headerlink" title="配置 FTP 权限"></a>配置 FTP 权限</h3><p>当前 FTP 服务允许匿名登陆，即直接访问，我们需要配置 FTP 访问权限</p><p>vsftpd 的配置目录为 /etc/vsftpd，其中</p><ul><li>vsftpd.conf 为主要配置文件</li><li>ftpusers 配置禁止访问 FTP 服务器的用户列表，即黑名单</li><li>user_list 配置用户访问控制</li></ul><h3 id="阻止匿名访问和切换根目录"><a href="#阻止匿名访问和切换根目录" class="headerlink" title="阻止匿名访问和切换根目录"></a>阻止匿名访问和切换根目录</h3><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">vi</span> /etc/vsftpd/vsftpd.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>找到 <code>anonymous_enable</code> 并设为 NO，找到 <code>chroot_local_user</code> 并去掉注释，并在最后添加 <code>allow_writeable_chroot=YES</code></p><pre class="line-numbers language-stylus"><code class="language-stylus"># 禁用匿名用户<span class="token variable-declaration"><span class="token variable">anonymous_enable=NO</span></span># 禁止切换根目录<span class="token variable-declaration"><span class="token variable">chroot_local_user=YES</span></span># 避免 vsftpd：500 OOPS<span class="token punctuation">:</span> vsftpd<span class="token punctuation">:</span> refusing to run with writable root inside chroot <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable-declaration"><span class="token variable">allow_writeable_chroot=YES</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其他配置见 <code>Very Secure FTP Daemon 手册</code>: <a href="https://wiki.archlinux.org/index.php/Very_Secure_FTP_Daemon_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)" target="_blank" rel="noopener">https://wiki.archlinux.org/index.php/Very_Secure_FTP_Daemon_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)</a></p><p>保存后重启 FTP 服务</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">service</span> vsftpd restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="创建-FTP-用户"><a href="#创建-FTP-用户" class="headerlink" title="创建 FTP 用户"></a>创建 FTP 用户</h3><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">useradd</span> ftpuser$ <span class="token function">passwd</span> ftpuser<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>限制该用户仅能通过 FTP 访问</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">usermod</span> -s /sbin/nologin ftpuser<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="为用户分配主目录"><a href="#为用户分配主目录" class="headerlink" title="为用户分配主目录"></a>为用户分配主目录</h3><p>假设 /data/ftp 是 ftp 要访问的目录</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">cd</span> /data$ <span class="token function">chmod</span> -R 755 ./ftp$ <span class="token function">chown</span> -R ftpuser ./ftp$ <span class="token function">usermod</span> -d /data/ftp ftpuser<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="访问-FTP-服务"><a href="#访问-FTP-服务" class="headerlink" title="访问 FTP 服务"></a>访问 FTP 服务</h3><p>Mac 系统推荐安装 <a href="https://panic.com/transmit/" target="_blank" rel="noopener">Transmit</a> 客户端</p><p>左边为本地文件，右边为 FTP 服务器，支持拖动，可以很方便的进行移动复制删除创建等操作</p><p><img src="https://src.wangriyu.wang/images/blog/ftp/transmit.png" alt="image"></p><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>至此 FTP 服务就搭建完了，我用这个 FTP 服务主要是上传修改博客和一些其他地方用到的静态文件，比如图片音乐等</p><p>我用 nginx 起一个 http 主机，这样我就可以通过 src.wangiyu.wang 这个域名访问 FTP 目录的文件，然后再去腾讯云那里添加 src.wangriyu.wang 到 CDN 上，这样我就可以用 FTP 方便管理博客要用到的图片等比较大的静态文件，然后用 CDN 来访问文件</p>]]></content>
      
      <categories>
          
          <category> Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ftp </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>HTTP2 详解</title>
      <link href="/2018/05-HTTP2.html"/>
      <url>/2018/05-HTTP2.html</url>
      <content type="html"><![CDATA[<p>维基百科关于 HTTP/2 的介绍，可以看下定义和发展历史:</p><p><a href="https://zh.wikipedia.org/wiki/HTTP/2" target="_blank" rel="noopener">Wiki</a></p><p>RFC 7540 定义了 HTTP/2 的协议规范和细节，本文的细节主要来自此文档，建议先看一遍本文，再回过头来照着协议大致过一遍 RFC，如果想深入某些细节再仔细翻看 RFC</p><p><a href="https://httpwg.org/specs/rfc7540.html" target="_blank" rel="noopener">RFC7540</a></p><h2 id="Why-use-it"><a href="#Why-use-it" class="headerlink" title="Why use it ?"></a>Why use it ?</h2><h3 id="HTTP-1-1-存在的问题"><a href="#HTTP-1-1-存在的问题" class="headerlink" title="HTTP/1.1 存在的问题:"></a>HTTP/1.1 存在的问题:</h3><p>1、<strong>TCP 连接数限制</strong></p><p>对于同一个域名，浏览器最多只能同时创建 6~8 个 TCP 连接 (不同浏览器不一样)。为了解决数量限制，出现了 <code>域名分片</code> 技术，其实就是资源分域，将资源放在不同域名下 (比如二级子域名下)，这样就可以针对不同域名创建连接并请求，以一种讨巧的方式突破限制，但是滥用此技术也会造成很多问题，比如每个 TCP 连接本身需要经过 DNS 查询、三步握手、慢启动等，还占用额外的 CPU 和内存，对于服务器来说过多连接也容易造成网络拥挤、交通阻塞等，对于移动端来说问题更明显，可以参考这篇文章: <a href="http://dev.mobify.com/blog/domain-sharding-bad-news-mobile-performance/" target="_blank" rel="noopener">Why Domain Sharding is Bad News for Mobile Performance and Users</a></p><p><img src="https://src.wangriyu.wang/images/blog/http/HOLB-1.png" alt="image"></p><p><img src="https://src.wangriyu.wang/images/blog/http/HOLB-2.png" alt="image"></p><p>在图中可以看到新建了六个 TCP 连接，每次新建连接 DNS 解析需要时间(几 ms 到几百 ms 不等)、TCP 慢启动也需要时间、TLS 握手又要时间，而且后续请求都要等待队列调度</p><p>2、<strong><a href="https://zh.wikipedia.org/wiki/%E9%98%9F%E5%A4%B4%E9%98%BB%E5%A1%9E" target="_blank" rel="noopener">线头阻塞 (Head Of Line Blocking)</a> 问题</strong></p><p>每个 TCP 连接同时只能处理一个请求 - 响应，浏览器按 FIFO 原则处理请求，如果上一个响应没返回，后续请求 - 响应都会受阻。为了解决此问题，出现了 <a href="https://zh.wikipedia.org/wiki/HTTP%E7%AE%A1%E7%B7%9A%E5%8C%96" target="_blank" rel="noopener">管线化 - pipelining</a> 技术，但是管线化存在诸多问题，比如第一个响应慢还是会阻塞后续响应、服务器为了按序返回相应需要缓存多个响应占用更多资源、浏览器中途断连重试服务器可能得重新处理多个请求、还有必须客户端 - 代理 - 服务器都支持管线化</p><p>3、Header 内容多，而且每次请求 Header 不会变化太多，没有相应的压缩传输优化方案</p><p>4、为了尽可能减少请求数，需要做合并文件、雪碧图、资源内联等优化工作，但是这无疑造成了单个请求内容变大延迟变高的问题，且内嵌的资源不能有效地使用缓存机制</p><p>5、明文传输不安全</p><h3 id="HTTP2-的优势"><a href="#HTTP2-的优势" class="headerlink" title="HTTP2 的优势:"></a>HTTP2 的优势:</h3><h4 id="1、二进制分帧层-Binary-Framing-Layer"><a href="#1、二进制分帧层-Binary-Framing-Layer" class="headerlink" title="1、二进制分帧层 (Binary Framing Layer)"></a>1、二进制分帧层 (Binary Framing Layer)</h4><p>帧是数据传输的最小单位，以二进制传输代替原本的明文传输，原本的报文消息被划分为更小的数据帧:</p><p><img src="https://src.wangriyu.wang/images/blog/http/http2-frame.png" alt="image"></p><p>h1 和 h2 的报文对比:</p><p><img src="https://src.wangriyu.wang/images/blog/http/h1-message.png" alt="image"><br><img src="https://src.wangriyu.wang/images/blog/http/h2-message.png" alt="image"></p><p>图中 h2 的报文是重组解析过后的，可以发现一些头字段发生了变化，而且所有头字段均小写</p><blockquote><p><code>strict-transport-security: max-age=63072000; includeSubdomains</code> 字段是服务器开启 <a href="https://zh.wikipedia.org/wiki/HTTP%E4%B8%A5%E6%A0%BC%E4%BC%A0%E8%BE%93%E5%AE%89%E5%85%A8" target="_blank" rel="noopener">HSTS 策略</a>，让浏览器强制使用 HTTPS 进行通信，可以减少重定向造成的额外请求和会话劫持的风险</p></blockquote><blockquote><p>服务器开启 HSTS 的方法是: 以 nginx 为例，在相应站点的 server 模块中添加 <code>add_header Strict-Transport-Security &quot;max-age=63072000; includeSubdomains&quot; always;</code> 即可</p></blockquote><blockquote><p>在 Chrome 中可以打开 <code>chrome://net-internals/#hsts</code> 进入浏览器的 HSTS 管理界面，可以增加 / 删除 / 查询 HSTS 记录，比如下图:</p></blockquote><blockquote><p><img src="https://src.wangriyu.wang/images/blog/http/HSTS.png" alt="image"></p></blockquote><blockquote><p>在 HSTS 有效期内且 TLS 证书仍有效，浏览器访问 blog.wangriyu.wang 会自动加上 https:// ，而不需要做一次查询重定向到 https</p></blockquote><p>关于帧详见: <a href="#帧-Frame">How does it work ？- 帧</a></p><h4 id="2、多路复用-MultiPlexing"><a href="#2、多路复用-MultiPlexing" class="headerlink" title="2、多路复用 (MultiPlexing)"></a>2、多路复用 (MultiPlexing)</h4><p>在一个 TCP 连接上，我们可以向对方不断发送帧，每帧的 stream identifier 的标明这一帧属于哪个流，然后在对方接收时，根据 stream identifier 拼接每个流的所有帧组成一整块数据。<br>把 HTTP/1.1 每个请求都当作一个流，那么多个请求变成多个流，请求响应数据分成多个帧，不同流中的帧交错地发送给对方，这就是 HTTP/2 中的多路复用。</p><p>流的概念实现了单连接上多请求 - 响应并行，解决了线头阻塞的问题，减少了 TCP 连接数量和 TCP 连接慢启动造成的问题</p><p>所以 http2 对于同一域名只需要创建一个连接，而不是像 http/1.1 那样创建 6~8 个连接:</p><p><img src="https://src.wangriyu.wang/images/blog/http/ConnectionView-h1.png" alt="image"><br><img src="https://src.wangriyu.wang/images/blog/http/ConnectionView-h2.png" alt="image"></p><p>关于流详见: <a href="#流-Stream">How does it work ？- 流</a></p><h4 id="3、服务端推送-Server-Push"><a href="#3、服务端推送-Server-Push" class="headerlink" title="3、服务端推送 (Server Push)"></a>3、服务端推送 (Server Push)</h4><p>浏览器发送一个请求，服务器主动向浏览器推送与这个请求相关的资源，这样浏览器就不用发起后续请求。</p><p>Server-Push 主要是针对资源内联做出的优化，相较于 http/1.1 资源内联的优势:</p><ul><li>客户端可以缓存推送的资源</li><li>客户端可以拒收推送过来的资源</li><li>推送资源可以由不同页面共享</li><li>服务器可以按照优先级推送资源</li></ul><p>关于服务端推送详见: <a href="#Server-Push">How does it work ？- Server-Push</a></p><h4 id="4、Header-压缩-HPACK"><a href="#4、Header-压缩-HPACK" class="headerlink" title="4、Header 压缩 (HPACK)"></a>4、Header 压缩 (HPACK)</h4><p>使用 <a href="https://httpwg.org/specs/rfc7541.html" target="_blank" rel="noopener">HPACK</a> 算法来压缩首部内容</p><p>关于 HPACK 详见: <a href="#HPACK-算法">How does it work ？- HPACK</a></p><h4 id="5、应用层的重置连接"><a href="#5、应用层的重置连接" class="headerlink" title="5、应用层的重置连接"></a>5、应用层的重置连接</h4><p>对于 HTTP/1 来说，是通过设置 tcp segment 里的 reset flag 来通知对端关闭连接的。这种方式会直接断开连接，下次再发请求就必须重新建立连接。HTTP/2 引入 RST_STREAM 类型的 frame，可以在不断开连接的前提下取消某个 request 的 stream，表现更好。</p><h4 id="6、请求优先级设置"><a href="#6、请求优先级设置" class="headerlink" title="6、请求优先级设置"></a>6、请求优先级设置</h4><p>HTTP/2 里的每个 stream 都可以设置依赖 (Dependency) 和权重，可以按依赖树分配优先级，解决了关键请求被阻塞的问题</p><h4 id="7、流量控制"><a href="#7、流量控制" class="headerlink" title="7、流量控制"></a>7、流量控制</h4><p>每个 http2 流都拥有自己的公示的流量窗口，它可以限制另一端发送数据。对于每个流来说，两端都必须告诉对方自己还有足够的空间来处理新的数据，而在该窗口被扩大前，另一端只被允许发送这么多数据。</p><p>关于流量控制详见: <a href="#流量控制">How does it work ？- 流量控制</a></p><h4 id="8、HTTP-1-的几种优化可以弃用"><a href="#8、HTTP-1-的几种优化可以弃用" class="headerlink" title="8、HTTP/1 的几种优化可以弃用"></a>8、HTTP/1 的几种优化可以弃用</h4><p>合并文件、内联资源、雪碧图、域名分片对于 HTTP/2 来说是不必要的，使用 h2 尽可能将资源细粒化，文件分解地尽可能散，不用担心请求数多</p><h2 id="How-does-it-work"><a href="#How-does-it-work" class="headerlink" title="How does it work ?"></a>How does it work ?</h2><h3 id="帧-Frame"><a href="#帧-Frame" class="headerlink" title="帧 - Frame"></a>帧 - Frame</h3><h4 id="帧的结构"><a href="#帧的结构" class="headerlink" title="帧的结构"></a>帧的结构</h4><p>所有帧都是一个固定的 9 字节头部 (payload 之前) 跟一个指定长度的负载 (payload):</p><pre class="line-numbers language-http"><code class="language-http">+-----------------------------------------------+|                 Length (24)                   |+---------------+---------------+---------------+|   Type (8)    |   Flags (8)   |+-+-------------+---------------+-------------------------------+|R|                 Stream Identifier (31)                      |+=+=============================================================+|                   Frame Payload (0...)                      ...+---------------------------------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>Length</code> 代表整个 frame 的长度，用一个 24 位无符号整数表示。除非接收者在 SETTINGS_MAX_FRAME_SIZE 设置了更大的值 (大小可以是 2^14(16384) 字节到 2^24-1(16777215) 字节之间的任意值)，否则数据长度不应超过 2^14(16384) 字节。头部的 9 字节不算在这个长度里</li><li><code>Type</code> 定义 frame 的类型，用 8 bits 表示。帧类型决定了帧主体的格式和语义，如果 type 为 unknown 应该忽略或抛弃。</li><li><code>Flags</code> 是为帧类型相关而预留的布尔标识。标识对于不同的帧类型赋予了不同的语义。如果该标识对于某种帧类型没有定义语义，则它必须被忽略且发送的时候应该赋值为 (0x0)</li><li><code>R</code> 是一个保留的比特位。这个比特的语义没有定义，发送时它必须被设置为 (0x0), 接收时需要忽略。</li><li><a href="https://httpwg.org/specs/rfc7540.html#StreamIdentifiers" target="_blank" rel="noopener">Stream Identifier</a> 用作流控制，用 31 位无符号整数表示。客户端建立的 sid 必须为奇数，服务端建立的 sid 必须为偶数，值 (0x0) 保留给与整个连接相关联的帧 (连接控制消息)，而不是单个流</li><li><code>Frame Payload</code> 是主体内容，由帧类型决定</li></ul><p>共分为十种类型的帧:</p><ul><li><code>HEADERS</code>: 报头帧 (type=0x1)，用来打开一个流或者携带一个首部块片段</li><li><code>DATA</code>: 数据帧 (type=0x0)，装填主体信息，可以用一个或多个 DATA 帧来返回一个请求的响应主体</li><li><code>PRIORITY</code>: 优先级帧 (type=0x2)，指定发送者建议的流优先级，可以在任何流状态下发送 PRIORITY 帧，包括空闲 (idle) 和关闭 (closed) 的流</li><li><code>RST_STREAM</code>: 流终止帧 (type=0x3)，用来请求取消一个流，或者表示发生了一个错误，payload 带有一个 32 位无符号整数的错误码 (<a href="https://httpwg.org/specs/rfc7540.html#ErrorCodes" target="_blank" rel="noopener">Error Codes</a>)，不能在处于空闲 (idle) 状态的流上发送 RST_STREAM 帧</li><li><code>SETTINGS</code>: 设置帧 (type=0x4)，设置此 <code>连接</code> 的参数，作用于整个连接</li><li><code>PUSH_PROMISE</code>: 推送帧 (type=0x5)，服务端推送，客户端可以返回一个 RST_STREAM 帧来选择拒绝推送的流</li><li><code>PING</code>: PING 帧 (type=0x6)，判断一个空闲的连接是否仍然可用，也可以测量最小往返时间 (RTT)</li><li><code>GOAWAY</code>: GOWAY 帧 (type=0x7)，用于发起关闭连接的请求，或者警示严重错误。GOAWAY 会停止接收新流，并且关闭连接前会处理完先前建立的流</li><li><code>WINDOW_UPDATE</code>: 窗口更新帧 (type=0x8)，用于执行流量控制功能，可以作用在单独某个流上 (指定具体 Stream Identifier) 也可以作用整个连接 (Stream Identifier 为 0x0)，只有 DATA 帧受流量控制影响。初始化流量窗口后，发送多少负载，流量窗口就减少多少，如果流量窗口不足就无法发送，WINDOW_UPDATE 帧可以增加流量窗口大小</li><li><code>CONTINUATION</code>: 延续帧 (type=0x9)，用于继续传送首部块片段序列，见 <a href="#首部的压缩与解压缩">首部的压缩与解压缩</a></li></ul><h4 id="DATA-帧格式"><a href="#DATA-帧格式" class="headerlink" title="DATA 帧格式"></a>DATA 帧格式</h4><pre class="line-numbers language-http"><code class="language-http"> +---------------+ |Pad Length? (8)| +---------------+-----------------------------------------------+ |                            Data (*)                         ... +---------------------------------------------------------------+ |                           Padding (*)                       ... +---------------------------------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>Pad Length</code>: ? 表示此字段的出现时有条件的，需要设置相应标识 (set flag)，指定 Padding 长度，存在则代表 PADDING flag 被设置</li><li><code>Data</code>: 传递的数据，其长度上限等于帧的 payload 长度减去其他出现的字段长度</li><li><code>Padding</code>: 填充字节，没有具体语义，发送时必须设为 0，作用是混淆报文长度，与 TLS 中 CBC 块加密类似，详见 <a href="https://httpwg.org/specs/rfc7540.html#padding" target="_blank" rel="noopener">https://httpwg.org/specs/rfc7540.html#padding</a></li></ul><p>DATA 帧有如下标识 (flags):</p><ul><li>END_STREAM: bit 0 设为 1 代表当前流的最后一帧</li><li>PADDED: bit 3 设为 1 代表存在 Padding</li></ul><p>例子:</p><p><img src="https://src.wangriyu.wang/images/blog/http/DATA-Frame1.png" alt="image"></p><p><img src="https://src.wangriyu.wang/images/blog/http/DATA-Frame2.png" alt="image"></p><p><img src="https://src.wangriyu.wang/images/blog/http/DATA-Frame3.png" alt="image"></p><h4 id="HEADERS-帧格式"><a href="#HEADERS-帧格式" class="headerlink" title="HEADERS 帧格式"></a>HEADERS 帧格式</h4><pre class="line-numbers language-http"><code class="language-http"> +---------------+ |Pad Length? (8)| +-+-------------+-----------------------------------------------+ |E|                 Stream Dependency? (31)                     | +-+-------------+-----------------------------------------------+ |  Weight? (8)  | +-+-------------+-----------------------------------------------+ |                   Header Block Fragment (*)                 ... +---------------------------------------------------------------+ |                           Padding (*)                       ... +---------------------------------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>Pad Length</code>: 指定 Padding 长度，存在则代表 PADDING flag 被设置</li><li><code>E</code>: 一个比特位声明流的依赖性是否是排他的，存在则代表 PRIORITY flag 被设置</li><li><code>Stream Dependency</code>: 指定一个 stream identifier，代表当前流所依赖的流的 id，存在则代表 PRIORITY flag 被设置</li><li><code>Weight</code>: 一个无符号 8 为整数，代表当前流的优先级权重值 (1~256)，存在则代表 PRIORITY flag 被设置</li><li><code>Header Block Fragment</code>: header 块片段</li><li><code>Padding</code>: 填充字节，没有具体语义，作用与 DATA 的 Padding 一样，存在则代表 PADDING flag 被设置</li></ul><p>HEADERS 帧有以下标识 (flags):</p><ul><li>END_STREAM: bit 0 设为 1 代表当前 header 块是发送的最后一块，但是带有 END_STREAM 标识的 HEADERS 帧后面还可以跟 CONTINUATION 帧 (这里可以把 CONTINUATION 看作 HEADERS 的一部分)</li><li>END_HEADERS: bit 2 设为 1 代表 header 块结束</li><li>PADDED: bit 3 设为 1 代表 Pad 被设置，存在 Pad Length 和 Padding</li><li>PRIORITY: bit 5 设为 1 表示存在 Exclusive Flag (E), Stream Dependency, 和 Weight</li></ul><p>例子:</p><p><img src="https://src.wangriyu.wang/images/blog/http/HEADERS-Frame.png" alt="image"></p><p><img src="https://src.wangriyu.wang/images/blog/http/HEADERS-Response.png" alt="image"></p><h4 id="首部的压缩与解压缩"><a href="#首部的压缩与解压缩" class="headerlink" title="首部的压缩与解压缩"></a>首部的压缩与解压缩</h4><p>HTTP/2 里的首部字段也是一个键具有一个或多个值。这些首部字段用于 HTTP 请求和响应消息，也用于服务端推送操作。</p><p>首部列表 (Header List) 是零个或多个首部字段 (Header Field) 的集合。当通过连接传送时，首部列表通过压缩算法(即下文 HPACK) 序列化成首部块 (Header Block)。然后，序列化的首部块又被划分成一个或多个叫做首部块片段 (Header Block Fragment) 的字节序列，并通过 HEADERS、PUSH_PROMISE，或者 CONTINUATION 帧进行有效负载传送。</p><blockquote><p>Cookie 首部字段需要 HTTP 映射特殊对待，见 <a href="https://httpwg.org/specs/rfc7540.html#CompressCookie" target="_blank" rel="noopener">8.1.2.5. Compressing the Cookie Header Field</a></p></blockquote><p>一个完整的首部块有两种可能</p><ul><li>一个 HEADERS 帧或 PUSH_PROMISE 帧加上设置 END_HEADERS flag</li><li>一个未设置 END_HEADERS flag 的 HEADERS 帧或 PUSH_PROMISE 帧，加上多个 CONTINUATION 帧，其中最后一个 CONTINUATION 帧设置 END_HEADERS flag</li></ul><p>必须将首部块作为连续的帧序列传送，不能插入任何其他类型或其他流的帧。尾帧设置 END_HEADERS 标识代表首部块结束，这让首部块在逻辑上等价于一个单独的帧。接收端连接片段重组首部块，然后解压首部块重建首部列表。</p><p><img src="https://src.wangriyu.wang/images/blog/http/End-Stream.png" alt="image"></p><h4 id="SETTINGS-帧格式"><a href="#SETTINGS-帧格式" class="headerlink" title="SETTINGS 帧格式"></a>SETTINGS 帧格式</h4><p><a href="https://httpwg.org/specs/rfc7540.html#SETTINGS" target="_blank" rel="noopener">https://httpwg.org/specs/rfc7540.html#SETTINGS</a></p><p>一个 SETTINGS 帧的 payload 由零个或多个参数组成，每个参数的形式如下:</p><pre class="line-numbers language-http"><code class="language-http"> +-------------------------------+ |       Identifier (16)         | +-------------------------------+-------------------------------+ |                        Value (32)                             | +---------------------------------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>Identifier</code>: 代表参数类型，比如 SETTINGS_HEADER_TABLE_SIZE 是 0x1</li><li><code>Value</code>: 相应参数的值</li></ul><p>在建立连接开始时双方都要发送 SETTINGS 帧以表明自己期许对方应做的配置，对方接收后同意配置参数便返回带有 ACK 标识的空 SETTINGS 帧表示确认，而且连接后任意时刻任意一方也都可能再发送 SETTINGS 帧调整，SETTINGS 帧中的参数会被最新接收到的参数覆盖</p><p>SETTINGS 帧作用于整个连接，而不是某个流，而且 SETTINGS 帧的 stream identifier 必须是 0x0，否则接收方会认为错误 (PROTOCOL_ERROR)。</p><p>SETTINGS 帧包含以下参数:</p><ul><li>SETTINGS_HEADER_TABLE_SIZE (0x1): 用于解析 Header block 的 Header 压缩表的大小，初始值是 4096 字节</li><li>SETTINGS_ENABLE_PUSH (0x2): 可以关闭 Server Push，该值初始为 1，表示允许服务端推送功能</li><li>SETTINGS_MAX_CONCURRENT_STREAMS (0x3): 代表发送端允许接收端创建的最大流数目</li><li>SETTINGS_INITIAL_WINDOW_SIZE (0x4): 指明发送端所有流的流量控制窗口的初始大小，会影响所有流，该初始值是 2^16 - 1(65535) 字节，最大值是 2^31 - 1，如果超出最大值则会返回 FLOW_CONTROL_ERROR</li><li>SETTINGS_MAX_FRAME_SIZE (0x5): 指明发送端允许接收的最大帧负载的字节数，初始值是 2^14(16384) 字节，如果该值不在初始值 (2^14) 和最大值 (2^24 - 1) 之间，返回 PROTOCOL_ERROR</li><li>SETTINGS_MAX_HEADER_LIST_SIZE (0x6): 通知对端，发送端准备接收的首部列表大小的最大字节数。该值是基于未压缩的首部域大小，包括名称和值的字节长度，外加每个首部域的 32 字节的开销</li></ul><p>SETTINGS 帧有以下标识 (flags):</p><ul><li>ACK: bit 0 设为 1 代表已接收到对方的 SETTINGS 请求并同意设置，设置此标志的 SETTINGS 帧 payload 必须为空</li></ul><p>例子:</p><p><img src="https://src.wangriyu.wang/images/blog/http/SETTINGS-Frame.png" alt="image"></p><p>实际抓包会发现 HTTP2 请求创建连接发送 SETTINGS 帧初始化前还有一个 Magic 帧 (建立 HTTP/2 请求的前言)。</p><p>在 HTTP/2 中，要求两端都要发送一个连接前言，作为对所使用协议的最终确认，并确定 HTTP/2 连接的初始设置，客户端和服务端各自发送不同的连接前言。</p><p>客户端的前言内容 (对应上图中编号 23 的帧) 包含一个内容为 <code>PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n</code> 的序列加上一个可以为空的 SETTINGS 帧，在收到 101(Switching Protocols) 响应 (代表 upgrade 成功) 后发送，或者作为 TLS 连接的第一个传输的应用数据。如果在预先知道服务端支持 HTTP/2 的情况下启用 HTTP/2 连接，客户端连接前言在连接建立时发送。</p><p>服务端的前言 (对应上图中编号 26 的帧) 包含一个可以为空的 SETTINGS 帧，在建立 HTTP/2 连接后作为第一帧发送。详见 <a href="https://httpwg.org/specs/rfc7540.html#ConnectionHeader" target="_blank" rel="noopener">HTTP/2 Connection Preface</a></p><p>发送完前言后双方都得向对方发送带有 ACK 标识的 SETTINGS 帧表示确认，对应上图中编号 29 和 31 的帧。</p><p>请求站点的全部帧序列，帧后面的数字代表所属流的 id，最后以 GOAWAY 帧关闭连接:</p><p><img src="https://src.wangriyu.wang/images/blog/http/All-Frame.png" alt="image"></p><p>GOAWAY 帧带有最大的那个流标识符 (比如图中第 29 帧是最大流)，对于发送方来说会继续处理完不大于此数字的流，然后再真正关闭连接</p><h3 id="流-Stream"><a href="#流-Stream" class="headerlink" title="流 - Stream"></a>流 - Stream</h3><p>流只是一个逻辑上的概念，代表 HTTP/2 连接中在客户端和服务器之间交换的独立双向帧序列，每个帧的 Stream Identifier 字段指明了它属于哪个流。</p><p>流有以下特性:</p><ul><li>单个 h2 连接可以包含多个并发的流，两端之间可以交叉发送不同流的帧</li><li>流可以由客户端或服务器来单方面地建立和使用，或者共享</li><li>流可以由任一方关闭</li><li>帧在流上发送的顺序非常重要，最后接收方会把相同 Stream Identifier (同一个流) 的帧重新组装成完整消息报文</li></ul><h4 id="流的状态"><a href="#流的状态" class="headerlink" title="流的状态"></a>流的状态</h4><p><img src="https://src.wangriyu.wang/images/blog/http/stream-state.png" alt="image"></p><blockquote><p>注意图中的 send 和 recv 对象是指端点，不是指当前的流</p></blockquote><h5 id="idle"><a href="#idle" class="headerlink" title="idle"></a>idle</h5><p>所有流以“空闲”状态开始。在这种状态下，没有任何帧的交换</p><p>其状态转换:</p><ul><li>发送或者接收一个 HEADERS 帧会使空闲 <code>idle</code> 流变成打开 <code>open</code> 状态，其中 HEADERS 帧的 Stream Identifier 字段指明了流 id。同样的 HEADERS 帧(带有 END_STREAM )也可以使一个流立即进入 half-closed 状态。</li><li>服务端必须在一个打开 <code>open</code> 或者半关闭 (远端) <code>half-closed(remote)</code> 状态的流 (由客户端发起的) 上发送 PUSH_PROMISE 帧，其中 PUSH_PROMISE 帧的 Promised Stream ID 字段指定了一个预示的新流 (由服务端发起)，<ul><li>在服务端该新流会由空闲 <code>idle</code> 状态进入被保留的 (本地) <code>reserved(local)</code> 状态</li><li>在客户端该新流会由空闲 <code>idle</code> 状态进入被保留的 (远端) <code>reserved(remote)</code> 状态</li></ul></li></ul><blockquote><p>在 <a href="https://httpwg.org/specs/rfc7540.html#discover-http" target="_blank" rel="noopener">3.2 - Starting HTTP/2 for “http” URIs</a> 中介绍了一种特殊情况:</p><blockquote><p>客户端发起一个 HTTP/1.1 请求，请求带有 Upgrade 机制，想创建 h2c 连接，服务端同意升级返回 101 响应。<br>升级之前发送的 HTTP/1.1 请求被分配一个流标识符 0x1，并被赋予默认优先级值。从客户端到服务端这个流 1 隐式地转为 “half-closed” 状态，因为作为 HTTP/1.1 请求它已经完成了。HTTP/2 连接开始后，流 1 用于响应。详细过程可以看下文的 <a href="#HTTP-2-的协议协商机制">HTTP/2 的协议协商机制</a></p></blockquote></blockquote><p>此状态下接收到 HEADERS 和 PRIORITY 以外的帧被视为 PROTOCOL_ERROR</p><p>状态图中 <code>send PP</code> 和 <code>recv PP</code> 是指连接的双方端点发送或接收了 PUSH_PROMISE，不是指某个空闲流发送或接收了 PUSH_PROMISE，是 PUSH_PROMISE 的出现促使一个预示的流从 <code>idle</code> 状态转为 <code>reserved</code></p><blockquote><p>在下文 <a href="#Server-Push">Server-Push</a> 中会详细介绍服务端推送的内容和 PUSH_PROMISE 的使用情形</p></blockquote><h5 id="reserved-local-reserved-remote"><a href="#reserved-local-reserved-remote" class="headerlink" title="reserved (local) / reserved (remote)"></a>reserved (local) / reserved (remote)</h5><p>PUSH_PROMISE 预示的流由 <code>idle</code> 状态进入此状态，代表准备进行 Server push</p><p>其状态转换:</p><ul><li>PUSH_PROMISE 帧预示的流的响应以 HEADERS 帧开始，这会立即将该流在服务端置于半关闭 (远端) <code>half-closed(remote)</code> 状态，在客户端置于半关闭 (本地) <code>half-closed(local)</code> 状态，最后以携带 END_STREAM 的帧结束，这会将流置于关闭 <code>closed</code> 状态</li><li>任一端点都可以发送 RST_STREAM 帧来终止这个流，其状态由 <code>reserved</code> 转为 <code>closed</code></li></ul><p><code>reserved(local)</code> 状态下的流不能发送 HEADERS、RST_STREAM、PRIORITY 以外的帧，接收到 RST_STREAM、PRIORITY、WINDOW_UPDATE 以外的帧被视为 PROTOCOL_ERROR</p><p><code>reserved(remote)</code> 状态下的流不能发送 RST_STREAM、WINDOW_UPDATE、PRIORITY 以外的帧，接收到 HEADERS、RST_STREAM、PRIORITY 以外的帧被视为 PROTOCOL_ERROR</p><h5 id="open"><a href="#open" class="headerlink" title="open"></a>open</h5><p>处于 <code>open</code> 状态的流可以被两个对端用来发送任何类型的帧</p><p>其状态转换:</p><ul><li>任一端都可以发送带有 END_STREAM 标识的帧，发送方会转入 <code>half-closed(local)</code> 状态；接收方会转入 <code>half-closed(remote)</code> 状态</li><li>任一端都可以发送 RST_STREAM 帧，这会使流立即进入 <code>closed</code> 状态</li></ul><h5 id="half-closed-local"><a href="#half-closed-local" class="headerlink" title="half-closed (local)"></a>half-closed (local)</h5><p>流是双向的，半关闭表示这个流单向关闭了，local 代表本端到对端的方向关闭了，remote 代表对端到本端的方向关闭了</p><p>此状态下的流不能发送 WINDOW_UPDATE、PRIORITY、RST_STREAM 以外的帧</p><p>当此状态下的流收到带有 END_STREAM 标识的帧或者任一方发送 RST_STREAM 帧，会转为 <code>closed</code> 状态</p><p>此状态下的流收到的 PRIORITY 帧用以调整流的依赖关系顺序，可以看下文的流优先级</p><h5 id="half-closed-remote"><a href="#half-closed-remote" class="headerlink" title="half-closed (remote)"></a>half-closed (remote)</h5><p>此状态下的流不会被对端用于发送帧，执行流量控制的端点不再有义务维护接收方的流控制窗口。</p><p>一个端点在此状态的流上接收到 WINDOW_UPDATE、PRIORITY、RST_STREAM 以外的帧，应该响应一个 STREAM_CLOSED 流错误</p><p>此状态下的流可以被端点用于发送任意类型的帧，且此状态下该端点仍会观察流级别的流控制的限制</p><p>当此状态下的流发送带有 END_STREAM 标识的帧或者任一方发送 RST_STREAM 帧，会转为 <code>closed</code> 状态</p><h5 id="closed"><a href="#closed" class="headerlink" title="closed"></a>closed</h5><p>代表流已关闭</p><p>此状态下的流不能发送 PRIORITY 以外的帧，发送 PRIORITY 帧是调整那些依赖这个已关闭的流的流优先级，端点都应该处理 PRIORITY 帧，尽管如果该流从依赖关系树中移除了也可以忽略优先级帧</p><p>此状态下在收到带有 END_STREAM 标识的 DATA 或 HEADERS 帧后的一小段时间内 (period) 仍可能接收到 WINDOW_UPDATE 或 RST_STREAM 帧，因为在远程对端接收并处理 RST_STREAM 或带有 END_STREAM 标志的帧之前，它可能会发送这些类型的帧。但是端点必须忽略接收到的 WINDOW_UPDATE 或 RST_STREAM</p><p>如果一个流发送了 RST_STREAM 帧后转入此状态，而对端接收到 RST_STREAM 帧时可能已经发送了或者处在发送队列中，这些帧是不可撤销的，发送 RST_STREAM 帧的端点必须忽略这些帧。</p><p>一个端点可以限制 period 的长短，在 period 内接受的帧会忽略，超出 period 的帧被视为错误。</p><p>一个端点发送了 RST_STREAM 帧后接收到流控制帧(比如 DATA)，仍会计入流量窗口，即使这些帧会被忽略，因为对端肯定是在接收到 RST_STREAM 帧前发送的流控制帧，对端会认为流控制已生效</p><p>一个端点可能会在发送了 RST_STREAM 帧后收到 PUSH_PROMISE 帧，即便预示的流已经被重置 (reset)，PUSH_PROMISE 帧也能使预示流变成 <code>reserved</code> 状态。因此，需要 RST_STREAM 来关闭一个不想要的预示流。</p><blockquote><p>PRIORITY 帧可以被任意状态的流发送和接收，未知类型的帧会被忽略</p></blockquote><h5 id="流状态的转换"><a href="#流状态的转换" class="headerlink" title="流状态的转换"></a>流状态的转换</h5><p>下面看两个例子来理解流状态:</p><p><img src="https://src.wangriyu.wang/images/blog/http/ServerPushStreamState.png" alt="image"></p><p>(1)、Server 在 Client 发起的一个流上发送 PUSH_PROMISE 帧，其 Promised Stream ID 指定一个预示流用于后续推送，send PP 后这个预示流在服务端从 idle 状态转为 reserve(local) 状态，客户端 recv PP 后这个流从 idle 状态转为 reserve(remote) 状态</p><p>(2)(3)、此时预示流处于保留状态，客户端如果选择拒绝接受推送，可以发送 RST 帧关闭这个流；服务端如果此时出问题了也可以发送 RST 帧取消推送。不管哪一方发送或接收到 RST，此状态都转为 closed</p><p>(4)、没有出现重置说明推送仍有效，则服务端开始推送，首先发送的肯定是响应的 HEADERS 首部块，此时流状态转为半关闭 half-closed(remote)；客户端接收到 HEADERS 后流状态转为半关闭 half-closed(local)</p><p>(5)(6)、半关闭状态下的流应该还会继续推送诸如 DATA 帧、CONTINUATION 帧这样的数据帧，如果这个过程碰到任一方发起重置，则流会关闭进入 closed 状态</p><p>(7)、如果一切顺利，资源随着数据帧响应完毕，最后一帧会带上 END_STREAM 标识代表这个流结束了，此时流转为 closed 状态</p><p><img src="https://src.wangriyu.wang/images/blog/http/RequestStreamState.png" alt="image"></p><p>(1)、客户端发起请求，首先发送一个 HEADERS 帧，其 Stream Identifier 创建一个新流，此流从 idle 状态转为 open 状态</p><p>(2)(3)、如果客户端取消请求可以发送 RST 帧，服务端出错也可以发送 RST 帧，不管哪一方接收或发送 RST，流关闭进入 closed 状态；</p><p>(4)、如果请求结束(END_STREAM)，流转为半关闭状态。假如是 GET 请求，一般 HEADERS 帧就是最后一帧，send H 后流会立即进入半关闭状态。假如是 POST 请求，待数据传完，最后一帧带上 END_STREAM 标识，流转为半关闭</p><p>(5)(6)、客户端半关闭后服务端开始返回响应，此时任一方接收或发送 RST，流关闭；</p><p>(7)、如果一切顺利，等待响应结束(END_STREAM)，流关闭</p><h4 id="流的标识符"><a href="#流的标识符" class="headerlink" title="流的标识符"></a>流的标识符</h4><p>流 ID 是 31 位无符号整数，客户端发起的流必须是奇数，服务端发起的流必须是偶数，0x0 保留为连接控制消息不能用于建立新流。</p><p>HTTP/1.1 Upgrade to HTTP/2 时响应的流 ID 是 0x1，在升级完成之后，流 0x1 在客户端会转为 <code>half-closed (local)</code> 状态，因此这种情况下客户端不能用 0x1 初始化一个流</p><p>新建立的流的 ID 必须大于所有已使用过的数字，接收到一个错误大小的 ID 应该返回 PROTOCOL_ERROR 响应</p><p>使用一个新流时隐式地关闭了对端发起的 ID 小于当前流的且处于 <code>idle</code> 状态的流，比如一个流发送一个 HEADERS 帧打开了 ID 为 7 的流，但还从未向 ID 为 5 的流发送过帧，则流 0x5 会在 0x7 发送完或接收完第一帧后转为 <code>closed</code> 状态</p><p>一个连接内的流 ID 不能重用</p><h4 id="流的优先级"><a href="#流的优先级" class="headerlink" title="流的优先级"></a>流的优先级</h4><p>客户端可以通过 HEADERS 帧的 PRIORITY 信息指定一个新建立流的优先级，其他期间也可以发送 PRIORITY 帧调整流优先级</p><p>设置优先级的目的是为了让端点表达它所期望对端在并发的多个流之间如何分配资源的行为。更重要的是，当发送容量有限时，可以使用优先级来选择用于发送帧的流。</p><p>流可以被标记为依赖其他流，所依赖的流完成后再处理当前流。每个依赖 (dependency) 后都跟着一个权重 (weight)，这一数字是用来确定依赖于相同的流的可分配可用资源的相对比例</p><h5 id="流依赖-Stream-Dependencies"><a href="#流依赖-Stream-Dependencies" class="headerlink" title="流依赖(Stream Dependencies)"></a>流依赖(Stream Dependencies)</h5><p>每个流都可以显示地依赖另一个流，包含依赖关系表示优先将资源分配给指定的流(上层节点)而不是依赖流</p><p>一个不依赖于其他流的流会指定 stream dependency 为 0x0 值，因为不存在的 0x0 流代表依赖树的根</p><p>一个依赖于其他流的流叫做<strong>依赖流</strong>，被依赖的流是当前流的父级。如果被依赖的流不在当前依赖树中(比如状态为 <code>idle</code> 的流)，被依赖的流会使用一个默认优先级</p><p>当依赖一个流时，该流会添加进父级的依赖关系中，共享相同父级的依赖流不会相对于彼此进行排序，比如 B 和 C 依赖 A，新添加一个依赖流 D，BCD 的顺序是不固定的:</p><pre class="line-numbers language-http"><code class="language-http">    A                 A   / \      ==>      /|\  B   C             B D C<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>独占标识 (exclusive) 允许插入一个新层级(新的依赖关系)，独占标识导致该流成为父级的唯一依赖流，而其他依赖流变为其子级，比如同样插入一个新依赖流 E (带有 exclusive):</p><pre class="line-numbers language-http"><code class="language-http">                      A    A                 |   /|\      ==>       E  B D C              /|\                    B D C<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在依赖关系树中，只有当一个依赖流所依赖的所有流(父级最高为 0x0 的链)被关闭或者无法继续在上面执行，这个依赖流才应该被分配资源</p><h5 id="依赖权重"><a href="#依赖权重" class="headerlink" title="依赖权重"></a>依赖权重</h5><p>所有依赖流都会分配一个 1~256 权重值</p><p>相同父级的依赖流按权重比例分配资源，比如流 B 依赖于 A 且权重值为 4，流 C 依赖于 A 且权重值为 12，当 A 不再执行时，B 理论上能分配的资源只有 C 的三分之一</p><h5 id="优先级调整-Reprioritization"><a href="#优先级调整-Reprioritization" class="headerlink" title="优先级调整 (Reprioritization)"></a>优先级调整 (Reprioritization)</h5><p>使用 PRIORITY 帧可以调整流优先级</p><p>PRIORITY 帧内容与 HEADERS 帧的优先级模块相同:</p><pre class="line-numbers language-http"><code class="language-http"> +-+-------------------------------------------------------------+ |E|                  Stream Dependency (31)                     | +-+-------------+-----------------------------------------------+ |   Weight (8)  | +-+-------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>如果父级重新设置了优先级，则依赖流会随其父级流一起移动。若调整优先级的流带有独占标识，会导致新的父流的所有子级依赖于这个流</p></li><li><p>如果一个流调整为依赖自己的一个子级，则这个将被依赖的子级首先移至调整流的父级之下(即同一层)，再移动那个调整流的整棵子树，移动的依赖关系保持其权重</p></li></ul><p>看下面这个例子: 第一个图是初始关系树，现在 A 要调整为依赖 D，根据第二点，现将 D 移至 x 之下，再把 A 调整为 D 的子树(图 3)，如果 A 调整时带有独占标识根据第一点 F 也归为 A 子级(图 4)</p><pre class="line-numbers language-http"><code class="language-http">    x                x                x                 x    |               / \               |                 |    A              D   A              D                 D   / \            /   / \            / \                |  B   C     ==>  F   B   C   ==>    F   A       OR      A     / \                 |             / \             /|\    D   E                E            B   C           B C F    |                                     |             |    F                                     E             E               (intermediate)   (non-exclusive)    (exclusive)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="流优先级的状态管理"><a href="#流优先级的状态管理" class="headerlink" title="流优先级的状态管理"></a>流优先级的状态管理</h5><p>当一个流从依赖树中移除，它的子级可以调整为依赖被关闭流的父级(应该就是连接上一层节点)，新的依赖权重将根据关闭流的权重以及流自身的权重重新计算。</p><p>从依赖树中移除流会导致某些优先级信息丢失。资源在具有相同父级的流之间共享，这意味着如果这个集合中的某个流关闭或者阻塞，任何空闲容量将分配给最近的相邻流。然而，如果此集合的共有依赖(即父级节点)从树中移除，这些子流将与更上一层的流共享资源</p><p>一个例子: 流 A 和流 B 依赖相同父级节点，而流 C 和流 D 都依赖 A，在移除流 A 之前的一段时间内，A 和 D 都无法执行(可能任务阻塞了)，则 C 会分配到 A 的所有资源；<br>如果 A 被移除出树了，A 的权重按比重新计算分配给 C 和 D，此时 D 仍旧阻塞，C 分配的资源相较之前变少了。对于同等的初始权重，C 获取到的可用资源是三分之一而不是二分之一(为什么是三分之一?文档中没有说明细节，权重如何重新分配也不太清楚，下面是按我的理解解释的)</p><p>X 的资源为 1，ABCD 初始权重均为 16，*号代表节点当前不可用，图一中 C 和 B 各占一半资源，而 A 移除后 CD 的权重重新分配变为 8，所以图二中 C 和 B 占比变为 1:2，R(C) 变为 1/3</p><pre class="line-numbers language-http"><code class="language-http">          X(v:1.0)               X(v:1.0)         / \                    /|\        /   \                  / | \      *A     B       ==>      /  |  \    (w:16) (w:16)            /   |   \      / \                   C   *D    B     /   \                (w:8)(w:8)(w:16)    C    *D (w:16) (w:16) R(C)=16/(16+16)=1/2 ==>  R(C)=8/(8+16)=1/3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可能向一个流创建依赖关系的优先级信息还在传输中，那个流就已经关闭了。如果一个依赖流的依赖指向没有相关优先级信息(即父节点无效)，则这个依赖流会分配默认优先级，这可能会造成不理想的优先级，因为给流分配了不在预期的优先级。</p><p>为了避免上述问题，一个端点应该在流关闭后的一段时间内保留流的优先级调整状态信息，此状态保留时间越长，流被分配错误的或者默认的优先级可能性越低。</p><p>类似地，处于“空闲”状态的流可以被分配优先级或成为其他流的父节点。这允许在依赖关系树中创建分组节点，从而实现更灵活的优先级表达式。空闲流以默认优先级开始</p><p>流优先级状态信息的保留可能增加终端的负担，因此这种状态可以被限制。终端可能根据负荷来决定保留的额外的状态的数目；在高负荷下，可以丢弃额外的优先级状态来限制资源的任务。在极端情况下，终端甚至可以丢弃激活或者保留状态流的优先级信息。如果使用了固定的限制，终端应当至少保留跟 SETTINGS_MAX_CONCURRENT_STREAMS 设置一样大小的流状态</p><h5 id="默认优先级"><a href="#默认优先级" class="headerlink" title="默认优先级"></a>默认优先级</h5><p>所有流都是初始为非独占地依赖于流 0x0。</p><p>Pushed 流初始依赖于相关的流(见 Server-Push)。</p><p>以上两种情况，流的权重都指定为 16。</p><h3 id="Server-Push"><a href="#Server-Push" class="headerlink" title="Server-Push"></a>Server-Push</h3><h4 id="PUSH-PROMISE-帧格式"><a href="#PUSH-PROMISE-帧格式" class="headerlink" title="PUSH_PROMISE 帧格式"></a>PUSH_PROMISE 帧格式</h4><pre class="line-numbers language-http"><code class="language-http"> +---------------+ |Pad Length? (8)| +-+-------------+-----------------------------------------------+ |R|                  Promised Stream ID (31)                    | +-+-----------------------------+-------------------------------+ |                   Header Block Fragment (*)                 ... +---------------------------------------------------------------+ |                           Padding (*)                       ... +---------------------------------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>Pad Length</code>: 指定 Padding 长度，存在则代表 PADDING flag 被设置</li><li><code>R</code>: 保留的1bit位</li><li><code>Promised Stream ID</code>: 31 位的无符号整数，代表 PUSH_PROMISE 帧保留的流，对于发送者来说该流标识符必须是可用于下一个流的有效值</li><li><code>Header Block Fragment</code>: 包含请求首部域的首部块片段</li><li><code>Padding</code>: 填充字节，没有具体语义，作用与 DATA 的 Padding 一样，存在则代表 PADDING flag 被设置</li></ul><p>PUSH_PROMISE 帧有以下标识 (flags):</p><ul><li>END_HEADERS: bit 2 置 1 代表 header 块结束</li><li>PADDED: bit 3 置 1 代表 Pad 被设置，存在 Pad Length 和 Padding</li></ul><h4 id="Push-的过程"><a href="#Push-的过程" class="headerlink" title="Push 的过程"></a>Push 的过程</h4><p>结合上文关于 Server-Push 的流状态转换</p><p>PUSH_PROMISE 帧只能在对端(客户端)发起的且流状态为 open 或者 half-closed (remote) 的流上发送</p><p>PUSH_PROMISE 帧准备推送的响应总是和来自于客户端的请求相关联。服务端在该请求所在的流上发送 PUSH_PROMISE 帧。PUSH_PROMISE 帧包含一个 Promised Stream ID，该流标识符是从服务端可用的流标识符里选出来的。</p><p>如果服务端收到了一个对文档的请求，该文档包含内嵌的指向多个图片文件的链接，且服务端选择向客户端推送那些额外的图片，那么在发送包含图片链接的 DATA 帧之前发送 PUSH_PROMISE 帧可以确保客户端在发现内嵌的链接之前，能够知道有一个资源将要被推送过来。同样地，如果服务端准备推送被首部块引用的响应 (比如，在 <a href="https://www.w3.org/wiki/LinkHeader" target="_blank" rel="noopener">Link 首部字段</a> 里的)，在发送首部块之前发送一个 PUSH_PROMISE 帧，可以确保客户端不再请求那些资源</p><p>一旦客户端收到了 PUSH_PROMISE 帧，并选择接收被推送的响应，客户端就不应该为准备推送的响应发起任何请求，直到预示的流被关闭以后。</p><p><img src="https://src.wangriyu.wang/images/blog/http/PUSH_PROMISE_1.png" alt="image"></p><p><img src="https://src.wangriyu.wang/images/blog/http/PUSH_PROMISE_2.png" alt="image"></p><blockquote><p>注意图中推送的四个资源各预示了一个流 (Promised Stream ID)，而发送 PUSH_PROMISE 帧的还是在客户端发起的请求流 (Stream Identifier = 1) 上，客户端收到 PUSH_PROMISE 帧并选择接收便不会对这四个资源发起请求，之后服务端会发起预示的流然后推送资源相关的响应</p></blockquote><p>不管出于什么原因，如果客户端决定不再从服务端接收准备推送的响应，或者如果服务端花费了太长时间准备发送被预示的响应，客户端可以发送一个 RST_STREAM 帧，该帧可以使用 CANCEL 或者 REFUSED_STEAM 码，并引用被推送的流标识符。</p><h4 id="nginx-配置-Server-Push"><a href="#nginx-配置-Server-Push" class="headerlink" title="nginx 配置 Server-Push"></a>nginx 配置 Server-Push</h4><blockquote><p>server-push 需要服务端设置，并不是说浏览器发起请求，与此请求相关的资源服务端就会自动推送</p></blockquote><p>以 nginx 为例，从版本 1.13.9 开始正式支持 hppt2 serverpush 功能，</p><p>在相应 server 或 location 模块中加入 <code>http2_push</code> 字段加上相对路径的文件即可在请求该资源时推送相关资源，比如我的博客设置如下，访问首页时有四个文件会由服务器主动推送过去而不需要客户端请求:</p><pre class="line-numbers language-nginx"><code class="language-nginx">  <span class="token keyword">server_name</span>  blog<span class="token punctuation">.</span>wangriyu<span class="token punctuation">.</span>wang<span class="token punctuation">;</span>  <span class="token keyword">root</span> <span class="token operator">/</span>blog<span class="token punctuation">;</span>  <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>  <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token punctuation">{</span>    http2_push <span class="token operator">/</span>css<span class="token operator">/</span>style<span class="token punctuation">.</span>css<span class="token punctuation">;</span>    http2_push <span class="token operator">/</span>js<span class="token operator">/</span>main<span class="token punctuation">.</span>js<span class="token punctuation">;</span>    http2_push <span class="token operator">/</span>img<span class="token operator">/</span>yule<span class="token punctuation">.</span>jpg<span class="token punctuation">;</span>    http2_push <span class="token operator">/</span>img<span class="token operator">/</span>avatar<span class="token punctuation">.</span>jpg<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过浏览器控制台可以查看 <code>Push</code> 响应:</p><p><img src="https://src.wangriyu.wang/images/blog/http/server-push.png" alt="image"></p><p>也可以用 <code>nghttp</code> 测试 push 响应 (* 号代表是服务端推送的):</p><p><img src="https://src.wangriyu.wang/images/blog/http/nghttp-serverpush.png" alt="image"></p><p>上面 <code>http2_push</code> 的设置适合静态资源，服务端事先知道哪些文件是客户端需要的，然后选择性推送</p><p>假如是后台应用动态生成的文件(比如 json 文件)，服务器事先不知道要推送什么，可以用 <code>Link</code> 响应头来做自动推送</p><p>在 server 模块中添加 <code>http2_push_preload on;</code></p><pre class="line-numbers language-nginx"><code class="language-nginx">  <span class="token keyword">server_name</span>  blog<span class="token punctuation">.</span>wangriyu<span class="token punctuation">.</span>wang<span class="token punctuation">;</span>  <span class="token keyword">root</span> <span class="token operator">/</span>blog<span class="token punctuation">;</span>  <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>  http2_push_preload on<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后设置响应头 (add_header) 或者后台程序生成数据文件返回时带上响应头 Link 标签，比如</p><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token property-declaration"><span class="token property">Link</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">.</span>css<span class="token operator">></span><span class="token punctuation">;</span> as<span class="token operator">=</span>style<span class="token punctuation">;</span> rel<span class="token operator">=</span>preload<span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">/</span>main<span class="token operator">.</span>js<span class="token operator">></span><span class="token punctuation">;</span> as<span class="token operator">=</span>script<span class="token punctuation">;</span> rel<span class="token operator">=</span>preload<span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">/</span>image<span class="token operator">.</span>jpg<span class="token operator">></span><span class="token punctuation">;</span> as<span class="token operator">=</span>image<span class="token punctuation">;</span> rel<span class="token operator">=</span>preload</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>nginx 会根据 Link 响应头主动推送这些资源</p><p>更多nginx 官方介绍见 <a href="https://www.nginx.com/blog/nginx-1-13-9-http2-server-push/" target="_blank" rel="noopener">Introducing HTTP/2 Server Push with NGINX 1.13.9</a></p><h4 id="Server-Push-潜在的问题"><a href="#Server-Push-潜在的问题" class="headerlink" title="Server-Push 潜在的问题"></a>Server-Push 潜在的问题</h4><p>看了这篇文章 <a href="https://imququ.com/post/server-push-in-http2.html" target="_blank" rel="noopener">HTTP/2 中的 Server Push 讨论</a>，发现 Server-Push 有个潜在的问题</p><p>Server-Push 满足条件时便会发起推送，可是客户端已经有缓存了想发送 RST 拒收，而服务器在收到 RST 之前已经推送资源了，虽然这部分推送无效但是肯定会占用带宽</p><p>比如我上面博客关于 http2_push 的配置，我每次打开首页服务器都会推送那四个文件，而实际上浏览器知道自己有缓存使用的也是本地缓存，也就是说本地缓存未失效的期间内，服务器的 Server-Push 只是起到了占用带宽的作用</p><p>当然实际上对我的小站点来说影响并不大，但是如果网站需要大量推送的话，需要考虑并测试 Server-Push 是否会影响用户的后续访问</p><p>另外服务端可以设置 Cookie 或者 Session 记录访问时间，然后之后的访问判断是否需要 Push；还有就是客户端可以限制 PUSH 流的数目，也可以设置一个很低的流量窗口来限制 PUSH 发送的数据大小</p><p>至于哪些资源需要推送，在《web 性能权威指南》中就提到几种策略，比如 Apache 的 mod_spdy 能够识别 X-Associated-Content 首部，当中列出了希望服务器推送的资源；另外网上有人已经做了基于 Referer 首部的中间件来处理 Server-Push；或者服务端能更智能的识别文档，根据当前流量决定是否推送或者推送那些资源。相信以后会有更多关于 Server-Push 的实现和应用</p><h3 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h3><p>多路复用的流会竞争 TCP 资源，进而导致流被阻塞。流控制机制确保同一连接上的流不会相互干扰。流量控制作用于单个流或整个连接。HTTP/2 通过使用 WINDOW_UPDATE 帧来提供流量控制。</p><p>流控制具有以下特征:</p><ul><li>流量控制是特定于连接的。两种级别的流量控制都位于单跳的端点之间，而不是整个端到端的路径。比如 server 前面有一个 front-end proxy 如 Nginx，这时就会有两个 connection，browser-Nginx, Nginx—server，flow control 分别作用于两个 connection。详情见: <a href="https://stackoverflow.com/questions/40747040/how-is-http-2-hop-by-hop-flow-control-accomplished" target="_blank" rel="noopener">How is HTTP/2 hop-by-hop flow control accomplished? - stackoverflow</a></li><li>流量控制是基于 WINDOW_UPDATE 帧的。接收方公布自己打算在每个流以及整个连接上分别接收多少字节。这是一个以信用为基础的方案。</li><li>流量控制是有方向的，由接收者全面控制。接收方可以为每个流和整个连接设置任意的窗口大小。发送方必须尊重接收方设置的流量控制限制。客户方、服务端和中间代理作为接收方时都独立地公布各自的流量控制窗口，作为发送方时都遵守对端的流量控制设置。</li><li>无论是新流还是整个连接，流量控制窗口的初始值是 65535 字节。</li><li>帧的类型决定了流量控制是否适用于帧。目前，只有 DATA 帧会受流量控制影响，所有其它类型的帧并不消耗流量控制窗口的空间。这保证了重要的控制帧不会被流量控制阻塞。</li><li>流量控制不能被禁用。</li><li>HTTP/2 只定义了 WINDOW_UPDATE 帧的格式和语义，并没有规定接收方如何决定何时发送帧、发送什么样的值，也没有规定发送方如何选择发送包。具体实现可以选择任何满足需求的算法。</li></ul><h4 id="WINDOW-UPDATE-帧格式"><a href="#WINDOW-UPDATE-帧格式" class="headerlink" title="WINDOW_UPDATE 帧格式"></a>WINDOW_UPDATE 帧格式</h4><pre class="line-numbers language-http"><code class="language-http">+-+-------------------------------------------------------------+|R|                Window Size Increment (31)                   |+-+-------------------------------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Window Size Increment 表示除了现有的流量控制窗口之外，发送端还可以传送的字节数。取值范围是 1 到 2^31 - 1 字节。</p><p>WINDOW_UPDATE 帧可以是针对一个流或者是针对整个连接的。如果是前者，WINDOW_UPDATE 帧的流标识符指明了受影响的流；如果是后者，流标识符为 0 表示作用于整个连接。</p><p>流量控制功能只适用于被标识的、受流量控制影响的帧。文档定义的帧类型中，只有 DATA 帧受流量控制影响。除非接收端不能再分配资源去处理这些帧，否则不受流量控制影响的帧必须被接收并处理。如果接收端不能再接收帧了，可以响应一个 FLOW_CONTROL_ERROR 类型的流错误或者连接错误。</p><p>WINDOW_UPDATE 可以由发送过带有 END_STREAM 标志的帧的对端发送。这意味着接收端可能会在 half-closed (remote) 或者 closed 状态的流上收到 WINDOW_UPDATE 帧，接收端不能将其当做错误。</p><h4 id="流量控制窗口"><a href="#流量控制窗口" class="headerlink" title="流量控制窗口"></a>流量控制窗口</h4><p>流量控制窗口是一个简单的整数值，指出了准许发送端传送的数据的字节数。窗口值衡量了接收端的缓存能力。</p><p>除非将其当做连接错误，否则当接收端收到 DATA 帧时，必须总是从流量控制窗口中减掉其长度(不包括帧头的长度，而且两个级别的控制窗口都要减)。即使帧有错误，这也是有必要的，因为发送端已经将该帧计入流量控制窗口，如果接收端没有这样做，发送端和接收端的流量控制窗口就会不一致。</p><p>发送端不能发送受流量控制影响的、其长度超出接收端告知的两种级别的流量控制窗口可用空间的帧。即使这两种级别的流量控制窗口都没有可用空间了，也可以发送长度为 0、设置了 END_STREAM 标志的帧(即空的 DATA 帧)。</p><p>当帧的接收端消耗了数据并释放了流量控制窗口的空间时，可以发送一个 WINDOW_UPDATE 帧。对于流级别和连接级别的流量控制窗口，需要分别发送 WINDOW_UPDATE 帧。</p><p>新建连接时，流和连接的初始窗口大小都是 2^16 - 1(65535) 字节。可以通过设置连接前言中 SETTINGS 帧的 SETTINGS_INITIAL_WINDOW_SIZE 参数改变流的初始窗口大小，这会作用于所有流。而<code>连接的初始窗口大小不能改，但可以用 WINDOW_UPDATE 帧来改变流量控制窗口</code>，这是为什么连接前言往往带有一个 WINDOW_UPDATE 帧的原因。</p><p>除了改变还未激活的流的流量控制窗口外，SETTIGNS 帧还可以改变已活跃的流 (处于 open 或 half-closed (remote) 状态的流)的初始流量控制窗口的大小。也就是说，当 SETTINGS_INITIAL_WINDOW_SIZE 的值变化时，接收端必须调整它所维护的所有流的流量控制窗口的值，不管是之前就打开的流还是尚未打开的流。</p><p>改变 SETTINGS_INITIAL_WINDOW_SIZE 可能引发流量控制窗口的可用空间变成负值。发送端必须追踪负的流量控制窗口，并且直到它收到了使流量控制窗口变成正值的 WINDOW_UPDATE 帧，才能发送新的 DATA 帧。</p><p>例如，如果连接一建立客户端就立即发送 60KB 的数据，而服务端却将初始窗口大小设置为 16KB，那么客户端一收到 SETTINGS 帧，就会将可用的流量控制窗口重新计算为 -44KB。客户端保持负的流量控制窗口，直到 WINDOW_UPDATE 帧将窗口值恢复为正值，客户端才可以继续发送数据。</p><p>如果改变 SETTINGS_INITIAL_WINDOW_SIZE 导致流量控制窗口超出了最大值，一端必须 将其当做类型为 FLOW_CONTROL_ERROR 的连接错误</p><p>如果接收端希望使用比当前值小的流量控制窗口，可以发送一个新的 SETTINGS 帧。但是，接收端必须准备好接收超出该窗口值的数据，因为可能在收到 SETTIGNS 帧之前，发送端已经发送了超出该较小窗口值的数据。</p><h4 id="合理使用流控制"><a href="#合理使用流控制" class="headerlink" title="合理使用流控制"></a>合理使用流控制</h4><p>流量控制的定义是用来保护端点在资源约束条件下的操作。例如，一个代理需要在很多连接之间共享内存，也有可能有缓慢的上游连接和快速的下游连接。流量控制解决了接收方无法在一个流上处理数据，但仍希望继续处理同一连接中的其他流的情况。</p><p>不需要此功能的部署可以通告最大大小 (2^31 - 1) 的流量控制窗口，并且可以通过在收到任何数据时发送 WINDOW_UPDATE 帧来维护此窗口大小保持不变。这可以有效禁用接受方的流控制。相反地，发送方总是受控于接收方通告的流控制窗口的限制。</p><p>资源约束下(例如内存)的调度可以使用流量来限制一个对端可以消耗的内存量。需要注意的是如果在不知道带宽延迟积的时候启用流量控制可能导致无法最优的利用可用的网络资源 (RFC1323)。</p><p>即便是对当前的网络延迟乘积有充分的认识，流量控制的实现也可能很复杂。当使用流量控制时，接收端必须及时地从 TCP 接收缓冲区读取数据。这样做可能导致在一些例如 WINDOW_UPDATE 的关键帧在 HTTP/2 不可用时导致死锁。但是流量控制可以保证约束资源能在不需要减少连接利用的情况下得到保护。</p><h3 id="HTTP-2-的协议协商机制"><a href="#HTTP-2-的协议协商机制" class="headerlink" title="HTTP/2 的协议协商机制"></a>HTTP/2 的协议协商机制</h3><h4 id="非加密下的协商-h2c"><a href="#非加密下的协商-h2c" class="headerlink" title="非加密下的协商 - h2c"></a>非加密下的协商 - h2c</h4><p>客户端使用 HTTP Upgrade 机制请求升级，HTTP2-Settings 首部字段是一个专用于连接的首部字段，它包含管理 HTTP/2 连接的参数(使用 Base64 编码)，其前提是假设服务端会接受升级请求</p><pre class="line-numbers language-http"><code class="language-http"> GET / HTTP/1.1 Host: server.example.com Connection: Upgrade, HTTP2-Settings Upgrade: h2c HTTP2-Settings: &lt;base64url encoding of HTTP/2 SETTINGS payload><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>服务器如果支持 http/2 并同意升级，则转换协议，否则忽略</p><pre class="line-numbers language-http"><code class="language-http"><span class="token response-status">HTTP/1.1 <span class="token property">101 Switching Protocols</span></span><span class="token header-name keyword">Connection:</span> Upgrade<span class="token header-name keyword">Upgrade:</span> h2c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>此时潜在的存在一个流 0x1，客户端上这个流在完成 h1 请求后便转为 <code>half-closed</code> 状态，服务端会用这个流返回响应</p><p><img src="https://src.wangriyu.wang/images/blog/http/h1-&gt;h2-1.png" alt="image"></p><p><img src="https://src.wangriyu.wang/images/blog/http/h1-&gt;h2-2.png" alt="image"></p><p><img src="https://src.wangriyu.wang/images/blog/http/h1-&gt;h2-3.png" alt="image"></p><p>注意图中第一个响应所在的流是 0x1，与上文所说的一致</p><p>目前浏览器只支持 TLS 加密下的 HTTP/2 通信，所以上述情况在浏览器中目前是不可能碰到的，图中显示的是 nghttp 客户端发起的请求</p><h4 id="加密的协商机制-h2"><a href="#加密的协商机制-h2" class="headerlink" title="加密的协商机制 - h2"></a>加密的协商机制 - h2</h4><p>TLS 加密中在 Client-Hello 和 Server-Hello 的过程中通过 <a href="https://zh.wikipedia.org/wiki/%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AE%E5%8D%8F%E5%95%86" target="_blank" rel="noopener">ALPN</a> 进行协议协商</p><p><img src="https://src.wangriyu.wang/images/blog/http/application_layer_protocol_negotiation_1.png" alt="image"></p><p>应用层协议协商在 TLS 握手第一步的扩展中，Client Hello 中客户端指定 ALPN Next Protocol 为 h2 或者 http/1.1 说明客户端支持的协议</p><p><img src="https://src.wangriyu.wang/images/blog/http/application_layer_protocol_negotiation_2.png" alt="image"></p><p>服务端如果在 Server Hello 中选择 h2 扩展，说明协商协议为 h2，后续请求响应跟着变化；如果服务端未设置 http/2 或者不支持 h2，则继续用 http/1.1 通信</p><h3 id="分析实例"><a href="#分析实例" class="headerlink" title="分析实例"></a>分析实例</h3><p><img src="https://src.wangriyu.wang/images/blog/http/all-frames.png" alt="image"></p><p>196: TLS 握手第一步 Client Hello，开始协议协商，且此处带上了 Session Ticket</p><p>200: Server Hello 同意使用 h2，而且客户端的会话票证有效，恢复会话，握手成功</p><p>202: 客户端也恢复会话，开始加密后续消息</p><p>205: 服务端发起一个连接前言 (SETTINGS)，SETTINGS 帧中设置了最大并行流数量、初始窗口大小、最大帧长度，然后 (WINDOW_UPDATE) 扩大窗口大小</p><p>310: 客户端也发送一个连接前言 Magic，并初始化设置 (SETTINGS)，SETTINGS 帧中设置了 HEADER TABLE 大小、初始窗口大小、最大并行流数量，然后 (WINDOW_UPDATE) 扩大窗口大小</p><p>311: 客户端发送完连接前言后可以立即跟上一个请求，GET / (HEADERS[1])，而且这个 HEADERS 帧还带有 END_STREAM，这会使流 1 从 idle 状态立即转为 half-closed(local) 状态 (open 是中间态)</p><p><img src="https://src.wangriyu.wang/images/blog/http/all-frames-1.png" alt="image"></p><p>311: 此消息中还包含一个客户端发送给服务端的带 ACK 的 SETTINGS 帧</p><p>312: 服务端也响应带 ACK 的 SETTINGS 帧</p><p>321: 服务端在流 1 (此时状态为 half-closed(remote)) 上发送了四个 PUSH_PROMISE 帧，它们分别保留了流 2、4、6、8 用于后续推送，</p><p><img src="https://src.wangriyu.wang/images/blog/http/all-frames-2.png" alt="image"></p><p>321: 此消息中还返回了上面请求的响应 (HEADERS - DATA)，最后 DATA 带上 END_STREAM，流 1 从 half-closed 转为 closed</p><p>329: 调整流优先级，依赖关系: 8 -&gt; 6 -&gt; 4 -&gt; 2 -&gt; 1 (都带有独占标志，而且权重均为 110)</p><p><img src="https://src.wangriyu.wang/images/blog/http/priority-1.png" alt="image"></p><p>342: 流 1 关闭后，流 2 得到分配资源，服务器开始推送，数据由两个 DATA 帧返回</p><p>344: 流 2 结束，开始推送流 4</p><p>356: 调整依赖关系</p><p><img src="https://src.wangriyu.wang/images/blog/http/priority-2.png" alt="image"></p><pre class="line-numbers language-http"><code class="language-http">  1         1         1         1(w: 110)  |         |         |         |  2         2         2         2(w: 110)  |         |         |         |  4   ==>   4   ==>   6   ==>   6(w: 147)  |         |         |         |  6         8         4         8(w: 147)  |         |         |         |  8         6         8         4(w: 110)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>367、369、372: 推送 6 和 8 的流数据</p><p>377: 发起一个请求，打开流 3，其中客户端发起的请求都是依赖流 0x0</p><p>之后都是同样的套路完成请求 - 响应，最后以 GOAWAY 帧关闭连接结束</p><h3 id="HPACK-算法"><a href="#HPACK-算法" class="headerlink" title="HPACK 算法"></a>HPACK 算法</h3><p><img src="https://src.wangriyu.wang/images/blog/http/hpack.png" alt="image"></p><p>上图来自 Ilya Grigorik 的 PPT - <a href="#references">HTTP/2 is here, let’s optimize!</a></p><p>可以清楚地看到 HTTP2 头部使用的也是键值对形式的值，而且 HTTP1 当中的请求行以及状态行也被分割成键值对，还有所有键都是小写，不同于 HTTP1。除此之外，还有一个包含静态索引表和动态索引表的索引空间，实际传输时会把头部键值表压缩，使用的算法即 HPACK，其原理就是匹配当前连接存在的索引空间，若某个键值已存在，则用相应的索引代替首部条目，比如 “:method: GET” 可以匹配到静态索引中的 index 2，传输时只需要传输一个包含 2 的字节即可；若索引空间中不存在，则用字符编码传输，字符编码可以选择哈夫曼编码，然后分情况判断是否需要存入动态索引表中</p><h4 id="索引表"><a href="#索引表" class="headerlink" title="索引表"></a>索引表</h4><h5 id="静态索引"><a href="#静态索引" class="headerlink" title="静态索引"></a>静态索引</h5><p>静态索引表是固定的，对于客户端服务端都一样，目前协议商定的静态索引包含 61 个键值，详见 <a href="https://httpwg.org/specs/rfc7541.html#static.table.definition" target="_blank" rel="noopener">Static Table Definition - RFC 7541</a></p><p>比如前几个如下</p><table><thead><tr><th style="text-align:left">索引</th><th style="text-align:left">字段值</th><th style="text-align:left">键值</th></tr></thead><tbody><tr><td style="text-align:left">index</td><td style="text-align:left">Header Name</td><td style="text-align:left">Header Value</td></tr><tr><td style="text-align:left">1</td><td style="text-align:left">:authority</td></tr><tr><td style="text-align:left">2</td><td style="text-align:left">:method</td><td style="text-align:left">GET</td></tr><tr><td style="text-align:left">3</td><td style="text-align:left">:method</td><td style="text-align:left">POST</td></tr><tr><td style="text-align:left">4</td><td style="text-align:left">:path</td><td style="text-align:left">/</td></tr><tr><td style="text-align:left">5</td><td style="text-align:left">:path</td><td style="text-align:left">/index.html</td></tr><tr><td style="text-align:left">6</td><td style="text-align:left">:scheme</td><td style="text-align:left">http</td></tr><tr><td style="text-align:left">7</td><td style="text-align:left">:scheme</td><td style="text-align:left">https</td></tr><tr><td style="text-align:left">8</td><td style="text-align:left">:status</td><td style="text-align:left">200</td></tr></tbody></table><h5 id="动态索引"><a href="#动态索引" class="headerlink" title="动态索引"></a>动态索引</h5><p>动态索引表是一个 FIFO 队列维护的有空间限制的表，里面含有非静态表的索引。<br>动态索引表是需要连接双方维护的，其内容基于连接上下文，一个 HTTP2 连接有且仅有一份动态表。<br>当一个首部匹配不到索引时，可以选择把它插入动态索引表中，下次同名的值就可能会在表中查到索引并替换。<br>但是并非所有首部键值都会存入动态索引，因为动态索引表是有空间限制的，最大值由 SETTING 帧中的 SETTINGS_HEADER_TABLE_SIZE (默认 4096 字节) 设置</p><ul><li>如何计算动态索引表的大小 (Table Size):</li></ul><p>大小均以字节为单位，动态索引表的大小等于所有条目大小之和，每个条目的大小 = 字段长度 + 键值长度 + 32</p><blockquote><p>这个额外的 32 字节是预估的条目开销，比如一个条目使用了两个 64-bit 指针分别指向字段和键值，并使用两个 64-bit 整数来记录字段和键值的引用次数</p><p>golang 实现也是加上了 32: <a href="https://github.com/golang/net/blob/db08ff08e8622530d9ed3a0e8ac279f6d4c02196/http2/hpack/hpack.go#L61" target="_blank" rel="noopener">golang.org/x/net/http2/hpack/hpack.go#L61</a></p></blockquote><p>SETTING 帧规定了动态表的最大大小，但编码器可以另外选择一个比 SETTINGS_HEADER_TABLE_SIZE 小的值作为动态表的有效负载量</p><ul><li>如何更新动态索引表的最大容量</li></ul><p>修改最大动态表容量可以发送一个 <code>dynamic table size update</code> 信号来更改:</p><pre class="line-numbers language-http"><code class="language-http">+---+---+---+---+---+---+---+---+| 0 | 0 | 1 |   Max size (5+)   |+---+---------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>前缀 001 代表此字节为 <code>dynamic table size update</code> 信号，后面使用 <strong>N=5 的整数编码方法</strong>表示新的最大动态表容量(不能超过 SETTINGS_HEADER_TABLE_SIZE)，其计算方法下文会介绍。</p><p>需要注意的是这个信号必须在首部块发送之前或者两个首部块传输的间隔发送，可以通过发送一个 Max size 为 0 的更新信号来清空现有动态表</p><ul><li>动态索引表什么时候需要驱逐条目</li></ul><ol><li>每当出现表大小更新的信号时，需要判断并驱逐队尾的条目，即旧的索引，直到当前大小小于等于新的容量</li><li>每当插入新条目时，需要判断并驱逐队尾的条目，直到当前大小小于等于容量。这个情形下插入一个比 Max size 还大的新条目不会视作错误，但其结果是会清空动态索引表</li></ol><blockquote><p>关于动态索引表如何管理的，推荐看下 golang 的实现: <a href="https://github.com/golang/net/blob/db08ff08e8622530d9ed3a0e8ac279f6d4c02196/http2/hpack/hpack.go#L157" target="_blank" rel="noopener">golang.org/x/net/http2/hpack/hpack.go#L157</a>，通过代码能更明白这个过程</p></blockquote><h5 id="索引地址空间"><a href="#索引地址空间" class="headerlink" title="索引地址空间"></a>索引地址空间</h5><p>由静态索引表和动态索引表可以组成一个索引地址空间:</p><pre class="line-numbers language-http"><code class="language-http">  &lt;----------  Index Address Space ---------->  &lt;-- Static  Table -->  &lt;-- Dynamic Table -->  +---+-----------+---+  +---+-----------+---+  | 1 |    ...    | s |  |s+1|    ...    |s+k|  +---+-----------+---+  +---+-----------+---+                         ⍋                   |                         |                   ⍒                  Insertion Point      Dropping Point<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>目前 s 就是 61，而有新键值要插入动态索引表时，从 index 62 开始插入队列，所以动态索引表中索引从小到大依次存着从新到旧的键值</p><h4 id="编码类型表示"><a href="#编码类型表示" class="headerlink" title="编码类型表示"></a>编码类型表示</h4><p>HPACK 编码使用两种原始类型: 无符号可变长度整数和八位字节表示的字符串，相应地规定了以下两种编码方式</p><h5 id="整数编码"><a href="#整数编码" class="headerlink" title="整数编码"></a>整数编码</h5><p>一个整数编码可以用于表示字段索引值、首部条目索引值或者字符串长度。<br>一个整数编码含两部分: 一个前缀字节和可选的后跟字节序列，只有前缀字节不足以表达整数值时才需要后跟字节，<strong>前缀字节中可用比特位 N 是整数编码的一个参数</strong></p><p>比如下面所示的是一个 N=5 的整数编码(前三比特用于其他标识)，如果我们要编码的整数值小于 2^N - 1，直接用一个前缀字节表示即可，比如 10 就用 <code>???01010</code> 表示</p><pre class="line-numbers language-http"><code class="language-http">+---+---+---+---+---+---+---+---+| ? | ? | ? |       Value       |+---+---+---+-------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果要编码的整数值 X 大于等于 2^N - 1，前缀字节的可用比特位都设成 1，然后把 X 减去 2^N - 1 得到值 R，并用一个或多个字节序列表示 R，字节序列中每个字节的最高有效位 (msb) 用于表示是否结束，<strong>msb 设为 0 时代表是最后一个字节</strong>。具体编码看下面的伪代码和例子</p><pre class="line-numbers language-http"><code class="language-http">+---+---+---+---+---+---+---+---+| ? | ? | ? | 1   1   1   1   1 |+---+---+---+-------------------+| 1 |    Value-(2^N-1) LSB      |+---+---------------------------+               ...+---+---------------------------+| 0 |    Value-(2^N-1) MSB      |+---+---------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编码:</p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">if</span> I <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token operator">^</span>N <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> encode I on N bits<span class="token keyword">else</span>    <span class="token function">encode</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">^</span>N <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> on N bits    I <span class="token operator">=</span> I <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">^</span>N <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>    while I <span class="token operator">>=</span> <span class="token number">128</span>         <span class="token function">encode</span> <span class="token punctuation">(</span>I <span class="token operator">%</span> <span class="token number">128</span> <span class="token operator">+</span> <span class="token number">128</span><span class="token punctuation">)</span> on <span class="token number">8</span> bits         I <span class="token operator">=</span> I <span class="token operator">/</span> <span class="token number">128</span>    encode I on <span class="token number">8</span> bits<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>解码:</p><pre class="line-numbers language-go"><code class="language-go">decode I from the next N bits<span class="token keyword">if</span> I <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token operator">^</span>N <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">return</span> I<span class="token keyword">else</span>    M <span class="token operator">=</span> <span class="token number">0</span>    repeat        B <span class="token operator">=</span> next octet        I <span class="token operator">=</span> I <span class="token operator">+</span> <span class="token punctuation">(</span>B <span class="token operator">&amp;</span> <span class="token number">127</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">^</span>M        M <span class="token operator">=</span> M <span class="token operator">+</span> <span class="token number">7</span>    while B <span class="token operator">&amp;</span> <span class="token number">128</span> <span class="token operator">==</span> <span class="token number">128</span>    <span class="token keyword">return</span> I<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>比如使用 N=5 的整数编码表示 1337:</p><p>1337 大于 31 (2^5 - 1), 将前缀字节后五位填满 1</p><p>I = 1337 - (2^5 - 1) = 1306</p><p>I 仍然大于 128, I % 128 = 26, 26 + 128 = 154</p><p>154 二进制编码: 10011010, 这即是第一个后跟字节</p><p>I = 1306 / 128 = 10, I 小于 128, 循环结束</p><p>将 I 编码成二进制: 00001010, 这即是最后一个字节</p><pre class="line-numbers language-http"><code class="language-http">+---+---+---+---+---+---+---+---+| X | X | X | 1 | 1 | 1 | 1 | 1 |  Prefix = 31, I = 1306| 1 | 0 | 0 | 1 | 1 | 0 | 1 | 0 |  1306 >= 128, encode(154), I=1306/128=10| 0 | 0 | 0 | 0 | 1 | 0 | 1 | 0 |  10 &lt; 128, encode(10), done+---+---+---+---+---+---+---+---+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>解码时读取第一个字节，发现后五位 (11111) 对应的值 I 等于 31(&gt;= 2^N - 1)，说明还有后跟字节；令 M=0，继续读下一个字节 B，I = I + (B &amp; 127) * 2^M = 31 + 26 * 1 = 57，M = M + 7 = 7，最高有效位为 1，表示字节序列未结束，B 指向下一个字节；I = I + (B &amp; 127) * 2^M = 57 + 10 * 128 = 1337，最高有效位为 0，表示字节码结束，返回 I</p><blockquote><p>这里也可以这样处理 1306: 1306 = 0x51a = (0101 0001 1010)B，将 bit 序列从低到高按 7 个一组分组，则有第一组 001 1010，第二组 000 1010，加上最高有效位 0/1 便与上面的后跟字节对应</p></blockquote><h5 id="字符编码"><a href="#字符编码" class="headerlink" title="字符编码"></a>字符编码</h5><p>一个字符串可能代表 Header 条目的字段或者键值。字符编码使用字节序列表示，要么直接使用字符的八位字节码要么使用哈夫曼编码。</p><pre class="line-numbers language-http"><code class="language-http">+---+---+---+---+---+---+---+---+| H |    String Length (7+)     |+---+---------------------------+|  String Data (Length octets)  |+-------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>H: 一个比特位表示是否使用哈夫曼编码</li><li>String Length: 代表字节序列长度，即 String Data 的长度，使用 N=7 的整数编码方式表示</li><li>String Data: 字符串的八位字节码序列表示，如果 H 为 0，则此处就是原字符的八位字节码表示；如果 H 为 1，则此处为原字符的哈夫曼编码</li></ul><p>RFC 7541 给出了一份字符的哈夫曼编码表: <a href="https://httpwg.org/specs/rfc7541.html#huffman.code" target="_blank" rel="noopener">Huffman Code</a>，这是基于大量 HTTP 首部数据生成的哈夫曼编码。</p><ul><li>当中第一列 (sym) 表示要编码的字符，最后的特殊字符 “EOS” 代表字符串结束</li><li>第二列 (code as bits) 是二进制哈夫曼编码，向最高有效位对齐</li><li>第三列 (code as hex) 是十六进制哈夫曼编码，向最低有效位对齐</li><li>最后一列 (len) 代表编码长度，单位 bit</li></ul><p>使用哈夫曼编码可能存在编码不是整字节的，会在后面填充 1 使其变成整字节</p><p>比如下面的例子:</p><p><img src="https://src.wangriyu.wang/images/blog/http/Literal-Header-Field-with-Incremental-Indexing-IndexedName.png" alt="Literal Header Field with Incremental Indexing - Indexed Name"></p><p><code>:authority: blog.wangriyu.wang</code> 首部对应的编码为:</p><pre class="line-numbers language-http"><code class="language-http">41 8e 8e 83 cc bf 81 d5    35 86 f5 6a fe 07 54 df<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>Literal Header Field with Incremental Indexing — Indexed Name</code> 的编码格式见下文</p><p>41 (0100 0001) 表示字段存在索引值 1，即对应静态表中第一项 :authority</p><p>8e (1000 1110) 最高有效位为 1 表示键值使用哈夫曼编码，000 1110 表示字节序列长度为 14</p><p>后面 <code>8e 83 cc bf 81 d5 35 86 f5 6a fe 07 54 df</code> 是一段哈夫曼编码序列</p><p>由哈夫曼编码表可知 100011 -&gt; ‘b’, 101000 -&gt; ‘l’, 00111 -&gt; ‘o’, 100110 -&gt; ‘g’, 010111 -&gt; ‘.’, 1111000 -&gt; ‘w’, 00011 -&gt; ‘a’, 101010 -&gt; ‘n’, 100110 -&gt; ‘g’, 101100 -&gt; ‘r’, 00110 -&gt; ‘i’, 1111010 -&gt; ‘y’, 101101 -&gt; ‘u’</p><pre class="line-numbers language-http"><code class="language-http">8e 83 cc bf 81 d5 35 86 f5 6a fe 07 54 df                         |                         ⍒1000 1110 1000 0011 1100 1100 1011 1111 1000 0001 1101 0101 0011 0101 1000 0110 1111 0101 0110 1010 1111 1110 0000 0111 0101 0100 1101 1111                         |                         ⍒100011 101000 00111 100110 010111 1111000 00011 101010 100110 101100 00110 1111010 101101 010111 1111000 00011 101010 100110 11111                         |                         ⍒blog.wangriyu.wang  最后 11111 用于填充<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="二进制编码"><a href="#二进制编码" class="headerlink" title="二进制编码"></a>二进制编码</h4><p>现在开始是 HPACK 真正的编解码规范</p><h5 id="已索引首部条目表示-Indexed-Header-Field-Representation"><a href="#已索引首部条目表示-Indexed-Header-Field-Representation" class="headerlink" title="已索引首部条目表示 (Indexed Header Field Representation)"></a>已索引首部条目表示 (Indexed Header Field Representation)</h5><ul><li><code>Indexed Header Field</code></li></ul><p>以 1 开始为标识，能在索引空间匹配到索引的首部会替换成这种形式，后面的 index 使用上述的整数编码方式且 N = 7。<br>比如 <code>:method: GET</code> 可以用 0x82，即 10000010 表示</p><pre class="line-numbers language-http"><code class="language-http">+---+---+---+---+---+---+---+---+| 1 |        Index (7+)         |+---+---------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://src.wangriyu.wang/images/blog/http/Indexed-Header-Field.png" alt="Indexed Header Field"></p><h5 id="未索引文字首部条目表示-Literal-Header-Field-Representation"><a href="#未索引文字首部条目表示-Literal-Header-Field-Representation" class="headerlink" title="未索引文字首部条目表示 (Literal Header Field Representation)"></a>未索引文字首部条目表示 (Literal Header Field Representation)</h5><p>尚未被索引的首部有三种表示形式，第一种会添加进索引，第二种对于当前跳来说不会添加进索引，第三种绝对不被允许添加进索引</p><ol><li>会添加索引的文字首部 (Literal Header Field with Incremental Indexing)</li></ol><p>以 01 开始为标识，此首部会加入到解码后的首部列表 (Header List) 中并且会把它<strong>作为新条目插入到动态索引表中</strong></p><ul><li><code>Literal Header Field with Incremental Indexing — Indexed Name</code></li></ul><p>如果字段已经存在索引，但键值未被索引，比如首部 <code>:authority: blog.wangriyu.wang</code> 的字段 <code>:authority</code> 已存在索引但键值 <code>blog.wangriyu.wang</code> 不存在索引，则会替换成如下形式 (index 使用 N=6 的整数编码表示)</p><pre class="line-numbers language-http"><code class="language-http">+---+---+---+---+---+---+---+---+| 0 | 1 |      Index (6+)       |+---+---+-----------------------+| H |     Value Length (7+)     |+---+---------------------------+| Value String (Length octets)  |+-------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://src.wangriyu.wang/images/blog/http/Literal-Header-Field-with-Incremental-Indexing-IndexedName.png" alt="Literal Header Field with Incremental Indexing - Indexed Name"></p><ul><li><code>Literal Header Field with Incremental Indexing — New Name</code></li></ul><p>如果字段和键值均未被索引，比如 <code>upgrade-insecure-requests: 1</code>，则会替换成如下形式</p><pre class="line-numbers language-http"><code class="language-http">+---+---+---+---+---+---+---+---+| 0 | 1 |           0           |+---+---+-----------------------+| H |     Name Length (7+)      |+---+---------------------------+|  Name String (Length octets)  |+---+---------------------------+| H |     Value Length (7+)     |+---+---------------------------+| Value String (Length octets)  |+-------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://src.wangriyu.wang/images/blog/http/Literal-Header-Field-with-Incremental-Indexing-NewName.png" alt="Literal Header Field with Incremental Indexing — New Name"></p><ol start="2"><li>不添加索引的首部 (Literal Header Field without Indexing)</li></ol><p>以 0000 开始为标识，此首部会加入到解码后的首部列表中，但<strong>不会插入到动态索引表中</strong></p><ul><li><code>Literal Header Field without Indexing — Indexed Name</code></li></ul><p>如果字段已经存在索引，但键值未被索引，则会替换成如下形式 (index 使用 N=4 的整数编码表示)</p><pre class="line-numbers language-http"><code class="language-http">+---+---+---+---+---+---+---+---+| 0 | 0 | 0 | 0 |  Index (4+)   |+---+---+-----------------------+| H |     Value Length (7+)     |+---+---------------------------+| Value String (Length octets)  |+-------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://src.wangriyu.wang/images/blog/http/Literal-Header-Field-without-Indexing-IndexedName.png" alt="Literal Header Field without Indexing - Indexed Name"></p><ul><li><code>Literal Header Field without Indexing — New Name</code></li></ul><p>如果字段和键值均未被索引，则会替换成如下形式。比如 <code>strict-transport-security: max-age=63072000; includeSubdomains</code></p><pre class="line-numbers language-http"><code class="language-http">+---+---+---+---+---+---+---+---+| 0 | 0 | 0 | 0 |       0       |+---+---+-----------------------+| H |     Name Length (7+)      |+---+---------------------------+|  Name String (Length octets)  |+---+---------------------------+| H |     Value Length (7+)     |+---+---------------------------+| Value String (Length octets)  |+-------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://src.wangriyu.wang/images/blog/http/Literal-Header-Field-without-Indexing-NewName.png" alt="Literal Header Field without Indexing - New Name"></p><ol start="3"><li>绝对不添加索引的首部 (Literal Header Field Never Indexed)</li></ol><p>这与上一种首部类似，只是标识为 0001，首部也是会添加进解码后的首部列表中但不会插入动态更新表。</p><p>区别在于这类首部发出是什么格式表示，接收也是一样的格式，作用于每一跳 (hop)，如果中间通过代理，代理必须原样转发不能另行编码。</p><p>而上一种首部只是作用当前跳，通过代理后可能会被重新编码</p><p>golang 实现中使用一个 <code>Sensitive</code> 标明哪些字段是绝对不添加索引的: <a href="https://github.com/golang/net/blob/db08ff08e8622530d9ed3a0e8ac279f6d4c02196/http2/hpack/hpack.go#L41" target="_blank" rel="noopener">golang.org/x/net/http2/hpack/hpack.go#L41</a></p><p>RFC 文档中详细说明了这么做的原因: <a href="https://httpwg.org/specs/rfc7541.html#never.indexed.literals" target="_blank" rel="noopener">Never-Indexed Literals</a></p><p>表示形式除了标识其他都跟上一种首部一样:</p><ul><li><code>Literal Header Field Never Indexed — Indexed Name</code></li></ul><pre class="line-numbers language-http"><code class="language-http">+---+---+---+---+---+---+---+---+| 0 | 0 | 0 | 1 |  Index (4+)   |+---+---+-----------------------+| H |     Value Length (7+)     |+---+---------------------------+| Value String (Length octets)  |+-------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>Literal Header Field Never Indexed — New Name</code></li></ul><pre class="line-numbers language-http"><code class="language-http">+---+---+---+---+---+---+---+---+| 0 | 0 | 0 | 1 |       0       |+---+---+-----------------------+| H |     Name Length (7+)      |+---+---------------------------+|  Name String (Length octets)  |+---+---------------------------+| H |     Value Length (7+)     |+---+---------------------------+| Value String (Length octets)  |+-------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="动态表最大容量更新-Dynamic-Table-Size-Update"><a href="#动态表最大容量更新-Dynamic-Table-Size-Update" class="headerlink" title="动态表最大容量更新 (Dynamic Table Size Update)"></a>动态表最大容量更新 (Dynamic Table Size Update)</h5><p>以 001 开始为标识，作用前面已经提过</p><pre class="line-numbers language-http"><code class="language-http">+---+---+---+---+---+---+---+---+| 0 | 0 | 1 |   Max size (5+)   |+---+---------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://src.wangriyu.wang/images/blog/http/Dynamic-Table-Size-Update-0.png" alt="Literal Header Field without Indexing - Indexed Name"></p><p>可以发送 Max Size 为 0 的更新来清空动态索引表</p><p><img src="https://src.wangriyu.wang/images/blog/http/Dynamic-Table-Size-Update-1.png" alt="Literal Header Field without Indexing - Indexed Name"></p><h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><p>RFC 中给出了很多实例 <a href="https://httpwg.org/specs/rfc7541.html#examples" target="_blank" rel="noopener">Examples - RFC 7541</a>，推荐看一遍加深理解</p><h2 id="What-then"><a href="#What-then" class="headerlink" title="What then ?"></a>What then ?</h2><h3 id="HTTP-2-演示"><a href="#HTTP-2-演示" class="headerlink" title="HTTP/2 演示"></a>HTTP/2 演示</h3><p><a href="https://http2.akamai.com/demo" target="_blank" rel="noopener">https://http2.akamai.com/demo</a></p><p><a href="https://http2.golang.org/" target="_blank" rel="noopener">https://http2.golang.org/</a></p><p>网站启用 h2 的前后对比，使用 <a href="http://www.webpagetest.org/" target="_blank" rel="noopener">WebPageTest</a> 做的测试，第一张是 h1，第二张是 h2:</p><p><img src="https://src.wangriyu.wang/images/blog/http/webtest-h1.png" alt="image"><br><img src="https://src.wangriyu.wang/images/blog/http/webtest-h2.png" alt="image"></p><h3 id="使用-HTTP-2-建议"><a href="#使用-HTTP-2-建议" class="headerlink" title="使用 HTTP/2 建议"></a>使用 HTTP/2 建议</h3><p>nginx 开启 HTTP2 只需在相应的 HTTPS 设置后加上 <code>http2</code> 即可</p><pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">listen</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">443</span> <span class="token keyword">ssl</span> http2 ipv6only<span class="token operator">=</span>on<span class="token punctuation">;</span><span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="以下几点是-HTTP-1-和-HTTP-2-都同样适用的"><a href="#以下几点是-HTTP-1-和-HTTP-2-都同样适用的" class="headerlink" title="以下几点是 HTTP/1 和 HTTP/2 都同样适用的"></a>以下几点是 HTTP/1 和 HTTP/2 都同样适用的</h4><p>1、开启压缩</p><p>配置 gzip 等可以使传输内容更小，传输速度更快</p><p>例如 nginx 可以再 http 模块中加入以下字段，其他字段和详细解释可以谷歌</p><pre class="line-numbers language-nginx"><code class="language-nginx">    <span class="token keyword">gzip</span>  on<span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">/</span> 开启    <span class="token keyword">gzip_min_length</span> 1k<span class="token punctuation">;</span>    <span class="token keyword">gzip_comp_level</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">/</span> 压缩级别    <span class="token keyword">gzip_types</span> text<span class="token operator">/</span>plain application<span class="token operator">/</span>javascript application<span class="token operator">/</span>x<span class="token operator">-</span>javascript application<span class="token operator">/</span>octet<span class="token operator">-</span>stream application<span class="token operator">/</span>json text<span class="token operator">/</span>css application<span class="token operator">/</span>xml text<span class="token operator">/</span>javascript application<span class="token operator">/</span>x<span class="token operator">-</span>httpd<span class="token operator">-</span>php image<span class="token operator">/</span>jpeg image<span class="token operator">/</span>gif image<span class="token operator">/</span>png font<span class="token operator">/</span>ttf font<span class="token operator">/</span>otf image<span class="token operator">/</span>svg<span class="token operator">+</span>xml<span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">/</span> 需要压缩的文件类型    <span class="token keyword">gzip_vary</span> on<span class="token punctuation">;</span>    <span class="token keyword">gzip_disable</span> <span class="token string">"MSIE [1-6]\."</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2、使用缓存</p><p>给静态资源设置一个缓存期是非常有必要的，关于缓存见另一篇博文 <code>HTTP Message</code></p><p>例如 nginx 在 server 模块中添加以下字段可以设置缓存时间</p><pre class="line-numbers language-nginx"><code class="language-nginx"> <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">+</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>ico<span class="token operator">|</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>moc<span class="token operator">|</span>mtn<span class="token operator">|</span>mp3<span class="token operator">|</span><span class="token keyword">mp4</span><span class="token operator">|</span>mov<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>   <span class="token keyword">access_log</span>   off<span class="token punctuation">;</span>   <span class="token keyword">expires</span>      30d<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">+</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>css<span class="token operator">|</span>js<span class="token operator">|</span>txt<span class="token operator">|</span>xml<span class="token operator">|</span>swf<span class="token operator">|</span>wav<span class="token operator">|</span>json<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>   <span class="token keyword">access_log</span>   off<span class="token punctuation">;</span>   <span class="token keyword">expires</span>      5d<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">+</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>html<span class="token operator">|</span>htm<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>   <span class="token keyword">expires</span>      24h<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">+</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>eot<span class="token operator">|</span>ttf<span class="token operator">|</span>otf<span class="token operator">|</span>woff<span class="token operator">|</span>svg<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>   <span class="token keyword">access_log</span>   off<span class="token punctuation">;</span>   <span class="token keyword">expires</span> 30d<span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>3、CDN 加速</p><p>CDN 的好处是就近访问，延迟低，访问快</p><p>4、减少 DNS 查询</p><p>每个域名都需要 DNS 查询，一般需要几毫秒到几百毫秒，移动环境下会更慢。DNS 解析完成之前，请求会被阻塞。减少 DNS 查询也是优化项之一</p><p>浏览器的 <a href="https://en.wikipedia.org/wiki/Link_prefetching" target="_blank" rel="noopener">DNS Prefetching</a> 技术也是一种优化手段</p><p>5、减少重定向</p><p>重定向可能引入新的 DNS 查询、新的 TCP 连接以及新的 HTTP 请求，所以减少重定向也很重要。</p><p>浏览器基本都会缓存通过 301 Moved Permanently 指定的跳转，所以对于永久性跳转，可以考虑使用状态码 301。对于启用了 HTTPS 的网站，配置 HSTS 策略，也可以减少从 HTTP 到 HTTPS 的重定向</p><h4 id="但以下几点就不推荐在-HTTP-2-中用了"><a href="#但以下几点就不推荐在-HTTP-2-中用了" class="headerlink" title="但以下几点就不推荐在 HTTP/2 中用了"></a>但以下几点就不推荐在 HTTP/2 中用了</h4><p>1、域名分片</p><p>HTTP/2 对于同一域名使用一个 TCP 连接足矣，过多 TCP 连接浪费资源而且效果不见得一定好</p><p>而且资源分域会破坏 HTTP/2 的优先级特性，还会降低头部压缩效果</p><p>2、资源合并</p><p>资源合并会不利于缓存机制，而且单文件过大对于 HTTP/2 的传输不好，尽量做到细粒化更有利于 HTTP/2 传输</p><p>3、资源内联</p><p>HTTP/2 支持 Server-Push，相比较内联优势更大效果更好</p><p>而且内联的资源不能有效缓存</p><p>如果有共用，多页面内联也会造成浪费</p><h4 id="HTTP-2-最佳实践"><a href="#HTTP-2-最佳实践" class="headerlink" title="HTTP/2 最佳实践"></a>HTTP/2 最佳实践</h4><p>使用 HTTP/2 尽可能用最少的连接，因为同一个连接上产生的请求和响应越多，动态字典积累得越全，头部压缩效果也就越好，而且多路复用效率高，不会像多连接那样造成资源浪费</p><p>为此需要注意以下两点:</p><ul><li>同一域名下的资源使用同一个连接，这是 HTTP/2 的特性</li><li>不同域名下的资源，如果满足能解析到同一 IP 或者使用的是同一个证书(比如泛域名证书)，HTTP/2 可以合并多个连接</li></ul><p>所以使用相同的 IP 和证书部署 Web 服务是目前最好的选择，因为这让支持 HTTP/2 的终端可以复用同一个连接，实现 HTTP/2 协议带来的好处；而只支持 HTTP/1.1 的终端则会不同域名建立不同连接，达到同时更多并发请求的目的</p><p>比如 Google 一系列网站都是用的同一个证书:</p><p><img src="https://src.wangriyu.wang/images/blog/http/google-dns.png" alt="image"></p><p>但是这好像也会造成一个问题，我使用 nginx 搭建的 webserver，有三个虚拟主机，它们共用一套证书，其中两个我显示地配置了 http2，而剩下一个我并没有配置 http2，结果我访问未配置 http2 的站点时也变成了 http2。</p><h3 id="大图片传输碰到的问题"><a href="#大图片传输碰到的问题" class="headerlink" title="大图片传输碰到的问题"></a>大图片传输碰到的问题</h3><p>先比较一下 h1 和 h2 的页面加载时间，图中绿色代表发起请求收到响应等待负载的时间，蓝色代表下载负载的时间:</p><p><img src="https://src.wangriyu.wang/images/blog/http/imgs-loadtime-h1.png" alt="image"><br><img src="https://src.wangriyu.wang/images/blog/http/imgs-loadtime-h2.png" alt="image"></p><p>可以发现 h2 加载时间还比 h1 慢一点，特别是碰到大图片时差别更明显</p><p>这篇文章对不同场景下 h1 和 h2 加载图片做了测试: <a href="https://99designs.com/tech-blog/blog/2016/07/14/real-world-http-2-400gb-of-images-per-day/" target="_blank" rel="noopener">Real–world HTTP/2: 400gb of images per day</a></p><p>其结果是:</p><ul><li><p>对一个典型的富图像，延迟限制 (latency–bound) 的界面来说。使用一个高速，低延迟的连接，视觉完成度 (visual completion) 平均会快 5%。</p></li><li><p>对一个图像极其多，带宽限制 (bandwidth–bound) 的页面来说。使用同样的连接，视觉完成度平均将会慢 5–10%，但页面的整体加载时间实际是减少了，因为得益于连接延迟少。</p></li><li><p>一个高延迟，低速度的连接(比如移动端的慢速 3G) 会对页面的视觉完成造成极大的延迟，但 h2 的视觉完成度明显更高更好。</p></li></ul><p>在所有的测试中，都可以看到: h2 使整体页面的加载速度提高了，并且在初次绘制 (initial render) 上做的更好，虽然第二种情况中视觉完成度略微下降，但总体效果还是好的</p><p>视觉完成度下降的原因是因为没有 HTTP/1.x 同时连接数量的限制，h2 可以同时发起多张图片的请求，服务器可以同时响应图片的负载，可以从下面的动图中看到</p><p><img src="https://src.wangriyu.wang/images/blog/http/safari-h2.gif" alt="image"></p><p>一旦图片下载完成，浏览器就会绘制出它们，然而，小图片下载后会渲染地更快，但是如果一个大图片恰好是初始的视图，那就会花费较长的时间加载，延迟视觉上的完成度。</p><h4 id="chrome-bug"><a href="#chrome-bug" class="headerlink" title="chrome bug"></a>chrome bug</h4><p>上面的动图是在 Safari 上的测试结果，图片最后都下载成功了，而我在 Chrome 上测试时后面的部分图片直接挂了，都报 <code>ERR_SPDY_PROTOCOL_ERROR</code> 错误，而且是百分百复现</p><p><img src="https://src.wangriyu.wang/images/blog/http/chrome-h2.gif" alt="image"></p><p>去看了下 <code>ERR_SPDY_PROTOCOL_ERROR</code> 出在哪，发现是 Server reset stream，应该是哪出错了导致流提前终止</p><p><img src="https://src.wangriyu.wang/images/blog/http/spdyerror-0.png" alt="image"></p><p>然后再研究了一下 HTTP/2 的帧序列，发出的请求都在 629 号消息中响应成功了，但是返回的数据帧只有流 15 上的，实际收到的图片又不止流 15 对应的图片，这是为什么?</p><p><img src="https://src.wangriyu.wang/images/blog/http/large-imgs-problem-0.png" alt="image"></p><p>后面我继续测试发现连续请求几张大图片，虽然 HEADERS 帧都打开的是不同的流，返回的响应的 HEADERS 帧也还是对应前面的流 ID，但是响应的 DATA 帧都是从第一个打开的流上返回的。</p><p>如果是小图片的话，一个请求响应过后这个流就关闭了，下一张小图是在其自己对应的流上返回的。只有连续几张大图会出现上述情形，这个机制很奇怪，我暂时还没有找到解释的文档。</p><p>至于 chrome 为什么出错呢，看一下 TCP 报文就会发现所有数据在一个连接上发送，到后面 TCP 包会出现各种问题，丢包、重传、失序、重包等等，不清楚 Safari 是否也是这样，因为 wireshark 只能解 chrome 的包解不了 Safari 的包</p><p><img src="https://src.wangriyu.wang/images/blog/http/large-imgs-problem-1.png" alt="image"></p><blockquote><p>《web 性能权威指南》中提及 HTTP/2 中一个 TCP 可能会造成的问题:<br>虽然消除了 HTTP 队首阻塞现象，但 TCP 层次上仍存在队首阻塞问题；如果 TCP 窗口缩放被禁用，那<a href="https://zh.wikipedia.org/wiki/%E5%B8%A6%E5%AE%BD%E6%97%B6%E5%BB%B6%E4%B9%98%E7%A7%AF" target="_blank" rel="noopener">带宽延迟积效应</a>可能会限制连接的吞吐量；丢包时 TCP 拥塞窗口会缩小；</p></blockquote><p>TCP 是一方面原因，还有另一方面应该是浏览器策略问题，估计也是 chrome bug，对比两张动图你会发现，safari 接收负载是轮流接收，我们几个接收一点然后换几个人接收，直到所有都接受完；而 chrome 则是按顺序接收，这个接收完才轮到下一个接收，结果后面的图片可能长时间未响应就挂了。</p><h4 id="使用渐进式图片"><a href="#使用渐进式图片" class="headerlink" title="使用渐进式图片"></a>使用渐进式图片</h4><p>渐进式 jpg 代替普通 jpg 有利于提高视觉完成度，而且文件更小:</p><p>输入 <code>convert --version</code> 看看是否已安装 <a href="http://www.imagemagick.org/" target="_blank" rel="noopener">ImageMagic</a>，如果没有先安装: Mac 可以用 <code>brew install imagemagick</code>，Centos 可以用 <code>yum install imagemagick</code></p><p>检测是否为 progressive jpeg，如果输出 None 说明不是 progressive jpeg；如果输出 JPEG 说明是 progressive jpeg:</p><pre class="line-numbers language-bash"><code class="language-bash">$ identify -verbose filename.jpg <span class="token operator">|</span> <span class="token function">grep</span> Interlace<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>将 basic jpeg 转换成 progressive jpeg，<a href="https://www.imagemagick.org/script/command-line-options.php#interlace" target="_blank" rel="noopener">interlace 参数</a>:</p><pre class="line-numbers language-bash"><code class="language-bash">$ convert -strip -interlace Plane source.jpg destination.jpg // 还可以指定质量 -quality 90// 批量处理$ <span class="token keyword">for</span> i <span class="token keyword">in</span> ./*.jpg<span class="token punctuation">;</span> <span class="token keyword">do</span> convert -strip -interlace Plane <span class="token variable">$i</span> <span class="token variable">$i</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>也可以转换 PNG 和 GIF，但是我试过 <code>convert -strip -interlace Plane source.png destination.png</code> 但转换后的图片往往会更大，不推荐这么用，可以 convert source.png destination.jpg</p><p>ImageMagic 还有很多强大的功能</p><pre class="line-numbers language-bash"><code class="language-bash">// 图片缩放$ convert -resize 50%x50% source.jpg destination.jpg// 图片格式转换$ convert source.jpg destination.png// 配合 <span class="token function">find</span> 命令，将当前目录下大于 100kb 的图片按 75% 质量进行压缩$ <span class="token function">find</span> -E <span class="token keyword">.</span> -iregex <span class="token string">'.*\.(jpg|png|bmp)'</span> -size +100k -exec convert -strip +profile “*” -quality 75 <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> \<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>png 压缩推荐使用 <a href="https://pngquant.org/" target="_blank" rel="noopener">pngquant</a></p><p>另外 photoshop 保存图片时也可以设置渐进或交错:</p><p>渐进式图片：选择图片格式为 JPEG =&gt; 选中“连续”</p><p>交错式图片：选择图片格式为 PNG/GIF =&gt; 选中“交错”</p><h3 id="SPDY-与-HTTP2-的关系"><a href="#SPDY-与-HTTP2-的关系" class="headerlink" title="SPDY 与 HTTP2 的关系"></a>SPDY 与 HTTP2 的关系</h3><p><a href="https://zh.wikipedia.org/wiki/SPDY" target="_blank" rel="noopener">SPDY</a> 是 HTTP2 的前身，大部分特性与 HTTP2 保持一致，包括服务器端推送，多路复用和帧作为传输的最小单位。但 SPDY 与 HTTP2 也有一些实现上的不同，比如 SPDY 的头部压缩使用的是 DEFLATE 算法，而 HTTP2 使用的是 HPACK 算法，压缩率更高。</p><h3 id="QUIC-协议"><a href="#QUIC-协议" class="headerlink" title="QUIC 协议"></a>QUIC 协议</h3><p>Google 的 <a href="https://zh.wikipedia.org/wiki/%E5%BF%AB%E9%80%9FUDP%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5" target="_blank" rel="noopener">QUIC(Quick UDP Internet Connections)</a> 协议，继承了 SPDY 的特点。QUIC 是一个 UDP 版的 TCP + TLS + HTTP/2 替代实现。</p><p>QUIC 可以创建更低延迟的连接，并且也像 HTTP/2 一样，通过仅仅阻塞部分流解决了包裹丢失这个问题，让连接在不同网络上建立变得更简单 － 这其实正是 <a href="https://en.wikipedia.org/wiki/Multipath_TCP" target="_blank" rel="noopener">MPTCP</a> 想去解决的问题。</p><p>QUIC 现在还只有 Google 的 Chrome 和它后台服务器上的实现，虽然有第三方库 libquic，但这些代码仍然很难在其他地方被复用。该协议也被 IETF 通信工作组引入了草案。</p><p><a href="https://github.com/mholt/caddy" target="_blank" rel="noopener">Caddy</a>: 基于 Go 语言开发的 Web Server， 对 HTTP/2 和 HTTPS 有着良好的支持，也开始支持 QUIC 协议 (试验性)</p><h3 id="推荐工具"><a href="#推荐工具" class="headerlink" title="推荐工具"></a>推荐工具</h3><ul><li>Chrome 插件: <a href="https://chrome.google.com/webstore/detail/http2-and-spdy-indicator/mpbpobfflnpcgagjijhmgnchggcjblin" target="_blank" rel="noopener">HTTP/2 and SPDY indicator</a></li></ul><p>如果你访问的站点开启了 HTTP/2，图标会亮起，而且点击会进入 chrome 内置的 HTTP/2 监视工具</p><ul><li>命令行工具: <a href="https://github.com/nghttp2/nghttp2" target="_blank" rel="noopener">nghttp2</a></li></ul><p>C 语言实现的 HTTP/2，可以用它调试 HTTP/2 请求</p><p>直接 <code>brew install nghttp2</code> 就可以安装，安装好后输入 <code>nghttp -nv https://nghttp2.org</code> 就可以查看 h2 请求</p><p><img src="https://src.wangriyu.wang/images/blog/http/nghttp2.png" alt="image"></p><ul><li><p>除 nghttp2 外还可以用 h2i 测试 http2: <a href="https://github.com/golang/net/blob/master/http2/h2i/README.md" target="_blank" rel="noopener">https://github.com/golang/net/blob/master/http2/h2i/README.md</a></p></li><li><p>还可以用 wireshark 解 h2 的包，不过得设置浏览器提供的对称协商密钥或者服务器提供的私钥，具体方法看此文: <a href="https://imququ.com/post/http2-traffic-in-wireshark.html" target="_blank" rel="noopener">使用 Wireshark 调试 HTTP/2 流量</a></p></li></ul><p>如果无法解包看一下 sslkeylog.log 文件有没有写入数据，如果没有数据说明浏览器打开方式不对，得用命令行打开浏览器，这样才能让浏览器读取环境变量然后向 sslkeylog 写入密钥，另外此方法好像支持谷歌浏览器和火狐，对 Safari 无效</p><p>如果 sslkeylog.log 有数据，wireshark 还是无法解包，打开设置的 SSL 选项重新选择一下文件试试，如果还是不行也用命令行打开 Wireshark</p><p>一次不行多试几次</p><ul><li><a href="https://github.com/h2o/h2o" target="_blank" rel="noopener">h2o</a>: 优化的 HTTP Server，对 HTTP/2 的支持性做的比较好</li></ul><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://www.slideshare.net/qgy18/http2-55366951" target="_blank" rel="noopener">HTTP/2: 新的机遇与挑战</a></li><li><a href="https://docs.google.com/presentation/d/1r7QXGYOLCh4fcUq0jDdDwKJWNqWK1o4xMtYpKZCJYjM/present?slide=id.p19" target="_blank" rel="noopener">HTTP2 is here, let’s optimize!</a></li><li><a href="https://imququ.com/post/series.html" target="_blank" rel="noopener">JerryQu’s Blog</a></li><li><a href="https://daniel.haxx.se/http2/" target="_blank" rel="noopener">http2 explained</a></li><li><a href="https://cdn-1.wp.nginx.com/wp-content/uploads/2015/09/NGINX_HTTP2_White_Paper_v4.pdf" target="_blank" rel="noopener">NGINX HTTP2 White Paper</a></li><li><a href="https://calendar.perfplanet.com/2016/http2-push-the-details/" target="_blank" rel="noopener">HTTP/2 Push: The details</a></li><li>《web 性能权威指南》</li></ul>]]></content>
      
      <categories>
          
          <category> http </category>
          
      </categories>
      
      
        <tags>
            
            <tag> http 扩展阅读 </tag>
            
            <tag> 网络 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>博客搬家</title>
      <link href="/2018/05-server-git.html"/>
      <url>/2018/05-server-git.html</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>3 月份腾讯云搞了一波活动，我也跟了一波车，花了 360 换了五年的服务器，美滋滋！虽然后来四月份阿里云也出了活动，我是更喜欢阿里云的，但是这波也不算亏。有了服务器之后做的第一件事就是把博客搬到服务器上，其实两个月前就弄好了，后来又折腾服务器去了，本来想等各种东西都折腾一遍后再写这篇博客，但是一拖拖到现在，罪过罪过！</p><blockquote><p>系统环境为 CentOS 7.4，默认用户为 root</p></blockquote><h2 id="系统初始化"><a href="#系统初始化" class="headerlink" title="系统初始化"></a>系统初始化</h2><p>新系统需要安装更新和一些常用工具</p><pre class="line-numbers language-bash"><code class="language-bash">$ yum -y update// 安装 node 和 <span class="token function">npm</span>$ yum <span class="token function">install</span> epel-release$ yum <span class="token function">install</span> nodejs$ node --version$ <span class="token function">npm</span> --version// 设置 <span class="token function">npm</span> 源$ <span class="token function">npm</span> config get registry$ <span class="token function">npm</span> config <span class="token keyword">set</span> registry https://registry.npm.taobao.org// 可以安装 node 版本管理工具 n$ <span class="token function">npm</span> <span class="token function">install</span> -g n$ n stable// 安装 <span class="token function">git</span>$ yum <span class="token function">install</span> <span class="token function">git</span>$ <span class="token function">git</span> --version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="修改域名解析"><a href="#修改域名解析" class="headerlink" title="修改域名解析"></a>修改域名解析</h2><p>原本域名是解析到 wangriyu.github.io 上，现在改为 A 类 ip 地址，填服务器的公有 ip</p><h2 id="设置-webserver"><a href="#设置-webserver" class="headerlink" title="设置 webserver"></a>设置 webserver</h2><h3 id="安装最新版-nginx"><a href="#安装最新版-nginx" class="headerlink" title="安装最新版 nginx"></a>安装最新版 nginx</h3><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">vi</span> /etc/yum.repos.d/nginx.repo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>写入以下内容，baseurl 根据系统修改如果是 centos 6 的话把当中的 7 改成 6，输入 <code>cat /etc/centos-release</code> 或者 <code>hostnamectl</code> 可以查看系统版本信息</p><pre class="line-numbers language-vim"><code class="language-vim"><span class="token punctuation">[</span>nginx<span class="token punctuation">]</span>name<span class="token operator">=</span>nginx repobaseurl<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>nginx<span class="token operator">.</span>org<span class="token operator">/</span>packages<span class="token operator">/</span>centos<span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span>$basearch<span class="token operator">/</span>gpgcheck<span class="token operator">=</span><span class="token number">0</span>enabled<span class="token operator">=</span><span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>清空缓存</p><pre class="line-numbers language-bash"><code class="language-bash">$ yum clean all$ yum makecache<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>输入 list 可以查看是否包含最新版本</p><pre class="line-numbers language-bash"><code class="language-bash">$ yum list <span class="token operator">|</span> <span class="token function">grep</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后安装</p><pre class="line-numbers language-bash"><code class="language-bash">$ yum <span class="token function">install</span> -y nginx$ nginx -V <span class="token comment" spellcheck="true"># 查看版本</span>$ rpm -ql nginx <span class="token comment" spellcheck="true"># 列出nginx的安装文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>启动服务并设置开机自启动</p><pre class="line-numbers language-bash"><code class="language-bash">$ systemctl start nginx$ systemctl <span class="token function">enable</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>此时访问服务器 ip 应该可以看到 nginx 的默认欢迎页了</p><h3 id="添加-Let’-Encrypt-通配符证书"><a href="#添加-Let’-Encrypt-通配符证书" class="headerlink" title="添加 Let’ Encrypt 通配符证书"></a>添加 Let’ Encrypt 通配符证书</h3><blockquote><p>国内的域名需要先备案，不然最后生成证书的时候可能会失败</p></blockquote><p>使用 CertBot 来生成证书，不同系统的方法可以到官网看: <a href="https://certbot.eff.org/lets-encrypt/centosrhel7-nginx" target="_blank" rel="noopener">https://certbot.eff.org/lets-encrypt/centosrhel7-nginx</a></p><p>安装 Certbot</p><pre class="line-numbers language-bash"><code class="language-bash">$ yum -y <span class="token function">install</span> yum-utils$ yum-config-manager --enable rhui-REGION-rhel-server-extras rhui-REGION-rhel-server-optional$ yum <span class="token function">install</span> certbot-nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>生成证书:</p><pre class="line-numbers language-bash"><code class="language-bash">$ certbot certonly --manual -d *.wangriyu.wang -d wangriyu.wang --agree-tos --manual-public-ip-logging-ok --preferred-challenges dns-01 --server https://acme-v02.api.letsencrypt.org/directory<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>zsh 可能需要在 * 前加上反斜杠 \</p></blockquote><p>确认一条消息后会要求要求你去添加一条 TXT DNS 解析记录，添加完后最好等几分钟，等 DNS 生效再确认进入下一步，然后会继续添加另一条 TXT DNS 解析记录，最后两条都通过后就会申请成功，如果验证失败了需要重新解析</p><p><img src="https://src.wangriyu.wang/images/blog/server/certbot.png" alt="image"></p><p>证书创建好后会输出证书位置，可以到 nginx 里设置虚拟机的 ssl_certificate 和 ssl_certificate_key 为生成的证书位置</p><pre class="line-numbers language-bash"><code class="language-bash">$ certbot certificates // 查看本地证书信息$ certbot delete // 删除证书<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Let’s Encrypt 证书只有 90 天有效期，快到期时可以用 <code>certbot renew</code> 更新证书，更简单的做法是添加一个 cron 任务</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">crontab</span> -e写入 30 0 1 * * root /usr/bin/certbot renew --renew-hook <span class="token string">"/usr/sbin/nginx -s reload"</span>$ <span class="token function">crontab</span> -l <span class="token comment" spellcheck="true"># 查看所有任务</span>$ <span class="token function">service</span> crond restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>每个月 1 号 0 点 30 分会自动执行该任务并重载 nginx</p><p>续期时会碰到错误，因为目前这个通配符证书的验证方式需要手动修改 DNS 记录才能生效，直接 certbot renew 是没用的，需要调用 DNS 服务商的接口实现脚本更新，可以参考这个库</p><blockquote><p>如果之后使用 certbot 出现 ImportError: ‘pyOpenSSL’ module missing required functionality. Try upgrading to v0.14 or newer. 错误<br>依次输入以下命令修复</p></blockquote><pre class="line-numbers language-bash"><code class="language-bash">$ pip uninstall requests$ pip uninstall urllib3$ yum remove python-urllib3$ yum remove python-requests$ yum remove certbot$ yum <span class="token function">install</span> python-urllib3$ yum <span class="token function">install</span> python-requests$ yum <span class="token function">install</span> certbot<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="配置服务器和虚拟机"><a href="#配置服务器和虚拟机" class="headerlink" title="配置服务器和虚拟机"></a>配置服务器和虚拟机</h3><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">cd</span> /etc/nginx$ tree <span class="token keyword">.</span>├── conf.d <span class="token comment" spellcheck="true"># 虚拟机文件，最好一个域名一个文件</span>│   ├── default.conf│   ├── blog.wangriyu.wang.conf│   └── wangriyu.wang.conf├── default.d├── nginx.conf <span class="token comment" spellcheck="true"># 服务器配置文件</span>├── ssl│   └── dhparam.pem└── <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>详细的设置我这不多说，上网搜一下 nginx 配置大把教程，我这里贴一下我的配置，仅作参考</p><ul><li>nginx.conf</li></ul><pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">http</span> <span class="token punctuation">{</span>    <span class="token keyword">include</span>       <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span>    <span class="token keyword">default_type</span>  application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>    <span class="token keyword">log_format</span>  main  <span class="token string">'$remote_addr - $remote_user [$time_local] "$request" '</span>                      <span class="token string">'$status $body_bytes_sent "$http_referer" '</span>                      <span class="token string">'"$http_user_agent" "$http_x_forwarded_for"'</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># access_log  /var/log/nginx/access.log  main;</span>    <span class="token keyword">sendfile</span>        on<span class="token punctuation">;</span>    <span class="token keyword">tcp_nopush</span>     on<span class="token punctuation">;</span>    <span class="token keyword">tcp_nodelay</span>    on<span class="token punctuation">;</span>    <span class="token keyword">keepalive_timeout</span>  <span class="token number">60</span><span class="token punctuation">;</span>    <span class="token keyword">server_tokens</span> off<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># 设置 gzip 压缩</span>    <span class="token keyword">gzip</span>  on<span class="token punctuation">;</span>    <span class="token keyword">gzip_min_length</span> 1k<span class="token punctuation">;</span>    <span class="token keyword">gzip_comp_level</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">gzip_buffers</span>    <span class="token number">16</span> 8k<span class="token punctuation">;</span>    <span class="token keyword">gzip_types</span> text<span class="token operator">/</span>plain application<span class="token operator">/</span>javascript application<span class="token operator">/</span>x<span class="token operator">-</span>javascript application<span class="token operator">/</span>octet<span class="token operator">-</span>stream application<span class="token operator">/</span>json text<span class="token operator">/</span>css application<span class="token operator">/</span>xml text<span class="token operator">/</span>javascript application<span class="token operator">/</span>x<span class="token operator">-</span>httpd<span class="token operator">-</span>php image<span class="token operator">/</span>jpeg image<span class="token operator">/</span>jpg image<span class="token operator">/</span>gif image<span class="token operator">/</span>png font<span class="token operator">/</span>ttf font<span class="token operator">/</span>otf image<span class="token operator">/</span>svg<span class="token operator">+</span>xml<span class="token punctuation">;</span>    <span class="token keyword">gzip_vary</span> on<span class="token punctuation">;</span>    <span class="token keyword">gzip_proxied</span>       any<span class="token punctuation">;</span>    <span class="token keyword">gzip_disable</span> <span class="token string">"MSIE [1-6]\."</span><span class="token punctuation">;</span>    <span class="token keyword">fastcgi_intercept_errors</span> on<span class="token punctuation">;</span>    <span class="token keyword">include</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token punctuation">.</span>d<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>blog.wangriyu.wang.conf</li></ul><pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">{</span>     <span class="token keyword">server_name</span>  blog<span class="token punctuation">.</span>wangriyu<span class="token punctuation">.</span>wang<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"># Load configuration files for the default server block.</span>     <span class="token keyword">include</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>default<span class="token punctuation">.</span>d<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"># 开启 tls 和 http2</span>     <span class="token keyword">listen</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">443</span> <span class="token keyword">ssl</span> http2 ipv6only<span class="token operator">=</span>on<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># managed by Certbot</span>     <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># managed by Certbot</span>     <span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>path<span class="token operator">/</span>to<span class="token operator">/</span>fullchain<span class="token punctuation">.</span>pem<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># managed by Certbot</span>     <span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>path<span class="token operator">/</span>to<span class="token operator">/</span>privkey<span class="token punctuation">.</span>pem<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># managed by Certbot</span>     <span class="token keyword">include</span> <span class="token operator">/</span>path<span class="token operator">/</span>to<span class="token operator">/</span>letsencrypt<span class="token operator">/</span>options<span class="token operator">-</span><span class="token keyword">ssl</span><span class="token operator">-</span>nginx<span class="token punctuation">.</span>conf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># managed by Certbot</span>     <span class="token keyword">ssl_dhparam</span> <span class="token operator">/</span>path<span class="token operator">/</span>to<span class="token operator">/</span>letsencrypt<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">-</span>dhparams<span class="token punctuation">.</span>pem<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># managed by Certbot</span>     <span class="token comment" spellcheck="true"># 优化 OCSP 查询</span>     ssl_stapling on<span class="token punctuation">;</span>     ssl_stapling_verify on<span class="token punctuation">;</span>     ssl_trusted_certificate <span class="token operator">/</span>path<span class="token operator">/</span>to<span class="token operator">/</span>letsencrypt<span class="token operator">/</span>live<span class="token operator">/</span>wangriyu<span class="token punctuation">.</span>wang<span class="token operator">/</span>chain<span class="token punctuation">.</span>pem<span class="token punctuation">;</span>     <span class="token keyword">resolver</span>                 <span class="token number">8.8</span><span class="token punctuation">.</span><span class="token number">4.4</span> <span class="token number">8.8</span><span class="token punctuation">.</span><span class="token number">8.8</span>  valid<span class="token operator">=</span>300s<span class="token punctuation">;</span>     <span class="token keyword">resolver_timeout</span>         10s<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"># HSTS 策略</span>     <span class="token keyword">add_header</span> Strict<span class="token operator">-</span>Transport<span class="token operator">-</span>Security <span class="token string">"max-age=63072000; includeSubdomains"</span> always<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"># 静态文件目录</span>     <span class="token keyword">root</span> <span class="token operator">/</span>www<span class="token operator">/</span>website<span class="token punctuation">;</span>     <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"># 设置 http2 的 ServerPush 文件，需要 nginx/1.13.9 以上才支持此功能</span>     <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token punctuation">{</span>       http2_push <span class="token operator">/</span>css<span class="token operator">/</span>style<span class="token punctuation">.</span>css<span class="token punctuation">;</span>       http2_push <span class="token operator">/</span>js<span class="token operator">/</span>main<span class="token punctuation">.</span>js<span class="token punctuation">;</span>       http2_push <span class="token operator">/</span>img<span class="token operator">/</span>yule<span class="token punctuation">.</span>jpg<span class="token punctuation">;</span>       http2_push <span class="token operator">/</span>img<span class="token operator">/</span>avatar<span class="token punctuation">.</span>jpg<span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token comment" spellcheck="true"># 设置静态文件缓存时间</span>     <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">+</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>ico<span class="token operator">|</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>moc<span class="token operator">|</span>mtn<span class="token operator">|</span>mp3<span class="token operator">|</span><span class="token keyword">mp4</span><span class="token operator">|</span>mov<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>       <span class="token keyword">access_log</span>   off<span class="token punctuation">;</span>       etag         on<span class="token punctuation">;</span>       <span class="token keyword">expires</span>      30d<span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">+</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>css<span class="token operator">|</span>js<span class="token operator">|</span>txt<span class="token operator">|</span>xml<span class="token operator">|</span>swf<span class="token operator">|</span>wav<span class="token operator">|</span>json<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>       <span class="token keyword">access_log</span>   off<span class="token punctuation">;</span>       etag         on<span class="token punctuation">;</span>       <span class="token keyword">expires</span>      5d<span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">+</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>html<span class="token operator">|</span>htm<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>       etag         on<span class="token punctuation">;</span>       <span class="token keyword">expires</span>      24h<span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">+</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>eot<span class="token operator">|</span>ttf<span class="token operator">|</span>otf<span class="token operator">|</span>woff<span class="token operator">|</span>svg<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>       <span class="token keyword">access_log</span>   off<span class="token punctuation">;</span>       etag         on<span class="token punctuation">;</span>       <span class="token keyword">expires</span>      30d<span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token comment" spellcheck="true"># 设置 404 错误页</span>     <span class="token keyword">error_page</span> <span class="token number">404</span> <span class="token number">403</span> <span class="token operator">/</span><span class="token number">404</span><span class="token punctuation">.</span>html<span class="token punctuation">;</span>     <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span><span class="token number">404</span><span class="token punctuation">.</span>html <span class="token punctuation">{</span>       <span class="token keyword">root</span> <span class="token operator">/</span>www<span class="token operator">/</span>website<span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token keyword">error_page</span> <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> <span class="token operator">/</span>50x<span class="token punctuation">.</span>html<span class="token punctuation">;</span>       <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span>50x<span class="token punctuation">.</span>html <span class="token punctuation">{</span>     <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true"># 重定向非加密连接的访问</span><span class="token keyword">server</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$host</span> <span class="token operator">=</span> blog<span class="token punctuation">.</span>wangriyu<span class="token punctuation">.</span>wang<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token number">301</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$host</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token comment" spellcheck="true"># managed by Certbot</span>    <span class="token keyword">listen</span>       <span class="token number">80</span> default_server<span class="token punctuation">;</span>    <span class="token keyword">listen</span>       <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">80</span> default_server<span class="token punctuation">;</span>    <span class="token keyword">server_name</span>  blog<span class="token punctuation">.</span>wangriyu<span class="token punctuation">.</span>wang<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">404</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># managed by Certbot</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>wangriyu.wang.conf</li></ul><pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">{</span>    <span class="token keyword">server_name</span> wangriyu<span class="token punctuation">.</span>wang<span class="token punctuation">;</span>    <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>    <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">301</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>blog<span class="token punctuation">.</span>wangriyu<span class="token punctuation">.</span>wang<span class="token variable">$request_uri</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关于 nginx 的配置推荐看下屈大大的博客: <a href="https://imququ.com/post/my-nginx-conf-for-wpo.html" target="_blank" rel="noopener">Nginx 配置之性能篇</a> 和 <a href="https://imququ.com/post/my-nginx-conf-for-security.html" target="_blank" rel="noopener">Nginx 配置之安全篇</a></p><p>通过优化 SEO 分数比 githubpage 要高得多</p><p><img src="https://src.wangriyu.wang/images/blog/server/blog.png" alt="image"></p><p><img src="https://src.wangriyu.wang/images/blog/server/home.png" alt="image"></p><p>nginx 访问的目录要存放博客生成的静态文件，接下来会介绍如何使用 git 部署</p><h2 id="搭建-Git-服务"><a href="#搭建-Git-服务" class="headerlink" title="搭建 Git 服务"></a>搭建 Git 服务</h2><p>之前博客是托管在 github 上的，我是在本地编辑完后再 push 到远端。现在放到服务器上，若用 git 部署，需要在服务器上搭建 Git 服务。</p><h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><p>创建一个 git 专用的用户</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">useradd</span> -m <span class="token function">git</span>$ <span class="token function">passwd</span> <span class="token function">git</span> <span class="token comment" spellcheck="true"># 设置密码，之后部署时登录用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>禁用 git 用户的 shell 登录权限</p><p>出于安全考虑，我们要让 git 用户不能通过 shell 登录。可以编辑 /etc/passwd 来实现，在 /etc/passwd 中找到类似下面的一行：</p><pre class="line-numbers language-vim"><code class="language-vim">git<span class="token punctuation">:</span><span class="token keyword">x</span><span class="token punctuation">:</span><span class="token number">1001</span><span class="token punctuation">:</span><span class="token number">1001</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">/</span>home<span class="token operator">/</span>git<span class="token punctuation">:</span><span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>将 bash 改为 git-shell，可以通过 <code>which git-shell</code> 获取</p><pre class="line-numbers language-vim"><code class="language-vim">git<span class="token punctuation">:</span><span class="token keyword">x</span><span class="token punctuation">:</span><span class="token number">1001</span><span class="token punctuation">:</span><span class="token number">1001</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">/</span>home<span class="token operator">/</span>git<span class="token punctuation">:</span><span class="token operator">/</span>usr<span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>git<span class="token operator">-</span><span class="token keyword">shell</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这样 git 用户可以通过 ssh 正常使用 git，但是无法登录 sehll</p><h3 id="创建仓库"><a href="#创建仓库" class="headerlink" title="创建仓库"></a>创建仓库</h3><p>新建一个 git 仓库地址比如 <code>/data/git-repo</code>。然后在这个文件夹里创建 blog.git 这个仓库。</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">mkdir</span> /data/git-repo$ <span class="token function">cd</span> /data/git-repo$ <span class="token function">git</span> init --bare blog.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然后进入 blog.git 可以看到 hooks 文件夹，可以再这里面写 Git Hook 脚本，不了解钩子的可以看下 <a href="https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90" target="_blank" rel="noopener">Git 钩子</a></p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">cd</span> blog.git/hooks$ <span class="token function">vi</span> post-update写入:<span class="token comment" spellcheck="true">#!/bin/sh</span><span class="token function">git</span> --work-tree<span class="token operator">=</span>/www/website --git-dir<span class="token operator">=</span>/data/git-repo/blog.git checkout -f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>worktree 就是我们要放置静态文件的目录，每次这个裸库收到 git 更新时会把文件更新到 worktree，这样 nginx 就可以访问新部署的文件了</p><p>如果 post-update 不是可执行权限，输入 <code>chmod +x post-update</code> 设置为可执行</p><h3 id="设置权限"><a href="#设置权限" class="headerlink" title="设置权限"></a>设置权限</h3><p>这里要注意的一点是除了要设置仓库的所有者和可读写权限外，还要设置工作目录，即静态文件存放的地方，要不然钩子函数可能更新不了工作目录</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">chown</span> -R git:git /data/git-repo/blog.git$ <span class="token function">chmod</span> 755 /data/git-repo/blog.git$ <span class="token function">chown</span> -R git:git /www/website$ <span class="token function">chmod</span> 755 /www/website<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>到本地使用 git 克隆服务器上的仓库测试一下是否可用:</p><pre class="line-numbers language-git"><code class="language-git"><span class="token command">$ git clone git@&lt;CVM IP>:/data/git-repo/blog.git</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>到此服务器的配置应该已经结束</p><h2 id="测试本地编辑部署"><a href="#测试本地编辑部署" class="headerlink" title="测试本地编辑部署"></a>测试本地编辑部署</h2><p>到 hexo 博客目录，编辑站点配置文件 <code>_config.yml</code> 的 deploy 选项</p><pre class="line-numbers language-stylus"><code class="language-stylus">deploy<span class="token punctuation">:</span>  - type<span class="token punctuation">:</span> git    repo<span class="token punctuation">:</span>      <span class="token property-declaration"><span class="token property">github</span><span class="token punctuation">:</span> git@github<span class="token operator">.</span>com<span class="token punctuation">:</span>wangriyu<span class="token operator">/</span>wangriyu<span class="token operator">.</span>github<span class="token operator">.</span>io<span class="token operator">.</span>git</span>      <span class="token property-declaration"><span class="token property">server</span><span class="token punctuation">:</span> git@<span class="token operator">&lt;</span>CVM IP<span class="token operator">></span><span class="token punctuation">:</span><span class="token operator">/</span>data<span class="token operator">/</span>git-repo<span class="token operator">/</span>blog<span class="token operator">.</span>git</span>    <span class="token property-declaration"><span class="token property">branch</span><span class="token punctuation">:</span> master</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>之后同样使用 <code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</code> 命令，然后输入 git 用户的密码就可部署到服务器上了</p><p>如果不想每次都输密码可以去创建一个密钥放到本地，这里就不叙述了</p><h2 id="升级-vim"><a href="#升级-vim" class="headerlink" title="升级 vim"></a>升级 vim</h2><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">cd</span> /etc/yum.repos.d/$ <span class="token function">wget</span> https://copr.fedorainfracloud.org/coprs/mcepl/vim8/repo/epel-7/mcepl-vim8-epel-7.repo$ rpm --import https://copr-be.cloud.fedoraproject.org/results/mcepl/vim8/pubkey.gpg$ yum update vim<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>如果 update vim 报错:</p><pre class="line-numbers language-stylus"><code class="language-stylus">Transaction check error<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">file</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>man<span class="token operator">/</span>man1<span class="token operator">/</span>vim<span class="token operator">.</span><span class="token number">1</span><span class="token operator">.</span>gz from install of vim-common-<span class="token number">2</span><span class="token punctuation">:</span><span class="token number">8.0</span><span class="token operator">.</span><span class="token number">1735</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token operator">.</span><span class="token number">96</span><span class="token operator">.</span>el7<span class="token operator">.</span>centos<span class="token operator">.</span>x86_64 conflicts with file from package vim-minimal-<span class="token number">2</span><span class="token punctuation">:</span><span class="token number">7.4</span><span class="token operator">.</span><span class="token number">160</span><span class="token operator">-</span><span class="token number">2</span><span class="token operator">.</span>el7<span class="token operator">.</span>x86_64</span><span class="token property-declaration"><span class="token property">Error</span> Summary</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>先执行一下 <code>yum erase vim-minimal</code> 再 <code>yum update vim</code></p><p>如果升级后发现只能用 <code>vim</code> 命令不能用 <code>vi</code>，设置如下</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">ls</span> -l /usr/bin <span class="token operator">|</span> <span class="token function">grep</span> <span class="token function">vi</span>$ <span class="token function">cp</span> /usr/bin/vim /usr/bin/vi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>推荐安装 oh-my-zsh，配合 <a href="https://github.com/zsh-users/zsh-syntax-highlighting" target="_blank" rel="noopener">zsh-syntax-highlighting</a> 插件和合适的主题，可以大大改善 shell 使用体验</p><p>接下来会写几篇折腾服务器的博客，比如搭建 FTP、nextcloud、docker 等等</p>]]></content>
      
      <categories>
          
          <category> Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Golang http/server</title>
      <link href="/2018/04-go-http.html"/>
      <url>/2018/04-go-http.html</url>
      <content type="html"><![CDATA[<h2 id="server"><a href="#server" class="headerlink" title="server"></a>server</h2><p><img src="https://src.wangriyu.wang/images/blog/go/server.png" alt="image"></p><h3 id="server-与-conn-等接口"><a href="#server-与-conn-等接口" class="headerlink" title="server 与 conn 等接口"></a>server 与 conn 等接口</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">type</span> Server <span class="token keyword">struct</span> <span class="token punctuation">{</span>    Addr              <span class="token builtin">string</span>        <span class="token comment" spellcheck="true">// 要监听的 TCP 地址</span>    Handler           Handler       <span class="token comment" spellcheck="true">// 调用的 handler, 如果为空则用 http.DefaultServeMux</span>    TLSConfig         <span class="token operator">*</span>tls<span class="token punctuation">.</span>Config   <span class="token comment" spellcheck="true">// 用于 ServeTLS 和 ListenAndServeTLS</span>    ReadTimeout       time<span class="token punctuation">.</span>Duration <span class="token comment" spellcheck="true">// 读取完整 request (包括 body) 的最大时长，可以和 ReadHeaderTimeout 同时使用</span>    ReadHeaderTimeout time<span class="token punctuation">.</span>Duration <span class="token comment" spellcheck="true">// 读取 request headers 的最大时长</span>    WriteTimeout      time<span class="token punctuation">.</span>Duration <span class="token comment" spellcheck="true">// 写 response 的最大时长</span>    IdleTimeout       time<span class="token punctuation">.</span>Duration <span class="token comment" spellcheck="true">// 当 keepalive 开启时等待下个 request 的最大时长，此值为空时使用 ReadTimeout 值代替，ReadTimeout 也为空使用 ReadHeaderTimeout 代替</span>    MaxHeaderBytes    <span class="token builtin">int</span>           <span class="token comment" spellcheck="true">// 解析 request headers 里键值对的最大字节数 (包含请求行)，不限制 body. 如果为 0, 使用 DefaultMaxHeaderBytes 代替</span>    TLSNextProto      <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>Server<span class="token punctuation">,</span> <span class="token operator">*</span>tls<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> Handler<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 当 '应用层协议协商 (NPN/ALPN)' 时发生协议升级时，TLSNextProto 需要指定可选的 function 去接管 TLS 连接</span>    ConnState         <span class="token keyword">func</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> ConnState<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 指定一个可选的钩子函数，由 client 连接状态改变触发</span>    ErrorLog          <span class="token operator">*</span>log<span class="token punctuation">.</span>Logger   <span class="token comment" spellcheck="true">// 指定一个可选的 logger 接收错误日志. 如果为空则由 log 包接管</span>    disableKeepAlives <span class="token builtin">int32</span>         <span class="token comment" spellcheck="true">// 在 SetKeepAlivesEnabled 中设置，为 1 表示取消长连接，为 0 保持长连接 (默认)</span>    inShutdown        <span class="token builtin">int32</span>         <span class="token comment" spellcheck="true">// 非零代表 in Shutdown</span>    nextProtoOnce     sync<span class="token punctuation">.</span>Once     <span class="token comment" spellcheck="true">// 设置 HTTP/2</span>    nextProtoErr      <span class="token builtin">error</span>         <span class="token comment" spellcheck="true">// http2.ConfigureServer 的结果</span>    mu                sync<span class="token punctuation">.</span>Mutex    listeners         <span class="token keyword">map</span><span class="token punctuation">[</span>net<span class="token punctuation">.</span>Listener<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    activeConn        <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token operator">*</span>conn<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    doneChan          <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// doneChan 代表任务结束</span>    onShutdown        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// 通过 RegisterOnShutdown 注册，在 Shutdown 时调用当中的钩子函数</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 此接口由 ResponseWriters 执行去检测连接是否已断开，此机制允许客户端断开后服务端取消一个长连接</span><span class="token keyword">type</span> CloseNotifier <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token function">CloseNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// conn 代表服务端的 HTTP 连接</span><span class="token keyword">type</span> conn <span class="token keyword">struct</span> <span class="token punctuation">{</span>    server     <span class="token operator">*</span>Server    cancelCtx  context<span class="token punctuation">.</span>CancelFunc   <span class="token comment" spellcheck="true">// 撤销连接层的 context，读写出错时会调用</span>    rwc        net<span class="token punctuation">.</span>Conn             <span class="token comment" spellcheck="true">//</span>    remoteAddr <span class="token builtin">string</span>               <span class="token comment" spellcheck="true">// rwc.RemoteAddr().String()</span>    tlsState   <span class="token operator">*</span>tls<span class="token punctuation">.</span>ConnectionState <span class="token comment" spellcheck="true">// TLS 连接状态，nil 代表非 TSL</span>    werr       <span class="token builtin">error</span>                <span class="token comment" spellcheck="true">// rwc 写入时的首个错误 (bufw 写入时)</span>    r          <span class="token operator">*</span>connReader          <span class="token comment" spellcheck="true">// 一个 *conn 使用的 io.reader 封装，存有 bufr 的读取内容</span>    bufr       <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader        <span class="token comment" spellcheck="true">// 从 r 读取</span>    bufw       <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Writer        <span class="token comment" spellcheck="true">// 要写入 checkConnErrorWriter{c} 的缓冲</span>    lastMethod <span class="token builtin">string</span>    curReq     atomic<span class="token punctuation">.</span>Value <span class="token comment" spellcheck="true">// 存入 *response (response 中包含 request)</span>    curState   atomic<span class="token punctuation">.</span>Value <span class="token comment" spellcheck="true">// 存入 ConnState</span>    mu         sync<span class="token punctuation">.</span>Mutex   <span class="token comment" spellcheck="true">// 保护 hijackedv</span>    hijackedv  <span class="token builtin">bool</span>         <span class="token comment" spellcheck="true">// 代表连接是否已经被 hijacke</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 一个 ctx 带有一个截止期限，一个取消信号，或者其他绑定值</span><span class="token comment" spellcheck="true">// 其函数可以被多个 goroutines 同时使用</span><span class="token comment" spellcheck="true">// 一个请求过来时可能会涉及到多个 goroutines，Ctx 可以控制关闭与之相关联和派生出的子 ctx 相关联的 goroutines</span><span class="token keyword">type</span> Context <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Deadline 方法是获取设置的截止时间，第一个返回值是截止时间，到了这个时间点，Context 会自动发起取消请求；</span>    <span class="token comment" spellcheck="true">// 第二个返回值 ok==false 时表示没有设置截止时间，如果需要取消的话，需要调用 cancel 函数进行取消，取消操作包括派生出去的子 Ctx</span>    <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 在 goroutine 中，如果该方法返回的 chan 可以读取，则意味着 parent context 已经发起了取消请求，</span>    <span class="token comment" spellcheck="true">// 我们通过 Done 方法收到这个信号后，就应该做清理操作，然后退出 goroutine，释放资源</span>    <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 如果 Done 还没关闭，Err 返回 nil</span>    <span class="token comment" spellcheck="true">// 如果 Done 已经关闭，返回非空 err，告知 Ctx 因何取消</span>    <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>    <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 键值对形式，与 Ctx 绑定，可以为空</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="监听函数"><a href="#监听函数" class="headerlink" title="监听函数"></a>监听函数</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Serve 接收 listener 上过来的连接，并为每个连接创建 service 线程</span><span class="token comment" spellcheck="true">// 在 service 线程中会读取 request 并调用 srv.Handler 进行服务</span><span class="token comment" spellcheck="true">// handler 参数一般传 nil 就行，代表使用的是 DefaultServeMux</span><span class="token keyword">func</span> <span class="token function">Serve</span><span class="token punctuation">(</span>l net<span class="token punctuation">.</span>Listener<span class="token punctuation">,</span> handler Handler<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// HTTPS: ServeTLS(l net.Listener, handler Handler, certFile, keyFile string) error</span>    srv <span class="token operator">:=</span> <span class="token operator">&amp;</span>Server<span class="token punctuation">{</span>Handler<span class="token punctuation">:</span> handler<span class="token punctuation">}</span>    <span class="token keyword">return</span> srv<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// HTTPS: srv.ServeTLS(l, certFile, keyFile)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// func HelloServer(w http.ResponseWriter, req *http.Request) {</span><span class="token comment" spellcheck="true">//     io.WriteString(w, "hello, world!\n")</span><span class="token comment" spellcheck="true">// }</span><span class="token comment" spellcheck="true">//</span><span class="token comment" spellcheck="true">// func main() {</span><span class="token comment" spellcheck="true">//     http.HandleFunc("/hello", HelloServer)</span><span class="token comment" spellcheck="true">//     log.Fatal(http.ListenAndServe(":12345", nil))</span><span class="token comment" spellcheck="true">// }</span><span class="token keyword">func</span> <span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr <span class="token builtin">string</span><span class="token punctuation">,</span> handler Handler<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    server <span class="token operator">:=</span> <span class="token operator">&amp;</span>Server<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> addr<span class="token punctuation">,</span> Handler<span class="token punctuation">:</span> handler<span class="token punctuation">}</span>    <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// err := http.ListenAndServeTLS(":10443", "cert.pem", "key.pem", nil)</span><span class="token comment" spellcheck="true">// HTTPS 方式，可以使用 crypto/tls 中的 generate_cert.go 生成 cert.pem 和 key.pem</span><span class="token keyword">func</span> <span class="token function">ListenAndServeTLS</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> certFile<span class="token punctuation">,</span> keyFile <span class="token builtin">string</span><span class="token punctuation">,</span> handler Handler<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    server <span class="token operator">:=</span> <span class="token operator">&amp;</span>Server<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> addr<span class="token punctuation">,</span> Handler<span class="token punctuation">:</span> handler<span class="token punctuation">}</span>    <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">ListenAndServeTLS</span><span class="token punctuation">(</span>certFile<span class="token punctuation">,</span> keyFile<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ListenAndServe 监听 srv.Addr 地址上的 tcp 网络，然后调用 Serve 服务连接，连接会设置 keep-alives</span><span class="token comment" spellcheck="true">// 如果 srv.Addr 为空则用 ":http" 代替</span><span class="token comment" spellcheck="true">// ListenAndServe 总是返回非空 err</span><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    addr <span class="token operator">:=</span> srv<span class="token punctuation">.</span>Addr    <span class="token keyword">if</span> addr <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>        addr <span class="token operator">=</span> <span class="token string">":http"</span>    <span class="token punctuation">}</span>    ln<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// HTTP:</span>    <span class="token keyword">return</span> srv<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>tcpKeepAliveListener<span class="token punctuation">{</span>ln<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token punctuation">.</span>TCPListener<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// HTTPS 方式调用 ListenAndServeTLS(certFile, keyFile string) error</span>    <span class="token comment" spellcheck="true">// 与 ListenAndServe 类似，只是最后要关闭 ln 并返回 srv.ServeTLS</span>    <span class="token comment" spellcheck="true">// defer ln.Close()</span>    <span class="token comment" spellcheck="true">// return srv.ServeTLS(tcpKeepAliveListener{ln.(*net.TCPListener)}, certFile, keyFile)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="server-的服务函数"><a href="#server-的服务函数" class="headerlink" title="server 的服务函数"></a>server 的服务函数</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">ServeTLS</span><span class="token punctuation">(</span>l net<span class="token punctuation">.</span>Listener<span class="token punctuation">,</span> certFile<span class="token punctuation">,</span> keyFile <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 在 srv.Serve 之前尝试设置 HTTP/2</span>    <span class="token comment" spellcheck="true">// setupHTTP2_ServeTLS 中调用 onceSetNextProtoDefaults_Serve，只有 srv.TLSNextProto 为 nil 时才可以设置 HTTP/2</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">setupHTTP2_ServeTLS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    config <span class="token operator">:=</span> <span class="token function">cloneTLSConfig</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>TLSConfig<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">strSliceContains</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>NextProtos<span class="token punctuation">,</span> <span class="token string">"http/1.1"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// strSliceContains 判断是否包含字符串</span>        config<span class="token punctuation">.</span>NextProtos <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>NextProtos<span class="token punctuation">,</span> <span class="token string">"http/1.1"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    configHasCert <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Certificates<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> config<span class="token punctuation">.</span>GetCertificate <span class="token operator">!=</span> <span class="token boolean">nil</span>    <span class="token keyword">if</span> <span class="token operator">!</span>configHasCert <span class="token operator">||</span> certFile <span class="token operator">!=</span> <span class="token string">""</span> <span class="token operator">||</span> keyFile <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> err <span class="token builtin">error</span>        config<span class="token punctuation">.</span>Certificates <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>tls<span class="token punctuation">.</span>Certificate<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>        config<span class="token punctuation">.</span>Certificates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> err <span class="token operator">=</span> tls<span class="token punctuation">.</span><span class="token function">LoadX509KeyPair</span><span class="token punctuation">(</span>certFile<span class="token punctuation">,</span> keyFile<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// LoadX509KeyPair 解析证书，文件中必须含有 PEM 编码数据</span>        <span class="token comment" spellcheck="true">// PEM (Privacy Enhancement Message)，定义见 RFC1421，是一种基于 base64 的编码格式</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> err        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    tlsListener <span class="token operator">:=</span> tls<span class="token punctuation">.</span><span class="token function">NewListener</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> config<span class="token punctuation">)</span>    <span class="token keyword">return</span> srv<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>tlsListener<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 若启用 HTTP/2，在调用 Serve 前需要根据 listener's TLS Config 初始化 srv.TLSConfig</span><span class="token comment" spellcheck="true">// Serve 总是返回非空的 err，在 Shutdown 或 Close 后返回 ErrServerClosed</span><span class="token comment" spellcheck="true">// Close 是立即关闭 Server 和与之相关的 listeners 和 connections，而 shutdown 是逐步关闭 listeners 和闲置的 connections，两者不会管已被 hijack 的连接</span><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">Serve</span><span class="token punctuation">(</span>l net<span class="token punctuation">.</span>Listener<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">defer</span> l<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> fn <span class="token operator">:=</span> testHookServerServe<span class="token punctuation">;</span> fn <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 如果钩子函数 testHookServerServe 非空则调用</span>        <span class="token function">fn</span><span class="token punctuation">(</span>srv<span class="token punctuation">,</span> l<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> tempDelay time<span class="token punctuation">.</span>Duration <span class="token comment" spellcheck="true">// accept 失败时 sleep 多长时间</span>    <span class="token comment" spellcheck="true">// setupHTTP2_Serve 和 setupHTTP2_ServeTLS 两者都是调用 onceSetNextProtoDefaults() 去尝试设置 HTTP/2</span>    <span class="token comment" spellcheck="true">// 只是考虑到多并发情况下的 Serve 请求，setupHTTP2_Serve 采用了更保守的政策去设置 HTTP/2</span>    <span class="token comment" spellcheck="true">// setupHTTP2_Serve 先调用 shouldConfigureHTTP2ForServe 判断是否应该为 Server.Serve 设置 HTTP/2</span>    <span class="token comment" spellcheck="true">// shouldConfigureHTTP2ForServe 中如果 srv.TLSConfig 为 nil 或者 srv.TLSConfig.NextProtos 包含 "h2" 字样返回真，否则返回假，</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">setupHTTP2_Serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    srv<span class="token punctuation">.</span><span class="token function">trackListener</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 将 l 添加进 server.listeners</span>    <span class="token keyword">defer</span> srv<span class="token punctuation">.</span><span class="token function">trackListener</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 结束后删去 l</span>    baseCtx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// baseContext 会一直存在，但没有值也没有 deadline，用于主函数或者初始化或者测试或者顶层接收请求的 context</span>    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>baseCtx<span class="token punctuation">,</span> ServerContextKey<span class="token punctuation">,</span> srv<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// WithValue 返回 baseCtx 的副本，副本内的值是一个键值对 ServerContextKey - srv</span>    <span class="token comment" spellcheck="true">// ServerContextKey = &amp;contextKey{"http-server"} 与其绑定的 value 类型为 *Server</span>    <span class="token keyword">for</span> <span class="token punctuation">{</span>        rw<span class="token punctuation">,</span> e <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 接收到连接</span>        <span class="token keyword">if</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">select</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token operator">&lt;-</span>srv<span class="token punctuation">.</span><span class="token function">getDoneChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// server 已关闭</span>                <span class="token keyword">return</span> ErrServerClosed            <span class="token keyword">default</span><span class="token punctuation">:</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> ne<span class="token punctuation">,</span> ok <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span>Error<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> ne<span class="token punctuation">.</span><span class="token function">Temporary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> tempDelay <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>                    tempDelay <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    tempDelay <span class="token operator">*=</span> <span class="token number">2</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> max <span class="token operator">:=</span> <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">;</span> tempDelay <span class="token operator">></span> max <span class="token punctuation">{</span>                    tempDelay <span class="token operator">=</span> max                <span class="token punctuation">}</span>                srv<span class="token punctuation">.</span><span class="token function">logf</span><span class="token punctuation">(</span><span class="token string">"http: Accept error: %v; retrying in %v"</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> tempDelay<span class="token punctuation">)</span>                time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>tempDelay<span class="token punctuation">)</span>                <span class="token keyword">continue</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> e        <span class="token punctuation">}</span>        tempDelay <span class="token operator">=</span> <span class="token number">0</span>        c <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">newConn</span><span class="token punctuation">(</span>rw<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// conn.setState 根据传入的状态调用 trackConn 来设置 server.activeConn 集合，再改变当前 conn.curState</span>        <span class="token comment" spellcheck="true">// 如果 server 设置了 ConnState 这个钩子函数，就调用</span>        c<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>rwc<span class="token punctuation">,</span> StateNew<span class="token punctuation">)</span>        <span class="token keyword">go</span> c<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="server-Serve-最后调用-conn-serve"><a href="#server-Serve-最后调用-conn-serve" class="headerlink" title="server.Serve 最后调用 conn.serve"></a>server.Serve 最后调用 conn.serve</h3><p>在此函数中调用 <code>serverHandler{c.server}.ServeHTTP(w, w.req)</code> 转入路由模块</p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token function">serve</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>    c<span class="token punctuation">.</span>remoteAddr <span class="token operator">=</span> c<span class="token punctuation">.</span>rwc<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> LocalAddrContextKey<span class="token punctuation">,</span> c<span class="token punctuation">.</span>rwc<span class="token punctuation">.</span><span class="token function">LocalAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// LocalAddrContextKey = &amp;contextKey{"local-addr"} 与其绑定的 value 类型是 net.Addr</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> ErrAbortHandler <span class="token punctuation">{</span>            <span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token number">64</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span> <span class="token comment" spellcheck="true">// 64 KB</span>            buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>            buf <span class="token operator">=</span> buf<span class="token punctuation">[</span><span class="token punctuation">:</span>runtime<span class="token punctuation">.</span><span class="token function">Stack</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">]</span>            c<span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">logf</span><span class="token punctuation">(</span><span class="token string">"http: panic serving %v: %v\n%s"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>remoteAddr<span class="token punctuation">,</span> err<span class="token punctuation">,</span> buf<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span><span class="token function">hijacked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 已经被 hijack 的连接不用管理，由 hijack 的调用者处理</span>            c<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            c<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>rwc<span class="token punctuation">,</span> StateClosed<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> tlsConn<span class="token punctuation">,</span> ok <span class="token operator">:=</span> c<span class="token punctuation">.</span>rwc<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>tls<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// HTTPS</span>        <span class="token keyword">if</span> d <span class="token operator">:=</span> c<span class="token punctuation">.</span>server<span class="token punctuation">.</span>ReadTimeout<span class="token punctuation">;</span> d <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>            c<span class="token punctuation">.</span>rwc<span class="token punctuation">.</span><span class="token function">SetReadDeadline</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> d <span class="token operator">:=</span> c<span class="token punctuation">.</span>server<span class="token punctuation">.</span>WriteTimeout<span class="token punctuation">;</span> d <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>            c<span class="token punctuation">.</span>rwc<span class="token punctuation">.</span><span class="token function">SetWriteDeadline</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> tlsConn<span class="token punctuation">.</span><span class="token function">Handshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            c<span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">logf</span><span class="token punctuation">(</span><span class="token string">"http: TLS handshake error from %s: %v"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>rwc<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        c<span class="token punctuation">.</span>tlsState <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>tls<span class="token punctuation">.</span>ConnectionState<span class="token punctuation">)</span>        <span class="token operator">*</span>c<span class="token punctuation">.</span>tlsState <span class="token operator">=</span> tlsConn<span class="token punctuation">.</span><span class="token function">ConnectionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 获取当前 TLS 连接的详细信息</span>        <span class="token comment" spellcheck="true">// NegotiatedProtocol 协商的协议，validNPN 判断 proto 是否属于 "", "http/1.1", "http/1.0" 之一，不属于返回真</span>        <span class="token keyword">if</span> proto <span class="token operator">:=</span> c<span class="token punctuation">.</span>tlsState<span class="token punctuation">.</span>NegotiatedProtocol<span class="token punctuation">;</span> <span class="token function">validNPN</span><span class="token punctuation">(</span>proto<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> fn <span class="token operator">:=</span> c<span class="token punctuation">.</span>server<span class="token punctuation">.</span>TLSNextProto<span class="token punctuation">[</span>proto<span class="token punctuation">]</span><span class="token punctuation">;</span> fn <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                h <span class="token operator">:=</span> initNPNRequest<span class="token punctuation">{</span>tlsConn<span class="token punctuation">,</span> serverHandler<span class="token punctuation">{</span>c<span class="token punctuation">.</span>server<span class="token punctuation">}</span><span class="token punctuation">}</span>                <span class="token function">fn</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>server<span class="token punctuation">,</span> tlsConn<span class="token punctuation">,</span> h<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 发生协议切换时触发钩子函数</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// HTTP/1.x following</span>    ctx<span class="token punctuation">,</span> cancelCtx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// WithCancel 返回 &amp;c, func() { c.cancel(true, Canceled) }</span>    <span class="token comment" spellcheck="true">// ctx.cancel close ctx.done 取消所有 ctx 的 children，如果第一个参数为 true，则把 ctx 从其 parent 的 children 列表删去</span>    c<span class="token punctuation">.</span>cancelCtx <span class="token operator">=</span> cancelCtx    <span class="token keyword">defer</span> <span class="token function">cancelCtx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 关闭 ctx，以及相关 goroutines</span>    c<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token operator">&amp;</span>connReader<span class="token punctuation">{</span>conn<span class="token punctuation">:</span> c<span class="token punctuation">}</span>    c<span class="token punctuation">.</span>bufr <span class="token operator">=</span> <span class="token function">newBufioReader</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>r<span class="token punctuation">)</span>    c<span class="token punctuation">.</span>bufw <span class="token operator">=</span> <span class="token function">newBufioWriterSize</span><span class="token punctuation">(</span>checkConnErrorWriter<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">{</span>        w<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">readRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 读取 request 返回 response 和可能的 err</span>        <span class="token keyword">if</span> c<span class="token punctuation">.</span>r<span class="token punctuation">.</span>remain <span class="token operator">!=</span> c<span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">initialReadLimitSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// remain 代表 io.reader 剩余空间，initialReadLimitSize 返回 int64(srv.MaxHeaderBytes > 0 ? srv.MaxHeaderBytes : DefaultMaxHeaderBytes) + 4096</span>            c<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>rwc<span class="token punctuation">,</span> StateActive<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// StateActive 代表连接已经从 request 读到数据</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">const</span> errorHeaders <span class="token operator">=</span> <span class="token string">"\r\nContent-Type: text/plain; charset=utf-8\r\nConnection: close\r\n\r\n"</span>            <span class="token keyword">if</span> err <span class="token operator">==</span> errTooLarge <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// errors.New("http: request too large")</span>                <span class="token keyword">const</span> publicErr <span class="token operator">=</span> <span class="token string">"431 Request Header Fields Too Large"</span>                fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>rwc<span class="token punctuation">,</span> <span class="token string">"HTTP/1.1 "</span><span class="token operator">+</span>publicErr<span class="token operator">+</span>errorHeaders<span class="token operator">+</span>publicErr<span class="token punctuation">)</span>                c<span class="token punctuation">.</span><span class="token function">closeWriteAndWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">// closewrite flush 所有缓存的数据并发送一个 FIN 包（如果客户端是通过 TCP 连接的），表示我们这边已结束，然后 sleep 500 ms</span>                <span class="token keyword">return</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token function">isCommonNetReadError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// err 是否是 io.EOF 或者是网络超时 (net.Error) 或者是读 request 的 net.OpError 之一</span>                <span class="token keyword">return</span>            <span class="token punctuation">}</span>            publicErr <span class="token operator">:=</span> <span class="token string">"400 Bad Request"</span>            <span class="token keyword">if</span> v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span>badRequestError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>                publicErr <span class="token operator">=</span> publicErr <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>rwc<span class="token punctuation">,</span> <span class="token string">"HTTP/1.1 "</span><span class="token operator">+</span>publicErr<span class="token operator">+</span>errorHeaders<span class="token operator">+</span>publicErr<span class="token punctuation">)</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// request Header : Expect 100 Continue</span>        req <span class="token operator">:=</span> w<span class="token punctuation">.</span>req        <span class="token keyword">if</span> req<span class="token punctuation">.</span><span class="token function">expectsContinue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> req<span class="token punctuation">.</span><span class="token function">ProtoAtLeast</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>ContentLength <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// after first '100 Continue' request, wrapper response with 'HTTP/1.1 100 Continue'</span>                req<span class="token punctuation">.</span>Body <span class="token operator">=</span> <span class="token operator">&amp;</span>expectContinueReader<span class="token punctuation">{</span>readCloser<span class="token punctuation">:</span> req<span class="token punctuation">.</span>Body<span class="token punctuation">,</span> resp<span class="token punctuation">:</span> w<span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"Expect"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>            w<span class="token punctuation">.</span><span class="token function">sendExpectationFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// response with status code 417 (Expectation Failed)</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        c<span class="token punctuation">.</span>curReq<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token function">requestBodyRemains</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Body<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 之后是否还能从 body 读取到数据，true 表示能继续读 (未到 io.EOF)</span>            <span class="token function">registerOnHitEOF</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Body<span class="token punctuation">,</span> w<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>r<span class="token punctuation">.</span>startBackgroundRead<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 当 body 读到 EOF，调用传入的 startBackgroundRead 函数</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 长连接下 HTTP 管线化请求时的处理</span>            <span class="token keyword">if</span> w<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>bufr<span class="token punctuation">.</span><span class="token function">Buffered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// [HTTP pipelining](https://zh.wikipedia.org/wiki/HTTP%E7%AE%A1%E7%B7%9A%E5%8C%96)</span>                w<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">closeNotifyFromPipelinedRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// closeNotify()</span>            <span class="token punctuation">}</span>            w<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">startBackgroundRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        serverHandler<span class="token punctuation">{</span>c<span class="token punctuation">.</span>server<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> w<span class="token punctuation">.</span>req<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// server.Handler == nil -> DefaultServeMux.ServeHTTP</span>        w<span class="token punctuation">.</span><span class="token function">cancelCtx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> c<span class="token punctuation">.</span><span class="token function">hijacked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        w<span class="token punctuation">.</span><span class="token function">finishRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">!</span>w<span class="token punctuation">.</span><span class="token function">shouldReuseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// tcp 连接是否可以继续使用</span>            <span class="token keyword">if</span> w<span class="token punctuation">.</span>requestBodyLimitHit <span class="token operator">||</span> w<span class="token punctuation">.</span><span class="token function">closedRequestBodyEarly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// requestBodyLimitHit 在 requestTooLarge 函数中设置，当此值为真，停止读取后续的 request 和输入</span>                <span class="token comment" spellcheck="true">// closedRequestBodyEarly 表示连接之前是否已关闭</span>                c<span class="token punctuation">.</span><span class="token function">closeWriteAndWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        c<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>rwc<span class="token punctuation">,</span> StateIdle<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// StateIdle 表示此连接已处理完一个 request 并处于 keep-alive 状态，等待后续 request</span>        c<span class="token punctuation">.</span>curReq<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>response<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">!</span>w<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">doKeepAlives</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// doKeepAlives 判断是否满足 disableKeepAlives == 0 &amp;&amp; inShutdown == 0 (处于 keep-alive 模式且不在 shutdown 状态)</span>            <span class="token comment" spellcheck="true">// We're in shutdown mode. We might've replied</span>            <span class="token comment" spellcheck="true">// to the user without "Connection: close" and</span>            <span class="token comment" spellcheck="true">// they might think they can send another</span>            <span class="token comment" spellcheck="true">// request, but such is life with HTTP/1.1.</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> d <span class="token operator">:=</span> c<span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">idleTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> d <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>            c<span class="token punctuation">.</span>rwc<span class="token punctuation">.</span><span class="token function">SetReadDeadline</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>bufr<span class="token punctuation">.</span><span class="token function">Peek</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// SetReadDeadline 设置后续读去调用的截止时间，如果传入零值表示不会 timeout</span>        c<span class="token punctuation">.</span>rwc<span class="token punctuation">.</span><span class="token function">SetReadDeadline</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><blockquote><p>流程：<br>当一个请求 request 进来的时候，server 会依次根据 ServeMux.m 中的 string（路由表达式）来一个一个匹配，<br>如果找到了可以匹配的 muxEntry，就取出 muxEntry.h，这是个 handler，<br>调用 handler 中的 ServeHTTP（ResponseWriter, *Request）来组装 Response，并返回。</p></blockquote><hr><h3 id="路由接口"><a href="#路由接口" class="headerlink" title="路由接口"></a>路由接口</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// ResponseWriter 接口用于 HTTP handler 生成 response</span><span class="token comment" spellcheck="true">// 在 Handler.ServeHTTP 返回后，ResponseWriter 不应该再被使用</span><span class="token keyword">type</span> ResponseWriter <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Header             <span class="token comment" spellcheck="true">// Header() 返回 WriteHeader 要发送的 Header map 集合</span>    <span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// Write 写入响应的 body</span>    <span class="token function">WriteHeader</span><span class="token punctuation">(</span>statusCode <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 这个方法发送 Response 的 Header 和传入的 HTTP 状态码</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Flusher 由 ResponseWriters 执行去允许 HTTP handler 将缓存中的数据推给客户端, 默认的 HTTP/1.x 和 HTTP/2 ResponseWriter 支持 Flusher，</span><span class="token comment" spellcheck="true">// 但是 ResponseWriter 的封装可能会不支持，Handlers 在运行时需要测试是否支持此函数</span><span class="token comment" spellcheck="true">// 即使 ResponseWriters 支持 Flush，如果客户端使用了 HTTP proxy，直到响应结束，缓存的数据也有可能到达不了客户端</span><span class="token keyword">type</span> Flusher <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Hijacker 接口由 ResponseWriters 执行去允许 HTTP handler 接管连接</span><span class="token comment" spellcheck="true">// 默认的 ResponseWriter 支持 HTTP/1.x 连接下的 Hijacker，但是 HTTP/2 连接不支持，HTTP/2 多路复用等情况不适合使用 Hijack 。</span><span class="token comment" spellcheck="true">// ResponseWriter 封装也可能不支持 Hijacker. Handlers 在运行时需要测试是否支持此函数</span><span class="token keyword">type</span> Hijacker <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token function">Hijack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>net<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> <span class="token operator">*</span>bufio<span class="token punctuation">.</span>ReadWriter<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ServeMux 类型是 HTTP 请求的路由规则转换器。它会将每一个接收的请求的 URL 与一个注册路由的列表进行匹配，并调用和 URL 最匹配的 handler.</span><span class="token comment" spellcheck="true">// 匹配到多个时较长的模式优先于较短的模式，模式也可以主机名开始，表示只匹配该主机上的路径，指定主机的模式优先于一般的模式，</span><span class="token comment" spellcheck="true">// ServeMux 还会规范化请求的 URL 路径，将任何包含 "." 或 ".." 元素的请求重定向到等价的没有这两种元素的 URL</span><span class="token keyword">type</span> ServeMux <span class="token keyword">struct</span> <span class="token punctuation">{</span>    mu    sync<span class="token punctuation">.</span>RWMutex <span class="token comment" spellcheck="true">// 读写锁</span>    m     <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>muxEntry <span class="token comment" spellcheck="true">// 路由规则，一个 string 对应一个 mux 实体，这里的 string 就是注册的路由表达式</span>    hosts <span class="token builtin">bool</span> <span class="token comment" spellcheck="true">// 是否在任意的规则中带有 host 信息</span><span class="token punctuation">}</span><span class="token keyword">type</span> muxEntry <span class="token keyword">struct</span> <span class="token punctuation">{</span>    h        Handler <span class="token comment" spellcheck="true">// 这个路由表达式对应哪个 handler</span>    pattern  <span class="token builtin">string</span>  <span class="token comment" spellcheck="true">// 固定的、由根开始的路径，如 "/favicon.ico"，或由根开始的子树，如 "/images/"，也可以主机名开头</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 一个 Handler 响应一个 HTTP 请求</span><span class="token comment" spellcheck="true">// ServeHTTP 应该将回复的头域和数据写入 ResponseWriter 接口然后返回。返回标志着该请求已经结束，HTTP 服务端可以转移向该连接上的下一个请求。</span><span class="token comment" spellcheck="true">// 在 ServeHTTP 调用结束之后或者并发执行时，使用 ResponseWriter 或者读取请求体是不可取的</span><span class="token comment" spellcheck="true">// handler 应该第一时间读取请求体并作出应答，在向 ResponseWriter 写入数据后就不能读取 request body 了. 同时 handler 不应该修改传入的 request</span><span class="token keyword">type</span> Handler <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>ResponseWriter<span class="token punctuation">,</span> <span class="token operator">*</span>Request<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// HandlerFunc(f) 是一个调用 f 的 handler</span><span class="token keyword">type</span> HandlerFunc <span class="token keyword">func</span><span class="token punctuation">(</span>ResponseWriter<span class="token punctuation">,</span> <span class="token operator">*</span>Request<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// ServeHTTP calls f(w, r).</span><span class="token keyword">func</span> <span class="token punctuation">(</span>f HandlerFunc<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">f</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="请求-响应实例"><a href="#请求-响应实例" class="headerlink" title="请求 - 响应实例"></a>请求 - 响应实例</h3><h4 id="这里实现了一个-404-not-found-响应"><a href="#这里实现了一个-404-not-found-响应" class="headerlink" title="这里实现了一个 404 not found 响应"></a>这里实现了一个 <code>404 not found</code> 响应</h4><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NotFound</span><span class="token punctuation">(</span>w ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"404 page not found"</span><span class="token punctuation">,</span> StatusNotFound<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 定义 handler</span><span class="token keyword">func</span> <span class="token function">NotFoundHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Handler <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">HandlerFunc</span><span class="token punctuation">(</span>NotFound<span class="token punctuation">)</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="server-导出的注册函数使用-DefaultServeMux-相应方法"><a href="#server-导出的注册函数使用-DefaultServeMux-相应方法" class="headerlink" title="server 导出的注册函数使用 DefaultServeMux 相应方法"></a>server 导出的注册函数使用 DefaultServeMux 相应方法</h4><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Handle</span><span class="token punctuation">(</span>pattern <span class="token builtin">string</span><span class="token punctuation">,</span> handler Handler<span class="token punctuation">)</span> <span class="token punctuation">{</span> DefaultServeMux<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> handler<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">HandleFunc</span><span class="token punctuation">(</span>pattern <span class="token builtin">string</span><span class="token punctuation">,</span> handler <span class="token keyword">func</span><span class="token punctuation">(</span>ResponseWriter<span class="token punctuation">,</span> <span class="token operator">*</span>Request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    DefaultServeMux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>mux <span class="token operator">*</span>ServeMux<span class="token punctuation">)</span> <span class="token function">HandleFunc</span><span class="token punctuation">(</span>pattern <span class="token builtin">string</span><span class="token punctuation">,</span> handler <span class="token keyword">func</span><span class="token punctuation">(</span>ResponseWriter<span class="token punctuation">,</span> <span class="token operator">*</span>Request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    mux<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> <span class="token function">HandlerFunc</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>mux <span class="token operator">*</span>ServeMux<span class="token punctuation">)</span> <span class="token function">Handle</span><span class="token punctuation">(</span>pattern <span class="token builtin">string</span><span class="token punctuation">,</span> handler Handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>    mux<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> mux<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> pattern <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"http: invalid pattern"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> handler <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"http: nil handler"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> exist <span class="token operator">:=</span> mux<span class="token punctuation">.</span>m<span class="token punctuation">[</span>pattern<span class="token punctuation">]</span><span class="token punctuation">;</span> exist <span class="token punctuation">{</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"http: multiple registrations for "</span> <span class="token operator">+</span> pattern<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> mux<span class="token punctuation">.</span>m <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        mux<span class="token punctuation">.</span>m <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>muxEntry<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    mux<span class="token punctuation">.</span>m<span class="token punctuation">[</span>pattern<span class="token punctuation">]</span> <span class="token operator">=</span> muxEntry<span class="token punctuation">{</span>h<span class="token punctuation">:</span> handler<span class="token punctuation">,</span> pattern<span class="token punctuation">:</span> pattern<span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 注册成功</span>    <span class="token keyword">if</span> pattern<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'/'</span> <span class="token punctuation">{</span>        mux<span class="token punctuation">.</span>hosts <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="ServeHTTP-调用-Handler-给-request-分派与-request-URL-最匹配的-handler"><a href="#ServeHTTP-调用-Handler-给-request-分派与-request-URL-最匹配的-handler" class="headerlink" title="ServeHTTP 调用 Handler() 给 request 分派与 request URL 最匹配的 handler"></a>ServeHTTP 调用 Handler() 给 request 分派与 request URL 最匹配的 handler</h4><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>mux <span class="token operator">*</span>ServeMux<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> r<span class="token punctuation">.</span>RequestURI <span class="token operator">==</span> <span class="token string">"*"</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> r<span class="token punctuation">.</span><span class="token function">ProtoAtLeast</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// ProtoAtLeast 判断是否大于等于协议最低标准，第一个参数是 major 版本号，第二个参数是 minor 版本号，即 http/1.1</span>            w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Connection"</span><span class="token punctuation">,</span> <span class="token string">"close"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 小于要求则在响应头返回关闭信息</span>        <span class="token punctuation">}</span>        w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>StatusBadRequest<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 状态码 400</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    h<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> mux<span class="token punctuation">.</span><span class="token function">Handler</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>    h<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 调用对应 handler 的 ServeHTTP，即执行注册好的 handler 函数，比如 NotFound 函数</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Handler 通过判断 r.Method, r.Host, and r.URL.Path 返回与 request 对应的 handler</span><span class="token comment" spellcheck="true">// 此函数总会返回非空的 handler. 如果 path 不符合规范形式，返回的是内部生成的重定向到规范路径的 handler</span><span class="token comment" spellcheck="true">// 如果 host 包含端口，匹配 handlers 时会忽略端口。第二个参数返回已注册的与请求匹配的路由</span><span class="token comment" spellcheck="true">// 如果没有已注册的 handler 与请求匹配, 则返回 ``page not found'' handler 和空的 pattern</span><span class="token keyword">func</span> <span class="token punctuation">(</span>mux <span class="token operator">*</span>ServeMux<span class="token punctuation">)</span> <span class="token function">Handler</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span>h Handler<span class="token punctuation">,</span> pattern <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> r<span class="token punctuation">.</span>Method <span class="token operator">==</span> <span class="token string">"CONNECT"</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// redirectToPathSlash 判断 path 是否需要追加 "/"，因为存在 "path + /" 已注册但 "path"</span>        <span class="token comment" spellcheck="true">// 本身未注册的情况。如果需要追加 "/"，则返回追加的 url 和 true</span>        <span class="token keyword">if</span> u<span class="token punctuation">,</span> ok <span class="token operator">:=</span> mux<span class="token punctuation">.</span><span class="token function">redirectToPathSlash</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Host<span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">RedirectHandler</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> StatusMovedPermanently<span class="token punctuation">)</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>Path        <span class="token punctuation">}</span>        <span class="token keyword">return</span> mux<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Host<span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    host <span class="token operator">:=</span> <span class="token function">stripHostPort</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Host<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 去掉 ":&lt;port>"</span>    path <span class="token operator">:=</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 规范 path 格式，比如缺失多余 '/'、存在相对路径'.'、'..' 等</span>    <span class="token keyword">if</span> u<span class="token punctuation">,</span> ok <span class="token operator">:=</span> mux<span class="token punctuation">.</span><span class="token function">redirectToPathSlash</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> path<span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">RedirectHandler</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> StatusMovedPermanently<span class="token punctuation">)</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>Path    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 修改 request 的不规范路径</span>    <span class="token keyword">if</span> path <span class="token operator">!=</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token punctuation">{</span>        <span class="token boolean">_</span><span class="token punctuation">,</span> pattern <span class="token operator">=</span> mux<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> path<span class="token punctuation">)</span>        url <span class="token operator">:=</span> <span class="token operator">*</span>r<span class="token punctuation">.</span>URL        url<span class="token punctuation">.</span>Path <span class="token operator">=</span> path        <span class="token keyword">return</span> <span class="token function">RedirectHandler</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> StatusMovedPermanently<span class="token punctuation">)</span><span class="token punctuation">,</span> pattern    <span class="token punctuation">}</span>    <span class="token keyword">return</span> mux<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 在 ServerMux.handler 中当匹配不到注册的路由时返回 NotFoundHandler</span><span class="token keyword">func</span> <span class="token punctuation">(</span>mux <span class="token operator">*</span>ServeMux<span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>h Handler<span class="token punctuation">,</span> pattern <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    mux<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> mux<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> mux<span class="token punctuation">.</span>hosts <span class="token punctuation">{</span>        h<span class="token punctuation">,</span> pattern <span class="token operator">=</span> mux<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>host <span class="token operator">+</span> path<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// match 根据完整 URL 优先匹配 handler</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        h<span class="token punctuation">,</span> pattern <span class="token operator">=</span> mux<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 如果 URL 匹配不到再根据路径匹配</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        h<span class="token punctuation">,</span> pattern <span class="token operator">=</span> <span class="token function">NotFoundHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://golang.org/pkg/net/http/" target="_blank" rel="noopener">Package http</a></li><li><a href="https://astaxie.gitbooks.io/build-web-application-with-golang/zh/" target="_blank" rel="noopener">Go Web 编程</a></li><li><a href="https://zh.wikipedia.org/wiki/%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AE%E5%8D%8F%E5%95%86" target="_blank" rel="noopener">wiki NPN/ALPN</a></li><li><a href="https://zh.wikipedia.org/wiki/%E5%82%B3%E8%BC%B8%E5%B1%A4%E5%AE%89%E5%85%A8%E6%80%A7%E5%8D%94%E5%AE%9A" target="_blank" rel="noopener">wiki TLS</a></li></ul>]]></content>
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go 源码 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Golang RPC</title>
      <link href="/2018/04-go-rpc.html"/>
      <url>/2018/04-go-rpc.html</url>
      <content type="html"><![CDATA[<p><img src="https://src.wangriyu.wang/images/blog/go/rpc.svg" alt="image"></p><h2 id="1-server"><a href="#1-server" class="headerlink" title="1. server"></a>1. server</h2><h3 id="service-与-server-结构体"><a href="#service-与-server-结构体" class="headerlink" title="service 与 server 结构体"></a>service 与 server 结构体</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">type</span> service <span class="token keyword">struct</span> <span class="token punctuation">{</span>    name   <span class="token builtin">string</span>                 <span class="token comment" spellcheck="true">// 服务名</span>    rcvr   reflect<span class="token punctuation">.</span>Value          <span class="token comment" spellcheck="true">// 服务中函数的接收者</span>    typ    reflect<span class="token punctuation">.</span>Type           <span class="token comment" spellcheck="true">// 接收者类型</span>    method <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>methodType <span class="token comment" spellcheck="true">// 已注册的函数集</span><span class="token punctuation">}</span><span class="token keyword">type</span> Server <span class="token keyword">struct</span> <span class="token punctuation">{</span>    serviceMap sync<span class="token punctuation">.</span>Map   <span class="token comment" spellcheck="true">// 服务对象集合</span>    reqLock    sync<span class="token punctuation">.</span>Mutex <span class="token comment" spellcheck="true">// 请求锁用来保护 freeReq</span>    freeReq    <span class="token operator">*</span>Request    respLock   sync<span class="token punctuation">.</span>Mutex <span class="token comment" spellcheck="true">// 响应锁保护 freeResp</span>    freeResp   <span class="token operator">*</span>Response<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="rpc-Register-调用-DefaultServer-Register，主要实现在内部函数-register-中"><a href="#rpc-Register-调用-DefaultServer-Register，主要实现在内部函数-register-中" class="headerlink" title="rpc.Register 调用 DefaultServer.Register，主要实现在内部函数 register 中"></a>rpc.Register 调用 DefaultServer.Register，主要实现在内部函数 register 中</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Register 在 server 中注册并发布 receiver 的函数集时需满足以下条件:</span><span class="token comment" spellcheck="true">//   * 函数和函数的类型名是已导出的</span><span class="token comment" spellcheck="true">//   * 两个参数都是导出类型 (或內建类型)</span><span class="token comment" spellcheck="true">//   * 第二个参数是指针</span><span class="token comment" spellcheck="true">//   * 函数只有一个类型为 error 的返回类型</span><span class="token comment" spellcheck="true">// 如果 receiver 不是导出的类型或者没有符合条件的函数，将会返回一个错误。Register 将会使用 log 包记录出现的 error</span><span class="token comment" spellcheck="true">// 客户端使用 "Type.Method" 的格式来调用函数，比如上文例子中 Arith.Multiply，这里的 Type 是 receiver 的具体类型.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>server <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">register</span><span class="token punctuation">(</span>rcvr <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> useName <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 新起一个 service 服务对象</span>    s <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>typ <span class="token operator">=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>rcvr<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>rcvr <span class="token operator">=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>rcvr<span class="token punctuation">)</span>    sname <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">Indirect</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>rcvr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 默认服务名是 receiver 的反射类型</span>    <span class="token comment" spellcheck="true">// 在 server.Register 中调用 register(rcvr, "", false)</span>    <span class="token comment" spellcheck="true">// 在 server.RegisterName 中调用 register(rcvr, name, true)</span>    <span class="token comment" spellcheck="true">// 这里使用的 name 可以指定服务对象名，客户端调用 rpc 服务时可以使用 "name.Method" 代替原来的 "Type.Method"</span>    <span class="token keyword">if</span> useName <span class="token punctuation">{</span>        sname <span class="token operator">=</span> name    <span class="token punctuation">}</span>    <span class="token keyword">if</span> sname <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>        s <span class="token operator">:=</span> <span class="token string">"rpc.Register: no service name for type "</span> <span class="token operator">+</span> s<span class="token punctuation">.</span>typ<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        log<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isExported</span><span class="token punctuation">(</span>sname<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>useName <span class="token punctuation">{</span>        s <span class="token operator">:=</span> <span class="token string">"rpc.Register: type "</span> <span class="token operator">+</span> sname <span class="token operator">+</span> <span class="token string">" is not exported"</span>        log<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    s<span class="token punctuation">.</span>name <span class="token operator">=</span> sname    <span class="token comment" spellcheck="true">// 判断传入的接口对象的函数集是否符合 RPC 规范</span>    s<span class="token punctuation">.</span>method <span class="token operator">=</span> <span class="token function">suitableMethods</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>typ<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        str <span class="token operator">:=</span> <span class="token string">""</span>        <span class="token comment" spellcheck="true">// 如果满足条件的函数集为空，根据 s.typ 的指针地址对象是否有符合条件的函数返回错误说明</span>        method <span class="token operator">:=</span> <span class="token function">suitableMethods</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">PtrTo</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>typ<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 此错误说明传入的 s.typ 不符合条件，应该传入 *s.typ</span>            str <span class="token operator">=</span> <span class="token string">"rpc.Register: type "</span> <span class="token operator">+</span> sname <span class="token operator">+</span> <span class="token string">" has no exported methods of suitable type (hint: pass a pointer to value of that type)"</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            str <span class="token operator">=</span> <span class="token string">"rpc.Register: type "</span> <span class="token operator">+</span> sname <span class="token operator">+</span> <span class="token string">" has no exported methods of suitable type"</span>        <span class="token punctuation">}</span>        log<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// LoadOrStore 会检查 sync.Map 类型对象中是否存在传入的键名，如果存在则返回相应的值和 true</span>    <span class="token comment" spellcheck="true">// 反之会先存入键值对再返回值和 false</span>    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> dup <span class="token operator">:=</span> server<span class="token punctuation">.</span>serviceMap<span class="token punctuation">.</span><span class="token function">LoadOrStore</span><span class="token punctuation">(</span>sname<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span> dup <span class="token punctuation">{</span>        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"rpc: service already defined: "</span> <span class="token operator">+</span> sname<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="注册后监听请求"><a href="#注册后监听请求" class="headerlink" title="注册后监听请求"></a>注册后监听请求</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Accept 从监听器上接收获取到的连接并服务每个连接的请求</span><span class="token comment" spellcheck="true">// Accept 在监听器返回非空的错误前都处于阻塞态</span><span class="token comment" spellcheck="true">// 调用者一般应使用 goroutine 启用 Accept，比如 `go server.Accept(l)`</span><span class="token keyword">func</span> <span class="token punctuation">(</span>server <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span>lis net<span class="token punctuation">.</span>Listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">{</span>        conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> lis<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">"rpc.Serve: accept:"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        <span class="token keyword">go</span> server<span class="token punctuation">.</span><span class="token function">ServeConn</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="在-Accept-中调用-ServeConn-函数进行服务"><a href="#在-Accept-中调用-ServeConn-函数进行服务" class="headerlink" title="在 Accept 中调用 ServeConn 函数进行服务"></a>在 Accept 中调用 ServeConn 函数进行服务</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// ServeConn 在一个连接上运行 server 并服务该连接.</span><span class="token comment" spellcheck="true">// ServeConn 在服务该连接到客户端挂起的期间处于阻塞态.</span><span class="token comment" spellcheck="true">// 一般另起线程来调用本函数，比如 `go server.ServeConn(conn)` (Accept 函数中有调用)</span><span class="token comment" spellcheck="true">// ServeConn 在该连接上使用 gob 包的有线格式 (参见 gob 包) .</span><span class="token comment" spellcheck="true">// 如需使用其他备份编解码器, 可以使用 ServeCodec 函数.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>server <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">ServeConn</span><span class="token punctuation">(</span>conn io<span class="token punctuation">.</span>ReadWriteCloser<span class="token punctuation">)</span> <span class="token punctuation">{</span>    buf <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewWriter</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>    srv <span class="token operator">:=</span> <span class="token operator">&amp;</span>gobServerCodec<span class="token punctuation">{</span>        rwc<span class="token punctuation">:</span>    conn<span class="token punctuation">,</span>        dec<span class="token punctuation">:</span>    gob<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">,</span>        enc<span class="token punctuation">:</span>    gob<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span>        encBuf<span class="token punctuation">:</span> buf<span class="token punctuation">,</span>    <span class="token punctuation">}</span>    server<span class="token punctuation">.</span><span class="token function">ServeCodec</span><span class="token punctuation">(</span>srv<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ServeCodec 与 ServeConn 类似，只是使用了指定的编解码器来解码 requests 和编码 responses</span><span class="token keyword">func</span> <span class="token punctuation">(</span>server <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">ServeCodec</span><span class="token punctuation">(</span>codec ServerCodec<span class="token punctuation">)</span> <span class="token punctuation">{</span>    sending <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">)</span>    wg <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">{</span>        service<span class="token punctuation">,</span> mtype<span class="token punctuation">,</span> req<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> replyv<span class="token punctuation">,</span> keepReading<span class="token punctuation">,</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">readRequest</span><span class="token punctuation">(</span>codec<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 读取请求信息</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> debugLog <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"rpc:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token operator">!</span>keepReading <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 如果读请求的 header 就出错了，keepReading 为 false，跳出此循环；如果能读取 header 信息便继续</span>                <span class="token keyword">break</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 发送一个 response 表示此请求无效</span>            <span class="token keyword">if</span> req <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                server<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>sending<span class="token punctuation">,</span> req<span class="token punctuation">,</span> invalidRequest<span class="token punctuation">,</span> codec<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                server<span class="token punctuation">.</span><span class="token function">freeRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">go</span> service<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> sending<span class="token punctuation">,</span> wg<span class="token punctuation">,</span> mtype<span class="token punctuation">,</span> req<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> replyv<span class="token punctuation">,</span> codec<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 没有 request 后需等待 response 发送完成再关闭 codec</span>    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    codec<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="客户端请求某个服务后，服务端在-ServeCodec-中通过调用-service-call-调用相应服务"><a href="#客户端请求某个服务后，服务端在-ServeCodec-中通过调用-service-call-调用相应服务" class="headerlink" title="客户端请求某个服务后，服务端在 ServeCodec 中通过调用 service.call 调用相应服务"></a>客户端请求某个服务后，服务端在 ServeCodec 中通过调用 service.call 调用相应服务</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>service<span class="token punctuation">)</span> <span class="token function">call</span><span class="token punctuation">(</span>server <span class="token operator">*</span>Server<span class="token punctuation">,</span> sending <span class="token operator">*</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">,</span> wg <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">,</span> mtype <span class="token operator">*</span>methodType<span class="token punctuation">,</span> req <span class="token operator">*</span>Request<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> replyv reflect<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> codec ServerCodec<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> wg <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    mtype<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    mtype<span class="token punctuation">.</span>numCalls<span class="token operator">++</span>    mtype<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    function <span class="token operator">:=</span> mtype<span class="token punctuation">.</span>method<span class="token punctuation">.</span>Func    <span class="token comment" spellcheck="true">// 执行函数, 返回新的值给 reply</span>    returnValues <span class="token operator">:=</span> function<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Value<span class="token punctuation">{</span>s<span class="token punctuation">.</span>rcvr<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> replyv<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 返回值里的错误</span>    errInter <span class="token operator">:=</span> returnValues<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    errmsg <span class="token operator">:=</span> <span class="token string">""</span>    <span class="token keyword">if</span> errInter <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        errmsg <span class="token operator">=</span> errInter<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 发送响应，然后释放当前请求节点</span>    server<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>sending<span class="token punctuation">,</span> req<span class="token punctuation">,</span> replyv<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> codec<span class="token punctuation">,</span> errmsg<span class="token punctuation">)</span>    server<span class="token punctuation">.</span><span class="token function">freeRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="HTTP-方式"><a href="#HTTP-方式" class="headerlink" title="HTTP 方式"></a>HTTP 方式</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// ServeHTTP 实现一个用于回应 RPC 请求的 http.Handler</span><span class="token keyword">func</span> <span class="token punctuation">(</span>server <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> req<span class="token punctuation">.</span>Method <span class="token operator">!=</span> <span class="token string">"CONNECT"</span> <span class="token punctuation">{</span>        w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/plain; charset=utf-8"</span><span class="token punctuation">)</span>        w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusMethodNotAllowed<span class="token punctuation">)</span>        io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"405 must CONNECT\n"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    conn<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> w<span class="token punctuation">.</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>Hijacker<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Hijack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 让调用者主动接管连接</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">"rpc hijacking "</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">,</span> <span class="token string">": "</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token string">"HTTP/1.0 "</span><span class="token operator">+</span>connected<span class="token operator">+</span><span class="token string">"\n\n"</span><span class="token punctuation">)</span>    server<span class="token punctuation">.</span><span class="token function">ServeConn</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// HandleHTTP 注册 server 的 RPC 信息到 rpcPath 上，注册 server 的 debug 信息到 debugPath 上</span><span class="token comment" spellcheck="true">// HandleHTTP 会注册到 http.DefaultServeMux 上</span><span class="token comment" spellcheck="true">// 之后，仍需要调用 http.Serve()，一般会另起线程："go http.Serve(l, nil)"</span><span class="token keyword">func</span> <span class="token punctuation">(</span>server <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">HandleHTTP</span><span class="token punctuation">(</span>rpcPath<span class="token punctuation">,</span> debugPath <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>rpcPath<span class="token punctuation">,</span> server<span class="token punctuation">)</span>    http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>debugPath<span class="token punctuation">,</span> debugHTTP<span class="token punctuation">{</span>server<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-client"><a href="#2-client" class="headerlink" title="2. client"></a>2. client</h2><p><img src="https://src.wangriyu.wang/images/blog/go/RPC-Client.png" alt="image"><br></p><h3 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Call 代表一个活跃的 RPC.</span><span class="token keyword">type</span> Call <span class="token keyword">struct</span> <span class="token punctuation">{</span>    ServiceMethod <span class="token builtin">string</span>      <span class="token comment" spellcheck="true">// 调用的服务名</span>    Args          <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 函数传入参数 (*struct)</span>    Reply         <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 函数返回结果 (*struct)</span>    Error         <span class="token builtin">error</span>       <span class="token comment" spellcheck="true">// 结束后的错误状态</span>    Done          <span class="token keyword">chan</span> <span class="token operator">*</span>Call  <span class="token comment" spellcheck="true">// 非空表示一个 rpc 调用结束</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Client 代表一个 RPC 客户端，同一个客户端可能有多个未返回的调用，也可能被多个 go 线程同时使用</span><span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">{</span>    codec ClientCodec    reqMutex sync<span class="token punctuation">.</span>Mutex <span class="token comment" spellcheck="true">// 保护 request</span>    request  Request    mutex    sync<span class="token punctuation">.</span>Mutex <span class="token comment" spellcheck="true">// 保护 seq</span>    seq      <span class="token builtin">uint64</span> <span class="token comment" spellcheck="true">// 一个序列值，request 和 response 会以此标识</span>    pending  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint64</span><span class="token punctuation">]</span><span class="token operator">*</span>Call <span class="token comment" spellcheck="true">// 等待响应的 Call 集合</span>    closing  <span class="token builtin">bool</span> <span class="token comment" spellcheck="true">// 用户已调用 Close</span>    shutdown <span class="token builtin">bool</span> <span class="token comment" spellcheck="true">// 服务器已告知停止</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ClientCodec 接口实现了 RPC 会话的客户端一侧 RPC 请求的写入和 RPC 响应的读取。</span><span class="token comment" spellcheck="true">// 客户端调用 WriteRequest 来写入请求到连接，然后成对调用 ReadRsponseHeader 和</span><span class="token comment" spellcheck="true">// ReadResponseBody 以读取响应。客户端在结束该连接的事务时调用 Close 方法。</span><span class="token comment" spellcheck="true">// ReadResponseBody 可以使用 nil 参数调用，以强制回复的主体被读取然后丢弃。</span><span class="token keyword">type</span> ClientCodec <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// WriteRequest 必须能安全的被多个 go 协程同时使用</span>    <span class="token function">WriteRequest</span><span class="token punctuation">(</span><span class="token operator">*</span>Request<span class="token punctuation">,</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>    <span class="token function">ReadResponseHeader</span><span class="token punctuation">(</span><span class="token operator">*</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span>    <span class="token function">ReadResponseBody</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>    <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="客户端获取-Client-对象"><a href="#客户端获取-Client-对象" class="headerlink" title="客户端获取 Client 对象"></a>客户端获取 Client 对象</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// DialHTTP 通过地址连向一个 HTTP RPC server (建立 HTTP 连接)</span><span class="token keyword">func</span> <span class="token function">DialHTTP</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Client<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">DialHTTPPath</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> address<span class="token punctuation">,</span> DefaultRPCPath<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// DialHTTPPath 通过地址和路径连向一个 HTTP RPC server</span><span class="token keyword">func</span> <span class="token function">DialHTTPPath</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> address<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Client<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> err <span class="token builtin">error</span>    conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> address<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token string">"CONNECT "</span><span class="token operator">+</span>path<span class="token operator">+</span><span class="token string">" HTTP/1.0\n\n"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 在切换 RPC 协议前需要保证成功的 HTTP 响应</span>    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">ReadResponse</span><span class="token punctuation">(</span>bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">{</span>Method<span class="token punctuation">:</span> <span class="token string">"CONNECT"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> resp<span class="token punctuation">.</span>Status <span class="token operator">==</span> connected <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">NewClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        err <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"unexpected HTTP response: "</span> <span class="token operator">+</span> resp<span class="token punctuation">.</span>Status<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>net<span class="token punctuation">.</span>OpError<span class="token punctuation">{</span>        Op<span class="token punctuation">:</span>   <span class="token string">"dial-http"</span><span class="token punctuation">,</span>        Net<span class="token punctuation">:</span>  network <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> address<span class="token punctuation">,</span>        Addr<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>        Err<span class="token punctuation">:</span>  err<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Dial 通过指定的地址连向一个 RPC server (建立 TCP 连接)</span><span class="token keyword">func</span> <span class="token function">Dial</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Client<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> address<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token function">NewClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="新建-Client-对象"><a href="#新建-Client-对象" class="headerlink" title="新建 Client 对象"></a>新建 Client 对象</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewClient</span><span class="token punctuation">(</span>conn io<span class="token punctuation">.</span>ReadWriteCloser<span class="token punctuation">)</span> <span class="token operator">*</span>Client <span class="token punctuation">{</span>    encBuf <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewWriter</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>    client <span class="token operator">:=</span> <span class="token operator">&amp;</span>gobClientCodec<span class="token punctuation">{</span>conn<span class="token punctuation">,</span> gob<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">,</span> gob<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>encBuf<span class="token punctuation">)</span><span class="token punctuation">,</span> encBuf<span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token function">NewClientWithCodec</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">NewClientWithCodec</span><span class="token punctuation">(</span>codec ClientCodec<span class="token punctuation">)</span> <span class="token operator">*</span>Client <span class="token punctuation">{</span>    client <span class="token operator">:=</span> <span class="token operator">&amp;</span>Client<span class="token punctuation">{</span>        codec<span class="token punctuation">:</span>   codec<span class="token punctuation">,</span>        pending<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint64</span><span class="token punctuation">]</span><span class="token operator">*</span>Call<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token keyword">go</span> client<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 另起线程接收 response</span>    <span class="token keyword">return</span> client<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="从连接中读取-response-根据-seq-找到-pending-集合中对应的-Call-对象，获取响应内容，Done-结束"><a href="#从连接中读取-response-根据-seq-找到-pending-集合中对应的-Call-对象，获取响应内容，Done-结束" class="headerlink" title="从连接中读取 response, 根据 seq 找到 pending 集合中对应的 Call 对象，获取响应内容，Done 结束"></a>从连接中读取 response, 根据 seq 找到 pending 集合中对应的 Call 对象，获取响应内容，Done 结束</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>client <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> err <span class="token builtin">error</span>    <span class="token keyword">var</span> response Response    <span class="token keyword">for</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        response <span class="token operator">=</span> Response<span class="token punctuation">{</span><span class="token punctuation">}</span>        err <span class="token operator">=</span> client<span class="token punctuation">.</span>codec<span class="token punctuation">.</span><span class="token function">ReadResponseHeader</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>response<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">break</span>        <span class="token punctuation">}</span>        seq <span class="token operator">:=</span> response<span class="token punctuation">.</span>Seq        client<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        call <span class="token operator">:=</span> client<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>seq<span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 等待队列中的对应当前 response 的序列号的 Call 对象</span>        <span class="token function">delete</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>pending<span class="token punctuation">,</span> seq<span class="token punctuation">)</span>        client<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">switch</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> call <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>            <span class="token comment" spellcheck="true">// call == nil 代表等待序列中没有对应的 Call 对象，一般意味着 WriteRequest 时失败了并且 call 已经被删去</span>            <span class="token comment" spellcheck="true">// 返回的 response 是读取错误 request 的错误信息</span>            err <span class="token operator">=</span> client<span class="token punctuation">.</span>codec<span class="token punctuation">.</span><span class="token function">ReadResponseBody</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                err <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"reading error body: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token keyword">case</span> response<span class="token punctuation">.</span>Error <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">:</span>            <span class="token comment" spellcheck="true">// 获取到一个错误响应. 将这个传给 Call;</span>            call<span class="token punctuation">.</span>Error <span class="token operator">=</span> <span class="token function">ServerError</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>Error<span class="token punctuation">)</span>            err <span class="token operator">=</span> client<span class="token punctuation">.</span>codec<span class="token punctuation">.</span><span class="token function">ReadResponseBody</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                err <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"reading error body: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>            call<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">default</span><span class="token punctuation">:</span>            err <span class="token operator">=</span> client<span class="token punctuation">.</span>codec<span class="token punctuation">.</span><span class="token function">ReadResponseBody</span><span class="token punctuation">(</span>call<span class="token punctuation">.</span>Reply<span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                call<span class="token punctuation">.</span>Error <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"reading body "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>            call<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 关闭等待中的 calls.</span>    client<span class="token punctuation">.</span>reqMutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    client<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    client<span class="token punctuation">.</span>shutdown <span class="token operator">=</span> <span class="token boolean">true</span>    closing <span class="token operator">:=</span> client<span class="token punctuation">.</span>closing    <span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>        <span class="token keyword">if</span> closing <span class="token punctuation">{</span>            err <span class="token operator">=</span> ErrShutdown        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            err <span class="token operator">=</span> io<span class="token punctuation">.</span>ErrUnexpectedEOF        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> call <span class="token operator">:=</span> <span class="token keyword">range</span> client<span class="token punctuation">.</span>pending <span class="token punctuation">{</span>        call<span class="token punctuation">.</span>Error <span class="token operator">=</span> err        call<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    client<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    client<span class="token punctuation">.</span>reqMutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> debugLog <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> io<span class="token punctuation">.</span>EOF <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>closing <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"rpc: client protocol error:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Client-使用不同函数去调取-rpc-服务，Go-可以异步执行，Call-是同步的"><a href="#Client-使用不同函数去调取-rpc-服务，Go-可以异步执行，Call-是同步的" class="headerlink" title="Client 使用不同函数去调取 rpc 服务，Go 可以异步执行，Call 是同步的"></a>Client 使用不同函数去调取 rpc 服务，Go 可以异步执行，Call 是同步的</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Go 异步地执行函数. 本方法 Call 结构体类型指针的返回值代表该次远程调用.</span><span class="token comment" spellcheck="true">// 通道类型的参数 done 会在本次调用完成时发出信号（通过返回本次 Go 方法的返回值）</span><span class="token comment" spellcheck="true">// 如果 done 为 nil，Go 会申请一个新的通道（写入返回值的 Done 字段）</span><span class="token comment" spellcheck="true">// 如果 done 非 nil，done 必须有缓冲，否则 Go 方法会崩溃。</span><span class="token keyword">func</span> <span class="token punctuation">(</span>client <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">Go</span><span class="token punctuation">(</span>serviceMethod <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> reply <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> done <span class="token keyword">chan</span> <span class="token operator">*</span>Call<span class="token punctuation">)</span> <span class="token operator">*</span>Call <span class="token punctuation">{</span>    call <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Call<span class="token punctuation">)</span>    call<span class="token punctuation">.</span>ServiceMethod <span class="token operator">=</span> serviceMethod    call<span class="token punctuation">.</span>Args <span class="token operator">=</span> args    call<span class="token punctuation">.</span>Reply <span class="token operator">=</span> reply    <span class="token keyword">if</span> done <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        done <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>Call<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// buffered.</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果调用者传的 done != nil，则必须确保通道有足够的缓冲来给多个同步 RPCs 使用</span>        <span class="token comment" spellcheck="true">// 如果通道完全没有缓冲，最好不要去运行</span>        <span class="token keyword">if</span> <span class="token function">cap</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token string">"rpc: done channel is unbuffered"</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    call<span class="token punctuation">.</span>Done <span class="token operator">=</span> done    client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span>    <span class="token keyword">return</span> call<span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Call 调用传入名的远程服务，并等待结束返回结果和错误状态</span><span class="token keyword">func</span> <span class="token punctuation">(</span>client <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">Call</span><span class="token punctuation">(</span>serviceMethod <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> reply <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    call <span class="token operator">:=</span> <span class="token operator">&lt;-</span>client<span class="token punctuation">.</span><span class="token function">Go</span><span class="token punctuation">(</span>serviceMethod<span class="token punctuation">,</span> args<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>Call<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Done    <span class="token keyword">return</span> call<span class="token punctuation">.</span>Error<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Go-中调用的函数"><a href="#Go-中调用的函数" class="headerlink" title="Go 中调用的函数"></a>Go 中调用的函数</h3><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>client <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">send</span><span class="token punctuation">(</span>call <span class="token operator">*</span>Call<span class="token punctuation">)</span> <span class="token punctuation">{</span>    client<span class="token punctuation">.</span>reqMutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> client<span class="token punctuation">.</span>reqMutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 将 call 转入等待集合</span>    client<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> client<span class="token punctuation">.</span>shutdown <span class="token operator">||</span> client<span class="token punctuation">.</span>closing <span class="token punctuation">{</span>        call<span class="token punctuation">.</span>Error <span class="token operator">=</span> ErrShutdown    client<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        call<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    seq <span class="token operator">:=</span> client<span class="token punctuation">.</span>seq    client<span class="token punctuation">.</span>seq<span class="token operator">++</span>    client<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>seq<span class="token punctuation">]</span> <span class="token operator">=</span> call    client<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 将 request 编码并发送</span>    client<span class="token punctuation">.</span>request<span class="token punctuation">.</span>Seq <span class="token operator">=</span> seq    client<span class="token punctuation">.</span>request<span class="token punctuation">.</span>ServiceMethod <span class="token operator">=</span> call<span class="token punctuation">.</span>ServiceMethod    err <span class="token operator">:=</span> client<span class="token punctuation">.</span>codec<span class="token punctuation">.</span><span class="token function">WriteRequest</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token punctuation">.</span>request<span class="token punctuation">,</span> call<span class="token punctuation">.</span>Args<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        client<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        call <span class="token operator">=</span> client<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>seq<span class="token punctuation">]</span>        <span class="token function">delete</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>pending<span class="token punctuation">,</span> seq<span class="token punctuation">)</span>        client<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> call <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            call<span class="token punctuation">.</span>Error <span class="token operator">=</span> err            call<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-jsonrpc"><a href="#3-jsonrpc" class="headerlink" title="3. jsonrpc"></a>3. jsonrpc</h2><p>jsonrpc 主要将 gob 序列化工具换成 json 序列化工具，主要函数还是调用 server 里的 FuncWithCodec 函数，原理基本一致</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://www.gitbook.com/book/smallnest/go-rpc-programming-guide/details" target="_blank" rel="noopener">Go RPC 开发指南</a></li><li><a href="http://colobu.com/2016/09/18/go-net-rpc-guide/" target="_blank" rel="noopener">Go 官方库 RPC 开发指南</a></li><li><a href="https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/08.4.md" target="_blank" rel="noopener">build-web-application-with-golang</a></li><li><a href="https://en.wikipedia.org/wiki/Remote_procedure_call" target="_blank" rel="noopener">rpc wikipedia</a></li><li><a href="https://technet.microsoft.com/en-us/library/cc738291%28v=ws.10%29.aspx?f=255&amp;MSPPError=-2147217396" target="_blank" rel="noopener">How RPC Works</a></li></ul>]]></content>
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go 源码 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>PKI 体系</title>
      <link href="/2018/04-http-pki.html"/>
      <url>/2018/04-http-pki.html</url>
      <content type="html"><![CDATA[<h2 id="中间人攻击和信息抵赖"><a href="#中间人攻击和信息抵赖" class="headerlink" title="中间人攻击和信息抵赖"></a>中间人攻击和信息抵赖</h2><p>没有身份验证的情况下，在非对称加密中实现身份验证和密钥协商时，比如常用的 RSA 算法无法确保服务器身份的合法性，因为公钥并不包含服务器的信息。可能出现如下两种情况:</p><ul><li>中间人攻击 (MITM): 攻击者介入通信双方，C - M 通信时使用的是中间人自己的一对公私钥 Key_M，中间人可以解密客户端用 Key_M 加密的信看;<br>M - S 通信时使用的是服务器提供的公钥，加密从客户端得到的消息给服务器完成双方通信</li><li>信息抵赖: 发送消息者可以否认之前发过的消息，因为接收端使用公钥不能确定之前接收的消息来源身份</li></ul><p><img src="https://src.wangriyu.wang/images/blog/http/MITM.png" alt="image"></p><p>此时需要一种认证体系以确保通信者是安全可靠的。</p><h2 id="PKI-互联网公钥基础设施"><a href="#PKI-互联网公钥基础设施" class="headerlink" title="PKI - 互联网公钥基础设施"></a>PKI - 互联网公钥基础设施</h2><p><strong>PKI</strong> 的目标就是实现不同成员在不见面的情况下进行安全通信，当前采用的模型是基于可信的第三方机构，也就是 <strong>证书颁发机构 (certification authority，CA)</strong> 签发的证书。<br>PKI 通过数字证书认证机构 (CA) 将用户的个人身份跟公开密钥链接在一起。对每个证书中心用户的身份必须是唯一的。链接关系由注册和发布过程确定，取决于担保级别，链接关系可能由 CA 的各种软件或在人为监督下完成。</p><p><img src="https://src.wangriyu.wang/images/blog/http/PKI.png" alt="image"></p><ul><li>订阅人: 或者叫最终实体，是指那些需要证书来提供安全服务的团体，维护服务端的人</li><li>登记机构 (registration authority - RA): 主要是完成一些证书签发的相关管理工作。例如， RA 会首先对用户进行必要的身份验证，然后才会去找 CA 签发证书。在某些情况下，<br>当 CA 希望在用户附近建立一个分支机构时（例如在不同的国家建立当地登记中心），我们也称 RA 为本地登记机构（local registration authority，LRA）。实际上，很多 CA 也执行 RA 的职责。RA 确保公开密钥和个人身份链接，可以防抵赖。</li><li>凭证签发请求文件 (Certificate Signing Request - CSR): 一种包含凭证签发时所需的公钥、组织信息、个人信息 (域名) 等信息的 (.csr) 文件，不含私钥信息。</li><li>证书颁发机构 (certification authority - CA): 是指我们都信任的证书颁发机构，CA 通过线上、线下等多种手段验证申请者提供信息的真实性，如组织是否存在、企业是否合法，是否拥有域名的所有权等，确认申请用户的身份之后再签发证书。<br>同时 CA 会在线提供其所签发证书的最新吊销信息，这样信赖方就可以验证证书是否仍然有效。</li><li>证书 (certificate) 包含以下信息：申请者公钥、申请者的组织信息和个人信息、签发机构 CA 的信息、有效时间、证书序列号等信息的明文，同时包含一个签名（使用散列函数计算公开的明文信息的信息摘要，<br>然后采用 CA 的私钥对信息摘要进行加密，此密文即签名）。<strong>证书 = 公钥 + 申请者与颁发者信息 + 签名</strong></li><li>信赖方 (relying party): 是指那些证书使用者。一般是指那些需要证书验证的网页浏览器、其他程序以及操作系统。他们通过维护根可信证书库来执行验证，<br>这些证书库包含某些 CA 的最终可信证书（信任密钥，trust anchor）。更广泛地说，信赖方是指那些需要通过证书在互联网上进行安全通信的最终用户。用户接收到证书后，读取证书中的相关的明文信息，采用相同的散列函数计算得到信息摘要，<br>然后利用对应 CA 的公钥解密签名数据，对比证书的信息摘要，如果一致，则可以确认证书的合法性；然后去查询证书的吊销情况</li></ul><p><img src="https://src.wangriyu.wang/images/blog/http/certificate-status.png" alt="image"></p><ul><li>证书吊销列表 (Certificate Revocation List - CRL): 一个单独的文件。该文件包含了 CA 已经吊销的证书序列号 (唯一) 与吊销日期，同时该文件包含生效日期并通知下次更新该文件的时间，当然该文件必然包含 CA 私钥的签名以验证文件的合法性。<br>证书中一般会包含一个 URL 地址 CRL Distribution Point，通知使用者去哪里下载对应的 CRL 以校验证书是否吊销。该吊销方式的优点是不需要频繁更新，但是不能及时吊销证书，因为 CRL 更新时间一般是几天，这期间可能已经造成了极大损失。</li><li>证书状态在线查询协议 (Online Certificate Status Protocol - OCSP): 一个实时查询证书是否吊销的方式。请求者发送证书的信息并请求查询，服务器返回正常、吊销或未知中的任何一个状态。证书中一般也会包含一个 OCSP 的 URL 地址，要求查询服务器具有良好的性能。<br>部分 CA 或大部分的 <a href="https://zh.wikipedia.org/wiki/%E5%85%AC%E9%96%8B%E9%87%91%E9%91%B0%E8%AA%8D%E8%AD%89#%E8%87%AA%E7%B0%BD%E8%AD%89%E6%9B%B8" target="_blank" rel="noopener">自签 CA (根证书)</a> 都是未提供 CRL 或 OCSP 地址的，对于吊销证书会是一件非常麻烦的事情。</li></ul><p>一个具体实例: <a href="https://zh.wikipedia.org/wiki/%E5%85%AC%E9%96%8B%E9%87%91%E9%91%B0%E8%AA%8D%E8%AD%89#%E7%94%B3%E9%A0%98%E5%8F%8A%E4%BD%BF%E7%94%A8" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/%E5%85%AC%E9%96%8B%E9%87%91%E9%91%B0%E8%AA%8D%E8%AD%89#%E7%94%B3%E9%A0%98%E5%8F%8A%E4%BD%BF%E7%94%A8</a></p><h2 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h2><h3 id="证书大致分为三类"><a href="#证书大致分为三类" class="headerlink" title="证书大致分为三类"></a>证书大致分为三类</h3><ul><li>自签名 CA: 在自签名 CA 中，证书中的公钥和用于验证证书的密钥是相同的。一些自签名 CA 是根 CA。这种自签名证书通常不会被广泛信任，使用时可能会遇到电脑软件的安全警告。自签名证书本身就是根证书。</li><li>从属 CA: 在从属 CA 中，证书中的公钥和用于核实证书的密钥是不同的。一个 CA 向另一个 CA 颁发证书的过程叫做交叉认证 。</li><li>根 CA: 根 CA 是一种特殊的 CA，它受到客户无条件地信任，位于证书层次结构的最高层。所有证书链均终止于根 CA。根颁发机构必须对它自己的证书签名，因为在证书层次结构中再也没有更高的认证机构了。根证书也是自签名证书。</li></ul><p>其他的还可以细分为中介证书、终端实体证书、授权证书、TLS 服务器证书、通配符证书、TLS 客户端证书</p><h3 id="审核级别-担保级别"><a href="#审核级别-担保级别" class="headerlink" title="审核级别 (担保级别)"></a>审核级别 (担保级别)</h3><ul><li>域名验证 (DV): 最基本的审核级别，如果申领代表可以证明他拥有管理某域名的权力，认证机构就可以发放域名验证（DV）证书，一般认证机构通常使用自动机制或通过电邮确认审核域名拥有权，成本较低</li><li>组织验证 (OV): 代表可以证明他拥有管理某域名的权力，而且相关组织是实际存在的法人，认证机构可以发放组织验证（OV）证书。审核程序通常需要经过人手处理。</li><li>扩展验证 (EV): 最严格的审核级别，审核过程可能牵涉专业法律人员的调查及独立审计人员的确认，成本也更高；成功获得扩展验证证书的网站，浏览器通常会在地址栏以绿色表示相关机构的法人名称及所属国家代码。扩展验证证书的主体名称或主体别名上不可以有通配符</li></ul><h3 id="证书结构"><a href="#证书结构" class="headerlink" title="证书结构"></a>证书结构</h3><p><img src="https://src.wangriyu.wang/images/blog/http/certificate-struct.png" alt="image"></p><ul><li>版本号 (version): 证书一共有 3 个版本号，分别用 0、1、2 编码表示版本 1、版本 2 和版本 3。版本 1 只支持简单的字段，版本 2 增加了两个标识符，而版本 3 则增加了扩展功能。现在大部分的证书都采用版本 3 的格式。</li><li>序列号 (serialNumber): 在一开始，序列号只要是正整数即可，是每个 CA 用来唯一标识其所签发的证书。但是在出现了针对证书签名的预选 <a href="http://www.freebuf.com/articles/database/133391.html" target="_blank" rel="noopener">前缀攻击</a> 之后，序列号增加了更多的要求来防止此类攻击；现在序列号需要是无序的（无法被预测）而且至少包括 20 位的熵</li><li>签名算法 (signture Algorithm): 这个字段指明证书签名所用的算法，需要放到证书里面，这样才能被证书签名保护</li><li>颁发者 (issuer): 证书颁发者的可分辨名称（distinguished name，DN），这个字段比较复杂，根据不同的实体会包含许多部分。举例来说，Verisign 根证书的可分辨名称是 /C=US/O=VeriSign, Inc./OU=Class 3 Public Primary Certification Authority；它包括了国家、组织和组织单位三个部分。</li><li>有效期 (validity): 证书的有效期包括开始日期和结束日期，在这段时间内证书是有效的。</li><li>使用者 (subject): 证书使用实体的可分辨名称，和公钥一起用于证书的签发。在自签名证书里，使用者 (subject) 和颁发者 (issuer) 字段的可分辨名称是一样的。在最开始，可分辨名称里面的公用名（common name， CN）主要用于服务器主机名（例如 /CN=<a href="http://www.example.com" target="_blank" rel="noopener">www.example.com</a> 用于 <a href="http://www.example.com" target="_blank" rel="noopener">www.example.com</a> 域名的证书）</li><li>公钥 (subject public-key info): 这个字段包含了公钥、算法 ID、可选参数</li><li>扩展 (extensions): 比如密钥用法、证书策略、CRL 分发点、使用者密钥标识符等等</li></ul><p><img src="https://src.wangriyu.wang/images/blog/http/github-certificate.png" alt="image"></p><h3 id="证书链"><a href="#证书链" class="headerlink" title="证书链"></a>证书链</h3><p>CA 根证书和服务器实体证书中间增加一层证书机构，即中介证书，证书的产生和验证原理不变，只是增加一层验证，只要最后能够被任何信任的 CA 根证书验证合法即可</p><ol><li>服务器证书 server.pem 的签发者为中间证书机构 inter，inter 根据证书 inter.pem 验证 server.pem 确实为自己签发的有效证书;</li><li>中间证书 inter.pem 的签发 CA 为 root，root 根据证书 root.pem 验证 inter.pem 为自己签发的合法证书;</li><li>客户端内置信任 CA 的 root.pem 证书，因此服务器证书 server.pem 被信任。</li></ol><p><img src="https://src.wangriyu.wang/images/blog/http/certificate-chain.png" alt="certificate-chain"></p><p><img src="https://src.wangriyu.wang/images/blog/http/ssllabs-certificate-chain.png" alt="ssllabs-certificate-chain"></p><p>具体例子可以看维基百科的例子: <a href="https://zh.wikipedia.org/wiki/%E4%BF%A1%E4%BB%BB%E9%8F%88#%E8%88%89%E4%BE%8B" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/%E4%BF%A1%E4%BB%BB%E9%8F%88#%E8%88%89%E4%BE%8B</a></p><p>点击浏览器地址栏的绿色小锁可以查看网站的证书链:</p><p><img src="https://src.wangriyu.wang/images/blog/http/chrome-certificate-chain.png" alt="chrome-certificate-chain"></p><p>二级证书结构存在的优势：</p><ul><li>减少根证书结构的管理工作量，可以更高效的进行证书的审核与签发;</li><li>根证书一般内置在客户端中，私钥一般离线存储，一旦私钥泄露，则吊销过程非常困难，无法及时补救;</li><li>中介证书结构的私钥泄露，则可以快速在线吊销，并重新为用户签发新的证书;</li><li>证书链四级以内一般不会对 HTTPS 的性能造成明显影响</li></ul><p>服务器一般提供一条证书链，但也有多条路径的可能。以 <a href="https://blog.csdn.net/fangwm2011/article/details/6623887" target="_blank" rel="noopener">交叉证书</a> 为例，一条可信路径可以一直到 CA 的主要根证书，另外一条则是到可选根证书上。<br>CA 有时候会为同样的密钥签发多张证书，例如现在最常使用的签名算法是 SHA1，因为安全原因正在逐步迁移到 SHA256， CA 可以使用同样的密钥签发出不同签名的新证书。如果信赖方恰好有两张这样的证书，那么就可以构建出两条不同的可信路径。</p><h2 id="身份验证"><a href="#身份验证" class="headerlink" title="身份验证"></a>身份验证</h2><p>再回过头来看中间人攻击，需要身份验证后中间人与 Server 通信时接收服务器的证书实现身份验证，但与客户端通信时无法向用户提供可信任的证书。</p><p><img src="https://src.wangriyu.wang/images/blog/http/MITM-Cert.png" alt="image"></p><p>除非伪造一份证书 (很困难)，或者骗取客户端信任，比如在客户机操作系统上添加中间人证书的完全信任，以此实现用户的信任和身份验证。</p><p>举个栗子:</p><p>使用抓包工具 Charles 时，如果想抓取 HTTPS 的内容，就需要安装其提供的证书并添加信任</p><p><img src="https://src.wangriyu.wang/images/blog/http/Charles.png" alt="image"></p><p>没有信任时，抓取的 HTTPS 内容无法解析</p><p><img src="https://src.wangriyu.wang/images/blog/http/nossl.png" alt="image"></p><p>取得信任后，抓取的 HTTPS 请求可以和 HTTP 请求一样直接读取</p><p><img src="https://src.wangriyu.wang/images/blog/http/withssl.png" alt="image"></p><p>在这个过程中 Charles 就是一个中间人，而且可以完全获取 HTTPS 信息，因为用户安装并信任它的证书，也就可以做到身份验证。</p><blockquote><p>可以看到加密协议下所有连接都是 Connect 形式，这涉及到 <a href="https://zh.wikipedia.org/wiki/%E9%9A%A7%E9%81%93%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener">隧道协议 - Tunneling Protocol</a> 的概念</p></blockquote><p>使用隧道的原因是在不兼容的网络上传输数据，或在不安全网络上提供一个安全路径。</p><p>隧道通信的机制如下:</p><pre class="line-numbers language-http"><code class="language-http">The client asks an HTTP Proxy server to tunnel the TCP connection to the desired destination.The server then proceeds to make the connection on behalf of the client. Once the connection has been established by the server,the Proxy server continues to proxy the TCP stream to and from the client.The client is now being proxied to the remote host.Any data sent to the proxy server is now forwarded, unmodified, to the remote host and the client can communicate using any protocol accepted by the remote hostProxy servers may also limit connections by only allowing connections to the default HTTPS port 443, whitelisting hosts, or blocking traffic which doesn't appear to be SSL.客户端先请求一个代理服务器去建立和目标服务器之间的 tcp tunnel，目标服务器尝试连接客户端 (实际是代理服务器)，如果连接成功建立，代理服务器会给客户端返回 200 ok 并继续代理客户端和目标服务器之间的 tcp 流。任何发送给代理服务器的数据都会不加修改地被转发，远程主机和客户端可以通过任何协议 (TLS、SSH、SOCKS、PPTP...) 进行后续交互。代理服务器也可以通过端口限制 (443)、host 白名单、阻止非 SSL 的数据流来限制连接<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一些代理服务器需要认证信息来建立 tunnel. 常见的是 Proxy-Authorization 头域:</p><pre class="line-numbers language-http"><code class="language-http">CONNECT server.example.com:80 HTTP/1.1<span class="token header-name keyword">Host:</span> server.example.com:80<span class="token header-name keyword">Proxy-Authorization:</span> basic aGVsbG86d29ybGQ=<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>关于这个中间代理的详细信息见 <a href="https://en.wikipedia.org/wiki/DMZ_(computing)" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/DMZ_(computing)</a></p><h2 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h2><p>讲到 Charles，不得不提另一个抓包工具 Wireshark。这两个工具的抓包原理不同，Charles 是通过代理过滤抓取本机的网络请求，主要抓 HTTP、HTTPS 的请求；<br>Wireshark 则是使用了 <a href="https://zh.wikipedia.org/wiki/%E6%B7%B7%E6%9D%82%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener">网卡混杂模式 - promiscuous mode</a>，可以抓取指定网卡上所有流过的包，可以抓取应用层、传输层、网络层的各种封包，但是正常情况下不能解析 HTTPS 的内容 (可以通过配置浏览器提供的对称协商密钥或者服务器的私钥来解密 TLS 内容)。</p><p>开启混杂模式时除了可以看到自己电脑上的网络封包，还可以看到目标地址不是本机的网络包 (如果路由器没有做网络分发的工作的话，完全有可能接收到其他电脑的网络包)，还可以看到局域网内的广播等等。我看了一篇于此相关的网络攻击手段 - <a href="https://zhuanlan.zhihu.com/p/28818627" target="_blank" rel="noopener">ARP 攻击</a>。</p><p>ARP（Address Resolution Protocol）即地址解析协议， 用于实现从 IP 地址到 MAC 地址的映射，即询问目标 IP 对应的 MAC 地址，如图</p><p><img src="https://src.wangriyu.wang/images/blog/http/ARP.png" alt="image"></p><p>而 ARP 攻击者可以通过两种方式实现抓取监听局域网内全部或者想要的目标的网络数据:</p><ul><li>通过大密集的 ARP 回应抢占或覆盖路由的映射表，使路由以为攻击者就是目标，然后把 ip 映射到错误对象的 mac 上，之后攻击者便能接收目标 ip 的网络数据</li><li>在局域网内向所有 ip 客户机广播，假装自己是网关，然后所有目标机器向自己发送外网或者转发请求数据</li></ul><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://zh.wikipedia.org/wiki/%E5%85%AC%E9%96%8B%E9%87%91%E9%91%B0%E5%9F%BA%E7%A4%8E%E5%BB%BA%E8%A8%AD" target="_blank" rel="noopener">PKI - wiki</a></li><li><a href="https://www.wosign.com/faq/faq2016-0309-03.htm" target="_blank" rel="noopener">PKI 体系</a></li><li><a href="https://zh.wikipedia.org/wiki/%E4%BF%A1%E4%BB%BB%E9%8F%88" target="_blank" rel="noopener">信任链 - wiki</a></li><li><a href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB" target="_blank" rel="noopener">MITM</a></li><li><a href="https://zh.wikipedia.org/wiki/%E5%85%AC%E9%96%8B%E9%87%91%E9%91%B0%E8%AA%8D%E8%AD%89" target="_blank" rel="noopener">数字证书 - wiki</a></li><li><a href="https://zh.wikipedia.org/wiki/%E6%95%B8%E4%BD%8D%E7%B0%BD%E7%AB%A0" target="_blank" rel="noopener">数字签名 - wiki</a></li><li><a href="https://en.wikipedia.org/wiki/HTTP_tunnel" target="_blank" rel="noopener">http tunnel</a></li><li><a href="https://en.wikipedia.org/wiki/Tunneling_protocol" target="_blank" rel="noopener">Tunneling protocol</a></li><li><a href="https://zh.wikipedia.org/wiki/%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8" target="_blank" rel="noopener">代理服务器 - wiki</a></li><li><a href="https://zh.wikipedia.org/wiki/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86" target="_blank" rel="noopener">反向代理 - wiki</a></li></ul>]]></content>
      
      <categories>
          
          <category> http </category>
          
      </categories>
      
      
        <tags>
            
            <tag> http 扩展阅读 </tag>
            
            <tag> 网络 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>SSL/TLS 详解</title>
      <link href="/2018/03-http-tls.html"/>
      <url>/2018/03-http-tls.html</url>
      <content type="html"><![CDATA[<h2 id="1-TLS-定义"><a href="#1-TLS-定义" class="headerlink" title="1. TLS 定义"></a>1. TLS 定义</h2><p><strong>SSL</strong>(Secure Sockets Layer) 安全套接层，是一种安全协议，经历了 SSL 1.0、2.0、3.0 版本后发展成了标准安全协议 - <strong>TLS</strong>(Transport Layer Security) 传输层安全性协议。TLS 有 1.0 (RFC 2246)、1.1(RFC 4346)、1.2(RFC 5246)、1.3(RFC 8446) 版本。</p><p>TLS 在实现上分为 <strong>记录层</strong> 和 <strong>握手层</strong> 两层，其中握手层又含四个子协议: 握手协议 (handshake protocol)、更改加密规范协议 (change cipher spec protocol)、应用数据协议 (application data protocol) 和警告协议 (alert protocol)</p><p><img src="https://src.wangriyu.wang/images/blog/http/tls.png" alt="image"></p><h2 id="2-HTTPS-HTTP-over-TLS"><a href="#2-HTTPS-HTTP-over-TLS" class="headerlink" title="2. HTTPS = HTTP over TLS."></a>2. HTTPS = HTTP over TLS.</h2><p>只需配置浏览器和服务器相关设置开启 TLS，即可实现 HTTPS，TLS 高度解耦，可装可卸，与上层高级应用层协议相互协作又相互独立。</p><p><img src="https://src.wangriyu.wang/images/blog/http/https.png" alt="image"></p><h2 id="3-加密"><a href="#3-加密" class="headerlink" title="3. 加密"></a>3. 加密</h2><p>TLS/SSL 的功能实现主要依赖于三类基本算法：散列函数 Hash、对称加密和非对称加密，其利用非对称加密实现身份认证和密钥协商，对称加密算法采用协商的密钥对数据加密，基于散列函数验证信息的完整性。</p><p><img src="https://src.wangriyu.wang/images/blog/http/encrypt.png" alt="image"></p><p>TLS 的基本工作方式是，客户端使用非对称加密与服务器进行通信，实现身份验证并协商对称加密使用的密钥，然后对称加密算法采用协商密钥对信息以及信息摘要进行加密通信，不同的节点之间采用的对称密钥不同，从而可以保证信息只能通信双方获取。</p><p>例如，在 HTTPS 协议中，客户端发出请求，服务端会将公钥发给客户端，客户端验证过后生成一个密钥再用公钥加密后发送给服务端（非对称加密），双方会在 TLS 握手过程中生成一个协商密钥（对称密钥），成功后建立加密连接。通信过程中客户端将请求数据用协商密钥加密后发送，服务端也用协商密钥解密，响应也用相同的协商密钥。后续的通信使用对称加密是因为对称加解密快，而握手过程中非对称加密可以保证加密的有效性，但是过程复杂，计算量相对来说也大。</p><h2 id="4-记录层"><a href="#4-记录层" class="headerlink" title="4. 记录层"></a>4. 记录层</h2><p>记录协议负责在传输连接上交换的所有底层消息，并且可以配置加密。每一条 TLS 记录以一个短标头开始。标头包含记录内容的类型 (或子协议)、协议版本和长度。原始消息经过分段 (或者合并)、压缩、添加认证码、加密转为 TLS 记录的数据部分。</p><p><img src="https://src.wangriyu.wang/images/blog/http/message.png" alt="image"></p><h3 id="分片-Fragmentation"><a href="#分片-Fragmentation" class="headerlink" title="分片 (Fragmentation)"></a>分片 (Fragmentation)</h3><p>记录层将信息块分割成携带 2^14 字节 (16KB) 或更小块的数据的 TLSPlaintext 记录。</p><p>记录协议传输由其他协议层提交给它的不透明数据缓冲区。如果缓冲区超过记录的长度限制（2^14），记录协议会将其切分成更小的片段。反过来也是可能的，属于同一个子协议的小缓冲区也可以组合成一个单独的记录。</p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">struct</span> <span class="token punctuation">{</span>  <span class="token builtin">uint8</span> major<span class="token punctuation">,</span> minor<span class="token punctuation">;</span><span class="token punctuation">}</span> ProtocolVersion<span class="token punctuation">;</span>enum <span class="token punctuation">{</span>  <span class="token function">change_cipher_spec</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">handshake</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">application_data</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">}</span> ContentType<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>  ContentType <span class="token keyword">type</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 用于处理封闭片段的较高级协议</span>  ProtocolVersion version<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 使用的安全协议版本</span>  <span class="token builtin">uint16</span> length<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// TLSPlaintext.fragment 的长度（以字节为单位），不超过 2^14</span>  opaque fragment<span class="token punctuation">[</span>TLSPlaintext<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 透明的应用数据，被视为独立的块，由类型字段指定的较高级协议处理</span><span class="token punctuation">}</span> TLSPlaintext<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="记录压缩和解压缩-Record-compression-and-decompression"><a href="#记录压缩和解压缩-Record-compression-and-decompression" class="headerlink" title="记录压缩和解压缩 (Record compression and decompression)"></a>记录压缩和解压缩 (Record compression and decompression)</h3><p>压缩算法将 TLSPlaintext 结构转换为 TLSCompressed 结构。如果定义 CompressionMethod 为 null 表示不压缩</p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">struct</span> <span class="token punctuation">{</span>  ContentType <span class="token keyword">type</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// same as TLSPlaintext.type</span>  ProtocolVersion version<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// same as TLSPlaintext.version</span>  <span class="token builtin">uint16</span> length<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// TLSCompressed.fragment 的长度，不超过 2^14 + 1024</span>  opaque fragment<span class="token punctuation">[</span>TLSCompressed<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span> TLSCompressed<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="空或标准流加密-Null-or-standard-stream-cipher"><a href="#空或标准流加密-Null-or-standard-stream-cipher" class="headerlink" title="空或标准流加密 (Null or standard stream cipher)"></a>空或标准流加密 (Null or standard stream cipher)</h3><p>流加密（BulkCipherAlgorithm）将 TLSCompressed.fragment 结构转换为流 TLSCiphertext.fragment 结构</p><pre class="line-numbers language-go"><code class="language-go">stream<span class="token operator">-</span>ciphered <span class="token keyword">struct</span> <span class="token punctuation">{</span>    opaque content<span class="token punctuation">[</span>TLSCompressed<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>    opaque MAC<span class="token punctuation">[</span>CipherSpec<span class="token punctuation">.</span>hash_size<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span> GenericStreamCipher<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>MAC 产生方法如下：</p><pre class="line-numbers language-go"><code class="language-go"><span class="token function">HMAC_hash</span><span class="token punctuation">(</span>MAC_write_secret<span class="token punctuation">,</span> seq_num <span class="token operator">+</span> TLSCompressed<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">+</span> TLSCompressed<span class="token punctuation">.</span>version <span class="token operator">+</span> TLSCompressed<span class="token punctuation">.</span>length <span class="token operator">+</span> TLSCompressed<span class="token punctuation">.</span>fragment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>seq_num（记录的序列号）、hash（SecurityParameters.mac_algorithm 指定的哈希算法）</p><blockquote><p>MAC(Message authentication code) - 消息认证码</p></blockquote><blockquote><p>注意，MAC 是在加密之前计算的。流加密加密整个块，包括 MAC。对于不使用同步向量 (例如 RC4) 的流加密，从一个记录结尾处的流加密状态仅用于后续数据包。如果 CipherSuite 是 TLS_NULL_WITH_NULL_NULL，则加密由身份操作 (数据未加密，MAC 大小为零，暗示不使用 MAC) 组成。TLSCiphertext.length 是 TLSCompressed.length 加上 CipherSpec.hash_size。</p></blockquote><h3 id="CBC-块加密-分组加密"><a href="#CBC-块加密-分组加密" class="headerlink" title="CBC 块加密 (分组加密)"></a>CBC 块加密 (分组加密)</h3><p>块加密（如 RC2 或 DES），将 TLSCompressed.fragment 结构转换为块 TLSCiphertext.fragment 结构</p><pre class="line-numbers language-go"><code class="language-go">block<span class="token operator">-</span>ciphered <span class="token keyword">struct</span> <span class="token punctuation">{</span>  opaque content<span class="token punctuation">[</span>TLSCompressed<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>  opaque MAC<span class="token punctuation">[</span>CipherSpec<span class="token punctuation">.</span>hash_size<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token builtin">uint8</span> padding<span class="token punctuation">[</span>GenericBlockCipher<span class="token punctuation">.</span>padding_length<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token builtin">uint8</span> padding_length<span class="token punctuation">;</span><span class="token punctuation">}</span> GenericBlockCipher<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>padding: 添加的填充将明文长度强制为块密码块长度的整数倍。填充可以是长达 255 字节的任何长度，只要满足 TLSCiphertext.length 是块长度的整数倍。长度大于需要的值可以阻止基于分析交换信息长度的协议攻击。填充数据向量中的每个 uint8 必须填入填充长度值 (即 padding_length)。</p><p>padding_length: 填充长度应该使得 GenericBlockCipher 结构的总大小是加密块长度的倍数。合法值范围从零到 255（含）。<strong>该长度指定 padding_length 字段本身除外的填充字段的长度</strong></p><p>加密块的数据长度（TLSCiphertext.length）是 TLSCompressed.length，CipherSpec.hash_size 和 padding_length 的总和加一</p><blockquote><p>示例: 如果块长度为 8 字节，压缩内容长度（TLSCompressed.length）为 61 字节，MAC 长度为 20 字节，则填充前的长度为 82 字节（padding_length 占 1 字节）。<br>因此，为了使总长度为块长度 (8 字节) 的偶数倍，模 8 的填充长度必须等于 6，所以填充长度可以为 6，14，22 等。如果填充长度是需要的最小值，比如 6，填充将为 6 字节，每个块都包含值 6。因此，块加密之前的 GenericBlockCipher 的最后 8 个八位字节将为 xx 06 06 06 06 06 06 06，其中 xx 是 MAC 的最后一个八位字节。</p><pre class="line-numbers language-http"><code class="language-http">XX  - 06 06 06 06 06 06 - 06MAC -     padding[6]    - padding_length<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></blockquote><h3 id="记录有效载荷保护-Record-payload-protection"><a href="#记录有效载荷保护-Record-payload-protection" class="headerlink" title="记录有效载荷保护 (Record payload protection)"></a>记录有效载荷保护 (Record payload protection)</h3><p>加密和 MAC 功能将 TLSCompressed 结构转换为 TLSCiphertext。记录的 MAC 还包括序列号，以便可以检测到丢失，额外或重复的消息。</p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">struct</span> <span class="token punctuation">{</span>  ContentType <span class="token keyword">type</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// same</span>  ProtocolVersion version<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// same</span>  <span class="token builtin">uint16</span> length<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// TLSCiphertext.fragment 的长度，不超过 2^14 + 2048</span>  <span class="token keyword">select</span> <span class="token punctuation">(</span>CipherSpec<span class="token punctuation">.</span>cipher_type<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> stream<span class="token punctuation">:</span> GenericStreamCipher<span class="token punctuation">;</span>    <span class="token keyword">case</span> block<span class="token punctuation">:</span> GenericBlockCipher<span class="token punctuation">;</span>  <span class="token punctuation">}</span> fragment<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// TLSCompressed.fragment 的加密形式，带有 MAC</span><span class="token punctuation">}</span> TLSCiphertext<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>注意<br>这里提到的都是先 MAC 再加密，是基于 RFC 2246 的方案 (TLS 1.0) 写的。但新的方案选择先加密再 MAC，这种替代方案中，首先对明文和填充进行加密，再将结果交给 MAC 算法。这可以保证主动网络攻击者不能操纵任何加密数据。</p></blockquote><h3 id="密钥计算-Key-calculation"><a href="#密钥计算-Key-calculation" class="headerlink" title="密钥计算 (Key calculation)"></a>密钥计算 (Key calculation)</h3><p>记录协议需要一种算法，从握手协议提供的安全性参数生成密钥、<a href="https://zh.wikipedia.org/wiki/%E5%88%9D%E5%A7%8B%E5%90%91%E9%87%8F" target="_blank" rel="noopener">IV</a> 和 MAC secret.</p><p>主密钥 (Master secret): 在连接中双方共享的一个 48 字节的密钥<br>客户随机数 (client random): 由客户端提供的 32 字节值<br>服务器随机数 (server random): 由服务器提供的 32 字节值</p><h2 id="5-握手层"><a href="#5-握手层" class="headerlink" title="5. 握手层"></a>5. 握手层</h2><ul><li>握手协议的职责是生成通信过程所需的共享密钥和进行身份认证。这部分使用无密码套件，为防止数据被窃听，通过公钥密码或 Diffie-Hellman 密钥交换技术通信。</li><li>密码规格变更协议，用于密码切换的同步，是在握手协议之后的协议。握手协议过程中使用的协议是“不加密”这一密码套件，握手协议完成后则使用协商好的密码套件。</li><li>警告协议，当发生错误时使用该协议通知通信对方，如握手过程中发生异常、消息认证码错误、数据无法解压缩等。</li><li>应用数据协议，通信双方真正进行应用数据传输的协议，传送过程通过 TLS 应用数据协议和 TLS 记录协议来进行传输。</li></ul><p>握手是 TLS 协议中最精密复杂的部分。在这个过程中，通信双方协商连接参数，并且完成身 份验证。根据使用的功能的不同，整个过程通常需要交换 6~10 条消息。根据配置和支持的协议扩展的不同，交换过程可能有许多变种。在使用中经常可以观察到以下三种流程：(1) 完整的握手， 对服务器进行身份验证；(2) 恢复之前的会话采用的简短握手；(3) 对客户端和服务器都进行身份验证的握手。</p><p>握手协议消息的标头信息包含消息类型（1 字节）和长度（3 字节），余下的信息则取决于消息类型：</p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">struct</span> <span class="token punctuation">{</span>  HandshakeType msg_type<span class="token punctuation">;</span>  uint24 length<span class="token punctuation">;</span>  HandshakeMessage message<span class="token punctuation">;</span><span class="token punctuation">}</span> Handshake<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-1-完整握手"><a href="#5-1-完整握手" class="headerlink" title="5.1 完整握手"></a>5.1 完整握手</h3><p>每一个 TLS 连接都会以握手开始。如果客户端此前并未与服务器建立会话，那么双方会执行一次完整的握手流程来协商 TLS 会话。握手过程中，客户端和服务器将进行以下四个主要步骤:</p><ul><li>交换各自支持的功能，对需要的连接参数达成一致</li><li>验证出示的证书，或使用其他方式进行身份验证</li><li>对将用于保护会话的共享主密钥达成一致</li><li>验证握手消息并未被第三方团体修改</li></ul><p>下面介绍最常见的握手规则，一种不需要验证客户端身份但需要验证服务器身份的握手:</p><p><img src="https://src.wangriyu.wang/images/blog/http/full-handshake.png" alt="image"></p><h4 id="5-1-1-ClientHello"><a href="#5-1-1-ClientHello" class="headerlink" title="5.1.1 ClientHello"></a>5.1.1 ClientHello</h4><p>这条消息将客户端的功能和首选项传送给服务器。</p><p><img src="https://src.wangriyu.wang/images/blog/http/wireshark-clienthello.png" alt="image"></p><ul><li>Version: 协议版本（protocol version）指示客户端支持的最佳协议版本</li><li>Random: 一个 32 字节数据，28 字节是随机生成的 (图中的 Random Bytes)；剩余的 4 字节包含额外的信息，与客户端时钟有关 (图中使用的是 GMT Unix Time)。在握手时，客户端和服务器都会提供随机数，客户端的暂记作 random_C (用于后续的密钥的生成)。这种随机性对每次握手都是独一无二的，在身份验证中起着举足轻重的作用。它可以防止 <a href="https://zh.wikipedia.org/wiki/%E9%87%8D%E6%94%BE%E6%94%BB%E5%87%BB" target="_blank" rel="noopener">重放攻击</a>，并确认初始数据交换的完整性。</li><li>Session ID: 在第一次连接时，会话 ID（session ID）字段是空的，这表示客户端并不希望恢复某个已存在的会话。典型的会话 ID 包含 32 字节随机生成的数据，一般由服务端生成通过 ServerHello 返回给客户端。</li><li>Cipher Suites: 密码套件（cipher suite）块是由客户端支持的所有密码套件组成的列表，该列表是按优先级顺序排列的</li><li>Compression: 客户端可以提交一个或多个支持压缩的方法。默认的压缩方法是 null，代表没有压缩</li><li>Extensions: 扩展（extension）块由任意数量的扩展组成。这些扩展会携带额外数据</li></ul><h4 id="5-1-2-ServerHello"><a href="#5-1-2-ServerHello" class="headerlink" title="5.1.2 ServerHello"></a>5.1.2 ServerHello</h4><p>是将服务器选择的连接参数传回客户端。</p><p><img src="https://src.wangriyu.wang/images/blog/http/wireshark-serverhello.png" alt="image"></p><p>这个消息的结构与 ClientHello 类似，只是每个字段只包含一个选项，其中包含服务端的 random_S 参数 (用于后续的密钥协商)。服务器无需支持客户端支持的最佳版本。如果服务器不支持与客户端相同的版本，可以提供某个其他版本以期待客户端能够接受</p><p>图中的 <code>Cipher Suite</code> 是后续密钥协商和身份验证要用的加密套件，此处选择的密钥交换与签名算法是 ECDHE_RSA，对称加密算法是 AES-GCM，后面会讲到这个</p><p>还有一点默认情况下 TLS 压缩都是关闭的，因为 <a href="https://zh.wikipedia.org/wiki/CRIME" target="_blank" rel="noopener">CRIME</a> 攻击会利用 TLS 压缩恢复加密认证 cookie，实现会话劫持，而且一般配置 gzip 等内容压缩后再压缩 TLS 分片效益不大又额外占用资源，所以一般都关闭 TLS 压缩</p><h4 id="5-1-3-Certificate"><a href="#5-1-3-Certificate" class="headerlink" title="5.1.3 Certificate"></a>5.1.3 Certificate</h4><p>典型的 Certificate 消息用于携带服务器 X.509 <a href="https://zh.wikipedia.org/wiki/%E4%BF%A1%E4%BB%BB%E9%8F%88" target="_blank" rel="noopener">证书链</a>。<br>服务器必须保证它发送的证书与选择的算法套件一致。比方说，公钥算法与套件中使用的必须匹配。除此以外，一些密钥交换算法依赖嵌入证书的特定数据，而且要求证书必须以客户端支持的算法签名。所有这些都表明服务器需要配置多个证书（每个证书可能会配备不同的证书链）。</p><p><img src="https://src.wangriyu.wang/images/blog/http/wireshark-certificate.png" alt="image"></p><p>Certificate 消息是可选的，因为并非所有套件都使用身份验证，也并非所有身份验证方法都需要证书。更进一步说，虽然消息默认使用 X.509 证书，但是也可以携带其他形式的标志；一些套件就依赖 <a href="https://zh.wikipedia.org/wiki/PGP" target="_blank" rel="noopener">PGP 密钥</a></p><h4 id="5-1-4-ServerKeyExchange"><a href="#5-1-4-ServerKeyExchange" class="headerlink" title="5.1.4 ServerKeyExchange"></a>5.1.4 ServerKeyExchange</h4><p>携带密钥交换需要的额外数据。ServerKeyExchange 是可选的，消息内容对于不同的协商算法套件会存在差异。部分场景下，比如使用 RSA 算法时，服务器不需要发送此消息。</p><p>ServerKeyExchange 仅在服务器证书消息（也就是上述 Certificate 消息）不包含足够的数据以允许客户端交换预主密钥（premaster secret）时才由服务器发送。</p><p>比如基于 DH 算法的握手过程中，需要单独发送一条 ServerKeyExchange 消息带上 DH 参数:</p><p><img src="https://src.wangriyu.wang/images/blog/http/wireshark-serverhellodone.png" alt="image"></p><h4 id="5-1-5-ServerHelloDone"><a href="#5-1-5-ServerHelloDone" class="headerlink" title="5.1.5 ServerHelloDone"></a>5.1.5 ServerHelloDone</h4><p>表明服务器已经将所有预计的握手消息发送完毕。在此之后，服务器会等待客户端发送消息。</p><h4 id="5-1-6-verify-certificate"><a href="#5-1-6-verify-certificate" class="headerlink" title="5.1.6 verify certificate"></a>5.1.6 verify certificate</h4><p>客户端验证证书的合法性，如果验证通过才会进行后续通信，否则根据错误情况不同做出提示和操作，合法性验证内容包括如下:</p><ul><li>证书链的可信性 trusted certificate path;</li><li>证书是否吊销 revocation，有两类方式 - 离线 CRL 与在线 OCSP，不同的客户端行为会不同;</li><li>有效期 expiry date，证书是否在有效时间范围;</li><li>域名 domain，核查证书域名是否与当前的访问域名匹配;</li></ul><p>由 <code>PKI 体系</code> 的内容可知，对端发来的证书签名是 CA 私钥加密的，接收到证书后，先读取证书中的相关的明文信息，采用相同的散列函数计算得到信息摘要，然后利用对应 CA 的公钥解密签名数据，对比证书的信息摘要，如果一致，则可以确认证书的合法性；然后去查询证书的吊销情况等</p><h4 id="5-1-7-ClientKeyExchange"><a href="#5-1-7-ClientKeyExchange" class="headerlink" title="5.1.7 ClientKeyExchange"></a>5.1.7 ClientKeyExchange</h4><p>合法性验证通过之后，客户端计算产生随机数字的预主密钥（Pre-master），并用证书公钥加密，发送给服务器并携带客户端为密钥交换提供的所有信息。这个消息受协商的密码套件的影响，内容随着不同的协商密码套件而不同。</p><p>此时客户端已经获取全部的计算协商密钥需要的信息: 两个明文随机数 random_C 和 random_S 与自己计算产生的 Pre-master，然后得到协商密钥(用于之后的消息加密)</p><pre class="line-numbers language-go"><code class="language-go">enc_key <span class="token operator">=</span> <span class="token function">PRF</span><span class="token punctuation">(</span>Pre_master<span class="token punctuation">,</span> <span class="token string">"master secret"</span><span class="token punctuation">,</span> random_C <span class="token operator">+</span> random_S<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://src.wangriyu.wang/images/blog/http/wireshark-clientkeychange.png" alt="image"></p><p>图中使用的是 ECDHE 算法，ClientKeyExchange 传递的是 DH 算法的客户端参数，如果使用的是 RSA 算法则此处应该传递加密的预主密钥</p><h4 id="5-1-8-ChangeCipherSpec"><a href="#5-1-8-ChangeCipherSpec" class="headerlink" title="5.1.8 ChangeCipherSpec"></a>5.1.8 ChangeCipherSpec</h4><p>通知服务器后续的通信都采用协商的通信密钥和加密算法进行加密通信</p><blockquote><p>注意<br>ChangeCipherSpec 不属于握手消息，它是另一种协议，只有一条消息，作为它的子协议进行实现。</p></blockquote><h4 id="5-1-9-Finished-Encrypted-Handshake-Message"><a href="#5-1-9-Finished-Encrypted-Handshake-Message" class="headerlink" title="5.1.9 Finished (Encrypted Handshake Message)"></a>5.1.9 Finished (Encrypted Handshake Message)</h4><p>Finished 消息意味着握手已经完成。消息内容将加密，以便双方可以安全地交换验证整个握手完整性所需的数据。</p><p>这个消息包含 verify_data 字段，它的值是握手过程中所有消息的散列值。这些消息在连接两端都按照各自所见的顺序排列，并以协商得到的主密钥 (enc_key) 计算散列。这个过程是通过一个伪随机函数（pseudorandom function，PRF）来完成的，这个函数可以生成任意数量的伪随机数据。<br>两端的计算方法一致，但会使用不同的标签（finished_label）：客户端使用 client finished，而服务器则使用 server finished。</p><pre class="line-numbers language-go"><code class="language-go">verify_data <span class="token operator">=</span> <span class="token function">PRF</span><span class="token punctuation">(</span>master_secret<span class="token punctuation">,</span> finished_label<span class="token punctuation">,</span> <span class="token function">Hash</span><span class="token punctuation">(</span>handshake_messages<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>因为 Finished 消息是加密的，并且它们的完整性由协商 MAC 算法保证，所以主动网络攻击者不能改变握手消息并对 vertify_data 的值造假。在 TLS 1.2 版本中，Finished 消息的长度默认是 12 字节（96 位），并且允许密码套件使用更长的长度。在此之前的版本，除了 SSL 3 使用 36 字节的定长消息，其他版本都使用 12 字节的定长消息。</p><h4 id="5-1-10-Server"><a href="#5-1-10-Server" class="headerlink" title="5.1.10 Server"></a>5.1.10 Server</h4><p>服务器用私钥解密加密的 Pre-master 数据，基于之前交换的两个明文随机数 random_C 和 random_S，同样计算得到协商密钥: <code>enc_key = PRF(Pre_master, &quot;master secret&quot;, random_C + random_S)</code>;</p><p>同样计算之前所有收发信息的 hash 值，然后用协商密钥解密客户端发送的 verify_data_C，验证消息正确性;</p><h4 id="5-1-11-change-cipher-spec"><a href="#5-1-11-change-cipher-spec" class="headerlink" title="5.1.11 change_cipher_spec"></a>5.1.11 change_cipher_spec</h4><p><img src="https://src.wangriyu.wang/images/blog/http/wireshark-serverchangecipher.png" alt="image"></p><p>服务端验证通过之后，服务器同样发送 change_cipher_spec 以告知客户端后续的通信都采用协商的密钥与算法进行加密通信（图中多了一步 New Session Ticket，此为会话票证，会在会话恢复中解释）;</p><h4 id="5-1-12-Finished-Encrypted-Handshake-Message"><a href="#5-1-12-Finished-Encrypted-Handshake-Message" class="headerlink" title="5.1.12 Finished (Encrypted Handshake Message)"></a>5.1.12 Finished (Encrypted Handshake Message)</h4><p>服务器也结合所有当前的通信参数信息生成一段数据 (verify_data_S) 并采用协商密钥 session secret (enc_key) 与算法加密并发送到客户端;</p><h4 id="5-1-13-握手结束"><a href="#5-1-13-握手结束" class="headerlink" title="5.1.13 握手结束"></a>5.1.13 握手结束</h4><p>客户端计算所有接收信息的 hash 值，并采用协商密钥解密 verify_data_S，验证服务器发送的数据和密钥，验证通过则握手完成;</p><h4 id="5-1-14-加密通信"><a href="#5-1-14-加密通信" class="headerlink" title="5.1.14 加密通信"></a>5.1.14 加密通信</h4><p>开始使用协商密钥与算法进行加密通信。</p><p><img src="https://src.wangriyu.wang/images/blog/http/wireshark-applicationdata.png" alt="image"></p><h3 id="5-2-密钥交换和签名算法"><a href="#5-2-密钥交换和签名算法" class="headerlink" title="5.2 密钥交换和签名算法"></a>5.2 密钥交换和签名算法</h3><h4 id="常用的密钥交换和签名算法"><a href="#常用的密钥交换和签名算法" class="headerlink" title="常用的密钥交换和签名算法"></a>常用的密钥交换和签名算法</h4><p>HTTPS 通过 TLS 层和证书机制提供了内容加密、身份认证和数据完整性三大功能。加密过程中，需要用到非对称密钥交换和对称内容加密两大算法。</p><p>对称内容加密强度非常高，加解密速度也很快，只是无法安全地生成和保管密钥。在 TLS 协议中，最后的应用数据都是经过对称加密后传输的，传输中所使用的对称协商密钥(上文中的 enc_key)，则是在握手阶段通过非对称密钥交换而来。常见的 AES-GCM、ChaCha20-Poly1305，都是对称加密算法。</p><p>非对称密钥交换能在不安全的数据通道中，产生只有通信双方才知道的对称加密密钥。目前最常用的密钥交换算法有 RSA 和 ECDHE。</p><p>RSA 历史悠久，支持度好，但不支持 <a href="https://zh.wikipedia.org/wiki/%E5%89%8D%E5%90%91%E5%AE%89%E5%85%A8%E6%80%A7" target="_blank" rel="noopener">完美前向安全 - PFS(Perfect Forward Secrecy)</a>；而 ECDHE 是使用了 ECC（椭圆曲线）的 DH（Diffie-Hellman）算法，计算速度快，且支持 PFS。</p><p>在 <code>PKI 体系</code> 一节中说明了仅有非对称密钥交换还是无法抵御 MITM 攻击的，所以需要引入了 PKI 体系的证书来进行身份验证，其中服务端非对称加密产生的公钥会放在证书中传给客户端。</p><p>在 RSA 密钥交换中，浏览器使用证书提供的 RSA 公钥加密相关信息，如果服务端能解密，意味着服务端拥有与公钥对应的私钥，同时也能算出对称加密所需密钥。密钥交换和服务端认证合并在一起。</p><p>在 ECDH 密钥交换中，服务端使用私钥 (RSA 或 ECDSA) 对相关信息进行签名，如果浏览器能用证书公钥验证签名，就说明服务端确实拥有对应私钥，从而完成了服务端认证。密钥交换则是各自发送 DH 参数完成的，密钥交换和服务端认证是完全分开的。</p><p>可用于 ECDHE 数字签名的算法主要有 <a href="https://zh.wikipedia.org/wiki/RSA%E5%8A%A0%E5%AF%86%E6%BC%94%E7%AE%97%E6%B3%95" target="_blank" rel="noopener">RSA</a> 和 <a href="https://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm" target="_blank" rel="noopener">ECDSA - 椭圆曲线数字签名算法</a>，也就是目前密钥交换 + 签名有三种主流选择:</p><ul><li><code>RSA</code> - RSA 密钥交换（无需签名）</li><li><code>ECDHE_RSA</code> - ECDHE 密钥交换、RSA 签名</li><li><code>ECDHE_ECDSA</code> - ECDHE 密钥交换、ECDSA 签名</li></ul><p><img src="https://src.wangriyu.wang/images/blog/http/signatureAlgorithm.png" alt="image"></p><p>比如我的网站使用的加密套件是 ECDHE_RSA，可以看到数字签名算法是 sha256 哈希加 RSA 加密，在 <code>PKI 体系</code> 一节中讲了签名是服务器信息摘要的哈希值加密生成的</p><p>内置 ECDSA 公钥的证书一般被称之为 ECC 证书，内置 RSA 公钥的证书就是 RSA 证书。因为 256 位 ECC Key 在安全性上等同于 3072 位 RSA Key，所以 ECC 证书体积比 RSA 证书小，而且 ECC 运算速度更快，ECDHE 密钥交换 + ECDSA 数字签名是目前最好的加密套件</p><p>以上内容来自本文: <a href="https://imququ.com/post/ecc-certificate.html" target="_blank" rel="noopener">开始使用 ECC 证书</a></p><p>关于 ECC 证书的更多细节可见文档: <a href="https://www.rfc-editor.org/rfc/rfc4492.txt" target="_blank" rel="noopener">ECC Cipher Suites for TLS - RFC4492</a></p><h4 id="RSA-密钥交换和-DH-密钥交换的区别"><a href="#RSA-密钥交换和-DH-密钥交换的区别" class="headerlink" title="RSA 密钥交换和 DH 密钥交换的区别"></a>RSA 密钥交换和 DH 密钥交换的区别</h4><p>使用 RSA 进行密钥交换的握手过程与前面说明的基本一致，只是没有 ServerKeyExchange 消息，其中协商密钥涉及到三个参数 (客户端随机数 random_C、服务端随机数 random_S、预主密钥 Premaster secret)，<br>其中前两个随机数和协商使用的算法是明文的很容易获取，最后一个 Premaster secret 会用服务器提供的公钥加密后传输给服务器 (密钥交换)，如果这个预主密钥被截取并破解则协商密钥也可以被破解。</p><p>RSA 算法的细节见: <a href="https://zh.wikipedia.org/wiki/RSA%E5%8A%A0%E5%AF%86%E6%BC%94%E7%AE%97%E6%B3%95" target="_blank" rel="noopener">wiki</a> 和 <a href="http://www.ruanyifeng.com/blog/2013/07/rsa_algorithm_part_two.html" target="_blank" rel="noopener">RSA算法原理（二）- 阮一峰</a></p><p>RSA 的算法核心思想是利用了极大整数 <a href="https://zh.wikipedia.org/wiki/%E6%95%B4%E6%95%B0%E5%88%86%E8%A7%A3" target="_blank" rel="noopener">因数分解</a> 的计算复杂性</p><p>而使用 <a href="https://zh.wikipedia.org/wiki/%E8%BF%AA%E8%8F%B2-%E8%B5%AB%E7%88%BE%E6%9B%BC%E5%AF%86%E9%91%B0%E4%BA%A4%E6%8F%9B" target="_blank" rel="noopener">DH(Diffie-Hellman) 算法</a> 进行密钥交换，双方只要交换各自的 DH 参数(在 ServerKeyExchange 发送 Server params，在 ClientKeyExchange 发送 Client params)，不需要传递 Premaster secret，就可以各自算出这个预主密钥</p><p>DH 的握手过程如下，大致过程与 RSA 类似，图中只表达如何生成预主密钥:</p><p><img src="https://src.wangriyu.wang/images/blog/http/DH-handshake.png" alt="image"></p><p>服务器通过私钥将客户端随机数 random_C，服务端随机数 random_S，服务端 DH 参数 Server params 签名生成 signature，然后在 ServerKeyExchange 消息中发送服务端 DH 参数和该签名；</p><p>客户端收到后用服务器给的公钥解密验证签名，并在 ClientKeyExchange 消息中发送客户端 DH 参数 Client params；</p><p>服务端收到后，双方都有这两个参数，再各自使用这两个参数生成预主密钥 Premaster secret，之后的协商密钥等步骤与 RSA 基本一致。</p><blockquote><p>基于 RSA 算法与 DH 算法的握手最大的区别就在于密钥交换与身份认证。前者客户端使用公钥加密预主密钥并发送给服务端完成密钥交换，服务端利用私钥解密完成身份认证。后者利用各自发送的 DH 参数完成密钥交换，服务器私钥签名数据，客户端公钥验签完成身份认证。</p></blockquote><p>关于 DH 算法如何生成预主密钥，推荐看下 <a href="https://zh.wikipedia.org/wiki/%E8%BF%AA%E8%8F%B2-%E8%B5%AB%E7%88%BE%E6%9B%BC%E5%AF%86%E9%91%B0%E4%BA%A4%E6%8F%9B#%E6%8F%8F%E8%BF%B0" target="_blank" rel="noopener">Wiki</a> 和 <a href="https://blog.cloudflare.com/keyless-ssl-the-nitty-gritty-technical-details/#ephemeraldiffiehellmanhandshake" target="_blank" rel="noopener">Ephemeral Diffie-Hellman handshake</a></p><p>其核心思想是利用了 <a href="https://en.wikipedia.org/wiki/Discrete_logarithm" target="_blank" rel="noopener">离散对数问题</a> 的计算复杂性</p><blockquote><p>原根：假设一个整数 g 对于质数 P 来说是原根，那么 g^i mod P (1 ≦ i &lt; P) 的结果各不相同，且其结果按一定顺序排列后是 1 到 P-1 的所有整数，<a href="https://zh.wikipedia.org/wiki/%E5%8E%9F%E6%A0%B9#%E4%BE%8B%E5%AD%90" target="_blank" rel="noopener">例子</a></p></blockquote><blockquote><p>离散对数：如果对于一个整数 n 和质数 P 的一个原根 g，可以找到一个唯一的指数 i，使得 n = g^i mod P (0 ≦ i &lt; P)，那么指数 i 称为 n 的以 g 为基数的模 P 的离散对数</p></blockquote><blockquote><p>Diffie-Hellman 算法的有效性依赖于计算离散对数的难度，其含义是：当已知大素数 P 和它的一个原根 g 后，对给定的 n，要计算 i，被认为是很困难的，而给定 i 计算 n 却相对容易</p></blockquote><p>算法过程可以抽象成下图:</p><p><img src="https://src.wangriyu.wang/images/blog/http/Diffie-Hellman.png" alt="image"></p><p>双方预先商定好了一对 P g 值 (公开的)，而 Alice 有一个私密数 a(非公开，对应一个私钥)，Bob 有一个私密数 b(非公开，对应一个私钥)</p><ul><li><p>Alice 计算 A = g^a mod P，并把 A(公开，对应一个公钥) 发给 Bob</p></li><li><p>Bob 计算 B = g^b mod P，并把 B(公开，对应一个公钥) 发给 Alice</p></li><li><p>双方计算出共享密钥，K = B^a mod P = A^b mod P (= g^ab mod P)</p></li></ul><p>对于 Alice 和 Bob 来说通过对方发过来的公钥参数和自己手中的私钥可以得到最终相同的密钥</p><p>而第三方最多知道 P g A B，想得到私钥和最后的密钥很困难，当然前提是 a b P 足够大 (RFC3526 文档中有几个常用的大素数可供使用)，否则暴力破解也有可能试出答案，至于 g 一般取个较小值就可以</p><p>如下几张图是实际 DH 握手发送的内容:</p><p><img src="https://src.wangriyu.wang/images/blog/http/Cipher-suite.png" alt="image"></p><p><img src="https://src.wangriyu.wang/images/blog/http/Server-params.png" alt="image"></p><p><img src="https://src.wangriyu.wang/images/blog/http/Client-params.png" alt="image"></p><p>可以看到双方发给对方的参数中携带了一个公钥值，对应上述的 A 和 B</p><p>而且实际用的加密套件是 <a href="https://zh.wikipedia.org/wiki/%E6%A9%A2%E5%9C%93%E6%9B%B2%E7%B7%9A%E8%BF%AA%E8%8F%B2-%E8%B5%AB%E7%88%BE%E6%9B%BC%E9%87%91%E9%91%B0%E4%BA%A4%E6%8F%9B" target="_blank" rel="noopener">椭圆曲线 DH 密钥交换 (ECDH)</a>，利用由椭圆曲线加密建立公钥与私钥对可以更进一步加强 DH 的安全性，因为目前解决椭圆曲线离散对数问题要比因式分解困难的多，而且 ECC 使用的密钥长度比 RSA 密钥短得多(目前 RSA 密钥需要 2048 位以上才能保证安全，而 ECC 密钥 256 位就足够)</p><p>关于 <a href="https://zh.wikipedia.org/wiki/%E6%A4%AD%E5%9C%86%E6%9B%B2%E7%BA%BF%E5%AF%86%E7%A0%81%E5%AD%A6" target="_blank" rel="noopener">椭圆曲线密码学 - ECC</a>，推荐看下 <a href="https://blog.cloudflare.com/a-relatively-easy-to-understand-primer-on-elliptic-curve-cryptography/" target="_blank" rel="noopener">A Primer on Elliptic Curve Cryptography - 原文</a> - <a href="https://zhuanlan.zhihu.com/p/26029199" target="_blank" rel="noopener">译文</a></p><h3 id="5-3-客户端身份验证"><a href="#5-3-客户端身份验证" class="headerlink" title="5.3 客户端身份验证"></a>5.3 客户端身份验证</h3><p>尽管可以选择对任意一端进行身份验证，但人们几乎都启用了对服务器的身份验证。如果服务器选择的套件不是匿名的，那么就需要在 Certificate 消息中跟上自己的证书。</p><p><img src="https://src.wangriyu.wang/images/blog/http/mutualAuthentication.png" alt="image"></p><p>相比之下，服务器通过发送 CertificateRequest 消息请求对客户端进行身份验证。消息中列出所有可接受的客户端证书。作为响应，客户端发送自己的 Certificate 消息（使用与服务器发送证书相同的格式），并附上证书。此后，客户端发送 CertificateVerify 消息，证明自己拥有对应的私钥。</p><p>只有已经过身份验证的服务器才被允许请求客户端身份验证。基于这个原因，这个选项也被称为相互身份验证（mutual authentication）。</p><h4 id="5-3-1-CertificateRequest"><a href="#5-3-1-CertificateRequest" class="headerlink" title="5.3.1 CertificateRequest"></a>5.3.1 CertificateRequest</h4><p>在 ServerHello 的过程中发出，请求对客户端进行身份验证，并将其接受的证书的公钥和签名算法传送给客户端。</p><p>它也可以选择发送一份自己接受的证书颁发机构列表，这些机构都用其可分辨名称来表示:</p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">struct</span> <span class="token punctuation">{</span>  ClientCertificateType certificate_types<span class="token punctuation">;</span>  SignatureAndHashAlgorithm supported_signature_algorithms<span class="token punctuation">;</span>  DistinguishedName certificate_authorities<span class="token punctuation">;</span><span class="token punctuation">}</span> CertificateRequest<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="5-3-2-CertificateVerify"><a href="#5-3-2-CertificateVerify" class="headerlink" title="5.3.2 CertificateVerify"></a>5.3.2 CertificateVerify</h4><p>在 ClientKeyExchange 的过程中发出，证明自己拥有的私钥与之前发送的客户端证书中的公钥匹配。消息中包含一条到这一步为止的所有握手消息的签名：</p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">struct</span> <span class="token punctuation">{</span>  Signature handshake_messages_signature<span class="token punctuation">;</span><span class="token punctuation">}</span> CertificateVerify<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="5-4-会话恢复"><a href="#5-4-会话恢复" class="headerlink" title="5.4 会话恢复"></a>5.4 会话恢复</h3><p>最初的会话恢复机制是，在一次完整协商的连接断开时，客户端和服务器都会将会话的安全参数保存一段时间。希望使用会话恢复的服务器为会话指定唯一的标识，称为会话 ID(Session ID)。服务器在 ServerHello 消息中将会话 ID 发回客户端。</p><p>希望恢复早先会话的客户端将适当的 Session ID 放入 ClientHello 消息，然后提交。服务器如果同意恢复会话，就将相同的 Session ID 放入 ServerHello 消息返回，接着使用之前协商的主密钥生成一套新的密钥，再切换到加密模式，发送 Finished 消息。<br>客户端收到会话已恢复的消息以后，也进行相同的操作。这样的结果是握手只需要一次网络往返。</p><p>Session ID 由服务器端支持，协议中的标准字段，因此基本所有服务器都支持，服务器端保存会话 ID 以及协商的通信信息，占用服务器资源较多。</p><p><img src="https://src.wangriyu.wang/images/blog/http/simple-handshake.png" alt="image"></p><p>用来替代服务器会话缓存和恢复的方案是使用会话票证（Session ticket）。使用这种方式，除了所有的状态都保存在客户端（与 HTTP Cookie 的原理类似）之外，其消息流与服务器会话缓存是一样的。</p><p>其思想是服务器取出它的所有会话数据（状态）并进行加密 (密钥只有服务器知道)，再以票证的方式发回客户端。在接下来的连接中，客户端恢复会话时在 <strong>ClientHello 的扩展字段</strong> session_ticket 中携带加密信息将票证提交回服务器，由服务器检查票证的完整性，解密其内容，再使用其中的信息恢复会话。</p><p>这种方法有可能使扩展服务器集群更为简单，因为如果不使用这种方式，就需要在服务集群的各个节点之间同步会话。<br>Session ticket 需要服务器和客户端都支持，属于一个扩展字段，占用服务器资源很少。</p><blockquote><p>警告<br>会话票证破坏了 TLS 安全模型。它使用票证密钥加密的会话状态并将其暴露在线路上。有些实现中的票证密钥可能会比连接使用的密码要弱。如果票证密钥被暴露，就可以解密连接上的全部数据。因此，使用会话票证时，票证密钥需要频繁轮换。</p></blockquote><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://www.ietf.org/rfc/rfc2246.txt" target="_blank" rel="noopener">RFC 2246 - The TLS Protocol Version 1.0</a></li><li><a href="https://zh.wikipedia.org/wiki/%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AE%E5%8D%8F%E5%95%86" target="_blank" rel="noopener">NPN/ALPN - wiki</a></li><li><a href="https://zh.wikipedia.org/wiki/%E5%82%B3%E8%BC%B8%E5%B1%A4%E5%AE%89%E5%85%A8%E6%80%A7%E5%8D%94%E5%AE%9A" target="_blank" rel="noopener">TLS - wiki</a></li><li><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc785811(v=ws.10" target="_blank" rel="noopener">SSL/TLS in detail</a>)</li><li><a href="https://www.wosign.com/faq/faq2016-0309-02.htm" target="_blank" rel="noopener">HTTPS 加密协议详解</a></li><li><a href="https://blog.cloudflare.com/keyless-ssl-the-nitty-gritty-technical-details/#rsahandshake" target="_blank" rel="noopener">Keyless SSL: The Nitty Gritty Technical Details</a></li><li><a href="https://en.wikipedia.org/wiki/Digital_Signature_Algorithm" target="_blank" rel="noopener">DSA - 数字签名算法</a></li><li>《HTTPS 权威指南 - 在服务器和 web 应用上部署 SSL/TLS 和 PKI》</li></ul>]]></content>
      
      <categories>
          
          <category> http </category>
          
      </categories>
      
      
        <tags>
            
            <tag> http 扩展阅读 </tag>
            
            <tag> 网络 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>HTTP Message</title>
      <link href="/2018/03-http-message.html"/>
      <url>/2018/03-http-message.html</url>
      <content type="html"><![CDATA[<h2 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h2><p><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html" target="_blank" rel="noopener">RFC2616</a> 中定义的 HTTP Request 消息体结构：</p><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token variable-declaration"><span class="token variable">Request</span> <span class="token operator">=</span> Request-Line             </span><span class="token comment" spellcheck="true">// 请求行</span>          *<span class="token punctuation">(</span><span class="token punctuation">(</span> general-header       <span class="token comment" spellcheck="true">// 通用首部</span>            | request-header       <span class="token comment" spellcheck="true">// 请求首部</span>            | entity-header <span class="token punctuation">)</span>CRLF<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 实体首部</span>          CRLF          <span class="token punctuation">[</span> message-body <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://src.wangriyu.wang/images/blog/http/request.png" alt="image"></p><p>一个 HTTP 的 request 消息以一个请求行开始，从第二行开始是 headers (️每个键值对都以 CRLF 结尾)，接下来是一个 CRLF 开头的空行，表示 header 结束，最后是消息主体。</p><h3 id="请求行的定义如下"><a href="#请求行的定义如下" class="headerlink" title="请求行的定义如下:"></a>请求行的定义如下:</h3><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token variable-declaration"><span class="token variable">Request-Line</span> <span class="token operator">=</span> Method SP Request-URI SP HTTP-Version CRLF</span><span class="token variable-declaration"><span class="token variable">Method</span> <span class="token operator">=</span> <span class="token string">"OPTIONS"</span> | <span class="token string">"GET"</span> | <span class="token string">"HEAD"</span> | <span class="token string">"POST"</span> | <span class="token string">"PUT"</span> | <span class="token string">"DELETE"</span> | <span class="token string">"TRACE"</span> | <span class="token string">"CONNECT"</span> | extension-method</span><span class="token variable-declaration"><span class="token variable">Request-URI</span> <span class="token operator">=</span> <span class="token string">"*"</span> | absoluteURI | abs_path | authotity（CONNECT）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="请求方法（也叫请求动作）"><a href="#请求方法（也叫请求动作）" class="headerlink" title="请求方法（也叫请求动作）"></a>请求方法（也叫请求动作）</h3><ul><li>GET 请求会显示请求指定的资源。一般来说 GET 方法应该只用于数据的读取，而不应当用于会产生副作用的非幂等的操作中。GET 会方法请求指定的页面信息，并返回响应主体，GET 被认为是不安全的方法，因为 GET 方法会被网络蜘蛛等任意的访问。</li><li>HEAD 方法与 GET 方法一样，都是向服务器发出指定资源的请求。但是，服务器在响应 HEAD 请求时不会回传资源的内容部分，即：响应主体。这样，我们可以不传输全部内容的情况下，就可以获取服务器的响应头信息。HEAD 方法常被用于客户端查看服务器的性能。</li><li>POST 请求会向指定资源提交数据，请求服务器进行处理，如：表单数据提交、文件上传等，请求数据会被包含在请求体中。POST 方法是非幂等的方法，因为这个请求可能会创建新的资源或 / 和修改现有资源。</li><li>PUT 请求会身向指定资源位置上传其最新内容，PUT 方法是幂等的方法。通过该方法客户端可以将指定资源的最新数据传送给服务器取代指定的资源的内容。</li><li>DELETE 请求用于请求服务器删除所请求 URI 所标识的资源。DELETE 请求后指定资源会被删除，DELETE 方法也是幂等的。</li><li>CONNECT 方法是 HTTP/1.1 协议预留的，代表使用隧道协议 (Tunneling Protocol) 进行连接。通常用于 SSL/TLS 加密服务器的链接与非加密的 HTTP 代理服务器的通信。</li><li>OPTIONS 请求与 HEAD 类似，一般也是用于客户端查看服务器的性能。 这个方法会请求服务器返回该资源所支持的所有 HTTP 请求方法，该方法会用 ‘*’ 来代替资源名称，向服务器发送 OPTIONS 请求，可以测试服务器功能是否正常。JavaScript 的 XMLHttpRequest 对象进行 CORS 跨域资源共享时，就是使用 OPTIONS 方法发送嗅探请求，以判断是否有对指定资源的访问权限。</li><li>TRACE 请求服务器回显其收到的请求信息，该方法主要用于 HTTP 请求的测试或诊断。</li></ul><h3 id="请求地址"><a href="#请求地址" class="headerlink" title="请求地址"></a>请求地址</h3><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token variable-declaration"><span class="token variable">Request-URI</span> <span class="token operator">=</span> <span class="token string">"*"</span> | absoluteURI | abs_path | authority（CONNECT）</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>“*“ 代表请求不指向特定的资源，而是服务器本身，且只在所使用的方法没必要应用到资源时允许。一个典型的例子是 <code>OPTIONS * HTTP/1.1</code></li><li>absoluteURI 绝对地址，比如 <code>GET http://www.w3.org/pub/WWW/TheProject.html HTTP/1.1</code>。只用于向代理服务器 (proxy) 发送请求</li><li>abs_path 相对路径，“/” 代表服务器根</li><li>只有 CONNECT 方法使用 authority 形式，由域名和可选端口组成的 URL，比如 <code>CONNECT developer.mozilla.org:80 HTTP/1.1</code></li></ul><blockquote><p>向一个代理服务器发送 HTTP 请求时，请求行中应该使用绝对路径的 URL。如果向目标服务器直接发送请求，则请求行中只会包含相对路径的 URL(完整 URL 的 path 部分)。<br>为了能在后续 http 版本中过渡，所有 http/1.1 服务器都应该能够处理 absoluteURI 形式的请求，即使客户端只会向代理发送这种形式的请求，详见 <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5.1.2" target="_blank" rel="noopener">https://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5.1.2</a></p></blockquote><p>HTTP/1.1 中 Host 和 Request-URI 一起作为 Request 消息接收者判断请求资源的条件, 确认主机资源的方法如下：</p><ul><li><p>如果 Request-URI 是绝对地址（absoluteURI），这时请求里的主机存在于 Request-URI 里。忽略任何出现在请求里 Host 头域值</p></li><li><p>假如 Request-URI 不是绝对地址（absoluteURI），并且请求包括一个 Host 头域，则主机由该 Host 头域值决定</p></li><li><p>假如由规则１或规则２定义的主机是一个无效的主机，则应当以一个 400（错误请求）错误消息返回</p></li></ul><blockquote><p>⚠️ HTTP/1.1 请求必须带 Host 头域，否则会报 bad request;</p></blockquote><blockquote><p>HTTP/1.0 不支持 Host 头域，因为 1.0 认为一个 ip 只绑定一个主机，通过 ip 就能确认主机，但后来一台服务器可以存在多个虚拟主机 (virtual host) 共用一个 ip 的情况，所以 1.1 添加 Host 头域显示指定主机。</p></blockquote><h3 id="URI-统一资源标识符，Uniform-Resource-Identifier"><a href="#URI-统一资源标识符，Uniform-Resource-Identifier" class="headerlink" title="URI(统一资源标识符，Uniform Resource Identifier)"></a>URI(统一资源标识符，Uniform Resource Identifier)</h3><p>URI 就是由某个协议方案表示的资源的定位标识符，这个协议可以使 http、https、ftp 等，比如：</p><pre class="line-numbers language-http"><code class="language-http"><span class="token header-name keyword">ftp:</span>//ftp.is.co.za/rfc/rfc1808.txt<span class="token header-name keyword">http:</span>//www.ietf.org/rfc/rfc2396.txt<span class="token header-name keyword">ldap:</span>//[2001:db8::7]/c=GB?objectClass?one<span class="token header-name keyword">mailto:</span>John.Doe@example.com<span class="token header-name keyword">news:</span>comp.infosystems.www.servers.unix<span class="token header-name keyword">tel:</span>+1-816-555-1212 telnet://192.0.2.16:80/<span class="token header-name keyword">urn:</span><span class="token header-name keyword">oasis:</span><span class="token header-name keyword">names:</span><span class="token header-name keyword">specification:</span><span class="token header-name keyword">docbook:</span><span class="token header-name keyword">dtd:</span><span class="token header-name keyword">xml:</span>4.1.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>绝对 URI 的格式应该是这样的:</p><hr><p><u>http</u>://<u>user:pass</u>@<u><a href="http://www.example.com" target="_blank" rel="noopener">www.example.com</a></u>:<u>80</u>/<u>dir/index.html</u>?<u>uid=1</u>#<u>ch1</u></p><p>协议:// 登录信息 @服务器地址: 端口号 / 文件路径? 查询字符串#片段标识符</p><hr><blockquote><p>与 URL(统一资源定位符，Universal Resource Locator) 和 URN(统一资源名，Uniform Resource Name) 的关系：</p></blockquote><blockquote><blockquote><p>URL 和 URN 是 URI 的两个子集，URI 唯一标识了文件资源对象 (类似身份证)，URN 标识资源名称，URL 标识资源地址</p></blockquote></blockquote><h2 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h2><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token variable-declaration"><span class="token variable">Response</span> <span class="token operator">=</span> Status-Line             </span><span class="token comment" spellcheck="true">// 状态行</span>           *<span class="token punctuation">(</span><span class="token punctuation">(</span> general-header      <span class="token comment" spellcheck="true">// 通用首部</span>            | response-header      <span class="token comment" spellcheck="true">// 响应首部</span>            | entity-header <span class="token punctuation">)</span>CRLF<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 实体首部</span>           CRLF           <span class="token punctuation">[</span> message-body <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://src.wangriyu.wang/images/blog/http/response.png" alt="image"></p><p>response 第一行是状态行，包含状态码 Status-Code，Reason-Phrase 是状态码的简单文本描述 (比如 200 - OK、404 - Not Found)</p><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token variable-declaration"><span class="token variable">Status-Line</span> <span class="token operator">=</span> HTTP-Version SP Status-Code SP Reason-Phrase CRLF</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Status-Code:</p><ul><li>1xx: 信息性——收到请求，继续处理</li><li>2xx: 成功性——成功收到、理解并接受行动</li><li>3xx: 重定向——必须采取进一步行动来完成请求</li><li>4xx: 客户端错误——请求包含错误语法或不能完成</li><li>5xx: 服务器错误——服务器没有成功完成显然有效的请求</li></ul><h2 id="消息体"><a href="#消息体" class="headerlink" title="消息体"></a>消息体</h2><p>HTTP 消息的 message-body（如果存在）用于挟带与请求或响应相关联的 entity-body.<br>message-body 只有在应用了 transfer-coding 时，通过 Transfer-Encoding 头部域指出，与 entity-body 不同。</p><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token variable-declaration"><span class="token variable">message-body</span> <span class="token operator">=</span> entity-body | <span class="token operator">&lt;</span>entity-body encoded as per Transfer-Encoding<span class="token operator">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="headers"><a href="#headers" class="headerlink" title="headers"></a>headers</h2><p>这里只列举了 2616 中提到的头部域，还有很多新添加的头部域，可以自行查找</p><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token variable-declaration"><span class="token variable">general-header</span> <span class="token operator">=</span> Cache-Control      </span><span class="token comment" spellcheck="true">// 控制缓存的行为，比如 `private, max-age=0, no-cache`</span>                | Connection        <span class="token comment" spellcheck="true">// 控制不再转发给代理的首部字段或者管理持久连接 (Keep-Alive 或者 close)</span>                | Date              <span class="token comment" spellcheck="true">// 表明创建 HTTP 报文的日期和时间</span>                | Pragma            <span class="token comment" spellcheck="true">// 唯一字段 `no-cache`，用于兼容 HTTP/1.1 之前的版本，客户端会要求所有的中间服务器不返回缓存的资源</span>                | Trailer           <span class="token comment" spellcheck="true">// 事先说明在报文主体后记录了哪些首部字段。该首部字段可应用在 HTTP/1.1 版本分块传输编码</span>                | Transfer-Encoding <span class="token comment" spellcheck="true">// 规定了传输报文主体时采用的编码方式，比如 `chunked`</span>                | Upgrade           <span class="token comment" spellcheck="true">// 检测 HTTP 协议及其他协议是否可使用更高的 版本进行通信，其参数值可以用来指定一个完全不同的通信协议，使用首部字段 Upgrade 时，还需要额外指定 Connection:Upgrade</span>                | Via               <span class="token comment" spellcheck="true">// 追踪客户端与服务器之间的请求和响应报文 的传输路径</span>                | Warning           <span class="token comment" spellcheck="true">// 从 HTTP/1.0 的响应首部（Retry-After）演变过来的。该首部通常会告知用户一些与缓存相关的问题的警告，字段格式:`[警告码][警告的主机: 端口号]“[警告内容]”([日期时间])`</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token variable-declaration"><span class="token variable">request-header</span> <span class="token operator">=</span> Accept               </span><span class="token comment" spellcheck="true">// 通知服务器，用户代理能够处理的媒体类型及媒体类型的相对优先级（可用权重 q=0~1 来表示相对优先级）。可使用 type/subtype 这种形式，一次指定多种媒体类型，支持通配符。例如 `text/html, text/plain, text/css, image/jpeg, video/mpeg, application/zip` 等</span>                | Accept-Charset      <span class="token comment" spellcheck="true">// 通知服务器用户代理支持的字符集及字符集的相对优先顺序，可一次性指定多种字符集</span>                | Accept-Encoding     <span class="token comment" spellcheck="true">// 告知服务器用户代理支持的内容编码及内容编码的优先级顺序。可一次性指定多种内容编码，例如: `gzip, compress, deflate, identity`</span>                | Accept-Language     <span class="token comment" spellcheck="true">// 告知服务器用户代理能够处理的自然语言集及优先级顺序，例如: `zh-cn,zh;q=0.7,en-us,en;q=0.3` 优先返回中文版响应</span>                | Authorization       <span class="token comment" spellcheck="true">// 告知服务器，用户代理的认证信息（证书值），例如: `Basic dWVub3NlbjpwYXNzd29yZA==`</span>                | Expect              <span class="token comment" spellcheck="true">// 告知服务器，客户端期望出现的某种特定行为。因服务器无法理解客户端的期望作出回应而发生错误时，会返回状态码 417 Expectation Failed。</span>                | From                <span class="token comment" spellcheck="true">// 告知服务器使用用户代理的用户的电子邮件地址</span>                | Host                <span class="token comment" spellcheck="true">// Host 会告知服务器，请求的资源所处的互联网主机名和端口号</span>                | If-Match            <span class="token comment" spellcheck="true">// 只有当 If-Match 的字段值跟资源的 ETag 值匹配一致时，服务器才会接受请求，否则返回状态码 412 Precondition Failed</span>                | If-Modified-Since   <span class="token comment" spellcheck="true">// If-Modified-Since 字段指定的日期时间后，资源发生了更新，服务器才会接受请求，否则返回状态码 304 Not Modified</span>                | If-None-Match       <span class="token comment" spellcheck="true">// If-None-Match 的字段值与 ETag 值不一致时，可处理该请求。与 If-Match 首部字段的作用相反</span>                | If-Range            <span class="token comment" spellcheck="true">// 告知服务器若指定的 If-Range 字段值（ETag 值或者时间）和请求资源的 ETag 值或时间相一致时，则作为范围请求处理。反之，则返回全体资源。</span>                | If-Unmodified-Since <span class="token comment" spellcheck="true">// 与 If-Modified-Since 的作用相反</span>                | Max-Forwards        <span class="token comment" spellcheck="true">// 通过 TRACE 方法或 OPTIONS 方法，发送包含首部字段 Max-Forwards 的请求时，该字段以十进制整数形式指定可经过的服务器最大数目，服务器转发请求之前，Max-Forwards 的值减 1 后重新赋值。当服务器接收到 Max-Forwards 值为 0 的请求时，则不再进行转发，直接返回响应。</span>                | Proxy-Authorization <span class="token comment" spellcheck="true">// 接收到从代理服务器发来的认证质询时，客户端会发送包含首部字段 Proxy-Authorization 的请求，以告知服务器认证所需要的信息。</span>                | Range               <span class="token comment" spellcheck="true">// 对于只需获取部分资源的范围请求，包含首部字段 Range 即可告知服 务器资源的指定范围。例如: `bytes=5001-10000` 表示请求获取从第 5001 字节至第 10000 字节的资源。服务器会在处理请求之后返回 206 Partial Content 的响应。无法处理该范围请求时，则返回 200 OK 的响应及全部资源。</span>                | Referer             <span class="token comment" spellcheck="true">// 告知服务器请求的原始资源的 URI。</span>                | TE                  <span class="token comment" spellcheck="true">// 告知服务器客户端能够处理响应的传输编码方式及相对优先级。它和首部字段 Accept-Encoding 的功能很相像，但是用于传输编码。</span>                | User-Agent          <span class="token comment" spellcheck="true">// 将创建请求的浏览器和用户代理名称等信息传达给服务器</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token variable-declaration"><span class="token variable">response-header</span> <span class="token operator">=</span> Accept-Ranges      </span><span class="token comment" spellcheck="true">// 告知客户端服务器是否能处理范围请求，以指定获取服务器端某个部分的资源。可处理范围请求时指定其为 bytes，反之则指定其为 none。</span>                | Age                <span class="token comment" spellcheck="true">// 告知客户端，源服务器在多久前创建了响应。字段值的单位为秒。若创建该响应的服务器是缓存服务器，Age 值是指缓存后的响应再次发起认证到认证完成的时间值。代理创建响应时必须加上首部字段 Age。</span>                | ETag               <span class="token comment" spellcheck="true">// 告知客户端实体标签 (Entity Tag)。它是一种可将资源以字符串形式做唯一性标识的方式。服务器会为每份资源分配对应的 ETag 值。有强弱之分，弱 Etag 以 'w/' 开头。</span>                | Location           <span class="token comment" spellcheck="true">// 将响应接收方引导至某个与请求 URI 位置不同的资源。该字段会配合 3xx ：Redirection 的响应，提供重定向的 URI。</span>                | Proxy-Authenticate <span class="token comment" spellcheck="true">// 由代理服务器所要求的认证信息发送给客户端。</span>                | Retry-After        <span class="token comment" spellcheck="true">// 告知客户端应该在多久之后再次发送请求。主要配合状态码 503 Service Unavailable 响应，或 3xx Redirect 响应一起使用。字段值可以指定为具体的日期时间（Wed, 04 Jul 2012 06：34：24 GMT 等格式），也可以是创建响应后的秒数</span>                | Server             <span class="token comment" spellcheck="true">// 告知客户端当前服务器上安装的 HTTP 服务器应用程序的信息。例如: `Apache/2.2.6 (Unix) PHP/5.2.5`</span>                | Vary               <span class="token comment" spellcheck="true">// 可对缓存进行控制。源服务器会向代理服务器传达关于本地缓存使用方法的命令。</span>                | WWW-Authenticate   <span class="token comment" spellcheck="true">// WWW-Authenticate 用于 HTTP 访问认证。它会告知客户端适用于访问请求 URI 所指定资源的认证方案（Basic 或是 Digest）和带参数提示的质询（challenge）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token variable-declaration"><span class="token variable">entity-header</span> <span class="token operator">=</span> Allow              </span><span class="token comment" spellcheck="true">// 服务端通知客户端能够支持 Request-URI 指定资源的所有 HTTP 方法。当服务器接收到不支持的 HTTP 方法时，会以状态码 405 Method Not Allowed 作为响应返回。与此同时，还会把所有能支持的 HTTP 方法写入首部字段 Allow 后返回</span>                | Content-Encoding <span class="token comment" spellcheck="true">// 告知客户端服务器对实体的主体部分选用的内容编码方式，字段值参见 Accept-Encoding</span>                | Content-Language <span class="token comment" spellcheck="true">// 会告知客户端，实体主体使用的自然语言，例如: `zh-CN`</span>                | Content-Length   <span class="token comment" spellcheck="true">// 表明了实体主体部分的大小（单位是字节）。对实体主体进行内容编码传输时，不能再使用 Content-Length 首部字段</span>                | Content-Location <span class="token comment" spellcheck="true">// 给出与报文主体部分相对应的 URI。和首部字段 Location 不同，Content-Location 表示的是报文主体返回资源对应的 URI。</span>                | Content-MD5      <span class="token comment" spellcheck="true">// 客户端会对接收的报文主体执行相同的 MD5 算法，然后与首部字段 Content-MD5 的字段值比较，其目的在于检查报文主体在传输过程中是否保持完整，以及确认传输到达。无法检测出恶意篡改</span>                | Content-Range    <span class="token comment" spellcheck="true">// 能告知客户端作为响应返回的实体的哪个部分符合范围请求。字段值以字节为单位，表示当前发送部分及整个实体大小。例如: `bytes 5001-10000/10000`</span>                | Content-Type     <span class="token comment" spellcheck="true">// 说明了实体主体内对象的媒体类型。和首部字段 Accept 一样，字段值用 type/subtype 形式赋值。例如: `text/html; charset=UTF-8`</span>                | Expires          <span class="token comment" spellcheck="true">// 将资源失效的日期告知客户端。当首部字段 Cache-Control 有指定 max-age 指令时，Cache-Control 优先级大于 Expires</span>                | Last-Modified    <span class="token comment" spellcheck="true">// 指明资源最终修改的时间</span>                | extension-header <span class="token comment" spellcheck="true">// 允许定义额外的 entity-header 域而不改变协议，但不能假设接收方认识这些域。接收方应该忽略未识别的头域，但透明代理必须转发它</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="强缓存和协商缓存"><a href="#强缓存和协商缓存" class="headerlink" title="强缓存和协商缓存"></a>强缓存和协商缓存</h3><h4 id="浏览器在加载资源的时，先根据-http-header-判断它是否命中强缓存"><a href="#浏览器在加载资源的时，先根据-http-header-判断它是否命中强缓存" class="headerlink" title="浏览器在加载资源的时，先根据 http header 判断它是否命中强缓存."></a>浏览器在加载资源的时，先根据 http header 判断它是否命中强缓存.</h4><ul><li>命中强缓存：浏览器直接从自己缓存中读取资源，不发送请求到服务器</li><li>不命中强缓存：浏览器发送一个请求到服务器，服务器根据资源携带的 http header 验证该资源是否命中协商缓存<ul><li>命中协商缓存：将请求返回，但不是返回该资源的数据，而是告诉浏览器可以直接从缓存中加载这个资源。</li><li>不命中协商缓存：服务器返回该资源数据</li></ul></li></ul><p><img src="https://src.wangriyu.wang/images/blog/http/Intermediaries.png" alt="image"></p><h4 id="强缓存"><a href="#强缓存" class="headerlink" title="强缓存"></a>强缓存</h4><p>-【Cache-Control、Expires】: Expires 指定一个过期的时间戳 (绝对时间)，Cache-Control 指定缓存行为 (比如 max-age=604800 代表有效期为七天，是相对时间)。一般用其中一个，如果两个同时出现，Cache-Control 优先级大于 Expires。</p><blockquote><p>Cache-Control 是 http/1.1 弥补 Expires 缺陷新加入的，增加了很多行为</p></blockquote><table><thead><tr><th>Cache-Control</th><th>description</th></tr></thead><tbody><tr><td>public</td><td>资源将被客户端和代理服务器缓存</td></tr><tr><td>private</td><td>资源仅被客户端缓存, 代理服务器不缓存</td></tr><tr><td>no-store</td><td>请求和响应都不缓存 (真正地不缓存)</td></tr><tr><td>no-cache</td><td>do-not-serve-from-cache-without-revalidation，响应实际上可以缓存在本地缓存区，只是在与原服务器进行新鲜度验证之前不能返回给客户端</td></tr><tr><td>max-age</td><td>缓存资源, 但是在指定时间 (单位为秒) 后缓存过期</td></tr><tr><td>s-maxage</td><td>同上, 依赖 public 设置, 覆盖 max-age, 且只在代理服务器上有效</td></tr><tr><td>max-stale</td><td>指定时间内, 即使缓存过时, 资源依然有效</td></tr><tr><td>min-fresh</td><td>缓存的资源至少要保持指定时间的新鲜期</td></tr><tr><td>must-revalidation / proxy-revalidation</td><td>如果缓存失效, 强制重新向服务器 (或代理) 发起验证 (使用 must-revalidate 指令会忽略请求的 max-stale 指令)</td></tr><tr><td>only-if-cached</td><td>仅仅返回已经缓存的资源, 不访问源服务器, 若无缓存则返回 504 Gateway Timeout</td></tr><tr><td>no-transform</td><td>强制要求代理服务器不要对资源进行转换, 禁止代理服务器对 Content-Encoding, Content-Range, Content-Type 字段的修改 (因此代理的 gzip 压缩将不被允许)</td></tr><tr><td>cache-extension token</td><td>通过 cache-extension 标记（token），可以扩展 Cache-Control 首部字段内的指令，如果缓存服务器不能理解这个新指令，就会直接忽略</td></tr></tbody></table><p><img src="https://src.wangriyu.wang/images/blog/http/StrongCache.png" alt="image"></p><p>在控制台中可以查看读取的是本地缓存还是向服务器拉取的资源:</p><p><img src="https://src.wangriyu.wang/images/blog/http/hit%20cache.png" alt="image"></p><p><img src="https://src.wangriyu.wang/images/blog/http/no%20cache.png" alt="image"></p><h4 id="协商缓存"><a href="#协商缓存" class="headerlink" title="协商缓存"></a>协商缓存</h4><p>-【Last-Modified、If-Modified-Since】: If-Modified-Since 就是上次请求返回的 Last-Modified，服务器再次收到资源请求时，根据浏览器传过来 If-Modified-Since 和资源在服务器上的最后修改时间判断资源是否有变化，如果有变化就正常返回资源内容。如果没有变化，就返回 304 Not Modified，不返回资源内容，不更新 Last-Modified。</p><p>-【ETag、If-None-Match】: 浏览器第一次跟服务器请求一个资源，服务器在返回这个资源的同时，在 respone 的 header 加上 ETag（服务器根据当前请求的资源生成的一个唯一标识），这个唯一标识是一个字符串，只要资源有变化这个串就不同，服务器再次收到资源请求时，根据资源生成一个新的 ETag 和浏览器传过来 If-None-Match 比较，如果这两个值相同就说明资源没有变化，否则就是有变化；如果没有变化，返回 304 和 ETag 不返回资源；如果有变化，返回资源。ETag 优先级比 Last-Modified 高</p><blockquote><p>⚠️</p><ul><li>在分布式部署的时候，多台机器的 Last-Modified 必须保持一致，否则协商缓存会出问题。</li><li>分布式部署，不同的机器生成的 ETag 都会不一样， 然后协商缓存就会出问题。【如果没有搞定 ETag 一致，就先关闭掉】</li><li>协商缓存需要配合强缓存使用 【不启动强缓存，协商缓存也就不起作用】</li></ul></blockquote><p><img src="https://src.wangriyu.wang/images/blog/http/NegotiateCache.png" alt="image"></p><blockquote><p>另外浏览器的刷新 (F5 / cmd + r) 和强刷 (Ctrl + F5 / shift + cmd +r / option + cmd + r(safari)):<br>普通刷新会使用协商缓存，忽略强缓存；强刷会忽略浏览器所有缓存（并且请求头会携带 Cache-Control:no-cache 和 Pragma:no-cache，用来通知所有中间节点忽略缓存）。<br>只有从地址栏或收藏夹输入网址、点击链接等情况下，浏览器才会使用强缓存。</p></blockquote><h4 id="强校验和弱校验"><a href="#强校验和弱校验" class="headerlink" title="强校验和弱校验"></a>强校验和弱校验</h4><p><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html#sec13.3.3" target="_blank" rel="noopener">https://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html#sec13.3.3</a></p><p><a href="https://zh.wikipedia.org/wiki/HTTP_ETag" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/HTTP_ETag</a></p><p>ETag 强校验表明资源的两个版本每个字节都是相同，并且请求头（如 Content-Language）也不能有改变。强校验允许缓存，以及字节请求部分响应合并。</p><p>ETag 弱校验表明资源的两个版本只需要语义上保持一致，忽略细微差别比如修改时间等，这意味着，他们是可以互换的，并且缓存的副本也可以被使用。因为不需要资源版本保持字节程度的相同，所以这种 ETag 不适合字节请求。如果 web 服务器要动态的生成响应，这时弱校验 ETag 比较合适。</p><p>比如使用弱验证类型，一个页面与另外一个页面只是在页脚显示的时间上有所不同，或者是展示的广告不相同，那么就会被认为是相同的。但是在使用强验证的情况下，二者是不同的。</p><p>Last-Modified 存在的问题，也是使用 Etag 的原因:</p><ul><li>一些文件也许会周期性的更改，但是他的内容并不改变 (仅仅改变的修改时间)，这个时候我们并不希望客户端认为这个文件被修改了，而重新 GET</li><li>有些文档可能被修改了，但所做的修改并不重要，不需要让所有缓存都重装数据 (比如对拼写和注释的修改)</li><li>某些文件修改非常频繁，比如在秒以下的时间内进行修改 (比如实时监控器)，If-Modified-Since 能检查到的粒度是秒级的，对于小于秒级的修改无法判断 (或者说 UNIX 记录 MTIME 只能精确到秒)</li><li>某些服务器不能精确的得到文件的最后修改时间；</li></ul><p>例子:</p><ul><li>强校验</li></ul><pre class="line-numbers language-http"><code class="language-http"><span class="token response-status">HTTP/1.1 <span class="token property">200 OK</span></span><span class="token header-name keyword">Date:</span> Sat, 05 May 2018 11:28:26 GMT<span class="token header-name keyword">ETag:</span> "aaa"<span class="token header-name keyword">Server:</span> nginx/1.12.2<span class="token header-name keyword">Content-Length:</span> 5<span class="token header-name keyword">Content-Type:</span> text/html<span class="token text/html">Hello</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>若添加了内容编码 <code>Content-Encoding: gzip</code> 后，ETag 便会改变</p><pre class="line-numbers language-http"><code class="language-http"><span class="token response-status">HTTP/1.1 <span class="token property">200 OK</span></span><span class="token header-name keyword">Date:</span> Sat, 05 May 2018 11:28:26 GMT<span class="token header-name keyword">ETag:</span> "bbb"<span class="token header-name keyword">Server:</span> nginx/1.12.2<span class="token header-name keyword">Content-Length:</span> 5<span class="token header-name keyword">Content-Type:</span> text/html<span class="token header-name keyword">Content-Encoding:</span> gzip<span class="token text/html">Hello</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>弱检验</li></ul><pre class="line-numbers language-http"><code class="language-http"><span class="token response-status">HTTP/1.1 <span class="token property">200 OK</span></span><span class="token header-name keyword">Date:</span> Sat, 05 May 2018 11:28:26 GMT<span class="token header-name keyword">ETag:</span> W/"ccc"<span class="token header-name keyword">Server:</span> nginx/1.12.2<span class="token header-name keyword">Content-Type:</span> text/css.absolute-center {  position: absolute;  left: 50%;  top: 50%;  transform: translate(-50%, -50%);}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>若 CSS 样式做了 minify，ETag 并不会改变，因为内容并没有发生实际变化</p><pre class="line-numbers language-http"><code class="language-http"><span class="token response-status">HTTP/1.1 <span class="token property">200 OK</span></span><span class="token header-name keyword">Date:</span> Sat, 05 May 2018 11:28:26 GMT<span class="token header-name keyword">ETag:</span> W/"ccc"<span class="token header-name keyword">Server:</span> nginx/1.12.2<span class="token header-name keyword">Content-Type:</span> text/css.absolute-center{position:absolute;left:50%;top:50%;transform:translate(-50%, -50%)}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此时客户端发起 <code>If-None-Match</code> 请求，服务端还是会响应 304 Not Modified，客户端继续读取之前未 minify 的缓存</p><h4 id="其他字段"><a href="#其他字段" class="headerlink" title="其他字段"></a>其他字段</h4><ul><li>Age: 告知客户端，源服务器在多久前创建了响应。若创建该响应的服务器是缓存服务器，Age 值是指缓存后的响应已过时间</li></ul><pre class="line-numbers language-http"><code class="language-http"><span class="token header-name keyword">Age:</span>2383321<span class="token header-name keyword">Date:</span>Wed, 08 Mar 2017 16:12:42 GMT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>代理服务器在 2017 年 3 月 8 日 16:12:42 时向源服务器发起了对该资源的请求, 目前已缓存了该资源 2383321 秒</p><ul><li>Vary: 从代理服务器接收到源服务器返回包含 Vary 指定项的响应之后，若再要进行缓存，仅对请求中含有相同 Vary 指定首部字段的请求返回缓存。即使对相同资源发起请求，但由于 Vary 指定的首部字段不相同，必须要从源服务器重新获取资源。</li></ul><pre class="line-numbers language-http"><code class="language-http"><span class="token header-name keyword">Vary:</span>Accept-Encoding,User-Agent<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>代理服务器将针对是否压缩和浏览器类型去缓存资源. 对于同一个 url, 就能针对 PC 和 Mobile 返回不同的缓存内容</p><ul><li>Pragma: <code>Pragma: no-cache</code> 是 http/1.1 之前的遗留版本，作用与 <code>Cache-Control: no-cache</code> 一样</li></ul><h3 id="CDN-缓存"><a href="#CDN-缓存" class="headerlink" title="CDN 缓存"></a>CDN 缓存</h3><p>CDN 的全称是 Content Delivery Network，即内容分发网络。将网站的内容发布到最接近用户的网络 “ 边缘 “ 的节点，使用户可以就近取得所需的内容，提高用户访问网站的响应速度</p><p>CDN 缓存，也叫网关缓存、反向代理缓存。浏览器先向 CDN 网关发起 WEB 请求，网关服务器后面对应着一台或多台负载均衡源服务器，会根据它们的负载请求，动态地请求转发到合适的源服务器上<br>当客户端向 CDN 节点请求数据时，CDN 节点会判断缓存数据是否过期，若缓存数据并没有过期，则直接将缓存数据返回给客户端；否则，CDN 节点就会向源站发出回源请求（back to the source request），从源站拉取最新数据，更新本地缓存，并将最新数据返回给客户端。</p><p>CDN 服务商一般会提供基于文件后缀、目录多个维度来指定 CDN 缓存时间，为用户提供更精细化的缓存管理。</p><p>CDN 缓存时间会对“回源率”产生直接的影响。若 CDN 缓存时间较短，CDN 边缘节点上的数据会经常失效，导致频繁回源，增加了源站的负载，同时也增大的访问延时；若 CDN 缓存时间太长，会带来数据更新时间慢的问题。开发者需要增对特定的业务，来做特定的数据缓存时间管理。</p><p>优点:</p><ul><li>CDN 节点解决了跨运营商和跨地域访问的问题，访问延时大大降低；</li><li>大部分请求在 CDN 边缘节点完成，CDN 起到了分流作用，减轻了源站的负载。</li></ul><h2 id="chunked-response"><a href="#chunked-response" class="headerlink" title="chunked response"></a>chunked response</h2><p>HTTP 1.1 默认使用的是持久连接 (Persistent Connection)，当服务器返回一个响应时连接不会关闭，如果未申明 <code>Connection: close</code> 关闭长连接，客户端会一直处于 pending 状态。</p><p>要让客户端知道这个响应到哪里结束主要有两种方式:</p><ol><li><p>在响应头上加上 <code>Content-Length</code> 显示申明实体 body 的长度，此时客户端便知道读到哪里结束，但是如果 <code>Content-Length</code> 长度短于实体长度，则内容会被截取；如果超过实体长度，客户端还是会 pending 等待后续缺省的数据。</p></li><li><p>HTTP 1.1 协议在 header 中引入 <code>Transfer-Encoding</code>，当其值为 <code>chunked</code> 时, 表明采用分块编码方式来进行报文体的传输。基本方法是将大块数据分解成多块小数据，每块都可以自定长度。</p></li></ol><p><strong>分块传输的优点:</strong></p><ul><li>HTTP 分块传输编码允许服务器为动态生成的内容以维持 HTTP 持久链接</li><li>分块传输编码允许服务器在最后发送消息头字段。对于那些头字段值在内容被生成之前无法知道的情形非常重要，例如消息的内容要使用散列进行签名，散列的结果通过 HTTP 消息头字段进行传输。没有分块传输编码时，服务器必须缓冲内容直到完成后计算头字段的值并在发送内容前发送这些头字段的值。</li><li>HTTP 服务器有时使用压缩 （gzip 或 deflate）以缩短传输花费的时间。分块传输编码可以用来分隔压缩对象的多个部分。在这种情况下，块不是分别压缩的，而是整个负载进行压缩，压缩的输出使用本文描述的方案进行分块传输。在压缩的情形中，分块编码有利于一边进行压缩一边发送数据，而不是先完成压缩过程以得知压缩后数据的大小。</li></ul><p><strong>格式:</strong></p><p>每一个非空的块都以该块包含数据的字节数（字节数以十六进制表示）开始，跟随一个 CRLF，然后是数据本身，最后 CRLF 结束。</p><p>最后一块是单行，由块大小（0），一些可选的填充空格，以及 CRLF。最后一块不再包含任何数据，但是可以发送可选的尾部，包括消息头字段。</p><p>消息最后以 CRLF 结尾。</p><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token variable-declaration"><span class="token variable">Chunked-Body</span>   <span class="token operator">=</span> <span class="token operator">*</span>chunk</span>                 last-chunk                 trailer                 CRLF<span class="token variable-declaration"><span class="token variable">chunk</span>          <span class="token operator">=</span> chunk-size <span class="token punctuation">[</span> chunk-extension <span class="token punctuation">]</span> CRLF</span>                 <span class="token property-declaration"><span class="token property">chunk-data</span> CRLF</span><span class="token variable-declaration"><span class="token variable">chunk-size</span>     <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">*</span>HEX</span><span class="token variable-declaration"><span class="token variable">last-chunk</span>     <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span> <span class="token punctuation">[</span> chunk-extension <span class="token punctuation">]</span> CRLF</span><span class="token variable-declaration"><span class="token variable">chunk-extension=</span> <span class="token operator">*</span><span class="token punctuation">(</span> <span class="token string">";"</span> chunk-ext-name <span class="token punctuation">[</span> <span class="token string">"="</span> chunk-ext-val <span class="token punctuation">]</span> <span class="token punctuation">)</span></span><span class="token variable-declaration"><span class="token variable">chunk-ext-name</span> <span class="token operator">=</span> token</span><span class="token variable-declaration"><span class="token variable">chunk-ext-val</span>  <span class="token operator">=</span> token | quoted-string</span><span class="token variable-declaration"><span class="token variable">chunk-data</span>     <span class="token operator">=</span> <span class="token func"><span class="token function">chunk-size</span><span class="token punctuation">(</span>OCTET<span class="token punctuation">)</span></span></span><span class="token variable-declaration"><span class="token variable">trailer</span>        <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>entity-header CRLF<span class="token punctuation">)</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例子:</p><pre class="line-numbers language-http"><code class="language-http"><span class="token response-status">HTTP/1.1 <span class="token property">200 OK</span></span><span class="token header-name keyword">Content-Type:</span> text/plain<span class="token header-name keyword">Transfer-Encoding:</span> chunked25This is the data in the first chunk1Cand this is the second one3con8sequence0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token string">"This is the data in the first chunk\r\n"</span>      <span class="token punctuation">(</span>37 字符 => 十六进制<span class="token punctuation">:</span> 0x25<span class="token punctuation">)</span><span class="token string">"and this is the second one\r\n"</span>               <span class="token punctuation">(</span>28 字符 => 十六进制<span class="token punctuation">:</span> 0x1C<span class="token punctuation">)</span><span class="token string">"con"</span>                                          <span class="token punctuation">(</span>3  字符 => 十六进制<span class="token punctuation">:</span> 0x03<span class="token punctuation">)</span><span class="token string">"sequence"</span>                                     <span class="token punctuation">(</span>8  字符 => 十六进制<span class="token punctuation">:</span> 0x08<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>最后以 “0\r\n\r\n” 结束</p><p>解码数据</p><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token property-declaration"><span class="token property">This</span> <span class="token operator">is</span> the data <span class="token operator">in</span> the first chunk</span><span class="token property-declaration"><span class="token property">and</span> this <span class="token operator">is</span> the second one</span>consequence<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>实际抓包数据:</p><p><img src="https://src.wangriyu.wang/images/blog/http/chunked.png" alt="image"></p><p>首部字段 <code>Trailer</code> 会事先说明在报文主体后记录了哪些首部字段，比如</p><pre class="line-numbers language-http"><code class="language-http"><span class="token response-status">HTTP/1.1 <span class="token property">200 OK</span></span><span class="token header-name keyword">Date:</span> Tue, 03 Jul 2012 04:40:56 GMT<span class="token header-name keyword">Content-Type:</span> text/html...<span class="token header-name keyword">Transfer-Encoding:</span> chunked<span class="token header-name keyword">Trailer:</span> Expires<span class="token text/html">...(报文主体)...0Expires: Tue, 28 Sep 2004 23:59:59 GMT</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>请求首部字段 <code>TE</code> 告知服务器 客户端能够处理响应的传输编码方式及相对优先级</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html" target="_blank" rel="noopener">RFC2616</a></li><li><a href="https://zh.wikipedia.org/wiki/%E7%BB%9F%E4%B8%80%E8%B5%84%E6%BA%90%E6%A0%87%E5%BF%97%E7%AC%A6" target="_blank" rel="noopener">wikipedia uri</a></li><li>《图解 HTTP》</li><li><a href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%9D%97%E4%BC%A0%E8%BE%93%E7%BC%96%E7%A0%81" target="_blank" rel="noopener">Chunked transfer encoding - 分块传输编码 wiki</a></li><li><a href="https://tools.ietf.org/html/rfc2616#section-3.6.1" target="_blank" rel="noopener">RFC 2616 - Chunked Transfer Coding</a></li><li><a href="https://github.com/amandakelake/blog/issues/41" target="_blank" rel="noopener">缓存机制</a></li><li><a href="https://notfalse.net/56/http-stale-response" target="_blank" rel="noopener">http cache</a></li><li><a href="http://imweb.io/topic/55c6f9bac222e3af6ce235b9" target="_blank" rel="noopener">缓存策略</a></li></ul>]]></content>
      
      <categories>
          
          <category> http </category>
          
      </categories>
      
      
        <tags>
            
            <tag> http 扩展阅读 </tag>
            
            <tag> 网络 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>更换博客评论系统</title>
      <link href="/2018/03-valine.html"/>
      <url>/2018/03-valine.html</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前使用 Disqus，必须翻墙才能显示，而且 Disqus 会产生大量请求，一直想换个评论系统但是好用的好像都倒了 <em>(:зゝ∠)</em></p><p>后来无意间看到 Valine 评论系统，好像很好用，而且简单简洁，试了一下感觉还行，但是这种自建的评论系统消息存储和提醒是问题。</p><p>wildfire 跟 Valine 差不多，不过使用的是 firebase (国内无法访问)和野狗（已倒）作为后端服务，界面更好看但是很久没更新了，而且在 yelee 添加会报错，我只在单独的 html 中试了一下: <a href="/pages/wildfire.html">wildfire page</a></p><p>最后使用了一段时间 valine 后还是打算改为 gitalk</p><h2 id="Yelee-添加-Valine-方法"><a href="#Yelee-添加-Valine-方法" class="headerlink" title="Yelee 添加 Valine 方法"></a>Yelee 添加 Valine 方法</h2><p><a href="https://valine.js.org" target="_blank" rel="noopener">Valine 配置官网</a></p><p>使用前还需要注册一个 <a href="https://leancloud.cn/" target="_blank" rel="noopener">LeanCloud</a> 账户，然后创建一个应用来存储管理评论内容。</p><ol><li>然后修改 Yelee 主题配置文件 <code>_config.yml</code></li></ol><p>添加：</p><pre class="line-numbers language-stylus"><code class="language-stylus">valine<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">on</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">appid</span><span class="token punctuation">:</span> <span class="token operator">**</span><span class="token operator">*</span> # LeanCloud 应用 AppID</span>  <span class="token property-declaration"><span class="token property">appkey</span><span class="token punctuation">:</span> <span class="token operator">**</span><span class="token operator">*</span> # LeanCloud 应用 AppKey</span>  <span class="token property-declaration"><span class="token property">verify</span><span class="token punctuation">:</span> <span class="token boolean">false</span> # 验证码</span>  <span class="token property-declaration"><span class="token property">notify</span><span class="token punctuation">:</span> <span class="token boolean">false</span> # 评论回复邮箱提醒</span>  <span class="token property-declaration"><span class="token property">avatar</span><span class="token punctuation">:</span> retro # 评论列表头像样式：<span class="token string">''</span><span class="token operator">/</span>mm<span class="token operator">/</span>identicon<span class="token operator">/</span>monsterid<span class="token operator">/</span>wavatar<span class="token operator">/</span>retro<span class="token operator">/</span>hide，自定义头像可以到 https<span class="token punctuation">:</span></span><span class="token comment" spellcheck="true">//cn.gravatar.com/ 注册一下</span>  <span class="token property-declaration"><span class="token property">placeholder</span><span class="token punctuation">:</span> Just do it <span class="token operator">!</span> # 评论框占位符</span>CDN<span class="token punctuation">:</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token property-declaration"><span class="token property">valine</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//unpkg.com/valine@1.2.0-beta1/dist/Valine.min.js</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>修改 <code>yelee/layout/_partial/article.ejs</code></li></ol><pre class="line-numbers language-diff"><code class="language-diff"><span class="token deleted">&lt;% if (!index &amp;&amp; post.comments){ %></span>    &lt;% if (theme.duoshuo.on) { %>      &lt;%- partial('comments/duoshuo', {          key: post.path,          title: post.title,          url: config.url+url_for(post.path),          }) %>    &lt;% } else if (theme.youyan.on) { %>        &lt;%- partial('comments/youyan') %>    &lt;% } else if (theme.disqus.on) { %>        &lt;%- partial('comments/disqus', {            shortname: theme.disqus.shortname          }) %>    &lt;% } else if (config.disqus_shortname) { %>        &lt;%- partial('comments/disqus', {            shortname: config.disqus_shortname          }) %><span class="token inserted">+   &lt;% } else if (theme.valine.on){ %></span><span class="token inserted">+       &lt;%- partial('comments/valine', {</span><span class="token inserted">+           key: post.slug,</span><span class="token inserted">+           title: post.title,</span><span class="token inserted">+           url: config.url+url_for(post.path)</span><span class="token inserted">+       }) %></span>    &lt;% } %><span class="token deleted">&lt;% } %></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>创建 <code>layout/_partial/comments/valine.ejs</code> 文件</li></ol><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>comments<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">2</span>em<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">2</span>em<span class="token punctuation">;</span> <span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">255</span>, <span class="token number">255</span>, <span class="token number">255</span>, <span class="token number">0.5</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>vcomment<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>comment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>//cdn1.lncld.net/static/js/3.0.4/av-min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%- theme.CDN.valine %<span class="token punctuation">></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span>      new Valine({        el: '#vcomment',        notify: '&lt;%= theme.valine.notify %>',        verify: '&lt;%= theme.valine.verify %>',        app_id: "&lt;%= theme.valine.appid %>",        app_key: "&lt;%= theme.valine.appkey %>",        placeholder: "&lt;%= theme.valine.placeholder %>",        avatar: "&lt;%= theme.valine.avatar %>"      });    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>在 <code>yelee/source/css/_partial/mobile.styl</code> 中添加</li></ol><pre class="line-numbers language-css"><code class="language-css"><span class="token selector"><span class="token id">#comments</span> </span><span class="token punctuation">{</span>    <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">10</span>/<span class="token number">16</span><span class="token punctuation">)</span>rem <span class="token number">10</span>px <span class="token important">!important</span><span class="token punctuation">;</span>    <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">1</span>rem <span class="token important">!important</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Yelee-添加-gitalk-方法"><a href="#Yelee-添加-gitalk-方法" class="headerlink" title="Yelee 添加 gitalk 方法"></a>Yelee 添加 gitalk 方法</h2><p>1、注册一个 Github OAuth application: <a href="https://github.com/settings/applications/new" target="_blank" rel="noopener">https://github.com/settings/applications/new</a></p><p>记下 <code>clientID</code> 和 <code>clientSecret</code></p><p>2、在主题配置文件 _config.yml 中添加</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">gitalk</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">clientID</span><span class="token punctuation">:</span> <span class="token string">'your clientID'</span>  <span class="token key atrule">clientSecret</span><span class="token punctuation">:</span> <span class="token string">'your clientSecret'</span>  <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">'wangriyu.github.io'</span> <span class="token comment" spellcheck="true"># 仓库地址</span>  <span class="token key atrule">owner</span><span class="token punctuation">:</span> <span class="token string">'wangriyu'</span> <span class="token comment" spellcheck="true"># 拥有者</span>  <span class="token key atrule">admin</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'wangriyu'</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># admin 用户</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>3、_partial/comments 下创建 gitalk.ejs</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span>section id<span class="token operator">=</span><span class="token string">'comments'</span> style<span class="token operator">=</span><span class="token string">'margin: 2em; padding: 2em; background: rgba(255, 255, 255, 0.5)'</span><span class="token operator">></span>  <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"https://unpkg.com/gitalk/dist/gitalk.css"</span><span class="token operator">></span>  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"https://unpkg.com/gitalk@latest/dist/gitalk.min.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"gitalk-container"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/javascript"</span><span class="token operator">></span>    <span class="token keyword">var</span> gitalk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gitalk</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      clientID<span class="token punctuation">:</span> <span class="token string">'&lt;%= theme.gitalk.clientID %>'</span><span class="token punctuation">,</span>      clientSecret<span class="token punctuation">:</span> <span class="token string">'&lt;%= theme.gitalk.clientSecret %>'</span><span class="token punctuation">,</span>      repo<span class="token punctuation">:</span> <span class="token string">'&lt;%= theme.gitalk.repo %>'</span><span class="token punctuation">,</span>      owner<span class="token punctuation">:</span> <span class="token string">'&lt;%= theme.gitalk.owner %>'</span><span class="token punctuation">,</span>      admin<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'&lt;%= theme.gitalk.owner %>'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      id<span class="token punctuation">:</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname    <span class="token punctuation">}</span><span class="token punctuation">)</span>    gitalk<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'gitalk-container'</span><span class="token punctuation">)</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>section<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>4、修改 _partial/article.ejs</p><pre class="line-numbers language-diff"><code class="language-diff"><span class="token deleted">&lt;% if (!index &amp;&amp; post.comments){ %></span>    &lt;% if (theme.duoshuo.on) { %>      &lt;%- partial('comments/duoshuo', {          key: post.path,          title: post.title,          url: config.url+url_for(post.path),          }) %>    &lt;% } else if (theme.youyan.on) { %>        &lt;%- partial('comments/youyan') %>    &lt;% } else if (theme.disqus.on) { %>        &lt;%- partial('comments/disqus', {            shortname: theme.disqus.shortname          }) %>    &lt;% } else if (config.disqus_shortname) { %>        &lt;%- partial('comments/disqus', {            shortname: config.disqus_shortname          }) %>    &lt;% } else if (theme.valine.on) { %>        &lt;%- partial('comments/valine', {          key: post.slug,          title: post.title,          url: config.url+url_for(post.path)        }) %><span class="token inserted">+   &lt;% } else if (theme.gitalk.on) { %></span><span class="token inserted">+       &lt;%- partial('comments/gitalk') %></span>    &lt;% } %><span class="token deleted">&lt;% } %></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      <categories>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Yelee </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>GithubPages 绑定二级域名并开启 HTTPS</title>
      <link href="/2018/01-githubpage.html"/>
      <url>/2018/01-githubpage.html</url>
      <content type="html"><![CDATA[<h2 id="1-创建-github-仓库"><a href="#1-创建-github-仓库" class="headerlink" title="1. 创建 github 仓库"></a>1. 创建 github 仓库</h2><p>通常使用 GithubPages 创建个人主页需要创建一个与用户名同名的 <code>XXX.github.io</code> 仓库</p><p>以我的博客为例，创建一个新仓库 <code>wangriyu.github.io</code>，上传网页文件，然后在仓库设置里开启 GitHub Pages 功能</p><p>此时应该能够在浏览器中输入 <a href="https://wangriyu.github.io" target="_blank" rel="noopener">https://wangriyu.github.io</a> 访问自己的网页了</p><p>而且 GithubPages 默认开启 HTTPS</p><h2 id="2-绑定自定义域名"><a href="#2-绑定自定义域名" class="headerlink" title="2. 绑定自定义域名"></a>2. 绑定自定义域名</h2><p>到 <a href="https://wanwang.aliyun.com" target="_blank" rel="noopener">万网</a> 上买个喜欢的域名，比如我买了 <code>wangriyu.wang</code>(可惜买不到 <code>riyu.wang</code>)</p><p>到上面的仓库目录下添加 <code>CNAME</code> 文件，里面的内容就是我的域名，比如我的就写了二级域名 <code>blog.wangriyu.wang</code></p><p>此时 Github Pages 看起来是这样的</p><p><img src="https://src.wangriyu.wang/images/blog/githubpages/githubpages.png" alt="image"></p><p><code>Enforce HTTPS</code> 选项显示 <code>Unavailable for your site because you have a custom domain configured</code></p><p>自定义域名不提供 HTTPS 服务</p><p>此时还无法访问 <a href="http://blog.wangriyu.wang">http://blog.wangriyu.wang</a>, 需要到 DNS 服务商那配置 DNS 解析，比如阿里云的即可</p><h2 id="3-配置-DNS-解析"><a href="#3-配置-DNS-解析" class="headerlink" title="3. 配置 DNS 解析"></a>3. 配置 DNS 解析</h2><p>打开 <a href="https://home.console.aliyun.com/new#/" target="_blank" rel="noopener">阿里云的域名控制台</a>，点击自己域名的解析按钮进入 DNS 设置页，添加解析:</p><p><img src="https://src.wangriyu.wang/images/blog/githubpages/DNS.png" alt="image"></p><ul><li>记录类型中 A 类填的是 IP 地址，CNAME 类填的是域名，我们需要把 wangriyu.github.io 转向 blog.wangriyu.wang, 所以填 CNAME</li><li>主机记录填二级域名即可，‘@’ 值代表一级域名，更多选项见阿里云说明</li><li>解析路线填默认即可，如果分国内国外需要另外选择使其能够根据国内外 IP 解析到不同地址</li><li>记录值就是我们的原域名 wangriyu.github.io，如果记录类型是 A 类这里需要填 IP 地址 (可以 PING 一下得到)</li></ul><p>等待 DNS 生效即可通过 <a href="http://blog.wangriyu.wang">http://blog.wangriyu.wang</a> 访问自己的网页了，而且原本的 <a href="https://wangriyu.github.io" target="_blank" rel="noopener">https://wangriyu.github.io</a><br>也会重定向到自定义域名上</p><p>DNS 解析这里我用了二级域名 blog 访问博客，还可以添加别的二级域名，比如我用了 home 访问我的另一个仓库 <a href="https://github.com/wangriyu/homepage" target="_blank" rel="noopener">https://github.com/wangriyu/homepage</a></p><p>只要在新的仓库根目录下添加 <code>CNAME</code> 文件并写入添加的有效二级域名 (home.wangriyu.wang), 再开启 GithubPages 功能即可访问另一个主页</p><h2 id="4-实现自定义域名-HTTPS"><a href="#4-实现自定义域名-HTTPS" class="headerlink" title="4. 实现自定义域名 HTTPS"></a>4. 实现自定义域名 HTTPS</h2><h3 id="到-CloudFlare-注册一个账号，注册成功后在返回的页面中添加域名-一级域名-wangriyu-wang-，点击扫描-DNS-记录"><a href="#到-CloudFlare-注册一个账号，注册成功后在返回的页面中添加域名-一级域名-wangriyu-wang-，点击扫描-DNS-记录" class="headerlink" title="到 CloudFlare 注册一个账号，注册成功后在返回的页面中添加域名 (一级域名 wangriyu.wang)，点击扫描 DNS 记录"></a>到 <a href="https://www.cloudflare.com/" target="_blank" rel="noopener">CloudFlare</a> 注册一个账号，注册成功后在返回的页面中添加域名 (一级域名 wangriyu.wang)，点击扫描 DNS 记录</h3><p><img src="https://zhouhao.me/img/https_20170721_3.png" alt="image"></p><h3 id="添加域名解析"><a href="#添加域名解析" class="headerlink" title="添加域名解析"></a>添加域名解析</h3><p>如果 DNS 扫描不到你的解析记录，可以手动添加，与上面的添加方法类似</p><p><img src="https://src.wangriyu.wang/images/blog/githubpages/cloundflare.png" alt="image"></p><h3 id="修改域名服务器"><a href="#修改域名服务器" class="headerlink" title="修改域名服务器"></a>修改域名服务器</h3><p>我用的是万网的 DNS，所以现在要在万网的域名控制台将 DNS 服务器修改至 CloudFlare 提供的域名服务器</p><p><img src="https://src.wangriyu.wang/images/blog/githubpages/nameserver.png" alt="image"></p><p>进入万网的域名控制台，点击域名的管理按钮，修改域名 DNS 为 CloudFlare 提供的</p><p><img src="https://zhouhao.me/img/https_20170721_6.png" alt="image"></p><h3 id="回到-CloudFlare-页面，设置-SSL-为-Flexible"><a href="#回到-CloudFlare-页面，设置-SSL-为-Flexible" class="headerlink" title="回到 CloudFlare 页面，设置 SSL 为 Flexible"></a>回到 CloudFlare 页面，设置 SSL 为 Flexible</h3><p><img src="https://zhouhao.me/img/https_20170721_7.png" alt="image"></p><h3 id="添加路由重定向规则"><a href="#添加路由重定向规则" class="headerlink" title="添加路由重定向规则"></a>添加路由重定向规则</h3><p>在 <code>Page Rules</code> 里使用通配符将路由重定向到 HTTPS 的链接</p><p><img src="https://src.wangriyu.wang/images/blog/githubpages/pagerules.png" alt="image"></p><p>待设置生效后再访问 <a href="http://blog.wangriyu.wang">http://blog.wangriyu.wang</a> 就会变成 https 了</p><p>具体原理如图，cloundflare 访问原网址的服务器获取储存原网页文件，用户再访问 cloundflare 的加密连接<br>如果在控制台中 Ping 一下 CloudFlare 代理前后的网址就会发现博客 ip 变了</p><p><img src="https://src.wangriyu.wang/images/blog/githubpages/FlexibleSSL.png" alt="image"></p><p>除此之外，在 CloudFlare 控制台中还提供了很多服务，比如 js、html 等静态文件压缩，设置浏览器缓存过期时间，<br>清空 CloudFlare 服务器缓存 (强制刷新资源，避免原网页更新用户访问的还是旧资源) 等等</p><p>更多技巧见文章: <a href="https://wzfou.com/cloudflare/" target="_blank" rel="noopener">十个你可能不知道的 CloudFlare 免费 CDN 加速技巧 -SSL\DDOS\Cache</a></p><p>cloundflare 的服务很适合博客这样的静态网页，也弥补了 GithubPages 的不足</p>]]></content>
      
      <categories>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Yelee </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Dart 语法入门 V</title>
      <link href="/2017/12-Dart%20V.html"/>
      <url>/2017/12-Dart%20V.html</url>
      <content type="html"><![CDATA[<h2 id="分离-Isolates"><a href="#分离-Isolates" class="headerlink" title="分离 Isolates"></a>分离 Isolates</h2><p>现在的网页浏览器，甚至是移动平台上的，运行在多核 CPU 之上。为了充分利用多核心的优势，开发人员通常对共享内存的线程采取并行策略。然而，在共享状态下使用并发容易出错并且会使代码复杂化。<br>Dart 在代码中使用 isolates 来替代线程。每个 isolate 有自己的内存堆，以确保 isolate 的状态不能被其他任何 isolate 访问。</p><hr><h2 id="类型定义-Typedefs"><a href="#类型定义-Typedefs" class="headerlink" title="类型定义 Typedefs"></a>类型定义 Typedefs</h2><p>在 Dart 中，方法是对象，就像字符串和数字也是对象。typedef , 又被称作函数类型别名，让你可以为函数类型命名，并且该命名可以在声明字段和返回类型的时候使用。当一种函数类型被分配给一个变量的时候，typedef 会记录原本的类型信息。<br>考虑下面的代码，哪一个没有使用 typedef：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">SortedCollection</span> <span class="token punctuation">{</span>  Function compare<span class="token punctuation">;</span>  <span class="token function">SortedCollection</span><span class="token punctuation">(</span>int <span class="token function">f</span><span class="token punctuation">(</span>Object a<span class="token punctuation">,</span> Object b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    compare <span class="token operator">=</span> f<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// Initial, broken implementation.</span> int <span class="token function">sort</span><span class="token punctuation">(</span>Object a<span class="token punctuation">,</span> Object b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  SortedCollection coll <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SortedCollection</span><span class="token punctuation">(</span>sort<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// All we know is that compare is a function,</span>  <span class="token comment" spellcheck="true">// but what type of function?</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>coll<span class="token punctuation">.</span>compare <span class="token operator">is</span> Function<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当 f 分配到 compare 的时候类型信息丢失了。f 的类型是 (Object, Object) → int(→ 意味着返回的)，然而 compare 的类型是方法。如果我们使用显式的名字更改代码并保留类型信息，则开发者和工具都可以使用这些信息。</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">typedef</span> int <span class="token function">Compare</span><span class="token punctuation">(</span>Object a<span class="token punctuation">,</span> Object b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">SortedCollection</span> <span class="token punctuation">{</span>  Compare compare<span class="token punctuation">;</span>  <span class="token function">SortedCollection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>compare<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// Initial, broken implementation.</span> int <span class="token function">sort</span><span class="token punctuation">(</span>Object a<span class="token punctuation">,</span> Object b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  SortedCollection coll <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SortedCollection</span><span class="token punctuation">(</span>sort<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>coll<span class="token punctuation">.</span>compare <span class="token operator">is</span> Function<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>coll<span class="token punctuation">.</span>compare <span class="token operator">is</span> Compare<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>目前 typedefs 仅限于函数类型，以后可能会有所改变。</p></blockquote><p>typedefs 是简单的别名，所以它提供了一种方法来检查任何函数的类型。比如：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">typedef</span> int <span class="token function">Compare</span><span class="token punctuation">(</span>int a<span class="token punctuation">,</span> int b<span class="token punctuation">)</span><span class="token punctuation">;</span>int <span class="token function">sort</span><span class="token punctuation">(</span>int a<span class="token punctuation">,</span> int b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> a <span class="token operator">-</span> b<span class="token punctuation">;</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>sort <span class="token operator">is</span> Compare<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// True</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="元数据-Metadata"><a href="#元数据-Metadata" class="headerlink" title="元数据 Metadata"></a>元数据 Metadata</h2><p>使用元数据来给你的代码提供附加信息。<br>元数据注解以 @ 字符开头，后面跟一个编译时的常量引用（例如 deprecated）或者调用常量构造器的语句。<br>所有的 Dart 代码中支持三个注解：@deprecated，@override 和 @proxy。@override 和 @proxy 的用法示例，请查看 <a href="https://www.dartlang.org/guides/language/language-tour#extending-a-class" target="_blank" rel="noopener">类的继承</a>。以下是 @deprecated 用法的示例：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Television</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Deprecated: Use [turnOn] instead</span>  <span class="token metadata symbol">@deprecated</span>  <span class="token keyword">void</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">turnOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// Turns the TV's power on.</span>  <span class="token keyword">void</span> <span class="token function">turnOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'on!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你可以定义你自己的元数据注解。下面的例子定义了一个有两个参数的 @todo 注解：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">library</span> todo<span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">todo</span> <span class="token punctuation">{</span>  <span class="token keyword">final</span> String who<span class="token punctuation">;</span>  <span class="token keyword">final</span> String what<span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token function">todo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>who<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面是使用 @todo 注解的例子：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string">'todo.dart'</span><span class="token punctuation">;</span><span class="token metadata symbol">@todo</span><span class="token punctuation">(</span><span class="token string">'seth'</span><span class="token punctuation">,</span> <span class="token string">'make this do something'</span><span class="token punctuation">)</span><span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'do something'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>元数据可以出现在库、类、typedef、类型参数、构造器、工厂、函数、属性、参数、变量声明、import 或 export 指令之前。你可以在运行时通过反射来取回元数据。</p><hr><h2 id="注释-Comments"><a href="#注释-Comments" class="headerlink" title="注释 Comments"></a>注释 Comments</h2><p>Dart 支持单行注释、多行注释和文档注释。</p><ul><li><p>单行注释由 // 开始</p></li><li><p>多行注释由 /<em> 开始，由 </em>/ 结束，多行注释可以嵌套</p></li><li><p>文档注释是由 /// 或 /** 开始的多行或单行注释<br>在连续的行上使用 /// 的效果等同于多行注释。<br>在一段文档注释中，Dart 编译器忽略所有除括号内的文本。你可以使用括号来引用类、方法、属性、顶级变量、函数和参数。括号中的名字会在被文档化程序元素的词法范围内解析。<br>下面是一个引用了其它类和参数的文档注释的例子：</p></li></ul><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">/// A domesticated South American camelid (Lama glama).</span><span class="token comment" spellcheck="true">///</span><span class="token comment" spellcheck="true">/// Andean cultures have used llamas as meat and pack</span><span class="token comment" spellcheck="true">/// animals since pre-Hispanic times.</span><span class="token keyword">class</span> <span class="token class-name">Llama</span> <span class="token punctuation">{</span>  String name<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/// Feeds your llama [Food].</span>  <span class="token comment" spellcheck="true">///</span>  <span class="token comment" spellcheck="true">/// The typical llama eats one bale of hay per week.</span>  <span class="token keyword">void</span> <span class="token function">feed</span><span class="token punctuation">(</span>Food food<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/// Exercises your llama with an [activity] for</span>  <span class="token comment" spellcheck="true">/// [timeLimit] minutes.</span>  <span class="token keyword">void</span> <span class="token function">exercise</span><span class="token punctuation">(</span>Activity activity<span class="token punctuation">,</span> int timeLimit<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在生成的文档中， [food] 变成了指向 Food 类的 API 文档连接。</p><hr><p><strong>更多内容</strong></p><ul><li><a href="https://www.dartlang.org/articles" target="_blank" rel="noopener">文章</a></li><li><a href="https://www.dartlang.org/dart-vm/dart-by-example" target="_blank" rel="noopener">代码用法示例</a></li><li><a href="https://www.dartlang.org/guides/libraries/library-tour" target="_blank" rel="noopener">Dart 核心库</a></li><li><a href="https://www.dartlang.org/guides/language/effective-dart" target="_blank" rel="noopener">Effective Dart</a></li><li><a href="https://www.dartlang.org/tutorials/language/futures" target="_blank" rel="noopener">Futures 教程</a></li><li><a href="https://www.dartlang.org/docs/tutorials/streams" target="_blank" rel="noopener">Streams 教程</a></li></ul>]]></content>
      
      <categories>
          
          <category> Dart </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dart </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>极具性价比的 Mac 存储扩展方案</title>
      <link href="/2017/12-MacStorageExpansion.html"/>
      <url>/2017/12-MacStorageExpansion.html</url>
      <content type="html"><![CDATA[<h2 id="常见-Mac-扩容方案"><a href="#常见-Mac-扩容方案" class="headerlink" title="常见 Mac 扩容方案"></a>常见 Mac 扩容方案</h2><ul><li>直接更换大容量 SSD：效果最好，速度最快，成本最高，需要专业人士操刀</li><li>外接移动硬盘：容量大速度也挺快，还算便捷但是不方便，而且占用一个 usb</li><li>外接小尺寸 U 盘：像三星这个 <a href="https://item.jd.com/2154209.html" target="_blank" rel="noopener">https://item.jd.com/2154209.html</a> ，占用空间小，速度也还行，但会占用一个 usb</li><li>利用 SD 卡槽扩展：比如创见的 <a href="https://item.jd.com/1212838.html" target="_blank" rel="noopener">JetDrive Lite</a> 扩展卡，专为 Mac 设计，速度也还可以，但是性价比一般</li><li>本文同样利用 SD 卡槽扩展但性价比远超 JetDrive Lite</li></ul><h2 id="准备物品"><a href="#准备物品" class="headerlink" title="准备物品"></a>准备物品</h2><ul><li>三星 Evo Plus UHS 高速 MicroSD 卡 - 128G，某东上活动价 249，速度和稳定性比较好，选择其他类似的 tf 卡也可以</li></ul><p><img src="https://src.wangriyu.wang/images/blog/MacStorage/SamsungEvoPlus.png" width="50%"></p><ul><li>适配 Mac SD 卡槽的卡套，某宝上几块钱一个，这东西只是转接作用，不影响速度，主要是长度问题，普通卡套插上 Mac 会突出一部分影响体验，而且需要注意不同 Mac 版本 SD 卡槽深度不一，买前请留意</li></ul><p><img src="https://src.wangriyu.wang/images/blog/MacStorage/IMG_20171224_214833.jpg" width="50%"><br><img src="https://src.wangriyu.wang/images/blog/MacStorage/IMG_20171224_214954.jpg" width="50%"></p><ul><li>四合一读卡器，这个可有可无，我只是推荐一下，配合这个读卡器可以在需要转储文件时很方便的连接安卓、苹果、电脑等</li></ul><p><img src="https://src.wangriyu.wang/images/blog/MacStorage/IMG_20171224_214714.jpg" width="50%"></p><h2 id="最后效果"><a href="#最后效果" class="headerlink" title="最后效果"></a>最后效果</h2><p><img src="https://src.wangriyu.wang/images/blog/MacStorage/IMG_20171231_210739.jpg" width="50%"></p><p>全套工具<br><img src="https://src.wangriyu.wang/images/blog/MacStorage/IMG_20171224_224139.jpg" width="50%"></p><p>速度测试，读写基本稳定几十 M 每秒，普通使用足矣<br><img src="https://src.wangriyu.wang/images/blog/MacStorage/SpeedTest.png" width="50%"></p><h2 id="注意的点"><a href="#注意的点" class="headerlink" title="注意的点"></a>注意的点</h2><ul><li>SD 卡在速度上可靠性上不如前面那些方案，适合存储一些图片视频音乐的文件，但像系统或者比较细碎的文件经常反复读写的文件不建议存 SD 卡里</li><li>SD 卡的常见格式有 exFat、Fat32、NTFS，像我这样会在多设备间转储的，包括 Mac、Windows、Android、ios 等，SD 卡格式最好的选择是 exFat，基本都支持此格式而且支持 4g 以上的单文件，而 Fat32 兼容性最好但不支持 4g 以上的单文件</li><li>exFat 格式的 SD 卡在部分安卓设备上无法识别，我的手机就识别不了，以下方法 (没有 root 的情况) 可以通过第三方软件实现读取<br>详细步骤见视频：<br><a href="https://www.youtube.com/watch?v=Daaydbsc5_c" target="_blank" rel="noopener">How to Mount NTFS/EXFat in your Android device without root</a><br>相关软件：<ul><li>Total Commender <a href="https://play.google.com/store/apps/details?id=com.ghisler.android.TotalCommander&amp;hl=en" target="_blank" rel="noopener">https://play.google.com/store/apps/details?id=com.ghisler.android.TotalCommander&amp;hl=en</a></li><li>USB-Stick Plugin <a href="https://play.google.com/store/apps/details?id=de.hechler.tcplugins.usbstick&amp;hl=en" target="_blank" rel="noopener">https://play.google.com/store/apps/details?id=de.hechler.tcplugins.usbstick&amp;hl=en</a></li><li>exFat/NTFS for USB <a href="https://play.google.com/store/apps/details?id=com.paragon.tcplugins_ntfs_ro&amp;hl=en" target="_blank" rel="noopener">https://play.google.com/store/apps/details?id=com.paragon.tcplugins_ntfs_ro&amp;hl=en</a></li></ul></li><li>最好在 Finder 中添加一个外接 SD 设备的替身，避免点击到弹出按钮</li></ul><p><img src="https://src.wangriyu.wang/images/blog/MacStorage/finder.gif" width="50%"></p>]]></content>
      
      <categories>
          
          <category> Mac </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mac 存储扩展 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>UEFI + GPT + Win10 + Ubuntu + rEFInd</title>
      <link href="/2017/12-Win+Ubuntu.html"/>
      <url>/2017/12-Win+Ubuntu.html</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>刚好赶上 win10 更新 1709 和 Ubuntu 更新 17.10，心血来潮给我的 Windows 笔记本重装一下系统并加上 Ubuntu，这里记录一下过程，以留备用。我的配置是 256G SSD+1T HHD，两个系统都装在固态盘，如果需要把 Ubuntu 装在机械硬盘里，可能还需要额外做一下引导：<a href="https://www.zhihu.com/question/33461827" target="_blank" rel="noopener">https://www.zhihu.com/question/33461827</a></p><hr><h2 id="安装-win10"><a href="#安装-win10" class="headerlink" title="安装 win10"></a>安装 win10</h2><h3 id="工具："><a href="#工具：" class="headerlink" title="工具："></a>工具：</h3><ul><li>4G 以上 U 盘</li><li>win10 镜像: <a href="https://msdn.itellyou.cn/" target="_blank" rel="noopener">https://msdn.itellyou.cn/</a> MSDN-&gt; 操作系统 -&gt;Windows10,Version1709</li><li>启动盘制作工具 Rufus:<a href="http://rufus.akeo.ie/?locale=zh_CN" target="_blank" rel="noopener">http://rufus.akeo.ie/?locale=zh_CN</a></li></ul><h3 id="制作启动盘"><a href="#制作启动盘" class="headerlink" title="制作启动盘"></a>制作启动盘</h3><ol><li>打开 rufus，选择 U 盘</li><li><code>分区方案和目标系统类型</code> 选择 <code>用于 UEFI 计算机的 GPT 分区方案</code></li><li>文件系统默认 fat32(这个不能改，uefi 只识别这个格式)</li><li>下面的 <code>创建一个启动盘使用</code> 默认选中的即是 <code>ISO 镜像</code>，然后点击右侧的磁盘图标在电脑中找到下载好的 Win10 正式版 ISO 镜像</li><li>最后点击 “开始” 按钮即可开始制作支持 UEFI 启动的 Win10 系统安装 U 盘</li></ol><h3 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h3><ol><li>插上 U 盘重启电脑，进入 BIOS 选择开机启动项为自己做好的的 <code>uefi U 盘</code>，保存重启</li><li>能进入 win10 安装界面则成功了一半，如果进不去需要检查一下之前 U 盘是否写入成功，还有 bios 的 uefi 是否打开</li><li>进入 win10 安装界面，选择安装，提示输入密钥，可以先跳过</li><li>接受许可条款后，提示选择 <code>安装类型</code>，点击自定义安装进入分区界面</li></ol><p><img src="https://src.wangriyu.wang/images/blog/win10&amp;ubuntu/partition.png" alt="iamge"></p><p>这里网上找的图，实际情况按自身需求处理，我的是驱动器 0 代表固态，1 代表机械，然后我把固态的分区全删除，在未分配的空间上新建分区，给 win10 系统盘 C 盘分配 80GB(uefi 会在系统盘的基础上自动多创建几个分区用于 uefi 引导)，再划分 100GB 做 D 盘，留 50GB 未分配的空间 (之后安装 Ubuntu)，分完区 <code>注意选中你要安装系统的盘即第一个分的 C 盘</code>，再点下一步进入正式安装</p><p>⚠️如果这里点新建，如果新建不了可能是硬盘格式不对，mbr 格式的磁盘需要先全部删除才能转成 GPT 格式，然后再新建</p><ol start="5"><li>安装完正常会自动进入系统，如果没有进去，可能得进 BIOS 把开机启动项改回系统，并退出 U 盘</li><li>进入系统，刚开始没有桌面图标可以到主题设置里找，我的电脑没有硬盘可以右键 <code>系统菜单</code> 或者 <code>我的电脑</code> 选择并进入磁盘管理给分区分配盘符，联网后系统更新会自动下载安装电脑驱动，分享一些我常年收藏的工具：<a href="https://mega.nz/#F!AOwwyaZY!iR2HEt15jl2chNbEfs6_Nw" target="_blank" rel="noopener">https://mega.nz/#F!AOwwyaZY!iR2HEt15jl2chNbEfs6_Nw</a></li></ol><hr><h2 id="安装-Ubuntu"><a href="#安装-Ubuntu" class="headerlink" title="安装 Ubuntu"></a>安装 Ubuntu</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul><li>2G 以上的 U 盘</li><li>Ubuntu 镜像：<a href="https://www.ubuntu.com/download/desktop" target="_blank" rel="noopener">https://www.ubuntu.com/download/desktop</a></li><li>启动盘制作工具 Rufus</li><li>同样打开 Rufus，步骤同上，制作好启动盘</li></ul><h3 id="开始安装-1"><a href="#开始安装-1" class="headerlink" title="开始安装"></a>开始安装</h3><ol><li>还是插上 U 盘改启动项进入 Ubuntu 安装界面，一样的套路</li><li>刚开始会选择 <code>try Ubuntu</code> 或者 <code>install Ubuntu</code>，那个都可以，try 就是先尝试一下然后再安装</li><li>正式进入安装程序后，出现 <code>为图形或无线硬件安装第三方软件</code> 不勾选，直接继续，避免安装过程下载东西</li><li>出现 <code>已安装 Windows10，准备如何安装 Ubuntu</code>，选择 <code>其他选项</code></li><li>出现选择分区时，选中之前留下来的 50GB 未分配的空闲空间，千万别选错了。选中后点 + 号新建分区，分区可以按下图示例 (盗的图) 进行分，/ 是 linux 根目录的空间大小、交换空间 swap 是虚拟内存大小 (按个人需求调整大小)、/boot 是启动引导的分区 (一般 200MB 足够)、/home 是给 home 目录分配独立分区并分配一定大小，也可以不分把所有空间放到根目录下<br><img src="https://src.wangriyu.wang/images/blog/win10&amp;ubuntu/1.png" alt="image"><br><img src="https://src.wangriyu.wang/images/blog/win10&amp;ubuntu/2.png" alt="image"><br><img src="https://src.wangriyu.wang/images/blog/win10&amp;ubuntu/3.png" alt="image"><br><img src="https://src.wangriyu.wang/images/blog/win10&amp;ubuntu/4.png" alt="image"><br>⚠️分好区后 <code>安装启动引导器的设备</code> 时要选中 / boot 分区所在的设备</li><li>点安装下一步确认改动，等待安装完成</li><li>安装完退出 U 盘重启，可以选择启动项，点 Ubuntu 进 linux，点 Windows boot manager 进 win10，但这个 grub 引导界面太丑，下面会使用 rEFInd 引导</li><li>进入 Ubuntu 后一些基础设置可以参考这篇文章：<a href="http://www.jianshu.com/p/62d947731401" target="_blank" rel="noopener">http://www.jianshu.com/p/62d947731401</a></li></ol><hr><h2 id="rEFInd-引导"><a href="#rEFInd-引导" class="headerlink" title="rEFInd 引导"></a><a href="http://www.rodsbooks.com/refind/" title=" 点击访问官网 " target="_blank" rel="noopener">rEFInd</a> 引导</h2><h3 id="安装-rEFInd"><a href="#安装-rEFInd" class="headerlink" title="安装 rEFInd"></a>安装 rEFInd</h3><p>这是官网的安装简介：<br><strong>Ubuntu—Two Ubuntu-specific methods of installing rEFInd in this distribution exist:</strong></p><ul><li>Ubuntu 17.04 (“Zesty Zapus”) includes rEFInd 0.10.4. Note that, like the Debian package, this one is not signed for use with Secure Boot, but if your system includes the sbsigntool package, the installer will generate a local key for this purpose. If you want a more recent version, you can use my PPA or install my Debian package.</li><li>I’ve created a rEFInd PPA for Ubuntu. To use it, open a Terminal window and type the following commands:<pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> apt-add-repository ppa:rodsmith/refind$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> refind<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>You’ll be asked whether to install rEFInd to the ESP when you first install it. Thereafter, the rEFInd version will update along with your other software. This package is built with GNU-EFI and is not signed with a Secure Boot key; however, the install script should sign the binary with a locally-generated key if it detects that your system uses Secure Boot. Thus, if you’ve previously installed one of my binaries on a Secure Boot system and added its key as a MOK, you’ll have to add your local key when you reboot.</li></ul><p>对于 Ubuntu 而言就是关掉 BIOS 里的 <code>Secure Boot</code> 选项（最好关掉），运行上述三条命令即可安装。</p><p>安装好后，文件目录默认是 <code>/boot/efi/efi/refind</code>，我的是这样，安装方式不同可能目录也不一样。之后要修改这里面的配置文件</p><h3 id="更换引导主题"><a href="#更换引导主题" class="headerlink" title="更换引导主题"></a>更换引导主题</h3><p>找到自己想要的主题：<a href="http://www.rodsbooks.com/refind/themes.html" target="_blank" rel="noopener">http://www.rodsbooks.com/refind/themes.html</a><br>比如我用的就是 <a href="https://github.com/EvanPurkhiser/rEFInd-minimal" target="_blank" rel="noopener">Minimal theme</a></p><ol><li>找到 refind 安装目录，比如 [/boot/efi/efi/refind]</li><li>如果不存在 <code>themes</code> 则创建一个 <code>themes</code> 文件夹</li><li>在 themes 目录下创建 <code>minimal</code> 文件夹，把克隆或下载下来的主题文件拷进来</li><li>修改 refind 目录下的 refind.conf 文件，修改配置。注释里有介绍，也可以找官网的介绍，或者其他例子：<a href="https://tieba.baidu.com/p/4459857693" target="_blank" rel="noopener">https://tieba.baidu.com/p/4459857693</a></li></ol><p>我的配置是这样的，可供参考：</p><pre class="line-numbers language-stylus"><code class="language-stylus"># Minimal refind theme# Hide user interface elements for personal preference or to increase# security<span class="token punctuation">:</span>#  banner      - the rEFInd title banner <span class="token punctuation">(</span>built-in or loaded via <span class="token string">"banner"</span><span class="token punctuation">)</span>#  label       - boot option text label in the menu#  singleuser  - remove the submenu options to boot Mac OS X in single-user#                or verbose modes<span class="token punctuation">;</span> affects ONLY MacOS X#  safemode    - remove the submenu option to boot Mac OS X in <span class="token string">"safe mode"</span>#  hwtest      - the submenu option to run Apple's hardware test#  arrows      - scroll arrows on the OS selection tag line#  hints       - brief command summary in the menu#  editor      - the options editor <span class="token punctuation">(</span>+, F2, or Insert on boot options menu<span class="token punctuation">)</span>#  all         - all of the above# Default is none of these <span class="token punctuation">(</span>all elements active<span class="token punctuation">)</span>#<span class="token property-declaration"><span class="token property">hideui</span> singleuser<span class="token punctuation">,</span>hints<span class="token punctuation">,</span>arrows<span class="token punctuation">,</span>badges</span># Set the name of a subdirectory in which icons are stored<span class="token punctuation">.</span> Icons must# have the same names they have in the standard directory<span class="token punctuation">.</span> The directory# name is specified relative to the main rEFInd binary's directory<span class="token punctuation">.</span> If# an icon can't be found in the specified directory, an attempt is made# to load it from the default directory<span class="token punctuation">;</span> thus, you can replace just some# icons in your own directory and rely on the default for others<span class="token punctuation">.</span># Default is <span class="token string">"icons"</span><span class="token punctuation">.</span>#<span class="token property-declaration"><span class="token property">icons_dir</span> themes<span class="token operator">/</span>minimal<span class="token operator">/</span>icons</span># Use a custom title banner instead of the rEFInd icon and name<span class="token punctuation">.</span> The file# path is relative to the directory where refind<span class="token punctuation">.</span>efi is located<span class="token punctuation">.</span> The color# in the top left corner of the image is used as the background color# for the menu screens<span class="token punctuation">.</span> Currently uncompressed BMP images with color# depths of 24, 8, 4 or 1 bits are supported, as well as PNG images<span class="token punctuation">.</span>#<span class="token property-declaration"><span class="token property">banner</span> themes<span class="token operator">/</span>minimal<span class="token operator">/</span>background<span class="token operator">.</span>png</span># Tells rEFInd whether to display banner images pixel-for-pixel <span class="token punctuation">(</span>noscale<span class="token punctuation">)</span># or to scale banner images to fill the screen <span class="token punctuation">(</span>fillscreen<span class="token punctuation">)</span><span class="token punctuation">.</span> The former is# the default<span class="token punctuation">.</span>#<span class="token property-declaration"><span class="token property">banner_scale</span> fillscreen</span># Custom images for the selection background<span class="token punctuation">.</span> There is a big one <span class="token punctuation">(</span>144 x 144<span class="token punctuation">)</span># for the OS icons, and a small one <span class="token punctuation">(</span>64 x 64<span class="token punctuation">)</span> for the function icons in the<span class="token selector"># second row. If only a small image is given<span class="token punctuation">,</span> that one is also used for# the big icons by stretching it in the middle. If only a big one is given<span class="token punctuation">,</span># the built-in default will be used for the small icons.## Like the banner option above<span class="token punctuation">,</span> these options take a filename of an# uncompressed BMP image file with a color depth of 24<span class="token punctuation">,</span> 8<span class="token punctuation">,</span> 4<span class="token punctuation">,</span> or 1 bits<span class="token punctuation">,</span></span># or a PNG image<span class="token punctuation">.</span> The PNG format is required if you need transparency# support <span class="token punctuation">(</span>to let you <span class="token string">"see through"</span> to a full-screen banner<span class="token punctuation">)</span><span class="token punctuation">.</span>#<span class="token property-declaration"><span class="token property">selection_big</span>   themes<span class="token operator">/</span>rEFInd-minimal<span class="token operator">/</span>selection_big<span class="token operator">.</span>png</span><span class="token property-declaration"><span class="token property">selection_small</span> themes<span class="token operator">/</span>rEFInd-minimal<span class="token operator">/</span>selection_small<span class="token operator">.</span>png</span># Which non-bootloader tools to show on the tools line, and in what# order to display them<span class="token punctuation">:</span>#  shell           - the EFI shell <span class="token punctuation">(</span>requires external program<span class="token punctuation">;</span> see rEFInd#                    documentation for details<span class="token punctuation">)</span>#  gptsync         - the <span class="token punctuation">(</span>dangerous<span class="token punctuation">)</span> gptsync<span class="token punctuation">.</span>efi utility <span class="token punctuation">(</span>requires external#                    program<span class="token punctuation">;</span> see rEFInd documentation for details<span class="token punctuation">)</span>#  apple_recovery  - boots the Apple Recovery HD partition, if present#  mok_tool        - makes available the Machine Owner Key <span class="token punctuation">(</span>MOK<span class="token punctuation">)</span> maintenance#                    tool, MokManager<span class="token punctuation">.</span>efi, used on Secure Boot systems#  about           - an <span class="token string">"about this program"</span> option#  exit            - a tag to exit from rEFInd#  shutdown        - shuts down the computer <span class="token punctuation">(</span>a bug causes this to reboot#                    EFI systems<span class="token punctuation">)</span>#  reboot          - a tag to reboot the computer#  firmware        - a tag to reboot the computer into the firmware's#                    user interface <span class="token punctuation">(</span>ignored on older computers<span class="token punctuation">)</span># Default is shell,apple_recovery,mok_tool,about,shutdown,reboot,firmware#<span class="token property-declaration"><span class="token property">showtools</span> shutdown<span class="token punctuation">,</span>reboot</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最终效果：<br><img src="https://src.wangriyu.wang/images/blog/win10&amp;ubuntu/refind.jpg" alt="image"></p><hr><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul><li><p>Ubuntu 16.04 与 Win10 双系统双硬盘安装图解 <a href="http://blog.csdn.net/fesdgasdgasdg/article/details/54183577" target="_blank" rel="noopener">http://blog.csdn.net/fesdgasdgasdg/article/details/54183577</a></p></li><li><p>最新版 Ubuntu 17.10 与 Windows 双系统安装、配置与美化教程 <a href="http://www.jianshu.com/p/62d947731401" target="_blank" rel="noopener">http://www.jianshu.com/p/62d947731401</a></p></li><li><p>rEFInd 引导教程 - refind 吧 <a href="https://tieba.baidu.com/p/4383185951?red_tag=2713770601" target="_blank" rel="noopener">https://tieba.baidu.com/p/4383185951?red_tag=2713770601</a></p></li></ul>]]></content>
      
      <categories>
          
          <category> Computer </category>
          
      </categories>
      
      
        <tags>
            
            <tag> UEFI&amp;GPT </tag>
            
            <tag> win10&amp;Ubuntu 双系统 </tag>
            
            <tag> rEFInd 引导美化 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Dart 语法入门 IV</title>
      <link href="/2017/12-Dart%20IV.html"/>
      <url>/2017/12-Dart%20IV.html</url>
      <content type="html"><![CDATA[<h2 id="泛型-Generics"><a href="#泛型-Generics" class="headerlink" title="泛型 Generics"></a>泛型 Generics</h2><p>如果你在 API 文档寻找基本数组类型或者 List 类型，你将会看到该类型实际上为 List<e>, 其中&lt;…&gt;标记表示此表为一个泛型类型（或为参数化结构）—— 一种含有正规类型参数的类型。按照惯例，类型变量通常为单字符名称，例如 E, T, S, K 以及 V。</e></p><h3 id="为何要使用泛型？"><a href="#为何要使用泛型？" class="headerlink" title="为何要使用泛型？"></a>为何要使用泛型？</h3><p>因为在 Dart 中类型是可选的，你不一定要使用泛型。或许你想用，可是，因为一些相同的原因你会想在代码中使用其他的类型：这些类型（泛型或者其他类型）可以记录并注释你的代码，使你的意图更加清晰。</p><p>比如，如果你打算使用一个仅仅包含字符串的 List，你可以声明它为 List<string>（可理解为“字符串类型组成的 List”），通过这种方式，你的程序员同事，以及你的工具（比如 Dart 编辑器和调试模式下的 Dart 虚拟机）能检测到将一个非字符串的变量分配到 List 中很可能是错误的，这里给出一个样例：</string></p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>names<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Seth'</span><span class="token punctuation">,</span> <span class="token string">'Kathy'</span><span class="token punctuation">,</span> <span class="token string">'Lars'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ...</span>names<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 在调试模式中失败 (在生产模式中成功)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>另外一个使用泛型的原因是为了减少代码的重复。泛型可以让你能共享多个类型的一个接口和实现方式，它在调试模式以及静态分析的错误预警中仍然很有优势。举个例子，当你在创建一个接口来缓存一个对象时：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ObjectCache</span><span class="token punctuation">{</span>  object <span class="token function">getByKey</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setByKey</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span>Object value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>你发现你想要一个字符串专用的接口，所以你创建了另外一个接口：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">StringCache</span><span class="token punctuation">{</span>  string <span class="token function">getByKey</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setByKey</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span>String value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>当你想要一个这种接口的数字专用的接口，又要创建不同类型的接口。<br>泛型类型可以减少你创建这些接口的麻烦。取而代之的是，你只需要创建一个带有一个类型参数的接口即可：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Cache</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">{</span>  T <span class="token function">getByKey</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setByKey</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span>T value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在这个代码中，T 是一个替代类型，即占位符，你可以将他视为后续被开发者定义的类型。</p><h3 id="使用集合常量"><a href="#使用集合常量" class="headerlink" title="使用集合常量"></a>使用集合常量</h3><p>Lis 常量以及 map 常量都能被参数化，参数常量就像你已经见过的常量那样，除非你在左 方括号之前添加<type>(对于 List）或者&lt;keyType,valuetype&gt;(对于 map）。当你需要避免调试模式下的类型警告，你或许可以使用参数常量。这里有一个使用常量类型的例子：</type></p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> names <span class="token operator">=</span> <span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">[</span><span class="token string">'Seth'</span><span class="token punctuation">,</span> <span class="token string">'Kathy'</span><span class="token punctuation">,</span> <span class="token string">'Lars'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> pages <span class="token operator">=</span> <span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">{</span>  <span class="token string">'index.html'</span><span class="token punctuation">:</span> <span class="token string">'Homepage'</span><span class="token punctuation">,</span>  <span class="token string">'robots.txt'</span><span class="token punctuation">:</span> <span class="token string">'Hints for web robots'</span><span class="token punctuation">,</span>  <span class="token string">'humans.txt'</span><span class="token punctuation">:</span> <span class="token string">'We are people, not machines'</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用带构造器的参数化类型"><a href="#使用带构造器的参数化类型" class="headerlink" title="使用带构造器的参数化类型"></a>使用带构造器的参数化类型</h3><p>为了在使用构造器时详细说明一个或多个类型，将类型放入类名后的三角括号（&lt;…&gt;）中，举个例子：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>names<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span>‘Seth’<span class="token punctuation">,</span> ‘Kathy’ <span class="token punctuation">,</span> ‘Lars’<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> nameSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>下列代码创建了一个含有整型的键以及值为 View 的 map：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> views <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>int<span class="token punctuation">,</span>view<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="泛型集合及其包含的类型"><a href="#泛型集合及其包含的类型" class="headerlink" title="泛型集合及其包含的类型"></a>泛型集合及其包含的类型</h3><p>Dart 泛型类型是被具体化的，意思就是它们在整个运行时间中都携带着类型信息。举个例子，你可以测试一个集合中的类型甚至是在生产模式中：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>names<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Seth'</span><span class="token punctuation">,</span> <span class="token string">'Kathy'</span><span class="token punctuation">,</span> <span class="token string">'Lars'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print</span><span class="token punctuation">(</span>names <span class="token operator">is</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然而，is 表达式检查的仅仅是集合中的类型并不是其中的对象。在生产模式下，一个 List<string>中可能含有一些非字符项，解决方法可以是逐项检查其类型或者在异常处理程序中加入数据项操作代码 (参见 <a href="">异常</a>)。</string></p><blockquote><p>相比之下，Java 中的泛型使用擦除，这意味着通用类型参数在运行时被删除。在 Java 中，您可以测试对象是否为 List，但是不能测试它是否为 List<string></string></p></blockquote><h3 id="限制参数化类型"><a href="#限制参数化类型" class="headerlink" title="限制参数化类型"></a>限制参数化类型</h3><p>实现通用类型时，可能需要限制其参数的类型。你可以使用 extends 来做到这一点</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// T 必须是某个类或者类的后代</span><span class="token keyword">class</span> <span class="token class-name">Foo</span><span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">SomeBaseClass</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Extender</span> <span class="token keyword">extends</span> <span class="token class-name">SomeBaseClass</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 在&lt;>中使用某个类或者其子类都可以</span>  <span class="token keyword">var</span> someBaseClassFoo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token operator">&lt;</span>SomeBaseClass<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> extenderFoo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token operator">&lt;</span>Extender<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 不使用&lt;>也可以</span>  <span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 指定任何非 SomeBaseClass 类型会导致警告（检查模式中是运行时错误 runtime error）</span>  <span class="token comment" spellcheck="true">// var objectFoo = new Foo&lt;Object>();</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用泛型函数"><a href="#使用泛型函数" class="headerlink" title="使用泛型函数"></a>使用泛型函数</h3><p>最初，Dart 的泛型支持仅限于类。一种较新的语法（称为泛型方法，SDK1.21 之后）允许在方法和函数上使用类型参数：</p><pre class="line-numbers language-dart"><code class="language-dart">T first<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span> ts<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ... 一些初始化工作或者错误检查...</span>  T tmp <span class="token operator">=</span> ts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ... 做一些额外的检查或处理...</span>  <span class="token keyword">return</span> tmp<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>泛型参数（<t>）允许你在多个位置使用类型参数 T：</t></p><ul><li>函数的返回类型 (T)</li><li>参数类型 (List<t>)</t></li><li>局部变量类型 (T tmp)<br>更多关于泛型函数，详见 <a href="https://github.com/dart-lang/sdk/blob/master/pkg/dev_compiler/doc/GENERIC_METHODS.md" target="_blank" rel="noopener">泛型方法</a></li></ul><hr><h2 id="库和可见性-Libraries-and-visibility"><a href="#库和可见性-Libraries-and-visibility" class="headerlink" title="库和可见性 Libraries and visibility"></a>库和可见性 Libraries and visibility</h2><p>import，library 指令可以帮助创建一个模块化的，可共享的代码库。库不仅提供了 API，还提供隐私单元：以下划线 ( _ ) 开头的标识符只对内部库可见。每个 Dartapp 就是一个库，即使它不使用库指令。</p><p>库可以分布式使用包。见 <a href="https://www.dartlang.org/tools/pub" target="_blank" rel="noopener">Pub Package and Asset Manager</a> 中有关 pub(SDK 中的一个包管理器）。</p><h3 id="使用库"><a href="#使用库" class="headerlink" title="使用库"></a>使用库</h3><p>使用 import 来指定如何从一个库命名空间用于其他库的范围。</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string">'dart:html'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Dart Web 应用一般采用这个库 dart:html</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>唯一需要 import 的参数是一个指向库的 URI。对于内置库，URI 中具有特殊 dart: scheme。对于其他库，你可以使用文件系统路径或 package: scheme。包 package：scheme 指定由程序包管理器（如 pub 工具）提供的库。例如:</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string">'dart:io'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'package:mylib/mylib.dart'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'package:utils/utils.dart'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>注：URI 代表统一资源标识符。网址（统一资源定位器）是一种常见的 URI 的。</p></blockquote><h3 id="指定库前缀"><a href="#指定库前缀" class="headerlink" title="指定库前缀"></a>指定库前缀</h3><p>如果导入两个库是有冲突的标识符，那么你可以指定一个或两个库的前缀。例如，如果 library1 和 library2 都有一个元素类，那么你可能有这样的代码：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string">'package:lib1/lib1.dart'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'package:lib2/lib2.dart'</span> <span class="token operator">as</span> lib2<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">var</span> element1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 使用 lib1 里的元素</span><span class="token keyword">var</span> element2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">lib2<span class="token punctuation">.</span>Element</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// 使用 lib2 里的元素</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="导入部分库"><a href="#导入部分库" class="headerlink" title="导入部分库"></a>导入部分库</h3><p>如果想使用的库一部分，你可以选择性导入库。例如：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// 只导入 foo 库</span><span class="token keyword">import</span> <span class="token string">'package:lib1/lib1.dart'</span> show foo<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 导入所有除了 foo</span><span class="token keyword">import</span> <span class="token string">'package:lib2/lib2.dart'</span> hide foo<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="延迟加载库"><a href="#延迟加载库" class="headerlink" title="延迟加载库"></a>延迟加载库</h3><p>延迟 (deferred) 加载（也称为懒 (lazy) 加载）允许应用程序按需加载库。下面是当你可能会使用延迟加载某些情况：</p><ul><li>为了减少应用程序的初始启动时间</li><li>例如，要执行 A / B 测试 ( A/B testing) - 尝试算法的替代实现</li><li>加载很少使用的功能，例如可选的屏幕和对话框</li></ul><p>为了延迟加载一个库，你必须使用 deferred as 先导入它:</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string">'package:deferred/hello.dart'</span> <span class="token keyword">deferred</span> <span class="token operator">as</span> hello<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>当需要库时，使用该库的调用标识符调用 LoadLibrary（）:</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>  <span class="token keyword">await</span> hello<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  hello<span class="token punctuation">.</span><span class="token function">printGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在上述代码中，await 关键字将暂停执行，直到库被加载。更多关于 async 和 await 详见 <a href="https://www.dartlang.org/guides/language/language-tour#asynchrony-support" target="_blank" rel="noopener">异步支持</a></p><p>您可以在库中多次调用 loadLibrary( )。该库仅加载一次。<br>当您使用延迟加载，要注意一下几点：</p><ul><li>延迟库的常量在其作为导入文件时不是常量。记住，这些常量不存在，直到迟库被加载完成。</li><li>你不能在导入文件中使用延迟库常量的类型。相反，考虑将接口类型移到同时由延迟库和导入文件导入的库。</li><li>Dart 隐式地将 loadLibrary（）插入到使用 deferred 作为命名空间定义的命名空间中。调用 LoadLibrary（）函数返回一个 Future 对象（类似于 JS 的 promise 对象）。</li></ul><h3 id="库的实现"><a href="#库的实现" class="headerlink" title="库的实现"></a>库的实现</h3><p>详见 <a href="https://www.dartlang.org/guides/libraries/create-library-packages" target="_blank" rel="noopener">创建库文件包</a></p><hr><h2 id="异步的支持-Asynchrony-support"><a href="#异步的支持-Asynchrony-support" class="headerlink" title="异步的支持 Asynchrony support"></a>异步的支持 Asynchrony support</h2><p>Dart 添加了一些新的语言特性用于支持异步编程。最通常使用的特性是 async 方法和 await 表达式。Dart 库大多方法返回 Future 和 Stream 对象。这些方法是异步的：它们在设置一个可能的耗时操作（比如 I/O 操作）之后返回，而无需等待操作完成。</p><p>当你需要使用 Future 来表示一个值时，你有两个选择：</p><ul><li>使用 async 和 await</li><li>使用 <a href="https://www.dartlang.org/guides/libraries/library-tour#future" target="_blank" rel="noopener">Future API</a></li></ul><p>同样的，当你需要从 Stream 获取值的时候，你有两个选择:</p><ul><li>使用 async 和一个异步的 for 循环 (await for)</li><li>使用 <a href="https://www.dartlang.org/guides/libraries/library-tour#stream" target="_blank" rel="noopener">Stream API</a></li></ul><p>要使用 await，代码必须用 async 标记函数:</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token function">checkVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> version <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">lookUpVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">==</span> expectedVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Do something.</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Do something else.</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你可以使用 try, catch, 和 finally 来处理错误并清理使用了 await 的代码:</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">try</span> <span class="token punctuation">{</span>  server <span class="token operator">=</span> <span class="token keyword">await</span> HttpServer<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>InternetAddress<span class="token punctuation">.</span>LOOPBACK_IP_V4<span class="token punctuation">,</span> <span class="token number">4044</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 响应无法绑定到端口...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="声明异步函数"><a href="#声明异步函数" class="headerlink" title="声明异步函数"></a>声明异步函数</h3><p>一个异步函数是一个由 async 修饰符标记的函数。虽然一个异步函数可能在操作上比较耗时，但是它可以在任何方法体执行之前立即返回。</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token function">checkVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token function">lookUpVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token comment" spellcheck="true">/* ... */</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在函数中添加关键字 async 使得它返回一个 Future 对象。<br>比如，考虑一下这个同步函数，它将返回一个字符串：<br>String lookUpVersionSync() =&gt; ‘1.0.0’;<br>更改它成为异步方法 - 因为在之后的实现中将会非常耗时 - 它的返回值是一个 Future 对象：<br>Future<string>lookUpVersion() async =&gt; ‘1.0.0’;<br>请注意函数体不需要使用 Future API，如果必要的话 Dart 将会自己创建 Future 对象。</string></p><h3 id="使用带-future-的-await-表达式"><a href="#使用带-future-的-await-表达式" class="headerlink" title="使用带 future 的 await 表达式"></a>使用带 future 的 await 表达式</h3><p>在异步方法中你可以使用 await 多次。比如，下列代码为了得到函数的结果一共等待了三次：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> entrypoint <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">findEntrypoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> exitCode <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">runExecutable</span><span class="token punctuation">(</span>entrypoint<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">await</span> <span class="token function">flushThenExit</span><span class="token punctuation">(</span>exitCode<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在 await 表达式中， 表达式 的值通常是一个 Future 对象；如果不是，那么这个值会自动转为 Future。这个 Future 对象表明了表达式应该返回一个对象。await 表达式 的值就是返回的一个对象。在对象可用之前，await 表达式将会一直处于暂停状态。</p><p>如果 await 没有起作用，请确认它是一个异步方法。比如，在你的 main() 函数里面使用 await，main() 的函数体必须被 async 标记:</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>  <span class="token function">checkVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'In main: version is ${await lookUpVersion()}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="结合-streams-使用异步循环"><a href="#结合-streams-使用异步循环" class="headerlink" title="结合 streams 使用异步循环"></a>结合 streams 使用异步循环</h3><p>一个异步循环具有以下形式：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">await</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>variable declaration <span class="token keyword">in</span> expression<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 每次 stream 发出一个值时执行</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>表达式 的值 the value of expression 必须有 Stream 类型（流类型）。执行过程如下：</p><ul><li>在 stream 发出一个值之前等待</li><li>执行 for 循环的主体，把变量设置为发出的值</li><li>重复 1 和 2，直到 Stream 关闭</li></ul><p>如果要停止监听 stream ，你可以使用 break 或者 return 语句，跳出循环并取消来自 stream 的订阅 。<br>如果一个异步 for 循环没有正常运行，请确认它是一个异步方法。 比如，在应用的 main() 方法中使用异步的 for 循环时，main() 的方法体必须被 async 标记：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token keyword">await</span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> request <span class="token keyword">in</span> requestServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">handleRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>更多关于异步编程的信息，请看 <a href="https://www.dartlang.org/guides/libraries/library-tour#dartasync---asynchronous-programming" target="_blank" rel="noopener">dart:async</a> 库的介绍。<br>也可以看文章 <a href="https://www.dartlang.org/articles/language/await-async" target="_blank" rel="noopener">Dart Language Asynchrony Support: Phase 1</a> 和 <a href="https://www.dartlang.org/articles/language/beyond-async" target="_blank" rel="noopener">Dart Language Asynchrony Support: Phase 2</a> 和 <a href="https://www.dartlang.org/guides/language/spec" target="_blank" rel="noopener">the Dart language specification</a>。</p><hr><h2 id="可调用类-Callable-classes"><a href="#可调用类-Callable-classes" class="headerlink" title="可调用类 Callable classes"></a>可调用类 Callable classes</h2><p>为了允许你的 Dart 类可以像函数一样被调用，实现了 call（）方法。<br>在下面的例子中，WannabeFunction 类定义了一个 call（）函数，它需要三个字符串并用空格串联它们，并加上感叹号：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">WannabeFunction</span> <span class="token punctuation">{</span>  <span class="token function">call</span><span class="token punctuation">(</span>String a<span class="token punctuation">,</span> String b<span class="token punctuation">,</span> String c<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'$a $b $c!'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> wf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WannabeFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> out <span class="token operator">=</span> <span class="token function">wf</span><span class="token punctuation">(</span><span class="token string">"Hi"</span><span class="token punctuation">,</span><span class="token string">"there,"</span><span class="token punctuation">,</span><span class="token string">"gang"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'$out'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Hi there, gang!</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>更多关于类函数，详见 <a href="https://www.dartlang.org/articles/language/emulating-functions" target="_blank" rel="noopener">将类用作函数</a>。</p>]]></content>
      
      <categories>
          
          <category> Dart </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dart </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>masm for mac</title>
      <link href="/2017/11-masm.html"/>
      <url>/2017/11-masm.html</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Mac 推荐使用的汇编语法是 nasm，但学校实验用的是 masm，Windows 上有专门的 masm 编辑器，Mac 上想要编写 masm 会麻烦一点，需要用到 DOSBox 和一些编译链接文件，下面就是折腾的过程</p><h2 id="使用教程"><a href="#使用教程" class="headerlink" title="使用教程"></a>使用教程</h2><h3 id="到用户目录克隆文件"><a href="#到用户目录克隆文件" class="headerlink" title="到用户目录克隆文件"></a>到用户目录克隆文件</h3><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">cd</span> ~/$ <span class="token function">git</span> clone https://github.com/wangriyu/masm-for-mac.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>~/masm-for-mac</code> 目录下应有以下文件，masm5 是主要的编译链接文件，DOSBox.app 提供沙盒环境，src 中有一些事例代码</p><p><img src="https://src.wangriyu.wang/images/blog/masm/files.png" alt="image"></p><h3 id="打开-DOSBox，输入-mount-指令挂载虚拟磁盘，盘符为-c，目录是克隆下来的-masm5-文件夹路径，挂载成功后输入-c-进入虚拟磁盘，再输入-dir-列出目录文件，输入-HELP-查看帮助，与-Dos-环境的命令一致"><a href="#打开-DOSBox，输入-mount-指令挂载虚拟磁盘，盘符为-c，目录是克隆下来的-masm5-文件夹路径，挂载成功后输入-c-进入虚拟磁盘，再输入-dir-列出目录文件，输入-HELP-查看帮助，与-Dos-环境的命令一致" class="headerlink" title="打开 DOSBox，输入 mount 指令挂载虚拟磁盘，盘符为 c，目录是克隆下来的 masm5 文件夹路径，挂载成功后输入 c: 进入虚拟磁盘，再输入 dir 列出目录文件，输入 HELP 查看帮助，与 Dos 环境的命令一致"></a>打开 DOSBox，输入 mount 指令挂载虚拟磁盘，盘符为 c，目录是克隆下来的 masm5 文件夹路径，挂载成功后输入 c: 进入虚拟磁盘，再输入 dir 列出目录文件，输入 HELP 查看帮助，与 Dos 环境的命令一致</h3><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">mount</span> c ~/masm-for-mac/masm5$ c:$ <span class="token function">dir</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://src.wangriyu.wang/images/blog/masm/mount.png" alt="image"></p><h3 id="用自己常用的文本编辑器，比如-VSCode-打开文件目录，在-masm5-下新建-asm-文件-src-中有一些事例-，用-masm-语法编写汇编代码，然后通过-masm-汇编、link-链接后就可以运行输出"><a href="#用自己常用的文本编辑器，比如-VSCode-打开文件目录，在-masm5-下新建-asm-文件-src-中有一些事例-，用-masm-语法编写汇编代码，然后通过-masm-汇编、link-链接后就可以运行输出" class="headerlink" title="用自己常用的文本编辑器，比如 VSCode 打开文件目录，在 masm5 下新建 asm 文件 (src 中有一些事例)，用 masm 语法编写汇编代码，然后通过 masm 汇编、link 链接后就可以运行输出"></a>用自己常用的文本编辑器，比如 VSCode 打开文件目录，在 masm5 下新建 asm 文件 (src 中有一些事例)，用 masm 语法编写汇编代码，然后通过 masm 汇编、link 链接后就可以运行输出</h3><pre class="line-numbers language-bash"><code class="language-bash">$ masm hello.asm// 连按三次回车$ <span class="token function">link</span> hello.obj// 连按三次回车$ hello.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://src.wangriyu.wang/images/blog/masm/hello.png" alt="image"></p><h2 id="事例"><a href="#事例" class="headerlink" title="事例"></a>事例</h2><h3 id="平均数计算，连续输入十个-10-以下的数，程序计算去掉一个最小数，去掉一个最大数后八个数的平均值，从显示器显示出来，结果保留-3-位小数"><a href="#平均数计算，连续输入十个-10-以下的数，程序计算去掉一个最小数，去掉一个最大数后八个数的平均值，从显示器显示出来，结果保留-3-位小数" class="headerlink" title="平均数计算，连续输入十个 10 以下的数，程序计算去掉一个最小数，去掉一个最大数后八个数的平均值，从显示器显示出来，结果保留 3 位小数"></a>平均数计算，连续输入十个 10 以下的数，程序计算去掉一个最小数，去掉一个最大数后八个数的平均值，从显示器显示出来，结果保留 3 位小数</h3><p><img src="https://src.wangriyu.wang/images/blog/masm/average.png" alt="average"></p><h3 id="按-15-行-X16-列的表格显示表示-ASCII-码为-10H—100H-的所有字符，即以行为主的顺序及-ASCII-码递增的次序一次显示对应的字符，每-16-个字符为一行，每行中的相邻的字符之间用空白（ASCII-为-0）隔开"><a href="#按-15-行-X16-列的表格显示表示-ASCII-码为-10H—100H-的所有字符，即以行为主的顺序及-ASCII-码递增的次序一次显示对应的字符，每-16-个字符为一行，每行中的相邻的字符之间用空白（ASCII-为-0）隔开" class="headerlink" title="按 15 行 X16 列的表格显示表示 ASCII 码为 10H—100H 的所有字符，即以行为主的顺序及 ASCII 码递增的次序一次显示对应的字符，每 16 个字符为一行，每行中的相邻的字符之间用空白（ASCII 为 0）隔开"></a>按 15 行 X16 列的表格显示表示 ASCII 码为 10H—100H 的所有字符，即以行为主的顺序及 ASCII 码递增的次序一次显示对应的字符，每 16 个字符为一行，每行中的相邻的字符之间用空白（ASCII 为 0）隔开</h3><p><img src="https://src.wangriyu.wang/images/blog/masm/test1.png" alt="test1"></p><h3 id="程序接受用户键入的一个关键字以及一个句子，如果句子中不包含关键字则显示-“No-match-”；如果句子中包含关键字则显示-“match-”，且把该字在句子中的位置用十六进制数显示出来"><a href="#程序接受用户键入的一个关键字以及一个句子，如果句子中不包含关键字则显示-“No-match-”；如果句子中包含关键字则显示-“match-”，且把该字在句子中的位置用十六进制数显示出来" class="headerlink" title="程序接受用户键入的一个关键字以及一个句子，如果句子中不包含关键字则显示 “No match!”；如果句子中包含关键字则显示 “match!”，且把该字在句子中的位置用十六进制数显示出来"></a>程序接受用户键入的一个关键字以及一个句子，如果句子中不包含关键字则显示 “No match!”；如果句子中包含关键字则显示 “match!”，且把该字在句子中的位置用十六进制数显示出来</h3><p><img src="https://src.wangriyu.wang/images/blog/masm/test2.png" alt="test2"></p><h3 id="程序接受用户键入一行字符（字符个数不超过-80-个，该字符串用回车符结束），并按字母、数字、其它字符分类计数，然后将结果存入以-letter、digit-和-other-为名的存储单元中"><a href="#程序接受用户键入一行字符（字符个数不超过-80-个，该字符串用回车符结束），并按字母、数字、其它字符分类计数，然后将结果存入以-letter、digit-和-other-为名的存储单元中" class="headerlink" title="程序接受用户键入一行字符（字符个数不超过 80 个，该字符串用回车符结束），并按字母、数字、其它字符分类计数，然后将结果存入以 letter、digit 和 other 为名的存储单元中"></a>程序接受用户键入一行字符（字符个数不超过 80 个，该字符串用回车符结束），并按字母、数字、其它字符分类计数，然后将结果存入以 letter、digit 和 other 为名的存储单元中</h3><p><img src="https://src.wangriyu.wang/images/blog/masm/test3.png" alt="test3"></p><h3 id="添加查找电话号码本，程序可接受输入人名及相应的电话号码，并把它们加入电话号码表中，程序可按人名对电话号码表重新排序，程序可接受需要查询电话号码的人名，并从电话号码表中查出其电话号码"><a href="#添加查找电话号码本，程序可接受输入人名及相应的电话号码，并把它们加入电话号码表中，程序可按人名对电话号码表重新排序，程序可接受需要查询电话号码的人名，并从电话号码表中查出其电话号码" class="headerlink" title="添加查找电话号码本，程序可接受输入人名及相应的电话号码，并把它们加入电话号码表中，程序可按人名对电话号码表重新排序，程序可接受需要查询电话号码的人名，并从电话号码表中查出其电话号码"></a>添加查找电话号码本，程序可接受输入人名及相应的电话号码，并把它们加入电话号码表中，程序可按人名对电话号码表重新排序，程序可接受需要查询电话号码的人名，并从电话号码表中查出其电话号码</h3><p><img src="https://src.wangriyu.wang/images/blog/masm/test4.png" alt="test4"></p><h2 id="DOSBox-进阶玩法"><a href="#DOSBox-进阶玩法" class="headerlink" title="DOSBox 进阶玩法"></a>DOSBox 进阶玩法</h2><h3 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h3><p>在 DOSBox 输入 <code>intro special</code> 可以查看热键，比如 alt(option) + enter(return) 切换全屏，但有些键在 mac 上好像没用</p><h3 id="运行-Dos-游戏和旧应用"><a href="#运行-Dos-游戏和旧应用" class="headerlink" title="运行 Dos 游戏和旧应用"></a>运行 Dos 游戏和旧应用</h3><p>在 DOSBox 中可以运行 exe 文件，一些很老的 Dos 游戏和旧应用也可以运行，网上有很多经典游戏的资源，可以用 DOSBox 尝试下</p>]]></content>
      
      <categories>
          
          <category> Mac </category>
          
      </categories>
      
      
        <tags>
            
            <tag> masm </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Dart 语法入门 III</title>
      <link href="/2017/11-Dart%20III.html"/>
      <url>/2017/11-Dart%20III.html</url>
      <content type="html"><![CDATA[<h2 id="类-Class"><a href="#类-Class" class="headerlink" title="类 Class"></a>类 Class</h2><p>Dart 是一种面向对象语言，包含类和基于 mixin 的继承两部分。每个对象是一个类的实例，并且 Object 是所有类的父类。基于 mixin 的继承指的是每个类（除了 Object ）都只有一个父类，类体还可以在多个类继承中被重用。</p><p>要创建一个对象，你可以使用 new 关键词并在其后跟上一个构造函数。构造函数可以写成&lt;类名&gt;或者&lt;类名. 标识符&gt;形式。例如:</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> jsonData <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token string">'{"x":1, "y":2}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 用 Point() 创建一个点。</span><span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 用 Point().fromJson() 创建一个点。</span><span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point<span class="token punctuation">.</span>fromJson</span><span class="token punctuation">(</span>jsonData<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对象的成员分为函数和数据两类（各自的方法和实例变量）。当你调用一个方法时，通过一个对象来调用它的：该方法可访问该对象的方法和数据。用 . 指向对象的方法和数据成员:</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 给 y 赋值。</span>p<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 获取 y 的值。</span><span class="token keyword">assert</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 用 p 对象调用 distanceTo() 。</span>num distance <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">distanceTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 使用?. 代替. 来避免操作对象为 null 时产生的异常</span>p<span class="token operator">?</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 如果 p 不为空则设置 p.y 等于 4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当你想对一个对象的成员进行一系列操作时，用级联操作（ cascade ）：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#button'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 获取一个对象。</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">'Confirm'</span>   <span class="token comment" spellcheck="true">// 调用他的成员。</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span>classes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'important'</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span>onClick<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> window<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Confirmed!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>一些类提供常量构造函数，要创建一个编译时常量构造函数，使用 const 关键字代替 new ：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token function">ImmutablePoint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token function">ImmutablePoint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">identical</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 他们是相同的实例！</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>如果想在运行时获取对象的类型，可以使用 runtimeType 属性：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'The type of a is ${a.runtimeType}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="实例变量"><a href="#实例变量" class="headerlink" title="实例变量"></a>实例变量</h3><p>声明实例变量：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>  num x<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 声明实例变量 x ，默认值为 null 。</span>  num y<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 声明实例变量 y ，默认值为 null 。</span>  num z <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 声明实例变量 z ，初始化为 0 。</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所有的实例变量会自动生成一个隐式的 getter 方法。 Non-final 实例变量也会自动生成一个隐式的 setter 方法。有关详细信息，参见 <a href="https://www.dartlang.org/guides/language/language-tour#getters-and-setters" target="_blank" rel="noopener">getter&amp;setter</a>。</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>  num x<span class="token punctuation">;</span>  num y<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> point <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  point<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 用 setter 方法得到 x 。</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 用 getter 方法得到 x 。</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>y <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 值为 null 。</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><p>要声明一个构造函数，只需创建一个与类同名的方法（或者加上一个额外的标识符命名构造函数的描述）。构造函数最常见的形式，就是自动生成的构造函数，下面创建一个类的新实例：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>  num x<span class="token punctuation">;</span>  num y<span class="token punctuation">;</span>  <span class="token function">Point</span><span class="token punctuation">(</span>num x<span class="token punctuation">,</span> num y<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 有个更好的方法来实现。用语法糖来设置 x，y: Point(this.x, this.y)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>默认构造函数: 如果你不声明一个构造函数，系统会提供默认构造函数。默认构造函数没有参数，它将调用父类的无参数构造函数。</p></li><li><p>子类不继承父类的构造函数。子类只有默认构造函数。（无参数，没有名字的构造函数）</p></li><li><p>命名构造函数。使用命名构造函数可以为一个类声明多个构造函数，或者说是提供额外的声明</p></li></ul><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>  num x<span class="token punctuation">;</span>  num y<span class="token punctuation">;</span>  <span class="token function">Point</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 命名构造函数</span>  Point<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>Map json<span class="token punctuation">)</span> <span class="token punctuation">{</span>    x <span class="token operator">=</span> json<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    y <span class="token operator">=</span> json<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>调用非默认的父类的构造函数。默认情况下，在子类的构造函数将会调用父类的无参数默认构造函数。如果父类没有构造函数，则必须手动调用父类的构造函数中的一个。在冒号（：）之后、构造函数之前指定父类的构造函数（如果有的话）。</li></ul><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  String firstName<span class="token punctuation">;</span>  Person<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>Map data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'in Person'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Employee</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Person 没有默认构造函数，子类必需调用 super.&lt;命名构造函数></span>  Employee<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>Map data<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'in Employee'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> emp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Employee<span class="token punctuation">.</span>fromJson</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 输出:</span>  <span class="token comment" spellcheck="true">// in Person</span>  <span class="token comment" spellcheck="true">// in Employee</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>emp <span class="token operator">is</span> Person<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 类型检查</span>    emp<span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">'Bob'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token punctuation">(</span>emp <span class="token operator">as</span> Person<span class="token punctuation">)</span><span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">'Bob'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在调用父类构造函数前会检测参数，这个参数可以是一个表达式作为函数调用：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Employee</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token function">Employee</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span><span class="token function">findDefaultData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>⚠️警告：父类构造函数的参数不能访问 this 。例如，参数可调用静态方法但是不能调用实例方法。</p><hr><h3 id="初始化列表"><a href="#初始化列表" class="headerlink" title="初始化列表"></a>初始化列表</h3><p>除了调用父类构造函数，你也可以在构造函数体运行之前初始化实例变量。用逗号隔开使其分别初始化。</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>  num x<span class="token punctuation">;</span>  num y<span class="token punctuation">;</span>  <span class="token function">Point</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 初始化列表在构造函数运行前设置实例变量。</span>  Point<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>Map jsonMap<span class="token punctuation">)</span>      <span class="token punctuation">:</span> x <span class="token operator">=</span> jsonMap<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        y <span class="token operator">=</span> jsonMap<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'In Point.fromJson(): ($x, $y)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>⚠️警告：右手边的初始化程序无法访问 this 关键字</p><p>以下示例在初始化程序列表中初始化三个 final 字段</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string">'dart:math'</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>  <span class="token keyword">final</span> num x<span class="token punctuation">;</span>  <span class="token keyword">final</span> num y<span class="token punctuation">;</span>  <span class="token keyword">final</span> num distanceFromOrigin<span class="token punctuation">;</span>  <span class="token function">Point</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>      <span class="token punctuation">:</span> x <span class="token operator">=</span> x<span class="token punctuation">,</span>        y <span class="token operator">=</span> y<span class="token punctuation">,</span>        distanceFromOrigin <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token operator">+</span> y <span class="token operator">*</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>distanceFromOrigin<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 输出 3.605551275463989</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="重定向构造函数"><a href="#重定向构造函数" class="headerlink" title="重定向构造函数"></a>重定向构造函数</h3><p>有时一个构造函数的目的只是重定向到同一个类中的另一个构造函数。如果一个重定向的构造函数的主体为空，那么调用这个构造函数的时候，直接在冒号后面调用这个构造函数即可。</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>  num x<span class="token punctuation">;</span>  num y<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 主构造函数</span>  <span class="token function">Point</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 主函数的委派</span>  Point<span class="token punctuation">.</span><span class="token function">alongXAxis</span><span class="token punctuation">(</span>num x<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="静态构造函数"><a href="#静态构造函数" class="headerlink" title="静态构造函数"></a>静态构造函数</h3><p>如果你的类产生的对象永远不会改变，你可以让这些对象成为编译时常量。为此，需要定义一个 const 构造函数并确保所有的实例变量都是 final 的。</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">ImmutablePoint</span> <span class="token punctuation">{</span>  <span class="token keyword">final</span> num x<span class="token punctuation">;</span>  <span class="token keyword">final</span> num y<span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token function">ImmutablePoint</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">static</span> <span class="token keyword">final</span> ImmutablePoint origin <span class="token operator">=</span>      <span class="token keyword">const</span> <span class="token function">ImmutablePoint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="工厂构造函数"><a href="#工厂构造函数" class="headerlink" title="工厂构造函数"></a>工厂构造函数</h3><p>当实现一个使用 factory 关键词修饰的构造函数时，这个构造函数不必创建类的新实例。例如，工厂构造函数可能从缓存返回实例，或者它可能返回子类型的实例。 下面的示例演示一个工厂构造函数从缓存返回的对象：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Logger</span> <span class="token punctuation">{</span>  <span class="token keyword">final</span> String name<span class="token punctuation">;</span>  bool mute <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token keyword">static</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Logger<span class="token operator">></span> _cache <span class="token operator">=</span> <span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Logger<span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//  _cache 是一个私有库，因为名字前有个 _</span>  <span class="token keyword">factory</span> <span class="token function">Logger</span> <span class="token punctuation">(</span>String name<span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>_cache<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> _cache<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">final</span> logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Logger<span class="token punctuation">.</span>_internal</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>      _cache<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> logger<span class="token punctuation">;</span>      <span class="token keyword">return</span> logger<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  Logger<span class="token punctuation">.</span><span class="token function">_internal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token function">log</span> <span class="token punctuation">(</span>String msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mute<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>⚠️注：工厂构造函数不能用 this。</p><p>调用一个工厂构造函数，你需要使用 new 关键字：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Logger</span><span class="token punctuation">(</span><span class="token string">'UI'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Button clicked'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><p>方法就是为对象提供行为的函数。</p><ul><li>实例方法<br>对象的实例方法可以访问实例变量和 this 。以下示例中的 distanceTo() 方法是实例方法的一个例子：</li></ul><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string">'dart:math'</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>  num x<span class="token punctuation">;</span>  num y<span class="token punctuation">;</span>  <span class="token function">Point</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>  num <span class="token function">distanceTo</span> <span class="token punctuation">(</span>Point other<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> dx <span class="token operator">=</span> x <span class="token operator">-</span> other<span class="token punctuation">.</span>x<span class="token punctuation">;</span>    <span class="token keyword">var</span> dy <span class="token operator">=</span> y <span class="token operator">-</span> other<span class="token punctuation">.</span>y<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>dx <span class="token operator">*</span> dx <span class="token operator">+</span> dy <span class="token operator">*</span> dy<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>setters 和 Getters: 是一种提供对方法属性读和写的特殊方法。每个实例变量都有一个隐式的 getter 方法，如果合适的话可以加上 setter 方法。你可以通过实现 getters 和 setters 来创建附加属性，也就是直接使用 get 和 set 关键词：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>  num left<span class="token punctuation">;</span>  num top<span class="token punctuation">;</span>  num width<span class="token punctuation">;</span>  num height<span class="token punctuation">;</span>  <span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>left<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>top<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 定义两个计算属性: right and bottom</span>  num <span class="token keyword">get</span> right             <span class="token operator">=</span><span class="token operator">></span> left <span class="token operator">+</span> width<span class="token punctuation">;</span>      <span class="token keyword">set</span> <span class="token function">right</span><span class="token punctuation">(</span>num value<span class="token punctuation">)</span>  <span class="token operator">=</span><span class="token operator">></span> left <span class="token operator">=</span> value <span class="token operator">-</span> width<span class="token punctuation">;</span>  num <span class="token keyword">get</span> bottom            <span class="token operator">=</span><span class="token operator">></span> top <span class="token operator">+</span> height<span class="token punctuation">;</span>      <span class="token keyword">set</span> <span class="token function">bottom</span><span class="token punctuation">(</span>num value<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> top <span class="token operator">=</span> value <span class="token operator">-</span> height<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> rect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span>left <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  rect<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span>left <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>借助于 getter 和 setter，你可以直接使用实例变量，并且在不改变客户代码的情况下把他们包装成方法。</p><p>⚠️注：不论是否显式地定义了一个 getter，类似增量（++）的操作符，都能以预期的方式工作。为了避免产生任何向着不期望的方向的影响，操作符一旦调用 getter ，就会把他的值存在临时变量里。</p><ul><li>抽象方法<br>Instance，getter 和 setter 方法可以是抽象的，也就是定义一个接口，但是把实现交给其他的类。要创建一个抽象方法，使用分号 (;) 代替方法体：</li></ul><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Doer</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ... 定义实例变量和方法...</span>  <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 定义一个抽象方法，没有 body</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">EffectiveDoer</span> <span class="token keyword">extends</span> <span class="token class-name">Doer</span> <span class="token punctuation">{</span>  <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ... 提供一个实现，所以这里的方法不是抽象的...</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调用抽象方法会导致运行时错误。</p><hr><h3 id="重载操作符"><a href="#重载操作符" class="headerlink" title="重载操作符"></a>重载操作符</h3><p>你可以重写在下表中列出的操作符。例如，如果你定义了一个向量类，你可以定义一个 + 方法来加两个向量。</p><table><thead><tr><th style="text-align:center">&lt;</th><th style="text-align:center">+</th><th style="text-align:center">I</th><th style="text-align:center">[ ]</th></tr></thead><tbody><tr><td style="text-align:center">&gt;</td><td style="text-align:center">/</td><td style="text-align:center">^</td><td style="text-align:center">[ ]=</td></tr><tr><td style="text-align:center">&lt;=</td><td style="text-align:center">~/</td><td style="text-align:center">&amp;</td><td style="text-align:center">~</td></tr><tr><td style="text-align:center">&gt;=</td><td style="text-align:center">*</td><td style="text-align:center">&lt;&lt;</td><td style="text-align:center">==</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">%</td><td style="text-align:center">&gt;&gt;</td></tr></tbody></table><p>以下是一个类中重写 + 和 - 操作符的例子：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Vector</span> <span class="token punctuation">{</span>  <span class="token keyword">final</span> int x<span class="token punctuation">;</span>  <span class="token keyword">final</span> int y<span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token function">Vector</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 重写 + (a + b).</span>  Vector <span class="token keyword">operator</span> <span class="token operator">+</span><span class="token punctuation">(</span>Vector v<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span>x <span class="token operator">+</span> v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y <span class="token operator">+</span> v<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 重写 - (a - b).</span>  Vector <span class="token keyword">operator</span> <span class="token operator">-</span><span class="token punctuation">(</span>Vector v<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span>x <span class="token operator">-</span> v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y <span class="token operator">-</span> v<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">final</span> v <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">final</span> w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// v == (2, 3)</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>x <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span>y <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// v + w == (4, 5)</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v <span class="token operator">+</span> w<span class="token punctuation">)</span><span class="token punctuation">.</span>x <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>v <span class="token operator">+</span> w<span class="token punctuation">)</span><span class="token punctuation">.</span>y <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// v - w == (0, 1)</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v <span class="token operator">-</span> w<span class="token punctuation">)</span><span class="token punctuation">.</span>x <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>v <span class="token operator">-</span> w<span class="token punctuation">)</span><span class="token punctuation">.</span>y <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Dart 中的每个对象自动提供一个整数哈希码，因此可以用作 map 的一个键。但是，你可以重写 hashCode getter 来生成自定义哈希码。如果你这样做，你可能也想重写 == 运算符。相等的（通过 ==）的对象必须具有相同的哈希码。哈希码不一定是唯一的，但是它具有良好的分布性。<br>重写 == 和 hashCode 例子:</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token keyword">final</span> String firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">;</span>  <span class="token function">Person</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>firstName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastName<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 使用 Effective Java 中的策略重写 hashCode</span>  int <span class="token keyword">get</span> hashCode <span class="token punctuation">{</span>    int result <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> <span class="token number">37</span> <span class="token operator">*</span> result <span class="token operator">+</span> firstName<span class="token punctuation">.</span>hashCode<span class="token punctuation">;</span>    result <span class="token operator">=</span> <span class="token number">37</span> <span class="token operator">*</span> result <span class="token operator">+</span> lastName<span class="token punctuation">.</span>hashCode<span class="token punctuation">;</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 如果重写了 hashCode，一般也要实现‘==''</span>  bool <span class="token keyword">operator</span> <span class="token operator">==</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>other <span class="token operator">is!</span> Person<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    Person person <span class="token operator">=</span> other<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>person<span class="token punctuation">.</span>firstName <span class="token operator">==</span> firstName <span class="token operator">&amp;&amp;</span> person<span class="token punctuation">.</span>lastName <span class="token operator">==</span> lastName<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'bob'</span><span class="token punctuation">,</span> <span class="token string">'smith'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'bob'</span><span class="token punctuation">,</span> <span class="token string">'smith'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> p3 <span class="token operator">=</span> <span class="token string">'not a person'</span><span class="token punctuation">;</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span>hashCode <span class="token operator">==</span> p2<span class="token punctuation">.</span>hashCode<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>p1 <span class="token operator">==</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>p1 <span class="token operator">!=</span> p3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>更多关于重载的信息，详见 <a href="https://www.dartlang.org/guides/language/language-tour#extending-a-class" target="_blank" rel="noopener">扩展一个类</a></p><hr><h3 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h3><p>使用 abstract 修饰符来定义一个抽象类，该类不能被实例化。抽象类在定义接口的时候非常有用，实际上抽象中也包含一些实现。如果你想让你的抽象类被实例化，请定义一个 工厂构造函数。</p><p>抽象类通常包含 抽象方法。下面是声明一个含有抽象方法的抽象类的例子：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// 这个类是抽象类，因此不能被实例化。</span><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractContainer</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ... 定义构造函数，域，方法...</span>  <span class="token keyword">void</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 抽象方法。</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面的类不是抽象类，因此它可以被实例化，即使定义了一个抽象方法：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">SpecializedContainer</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractContainer</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ... 定义更多构造函数，域，方法...</span>  <span class="token keyword">void</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ... 实现 updateChildren()...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 抽象方法造成一个警告，但是不会阻止实例化。</span>  <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="隐式接口"><a href="#隐式接口" class="headerlink" title="隐式接口"></a>隐式接口</h3><p>每个类隐式的定义了一个接口，含有类的所有实例和它实现的所有接口。如果你想创建一个支持类 B 的 API 的类 A，但又不想继承类 B ，那么，类 A 应该实现类 B 的接口。<br>一个类实现一个或更多接口通过用 implements 子句声明，然后提供 API 接口要求。例如：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// 一个 person 类 ，包含 greet() 的隐式接口。</span><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 在这个接口中，只有库中可见。</span>  <span class="token keyword">final</span> _name<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 不在接口中，因为这是个构造函数。</span>  <span class="token function">Person</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 在这个接口中。</span>  String <span class="token function">greet</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'Hello, $who. I am $_name.'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//  Person 接口的一个实现。</span><span class="token keyword">class</span> <span class="token class-name">Imposter</span> <span class="token keyword">implements</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 我们不得不定义它，但不用它。</span>  <span class="token keyword">final</span> _name <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>  String <span class="token function">greet</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'Hi $who. Do you know who I am?'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">greetBob</span><span class="token punctuation">(</span>Person person<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> person<span class="token punctuation">.</span><span class="token function">greet</span><span class="token punctuation">(</span><span class="token string">'bob'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token function">greetBob</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'kathy'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Hello, bob. I am kathy.</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token function">greetBob</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Imposter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Hi bob. Do you know who I am?</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一个类实现多个接口的例子：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token punctuation">,</span> Location <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><h3 id="扩展一个类"><a href="#扩展一个类" class="headerlink" title="扩展一个类"></a>扩展一个类</h3><p>使用 extends 创建一个子类，同时 supper 将指向父类：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Television</span> <span class="token punctuation">{</span>  <span class="token keyword">void</span> <span class="token function">turnOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">_illuminateDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_activateIrSensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">SmartTelevision</span> <span class="token keyword">extends</span> <span class="token class-name">Television</span> <span class="token punctuation">{</span>  <span class="token keyword">void</span> <span class="token function">turnOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">turnOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_bootNetworkInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_initializeMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_upgradeApps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="重写成员"><a href="#重写成员" class="headerlink" title="重写成员"></a>重写成员</h3><p>子类可以重载实例方法，getters 方法，setters 方法。可以使用 @override 注释来显示地表明你要重写的成员：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">SmartTelevision</span> <span class="token keyword">extends</span> <span class="token class-name">Television</span> <span class="token punctuation">{</span>  <span class="token metadata symbol">@override</span>  <span class="token keyword">void</span> <span class="token function">turnOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你可以使用 covariant 关键字来缩小类型安全代码中方法参数或实例变量的类型范围。<br>在一些（很少见到）的编码模式中使用子类型重写一个参数类型来缩小类型范围，这在强模式 Dart 中是非法的。在这种情况下，您可以使用协变关键字 covariant 告诉分析器您正在进行此操作。这将删除静态错误，而在运行时检查无效的参数类型。<br>下面是使用 covariant 的例子：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string">'package:meta/meta.dart'</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span>  <span class="token keyword">void</span> <span class="token function">chase</span><span class="token punctuation">(</span>Animal x<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Mouse</span> <span class="token keyword">extends</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Cat</span> <span class="token keyword">extends</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span>  <span class="token keyword">void</span> <span class="token function">chase</span><span class="token punctuation">(</span>covariant Mouse x<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>covariant 关键字可以放置在父类或子类方法中, 通常，父类方法是放置它的最佳方法。covariant 关键字适用于单个参数，并且支持 setters 和 fields。</p><hr><h3 id="noSuchMethod"><a href="#noSuchMethod" class="headerlink" title="noSuchMethod()"></a>noSuchMethod()</h3><p>当代码试图用不存在的方法或实例变量时，这个方法会被调用。</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 如果你不重写 noSuchMethod 方法，就用一个不存在的成员，会导致 NoSuchMethodError 错误。</span>  <span class="token keyword">void</span> <span class="token function">noSuchMethod</span> <span class="token punctuation">(</span>Invocation mirror<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'You tried to use a non-existent member:'</span> <span class="token operator">+</span>          <span class="token string">'${mirror.memberName}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果你用 noSuchMethod() 实现每一个可能的 getter 方法，setter 方法和类的方法，那么你可以使用 @proxy 标注来避免警告。</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token metadata symbol">@proxy</span><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>  <span class="token keyword">void</span> <span class="token function">noSuchMethod</span><span class="token punctuation">(</span>Invocation mirror<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关于注释 annotations，详见 <a href="https://www.dartlang.org/guides/language/language-tour#metadata" target="_blank" rel="noopener">元数据 MetaData</a></p><hr><h3 id="枚举类型"><a href="#枚举类型" class="headerlink" title="枚举类型"></a>枚举类型</h3><p>枚举类型，通常被称为 enumerations 或 enums ，是一种用来代表一个固定数量的常量的特殊类。</p><ul><li>使用枚举<br>声明一个枚举类型需要使用关键字 enum ：</li></ul><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">enum</span> Color <span class="token punctuation">{</span>  red<span class="token punctuation">,</span>  green<span class="token punctuation">,</span>  blue<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在枚举中每个值都有一个 index getter 方法，它返回一个在枚举声明中从 0 开始的位置。例如，第一个值索引值为 0，第二个值索引值为 1。</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">assert</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>red<span class="token punctuation">.</span>index <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>green<span class="token punctuation">.</span>index <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>blue<span class="token punctuation">.</span>index <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 要得到枚举列表的所有值，可使用枚举的 values 常量</span>List<span class="token operator">&lt;</span>Color<span class="token operator">></span> colors <span class="token operator">=</span> Color<span class="token punctuation">.</span>values<span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> Color<span class="token punctuation">.</span>blue<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你可以在 switch 语句 中使用枚举。如果 e 在 switch (e) 是显式类型的枚举，那么如果你不处理所有的枚举值将会弹出警告：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">enum</span> Color <span class="token punctuation">{</span>  red<span class="token punctuation">,</span>  green<span class="token punctuation">,</span>  blue<span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span>Color aColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>blue<span class="token punctuation">;</span><span class="token keyword">switch</span> <span class="token punctuation">(</span>aColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">case</span> Color<span class="token punctuation">.</span>red<span class="token punctuation">:</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Red as roses!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token keyword">case</span> Color<span class="token punctuation">.</span>green<span class="token punctuation">:</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Green as grass!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// 如果没有这个分句，将会弹出警告</span>    <span class="token function">print</span><span class="token punctuation">(</span>aColor<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 'Color.blue'</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>枚举类型有以下限制</p><ol><li>你不能在子类中混合或实现一个枚举</li><li>你不能显式实例化一个枚举</li></ol><hr><h3 id="为类添加特征：mixins"><a href="#为类添加特征：mixins" class="headerlink" title="为类添加特征：mixins"></a>为类添加特征：mixins</h3><p>mixins 是一种多类层次结构的类的代码重用。<br>要使用 mixins ，在 with 关键字后面跟一个或多个 mixin 的名字。下面的例子显示了两个使用 mixins 的类：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Musician</span> <span class="token keyword">extends</span> <span class="token class-name">Performer</span> <span class="token keyword">with</span> Musical <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Maestro</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span> <span class="token keyword">with</span> Musical<span class="token punctuation">,</span> Aggressive<span class="token punctuation">,</span> Demented <span class="token punctuation">{</span>  <span class="token function">Maestro</span><span class="token punctuation">(</span>String maestroName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    name <span class="token operator">=</span> maestroName<span class="token punctuation">;</span>    canConduct <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>要实现 mixin ，就创建一个继承 Object 类的子类，不声明任何构造函数，不调用 super。例如：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Musical</span> <span class="token punctuation">{</span>  bool canPlayPiano <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  bool canCompose <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  bool canConduct <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token function">entertainMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>canPlayPiano<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Playing piano'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>canConduct<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Waving hands'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Humming to self'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>从 1.13 起，Dart VM 已经取消了对 mixin 的两个限制：</p><blockquote><ol><li>Mixins 允许继承自类 class，不局限于 Object</li><li>Mixins 可以调用 super（）<br>“super mixins” 在 dart2js 不受支持，并且需要在 dartanalyzer 中使用 –supermixin 标签。更多关于 mixins，详见 <a href="https://www.dartlang.org/articles/language/mixins" target="_blank" rel="noopener">Mixins in Dart</a></li></ol></blockquote></blockquote><h3 id="类的变量和方法"><a href="#类的变量和方法" class="headerlink" title="类的变量和方法"></a>类的变量和方法</h3><p>使用 static 关键字来实现类变量和类方法。</p><ul><li>静态变量<br>静态变量（类变量）对于类状态和常数是有用的：</li></ul><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Color</span> <span class="token punctuation">{</span>  <span class="token keyword">static</span> <span class="token keyword">const</span> red <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token function">Color</span><span class="token punctuation">(</span><span class="token string">'red'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 一个恒定的静态变量</span>  <span class="token keyword">final</span> String name<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 一个实例变量。</span>  <span class="token keyword">const</span> <span class="token function">Color</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 一个恒定的构造函数。</span><span class="token punctuation">}</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>red<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'red'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>只有当静态变量被调用时才被初始化。</p><ul><li>静态方法<br>静态方法（类方法）不在一个实例上进行操作，因而不必访问 this 。例如：</li></ul><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string">'dart:math'</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>  num x<span class="token punctuation">;</span>  num y<span class="token punctuation">;</span>  <span class="token function">Point</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">static</span> num <span class="token function">distanceBetween</span><span class="token punctuation">(</span>Point a<span class="token punctuation">,</span> Point b<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> dx <span class="token operator">=</span> a<span class="token punctuation">.</span>x <span class="token operator">-</span> b<span class="token punctuation">.</span>x<span class="token punctuation">;</span>    <span class="token keyword">var</span> dy <span class="token operator">=</span> a<span class="token punctuation">.</span>y <span class="token operator">-</span> b<span class="token punctuation">.</span>y<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>dx <span class="token operator">*</span> dx <span class="token operator">+</span> dy <span class="token operator">*</span> dy<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> distance <span class="token operator">=</span> Point<span class="token punctuation">.</span><span class="token function">distanceBetween</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>distance <span class="token operator">&lt;</span> <span class="token number">2.9</span> <span class="token operator">&amp;&amp;</span> distance <span class="token operator">></span> <span class="token number">2.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你可以将静态方法作为编译时常量。例如，你可以把静态方法作为一个参数传递给静态构造函数。</p>]]></content>
      
      <categories>
          
          <category> Dart </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dart </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Dart 语法入门 II</title>
      <link href="/2017/10-Dart%20II.html"/>
      <url>/2017/10-Dart%20II.html</url>
      <content type="html"><![CDATA[<h2 id="函数-Functions"><a href="#函数-Functions" class="headerlink" title="函数 Functions"></a>函数 Functions</h2><p>Dart 是一门面向对象的语言，即使函数也是对象也有类型。这意味着函数可以分配给变量或者当作参数传给其他函数。也可以像函数一样调用一个类的实例，比如 <a href="https://www.dartlang.org/guides/language/language-tour#callable-classes" target="_blank" rel="noopener">可调用的 Classes</a>。<br>下面是定义了一个函数：</p><pre class="line-numbers language-dart"><code class="language-dart">bool <span class="token function">isNoble</span><span class="token punctuation">(</span>int atomicNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不指定函数返回类型也可以执行，但不推荐这样做</span>  <span class="token keyword">return</span> _nobleGases<span class="token punctuation">[</span>atomicNumber<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 可以用箭头语法描述单个表达式，但不能使用多行的语句，比如 if statement，可以用条件表达式 (?:) 代替 if else</span>bool <span class="token function">isNoble</span><span class="token punctuation">(</span>int atomicNumber<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> _nobleGases<span class="token punctuation">[</span>atomicNumber<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="函数的参数有两种类型：required-和-optional"><a href="#函数的参数有两种类型：required-和-optional" class="headerlink" title="函数的参数有两种类型：required 和 optional"></a>函数的参数有两种类型：required 和 optional</h3><p>首先列出所有必需的参数，再跟上可选的参数。</p><p>可选参数有两种指定方式：可选命名参数 named 和可选位置参数 positional</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// 定义函数时用{param1, param2, …}的形式指定 named 参数</span><span class="token function">enableFlags</span><span class="token punctuation">(</span><span class="token punctuation">{</span>bool bold<span class="token punctuation">,</span> bool hidden<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 调用函数时可以使用 paramName: value 的方式</span><span class="token function">enableFlags</span><span class="token punctuation">(</span>bold<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> hidden<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>用 [ ] 包裹可选参数：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// 定义函数时用 [param1, param2, …] 的形式指定 positional 参数</span>String <span class="token function">say</span><span class="token punctuation">(</span>String from<span class="token punctuation">,</span> String msg<span class="token punctuation">,</span> <span class="token punctuation">[</span>String device<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token string">'$from says $msg'</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>device <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    result <span class="token operator">=</span> <span class="token string">'$result with a $device'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token string">'Bob'</span><span class="token punctuation">,</span> <span class="token string">'Howdy'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'Bob says Howdy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token string">'Bob'</span><span class="token punctuation">,</span> <span class="token string">'Howdy'</span><span class="token punctuation">,</span> <span class="token string">'smoke signal'</span><span class="token punctuation">)</span> <span class="token operator">==</span>    <span class="token string">'Bob says Howdy with a smoke signal'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="默认参数值"><a href="#默认参数值" class="headerlink" title="默认参数值"></a>默认参数值</h3><p>在函数定义时可以用 = 给参数指定默认值，这个默认值必须是编译时常量，如果没有指定默认值则为 null。</p><p>下面是给 named 参数设置默认值的方法：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">void</span> <span class="token function">enableFlags</span><span class="token punctuation">(</span><span class="token punctuation">{</span>bool bold <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> bool hidden <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// bold will be true; hidden will be false.</span><span class="token function">enableFlags</span><span class="token punctuation">(</span>bold<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面是给 positional 参数设置默认值的方法：</p><pre class="line-numbers language-dart"><code class="language-dart">String <span class="token function">say</span><span class="token punctuation">(</span>String from<span class="token punctuation">,</span> String msg<span class="token punctuation">,</span>    <span class="token punctuation">[</span>String device <span class="token operator">=</span> <span class="token string">'carrier pigeon'</span><span class="token punctuation">,</span> String mood<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token string">'$from says $msg'</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>device <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    result <span class="token operator">=</span> <span class="token string">'$result with a $device'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>mood <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    result <span class="token operator">=</span> <span class="token string">'$result (in a $mood mood)'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token string">'Bob'</span><span class="token punctuation">,</span> <span class="token string">'Howdy'</span><span class="token punctuation">)</span> <span class="token operator">==</span>    <span class="token string">'Bob says Howdy with a carrier pigeon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以传递 lists 或者 maps 作为默认值：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">void</span> <span class="token function">doStuff</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    List<span class="token operator">&lt;</span>int<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> gifts <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>      <span class="token string">'first'</span><span class="token punctuation">:</span> <span class="token string">'paper'</span><span class="token punctuation">,</span>      <span class="token string">'second'</span><span class="token punctuation">:</span> <span class="token string">'cotton'</span><span class="token punctuation">,</span>      <span class="token string">'third'</span><span class="token punctuation">:</span> <span class="token string">'leather'</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'list:  $list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'gifts: $gifts'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Main-函数"><a href="#Main-函数" class="headerlink" title="Main() 函数"></a>Main() 函数</h3><p>每个 app 都必需有一个 main() 函数，main() 返回 void 而且有一个可选的 List<string>字符参数列表。</string></p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"#sample_text_id"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">"Click me!"</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span>onClick<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>reverseText<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// .. 是级联 (cascade) 操作符，可以对单个对象执行多个操作</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>给 main() 传入参数：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// 运行 app 时传入参数：dart args.dart 1 test</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> arguments<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>int<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将函数作为参数传给其他函数或者赋给变量：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token function">printElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>printElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> loudify <span class="token operator">=</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'!!! ${msg.toUpperCase()} !!!'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 一个匿名函数</span><span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">loudify</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'!!! HELLO !!!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="词法作用域-Lexical-scope"><a href="#词法作用域-Lexical-scope" class="headerlink" title="词法作用域 Lexical scope"></a>词法作用域 Lexical scope</h3><p>Dart 时一门词法作用域的语言，即变量的作用域是静态地决定的，由代码的布局决定的。<br>词法作用域的函数遇到既不是形参也不是函数内部定义的局部变量的变量时，会去函数定义时的环境中查询。</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> topLevel <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 如果去掉这一行，getLevel 报错“No top-level getter 'topLevel' declared”</span><span class="token keyword">void</span> <span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span>topLevel<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> topLevel <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 输出 1，因为 getsome() 定义时 topLevel=1</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="词法闭包"><a href="#词法闭包" class="headerlink" title="词法闭包"></a>词法闭包</h3><p>指的是一个函数可以访问其语法作用域内的变量，即使这个函数是在变量本身的作用域之外被调用的。<br>下面的例子中 makeAdder() 捕获了变量 addBy，不管返回的函数在哪里被调用，它都可以使用 addBy：</p><pre class="line-numbers language-dart"><code class="language-dart">Function <span class="token function">makeAdder</span><span class="token punctuation">(</span>num addBy<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>num i<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> addBy <span class="token operator">+</span> i<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> add2 <span class="token operator">=</span> <span class="token function">makeAdder</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> add4 <span class="token operator">=</span> <span class="token function">makeAdder</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">add2</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">add4</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="函数的等价性测试"><a href="#函数的等价性测试" class="headerlink" title="函数的等价性测试"></a>函数的等价性测试</h3><p>下面是关于顶层函数、静态方法和实例方法的等价性测试</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 一个顶层函数</span><span class="token keyword">class</span> <span class="token class-name">SomeClass</span> <span class="token punctuation">{</span>  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 一个静态方法</span>  <span class="token keyword">void</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 一个实例方法</span><span class="token punctuation">}</span><span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> x<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 比较顶级函数</span>  x <span class="token operator">=</span> foo<span class="token punctuation">;</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>foo <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>  <span class="token comment" spellcheck="true">// 比较静态方法</span>  x <span class="token operator">=</span> SomeClass<span class="token punctuation">.</span>bar<span class="token punctuation">;</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>SomeClass<span class="token punctuation">.</span>bar <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>  <span class="token comment" spellcheck="true">// 比较实例方法</span>  <span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SomeClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// SomeClass 的实例 1</span>  <span class="token keyword">var</span> w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SomeClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// SomeClass 的实例 2</span>  <span class="token keyword">var</span> y <span class="token operator">=</span> w<span class="token punctuation">;</span>  x <span class="token operator">=</span> w<span class="token punctuation">.</span>baz<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 这些闭包引用了相同的示例对象（A 的实例 2），所以它们是等价的</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>baz <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>  <span class="token comment" spellcheck="true">// 这些闭包引用的是不同实例，所以它们不等价</span>  <span class="token keyword">assert</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>baz <span class="token operator">!=</span> w<span class="token punctuation">.</span>baz<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="函数返回值"><a href="#函数返回值" class="headerlink" title="函数返回值"></a>函数返回值</h3><p>所有函数都会返回一个值，如果没有指定返回值，函数将会在函数体末尾隐式地添加“return null”</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">void</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 输出 null</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="操作符-Operators"><a href="#操作符-Operators" class="headerlink" title="操作符 Operators"></a>操作符 Operators</h2><p>Dart 定义了以下操作符，你可以 <a href="https://www.dartlang.org/guides/language/language-tour#overridable-operators" target="_blank" rel="noopener">重写这些操作符</a>。</p><table><thead><tr><th style="text-align:center">介绍</th><th style="text-align:left">符号</th></tr></thead><tbody><tr><td style="text-align:center">一元后缀符</td><td style="text-align:left">expr++ 、 expr– 、 () 、 [] 、 . 、 ?.</td></tr><tr><td style="text-align:center">一元前缀符</td><td style="text-align:left">-expr 、 !expr 、 ~expr 、 ++expr 、 —expr</td></tr><tr><td style="text-align:center">乘法类型</td><td style="text-align:left">* 、 / 、 % 、 ~/</td></tr><tr><td style="text-align:center">加法类型</td><td style="text-align:left">+ 、 -</td></tr><tr><td style="text-align:center">位操作符</td><td style="text-align:left">&lt;&lt; 、 &gt;&gt;</td></tr><tr><td style="text-align:center">按位与</td><td style="text-align:left">&amp;</td></tr><tr><td style="text-align:center">按位异或</td><td style="text-align:left">^</td></tr><tr><td style="text-align:center">按为或</td><td style="text-align:left">I</td></tr><tr><td style="text-align:center">比较和类型测试</td><td style="text-align:left">&gt;= 、 &gt; 、 &lt;= 、 &lt; 、 as 、 is 、 is!</td></tr><tr><td style="text-align:center">等价</td><td style="text-align:left">== 、 !=</td></tr><tr><td style="text-align:center">逻辑与</td><td style="text-align:left">&amp;&amp;</td></tr><tr><td style="text-align:center">逻辑或</td><td style="text-align:left">II</td></tr><tr><td style="text-align:center">null 分配符</td><td style="text-align:left">??</td></tr><tr><td style="text-align:center">条件运算符</td><td style="text-align:left">expr1 ? expr2 : expr3</td></tr><tr><td style="text-align:center">级联运算符</td><td style="text-align:left">..</td></tr><tr><td style="text-align:center">赋值</td><td style="text-align:left">= 、 *= 、 /= 、 ~/= 、 %= 、 += 、 -= 、 &lt;&lt;= 、 &gt;&gt;= 、 &amp;= 、 ^=</td></tr></tbody></table><h3 id="算术运算符"><a href="#算术运算符" class="headerlink" title="算术运算符"></a>算术运算符</h3><p>／ 返回 double 型，～／ 返回整型的除数，% 返回除法的余数：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 结果是 double 类型</span><span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">~/</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 结果是一个整数</span><span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 余数</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'5/2 = ${5~/2} 余 ${5%2}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 5/2 = 2 余 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="自增自减"><a href="#自增自减" class="headerlink" title="自增自减"></a>自增自减</h3><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>b <span class="token operator">=</span> <span class="token operator">++</span>a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 在 b 获得其值前先自增 a</span><span class="token keyword">assert</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1 == 1</span>a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>b <span class="token operator">=</span> a<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 在 b 获得其值后自增 a</span><span class="token keyword">assert</span><span class="token punctuation">(</span>a <span class="token operator">!=</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1 != 0</span>a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>b <span class="token operator">=</span> <span class="token operator">--</span>a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 在 b 获得其值前自减 a</span><span class="token keyword">assert</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// -1 == -1</span>a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>b <span class="token operator">=</span> a<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 在 b 获得其值后自减 a</span><span class="token keyword">assert</span><span class="token punctuation">(</span>a <span class="token operator">!=</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// -1 != 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="类型测试操作符"><a href="#类型测试操作符" class="headerlink" title="类型测试操作符"></a>类型测试操作符</h3><ul><li>as 类型转换</li><li>is 当对象是相应类型时返回 true</li><li>is！当对象不是相应类型时返回 true<br>如果 obj 实现了 T 所定义的借口，那么 obj is T 将返回 true。比如，obj is Object 必然返回 true。<br>使用 as 操作符可以把一个对象转换为特定类型。一般来说，如果在 is 测试之后还有一些关于对象的表达式，你可以把 as 当做是 is 测试的一种简写:</li></ul><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">if</span> <span class="token punctuation">(</span>emp <span class="token operator">is</span> Person<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 类型检查</span>  emp<span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">'Bob'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// as 化简代码</span><span class="token punctuation">(</span>emp <span class="token operator">as</span> Person<span class="token punctuation">)</span><span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">'Bob'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面两段代码并不相等。如果 emp 的值为 null 或者不是 Person 的一个对象，第一段代码不会做任何事情，第二段代码将会报错 。</p><h3 id="分配符"><a href="#分配符" class="headerlink" title="分配符"></a>分配符</h3><pre class="line-numbers language-dart"><code class="language-dart">a <span class="token operator">=</span> value<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 将 value 赋给 a</span>b <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">=</span> value<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 如果 b 为 null 将 value 赋给 b，否则 b 值不变</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="条件表达式"><a href="#条件表达式" class="headerlink" title="条件表达式"></a>条件表达式</h3><ul><li>condition ? expr1 : expr2 条件为真返回表达式 1，否则返回表达式 2</li><li>expr1 ?? expr2 表达式 1 为 null 则返回表达式 2，否则返回表达式 1</li></ul><pre class="line-numbers language-dart"><code class="language-dart">String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> msg <span class="token operator">?</span><span class="token operator">?</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 等价于</span>String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> msg <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> msg<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="级联操作符"><a href="#级联操作符" class="headerlink" title="级联操作符"></a>级联操作符</h3><p>允许你在单个对象的成员上执行多个操作</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#button'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Get an object.</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">'Confirm'</span>   <span class="token comment" spellcheck="true">// Use its members.</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span>classes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'important'</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span>onClick<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> window<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Confirmed!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 等价于</span><span class="token keyword">var</span> button <span class="token operator">=</span> <span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>button<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">'Confirm'</span><span class="token punctuation">;</span>button<span class="token punctuation">.</span>classes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'important'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>button<span class="token punctuation">.</span>onClick<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> window<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Confirmed!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>级联操作符可以嵌套</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">final</span> addressBook <span class="token operator">=</span> <span class="token punctuation">(</span>  <span class="token keyword">new</span> <span class="token class-name">AddressBookBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jenny'</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span>email <span class="token operator">=</span> <span class="token string">'jenny@example.com'</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span>phone <span class="token operator">=</span> <span class="token punctuation">(</span>    <span class="token keyword">new</span> <span class="token class-name">PhoneNumberBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span>number <span class="token operator">=</span> <span class="token string">'415-555-0100'</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span>label <span class="token operator">=</span> <span class="token string">'home'</span>  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在返回对象的函数上使用级联要格外注意，下面的例子中 sb.write() 返回 void，不能在 void 上构建级联</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>sb<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 无效</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>严格意义上讲，级联操作符 .. 不算一个操作符，它属于 Dart 语法的一部分，应该算作一个语法</p><h3 id="其他操作符"><a href="#其他操作符" class="headerlink" title="其他操作符"></a>其他操作符</h3><ul><li>一个点. 代表成员访问，比如 foo.bar 从 foo 中选择了 bar 属性</li><li>问号加上一个点 ?. 代表条件成员访问，?. 之前的操作数可以为空，比如 foo?.bar 从 foo 中选择属性 bar，当 foo 为空时则不访问 bar</li></ul><hr><h2 id="控制流语句-Control-flow-statements"><a href="#控制流语句-Control-flow-statements" class="headerlink" title="控制流语句 Control flow statements"></a>控制流语句 Control flow statements</h2><ul><li>if else</li><li>for 循环</li><li>while 和 do while 循环</li><li>break 和 continue</li><li>switch case</li><li>assert</li></ul><h3 id="for-循环"><a href="#for-循环" class="headerlink" title="for 循环"></a>for 循环</h3><p>Dart 的 for 循环闭包中可以获取 index 的值，就像下面的例子输出下标 0，1，2；而在 javaScript 中，下面的例子输出 3，3，3，如果想输出 0，1，2 需要把 var 改成 let</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// in Dart</span><span class="token keyword">var</span> callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  callbacks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>callbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 输出 0，1，2</span><span class="token comment" spellcheck="true">// in javaScript</span><span class="token keyword">var</span> callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 改成 let 输出 0，1，2</span>  callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>callbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 输出 3，3，3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可迭代的元素可以用 forEach() 方法遍历，也可以用 for-in</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> collection <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> x <span class="token keyword">in</span> collection<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="break-和-continue"><a href="#break-和-continue" class="headerlink" title="break 和 continue"></a>break 和 continue</h3><p>用 break 退出循环，循环结束</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shutDownRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token function">processIncomingRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>用 continue 跳出这一次循环，循环不结束</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> candidates<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> candidate <span class="token operator">=</span> candidates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">.</span>yearsExperience <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">continue</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  candidate<span class="token punctuation">.</span><span class="token function">interview</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过迭代可以简化上述代码</p><pre class="line-numbers language-dart"><code class="language-dart">candidates<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> c<span class="token punctuation">.</span>yearsExperience <span class="token operator">>=</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> c<span class="token punctuation">.</span><span class="token function">interview</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="转换语句"><a href="#转换语句" class="headerlink" title="转换语句"></a>转换语句</h3><p>可以使用 continue 和标签来跳转</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> command <span class="token operator">=</span> <span class="token string">'CLOSED'</span><span class="token punctuation">;</span><span class="token keyword">switch</span> <span class="token punctuation">(</span>command<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">case</span> <span class="token string">'CLOSED'</span><span class="token punctuation">:</span>    <span class="token function">executeClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">continue</span> nowClosed<span class="token punctuation">;</span>nowClosed<span class="token punctuation">:</span>  <span class="token keyword">case</span> <span class="token string">'NOW_CLOSED'</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">// Runs for both CLOSED and NOW_CLOSED.</span>    <span class="token function">executeNowClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一个 case 分句可以含有局部变量，该局部变量仅仅只在此分句范围内可见</p><h3 id="assert"><a href="#assert" class="headerlink" title="assert"></a>assert</h3><p>如果一个布尔条件值为 false，使用 assert 语句来中断正常执行的代码。在 assert 语句后面的括号中，你可以加入任何表示布尔值或者函数的表达式。如果表达式的值或者函数返回值 true，则 assert 语句成功并继续执行代码。如果值为 false，则 assert 语句失败并抛出一个异常 (an AssertionError)</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// 确保这个变量不为空值.</span><span class="token keyword">assert</span><span class="token punctuation">(</span>text <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 确保这个变量小于 100.</span><span class="token keyword">assert</span><span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 确保它是一个 https 协议类型的 URL.</span><span class="token keyword">assert</span><span class="token punctuation">(</span>urlString<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>‘https’<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>⚠️注意：assert 语句仅仅只能在调试模式下使用，在生产模式下没有任何作用。</p><p>要将消息附加到断言，添加一个字符串作为第二个参数，当第一个参数为 false 时第二个参数会随错误一起抛出</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">assert</span><span class="token punctuation">(</span>urlString<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'URL ($urlString) should start with "https".'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="异常-Exception"><a href="#异常-Exception" class="headerlink" title="异常 Exception"></a>异常 Exception</h2><h3 id="throw-语句"><a href="#throw-语句" class="headerlink" title="throw 语句"></a>throw 语句</h3><p>抛出了一个异常：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FormatException</span><span class="token punctuation">(</span><span class="token string">'Expected at least 1 section'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>也可以将任意对象作为异常抛出：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">throw</span> <span class="token string">'Out of llamas!'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>因为抛出异常的语句是个表达式，所以可以写在箭头函数里：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token function">distanceTo</span><span class="token punctuation">(</span>Point other<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnimplementedError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="on-catch-语句"><a href="#on-catch-语句" class="headerlink" title="on catch 语句"></a>on catch 语句</h3><p>捕获一个异常:</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">try</span> <span class="token punctuation">{</span>  <span class="token function">breedMoreLlamas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> on OutOfLlamasException <span class="token punctuation">{</span>  <span class="token function">buyMoreLlamas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了处理含有多种类型异常的代码，你可以选择多个 catch 子句。第一个匹配抛出对象类型的 catch 子句将会处理这个异常。如果 catch 子句未说明所捕获的异常类型，这个子句就可处理任何被抛出的对象:</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">try</span> <span class="token punctuation">{</span>  <span class="token function">breedMoreLlamas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> on OutOfLlamasException <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 一个具体异常</span>  <span class="token function">buyMoreLlamas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> on Exception <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 任意一个异常</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Unknown exception: $e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span>，s<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 非具体类型</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Exception details:\n $e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Stack trace:\n $s'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>catch() 可以带两个参数，第二个参数代表堆栈跟踪 <a href="https://api.dartlang.org/stable/dart-core/StackTrace-class.html" target="_blank" rel="noopener">stack trace</a>。</p><p>要处理部分异常，同时允许它传播，可以使用 rethrow 关键字：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">final</span> foo <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">misbehave</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    foo <span class="token operator">=</span> <span class="token string">"You can't change a final variable's value."</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'misbehave() partially handled ${e.runtimeType}.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">rethrow</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Allow callers to see the exception.</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token function">misbehave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'main() finished handling ${e.runtimeType}.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的例子输出两条 print 语句，如果去掉 rethrow 则只输出第一个 print 语句</p><h3 id="finally-语句"><a href="#finally-语句" class="headerlink" title="finally 语句"></a>finally 语句</h3><p>如果没有 catch 匹配子句的异常， finally 子句运行以后异常将被传播：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">try</span> <span class="token punctuation">{</span>  <span class="token function">breedMoreLlamas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 即使抛出一个异常时也会进行清理</span>  <span class="token function">cleanLlamaStalls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">try</span> <span class="token punctuation">{</span>  <span class="token function">breedMoreLlamas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Error: $e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 先处理异常</span><span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>  <span class="token function">cleanLlamaStalls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 然后清理</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      <categories>
          
          <category> Dart </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dart </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Mac 快速入门操作指南</title>
      <link href="/2017/10-MacSkills.html"/>
      <url>/2017/10-MacSkills.html</url>
      <content type="html"><![CDATA[<blockquote><p>OS X 测试版本 Mac Sierra 10.12.4，测试机型 Mac Air</p></blockquote><h2 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h2><p>键盘符号说明<br><img alt="image" src="https://src.wangriyu.wang/images/blog/mac/mac_keyboard.jpg" width="650px" height="900px"></p><p>系统设置 <code>system preferences &gt; keyboard &gt; shortcuts</code> 下有很多自定义快捷键设置，每个人都可以根据自己的喜好修改，熟悉以下的操作将会大大提高生产力，提升效率</p><h3 id="修改输入法切换的快捷方式"><a href="#修改输入法切换的快捷方式" class="headerlink" title="修改输入法切换的快捷方式"></a>修改输入法切换的快捷方式</h3><p>依次打开系统设置 <code>system preferences &gt; keyboard &gt; shortcuts &gt; input sources</code>，然后勾选其中的 select next source in input menu 选项，然后输入你想要的快捷键组合，这就是输入法切换快捷键了。我的是 <kbd>Opt</kbd> + <kbd>Space</kbd> 切换输入法，<kbd>CMD</kbd> + <kbd>Space</kbd> 用来打开 Alfred。</p><h3 id="关闭-spotlight"><a href="#关闭-spotlight" class="headerlink" title="关闭 spotlight"></a>关闭 spotlight</h3><p>推荐用 Alfred 代替自带的 spotlight 应用，所以可以把 spotlight 关掉然后把 <kbd>CMD</kbd> + <kbd>Space</kbd> 快捷键设置成 Alfred<br>进入 <code>system preferences &gt; keyboard &gt; shortcuts &gt; spotlight</code> 取消 spotlight 选项</p><h3 id="删除字符的快捷方式"><a href="#删除字符的快捷方式" class="headerlink" title="删除字符的快捷方式"></a>删除字符的快捷方式</h3><p>这个和 windows 有点不同，windows 中是用 <kbd>backspace</kbd> 键来删除光标左侧字符，用 <kbd>Delete</kbd> 键来删除光标右侧字符。而在 Mac 中，是用 <kbd>Delete</kbd> 键来删除光标左侧字符。如果要删除光标右侧字符的话，则需要使用 <kbd>fn</kbd> + <kbd>Delete</kbd>。在 Mac 中，可以使用 <kbd>CMD</kbd> + <kbd>Delete</kbd> 来删除光标左侧的整行文字。</p><h3 id="光标和翻页的快捷方式"><a href="#光标和翻页的快捷方式" class="headerlink" title="光标和翻页的快捷方式"></a>光标和翻页的快捷方式</h3><p>以下快捷键加上 <kbd>Shft</kbd> 键可以选中文字：</p><ul><li><kbd>CMD</kbd> + 下箭头，可以快速定位到一篇文章的末尾，在浏览器中可以快速拉到底部</li><li><kbd>CMD</kbd> + 上箭头，可以快速定位到一篇文章的开头，在浏览器中可以快速回到顶部</li><li><kbd>CMD</kbd> + 左箭头（也可以 <kbd>Ctrl</kbd> + A 或者 <kbd>Opt</kbd> + 上箭头），可以快速定位到一行的行首</li><li><kbd>CMD</kbd> + 右箭头（也可以 <kbd>Ctrl</kbd> + E 或者 <kbd>Opt</kbd> + 下箭头），可以快速定位到一行的行末</li><li><kbd>Opt</kbd> + 左箭头，跳到当前单词的开头</li><li><kbd>Opt</kbd> + 右箭头，跳到当前单词的末尾</li><li><kbd>Ctrl</kbd> + N，跳至下一行</li><li><kbd>Ctrl</kbd> + P，跳至上一行</li></ul><p>文本编辑中的光标移动，也适用于命令行</p><ul><li><kbd>Ctrl</kbd> + F (Forward): 光标右移</li><li><kbd>Ctrl</kbd> + B (Backward): 光标左移</li><li><kbd>Ctrl</kbd> + P (Previous): 光标上移</li><li><kbd>Ctrl</kbd> + N (Next): 光标下移</li><li><kbd>Ctrl</kbd> + A : 光标移至段落头部（Move to the Beginning of the Paragraph）</li><li><kbd>Ctrl</kbd> + E (End): 光标移至段落尾部（Move to the End of the Paragraph）</li></ul><p>文本编辑</p><ul><li><kbd>Ctrl</kbd> + H : 移除光标左一字符</li><li><kbd>Ctrl</kbd> + D (Delete): 移除光标右一字符</li><li><kbd>Ctrl</kbd> + K : 移除光标右侧内容，至段落结束（Delete to the End of the Paragraph）</li><li><kbd>Ctrl</kbd> + O : 在光标处换行，相当于回车键（Split the Current Line）</li><li><kbd>Ctrl</kbd> + T (Transpose): 交换光标前后一字符位置（Transpose Letters）</li></ul><p>组合按键</p><ul><li><kbd>Ctrl</kbd> + AK: 移除光标所在行（Clear Current Line）</li><li><kbd>Ctrl</kbd> + EK: 与后一行合并（Join Lines）</li></ul><h3 id="程序相关的快捷键"><a href="#程序相关的快捷键" class="headerlink" title="程序相关的快捷键"></a>程序相关的快捷键</h3><ul><li><kbd>CMD</kbd> + q，快速退出程序进程</li><li><kbd>CMD</kbd> + w，关闭当前页面，相当于按窗口左上角的红色叉，但是该程序的进程并没有退出</li><li><kbd>CMD</kbd> + <kbd>Tab</kbd>，可以在当前打开进程的程序中进行切换</li><li><kbd>CMD</kbd> + h，可以隐藏当前的应用程序</li><li><kbd>CMD</kbd> + 逗号， 可以打开当前应用程序的偏好设置</li></ul><h3 id="强制退出的快捷键"><a href="#强制退出的快捷键" class="headerlink" title="强制退出的快捷键"></a>强制退出的快捷键</h3><p>如果 Mac 中的某个程序运行出现异常，需要强制退出，可以按下的快捷键 <kbd>Opt</kbd> + <kbd>CMD</kbd> + <kbd>Esc</kbd>，这时系统会弹出一个 force quit application 的窗口，选中需要强制退出的程序，点击 force quit 键即可。也可以在 Dock 栏右键要关闭的程序，再长按 <kbd>Opt</kbd> 键会出现 <code>force quit</code> 和 <code>hide others</code> 选项</p><h3 id="窗口相关的快捷键"><a href="#窗口相关的快捷键" class="headerlink" title="窗口相关的快捷键"></a>窗口相关的快捷键</h3><ul><li><kbd>CMD</kbd> + n，建立一个新窗口</li><li><kbd>CMD</kbd> + `(反引号，数字 1 旁边)，在打开的程序窗口之间进行切换</li><li><kbd>CMD</kbd> + m，可以最小化当前窗口</li><li><kbd>CMD</kbd> + t，建立一个新签标</li><li><kbd>Ctrl</kbd> + 左右方向键（←→）切换桌面</li><li><kbd>Opt</kbd> + <kbd>CMD</kbd> + 左右方向键（←→）在浏览器中切换标签</li><li><kbd>Ctrl</kbd> + ↑：mission control</li><li><kbd>Ctrl</kbd> + ↓：application control</li><li><kbd>F11</kbd>：显示桌面，mac air 要 <kbd>fn</kbd> + <kbd>F11</kbd></li></ul><h3 id="手动整理状态栏图标"><a href="#手动整理状态栏图标" class="headerlink" title="手动整理状态栏图标"></a>手动整理状态栏图标</h3><p>按住 <kbd>⌘</kbd> 键左右拖动顶部状态栏图标</p><h3 id="截图相关的快捷键"><a href="#截图相关的快捷键" class="headerlink" title="截图相关的快捷键"></a>截图相关的快捷键</h3><p>可以在 <code>system preferences &gt; keyboard &gt; shortcuts &gt; screen shots</code> 中修改</p><ul><li><kbd>CMD</kbd> + <kbd>Shft</kbd> + 3，对整个屏幕进行截图，并且保存在桌面</li><li><kbd>CMD</kbd> + <kbd>Shft</kbd> + 4，用鼠标划定一个范围，会对该范围进行截图并且保存在桌面</li><li><kbd>CMD</kbd> + <kbd>Shft</kbd> + 4，鼠标不动，按空格键，会对当前操作的窗口进行截图并且保存在桌面</li><li><kbd>CMD</kbd> + <kbd>Shft</kbd> + <kbd>Ctrl</kbd> + 4，类似于以上 <kbd>CMD</kbd> + <kbd>Shft</kbd> + 4 的两类操作，只不过其截图是保存在剪切板上，不在桌面上，可以后续将其贴在 page 等文档中</li></ul><h3 id="声音相关的快捷键"><a href="#声音相关的快捷键" class="headerlink" title="声音相关的快捷键"></a>声音相关的快捷键</h3><ul><li>Mac 自带了多种的系统语音，可以分别识别各国的语言，发出各国的语音。</li></ul><p>在 <code>system preferences &gt; accessibility &gt; speech &gt; system voice</code> 中可以选择各国的语音了。</p><p>在弹出框到最下方，有一个 speak selected text when the key is pressed 的选项，这就表示当你选中某个文本的时候，以下的快捷键可以实现对该文本的发音。默认的快捷键是：<kbd>Opt</kbd> + <kbd>Esc</kbd>。</p><ul><li>按住 <kbd>Opt</kbd> + <kbd>Shft</kbd>，再按功能键调节音量可以实现四分之一为单位调整</li></ul><h3 id="隐藏-Dock-栏的快捷键"><a href="#隐藏-Dock-栏的快捷键" class="headerlink" title="隐藏 Dock 栏的快捷键"></a>隐藏 Dock 栏的快捷键</h3><p>按下 <kbd>Opt</kbd> + <kbd>CMD</kbd> + d，可以隐藏 dock 栏，此时如果把鼠标移动到 dock 栏原先所在位置，dock 栏会重新出现在下方，待鼠标移走后，dock 栏又重新隐藏。再次按下 <kbd>Opt</kbd> + <kbd>CMD</kbd> + d，dock 栏重新恢复到正常的显示状态。</p><h3 id="Option-妙用"><a href="#Option-妙用" class="headerlink" title="Option 妙用"></a>Option 妙用</h3><p><kbd>Opt</kbd> 和其他一些按键同时作用时，常常发挥出很多神奇的作用</p><ul><li><kbd>Opt</kbd> + <kbd>CMD</kbd> + h，如果当前桌面上同时打开了好多个程序，这个快捷键可以隐藏当前应用程序外的其他应用程序。如果只是 <kbd>Opt</kbd> + h 只隐藏当前程序</li><li><kbd>Opt</kbd> + <kbd>CMD</kbd> + v，可以实现对一个已复制文件的移动，类似于 windows 中对文件的剪切黏贴效果</li><li><kbd>Opt</kbd> + <kbd>CMD</kbd> + w，可以关闭 safari 下除当前 tab 外的所有其他 tab，或者关闭某 app 相关的所有窗口。比如当你选中一批文件，按下 <kbd>CMD</kbd> + i 后，会弹出所有选中文件的 info 窗口，这时候就可以按 <kbd>Opt</kbd> + <kbd>CMD</kbd> + w 将全部 info 窗口关闭</li><li><kbd>Opt</kbd> + <kbd>CMD</kbd> + i，可以用于选中好几个文件的场合，来看所有文件整合的 info 消息及所有文件占据空间的大小总和</li><li>打开 launchpad，按下 <kbd>Opt</kbd> 键，所有 app 都会颤抖，和 iphone 中的状况是一样的。这时候按颤抖 app 上的✖️，即可卸载该 app。仅适用于 app store 上下载的 app 的卸载</li><li>选择 dock 栏上打开的程序，按下右键弹出菜单后，再按下 <kbd>Opt</kbd> 键，这时就发现菜单栏倒数两项分别从 hide，quit 变化为 hide others 和 force quit</li><li>在 safari 中，如果按下 <kbd>CMD</kbd> + <kbd>Opt</kbd> + q 退出 safari，那么再次打开 Safari 的话，会发现之前打开的网址全部被保留了下来。但是如果是以 <kbd>CMD</kbd> + q 的方式退出 safari，就没有这个保留网址的效果了</li><li><kbd>Opt</kbd> + 点击 Dock 上的图标，可打开此程序或文件夹所在的目录。</li></ul><h3 id="屏幕取词"><a href="#屏幕取词" class="headerlink" title="屏幕取词"></a>屏幕取词</h3><p>可以用 <kbd>Ctrl</kbd> + <kbd>CMD</kbd> + d 来实现屏幕取词的功能。作用与三指点击取词的手势操作一样。</p><h3 id="Finder-快捷键"><a href="#Finder-快捷键" class="headerlink" title="Finder 快捷键"></a>Finder 快捷键</h3><p><img src="https://src.wangriyu.wang/images/blog/mac/finder.png" alt="image"></p><ul><li><kbd>CMD</kbd> + <kbd>Delete</kbd> 将选择的文件删除到垃圾箱</li><li><kbd>CMD</kbd> + z 撤销操作，包括复制粘贴删除</li><li>选中文件再按空格键 打开快速查看窗口</li><li>选中文件再回车 重命名</li><li><kbd>CMD</kbd> + N 新打开一个 Finder 窗口</li><li><kbd>CMD</kbd> + <kbd>Shft</kbd> + N 新建一个文件夹</li><li><kbd>CMD</kbd> + I 显示文件 / 文件夹简介</li><li><kbd>CMD</kbd> + A 全选</li><li><kbd>CMD</kbd> + <kbd>Opt</kbd> + A 取消全选</li><li><kbd>CMD</kbd> + <kbd>Shft</kbd> + <kbd>句号 (.)</kbd> <code>可以切换显示隐藏文件、文件夹</code></li><li><kbd>CMD</kbd> + <kbd>Shft</kbd> + G，可以跳转指定路径</li><li><kbd>CMD</kbd> + <kbd>Shft</kbd> + C，可以复制当前文件路径</li><li><kbd>CMD</kbd> + <kbd>Shft</kbd> + P，可以打开预览窗口</li><li><kbd>CMD</kbd> + <kbd>Shft</kbd> + T，可以打开导航栏，跟浏览器一样</li><li><kbd>CMD</kbd> + /，可以打开底部状态栏</li><li><kbd>Opt</kbd> + <kbd>CMD</kbd> + P，可以打开底部路径栏</li><li><kbd>Opt</kbd> + <kbd>CMD</kbd> + S，可以隐藏左侧栏</li><li><kbd>CMD</kbd> + 上下键跳转父子目录</li><li>按住 <kbd>CMD</kbd>+ <kbd>Opt</kbd>+ 拖动文件，可快速“制作替身”</li><li><kbd>Opt</kbd> + 双击文件夹，强制本窗口打开文件夹</li><li><kbd>CMD</kbd> + 双击文件夹，强制新窗口打开文件夹</li></ul><h3 id="快速切换目录"><a href="#快速切换目录" class="headerlink" title="快速切换目录"></a>快速切换目录</h3><p>在 OS X 下，可以在终端中以 cd ~ 的方式进入用户目录。</p><p>如果是在 Finder 里，可以按 <kbd>CMD</kbd> + <kbd>Shft</kbd> + h，快速切换到用户目录。<br><kbd>CMD</kbd> + <kbd>Shft</kbd> + d，快速切换到桌面目录。<br><kbd>CMD</kbd> + <kbd>Shft</kbd> + o，快速切换到 Documents 目录。</p><p>其他的快速切换在菜单栏 Go 中</p><h3 id="在-MAC-中输入特殊字符"><a href="#在-MAC-中输入特殊字符" class="headerlink" title="在 MAC 中输入特殊字符"></a>在 MAC 中输入特殊字符</h3><p><kbd>Opt</kbd> + 各个键都有特定的一个字符，<kbd>Opt</kbd> + <kbd>Shft</kbd> + 各个键也有特殊的字符</p><p>苹果标志 （<kbd>Shft</kbd> + <kbd>Opt</kbd> + K）<br>Copyright © (<kbd>Opt</kbd> + G)<br>美元 $ (<kbd>Shft</kbd> + 4)<br>美分 ￠ (<kbd>Opt</kbd> + 4)<br>英镑 ￡ （<kbd>Opt</kbd> + 3)<br>日元 ￥(<kbd>Opt</kbd> + Y)<br>欧元 €（<kbd>Shft</kbd> + <kbd>Opt</kbd> + 2)<br>破折号 –(<kbd>Opt</kbd> + -)<br>约等于 ≈（<kbd>Opt</kbd> + X)<br>度 °(<kbd>Shft</kbd> + <kbd>Opt</kbd> + 8)<br>除号 ÷（<kbd>Opt</kbd> + /)<br>循环 ∞（<kbd>Opt</kbd> + 5）<br>小于等于≤（<kbd>Opt</kbd> + ,)<br>大于等于≥（<kbd>Opt</kbd> + .)<br>不等于≠（<kbd>Opt</kbd> + =）<br>Pi π（<kbd>Opt</kbd> + P）<br>正负号 ±(<kbd>Shft</kbd> + <kbd>Opt</kbd> + =)<br>平方根√（<kbd>Opt</kbd> + V)<br>求和 ∑（<kbd>Opt</kbd> + w）<br>产品标识 ™（<kbd>Opt</kbd> + 2)<br>®(<kbd>Opt</kbd> + r)</p><p>快捷键 <kbd>Ctrl</kbd> + <kbd>CMD</kbd> + <kbd>Space</kbd> 打开系统自带的符号面板，可以选择特殊字符输入，比如 cmd⌘、option⌥、control⌃、shift⇧、caps lock⇪、delete⌫、arrow↑→↓←等</p><h3 id="Finder-设置"><a href="#Finder-设置" class="headerlink" title="Finder 设置"></a>Finder 设置</h3><ul><li>显示隐藏文件</li></ul><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token property-declaration"><span class="token property">defaults</span> write com<span class="token operator">.</span>apple<span class="token operator">.</span>finder AppleShowAllFiles -boolean <span class="token boolean">true</span> <span class="token punctuation">;</span> killall Finder</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>将 true 改为 false 恢复隐藏</p><ul><li>在顶部显示绝对路径，右键绝对路径前的图标可以切换父目录</li></ul><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token property-declaration"><span class="token property">defaults</span> write com<span class="token operator">.</span>apple<span class="token operator">.</span>finder _FXShowPosixPathInTitle -bool YES</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>将 yes 换为 no 还原</p><ul><li>底部地址栏从用户开始，默认是显示“MacHD/Users/clown/Downloads”，修改后显示“clown/Downloads”</li></ul><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token property-declaration"><span class="token property">defaults</span> write com<span class="token operator">.</span>apple<span class="token operator">.</span>finder PathBarRootAtHome -bool TRUE<span class="token punctuation">;</span>killall Finder</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>将 true 改为 false 还原</p><h3 id="Terminal-常用命令"><a href="#Terminal-常用命令" class="headerlink" title="Terminal 常用命令"></a>Terminal 常用命令</h3><ul><li><p><code>pwd</code> 显示当前路径</p></li><li><p><code>which 库名</code> 查看安装目录，比如 <code>which go</code> 输出 /usr/local/go/bin/go</p></li><li><p><code>cd 路径</code> 跳转，支持绝对路径和相对路径 ./ 和 ../</p></li><li><p><code>mkdir 文件名</code> 新建文件夹</p></li><li><p><code>rmdir 文件名</code> 删除目录</p></li><li><p><code>mvdir</code> 移动目录</p></li><li><p><code>cat + 文件</code> 预览文件</p></li><li><p><code>ls 参数 路径</code> 列出文件，<code>ls -l -A -h</code> 显示当前路径详细信息文件列表</p></li><li><p><code>cp 参数 源文件 目标文件</code> 拷贝文件，<code>cp -R ./Downloads/* ~/Desktop</code> 表示将 Downloads 下所有文件拷贝到桌面，-R 表示递归操作，源文件是文件夹时需要</p></li><li><p><code>rm 参数 文件</code> 删除文件，参数－rf 表示递归和强制，文件夹需要 -r 参数，-i 参数表示删除前要确认</p></li><li><p><code>mv 文件 路径</code> 移动文件</p></li><li><p><code>file 文件</code> 显示文件类型</p></li><li><p><code>open 文件</code> 用默认工具打开文件</p></li><li><p><code>touch 文件名</code> 更改文件的时间信息（可以用 <code>stat 文件</code> 查看），如果文件不存在会创建一个新的空文件，常用于创建新文件</p></li><li><p><code>vi 文件名</code> 编辑文件，如果文件不存在就新建一个并打开文件，在 vi 编辑器中输入“:wq”保存更改并退出，推荐用 vim 代替 vi</p></li><li><p><code>find</code> 查询文件，<code>find 目录 -type f|wc -l</code> 统计文件数，<code>find 目录 -type d|wc -l</code> 统计目录数，<code>find . -name &quot;*.js&quot; -print</code> 查询 js 格式的文件</p></li><li><p><code>date</code> 显示系统时间</p></li><li><p><code>cal</code> 显示日历</p></li><li><p><code>time 程序</code> 统计程序的执行时间，比如 time a.out</p></li><li><p><code>telnet</code> 远程登录</p></li><li><p><code>clear</code> 清除窗口内容</p></li><li><p><code>env</code> 显示当前所有设置过的环境变量</p></li><li><p><code>du</code> 查询磁盘使用情况，<code>du -sh 目录</code> 统计目录大小</p></li><li><p><code>df</code> 显示文件系统的总空间和可用空间, <code>df -h /</code> 显示硬盘使用情况</p></li><li><p><code>history</code> 列出最近执行过的 几条命令及编号</p></li><li><p><code>alias</code> 给某个命令定义别名，比如 <code>alias del=rm -i</code></p></li><li><p><code>top</code> 显示进程信息</p></li><li><p><code>kill 进程</code> 终止进程<br>……</p></li></ul><p>更多参看：[mac 终端命令大全介绍]<a href="https://www.douban.com/note/75797151/" target="_blank" rel="noopener">https://www.douban.com/note/75797151/</a></p><h3 id="介绍-Alfred"><a href="#介绍-Alfred" class="headerlink" title="介绍 Alfred"></a>介绍 Alfred</h3><p>前面提到了 Alfred，现在介绍一下如何使用它，使用教程网上都有，我就不赘述了，这里贴上一篇 <a href="http://wellsnake.com/jekyll/update/2014/06/15/001/" target="_blank" rel="noopener">丢掉鼠标－Mac 神软 Alfred 使用手册</a></p><p>我的设置如下</p><ul><li>热键：我设置的热键是 <kbd>CMD</kbd> + <kbd>Space</kbd>，刚好代替系统自带的 spotlight</li><li>Default Results：勾上书签，支持搜索 Safari 的书签，但我用的是 Chrome，可以把书签导入到 Safari 中即可；Search Scope 设置 Alfred 查询时会遍历的文件夹，在这里可以自己添加经常访问的和删除不必要文件夹</li><li>Web Search：经常用到的功能，把自己常用的网站设置快捷键，像 google 搜索只要在 Alfred 中输入 <code>gg 搜索的内容</code> 即可，给自己的博客添加快捷键 blog 等等<br><img src="https://src.wangriyu.wang/images/blog/artifact/websearch.png" alt="images"></li><li>关联 terminal，直接在 Alfred 中输入 <code>&gt; 命令</code> 执行</li><li>workflow：我用的有 Chrome Bookmarks、Dash 和有道词典翻译，功能分别是搜索 Chrome 书签、<code>Dash 搜索内容</code> 打开 Dash 中的 API 介绍，<code>yd 待翻译内容</code> 显示翻译，其他 workflow 可以到网站 <a href="http://www.packal.org" target="_blank" rel="noopener">http://www.packal.org</a> 和 <a href="https://www.alfredapp.com/workflows" target="_blank" rel="noopener">https://www.alfredapp.com/workflows</a> 上看看</li><li>remote：远程控制电脑<br><img src="https://src.wangriyu.wang/images/blog/mac/bookmarks.png" alt="image"></li></ul><p>完成设置后，之后几乎所有事都可以快捷键 <kbd>CMD</kbd> + <kbd>Space</kbd> 打开 Alfred 解决，打开应用、搜索文件、执行命令、跳转网页、翻译、计算等等</p><h2 id="手势操作"><a href="#手势操作" class="headerlink" title="手势操作"></a>手势操作</h2><p>如果只是快捷键的话，windows 也有，没什么很特别的，mac 的优势之一就是它的触控板了，所以接下来介绍如何用好手势操作</p><h3 id="基础设置"><a href="#基础设置" class="headerlink" title="基础设置"></a>基础设置</h3><p>打开系统设置 <code>system preferences &gt; Trackpad</code>，看介绍选择自己喜欢的操作，<br>我推荐把四指切换桌面选上，平时切换桌面会方便很多；<br>还有三指上划显示 Mission Control 选上，方便切换任务、整理桌面</p><h3 id="设置-Hot-Corner"><a href="#设置-Hot-Corner" class="headerlink" title="设置 Hot Corner"></a>设置 Hot Corner</h3><p>打开 <code>system preferences &gt; Mission Control</code>，点击底部 Hot Corner，设置鼠标移入四个角时的操作，比如我的<br><img src="https://src.wangriyu.wang/images/blog/mac/hotcorner.png" alt="image"></p><p>鼠标移入右下角息屏，右上角显示桌面，很方便，是我使用很多的功能</p><h3 id="添加手势扩展"><a href="#添加手势扩展" class="headerlink" title="添加手势扩展"></a>添加手势扩展</h3><p>推荐两个软件：<a href="http://www.jitouch.com/" target="_blank" rel="noopener">Jitouch</a> 和 <a href="https://www.boastr.net/" target="_blank" rel="noopener">BetterTouchTool</a></p><p>bettertouch 比 jitouch 更强大，支持的东西更多，但收费而且设置也会更复杂一点，对我来说 jitouch 已经够用，如果你喜欢折腾就去试下 bettertouch</p><p>安装好后设置自己喜欢的手势，比如我的<br><img src="https://src.wangriyu.wang/images/blog/artifact/jitouch1.png" alt="image"><br><img src="https://src.wangriyu.wang/images/blog/artifact/jitouch2.png" alt="image"></p><p>使用手势时要注意两指的距离，设置里可以调，但不要太近，太近容易跟滚动冲突，我推荐用食指和无名指划字。</p><p>我也试了下 buttertouch，它支持自定义手势，可选择的 action 也比 jitouch 多很多，但要注意一点，设置手势后还要设置一个快捷键选择 record gesture，然后每次操作先按这个快捷键出现可划动区域再划手势，其实这点没有 jitouch 好用。</p><h2 id="Terminal"><a href="#Terminal" class="headerlink" title="Terminal"></a>Terminal</h2><p>这节主要跟 terminal 有关，terminal 这也是 mac 另一大优势</p><p>推荐安装 oh my zsh 和 iTerm2，提升 terminal 的使用效率和逼格指数</p><h3 id="Oh-My-ZSH"><a href="#Oh-My-ZSH" class="headerlink" title="Oh My ZSH"></a>Oh My ZSH</h3><p><a href="http://ohmyz.sh/" title=" 点击访问 " target="_blank" rel="noopener">oh my zsh</a> is an open source, community-driven framework for managing your ZSH configuration. It comes bundled with a ton of helpful functions, helpers, plugins, themes, and a few things that make you shout…</p><ul><li>安装 oh my zsh 后默认 bash 改为 zsh，配置文件变为 <code>~/.zshrc</code>，通过 oh my zsh 可以很方便地安装主题、安装插件等。</li><li>zsh 的命令补全功能非常强大，可以补齐路径，补齐命令，补齐参数等。按下 <kbd>Tab</kbd> 键显示出所有待选项后，再按一次 <kbd>Tab</kbd> 键，即进入选择模式，进入选择模式后，按 <kbd>Tab</kbd> 切向下一个选项，按 <kbd>Shft</kbd> + <kbd>Tab</kbd> 键切向上一个选项，ctrl + f/b/n/p 可以向前后左右切换。</li><li>之前杀进程是 <code>ps aux | grep xxx</code> 查进程的 PID，然后 kill -9 PID。在 zsh 中直接 kill xxx 然后按下 <kbd>Tab</kbd> 键即可。也可以直接 kill + <kbd>Tab</kbd> 列出所有进程</li><li>建议加个主题再换个字体，设置一下颜色，逼格立马提高<br><img src="https://src.wangriyu.wang/images/blog/mac/terminal3.png" alt="image"><br><img src="https://src.wangriyu.wang/images/blog/mac/terminal7.png" alt="image"></li><li>推荐插件 zsh-syntax-highlighting(指令高亮效果作用是当用户输入正确命令时指令会绿色高亮，错误时命令红色高亮)、z、git 等等，查看官方插件地址 <a href="https://github.com/robbyrussell/oh-my-zsh/wiki/Plugins" target="_blank" rel="noopener">https://github.com/robbyrussell/oh-my-zsh/wiki/Plugins</a></li><li>zsh 的目录跳转更为智能，你无需输入 cd，直接输入路径即可。.. 表示后退一级目录，../../ 表示后退两级，依次类推。<br>输入 d，将列出当前 session 访问过的所有目录，再按提示的数字即可进入相应目录。</li><li>zsh 的历史记录跨 session，可以共享。历史记录支持受限查找。比如，输入 git，再按向上箭头，会搜索用过的所有 git 命令。</li><li>通配符搜索: <code>ls *.png</code> 查找当前目录下所有 png 文件，<code>ls **/*.png</code> 递归查找，作用与 <code>find . -name &quot;*.png&quot; -print</code> 一样</li><li>递归操作：<code>**/*</code> ，比如 <code>ls **/*</code></li></ul><h3 id="VIM-快捷鍵"><a href="#VIM-快捷鍵" class="headerlink" title="VIM 快捷鍵"></a>VIM 快捷鍵</h3><ol><li>按 <kbd>Esc</kbd> 进入普通模式:</li></ol><ul><li>k 将光标上移一行</li><li>j 将光标下移一行</li><li>h 将光标左移一个字母</li><li>l 将光标右移一个字母</li><li>w 将光标右移至下一个单词或符号的开头（字母和数字组成的词）</li><li>W 将光标右移至下一个单词或符号的开头（以空格分隔的词）</li><li>b 将光标左移至当前单词或符号的开头（字母和数字组成的词）</li><li>B 将光标左移至当前单词或符号的开头（以空格分隔的词）</li><li>e 将光标左移至当前单词或符号的结尾（字母和数字组成的词）</li><li>E 将光标左移至当前单词或符号的结尾（以空格分隔的词）</li></ul><blockquote><p>数字加 jkhlwb 可以移动多行或字母，比如 nk 上移 n 行</p></blockquote><ul><li>J 合并当前行和下一行 (也可以加数字操作多行)</li><li>H 将光标移至当前可视范围的第一行</li><li>L 将光标移至当前可视范围的最后一行</li><li>0 将光标移至该行行首</li><li>$ 将光标移至该行行尾</li><li>nG 将光标移至第 n 行</li><li>G 将光标移至文件的最后一行</li><li>gg 将光标移至文件的第一行</li><li>{ 将光标移至上一段</li><li>} 将光标移至下一段</li><li>[[ 将光标移至文件首行</li><li>]] 将光标移至文件尾行</li></ul><p><strong>删除:</strong></p><ul><li>dd 删除光标所在的整行内容 (可以加数字删除多行)</li><li>d$ 删除从光标所在位置直到行尾</li><li>d^ 删除从光标所在位置直到行首</li><li>d) 删除从光标所在位置直到句尾</li><li>d0 删除从光标所在位置直到行首</li><li>dw 删除从光标所在位置直到下一个词开始的所有内容</li><li>x 删除光标后一字符</li><li>X 删除光标前一字符</li><li>dgg 删至文件开头</li><li>dG 删至文件末尾</li></ul><p><strong>复制粘贴:</strong></p><ul><li>yy 复制当前行 (可以加数字复制多行)</li><li>p 在光标之后粘贴复制行</li><li>P 在光标之前粘贴复制行</li></ul><p><strong>替换:</strong></p><ul><li>r{text} 将光标处的字符替换成 {text}</li><li>R 进入覆写模式 (REPLACE)，输入的字符将替换原有的字符</li></ul><p><strong>撤销:</strong></p><ul><li>u 撤销一个操作 (可以加数字撤销多个操作)</li><li>Ctrl+r 恢复上一步被撤销的操作 (取消撤销)</li></ul><p><strong>搜索:</strong></p><ul><li>:/{search_text} 检索文档，搜索光标之后出现的 {search_text}</li><li>?{search_text} 检索文档，搜索光标之前出现的 {search_text}</li><li>n 向后移动检索结果</li><li>N 向前移动检索结果</li><li>:%s/original/replacement 检索第一个 “original” 字符串并将其替换成 “replacement”</li><li>:%s/original/replacement/g 检索并将所有的 “original” 替换为 “replacement”</li><li>:%s/original/replacement/gc 检索出所有的 “original” 字符串，但在替换成 “replacement” 前，先询问是否替换</li></ul><ol start="2"><li>从普通模式进入编辑模式 (INSERT):</li></ol><ul><li>i 在当前光标位置之前插入内容</li><li>I 在光标所在行的行首插入内容</li><li>a 在当前光标位置之后插入内容</li><li>A 在光标所在行的行尾插入内容</li><li>o 在当前光标所在行之后添加一行</li><li>O 在当前光标所在行之前添加一行</li></ul><ol start="3"><li>从普通模式进入视图模式 (VISUAL):</li></ol><ul><li>v 进入逐字可视模式</li><li>V 进入逐行可视模式</li></ul><p><strong>在视图模式中:</strong></p><ul><li>移动光标 (←↑↓→) 选中操作范围</li><li>~ 切换大小写</li><li>d 剪切选中字符</li><li>y 复制选中字符</li></ul><ol start="4"><li>窗口操作:</li></ol><ul><li>:split 水平方向分割出一个窗口</li><li>:split otherfile 新建窗口打开另一个文件</li><li>:sview filename 以只读的方式水平分割打开一个新窗口</li><li>:vsplit 垂直方向分割出一个窗口</li><li>:close 关闭窗口</li><li>ctrl + w + w 切换窗口</li></ul><ol start="5"><li>退出 vim</li></ol><ul><li>:q 退出 Vim，如果文件已被修改，将退出失败</li><li>:w 保存文件</li><li>:w new_name 用 new_name 作为文件名保存为新文件 (原文件仍在)</li><li>:wq 保存文件并退出 Vim</li><li>:q! 退出 Vim，不保存文件改动</li><li>ZZ 退出 Vim，如果文件被改动过，保存改动内容</li><li>ZQ 与 :q! 相同，退出 Vim，不保存文件改动</li></ul><p>在线演示 vim 操作: <a href="http://www.openvim.com/" target="_blank" rel="noopener">http://www.openvim.com/</a></p><h3 id="VIM-配置"><a href="#VIM-配置" class="headerlink" title="VIM 配置"></a>VIM 配置</h3><p>编辑 <code>~/.vimrc</code> 文件，添加相应项开启相应功能</p><pre class="line-numbers language-stylus"><code class="language-stylus">" 显示行号<span class="token property-declaration"><span class="token property">set</span> nu</span>" 语法高亮<span class="token property-declaration"><span class="token property">syntax</span> on</span>" 在状态行上显示光标所在位置的行号和列号<span class="token property-declaration"><span class="token property">set</span> ruler</span><span class="token property-declaration"><span class="token property">set</span> rulerformat<span class="token operator">=</span><span class="token operator">%</span><span class="token func"><span class="token function">20</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">2</span><span class="token operator">*</span><span class="token operator">%</span><span class="token operator">&lt;</span><span class="token operator">%</span>f<span class="token operator">%=</span>\ <span class="token operator">%</span>m<span class="token operator">%</span>r\ <span class="token operator">%</span><span class="token number">3</span>l\ <span class="token operator">%</span>c\ <span class="token operator">%</span>p<span class="token operator">%</span><span class="token operator">%</span><span class="token operator">%</span><span class="token punctuation">)</span></span></span>" 允许折叠<span class="token property-declaration"><span class="token property">set</span> foldenable</span>" 手动折叠<span class="token property-declaration"><span class="token property">set</span> foldmethod<span class="token operator">=</span>manual</span>" 命令行（在状态行下）的高度，默认为 1，这里是 2<span class="token property-declaration"><span class="token property">set</span> cmdheight<span class="token operator">=</span><span class="token number">2</span></span>" 使回格键（backspace）正常处理 indent, eol, start 等<span class="token property-declaration"><span class="token property">set</span> backspace<span class="token operator">=</span><span class="token number">2</span></span>" 通过使用<span class="token punctuation">:</span> commands 命令，告诉我们文件的哪一行被改变过<span class="token property-declaration"><span class="token property">set</span> report<span class="token operator">=</span><span class="token number">0</span></span>" 侦测文件类型<span class="token property-declaration"><span class="token property">filetype</span> on</span>" 载入文件类型插件<span class="token property-declaration"><span class="token property">filetype</span> plugin on</span>" 为特定文件类型载入相关缩进文件<span class="token property-declaration"><span class="token property">filetype</span> indent on</span>" 不让 vim 发出讨厌的滴滴声<span class="token property-declaration"><span class="token property">set</span> noerrorbells</span>" 高亮显示匹配的括号<span class="token property-declaration"><span class="token property">set</span> showmatch</span>" 在搜索的时候忽略大小写<span class="token property-declaration"><span class="token property">set</span> ignorecase</span>" 在搜索时，输入的词句的逐字符高亮（类似 firefox 的搜索）<span class="token property-declaration"><span class="token property">set</span> incsearch</span>" 继承前一行的缩进方式，特别适用于多行注释<span class="token property-declaration"><span class="token property">set</span> autoindent</span>" 制表符为 4<span class="token property-declaration"><span class="token property">set</span> tabstop<span class="token operator">=</span><span class="token number">4</span></span>" 统一缩进为 4<span class="token property-declaration"><span class="token property">set</span> softtabstop<span class="token operator">=</span><span class="token number">4</span></span><span class="token property-declaration"><span class="token property">set</span> shiftwidth<span class="token operator">=</span><span class="token number">4</span></span>" 不要换行<span class="token property-declaration"><span class="token property">set</span> nowrap</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>推荐一个很好的 vim 配置库: <a href="https://github.com/spf13/spf13-vim" target="_blank" rel="noopener">https://github.com/spf13/spf13-vim</a></p><h3 id="iTerm2"><a href="#iTerm2" class="headerlink" title="iTerm2"></a>iTerm2</h3><p><a href="http://www.iterm2.com/" title=" 点击访问 " target="_blank" rel="noopener">iTerm2</a> 是代替原本的 terminal 工具，支持更多操作，<a href="http://wulfric.me/2015/08/iterm2/" target="_blank" rel="noopener">设置教程</a></p><ul><li><p>主题配色可以去 <a href="http://iterm2colorschemes.com/" target="_blank" rel="noopener">iterm2colorschemes.com</a> 找，我用的是 <code>idleToes</code></p></li><li><p>快捷键：</p><ul><li><kbd>CMD</kbd> + Click：可以打开文件，文件夹和链接</li><li><kbd>CMD</kbd> + n：新建窗口</li><li><kbd>CMD</kbd> + t：新建标签页</li><li><kbd>CMD</kbd> + w：关闭当前页</li><li><kbd>CMD</kbd> + 数字 &amp; <kbd>CMD</kbd> + 方向键：切换标签页</li><li><kbd>Opt</kbd><kbd>CMD</kbd> + 数字：切换窗口</li><li><kbd>CMD</kbd> + <kbd>Enter</kbd>：切换全屏</li><li><kbd>CMD</kbd> + d：左右分屏</li><li><kbd>Shft</kbd><kbd>CMD</kbd> + d：上下分屏</li><li><kbd>CMD</kbd> + <kbd>;</kbd>：自动补全历史记录</li><li><kbd>Shft</kbd><kbd>CMD</kbd> + h：自动补全剪贴板历史</li><li><kbd>Opt</kbd><kbd>CMD</kbd> + e：查找所有来定位某个标签页</li><li><kbd>CMD</kbd> + r &amp; <kbd>Ctrl</kbd> + l：清屏 (等同于输入 <code>clear</code> 命令或 <kbd>CMD</kbd> + K)</li><li><kbd>CMD</kbd> + <kbd>/</kbd>：显示光标位置</li><li><kbd>Opt</kbd><kbd>CMD</kbd> + b：历史回放</li><li><kbd>CMD</kbd> + f：查找，然后用 <kbd>Tab</kbd> 和 <kbd>Shft</kbd> + <kbd>Tab</kbd> 可以向右和向左补全，补全之后的内容会被自动复制，还可以用 <kbd>Opt</kbd> + <kbd>Enter</kbd> 将查找结果输入终端选中即复制，鼠标中键粘贴</li></ul></li><li><p>命令行快捷键</p><ul><li><kbd>Ctrl</kbd> + u：清空当前行</li><li><kbd>Ctrl</kbd> + a：移动到行首</li><li><kbd>Ctrl</kbd> + e：移动到行尾</li><li><kbd>Ctrl</kbd> + r：搜索历史命令</li><li><kbd>Ctrl</kbd> + y：召回最近用命令删除的文字</li><li><kbd>Ctrl</kbd> + h：删除光标之前的字符</li><li><kbd>Ctrl</kbd> + d：删除光标所指的字符</li><li><kbd>Ctrl</kbd> + w：删除光标之前的单词</li><li><kbd>Ctrl</kbd> + k：删除从光标到行尾的内容</li><li><kbd>Ctrl</kbd> + t：交换光标和之前的字符</li></ul></li><li><p>iTerm2 参考设置<br><img src="https://src.wangriyu.wang/images/blog/mac/terminal4.png" alt="image"><br><img src="https://src.wangriyu.wang/images/blog/mac/terminal5.png" alt="image"><br><img src="https://src.wangriyu.wang/images/blog/mac/terminal6.png" alt="image"></p></li><li><p>关闭向上滚动到头时的提示音：<code>Preferences/Profiles/Terminal/Notifications</code> 选中 <code>Silence bell</code></p></li></ul><p><img src="https://src.wangriyu.wang/images/blog/mac/terminal1.png" alt="image"><br><img src="https://src.wangriyu.wang/images/blog/mac/terminal2.png" alt="image"></p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul><li><p>命令行设置大全：<a href="https://github.com/herrbischoff/awesome-osx-command-line" target="_blank" rel="noopener">https://github.com/herrbischoff/awesome-osx-command-line</a></p></li><li><p>允许安装任何来源的软件。从网上下载的安装包安装的应用一般是打不开的，macOS Sierra 之后的版本把“安全性与隐私”中的允许“任何来源”的选项去除了。<br>若要安装第三方软件需要恢复该选项：</p></li></ul><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> spctl --master-disable<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>替换 vi 为 vim</li></ul><pre class="line-numbers language-bash"><code class="language-bash">$ brew <span class="token function">install</span> vim --with-lua --with-override-system-vi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>更新 vim</p><pre class="line-numbers language-bash"><code class="language-bash">$ brew upgrade vim<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看 vim 版本</p><pre class="line-numbers language-bash"><code class="language-bash">$ brew info vim<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用还是 <code>vi</code> 加文件名</p><ul><li>txt 中文乱码</li></ul><p>打开系统文本编辑器 TextEditor 的设置界面，修改 <code>Plain Text File Encoding</code> 的 <code>Opening files</code> 选项，选择 <code>Chinese(GB 18030)</code><br><img src="https://src.wangriyu.wang/images/blog/mac/texteditor.png" alt="image"></p><ul><li>在 Dock 中显示最近打开的应用（Recent Applications）</li></ul><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token selector">defaults write com.apple.dock persistent-others -array-add '<span class="token punctuation">{</span></span><span class="token selector">"tile-data" = <span class="token punctuation">{</span></span><span class="token string">"list-type"</span> = 1<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token string">"tile-type"</span> = <span class="token string">"recents-tile"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>'<span class="token property-declaration"><span class="token property">killall</span> -KILL Dock</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>Launchpad 里放下更多图标</li></ul><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token property-declaration"><span class="token property">defaults</span> write com<span class="token operator">.</span>apple<span class="token operator">.</span>dock springboard-columns -int <span class="token number">8</span><span class="token punctuation">;</span> defaults write com<span class="token operator">.</span>apple<span class="token operator">.</span>dock springboard-rows -int <span class="token number">7</span><span class="token punctuation">;</span> defaults write com<span class="token operator">.</span>apple<span class="token operator">.</span>dock ResetLaunchPad -bool TRUE<span class="token punctuation">;</span> killall Dock</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>命令中有两个数字 8 和 7，它们分别代表的是布局中的列数和行数</p><ul><li>Launchpad 背景透明度</li></ul><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token property-declaration"><span class="token property">defaults</span> write com<span class="token operator">.</span>apple<span class="token operator">.</span>dock springboard-blur-radius -int <span class="token number">100</span><span class="token punctuation">;</span> killall Dock</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>其中数字 100 代表的背景模糊的程度，你可以在 0 ~ 255 的范围内选择</p><ul><li>homebrew 用法</li></ul><pre class="line-numbers language-bash"><code class="language-bash">// 支持搜索，提供多种结果，如果只是单个应用名，你可以用 <span class="token variable"><span class="token variable">`</span>brew <span class="token function">install</span> 命令行应用 <span class="token variable">`</span></span> 直接安装 <span class="token punctuation">(</span>一般是命令行工具<span class="token punctuation">)</span>// 名字前带着 cask 的代表 app 应用也就是平时使用的有图形化界面的应用，它们需要换个命令来安装 <span class="token variable"><span class="token variable">`</span>brew cask <span class="token function">install</span> GUI 应用 <span class="token variable">`</span></span>$ brew search 应用名（一般需英文名）// 查看是否由更新$ brew outdated// 更新所有，可以使用 <span class="token variable"><span class="token variable">`</span>brew upgrade 应用名 <span class="token variable">`</span></span> 更新单个应用$ brew upgrade// 更新完后删除旧版和缓存，<span class="token variable"><span class="token variable">`</span>brew cleanup -n<span class="token variable">`</span></span> 只查看有哪些条目但不删除，<span class="token variable"><span class="token variable">`</span>brew cleanup 应用名 <span class="token variable">`</span></span> 清除单应用$ brew cleanup// 访问应用官网，<span class="token variable"><span class="token variable">`</span>brew cask home sketch<span class="token variable">`</span></span> 访问 app 应用类的官网$ brew home 应用名<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>增强文件预览</li></ul><pre class="line-numbers language-bash"><code class="language-bash">$ brew cask <span class="token function">install</span> qlcolorcode qlstephen qlmarkdown quicklook-json qlimagesize webpquicklook suspicious-package quicklookase qlvideo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      <categories>
          
          <category> Mac </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分享 </tag>
            
            <tag> 技巧 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Dart 语法入门 I</title>
      <link href="/2017/10-Dart%20I.html"/>
      <url>/2017/10-Dart%20I.html</url>
      <content type="html"><![CDATA[<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// 定义一个方法</span><span class="token function">printNumber</span><span class="token punctuation">(</span>num aNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'The number is $aNumber.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 主函数</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> number <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>  <span class="token function">printNumber</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// The number is 42</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="重要概念-Important-concepts"><a href="#重要概念-Important-concepts" class="headerlink" title="重要概念 Important concepts"></a>重要概念 Important concepts</h2><ul><li>所有变量都可以看作对象 (object)，每个对象都是一个类的实例。<br>包括 numbers、function 和 null 都是对象。所有对象都继承自 Object 类。</li><li>指定静态类型（比如代码示例中的 num）表明你想指定的变量用途。（未指定具体类型的变量在 debug 时会发现被指定为一个特殊的类型：dynamic）<br>为确保代码类型安全，查看 <a href="https://www.dartlang.org/guides/language/sound-dart" target="_blank" rel="noopener">稳定模式 Dart</a></li><li>Dart 在运行前会解析所有代码。你可以先准备几点，比如使用类型和编译常量来捕获 errors 或者使代码运行更快。</li><li>Dart 支持顶层方法，比如 main()。也可以绑定在一个类或者对象上（分别为静态和实例方法）。也可以在方法中定义方法。</li><li>同理，Dart 也支持顶层变量，并且可以绑定到类或对象（静态和实例变量）。实例变量也称作字段或者属性。</li><li>不同于 Java，Dart 没有关键字 public、protected 和 private。如果一个标识符以下划线 _ 开头，则它的库使私有的。详见 <a href="https://www.dartlang.org/guides/language/language-tour#libraries-and-visibility" target="_blank" rel="noopener">库和可见性</a></li><li>标识符以字母和下划线 _ 开头，接着字母和数字的任意组合</li><li>Dart 工具可以报告两种问题：警告 Warnings 和错误 errors。</li><li>Dart 有两种运行模式：生产 (production) 和检查 (checked)。一般在检查模式开发和调试，最终部署到生产模式</li><li>Production mode 是 Dart 程序一个速度优化的默认运行模式。Production mode 忽略断言语句（assert statements）和静态类型</li><li>Checked mode 是开发人员友好的方式，可以帮助你在运行时捕捉一些类型的错误。例如，如果分配一个非数字来声明为一个 num 变量，然后在检查模式会抛出异常</li></ul><hr><h2 id="变量-Variables"><a href="#变量-Variables" class="headerlink" title="变量 Variables"></a>变量 Variables</h2><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'Voyager I'</span><span class="token punctuation">;</span><span class="token keyword">var</span> year <span class="token operator">=</span> <span class="token number">1977</span><span class="token punctuation">;</span><span class="token keyword">var</span> antennaDiameter <span class="token operator">=</span> <span class="token number">3.7</span><span class="token punctuation">;</span><span class="token keyword">var</span> flybyObjects <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Jupiter'</span><span class="token punctuation">,</span> <span class="token string">'Saturn'</span><span class="token punctuation">,</span> <span class="token string">'Uranus'</span><span class="token punctuation">,</span> <span class="token string">'Neptune'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> image <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token string">'tags'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'saturn'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token string">'url'</span><span class="token punctuation">:</span> '<span class="token comment" spellcheck="true">//path/to/saturn.jpg'</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a>默认值</h3><p>未初始化的变量值为 null，即使指定了数字类型也是 null，因为 numbers 也是对象。</p><pre class="line-numbers language-dart"><code class="language-dart">int lineCount<span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>lineCount <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Variables (even if they will be numbers) are initially null.</span><span class="token comment" spellcheck="true">// assert(condition) 方法只在检查模式下有用，表达式的值或者函数返回 true，则 assert 语句成功并继续执行代码。如果值为 false，则 assert 语句失败并抛出一个异常 (AssertionError)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="final-和-const"><a href="#final-和-const" class="headerlink" title="final 和 const"></a>final 和 const</h3><p>一个 final 变量只能设定一次且不能更改，一个 const 变量是编译时变量（const 变量是隐式 final 变量）。<br>一个 final 的顶层变量或者类变量，会在它第一次被调用时初始化。</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">final</span> name <span class="token operator">=</span> <span class="token string">'Bob'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Or: final String name = 'Bob';</span>name <span class="token operator">=</span> <span class="token string">'Alice'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Uncommenting this causes an error</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// [] 创建一个空数组，const [] 创建一个不可变空数组 (EIA)</span><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// foo 当前是 EIA</span><span class="token keyword">final</span> bar <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// bar 一直是 EIA</span><span class="token keyword">const</span> baz <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// baz 是编译时的 EIA</span><span class="token comment" spellcheck="true">// 可以改变非 final、const 定义的变量，即使它之前是赋的 const 值，比如 foo</span>foo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 但 bar、baz 不能更改</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="可选的静态类型"><a href="#可选的静态类型" class="headerlink" title="可选的静态类型"></a>可选的静态类型</h3><p>变量类型包括：numbers、strings、booleans、lists（也就是数组）、maps、runs、symbols。<br>每个变量类型有自定义的构造函数，比如 new Map() 创建一个 map 变量。</p><p><code>数字类型 numbers</code> 分 int（-2e53 ～ 2e53）和 double 型（IEEE 754 标准）, 支持 abs()、ceil() 等 <a href="https://api.dartlang.org/stable/dart-math/dart-math-library.html" target="_blank" rel="noopener">math 函数</a>。<br>int 型支持位运算，如&lt;&lt;、&gt;&gt;、&amp; 和 |</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// 类型转换</span><span class="token comment" spellcheck="true">// String -> int</span><span class="token keyword">var</span> one <span class="token operator">=</span> int<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>one <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// String -> double</span><span class="token keyword">var</span> onePointOne <span class="token operator">=</span> double<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'1.1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>onePointOne <span class="token operator">==</span> <span class="token number">1.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// int -> String</span>String oneAsString <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>oneAsString <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// double -> String</span>String piAsString <span class="token operator">=</span> <span class="token number">3.14159</span><span class="token punctuation">.</span><span class="token function">toStringAsFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>piAsString <span class="token operator">==</span> <span class="token string">'3.14'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="字符串类型-Strings"><a href="#字符串类型-Strings" class="headerlink" title="字符串类型 Strings"></a>字符串类型 Strings</h3><p>Strings 是 UTF-16 代码单元的序列，可以使用单引号或双引号创建一个字符串。</p><p>可以通过使用 ${expression} 把一个表达式的值放进字符串。如果表达式是一个标识符，你可以跳过{}。为了获得相应对象的字符串，Dart 调用对象的 toString（）方法。</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">'string interpolation'</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token string">'Dart has $s, which is very handy.'</span> <span class="token operator">==</span>       <span class="token string">'Dart has string interpolation, '</span> <span class="token operator">+</span>       <span class="token string">'which is very handy.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span><span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token string">'That deserves all caps. '</span> <span class="token operator">+</span>       <span class="token string">'${s.toUpperCase()} is very handy!'</span> <span class="token operator">==</span>       <span class="token string">'That deserves all caps. '</span> <span class="token operator">+</span>       <span class="token string">'STRING INTERPOLATION is very handy!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以利用相邻字符串或 + 运算符连接字符串：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> s1 <span class="token operator">=</span> <span class="token string">'String '</span> <span class="token string">'concatenation'</span>         <span class="token string">" works even over line breaks."</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> <span class="token string">'String concatenation works even over '</span>             <span class="token string">'line breaks.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span><span class="token keyword">var</span> s2 <span class="token operator">=</span> <span class="token string">'The + operator '</span>         <span class="token operator">+</span> <span class="token string">'works, as well.'</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>s2 <span class="token operator">==</span> <span class="token string">'The + operator works, as well.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用三个单或双引号创建一个多行字符串</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> s1 <span class="token operator">=</span> <span class="token string">'''You can createmulti-line strings like this one.'''</span><span class="token punctuation">;</span><span class="token keyword">var</span> s2 <span class="token operator">=</span> <span class="token string">"""This is also a multi-line string."""</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>带有 r 的前缀来创建一个“raw”的字符串</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">r"In a raw string, even \n isn't special."</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>支持 Unicode 转义</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Unicode escapes work: \u2665'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="布尔类型-booleans"><a href="#布尔类型-booleans" class="headerlink" title="布尔类型 booleans"></a>布尔类型 booleans</h3><p>不同于 javaScript，1、“aString”、someObject 都视为假的</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'Bob'</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// JavaScript 中会产生打印，而 Dart 中不会</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'in javaScript, You have a name!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'but in Dart, print this line'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 在 Dart 生产模式下，上述条件为假；而在检查模式下，程序会抛出一个异常，因为 name 类型不是 bool</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'JS prints this line.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Dart in production mode prints this line.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 但在 checked 模式下会抛出一个异常，因为 1 不是一个 boolean</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Dart 的判断条件应该指定为布尔类型，不能使用 if（nonbooleanValue），这个在检查模式下会抛出异常</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// 检查一个空字符串.</span><span class="token keyword">var</span> fullName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>fullName<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 检查为零.</span><span class="token keyword">var</span> hitPoints <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>hitPoints <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 检查是否为空.</span><span class="token keyword">var</span> unicorn<span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>unicorn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 检查 NaN.</span><span class="token keyword">var</span> iMeantToDoThis <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>iMeantToDoThis<span class="token punctuation">.</span>isNaN<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="列表类型-List"><a href="#列表类型-List" class="headerlink" title="列表类型 List"></a>列表类型 List</h3><p>在 Dart，数组是列表对象，所以我们通常只是将其称为 lists。<br>常见用法与 javaScript 类似：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> fruits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'apples'</span><span class="token punctuation">,</span> <span class="token string">'oranges'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 也可以用构造函数 new List('apples', 'oranges')</span><span class="token comment" spellcheck="true">// 如果指定类型, new List&lt;String>('apples') 或者&lt;String>['apples'] 则只能存放字符类型, 否则在检查模式下加入非指定类型元素会抛出异常</span>fruits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'kiwis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 添加元素</span>fruits<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'grapes'</span><span class="token punctuation">,</span> <span class="token string">'bananas'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 添加多个元素</span><span class="token keyword">assert</span><span class="token punctuation">(</span>fruits<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 获取长度</span>fruits<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'I have some $item'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// forEach((key, value) => {}) 可以传两个参数</span>fruits<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'I have some $item'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>fruits<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> item <span class="token operator">==</span><span class="token operator">=</span> <span class="token string">'oranges'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// where() 筛选符合条件的元素</span><span class="token comment" spellcheck="true">// 删除一个元素</span><span class="token keyword">var</span> appleIndex <span class="token operator">=</span> fruits<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'apples'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fruits<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span>appleIndex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>fruits<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 清空列表</span>fruits<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>fruits<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>更多用法详见 <a href="https://www.dartlang.org/guides/language/language-tour#generics" target="_blank" rel="noopener">泛型 Generics</a> 和 <a href="https://www.dartlang.org/docs/dart-up-and-running/ch03.html#collections" target="_blank" rel="noopener">集合 Collections</a>。</p><h3 id="Maps-类型"><a href="#Maps-类型" class="headerlink" title="Maps 类型"></a>Maps 类型</h3><p>一般情况下，map 是一个键值对组成的对象，这两个键和值可以是任何类型的对象。</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">var</span> gifts <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token string">'first'</span> <span class="token punctuation">:</span> <span class="token string">'partridge'</span><span class="token punctuation">,</span>  <span class="token string">'second'</span><span class="token punctuation">:</span> <span class="token string">'turtledoves'</span><span class="token punctuation">,</span>  <span class="token string">'fifth'</span> <span class="token punctuation">:</span> <span class="token string">'golden rings'</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> nobleGases <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token number">2</span> <span class="token punctuation">:</span>   <span class="token string">'helium'</span><span class="token punctuation">,</span>  <span class="token number">10</span><span class="token punctuation">:</span>   <span class="token string">'neon'</span><span class="token punctuation">,</span>  <span class="token number">18</span><span class="token punctuation">:</span>   <span class="token string">'argon'</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* ----- 也可以使用构函数 ----- */</span><span class="token keyword">var</span> gifts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>gifts<span class="token punctuation">[</span><span class="token string">'first'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'partridge'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 直接添加键值对</span>gifts<span class="token punctuation">[</span><span class="token string">'second'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'turtledoves'</span><span class="token punctuation">;</span>gifts<span class="token punctuation">[</span><span class="token string">'fifth'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'golden rings'</span><span class="token punctuation">;</span><span class="token keyword">var</span> nobleGases <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>nobleGases<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'helium'</span><span class="token punctuation">;</span>nobleGases<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'neon'</span><span class="token punctuation">;</span>nobleGases<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'argon'</span><span class="token punctuation">;</span><span class="token keyword">assert</span><span class="token punctuation">(</span>nobleGases<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// length 返回 map 中键值对的数目</span><span class="token comment" spellcheck="true">// 创建一个编译时常量</span><span class="token keyword">final</span> constantMap <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>  <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">'helium'</span><span class="token punctuation">,</span>  <span class="token number">10</span><span class="token punctuation">:</span> <span class="token string">'neon'</span><span class="token punctuation">,</span>  <span class="token number">18</span><span class="token punctuation">:</span> <span class="token string">'argon'</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span>constantMap<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Helium'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 会报错，因为不可更改</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Runes-符号类型"><a href="#Runes-符号类型" class="headerlink" title="Runes 符号类型"></a>Runes 符号类型</h3><p>在 Dart 中，runes 是字符串的 UTF-32 点。Unicode 给每个字符定义了一个值。因为 Dart 中的字符串是 UTF-16 单元的序列，所以表达 32 位 Unicode 值需要特定的语法来实现。<br>通常一个 Unicode 码的形式是 /uXXXX，XXXX 是 4 位 16 进制的值，比如 \u2665 代表 ♥ 这个符号，当指定多于或少于 4 位的 16 进制时用{}包裹，比如 \u{1f600}代表 😆 这个符号。<br>字符串的属性方法中 codeUnitAt 和 codeUnit 返回 16 位代码单元，runes 属性方法用于获取 String 类型的 runes 值：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> clapping <span class="token operator">=</span> <span class="token string">'\u{1f44f}'</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>clapping<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>clapping<span class="token punctuation">.</span>codeUnits<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>clapping<span class="token punctuation">.</span>runes<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  Runes input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runes</span><span class="token punctuation">(</span>      <span class="token string">'\u2665  \u{1f605}  \u{1f60e}  \u{1f47b}  \u{1f596}  \u{1f44d}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String<span class="token punctuation">.</span>fromCharCodes</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 输出结果</span>👏<span class="token punctuation">[</span><span class="token number">55357</span><span class="token punctuation">,</span> <span class="token number">56399</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">128079</span><span class="token punctuation">]</span>♥  😅  😎  👻  🖖  👍<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="符号类型-symbols"><a href="#符号类型-symbols" class="headerlink" title="符号类型 symbols"></a>符号类型 symbols</h3><p>一个符号对象表示在 Dart 程序中声明的操作符或标识。你可能不会需要使用这些符号，但他们对于由名字指向的 API 是很有用的，因为时常要改变的是标识符的名字，而不是标识符的符号。</p><p>为了得到符号的标识，使用符号的文本，只是＃后跟标识符：</p><pre class="line-numbers language-dart"><code class="language-dart">#radix#bar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>更多详细信息见 <a href="https://www.dartlang.org/docs/dart-up-and-running/ch03.html#dartmirrors---reflection" target="_blank" rel="noopener">Dart: mirrors—reflection</a></p>]]></content>
      
      <categories>
          
          <category> Dart </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dart </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>分享自用的一些软件、插件、网站和应用</title>
      <link href="/2017/09-ShareArtifact.html"/>
      <url>/2017/09-ShareArtifact.html</url>
      <content type="html"><![CDATA[<blockquote><p>这些只是收录我现在用到的东西，没有特意收集的意思，未必很全，但每个应该都很实用<br><a href="https://github.com/wangriyu/Collections" title=" 点击访问 " target="_blank" rel="noopener">Github 仓库</a></p></blockquote><h2 id="插件篇"><a href="#插件篇" class="headerlink" title="插件篇"></a>插件篇</h2><h3 id="Chrome-插件"><a href="#Chrome-插件" class="headerlink" title="Chrome 插件"></a>Chrome 插件</h3><ul><li><p>Adblock Plus: 屏蔽广告，必备，不用介绍</p></li><li><p><a href="https://chrome.google.com/webstore/detail/code-cola/lomkpheldlbkkfiifcbfifipaofnmnkn" title=" 点击访问 " target="_blank" rel="noopener">Code Cola</a>：一个可视化编辑在线页面 css 样式的 chrome 插件，相当于控制台修改的效果，但方便很多</p></li><li><p><a href="https://chrome.google.com/webstore/detail/full-page-screen-capture/fdpohaocaechififmbbbbbknoalclacl" title=" 点击访问 " target="_blank" rel="noopener">Full Page Screen Capture</a>：可以滚动截取整个网页</p></li><li><p><a href="https://chrome.google.com/webstore/detail/%E5%88%92%E8%AF%8D%E7%BF%BB%E8%AF%91/ikhdkkncnoglghljlkmcimlnlhkeamad" target="_blank" rel="noopener">划词翻译</a>：划词翻译，支持谷歌、百度、有道翻译</p></li><li><p>★★<a href="http://ksria.com/simpread/" target="_blank" rel="noopener">简阅</a>：巨好用的插件，相当于添加了阅读模式，界面很漂亮，设置很全，功能也挺完整</p></li><li><p><a href="https://chrome.google.com/webstore/detail/page-ruler/jlpkojjdgbllmedoapgfodplfhcbnbpn" title=" 点击访问 " target="_blank" rel="noopener">Page Ruler</a>：网页标尺，可以方便测量各个元素的尺寸</p></li><li><p>★<a href="http://chrispederick.com/work/web-developer/" title=" 点击访问 " target="_blank" rel="noopener">Web Developer</a>：前端必备，功能强大，可以设置网页上几乎所有东西</p></li><li><p>★★<a href="https://chrome.google.com/webstore/detail/web%E5%89%8D%E7%AB%AF%E5%8A%A9%E6%89%8Bfehelper/pkgccpejnmalmdinmhkkfafefagiiiad?utm_source=chrome-ntp-icon" title=" 点击访问 " target="_blank" rel="noopener">WEB 前端助手 (FeHelper)</a>：也是前端必备，包括 json 美化、页面测试、编解码、代码美化压缩等等</p></li><li><p>★有道云笔记网页剪报：配合有道云笔记，方便收藏各种笔记、网页</p></li><li><p><a href="https://chrome.google.com/webstore/detail/wide-github/kaalofacklcidaampbokdplbklpeldpj" title=" 点击访问 " target="_blank" rel="noopener">Wide Github</a>：加宽 GitHub 的页面内容，让你的 GitHub 网页显示更舒服</p></li><li><p><a href="https://chrome.google.com/webstore/detail/sourcegraph-for-github/dgjhfomjieaadpoljlnidmbgkdffpack" title=" 点击访问 " target="_blank" rel="noopener">Sourcegraph for GitHub</a>：相当于一个 IDE，直接查看 GitHub 上的仓库</p></li><li><p><a href="https://chrome.google.com/webstore/detail/octotree/bkhaagjahfmjljalopjnoealnfndnagc?hl=en-US" title=" 点击访问 " target="_blank" rel="noopener">Octotree</a>：GitHub 插件，极力推荐，在仓库左上角显示目录，直接点击文件跳转，不用一级级打开网页上的 repo</p></li><li><p>★★<a href="https://chrome.google.com/webstore/detail/insightio-for-github/pmhfgjjhhomfplgmbalncpcohgeijonh" title=" 点击访问 " target="_blank" rel="noopener">Insight.io for Github</a>：功能和 Octotree 类似，比 Octotree 略微高级点</p></li><li><p>★<a href="https://chrome.google.com/webstore/detail/isometric-contributions/mjoedlfflcchnleknnceiplgaeoegien" title=" 点击访问 " target="_blank" rel="noopener">Isometric Contributions</a>：装逼利器，让 GitHub profile 页的提交记录立体化，跟 gitee 的效果差不多</p></li><li><p>★★<a href="https://chrome.google.com/webstore/detail/github-plus/anlikcnbgdeidpacdbdljnabclhahhmd" title=" 点击访问 " target="_blank" rel="noopener">GitHub Plus</a>：极力推荐，显示仓库、文件大小，并提供单文件的下载</p></li><li><p><a href="http://listen1.github.io/listen1" title=" 点击访问 " target="_blank" rel="noopener">Lisen1</a>：很棒的一个音乐插件，还有客户端版本</p></li><li><p>★<a href="https://muz.li/" title=" 点击访问 " target="_blank" rel="noopener">Muzli</a>：集合了很多网站的最新更新，一站式阅读新闻和资讯，适合设计者和开发者</p></li><li><p><a href="https://chrome.google.com/webstore/detail/feedly/hipbfijinpcgfogaopmgehiegacbhmob?utm_source=chrome-ntp-icon" title=" 点击访问 " target="_blank" rel="noopener">feedly</a>：一个 webapp，可以收藏网址，主要用于 RSS 和博客订阅</p></li><li><p><a href="https://userstyles.org/" title=" 点击访问 " target="_blank" rel="noopener">stylish</a>：可以自定义浏览器主题样式，也可以安装别人的</p></li><li><p>★<a href="https://chrome.google.com/webstore/detail/addtoany-share-anywhere/ffpgijchhhkhnokafdeklpllijgnbche" title=" 点击访问 " target="_blank" rel="noopener">AddToAny: Share Anywhere</a>：一个分享插件</p></li><li><p><a href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo" target="_blank" rel="noopener">Tampermonkey</a>：油猴脚本，各个浏览器都有，加上脚本就是神器了，脚本可以到 <a href="https://greasyfork.org/zh-CN" target="_blank" rel="noopener">GreasyFork</a> 找</p></li><li><p><a href="http://www.chengyinliu.com/whatfont.html" target="_blank" rel="noopener">WhatFont</a>: 可以找出网站上每处使用的字体</p></li><li><p><a href="https://chrome.google.com/webstore/detail/pesticide-for-chrome/bblbgcheenepgnnajgfpiicnbbdmmooh" target="_blank" rel="noopener">Pesticide</a>: 标记所有元素的边框</p></li><li><p><a href="https://chrome.google.com/webstore/detail/css-peeper/mbnbehikldjhnfehhnaidhjhoofhpehk" target="_blank" rel="noopener">CSS Peeper</a>: 可以分析出网站使用的字体、颜色方案、图片</p></li></ul><h3 id="Terminal-插件"><a href="#Terminal-插件" class="headerlink" title="Terminal 插件"></a>Terminal 插件</h3><p>Terminal 插件和 vim 插件没怎么试过. 感兴趣的可以到这个网站看看：<a href="https://vimawesome.com/" target="_blank" rel="noopener">Vim Awesome</a></p><p>这里有几个我用过的:</p><ul><li><p>★★<a href="http://ohmyz.sh/" target="_blank" rel="noopener">Oh My ZSH</a>：方便个性化配置你的 zsh<br>加个 ys 主题，换个字体，再加个背景图片，逼格立马上升了:<br><img src="https://src.wangriyu.wang/images/blog/mac/terminal1.png" alt="image"></p></li><li><p><a href="https://github.com/johngrib/vim-game-code-break" title=" 点击访问 " target="_blank" rel="noopener">VimGameCodeBreak</a>：打开一个文本，开始一盘打方块游戏吧，注意需要 vim8.0</p></li><li><p><a href="https://github.com/aksakalli/gtop" title=" 点击访问 " target="_blank" rel="noopener">gtop</a>：在终端显示电脑 cpu、内存、进程信息</p></li><li><p><a href="https://github.com/hishamhm/htop" target="_blank" rel="noopener">htop</a>：better top</p></li><li><p><a href="https://github.com/nicolargo/glances" target="_blank" rel="noopener">glances</a>: Glances an Eye on your system. A top/htop alternative. <a href="http://nicolargo.github.io/glances/" target="_blank" rel="noopener">http://nicolargo.github.io/glances/</a></p></li><li><p><a href="https://github.com/jakubroztocil/httpie" target="_blank" rel="noopener">httpie</a>: 测试 http</p></li><li><p><a href="https://github.com/dbcli/mycli" target="_blank" rel="noopener">mycli</a>: A Terminal Client for MySQL with AutoCompletion and Syntax Highlighting</p></li><li><p><a href="https://github.com/jeffkaufman/icdiff" target="_blank" rel="noopener">icdiff</a>: improved colored diff <a href="http://www.jefftk.com/icdiff" target="_blank" rel="noopener">http://www.jefftk.com/icdiff</a></p></li></ul><h3 id="VS-Code-插件"><a href="#VS-Code-插件" class="headerlink" title="VS Code 插件"></a>VS Code 插件</h3><p>更多 vsc 插件可以到官方市场搜索 <a href="https://marketplace.visualstudio.com/search?target=VSCode&amp;category=All%20categories&amp;sortBy=Downloads" target="_blank" rel="noopener">https://marketplace.visualstudio.com/search?target=VSCode&amp;category=All%20categories&amp;sortBy=Downloads</a></p><ul><li><p><a href="https://marketplace.visualstudio.com/items?itemName=RoscoP.ActiveFileInStatusBar" target="_blank" rel="noopener">Active File In Status Bar</a>：在底部显示文档绝对路径</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=formulahendry.auto-close-tag" target="_blank" rel="noopener">Auto Close Tag</a>：自动补全关闭的标签，比如</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=formulahendry.auto-rename-tag" target="_blank" rel="noopener">Auto Rename Tag</a>：当你修改标签头时，同时修改标签尾</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=CoenraadS.bracket-pair-colorizer" target="_blank" rel="noopener">Bracket Pair Colorizer</a>：给各个括号添加颜色</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=msjsdiag.debugger-for-chrome" target="_blank" rel="noopener">Debugger for Chrome</a>：在 Google Chrome 浏览器调试 JavaScript 代码</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint" target="_blank" rel="noopener">ESLint</a>：代码检查工具</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=christian-kohler.npm-intellisense" target="_blank" rel="noopener">npm Intellisense</a>：在 import 导入语句中自动完成 npm 模块</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=mkxml.vscode-filesize" target="_blank" rel="noopener">filesize</a>：显示文件大小</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=PKief.material-icon-theme" target="_blank" rel="noopener">Material Icon Theme</a>：提供 MD 风格的文档图标</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=christian-kohler.path-intellisense" target="_blank" rel="noopener">Path Intellisense</a>：路径自动补全</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=searKing.preview-vscode" target="_blank" rel="noopener">Preview</a>：提供 Markdown, ReStructured Text, HTML, Jade, Pug, Mermaid files, Image’s URI or CSS properties 的预览，MAC 快捷键:cmd+shift+v</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=DoubleWoodH.word-count" target="_blank" rel="noopener">Word Count</a>：字数统计，同事写的</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=bibhasdn.git-easy" target="_blank" rel="noopener">Git Easy</a>：让 git 更方便</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=xabikos.JavaScriptSnippets" target="_blank" rel="noopener">JavaScript (ES6) code snippets</a>：代码片段插件，支持 js 和 ts，比如输入 imp 生成 import fs from ‘fs’;</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=joelday.docthis" target="_blank" rel="noopener">Document This</a>：自动给 js 代码添加注释</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode" target="_blank" rel="noopener">Prettier</a>：格式化 js 代码，快捷键 <code>cmd + shift + p</code> 输入 Format Document 或 Format Selection(先选中要格式化的文本)</p></li><li><p><a href="https://marketplace.visualstudio.com/items?itemName=pnp.polacode" target="_blank" rel="noopener">Polacode</a>: 生成漂亮的代码图片</p></li></ul><p>Settings:</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"workbench.iconTheme"</span><span class="token operator">:</span> <span class="token string">"material-icon-theme"</span><span class="token punctuation">,</span>    <span class="token property">"workbench.colorTheme"</span><span class="token operator">:</span> <span class="token string">"Quiet Light"</span><span class="token punctuation">,</span>    <span class="token property">"editor.fontSize"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>    <span class="token property">"editor.tabSize"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token property">"editor.renderWhitespace"</span><span class="token operator">:</span> <span class="token string">"boundary"</span><span class="token punctuation">,</span>    <span class="token property">"git.enabled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token property">"files.autoSave"</span><span class="token operator">:</span> <span class="token string">"onFocusChange"</span><span class="token punctuation">,</span>    <span class="token property">"licenseheader.Author"</span><span class="token operator">:</span> <span class="token string">"Wang RiYu"</span><span class="token punctuation">,</span>    <span class="token property">"licenseheader.CopiedBy"</span><span class="token operator">:</span> <span class="token string">"Copyright (c) 2018 SmartestEE Co,Ltd.."</span><span class="token punctuation">,</span>    <span class="token property">"extensions.ignoreRecommendations"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"material-icon-theme.showUpdateMessage"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="IDE-插件"><a href="#IDE-插件" class="headerlink" title="IDE 插件"></a>IDE 插件</h3><p>分享两个 JetBrains 的插件，无意间看到的</p><ul><li><p><a href="https://plugins.jetbrains.com/plugin/8502-background-image-plus" target="_blank" rel="noopener">Background Image Plus</a>: 设置背景图片的，效果如下<br><img src="https://src.wangriyu.wang/images/blog/artifact/background1.png" alt="image"><br><img src="https://src.wangriyu.wang/images/blog/artifact/background2.png" alt="image"></p></li><li><p><a href="https://plugins.jetbrains.com/plugin/8330-activate-power-mode" target="_blank" rel="noopener">activate-power-mode</a>: 这原本是 Atom 的插件，移植过来的，效果还行吧，但是这东西华而不实，如果影响打字还是去掉得好。还有如果安装后发现没有效果，记得把 combo 那个选项去掉，因为默认要连击多少下才会出效果</p></li><li><p><a href="">carbon-now-sh</a>: 选中代码，右键 Open in carbon.now.sh，会打开 <a href="https://carbon.now.sh" target="_blank" rel="noopener">https://carbon.now.sh</a> ，可以生成一张图片</p></li></ul><hr><h2 id="软件篇"><a href="#软件篇" class="headerlink" title="软件篇"></a>软件篇</h2><ul><li><p>★<a href="https://pdfexpert.com/" title=" 点击访问 " target="_blank" rel="noopener">PDF Expert</a>：mac 上最好用最强大的 pdf 软件，如果资金有限不想购买的客官可以看下 <a href="http://xclient.info/s/pdf-expert-for-mac.html?_=f7d710b8833dbc76de5d7640956a0551" title=" 点击访问 " target="_blank" rel="noopener">Xclient.info</a></p></li><li><p>★★<a href="https://typora.io/" title=" 点击访问 " target="_blank" rel="noopener">Typora</a>：方便快速地编写 MarkDown，界面简单，实用高效</p></li><li><p>★<a href="https://itunes.apple.com/cn/app/networker-%E6%98%BE%E7%A4%BA%E7%BD%91%E7%BB%9C%E4%BF%A1%E6%81%AF/id1163602886?mt=12" title=" 点击访问 " target="_blank" rel="noopener">NetWorker</a>：状态栏显示网速，简单美观</p></li><li><p>★<a href="https://itunes.apple.com/us/app/istatistica/id1025822138?mt=12" title=" 点击访问 " target="_blank" rel="noopener">iStatistica</a>：一款颜值颇高的系统监控软件，它包括通知中心小部件和状态栏菜单<br><img src="https://src.wangriyu.wang/images/blog/artifact/iStatistica.png" alt="image"></p></li><li><p>★<a href="https://sipapp.io/" title=" 点击访问 " target="_blank" rel="noopener">Sip</a>：很好用的取色工具，需要购买，如果资金有限不想购买的客官可以看下 <a href="http://xclient.info/s/sip.html?_=f7d710b8833dbc76de5d7640956a0551" title=" 点击访问 " target="_blank" rel="noopener">Xclient.info</a></p></li><li><p>★★<a href="https://justgetflux.com/" target="_blank" rel="noopener">F.lux</a>：一款根据时间调整屏幕色温的软件，适合长期用眼的人，推荐程序员使用</p></li><li><p>★★<a href="http://faststone.org/FSCaptureDetail.htm" title=" 点击访问 " target="_blank" rel="noopener">FastStone Capture</a>：Windows 上一款非常强大的集取色截屏录屏于一身的软件，而且支持滚动截屏，可惜 mac 上没有</p></li><li><p>★★<a href="https://note.youdao.com/" title=" 点击访问 " target="_blank" rel="noopener">有道云笔记</a>：收藏编写笔记很方便，配合浏览器插件可以收藏网页，关注官方公众号还可以把微信文章也收藏进去，我的所有收藏和笔记都可以放进去，而且多端同步随时可以看，手机版还可以写 markdown</p></li><li><p><a href="http://snip.qq.com/" title=" 点击访问 " target="_blank" rel="noopener">Snip</a>：之前找 mac 上支持滚动截屏的软件，但没找到很好的能代替 Windows 平台利器 FastStone 的，这个 Snip 勉强符合滚动截屏的要求</p></li><li><p>★<a href="http://jietu.qq.com" title=" 点击访问 " target="_blank" rel="noopener">Jietu</a>：和 snip 一样同出于鹅厂，也有滚动截屏，功能多一点，可以代替 snip</p></li><li><p>★<a href="https://itunes.apple.com/app/id992076693?mt=12&amp;ign-mpt=uo%3D4" title=" 点击访问 " target="_blank" rel="noopener">MindNode</a>：很漂亮的一款思维导图，如果资金有限不想购买的客官可以看下 <a href="http://xclient.info/s/mind-node-pro.html?_=f7d710b8833dbc76de5d7640956a0551" title=" 点击访问 " target="_blank" rel="noopener">Xclient.info</a></p></li><li><p><a href="https://itunes.apple.com/cn/app/expressions/id913158085?l=en&amp;mt=12" title=" 点击访问 " target="_blank" rel="noopener">Expressions</a>：一款 macOS 平台的强大的正则表达式工具，测试正则表达式，多种主题，选中高亮等。如果资金有限不想购买的客官可以看下 <a href="http://xclient.info/s/expressions.html?_=f7d710b8833dbc76de5d7640956a0551" title=" 点击访问 " target="_blank" rel="noopener">Xclient.info</a></p></li><li><p><a href="https://cleanmymac.com/" title=" 点击访问 " target="_blank" rel="noopener">CleanMyMac3</a>：清理 mac 垃圾的软件，颜值比较高</p></li><li><p><a href="https://www.omnigroup.com/more" target="_blank" rel="noopener">OmniDiskSweeper</a>：能快速扫描磁盘并找出占用空间大的文档或文件</p></li><li><p><a href="https://freemacsoft.net/appcleaner/" target="_blank" rel="noopener">AppCleaner</a>：可以完全卸载软件</p></li><li><p><a href="https://webtorrent.io/desktop/" title=" 点击访问 " target="_blank" rel="noopener">WebTorrent</a>：直接看磁链里的内容，无需等待下载</p></li><li><p><a href="https://framer.com/features/" title=" 点击访问 " target="_blank" rel="noopener">Framer</a>：一个设计开发用的</p></li><li><p><a href="http://tumult.com/hype/pro/" title=" 点击访问 " target="_blank" rel="noopener">Tumult</a>：也是一个设计工具，还没用过</p></li><li><p>★<a href="http://xclient.info/s/new-file-menu.html?_=8f2ea7453a409bd6674c05d22079f675" title=" 点击访问 " target="_blank" rel="noopener">New File Menu</a>：finder 扩展，右键新建文件，还可以自定义文件模板</p></li><li><p>★★<a href="https://www.freedownloadmanager.org/" title=" 点击访问 " target="_blank" rel="noopener">FDM</a>：全称 free download manager，相当于免费的 idm，而且支持 mac 平台，支持下载 youtubu 视频，支持 url 或者 torrent，我还试了下 mac 平台另一款网上推荐的下载工具 folx，但 folx 速度好像比不上 fdm</p></li><li><p>★<a href="http://www.eigenlogik.com/entropy/" title=" 点击访问 " target="_blank" rel="noopener">Entropy</a>：很强大的解压缩软件，支持多种格式，操作便捷，但收费，如果资金有限不想购买的客官可以看下 <a href="http://xclient.info/s/entropy.html?_=38c50d7151e1cd2d16ca86daef7039c2" target="_blank" rel="noopener">xclient.info</a></p></li><li><p>★<a href="https://itunes.apple.com/cn/app/leaf-rss-news-reader/id576338668?l=en&amp;mt=12" target="_blank" rel="noopener">Leaf</a>：RSS News Reader, 订阅 RSS 源后，可以一站式阅读，之前不知道 rss 这东西，傻傻地一个个打开别人博客看文章<br>我收藏的 RSS 源: <a href="https://mega.nz/#!lW4BgLKQ!hDcw-jH3MDbjMHo8G_0phrRPaVXVSZP5ZbbtP61mR-w" target="_blank" rel="noopener">Leaf Subscriptions.xml - MEGA</a></p></li><li><p><a href="https://bootstrapstudio.io/" title=" 点击访问 " target="_blank" rel="noopener">Bootstrap Studio</a>：这个软件可牛逼了，建议看下官网的介绍视频，这个软件可以让你以直接拖动组件的方式完成一个网页，感觉跟 C#类似，用来做基础布局可以节约大量时间</p></li><li><p>★<a href="https://zhitu.isux.us/" title=" 点击访问 " target="_blank" rel="noopener">智图</a>：图片压缩，方便快捷</p></li><li><p><a href="https://github.com/yinghuocho/firefly-proxy" title=" 点击访问 " target="_blank" rel="noopener">萤火虫 Firefly</a>：一款翻墙软件，电脑手机都有</p></li><li><p><a href="https://github.com/getlantern/lantern" title=" 点击访问 " target="_blank" rel="noopener">蓝灯</a>：蓝灯 VPN，速度挺快的，如果下载发行版的话有流量限制，建议去 GitHub 上照步骤自己编译程序，这样是没有流量限制的</p></li><li><p><a href="https://www.tunnelbear.com/" title=" 点击访问 " target="_blank" rel="noopener">ThunnelBear</a>：ThunnelBear VPN，速度还行，分享推特后每月有 1GB 流量</p></li><li><p><a href="https://github.com/XX-net/XX-Net" title=" 点击访问 " target="_blank" rel="noopener">XX-Net</a>：很好用的翻墙工具，但配置会麻烦一点</p></li><li><p><a href="http://www.smartisan.com/apps/handshaker" title=" 点击访问 " target="_blank" rel="noopener">HandShaker</a>：锤子科技出的一款软件，可以无线连接手机和电脑，方便在电脑上管理移动设备的文件，如果要互传可以使用茄子快传</p></li><li><p>★★<a href="https://kapeli.com/dash" title=" 点击访问 " target="_blank" rel="noopener">Dash</a>：开发者必备，各种 API 文档，配合 Alfred 查询非常方便，如果资金有限不想购买的客官可以看下 <a href="http://xclient.info/s/dash.html?_=f7d710b8833dbc76de5d7640956a0551" title=" 点击访问 " target="_blank" rel="noopener">Xclient.info</a></p></li><li><p><a href="http://xscopeapp.com" title=" 点击访问 " target="_blank" rel="noopener">xScope</a>：设计开发辅助工具，有 10 个实用优秀的小工具，如屏幕镜像、屏幕标尺、放大镜、十字定位等等</p></li><li><p>★★<a href="https://itunes.apple.com/cn/app/ohmystar2-best-way-to-organize-your-github-stars/id1218642292?l=en&amp;mt=12" title=" 点击访问 " target="_blank" rel="noopener">ohMyStar2</a>：强烈推荐的一个软件，可以管理 GitHub 账号的 star，分类管理添加标签，还可以看热门项目，对于 star 几百个的人太有用了</p></li><li><p>★<a href="https://github.com/Nightonke/Gitee" title=" 点击访问 " target="_blank" rel="noopener">gitee</a>：显示 GitHub 账号信息，方便查看 trending、项目信息等</p></li><li><p>★<a href="https://slack.com/" title=" 点击访问 " target="_blank" rel="noopener">Slack</a>：开发人员的聊天 app，主要是国外用户，加入不同的 channel，了解不同的地域风格，与国外友人交流</p></li><li><p><a href="http://gitter.im" title=" 点击访问 " target="_blank" rel="noopener">Gitter</a>：也是一款开发人员地聊天 app，集合各种语言和框架，与其相关的还有一个 GitLab</p></li><li><p>★★★<a href="http://www.jitouch.com/" title=" 点击访问 " target="_blank" rel="noopener">Jitouch</a>：手势拓展，定义手势操作让触控板更强大，加上 alfred，还要什么鼠标。这是我的设置，注意手势要求两指有一定距离，最好用食指和无名指来划。</p></li></ul><p><img src="https://src.wangriyu.wang/images/blog/artifact/jitouch1.png" alt="image"></p><p><img src="https://src.wangriyu.wang/images/blog/artifact/jitouch2.png" alt="image"></p><ul><li><p>★★<a href="https://www.boastr.net/" title=" 点击访问 " target="_blank" rel="noopener">BetterTouchTool</a>：功能比 jitouch 还要强大，但现在要收费，虽然功能更多而且支持自定义手势但设置也会复杂一点，这里有篇 <a href="http://www.jianshu.com/p/4447344fc531" target="_blank" rel="noopener">教程</a>，对我来说 jitouch 已经够用了</p></li><li><p>★★★<a href="https://www.alfredapp.com/" title=" 点击访问 " target="_blank" rel="noopener">Alfred</a>：如果上面的都是神器，那这个就是超神器，强烈推荐。附上 <a href="http://wellsnake.com/jekyll/update/2014/06/15/001/" title=" 点击访问 " target="_blank" rel="noopener">使用教程</a>。<br>建议关掉 mac 自带的 Spotlight, 将 Alfred 快捷键设置成 cmd + space(原 Spotlight 快捷键)；<br>把常用的网站，特别是搜索类的放到 websearch 里：<br><img alt="image" src="https://src.wangriyu.wang/images/blog/artifact/websearch.png" width="600px" height="400px"><br>把浏览器书签导入 Safari，可以用 Alfred 搜索打开；快捷键打开终端；查询文档；搜索打开文件；记录 Clipboard 历史等等…<br>当然最强大的功能还是 workflow，我用到的 workflow 有 Dash 和有道翻译</p></li><li><p>Alfred 的其他平台替代品：windows 有 <a href="http://www.getwox.com/" target="_blank" rel="noopener">wox</a>、linux 有 <a href="https://albertlauncher.github.io/" target="_blank" rel="noopener">Albert</a> 和 Synapse</p></li><li><p><a href="https://itunes.apple.com/us/app/blackmagic-disk-speed-test/id425264550?mt=12" target="_blank" rel="noopener">Blackmagic Disk Speed Test</a>: 简单实用的硬盘测速软件</p></li></ul><hr><h2 id="应用篇"><a href="#应用篇" class="headerlink" title="应用篇"></a>应用篇</h2><h3 id="安卓"><a href="#安卓" class="headerlink" title="安卓"></a>安卓</h3><ul><li><p>[Google Play]：第一推荐当然是谷歌商店啦，上面也有很多精品应用</p></li><li><p>[蓝灯 VPN]：要访问谷歌肯定要翻墙，蓝灯还是能用的，之前用的是 green，但后来又被封了</p></li><li><p>[萤火虫 VPN]：萤火虫也是可以用的</p></li><li><p>★★[知乎、简书、轻氧、掘金、开发者头条]：学习的好地方</p></li><li><p><a href="https://play.google.com/store/apps/details?id=com.fastaccess.github" target="_blank" rel="noopener">FastHub</a>：FastHub for GitHub，集合了 GitHub 基本所需的所有功能</p></li><li><p><a href="http://zuimeia.com/apps/?platform=2" title=" 点击访问 " target="_blank" rel="noopener">最美应用</a>：这是一个应用的名字，是最美团队出品的，收集了很多精品应用</p></li><li><p><a href="https://play.google.com/store/apps/details?id=flipboard.app&amp;hl=zh_CN" title=" 点击访问 " target="_blank" rel="noopener">Flipboard</a>：需要翻墙，一些时事资讯。热门文章等</p></li><li><p><a href="https://play.google.com/store/apps/details?id=com.zuiapps.suite.days&amp;hl=zh_CN" title=" 点击访问 " target="_blank" rel="noopener">ZUI Days</a>：一款很漂亮的记录时间和重要纪念日的应用</p></li><li><p>★<a href="https://play.google.com/store/apps/details?id=com.ruguoapp.jike&amp;hl=zh_CN" title=" 点击访问 " target="_blank" rel="noopener">即刻</a>：专门为你定制的内容推送，推荐使用</p></li><li><p><a href="https://play.google.com/store/apps/details?id=com.google.android.spotlightstories&amp;hl=zh_CN" title=" 点击访问 " target="_blank" rel="noopener">Google Spotlight Stories</a>：用手机看真•3D 视频，效果很棒，值得一试</p></li><li><p>★<a href="https://play.google.com/store/apps/details?id=com.memorado.brain.games&amp;hl=zh_CN" title=" 点击访问 " target="_blank" rel="noopener">Memorado</a>：很棒的一款脑力游戏，画面精美，无聊的时候练练脑力</p></li><li><p><a href="https://play.google.com/store/apps/details?id=com.picsart.studio&amp;hl=zh_CN" title=" 点击访问 " target="_blank" rel="noopener">PicsArt</a>：很强大的修图应用，但让我印象深刻的是里面的魔法：可以将一张图转换成其他图片的风格，比如梵高的星夜</p></li><li><p><a href="https://play.google.com/store/apps/details?id=com.scheffsblend.designertools&amp;hl=zh_CN" title=" 点击访问 " target="_blank" rel="noopener">Designer Tools</a>：设计师工具，提供了网格覆盖图、样机覆盖图、取色器、截图细节等</p></li><li><p><a href="https://play.google.com/store/apps/details?id=com.curiosity.dailycuriosity&amp;hl=zh_CN" title=" 点击访问 " target="_blank" rel="noopener">Curiosity</a>：各种视频，了解世界，增长见识</p></li><li><p>★★<a href="https://play.google.com/store/apps/details?id=mark.via.gp&amp;hl=zh_CN" title=" 点击访问 " target="_blank" rel="noopener">Via 浏览器</a>：非常小巧的浏览器，但功能一应俱全，而且响应速度很快，类似的还有一个夸克浏览器</p></li><li><p>★<a href="https://play.google.com/store/apps/details?id=com.dv.adm" title=" 点击访问 " target="_blank" rel="noopener">ADM</a>: 安卓上的 IDM，配合 ES 文件浏览器还可以下载百度网盘的东西，具体教程可以在网上搜到; 还可以配合 via 浏览器作下载工具使用</p></li><li><p>★★<a href="https://www.taptap.com/" target="_blank" rel="noopener">TapTap</a>：很棒的游戏社区</p></li></ul><h3 id="ios"><a href="#ios" class="headerlink" title="ios"></a>ios</h3><ul><li><p><a href="http://www.nosleep.net/" target="_blank" rel="noopener">Ideament</a>：很棒的思维导图工具</p></li><li><p><a href="http://weavesilk.com/" target="_blank" rel="noopener">Silk 2</a>: 动动手指便可创作出独一无二的艺术壁纸</p></li></ul><hr><h2 id="网站篇"><a href="#网站篇" class="headerlink" title="网站篇"></a>网站篇</h2><ul><li><p>★<a href="http://xclient.info" title=" 点击访问 " target="_blank" rel="noopener">Xclient</a>：精品 mac 应用分享</p></li><li><p>★<a href="http://devdocs.io/" title=" 点击访问 " target="_blank" rel="noopener">Devdocs</a>：API 文档，功能和 Dash 差不多</p></li><li><p><a href="https://www.docschina.org/" title=" 点击访问 " target="_blank" rel="noopener">印记中文</a>：一些权威中文文档</p></li><li><p>★★<a href="https://htmlpreview.github.io/" title=" 点击访问 " target="_blank" rel="noopener">HtmlPreview</a>：HTML 链接预览，可以用于预览 github 上的 html 文件</p></li><li><p>★★<a href="https://clipchamp.com/zh-Hans/dashboard" title=" 点击访问 " target="_blank" rel="noopener">在线压缩视频 ClipChamp</a>：方便好用</p></li><li><p><a href="https://converticon.com/" target="_blank" rel="noopener">converticon</a>：图片转 icon</p></li><li><p><a href="https://ezgif.com/video-to-gif" title=" 点击访问 " target="_blank" rel="noopener">视频转换器</a>：视频转 GIF，压缩、裁剪等等</p></li><li><p>★<a href="http://naotu.baidu.com/home" title=" 点击访问 " target="_blank" rel="noopener">百度脑图</a>：在线创建思维导图，功能强大</p></li><li><p>★<a href="http://caibaojian.com/page/3" title=" 点击访问 " target="_blank" rel="noopener">前端开发博客</a>：前端优质内容</p></li><li><p>★<a href="http://gank.io/" title=" 点击访问 " target="_blank" rel="noopener">干货集中营</a>：确实有干货，还有妹纸</p></li><li><p>★<a href="https://tutorialzine.com/articles" title=" 点击访问 " target="_blank" rel="noopener">tutorialzine</a>：前端文章推送</p></li><li><p><a href="http://collectui.com/" title=" 点击访问 " target="_blank" rel="noopener">Collect UI </a>：UI 设计灵感</p></li><li><p><a href="http://www.uisdc.com/75-web-animation-tools-1#" title=" 点击访问 " target="_blank" rel="noopener">优设</a>：关于设计和开发</p></li><li><p>★<a href="https://codepen.io/picks/2/" title=" 点击访问 " target="_blank" rel="noopener">CodePen</a>：各种有趣的 js demo 和项目</p></li><li><p><a href="https://www.codeseek.co/" target="_blank" rel="noopener">CodeSeek</a>：与 CodePen 类似的网站</p></li><li><p>★<a href="https://tympanus.net/codrops/category/playground/" title=" 点击访问 " target="_blank" rel="noopener">Codrops</a>：各种优质文章和设计</p></li><li><p>★★<a href="https://www.ctolib.com/" title=" 点击访问 " target="_blank" rel="noopener">CTOLib 码库</a>：各种代码库</p></li><li><p><a href="http://nec.netease.com/library" title=" 点击访问 " target="_blank" rel="noopener">网易代码库</a></p></li><li><p>★<a href="https://dribbble.com/" title=" 点击访问 " target="_blank" rel="noopener">Dribbble</a>：优秀设计模板</p></li><li><p>★<a href="https://www.behance.net/" title=" 点击访问 " target="_blank" rel="noopener">Behance</a>：优秀设计创意作品</p></li><li><p>★<a href="https://tinypng.com/" title=" 点击访问 " target="_blank" rel="noopener">压缩图片 https://tinypng.com</a></p></li><li><p><a href="http://asciiflow.com/" title=" 点击访问 " target="_blank" rel="noopener">在线画图 Asciiflow</a></p></li><li><p><a href="http://thecodeplayer.com/" title=" 点击访问 " target="_blank" rel="noopener">TheCodePlayer</a>：很棒的 HTML5、CSS3、JS 学习网站，代码一行一行视频演示</p></li><li><p><a href="https://www.freshdesignweb.com/" title=" 点击访问 " target="_blank" rel="noopener">Freshdesignweb</a>：网站设计</p></li><li><p><a href="https://css-tricks.com/" title=" 点击访问 " target="_blank" rel="noopener">CSS-Tricks</a>：学习 CSS 不可错过此网站</p></li><li><p><a href="http://en.jsrun.net/" title=" 点击访问 " target="_blank" rel="noopener">JSRUN</a>：类似 codepen，提供在线编写代码，也有很多有趣 demo</p></li><li><p><a href="http://cssdeck.com/" title=" 点击访问 " target="_blank" rel="noopener">CssDeck</a>：一些展示 CSS 效果的 demo</p></li><li><p>★<a href="http://tool.oschina.net/" title=" 点击访问 " target="_blank" rel="noopener">在线工具汇总</a></p></li><li><p><a href="http://www.jiawin.com/10-design-artifact" title=" 点击访问 " target="_blank" rel="noopener">觉唯设计</a></p></li><li><p>★<a href="https://www.smashingmagazine.com/tag/javascript/" title=" 点击访问 " target="_blank" rel="noopener">SmashingMagazine</a>：前端杂志</p></li><li><p><a href="http://navnav.co/" title=" 点击访问 " target="_blank" rel="noopener">NavNav</a>：各种响应式菜单的设计</p></li><li><p><a href="https://codyhouse.co/library/" title=" 点击访问 " target="_blank" rel="noopener">CODYHOUSE</a>：视觉设计</p></li><li><p><a href="https://csswizardry.com/archive/" title=" 点击访问 " target="_blank" rel="noopener">CSS Wizardry Posts Archive</a>：优质博客文章，很多关于 css 和设计的</p></li><li><p><a href="http://textify.it/" title=" 点击访问 " target="_blank" rel="noopener">textify.it</a>：一个有趣的网站，可以把图片字符化</p></li><li><p><a href="http://www.developerdrive.com/categories/" title=" 点击访问 " target="_blank" rel="noopener">DeveloperDrive</a>：提供大量优质文章</p></li><li><p>★<a href="https://hackernoon.com/" title=" 点击访问 " target="_blank" rel="noopener">HACKNOON</a>：极客的下午茶时间，推送很多优质文章</p></li><li><p><a href="http://fakeupdate.net/" title=" 点击访问 " target="_blank" rel="noopener">假装 Windows 升级界面</a></p></li><li><p><a href="https://www.seeseed.com/" title=" 点击访问 " target="_blank" rel="noopener">SeeSeed</a>：设计与灵感，适合设计师用</p></li><li><p><a href="http://tushuo.baidu.com/wave/index#/gallery" title=" 点击访问 " target="_blank" rel="noopener">百度•图说</a>：在线创建图表</p></li><li><p><a href="http://www.csswinner.com/blog/" title=" 点击访问 " target="_blank" rel="noopener">CSSWinner</a>：CSS Award Gallery for Website Design Inspiration</p></li><li><p><a href="http://www.zcfy.cc/translate/discovery" title=" 点击访问 " target="_blank" rel="noopener">众成翻译</a>：有很多翻译的和未翻译的文章，值得翻一翻看一看</p></li><li><p><a href="http://www.guokr.com/scientific/" title=" 点击访问 " target="_blank" rel="noopener">果壳 - 科学人</a>：挺多有趣的科学文章</p></li><li><p><a href="https://zh.airbnb.com/" title=" 点击访问 " target="_blank" rel="noopener">Airbnb</a></p></li><li><p>★<a href="https://medium.com/" title=" 点击访问 " target="_blank" rel="noopener">Medium</a>：各种文章，谷歌商店上还能找到 app</p></li><li><p><a href="https://developers.google.com/speed/pagespeed/?hl=zh-CN&amp;utm_source=PSI&amp;utm_medium=incoming-link&amp;utm_campaign=PSI" title=" 点击访问 " target="_blank" rel="noopener">Google PageSpeed Tools</a>：谷歌站点分析，网站速度性能评分</p></li><li><p><a href="http://www.arkie.cn/" title=" 点击访问 " target="_blank" rel="noopener">ARKie</a>：自动帮你设计海报，很好用</p></li><li><p>★<a href="http://iconfont.cn/" title=" 点击访问 " target="_blank" rel="noopener">IconFont</a>：阿里巴巴矢量图标库</p></li><li><p><a href="http://ppt.baidu.com/" title=" 点击访问 " target="_blank" rel="noopener">PPT 遥控器</a>：用手机当 ppt 遥控器</p></li><li><p>★<a href="https://wordart.com/" title=" 点击访问 " target="_blank" rel="noopener">Wordart</a>：在线生成文字云</p></li><li><p><a href="https://goo.gl/#" title=" 点击访问 " target="_blank" rel="noopener">在线生成短链</a>：谷歌在线生成短链工具</p></li><li><p>★<a href="https://gfycat.com/" title=" 点击访问 " target="_blank" rel="noopener">Gfycat</a>：各种动图</p></li><li><p><a href="https://mockupsjar.com/" title=" 点击访问 " target="_blank" rel="noopener">Mockups</a>：三步生成逼真的网站、手机的设计稿</p></li><li><p>★<a href="https://frontend.directory/p" title=" 点击访问 " target="_blank" rel="noopener">frontend.directory</a>：罗列了各种前端的资源</p></li><li><p><a href="http://hawx1993.github.io/Front-end-Interview-Questions/#/?id=interview-quesetions" title=" 点击访问 " target="_blank" rel="noopener">前端面试题</a>：长期更新的，内容挺全</p></li><li><p><a href="http://html5ify.com/fks/" title=" 点击访问 " target="_blank" rel="noopener">FKS</a>：Frontend Knowledge Structure，前端知识体系汇总</p></li><li><p><a href="http://css3pie.com/" title=" 点击访问 " target="_blank" rel="noopener">CSS3PIE</a>：PIE 使 IE6~9 可以支持大部分 CSS3 的样式</p></li><li><p><a href="https://javier.xyz/img2css/" title=" 点击访问 " target="_blank" rel="noopener">img2css</a>：将图片转成 css，适合一些小图标，大图就不要尝试了</p></li><li><p><a href="https://trello.com/#" title=" 点击访问 " target="_blank" rel="noopener">Trello</a>：看板，GitHub 上有一个类似的项目叫 <a href="https://wekan.indie.host/" title=" 点击访问 " target="_blank" rel="noopener">wekan</a></p></li><li><p><a href="http://www.bootcdn.cn/" title=" 点击访问 " target="_blank" rel="noopener">BootCDN</a>：找一些库的 cdn 很方便</p></li><li><p><a href="http://wetest.qq.com/product/cloudphone" title=" 点击访问 " target="_blank" rel="noopener">云真机</a>：腾讯推出的服务，可以线上测试各种手机</p></li><li><p>★<a href="http://hao.caibaojian.com/" title=" 点击访问 " target="_blank" rel="noopener">码农头条</a></p></li><li><p>★<a href="http://weekly.manong.io/issues/" title=" 点击访问 " target="_blank" rel="noopener">码农周刊</a></p></li><li><p><a href="http://cssanimate.com/" title=" 点击访问 " target="_blank" rel="noopener">CSS Animate</a>：在线生成 css 动画</p></li><li><p><a href="http://www.wailian.work/" title=" 点击访问 " target="_blank" rel="noopener">外链工厂</a>：无限外链，批量上传，而且可以生成各种嵌入代码</p></li><li><p><a href="http://algo-visualizer.jasonpark.me/#path=backtracking/knight&#39;s_tour/basic" title=" 点击访问 " target="_blank" rel="noopener">AlgorithmVisualizer</a>：演示算法的网页，做的很棒</p></li><li><p>★<a href="https://www.codewars.com" title=" 点击访问 " target="_blank" rel="noopener">CodeWar</a>：很适合练习编程，包含各种语言，而且可以查看别人对同一问题的不同解法</p></li><li><p><a href="http://onlywei.github.io/explain-git-with-d3/" title=" 点击访问 " target="_blank" rel="noopener">Visualizing Git Concepts with D3</a>：用图形化的教程教你使用一些基础的 git 命令</p></li><li><p><a href="http://www.jobbole.com/" title=" 点击访问 " target="_blank" rel="noopener">伯乐在线</a></p></li><li><p><a href="https://www.creative-tim.com/" title=" 点击访问 " target="_blank" rel="noopener">CreativeTim</a>：很多网站和管理后台的模板</p></li><li><p>★<a href="https://carbon.now.sh/" title=" 点击访问 " target="_blank" rel="noopener">Carbon</a>：生成一张代码高亮图片，很漂亮，适合插入到网站和博客中</p></li><li><p><a href="http://resume.github.io/" title=" 点击访问 " target="_blank" rel="noopener">GitHub Resume</a>：输入 github 名，自动生成一个简单的简历页</p></li><li><p><a href="https://js.coach/" title=" 点击访问 " target="_blank" rel="noopener">js coach</a>：js 开源库目录</p></li><li><p><a href="http://www.feweekly.com/issues" title=" 点击访问 " target="_blank" rel="noopener">前端周刊</a></p></li><li><p>★<a href="https://www.easy-mock.com/login" title=" 点击访问 " target="_blank" rel="noopener">EasyMock</a>：更方便地模拟数据</p></li><li><p><a href="https://material.io/icons/" title=" 点击访问 " target="_blank" rel="noopener">MaterialIcon</a>：Material Design Icon</p></li><li><p><a href="https://tutorialzine.com/articles" title=" 点击访问 " target="_blank" rel="noopener">tutorialzine</a>：前端文章</p></li><li><p>★<a href="http://www.w3cplus.com/" title=" 点击访问 " target="_blank" rel="noopener">W3CPlus</a>：w3cplus_ 引领 web 前沿，打造前端精品教程</p></li><li><p><a href="https://www.helloweba.com/" title=" 点击访问 " target="_blank" rel="noopener">HelloWeba</a>：又是前端文章</p></li><li><p><a href="http://youarelistening.to/" target="_blank" rel="noopener">http://youarelistening.to</a>: 好像是在线听美国的广播电台，在知乎上看到的</p></li><li><p><a href="http://geektyper.com/" target="_blank" rel="noopener">http://geektyper.com</a>：随便乱敲，屏幕会显示一段一段代码或窗口，看起来跟黑客一样，纯属装逼</p></li><li><p><a href="http://www.tuling123.com/" target="_blank" rel="noopener">http://www.tuling123.com</a>：聊天机器人，可以接入公众号、qq、网页等</p></li><li><p><a href="https://sentry.io/welcome/" target="_blank" rel="noopener">sentry.io</a>：收集错误报告，帮助开发人员实时监控和修复崩溃</p></li><li><p>★<a href="https://smallpdf.com/cn" target="_blank" rel="noopener">smallpdf</a>：一站式处理 pdf</p></li><li><p><a href="http://overapi.com/" target="_blank" rel="noopener">overapi</a>：各大语言和各种框架的 API 介绍</p></li><li><p><a href="http://www.it-ebooks.info/" target="_blank" rel="noopener">it-ebooks</a>：可以下载很多 it 相关的书籍</p></li><li><p><a href="https://ui8.net/category/all" target="_blank" rel="noopener">UI8</a>：很多设计模板</p></li><li><p>★<a href="http://repository-hunter.herokuapp.com" target="_blank" rel="noopener">github hunter</a>：统计 github 上的一些信息，可以查指定名字的信息，还有一些趣事集锦，还可以生成你的贡献图</p></li><li><p><a href="http://www.hongkiat.com/blog/" target="_blank" rel="noopener">HONGKIAT</a>：汇集各种设计和灵感</p></li><li><p>★★<a href="https://gigabook.com/tools" target="_blank" rel="noopener">Free Web Developer Tools by GigaBook</a>：各种网页开发工具，很全很强大</p></li><li><p><a href="https://www.lanhuapp.com/" target="_blank" rel="noopener">蓝湖 - 产品设计的协作平台</a>：适合团队设计</p></li><li><p><a href="http://www.biaonimeia.com/" target="_blank" rel="noopener">标你妹啊</a>：标你妹啊是新一代全自动化的标注工具，通过分析 psd 文件，自动创建图层、字体等元素的数据信息。</p></li><li><p><a href="https://visualgo.net" target="_blank" rel="noopener">visualgo</a>：演示算法</p></li><li><p><a href="https://www.interviewcake.com/" target="_blank" rel="noopener">interviewcake</a>：I will teach you to be good at programming interviews</p></li><li><p>★<a href="http://www.css88.com" target="_blank" rel="noopener">http://www.css88.com</a> ：WEB 前端开发 - 专注前端开发，关注用户体验 - 专注前端开发，关注用户体验</p></li><li><p><a href="http://www.jsnice.org" target="_blank" rel="noopener">http://www.jsnice.org</a> ：反编译压缩的 js 代码，更容易阅读理解</p></li><li><p><a href="https://www.cloudboost.io" target="_blank" rel="noopener">https://www.cloudboost.io</a> : 快速构建 app</p></li><li><p><a href="https://css3gen.com/" target="_blank" rel="noopener">css3gen</a>：CSS3Gen 可让您轻松生成有用的 CSS3 片段，并将其直接复制到您的项目中</p></li><li><p><a href="http://learningthreejs.com" target="_blank" rel="noopener">http://learningthreejs.com</a> ：学习 three.js</p></li><li><p><a href="http://javascript-puzzlers.herokuapp.com" target="_blank" rel="noopener">http://javascript-puzzlers.herokuapp.com</a> ：测试一下你是否真的懂了 js，共 44 道题</p></li><li><p>★javascript 周刊 <a href="http://javascriptweekly.com/issues" target="_blank" rel="noopener">http://javascriptweekly.com/issues</a> ：英文网站</p></li><li><p><a href="http://bennettfeely.com/cssynth" target="_blank" rel="noopener">http://bennettfeely.com/cssynth</a> ：生成卡片加载动画</p></li><li><p>★<a href="https://gtmetrix.com/" target="_blank" rel="noopener">GTmetrix 网站测试</a>：对网站进行评估，并给出优化的建议</p></li><li><p>★<a href="https://developers.google.com/speed/pagespeed/insights/?hl=zh-CN" target="_blank" rel="noopener">PageSpeed Tools 谷歌站点分析工具</a>：也是对网站进行评估，并给出优化的建议</p></li><li><p><a href="https://codeburst.io/" target="_blank" rel="noopener">CodeBurst</a>：前端博客</p></li><li><p><a href="http://hitokoto.cn/" target="_blank" rel="noopener">Hitokoto - 一言</a>：一言指的就是一句话，可以是动漫中的台词，也可以是网络上的各种小段子。或是感动，或是开心，有或是单纯的回忆。</p></li><li><p><a href="https://www.invisionapp.com/feature/inspect?ref=muzli" target="_blank" rel="noopener">InvisionApp</a>：A magical new design to development workflow with Inspect</p></li><li><p><a href="https://webflow.com/" target="_blank" rel="noopener">Webflow</a>：Webflow gives designers and developers the power to design, build, and launch responsive websites visually, while writing clean, semantic code for you.</p></li><li><p><a href="https://www.sekai.co/trust/" target="_blank" rel="noopener">信任的进化</a>：有趣的游戏，通过博弈论来讲解 “ 不信任 “ 的原因</p></li><li><p><a href="https://ipfs.io/" target="_blank" rel="noopener">IPFS 网络</a>：IPFS 是一个点对点的超媒体协议，使网页更快，更安全，更开放。</p></li><li><p><a href="http://www.debugrun.com/" target="_blank" rel="noopener">DebugRun.com</a>：编程语言帮助文档</p></li><li><p><a href="http://www.aazzp.com/index.php?s=/home/index/index.html" target="_blank" rel="noopener">小众前端</a>：一个自由的前端开发者！</p></li><li><p>★<a href="https://xituqu.com/" target="_blank" rel="noopener">稀土区</a>：优秀开发设计资源分享</p></li><li><p><a href="https://www.servethehome.com/" target="_blank" rel="noopener">ServeTheHome</a>：Server, Storage, Networking and Open Source Software News and Reviews</p></li><li><p><a href="http://flarum.org.cn/" target="_blank" rel="noopener">Flarum</a>：Flarum 是一款优雅简洁论坛软件。让在线交流变得更加轻松愉快。</p></li><li><p><a href="http://online.xiaomo.info" target="_blank" rel="noopener">http://online.xiaomo.info</a> ：小莫的资源管理器</p></li><li><p><a href="http://www.yiibai.com/" target="_blank" rel="noopener">易百教程</a>：各种语言教程</p></li><li><p><a href="http://www.bigpixel.cn/#latestworks" target="_blank" rel="noopener">景坤科技</a>：各种超大分辨率的全景图片</p></li><li><p><a href="http://www.koalastothemax.com" target="_blank" rel="noopener">http://www.koalastothemax.com</a> ：不断滑动，最后会出现考拉</p></li><li><p><a href="https://dev.to/" target="_blank" rel="noopener">The DEV Community</a></p></li><li><p><a href="https://www.taptap.com/" target="_blank" rel="noopener">TapTap</a>：很棒的移动游戏社区，可以在上面找到很多心仪的游戏</p></li><li><p><a href="https://webkul.github.io/coolhue" target="_blank" rel="noopener">https://webkul.github.io/coolhue</a> ：不知道怎么搭配色彩，没关系，这里列了很多很棒的搭配方案</p></li><li><p>★<a href="https://www.minimamente.com/example/gradient-generator/" target="_blank" rel="noopener">css 生成渐变色代码</a></p></li><li><p><a href="https://mycolor.space/gradient" title=" 点击访问 " target="_blank" rel="noopener">ColorSpace</a>：生成渐进色背景</p></li><li><p><a href="https://laod.cn/" target="_blank" rel="noopener">老 D 博客</a>: 关注谷歌服务，分享互联网精神！</p></li><li><p><a href="https://giphy.com/" target="_blank" rel="noopener">https://giphy.com/</a> : Search All the GIFs &amp; Make Your Own Animated GIF</p></li><li><p><a href="http://www.gifntext.com/" target="_blank" rel="noopener">http://www.gifntext.com/</a> : 可以编辑动图，比如添加文字等</p></li><li><p><a href="http://magickeyboard.io/" target="_blank" rel="noopener">http://magickeyboard.io/</a> ：趣味网站，键入会有特效</p></li><li><p><a href="https://www.miaomiaomiao.org/interesting" target="_blank" rel="noopener">https://www.miaomiaomiao.org/interesting</a> ： 有趣实用的网站分享</p></li><li><p><a href="http://weavesilk.com/" target="_blank" rel="noopener">http://weavesilk.com/</a> ：可以画出独一无二的艺术壁纸</p></li><li><p><a href="http://helloweb.wang/" target="_blank" rel="noopener">http://helloweb.wang/</a> ：HelloWeb 前端网</p></li><li><p><a href="https://www.templatemonster.com/" target="_blank" rel="noopener">https://www.templatemonster.com/</a> ：模板巨人，各种网页模板</p></li></ul><hr><h2 id="收藏库"><a href="#收藏库" class="headerlink" title="收藏库"></a>收藏库</h2><ul><li><p><a href="https://apoorv.pro/lozad.js/" target="_blank" rel="noopener">Lozad.js</a>：懒加载库</p></li><li><p><a href="https://tabrisjs.com" target="_blank" rel="noopener">https://tabrisjs.com</a> ：Tabris.js 是一个移动框架，可让您从完全用 JavaScript 编写的单一代码库中开发原生 iOS 和 Android 应用程序</p></li><li><p><a href="https://github.com/oneuijs/You-Dont-Need-jQuery/blob/master/README.zh-CN.md" target="_blank" rel="noopener">You-Dont-Need-jQuery</a>：本项目总结了大部分 jQuery API 替代的方法</p></li><li><p>★<a href="http://lodashjs.com/" target="_blank" rel="noopener">lodash</a>：这是一个具有一致接口、模块化、高性能等特性的 JavaScript 工具库</p></li><li><p>★<a href="http://www.css88.com/doc/underscore" target="_blank" rel="noopener">underscore.js</a>：Underscore 一个 JavaScript 实用库，提供了一整套函数式编程的实用功能，但是没有扩展任何 JavaScript 内置对象</p></li><li><p><a href="https://github.com/alvarcarto/url-to-pdf-api" target="_blank" rel="noopener">url-to-pdf-api</a>：网页生成 pdf 的 API</p></li><li><p><a href="http://github.hubspot.com/odometer/" target="_blank" rel="noopener">Odometer</a>：Odometer 是一个用于平滑过渡数字的 Javascript 和 CSS 库</p></li><li><p><a href="http://daniel-lundin.github.io/snabbt.js/" target="_blank" rel="noopener">snabbt.js</a>：snabbt.js 是一个简约的 JavaScript 动画库。它专注于移动事物。它会翻译，旋转，缩放，扭曲和调整元素的大小。</p></li><li><p><a href="https://github.com/lukehaas/css-loaders" target="_blank" rel="noopener">css-loaders</a>：这是一个使用 CSS 动画的 loading spinners 集合</p></li><li><p><a href="http://force-js.com/" target="_blank" rel="noopener">Force.js</a>：The easy way to scroll and animate your page</p></li><li><p><a href="https://ionicframework.com/" target="_blank" rel="noopener">Ionic</a>：Build amazing native and progressive web apps with open web technologies</p></li><li><p><a href="https://hyperapp.js.org/" target="_blank" rel="noopener">hyperapp</a>：1 KB JavaScript library for building frontend applications</p></li><li><p><a href="http://shopify.github.io/js-buy-sdk/" target="_blank" rel="noopener">js-buy-sdk</a>：JS Buy SDK 是一个轻量级库，可以让您在任何网站上构建电子商务</p></li><li><p><a href="https://shopify.github.io/draggable/" target="_blank" rel="noopener">draggable.js</a>：a lightweight, responsive, modern drag &amp; drop library</p></li><li><p>★<a href="http://momentjs.cn/" target="_blank" rel="noopener">moment.js</a>：JavaScript 日期处理类库</p></li><li><p><a href="http://fian.my.id/Waves/" target="_blank" rel="noopener">Waves</a>：Click effect inspired by Google’s Material Design</p></li><li><p><a href="http://learningthreejs.com/blog/2011/08/14/dat-gui-simple-ui-for-demos/" target="_blank" rel="noopener">dat-gui-demos</a>：<a href="https://github.com/dataarts/dat.gui" target="_blank" rel="noopener">Dat.gui</a> is a GUI widget for your demos. It provide way for the user to set parameters of the demo to play with it. It is simple to code, yet cool and minimalist on the screen.</p></li><li><p><a href="http://todomvc.com" target="_blank" rel="noopener">http://todomvc.com</a> ：Helping you select an MV* framework</p></li><li><p><a href="https://hnpwa.com" target="_blank" rel="noopener">https://hnpwa.com</a> ：Hacker News readers as Progressive Web Apps</p></li><li><p><a href="https://alvarotrigo.com/fullPage/" target="_blank" rel="noopener">fullPage.js</a>：Create Beautiful Fullscreen Scrolling Websites</p></li><li><p><a href="https://alvarotrigo.com/multiScroll" target="_blank" rel="noopener">multiScroll.js</a>：Create divided multi-scrolling pages</p></li><li><p><a href="http://createjs.com/" target="_blank" rel="noopener">Create js</a>：A suite of modular libraries and tools which work together or independently to enable rich interactive content on open web technologies via HTML5</p></li><li><p><a href="http://c3js.org" target="_blank" rel="noopener">http://c3js.org</a> ：D3-based reusable chart library</p></li><li><p>★★<a href="https://d3js.org" target="_blank" rel="noopener">D3</a> ：D3.js is a JavaScript library for manipulating documents based on data，巨强的图表库</p></li><li><p>★<a href="http://echarts.baidu.com/index.html" target="_blank" rel="noopener">Echarts</a>：百度出品的图表库，配置很简单，文档很全</p></li><li><p>★<a href="https://antv.alipay.com/index.html" target="_blank" rel="noopener">G2 + G6</a>：阿里出品的图表库</p></li><li><p>★<a href="http://www.chartjs.org" target="_blank" rel="noopener">Chart js</a> ：Simple yet flexible JavaScript charting for designers &amp; developers</p></li><li><p><a href="https://www.highcharts.com/" target="_blank" rel="noopener">Highcharts</a>：Highcharts makes it easy for developers to set up interactive charts in their web pages</p></li><li><p><a href="https://naver.github.io/billboard.js/" target="_blank" rel="noopener">billboard.js</a>：Re-usable, easy interface JavaScript chart library, based on D3 v4+</p></li><li><p><a href="http://recharts.org/#/zh-CN" target="_blank" rel="noopener">Recharts</a>：基于 React 的组合式图表，适合做简单轻量的图表</p></li><li><p><a href="https://display.js.org" target="_blank" rel="noopener">https://display.js.org</a> ：A simple JavaScript framework for building ambitious UIs</p></li><li><p><a href="http://www.pixijs.com" target="_blank" rel="noopener">Pixi JS</a> ：Create beautiful digital content with the fastest, most flexible 2D WebGL renderer</p></li><li><p><a href="https://gka.js.org/#/?id=gka" target="_blank" rel="noopener">GKA</a>：简单的、高效的帧动画生成工具</p></li><li><p><a href="https://alloyteam.github.io/curvejs/" target="_blank" rel="noopener">curvejs</a>：Made curve a dancer in HTML5 canvas - 魔幻线条，AllolyTeam 出品 <a href="https://alloyteam.github.io/" target="_blank" rel="noopener">https://alloyteam.github.io/</a></p></li><li><p>★<a href="http://thednp.github.io/kute.js/" target="_blank" rel="noopener">kute.js</a>：非常漂亮的动画库</p></li><li><p>★<a href="http://animejs.com/" target="_blank" rel="noopener">animejs</a>：js 动画库</p></li><li><p><a href="http://dynamicsjs.com/" target="_blank" rel="noopener">dynamicsjs</a>：js 基于物理的动画库</p></li><li><p><a href="http://bonsaijs.org/" target="_blank" rel="noopener">bonsaijs</a>：A lightweight graphics library with an intuitive graphics API and an SVG renderer</p></li><li><p><a href="http://lazylinepainter.info/" target="_blank" rel="noopener">lazylinepainter</a>：A JQUERY PLUGIN FOR SVG PATH ANIMATION</p></li><li><p><a href="http://anijs.github.io/" target="_blank" rel="noopener">AniJS</a>：A Library to Raise your Web Design without Coding</p></li><li><p><a href="http://bouncejs.com/" target="_blank" rel="noopener">bouncejs</a>：Bounce.js is a tool and JS library that lets you create beautiful CSS3 powered animations</p></li><li><p><a href="https://www.minimamente.com/example/magic_animations/" target="_blank" rel="noopener">Magic Animations CSS3</a>：漂亮的 css 动画</p></li><li><p><a href="https://daneden.github.io/animate.css/" target="_blank" rel="noopener">Animate.css</a></p></li><li><p>★<a href="https://threejs.org/" target="_blank" rel="noopener">three.js</a>：js 3D 库</p></li><li><p><a href="https://varin6.github.io/Hover-Buttons/" target="_blank" rel="noopener">Hover-Buttons</a>：button hover 特效</p></li><li><p>★<a href="http://brm.io/matter-js/" target="_blank" rel="noopener">matter-js</a>：Matter.js is a 2D physics engine for the web，js 平面物理引擎库</p></li><li><p>★★<a href="http://iscrolljs.com/" target="_blank" rel="noopener">iScroll.js</a>：iScroll is a high performance, small footprint, dependency free, multi-platform javascript scroller.</p></li><li><p><a href="https://draftjs.org/" target="_blank" rel="noopener">Draft.js</a>：一个用于构建富文本编辑的框架</p></li><li><p><a href="https://maxwellito.github.io/vivus/" target="_blank" rel="noopener">Vivus</a>：vivus 用于描绘 SVG 动画</p></li><li><p><a href="http://hammerjs.github.io/" target="_blank" rel="noopener">HammerJS</a>：是页面支持手势操作</p></li><li><p><a href="https://markojs.com/" target="_blank" rel="noopener">Marko</a>：A friendly (and fast!) UI library from eBay that makes building web apps</p></li><li><p><a href="http://www.voxelcss.com/" target="_blank" rel="noopener">VoxelCSS</a>：A lightweight 3D CSS voxel library</p></li><li><p><a href="https://bulma.io/" target="_blank" rel="noopener">Bulma</a>：Bulma is a free and open source CSS framework based on Flexbox</p></li><li><p><a href="https://www.blazecss.com/" target="_blank" rel="noopener">BlazeCSS</a>：Blaze is an open source modular toolkit. It provides great structure for building websites quickly with a scalable and maintainable foundation</p></li><li><p><a href="https://purecss.io/" target="_blank" rel="noopener">PureCSS</a>：A set of small, responsive CSS modules that you can use in every web project</p></li><li><p><a href="https://scrollrevealjs.org/" target="_blank" rel="noopener">ScrollRevealJS</a>：Easy scroll animations for web and mobile browsers</p></li></ul><blockquote><p>如果你在这找到好用的东西，恭喜！如果你有好用的东西分享，欢迎在评论中告诉我！</p></blockquote>]]></content>
      
      <categories>
          
          <category> Share </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分享 </tag>
            
            <tag> 应用 </tag>
            
            <tag> 插件 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>使用 Hexo 主题 Yelee</title>
      <link href="/2017/08-Hexo.html"/>
      <url>/2017/08-Hexo.html</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前使用的是 next 主题，虽然 next 很强大，但是 next 的样式并不是我很喜欢的类型。<br>后来无意间在别人博客上看到这种双栏主题，而且还有各种动画效果，作为颜控立马被吸引了，然后发现类似的双栏博客有好几个，像 yilia、spfk、yelee 等。<br>后者好像都是在 yilia 的基础上修改的，而我选择了 yelee，因为我更喜欢其色调，并且作者很贴心地写了 <a href="http://moxfive.coding.me/yelee" title="Yelee 主题使用说明 " target="_blank" rel="noopener">gitbook 操作指南</a>，这对刚接触博客的小白我来说真是福音。<br>感谢作者提供了这么好的主题，后来使用上碰到的一些问题和修改，我都一一列举在下面，以后如果还有修改我还会更新。</p><hr><p>按照 gitbook 的教程我完成博客的基础配置，效果基本上已经很满足了，但是测试上发现有些小问题，作为强迫症，修改之。</p><h2 id="代码块前后留白问题："><a href="#代码块前后留白问题：" class="headerlink" title="代码块前后留白问题："></a>代码块前后留白问题：</h2><p>代码块中的代码空行消失，都被挤到前后了，issue 上有人解决了：<br><img src="https://src.wangriyu.wang/images/blog/hexo/CodeSpace.png" alt="代码显示错位"></p><hr><p>然后是页面跳转问题，我希望的是本站内的链接和标签都在本窗口打开，外站的都在新标签页打开，<br>但是像搜索结果和迷你文章列表等点击会在新标签页打开，得做如下修改：</p><h2 id="取消搜索结果跳转新标签页："><a href="#取消搜索结果跳转新标签页：" class="headerlink" title="取消搜索结果跳转新标签页："></a>取消搜索结果跳转新标签页：</h2><p><strong>目标文件：themes/yelee/source/js/search.js</strong></p><p>找到</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// show search results</span><span class="token keyword">if</span> <span class="token punctuation">(</span>isMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>    str <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">"&lt;li>&lt;a href='"</span><span class="token operator">+</span> data_url <span class="token operator">+</span><span class="token string">"' class='search-result-title' target='_blank'>"</span><span class="token operator">+</span> <span class="token string">"> "</span> <span class="token operator">+</span> data_title <span class="token operator">+</span><span class="token string">"&lt;/a>"</span><span class="token punctuation">;</span>    <span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>删除 <code>target=&#39;_blank&#39;</code> 字段</p><hr><h2 id="取消迷你文章在新窗口打开"><a href="#取消迷你文章在新窗口打开" class="headerlink" title="取消迷你文章在新窗口打开"></a>取消迷你文章在新窗口打开</h2><p><img src="https://src.wangriyu.wang/images/blog/hexo/miniArchives.png" alt="迷你文章列表"></p><p><strong>目标文件：themes/yelee/layout/_partial/open-in-new-tab.ejs</strong></p><p>找到</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>theme<span class="token punctuation">.</span>open_in_new<span class="token punctuation">.</span>mini_archives<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">></span> miniArchives<span class="token punctuation">:</span> <span class="token string">"a.post-list-link"</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>将 <code>theme.open_in_new.mini_archives</code> 直接改为 false</p><p>我在 _config.yml 里设置 mini_archives 好像不起作用</p><hr><p><strong>下面的是我自己的一些修改，如有需要可供参考</strong></p><blockquote><p>我的所有修改记录都放在仓库里了：<a href="https://github.com/wangriyu/hexo-theme-yelee" title=" 点击访问 " target="_blank" rel="noopener">github</a></p></blockquote><h2 id="添加文章字数统计"><a href="#添加文章字数统计" class="headerlink" title="添加文章字数统计"></a>添加文章字数统计</h2><p>用到的插件是 <a href="https://github.com/willin/hexo-wordcount" title=" 点击访问 " target="_blank" rel="noopener">hexo-wordcount</a></p><p>安装很简单，一条命令 <code>npm i --save hexo-wordcount</code> 即可解决，<br>下面的配置是信息显示位置和样式，仅供参考，也可以自行修改</p><p><strong>目标文件：themes/yelee/layout/_partial/post/tag.ejs</strong><br>修改如下:</p><pre class="line-numbers language-diff"><code class="language-diff"><span class="token deleted">&lt;% if (post.tags &amp;&amp; post.tags.length){ %></span><span class="token deleted">-    &lt;div class="article-tag tagcloud"></span><span class="token inserted">+    &lt;div class="article-tag tagcloud" style="display: flex; flex-wrap: wrap"></span>        &lt;%-          list_tags(post.tags, {            show_count: false,            class: 'article-tag'          })        %><span class="token inserted">+       &lt;span class="post-count">总字数&lt;%= wordcount(post.content) %>&lt;/span></span><span class="token inserted">+       &lt;span class="post-count">预计阅读&lt;%= min2read(post.content) %>分钟&lt;/span></span>    &lt;/div><span class="token deleted">&lt;% } %></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>添加样式：<br><strong>目标文件：themes/yelee/source/css/_partial/tagcloud.styl</strong></p><p>找到</p><pre class="line-numbers language-sass"><code class="language-sass"><span class="token property-line"><span class="token property">.article-tag</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token property">before,</span></span><span class="token property-line"><span class="token property">.article-category</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token property">before</span></span>    <span class="token selector">float left</span>    <span class="token selector">color </span><span class="token hexcode">#999</span>    <span class="token selector">font base-font-size FontAwesome</span>    <span class="token selector">margin-right </span><span class="token number">5</span><span class="token selector">px</span>    <span class="token selector">margin-top (</span><span class="token number">1</span><span class="token selector">/</span><span class="token number">3</span><span class="token selector">)rem</span><span class="token property-line"><span class="token property">.article-tag</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token property">before</span></span>    <span class="token selector">content </span><span class="token string">"\f02b"</span>    <span class="token selector">margin-left </span><span class="token number">1</span><span class="token selector">em</span><span class="token property-line"><span class="token property">.article-category</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token property">before</span></span>    <span class="token selector">content </span><span class="token string">"\f02d"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 <code>.article-category::before</code> 前插入：</p><pre class="line-numbers language-sass"><code class="language-sass"><span class="token number">.</span><span class="token selector">article-tag</span>    <span class="token number">.</span><span class="token selector">article-tag-list</span>        <span class="token selector">display flex</span>        <span class="token selector">flex-wrap wrap</span>    <span class="token selector">span</span>        <span class="token selector">cursor pointer</span>        <span class="token selector">line-height </span><span class="token number">29</span><span class="token selector">px</span>        <span class="token selector">font-size </span><span class="token number">13</span><span class="token selector">px</span>        <span class="token selector">color </span><span class="token hexcode">#aaa</span><span class="token property-line">        <span class="token property">&amp;</span><span class="token punctuation">:</span><span class="token property">before</span></span>            <span class="token selector">content </span><span class="token string">"\27A4"</span>            <span class="token selector">margin-left </span><span class="token number">1</span><span class="token selector">em</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>content: “\27A4” 是 unicode 图标编码，可以换成其他的</p><p><a href="https://unicode-table.com/cn" title=" 点击访问 " target="_blank" rel="noopener">unicode 图标</a></p><p><a href="http://fontawesome.io/icons" title=" 点击访问 " target="_blank" rel="noopener">Font Awesome Icon</a></p><hr><h2 id="添加音乐播放器"><a href="#添加音乐播放器" class="headerlink" title="添加音乐播放器"></a>添加音乐播放器</h2><ul><li>网易云 <code>iframe</code> 标签<br>到网易云网页上找喜欢的歌，点击生产外链播放器，获取 <code>iframe</code> 标签代码，粘贴到想放的地方即可，也可以直接贴在 markdown 文本中，<br>我就是这样在每篇文章中插入一首歌;</li></ul><p>如果不能正常打开生成外链的页面，只需要把歌曲或者歌单的 id（页面地址就有）记下来就好，标签格式如下</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span>  <span class="token attr-name">frameborder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>no<span class="token punctuation">"</span></span>  <span class="token attr-name">border</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>  <span class="token attr-name">marginwidth</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>  <span class="token attr-name">marginheight</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>  <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span>330</span>  <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span>450</span>  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>//music.163.com/outchain/player?type<span class="token punctuation">=</span>0&amp;id<span class="token punctuation">=</span>883067320&amp;auto<span class="token punctuation">=</span>1&amp;height<span class="token punctuation">=</span>430<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> // 歌曲 type=2，歌单 type=0，id 填对应 id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>使用 aplayer 插件 <a href="https://github.com/MoePlayer/hexo-tag-aplayer" title=" 点击访问 " target="_blank" rel="noopener">hexo-tag-aplayer</a></li></ul><p>安装：</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save hexo-tag-aplayer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用：</p><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token punctuation">{</span>% aplayer title author url <span class="token punctuation">[</span>picture_url, narrow, autoplay, width<span class="token punctuation">:</span>xxx, lrc<span class="token punctuation">:</span>xxx<span class="token punctuation">]</span> %<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>使用 aplayer 库配合 MetingJS 使用</li></ul><p>在主题的 _config.yml 文件底部添加两个库：</p><pre class="line-numbers language-diff"><code class="language-diff">CDN  ...<span class="token inserted">+  aplayer: //cdn.bootcss.com/aplayer/1.6.0/APlayer.min.js # https://github.com/MoePlayer/APlayer</span><span class="token inserted">+  meting: //unpkg.com/meting@1.0.1/dist/Meting.min.js # https://github.com/metowolf/MetingJS</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>目标文件：themes/yelee/layout/_partial/head.ejs</strong><br>在 jquery 后面导入库</p><pre class="line-numbers language-diff"><code class="language-diff"><span class="token deleted">&lt;script src="&lt;%- theme.CDN.jquery %>">&lt;/script></span><span class="token inserted">+ &lt;script src="&lt;%- theme.CDN.aplayer %>">&lt;/script></span><span class="token inserted">+ &lt;script src="&lt;%- theme.CDN.meting %>">&lt;/script></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>使用：粘贴以下代码生成播放器</p><pre class="line-numbers language-html"><code class="language-html">&lt;div  class="aplayer"  data-id="883067320"   // 歌曲 / 专辑 / 歌单 ID  data-server="netease" // 音乐平台：netease、tencent、xiami、kugou、baidu  data-type="playlist"  // 类型：song、album、playlist、search、artist  data-mode="random"    // 播放模式：random、single、circulation、order  data-autoplay="true"  // 自动播放  ><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="简化添加音乐的方法"><a href="#简化添加音乐的方法" class="headerlink" title="简化添加音乐的方法"></a>简化添加音乐的方法</h2><p>我喜欢在每篇文章放不同的歌曲，如果按上面的方法添加，每次都得在文章前粘贴一段代码，而且主页加载时也会加载两个 CDN 库，影响加载速度</p><pre class="line-numbers language-html"><code class="language-html">&lt;div  class="aplayer"  data-id="883067320" // 歌曲 ID  data-server="netease"  data-type="playlist"  data-mode="random"  data-autoplay="true"/><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面简化一下步骤</p><ol><li>修改 <code>/themes/yelee/layout/_partial/article.ejs</code> 如下</li></ol><pre class="line-numbers language-diff"><code class="language-diff"><span class="token deleted">&lt;div class="article-entry" itemprop="articleBody"></span>  &lt;% if (index &amp;&amp; (post.description || post.excerpt)){ %>      &lt;% if (post.description){ %>          &lt;%- post.description %>      &lt;% } else { %>          &lt;%- post.excerpt %>      &lt;% } %>  &lt;% } else { %>      &lt;% if (is_page()){ %>          &lt;%- partial('_partial/page') %>      &lt;% } %><span class="token inserted">+   &lt;% if (post.music){ %></span><span class="token inserted">+       &lt;%- partial('post/player') %></span><span class="token inserted">+   &lt;% } %></span>    &lt;%- post.content %>  &lt;% } %><span class="token deleted">&lt;/div></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>在 <code>/themes/yelee/layout/post/</code> 下创建 <code>player.ejs</code> 文件</li></ol><p>player:</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%- theme.CDN.aplayer %<span class="token punctuation">></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%- theme.CDN.player %<span class="token punctuation">></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>aplayer<span class="token punctuation">"</span></span> <span class="token attr-name">data-id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%<span class="token punctuation">=</span> post.music %<span class="token punctuation">></span><span class="token punctuation">"</span></span> <span class="token attr-name">data-server</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>netease<span class="token punctuation">"</span></span> <span class="token attr-name">data-type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>song<span class="token punctuation">"</span></span> <span class="token attr-name">data-autoplay</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">16</span>px</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span>  // 去除移动端的播放器, 减少流量消耗  if ($(".left-col").css("display") === "none") {    $(".aplayer").remove();  }<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里引入了 cdn 库，如果上文在 head 也引入这两个文件，那可以把 head 里的删了</p><ol start="3"><li>每篇文章要加音乐时只需在顶部引入 <code>music: 歌曲 ID</code></li></ol><pre class="line-numbers language-stylus"><code class="language-stylus">-----------<span class="token property-declaration"><span class="token property">title</span><span class="token punctuation">:</span> 使用 Hexo 主题 Yelee</span><span class="token property-declaration"><span class="token property">date</span><span class="token punctuation">:</span> <span class="token number">2017</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">24</span></span><span class="token property-declaration"><span class="token property">description</span><span class="token punctuation">:</span> <span class="token string">" 更换博客主题 Yelee 的前前后后 "</span></span><span class="token property-declaration"><span class="token property">top</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span><span class="token property-declaration"><span class="token property">music</span><span class="token punctuation">:</span> <span class="token number">729638</span></span><span class="token property-declaration"><span class="token property">categories</span><span class="token punctuation">:</span> Web</span><span class="token property-declaration"><span class="token property">tags</span><span class="token punctuation">:</span> Yelee</span>---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Aplayer-Fixed"><a href="#Aplayer-Fixed" class="headerlink" title="Aplayer Fixed"></a>Aplayer Fixed</h2><p>后来 Aplayer 更新了 Fixed 模式，功能算是最完整的</p><p>之前的修改可以弃用，player.ejs 可以改成如下:</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%- theme.CDN.aplayer %<span class="token punctuation">></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>aplayer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/js/player.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>player.js</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token operator">!</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'none'</span> <span class="token operator">!==</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.left-col'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'display'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">APlayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      element<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'aplayer'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      mutex<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">,</span>      theme<span class="token punctuation">:</span> <span class="token string">'#EBEEDF'</span><span class="token punctuation">,</span>      order<span class="token punctuation">:</span> <span class="token string">'random'</span><span class="token punctuation">,</span>      lrcType<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>      fixed<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">,</span> listid <span class="token operator">=</span> <span class="token number">883067320</span> <span class="token comment" spellcheck="true">// 歌单 ID</span>    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'https://api.i-meto.com/meting/api?server=netease&amp;type=playlist&amp;id='</span> <span class="token operator">+</span> listid<span class="token punctuation">)</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>onreadystatechange <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token number">4</span> <span class="token operator">===</span> xhr<span class="token punctuation">.</span>readyState <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">200</span> <span class="token operator">===</span> xhr<span class="token punctuation">.</span>status <span class="token operator">?</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 获取失败时的默认歌曲</span>        title<span class="token punctuation">:</span> <span class="token string">'Fell For U'</span><span class="token punctuation">,</span>        author<span class="token punctuation">:</span> <span class="token string">'Noicybino'</span><span class="token punctuation">,</span>        url<span class="token punctuation">:</span> <span class="token string">'https://example.com/FellForU.mp3'</span><span class="token punctuation">,</span>        pic<span class="token punctuation">:</span> <span class="token string">'/img/love.png'</span><span class="token punctuation">,</span>        lrc<span class="token punctuation">:</span> <span class="token string">''</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="修改头像动画"><a href="#修改头像动画" class="headerlink" title="修改头像动画"></a>修改头像动画</h2><p><strong>目标文件：themes/yelee/source/css/_partial/main.styl</strong></p><p>修改头像为旋转效果：</p><pre class="line-numbers language-css"><code class="language-css">    <span class="token number">...</span>    // <span class="token property">animation</span><span class="token punctuation">:</span> profilepic <span class="token number">.15</span>s linear infinite alternate<span class="token punctuation">;</span>    // <span class="token property">-webkit-animation</span><span class="token punctuation">:</span> profilepic <span class="token number">.15</span>s linear infinite alternate<span class="token punctuation">;</span>    <span class="token property">animation</span><span class="token punctuation">:</span> profilepic <span class="token number">5</span>s linear infinite<span class="token punctuation">;</span>    <span class="token property">-webkit-animation</span><span class="token punctuation">:</span> profilepic <span class="token number">5</span>s linear infinite<span class="token punctuation">;</span> // profilepic 动画，周期 <span class="token number">5</span> 秒，速度不变，无限循环<span class="token punctuation">}</span><span class="token atrule"><span class="token rule">@keyframes</span> profilepic</span> <span class="token punctuation">{</span>    <span class="token selector">0% </span><span class="token punctuation">{</span>        // <span class="token property">right</span><span class="token punctuation">:</span> <span class="token number">4</span>px<span class="token punctuation">;</span>        // <span class="token property">top</span><span class="token punctuation">:</span> <span class="token number">1</span>x<span class="token punctuation">;</span>        <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token number">360</span>deg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token selector">100% </span><span class="token punctuation">{</span>        // <span class="token property">right</span><span class="token punctuation">:</span> <span class="token number">0</span>px<span class="token punctuation">;</span>        // <span class="token property">top</span><span class="token punctuation">:</span> -<span class="token number">1</span>px<span class="token punctuation">;</span>        <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token number">0</span>deg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>animation: name duration timing-function delay iteration-count direction;</code><br>animation 是 CSS 动画属性：第一个参数是用 @keyframes 定义的动画，第二个参数是单次动画持续时间，<br>第三个是动画的速度曲线，第四个参数是动画开始之前的延迟，第五个是动画应该播放的次数，最后一个规定是否应该轮流反向播放动画</p><h2 id="添加多合一打赏"><a href="#添加多合一打赏" class="headerlink" title="添加多合一打赏"></a>添加多合一打赏</h2><p>实现原理和源码见博文: <a href="https://mkblog.cn/922/" target="_blank" rel="noopener">https://mkblog.cn/922/</a></p><p>给 yelee 的配置文件 <code>_config.yml</code> 加上：</p><pre class="line-numbers language-stylus"><code class="language-stylus"># 打赏# 将 on 改为 false 去掉打赏donate<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">on</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">multipay</span><span class="token punctuation">:</span> <span class="token operator">/</span>img<span class="token operator">/</span>multipay<span class="token operator">.</span>png</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>multipay.png 上的二维码指向链接 <a href="https://blog.wangriyu.wang/pages/donate">https://blog.wangriyu.wang/pages/donate</a> , 然后根据用户的 userAgent 转向不同服务</p><p><strong>目标文件：themes/yelee/layout/_partial/left-col.ejs</strong><br>找到</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>header-nav<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>social<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>%</span> <span class="token attr-name">for</span> <span class="token attr-name">(var</span> <span class="token attr-name">i</span> <span class="token attr-name">in</span> <span class="token attr-name">theme.subnav){</span> <span class="token attr-name">%</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fa &lt;%<span class="token punctuation">=</span> i %<span class="token punctuation">></span><span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%- url_for(theme.subnav[i]) %<span class="token punctuation">></span><span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%<span class="token punctuation">=</span> i %<span class="token punctuation">></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>%}%</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 <code>&lt;/ul&gt;</code> 下添加：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>%</span> <span class="token attr-name">if</span> <span class="token attr-name">(theme.donate.on)</span> <span class="token attr-name">{</span> <span class="token attr-name">%</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>social<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span> <span class="token property">top</span><span class="token punctuation">:</span> <span class="token number">95%</span><span class="token punctuation">;</span> <span class="token property">left</span><span class="token punctuation">:</span> <span class="token number">50%</span><span class="token punctuation">;</span> <span class="token property">margin-left</span><span class="token punctuation">:</span> -<span class="token number">30</span>px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">display</span><span class="token punctuation">:</span> block</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span>                    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>donateIcon<span class="token punctuation">"</span></span>                    <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:void(0)<span class="token punctuation">"</span></span>                    <span class="token attr-name">onmouseout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>                        var qr <span class="token punctuation">=</span> document.getElementById(<span class="token punctuation">'</span>donate<span class="token punctuation">'</span>);                        qr.style.display<span class="token punctuation">=</span><span class="token punctuation">'</span>none<span class="token punctuation">'</span>;                    <span class="token punctuation">"</span></span>                    <span class="token attr-name">onmouseenter</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>                        var qr <span class="token punctuation">=</span> document.getElementById(<span class="token punctuation">'</span>donate<span class="token punctuation">'</span>);                        qr.style.display<span class="token punctuation">=</span><span class="token punctuation">'</span>block<span class="token punctuation">'</span>;                    <span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    赏                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>%</span> <span class="token attr-name">}</span> <span class="token attr-name">%</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 <code>left-col.ejs</code> 文件末尾 <code>&lt;/div&gt;</code> 之前添加：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>%</span> <span class="token attr-name">if</span> <span class="token attr-name">(theme.donate.multipay)</span> <span class="token attr-name">{</span> <span class="token attr-name">%</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>donate<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>multipay<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%<span class="token punctuation">=</span>theme.donate.multipay%<span class="token punctuation">></span><span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>250px<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%<span class="token punctuation">=</span>theme.author%<span class="token punctuation">></span> Multipay<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>triangle<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>%</span> <span class="token attr-name">}</span> <span class="token attr-name">%</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>目标文件：themes/yelee/source/css/_partial/customise/social-icon.styl</strong><br>在顶部找到找到</p><pre class="line-numbers language-sass"><code class="language-sass"><span class="token selector">#header </span><span class="token number">.</span><span class="token selector">header-nav </span><span class="token number">.</span><span class="token selector">social</span>    <span class="token selector">margin-top </span><span class="token number">10</span><span class="token selector">px</span>    <span class="token selector">text-align center</span>    <span class="token selector">font-family Arial</span>    <span class="token selector">a</span>        <span class="token selector">width base-font-size + </span><span class="token number">21</span>        <span class="token selector">height @width</span>        <span class="token selector">border-radius </span><span class="token number">50%</span>        <span class="token selector">margin </span><span class="token number">0</span> <span class="token number">2</span><span class="token selector">px </span><span class="token number">6</span><span class="token selector">px</span>        <span class="token selector">vertical-align middle</span>        <span class="token selector">font-size </span><span class="token number">.66</span><span class="token selector">*@width</span>        <span class="token selector">line-height @width</span>        <span class="token selector">text-align center</span>        <span class="token selector">color white</span>        <span class="token selector">background </span><span class="token hexcode">#6f7170</span>        <span class="token selector">opacity i-opacity</span>        <span class="token selector">box-shadow </span><span class="token number">1</span><span class="token selector">px </span><span class="token number">2</span><span class="token selector">px </span><span class="token number">2</span><span class="token selector">px </span><span class="token function">rgba</span><span class="token selector">(</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0</span><span class="token selector">, </span><span class="token number">.1</span><span class="token selector">), </span><span class="token number">1</span><span class="token selector">px </span><span class="token number">1</span><span class="token selector">px </span><span class="token number">3</span><span class="token selector">px </span><span class="token function">rgba</span><span class="token selector">(</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0</span><span class="token selector">, </span><span class="token number">.3</span><span class="token selector">)</span><span class="token property-line">        <span class="token property">&amp;</span><span class="token punctuation">:</span><span class="token property">hover</span></span>            <span class="token selector">opacity </span><span class="token number">1</span>            <span class="token selector">transform </span><span class="token function">scale</span><span class="token selector">(</span><span class="token number">1.1</span><span class="token selector">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 <code>a</code> 标签的样式后面加上</p><pre class="line-numbers language-sass"><code class="language-sass"><span class="token number">.</span><span class="token selector">donateIcon</span>    <span class="token selector">display block</span>    <span class="token selector">width </span><span class="token number">56</span><span class="token selector">px</span>    <span class="token selector">margin auto</span>    <span class="token selector">height </span><span class="token number">56</span><span class="token selector">px</span>    <span class="token selector">line-height </span><span class="token number">56</span><span class="token selector">px</span>    <span class="token selector">font-size </span><span class="token number">20</span><span class="token selector">px</span>    <span class="token selector">color </span><span class="token hexcode">#fff</span>    <span class="token selector">border none</span>    <span class="token selector">background </span><span class="token hexcode">#4094c7</span>    <span class="token selector">border-radius </span><span class="token number">50%</span>    <span class="token selector">text-align center</span>    <span class="token selector">-webkit-box-shadow </span><span class="token number">0</span> <span class="token number">2</span><span class="token selector">px </span><span class="token number">5</span><span class="token selector">px </span><span class="token number">0</span> <span class="token function">rgba</span><span class="token selector">(</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0.16</span><span class="token selector">), </span><span class="token number">0</span> <span class="token number">2</span><span class="token selector">px </span><span class="token number">10</span><span class="token selector">px </span><span class="token number">0</span> <span class="token function">rgba</span><span class="token selector">(</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0.12</span><span class="token selector">)</span>    <span class="token selector">box-shadow </span><span class="token number">0</span> <span class="token number">2</span><span class="token selector">px </span><span class="token number">5</span><span class="token selector">px </span><span class="token number">0</span> <span class="token function">rgba</span><span class="token selector">(</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0.16</span><span class="token selector">), </span><span class="token number">0</span> <span class="token number">2</span><span class="token selector">px </span><span class="token number">10</span><span class="token selector">px </span><span class="token number">0</span> <span class="token function">rgba</span><span class="token selector">(</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0</span><span class="token selector">,</span><span class="token number">0.12</span><span class="token selector">)</span>    <span class="token selector">-webkit-transition </span><span class="token number">0.4</span><span class="token selector">s ease-in-out</span>    <span class="token selector">-moz-transition </span><span class="token number">0.4</span><span class="token selector">s ease-in-out</span>    <span class="token selector">-ms-transition </span><span class="token number">0.4</span><span class="token selector">s ease-in-out</span>    <span class="token selector">transition </span><span class="token number">0.4</span><span class="token selector">s ease-in-out</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>目标文件：themes/yelee/source/css/_partial/main.styl</strong><br>找到 <code>intrude-less</code> 并加上 donate 标签的样式：</p><pre class="line-numbers language-diff"><code class="language-diff">.intrude-less {    width: 76%;    text-align: center;    margin: 112px auto 0;<span class="token inserted">+   #donate {</span><span class="token inserted">+       display: none;</span><span class="token inserted">+       position: fixed;</span><span class="token inserted">+       top: 280px;</span><span class="token inserted">+       left: 25px;</span><span class="token inserted">+       img {</span><span class="token inserted">+           border-radius: 5px;</span><span class="token inserted">+       }</span><span class="token inserted">+       .triangle {</span><span class="token inserted">+           height: 0;</span><span class="token inserted">+           width: 0;</span><span class="token inserted">+           margin: -5px 0 0 85px;</span><span class="token inserted">+           border-right: 45px solid transparent;</span><span class="token inserted">+           border-left: 45px solid transparent;</span><span class="token inserted">+           border-top: 30px solid #5b91ee;</span><span class="token inserted">+       }</span><span class="token inserted">+   }</span>}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="修改移动端背景"><a href="#修改移动端背景" class="headerlink" title="修改移动端背景"></a>修改移动端背景</h2><p><strong>目标文件：themes/yelee/layout/_partial/background.ejs</strong></p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>theme<span class="token punctuation">.</span>background_image<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">></span>  <span class="token operator">&lt;</span>script<span class="token operator">></span>    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> iPad <span class="token operator">=</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'iPad'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>iPad <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> bgColorList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"#9db3f4"</span><span class="token punctuation">,</span> <span class="token string">"#414141"</span><span class="token punctuation">,</span> <span class="token string">"#e5a859"</span><span class="token punctuation">,</span> <span class="token string">"#f5dfc6"</span><span class="token punctuation">,</span> <span class="token string">"#c084a0"</span><span class="token punctuation">,</span> <span class="token string">"#847e72"</span><span class="token punctuation">,</span> <span class="token string">"#cd8390"</span><span class="token punctuation">,</span> <span class="token string">"#996731"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> bgColor <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>bgColorList<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"background-color"</span><span class="token punctuation">:</span> bgColorList<span class="token punctuation">[</span>bgColor<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"background-size"</span><span class="token punctuation">:</span> <span class="token string">"cover"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".left-col"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">"display"</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"none"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span>          <span class="token string">"background-image"</span><span class="token punctuation">:</span> <span class="token string">"url(&lt;%- theme.root_url %>/background/mobile.jpg)"</span><span class="token punctuation">,</span>          <span class="token string">"background-repeat"</span><span class="token punctuation">:</span> <span class="token string">"no-repeat"</span><span class="token punctuation">,</span>          <span class="token string">"background-attachment"</span><span class="token punctuation">:</span> <span class="token string">"fixed"</span><span class="token punctuation">,</span>          <span class="token string">"background-size"</span><span class="token punctuation">:</span> <span class="token string">"cover"</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> backgroundnum <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">=</span> theme<span class="token punctuation">.</span>background_image <span class="token operator">%</span><span class="token operator">></span><span class="token punctuation">;</span>        <span class="token keyword">var</span> backgroundimg <span class="token operator">=</span> <span class="token string">"url(&lt;%- theme.root_url %>/background/bg-x.jpg)"</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/x/gi</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> backgroundnum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span>          <span class="token string">"background"</span><span class="token punctuation">:</span> backgroundimg<span class="token punctuation">,</span>          <span class="token string">"background-position"</span><span class="token punctuation">:</span> <span class="token string">"0% 80%"</span><span class="token punctuation">,</span>          <span class="token string">"background-attachment"</span><span class="token punctuation">:</span> <span class="token string">"fixed"</span><span class="token punctuation">,</span>          <span class="token string">"background-size"</span><span class="token punctuation">:</span> <span class="token string">"cover"</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="修改列表显示的-bug"><a href="#修改列表显示的-bug" class="headerlink" title="修改列表显示的 bug"></a>修改列表显示的 bug</h2><p>bug 如下：Expressions 和 xScope 的前缀消失<br><img src="https://src.wangriyu.wang/images/blog/hexo/list.png" alt="image"></p><p>markdown 中编写无序列表时，比如 “- [列表名]”, 如果列表名前两个字符含 ‘x’, 则列表前缀消失</p><p>排查之后发现是 main.js 里对无序列表进行了判断，若出现 “- [ ]” 或者 “- [x]”，则解析成复选框的样式，需要修改判断条件</p><p><strong>目标文件：themes/yelee/source/js/main.js</strong></p><pre class="line-numbers language-diff"><code class="language-diff">// Task lists in markdown$('ul > li').each(function() {    var taskList = {<span class="token deleted">-       field: this.textContent.substring(0, 2),</span><span class="token inserted">+       field: this.textContent.substring(0, 3),</span>        check: function(str) {<span class="token deleted">-           var re = new RegExp(str);</span><span class="token deleted">-           return this.field.match(re);</span><span class="token inserted">+           return this.field === str;</span>        }    }    ...}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="添加-404-文字特效"><a href="#添加-404-文字特效" class="headerlink" title="添加 404 文字特效"></a>添加 404 文字特效</h2><p>原文字特效: <a href="/pages/yun.html">点击查看</a></p><p>如果没有 404 页面，先用 Hexo 命令新建一个名为 404 的页面: <code>hexo new page 404</code></p><p>将 <code>/source/404/index.md</code> 文件的内容修改如下:</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token operator">--</span><span class="token operator">-</span>toc<span class="token punctuation">:</span> <span class="token boolean">false</span>comments<span class="token punctuation">:</span> <span class="token boolean">false</span>permalink<span class="token punctuation">:</span> <span class="token operator">/</span><span class="token number">404</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"//cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.5/pixi.min.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"yun"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span>    <span class="token comment" spellcheck="true">/**     *  404 页面     */</span>    <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">var</span> lastTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>         <span class="token keyword">var</span> vendors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'ms'</span><span class="token punctuation">,</span> <span class="token string">'moz'</span><span class="token punctuation">,</span> <span class="token string">'webkit'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> vendors<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>window<span class="token punctuation">.</span>requestAnimationFrame<span class="token punctuation">;</span> <span class="token operator">++</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>           window<span class="token punctuation">.</span>requestAnimationFrame <span class="token operator">=</span> window<span class="token punctuation">[</span>vendors<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'RequestAnimationFrame'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>           window<span class="token punctuation">.</span>cancelAnimationFrame <span class="token operator">=</span> window<span class="token punctuation">[</span>vendors<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'CancelAnimationFrame'</span><span class="token punctuation">]</span> <span class="token operator">||</span> window<span class="token punctuation">[</span>vendors<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'CancelRequestAnimationFrame'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>requestAnimationFrame<span class="token punctuation">)</span>           window<span class="token punctuation">.</span>requestAnimationFrame <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">var</span> currTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">var</span> timeToCall <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span> <span class="token operator">-</span> <span class="token punctuation">(</span>currTime <span class="token operator">-</span> lastTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">var</span> id <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token function">callback</span><span class="token punctuation">(</span>currTime <span class="token operator">+</span> timeToCall<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span><span class="token punctuation">,</span>               timeToCall<span class="token punctuation">)</span><span class="token punctuation">;</span>             lastTime <span class="token operator">=</span> currTime <span class="token operator">+</span> timeToCall<span class="token punctuation">;</span>             <span class="token keyword">return</span> id<span class="token punctuation">;</span>           <span class="token punctuation">}</span><span class="token punctuation">;</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>cancelAnimationFrame<span class="token punctuation">)</span>           window<span class="token punctuation">.</span>cancelAnimationFrame <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token function">clearTimeout</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//math2 utils</span>    <span class="token keyword">var</span> Math2<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    Math2<span class="token punctuation">.</span>random <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>t<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">+</span> t    <span class="token punctuation">}</span><span class="token punctuation">,</span> Math2<span class="token punctuation">.</span>map <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>t<span class="token punctuation">,</span> n<span class="token punctuation">,</span> r<span class="token punctuation">,</span> a<span class="token punctuation">,</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token punctuation">(</span>o <span class="token operator">-</span> a<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">-</span> n<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>r <span class="token operator">-</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> a    <span class="token punctuation">}</span><span class="token punctuation">,</span> Math2<span class="token punctuation">.</span>randomPlusMinus <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> t <span class="token operator">=</span> t <span class="token operator">?</span> t <span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token number">5</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> t <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> Math2<span class="token punctuation">.</span>randomInt <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>t<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> n <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">+</span> t<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> Math2<span class="token punctuation">.</span>randomBool <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> t <span class="token operator">=</span> t <span class="token operator">?</span> t <span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token number">5</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> t <span class="token operator">?</span> <span class="token operator">!</span><span class="token number">0</span> <span class="token punctuation">:</span> <span class="token operator">!</span><span class="token number">1</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> Math2<span class="token punctuation">.</span>degToRad <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> rad <span class="token operator">=</span> t <span class="token operator">*</span> Math<span class="token punctuation">.</span>PI <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">,</span> rad    <span class="token punctuation">}</span><span class="token punctuation">,</span> Math2<span class="token punctuation">.</span>radToDeg <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> deg <span class="token operator">=</span> <span class="token number">180</span> <span class="token operator">/</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span>PI <span class="token operator">*</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span> deg    <span class="token punctuation">}</span><span class="token punctuation">,</span> Math2<span class="token punctuation">.</span>rgbToHex <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">function</span> <span class="token function">n</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token string">"0"</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      t <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> r <span class="token operator">=</span> <span class="token function">n</span><span class="token punctuation">(</span>t<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">n</span><span class="token punctuation">(</span>t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">n</span><span class="token punctuation">(</span>t<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> r<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> Math2<span class="token punctuation">.</span>distance <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>t<span class="token punctuation">,</span> n<span class="token punctuation">,</span> r<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>r <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a <span class="token operator">-</span> n<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>a <span class="token operator">-</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//mouse</span>    <span class="token keyword">var</span> mousePos<span class="token operator">=</span><span class="token punctuation">{</span>      x<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>      y<span class="token punctuation">:</span><span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>      e <span class="token operator">=</span> e <span class="token operator">||</span> window<span class="token punctuation">.</span>event<span class="token punctuation">;</span>      <span class="token keyword">var</span> pageX <span class="token operator">=</span> e<span class="token punctuation">.</span>pageX <span class="token operator">-</span> <span class="token number">300</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> pageY <span class="token operator">=</span> e<span class="token punctuation">.</span>pageY <span class="token operator">+</span> <span class="token number">350</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>pageX <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>        pageX <span class="token operator">=</span> e<span class="token punctuation">.</span>clientX <span class="token operator">+</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollLeft <span class="token operator">+</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollLeft <span class="token operator">-</span> <span class="token number">300</span><span class="token punctuation">;</span>        pageY <span class="token operator">=</span> e<span class="token punctuation">.</span>clientY <span class="token operator">+</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop <span class="token operator">+</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">+</span> <span class="token number">350</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      mousePos <span class="token operator">=</span> <span class="token punctuation">{</span>        x<span class="token punctuation">:</span> pageX<span class="token punctuation">,</span>        y<span class="token punctuation">:</span> pageY<span class="token punctuation">,</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>      width<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>      height<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>      keyword<span class="token punctuation">:</span> <span class="token string">"404"</span><span class="token punctuation">,</span>      density<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>      densityText<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>      minDist<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// initialize canvas</span>    <span class="token keyword">var</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> options<span class="token punctuation">.</span>width<span class="token punctuation">;</span>    canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> options<span class="token punctuation">.</span>height<span class="token punctuation">;</span>    canvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> options<span class="token punctuation">.</span>width<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>    canvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> options<span class="token punctuation">.</span>height<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>    canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>    <span class="token keyword">var</span> renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PIXI<span class="token punctuation">.</span>autoDetectRenderer</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>width<span class="token punctuation">,</span> options<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token punctuation">{</span>      transparent<span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> stage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PIXI<span class="token punctuation">.</span>Container</span><span class="token punctuation">(</span><span class="token string">"0X000000"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"yun"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>renderer<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>    renderer<span class="token punctuation">.</span>view<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">"notFound"</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> imageData <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> particles <span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">positionParticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">positionText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">positionParticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"canvas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>      canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">350</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> context <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"2d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      context<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">"#000000"</span><span class="token punctuation">;</span>      context<span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token string">"300px 'Arial', sans-serif"</span><span class="token punctuation">;</span>      context<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>keyword<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> imageData <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      data <span class="token operator">=</span> imageData<span class="token punctuation">.</span>data<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// Iterate each row and column</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> imageData<span class="token punctuation">.</span>height<span class="token punctuation">;</span> i <span class="token operator">+</span><span class="token operator">=</span> options<span class="token punctuation">.</span>density<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> imageData<span class="token punctuation">.</span>width<span class="token punctuation">;</span> j <span class="token operator">+</span><span class="token operator">=</span> options<span class="token punctuation">.</span>density<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// Get the color of the pixel</span>          <span class="token keyword">var</span> color <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>j <span class="token operator">*</span> <span class="token punctuation">(</span>imageData<span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// If the color is black, draw pixels</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>color <span class="token operator">==</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">var</span> newPar <span class="token operator">=</span> <span class="token function">particle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            newPar<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>            particles<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newPar<span class="token punctuation">)</span><span class="token punctuation">;</span>            stage<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>newPar<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">positionText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"canvas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>      canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">120</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> context <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"2d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      context<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">"#000000"</span><span class="token punctuation">;</span>      context<span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token string">"80px 'Arial', sans-serif"</span><span class="token punctuation">;</span>      context<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span><span class="token string">"Not Found"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> imageData <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      data <span class="token operator">=</span> imageData<span class="token punctuation">.</span>data<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// Iterate each row and column</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> imageData<span class="token punctuation">.</span>height<span class="token punctuation">;</span> i <span class="token operator">+</span><span class="token operator">=</span> options<span class="token punctuation">.</span>densityText<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> imageData<span class="token punctuation">.</span>width<span class="token punctuation">;</span> j <span class="token operator">+</span><span class="token operator">=</span> options<span class="token punctuation">.</span>densityText<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// Get the color of the pixel</span>          <span class="token keyword">var</span> color <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>j <span class="token operator">*</span> <span class="token punctuation">(</span>imageData<span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// If the color is black, draw pixels</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>color <span class="token operator">==</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">var</span> newPar <span class="token operator">=</span> <span class="token function">particle</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            newPar<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>            particles<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newPar<span class="token punctuation">)</span><span class="token punctuation">;</span>            stage<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>newPar<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">particle</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>      $<span class="token keyword">this</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PIXI<span class="token punctuation">.</span>Graphics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>text <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        $<span class="token keyword">this</span><span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      $<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">beginFill</span><span class="token punctuation">(</span>0X5CC9F5<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> radius<span class="token punctuation">;</span>      $<span class="token keyword">this</span><span class="token punctuation">.</span>radius <span class="token operator">=</span> radius <span class="token operator">=</span> $<span class="token keyword">this</span><span class="token punctuation">.</span>text <span class="token operator">?</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3.5</span> <span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10.5</span><span class="token punctuation">;</span>      $<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> radius<span class="token punctuation">)</span><span class="token punctuation">;</span>      $<span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>radius<span class="token punctuation">;</span>      $<span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token operator">-</span><span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token punctuation">;</span>      $<span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">-</span><span class="token keyword">this</span><span class="token punctuation">.</span>height<span class="token punctuation">;</span>      $<span class="token keyword">this</span><span class="token punctuation">.</span>free <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      $<span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> Math2<span class="token punctuation">.</span><span class="token function">randomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      $<span class="token keyword">this</span><span class="token punctuation">.</span>v <span class="token operator">=</span> Math2<span class="token punctuation">.</span><span class="token function">randomPlusMinus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> Math2<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      $<span class="token keyword">this</span><span class="token punctuation">.</span>hovered <span class="token operator">=</span> <span class="token boolean">false</span>      $<span class="token keyword">this</span><span class="token punctuation">.</span>alpha <span class="token operator">=</span> Math2<span class="token punctuation">.</span><span class="token function">randomInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span>      $<span class="token keyword">this</span><span class="token punctuation">.</span>vy <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">5</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>      $<span class="token keyword">this</span><span class="token punctuation">.</span>vx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      $<span class="token keyword">this</span><span class="token punctuation">.</span>setPosition <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token keyword">this</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>          $<span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          $<span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">+</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          $<span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          $<span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">+</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">175</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>stage<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> particles<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> p <span class="token operator">=</span> particles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mousePos<span class="token punctuation">.</span>x <span class="token operator">></span> p<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> mousePos<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>x <span class="token operator">+</span> p<span class="token punctuation">.</span>size <span class="token operator">&amp;&amp;</span> mousePos<span class="token punctuation">.</span>y <span class="token operator">></span> p<span class="token punctuation">.</span>y <span class="token operator">&amp;&amp;</span> mousePos<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>y <span class="token operator">+</span> p<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>          p<span class="token punctuation">.</span>hovered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        p<span class="token punctuation">.</span>scale<span class="token punctuation">.</span>x <span class="token operator">=</span> p<span class="token punctuation">.</span>scale<span class="token punctuation">.</span>y <span class="token operator">=</span> scale <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">2.5</span> <span class="token operator">-</span> <span class="token punctuation">(</span>Math2<span class="token punctuation">.</span><span class="token function">distance</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> mousePos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> mousePos<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">160</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>x <span class="token operator">=</span> p<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token punctuation">.</span><span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>timer <span class="token operator">*</span> <span class="token punctuation">.</span><span class="token number">15</span><span class="token punctuation">)</span>        p<span class="token punctuation">.</span>y <span class="token operator">=</span> p<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token punctuation">.</span><span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>timer <span class="token operator">*</span> <span class="token punctuation">.</span><span class="token number">15</span><span class="token punctuation">)</span>        p<span class="token punctuation">.</span>timer <span class="token operator">=</span> p<span class="token punctuation">.</span>timer <span class="token operator">+</span> p<span class="token punctuation">.</span>v<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改样式: <code>themes/yelee/source/css/_partial/article.styl</code>，<br>在 <code>.article-entry</code> 子级中加上如下样式:</p><pre class="line-numbers language-css"><code class="language-css"><span class="token selector"><span class="token id">#notFound</span> </span><span class="token punctuation">{</span>  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>  <span class="token property">top</span><span class="token punctuation">:</span> <span class="token number">50%</span><span class="token punctuation">;</span>  <span class="token property">left</span><span class="token punctuation">:</span> <span class="token number">50%</span><span class="token punctuation">;</span>  <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">translateY</span><span class="token punctuation">(</span>-<span class="token number">50%</span><span class="token punctuation">)</span> <span class="token function">translateX</span><span class="token punctuation">(</span>-<span class="token number">50%</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">80%</span><span class="token punctuation">;</span>  <span class="token property">height</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token id">#yun</span> </span><span class="token punctuation">{</span>  <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">320</span>px<span class="token punctuation">;</span>  <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100%</span><span class="token punctuation">;</span>  <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token atrule"><span class="token rule">@media</span> only screen and <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 768px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>  <span class="token selector"><span class="token id">#yun</span> </span><span class="token punctuation">{</span>    <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">300</span>px<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token id">#notFound</span> </span><span class="token punctuation">{</span>    <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100%</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token atrule"><span class="token rule">@media</span> only screen and <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 425px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>  <span class="token selector"><span class="token id">#yun</span> </span><span class="token punctuation">{</span>    <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">200</span>px<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token id">#notFound</span> </span><span class="token punctuation">{</span>    <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">120%</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最终效果: <a href="/404.html">点击查看</a></p><blockquote><p>如果不想主题文件修改你添加的单页面内容，需要在站点配置文件中配置如下：</p><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token comment" spellcheck="true">//  单个文件夹下全部文件：skip_render: test/*</span><span class="token comment" spellcheck="true">//  单个文件夹下指定类型文件：skip_render: test/*.html</span><span class="token comment" spellcheck="true">//  单个文件夹下全部文件以及子目录:skip_render: test/**</span><span class="token comment" spellcheck="true">//  多个文件夹以及各种复杂情况：</span><span class="token comment" spellcheck="true">//  skip_render:</span><span class="token comment" spellcheck="true">//      - `test1/*.html`</span><span class="token comment" spellcheck="true">//      - `test2/**`</span>比如 skip_render<span class="token punctuation">:</span> pages/** 代表 source/pages/ 目录下所有东西都不会被修改<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h2 id="压缩优化静态文件"><a href="#压缩优化静态文件" class="headerlink" title="压缩优化静态文件"></a>压缩优化静态文件</h2><p>使用 <a href="https://github.com/chenzhutian/hexo-all-minifier" target="_blank" rel="noopener">hexo-all-minifier</a> 插件压缩 js、html、css 和图片</p><p>在博客目录安装插件 <code>npm install hexo-all-minifier --save</code></p><p>对于 Mac 用户，可能还需要安装以下依赖:</p><pre class="line-numbers language-bash"><code class="language-bash">$ brew <span class="token function">install</span> libtool automake autoconf nasm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在站点配置文件 <code>_config.yml</code> 中添加插件配置</p><pre class="line-numbers language-sass"><code class="language-sass"><span class="token selector">### hexo_all_minifier: https://github</span><span class="token number">.</span><span class="token selector">com/chenzhutian/hexo-all-minifier</span><span class="token property-line"><span class="token property">all_minifier</span><span class="token punctuation">:</span> true</span><span class="token property-line"><span class="token property">html_minifier</span><span class="token punctuation">:</span></span><span class="token property-line">  <span class="token property">enable</span><span class="token punctuation">:</span> true</span><span class="token property-line">  <span class="token property">ignore_error</span><span class="token punctuation">:</span> false</span><span class="token property-line">  <span class="token property">silent</span><span class="token punctuation">:</span> false <span class="token operator">/</span><span class="token operator">/</span> 设为 true 代表不输出压缩的信息日志，默认为 false</span><span class="token property-line"><span class="token property">css_minifier</span><span class="token punctuation">:</span></span><span class="token property-line">  <span class="token property">enable</span><span class="token punctuation">:</span> true</span><span class="token property-line">  <span class="token property">silent</span><span class="token punctuation">:</span> false</span><span class="token property-line">  <span class="token property">exclude</span><span class="token punctuation">:</span> <span class="token operator">/</span><span class="token operator">/</span> 排除此类型文件</span>    <span class="token selector">- </span><span class="token string">'*.min.css'</span><span class="token property-line"><span class="token property">js_minifier</span><span class="token punctuation">:</span></span><span class="token property-line">  <span class="token property">enable</span><span class="token punctuation">:</span> true</span><span class="token property-line">  <span class="token property">mangle</span><span class="token punctuation">:</span> true</span><span class="token property-line">  <span class="token property">silent</span><span class="token punctuation">:</span> false</span><span class="token property-line">  <span class="token property">exclude</span><span class="token punctuation">:</span></span>    <span class="token selector">- </span><span class="token string">'*.min.js'</span><span class="token property-line"><span class="token property">image_minifier</span><span class="token punctuation">:</span></span><span class="token property-line">  <span class="token property">enable</span><span class="token punctuation">:</span> true</span><span class="token property-line">  <span class="token property">interlaced</span><span class="token punctuation">:</span> true <span class="token operator">/</span><span class="token operator">/</span> 交错 gif 图实现渐进式渲染，默认为 false</span><span class="token property-line">  <span class="token property">multipass</span><span class="token punctuation">:</span> true <span class="token operator">/</span><span class="token operator">/</span> 压缩 svg 格式，默认 false</span><span class="token property-line">  <span class="token property">optimizationLevel</span><span class="token punctuation">:</span> 3 <span class="token operator">/</span><span class="token operator">/</span> 压缩级别 0~7，默认为 2</span><span class="token property-line">  <span class="token property">pngquant</span><span class="token punctuation">:</span> true <span class="token operator">/</span><span class="token operator">/</span> 使用 imagemin-pngquant 插件压缩 png，默认为 false</span><span class="token property-line">  <span class="token property">progressive</span><span class="token punctuation">:</span> true <span class="token operator">/</span><span class="token operator">/</span> 无损转换为渐进式</span><span class="token property-line">  <span class="token property">silent</span><span class="token punctuation">:</span> false</span><span class="token property-line">  <span class="token property">exclude</span><span class="token punctuation">:</span> <span class="token operator">/</span><span class="token operator">/</span> 排除指定类型的图片文件，比如 gif,jpg, png, 或 svg，默认为 null</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用 <code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo s --watch --debug</code> 命令查看加载信息</p><h2 id="添加谷歌站长并提交站点地图"><a href="#添加谷歌站长并提交站点地图" class="headerlink" title="添加谷歌站长并提交站点地图"></a>添加谷歌站长并提交站点地图</h2><p>验证网址：<a href="https://www.google.com/webmasters/tools/" target="_blank" rel="noopener">Search Console</a></p><p>然后安装 sitemap 生成器 <code>npm install hexo-generator-sitemap --save</code>，</p><p>在站点配置文件 <code>_config.yml</code> 中加上</p><pre class="line-numbers language-stylus"><code class="language-stylus">### sitemap<span class="token property-declaration"><span class="token property">sitemap</span><span class="token punctuation">:</span>  path<span class="token punctuation">:</span> sitemap<span class="token operator">.</span>xml</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>部署一遍博客目录下会多出一个 <code>sitemap.xml</code> 文件, 到谷歌站长里添加站点地图即可</p><p>这里提一点，搜索引擎会抓取路径在三级以内的地址，如果路径太多可能抓取不到，但 hexo 文章的路径默认会加上日期，比如 <code>http://wangriyu.wang/2017/08/24/Hexo/</code>，<br>在站点配置文件中修改一下 permalink(默认是:year/:month/:day/:title/)：</p><pre class="line-numbers language-stylus"><code class="language-stylus"># URL## If your site is put in a subdirectory, set url as 'http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//yoursite.com/child' and root as '/child/'</span><span class="token property-declaration"><span class="token property">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span></span><span class="token comment" spellcheck="true">//wangriyu.wang</span><span class="token property-declaration"><span class="token property">root</span><span class="token punctuation">:</span> <span class="token operator">/</span></span><span class="token property-declaration"><span class="token property">permalink</span><span class="token punctuation">:</span> <span class="token punctuation">:</span>title<span class="token operator">.</span>html</span>permalink_defaults<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在就不会加上日期了</p><h2 id="使用七牛云图床"><a href="#使用七牛云图床" class="headerlink" title="使用七牛云图床"></a>使用七牛云图床</h2><p><a href="https://portal.qiniu.com" target="_blank" rel="noopener">https://portal.qiniu.com</a><br>注册七牛云账号，进入对象存储，点击内容管理，上传图片或其他一些资源，上传完成便可以使用产生的外链来代替站内的图片资源，<br>七牛云还提供了图片处理的服务，添加水印、裁剪缩放等</p><h2 id="使用-Sentry-io-的错误收集服务"><a href="#使用-Sentry-io-的错误收集服务" class="headerlink" title="使用 Sentry.io 的错误收集服务"></a>使用 <a href="https://sentry.io" title=" 点击访问 " target="_blank" rel="noopener">Sentry.io</a> 的错误收集服务</h2><p>添加 CDN 库：<code>sentry: //cdn.ravenjs.com/3.18.1/raven.min.js</code></p><p>在 head.ejs 中加入以下代码</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%- theme.CDN.sentry %<span class="token punctuation">></span><span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span>Raven.config(' 服务地址 ').install()<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>服务地址改为注册得到的地址，例如 <a href="https://XXXXXXXXXXXX@sentry.io/XXXXXX" target="_blank" rel="noopener">https://XXXXXXXXXXXX@sentry.io/XXXXXX</a></p><p>之后打开 sentry 的网站查看，如果出现错误会一一记录下来<br><img src="https://src.wangriyu.wang/images/blog/hexo/error.png" alt="image"></p><p>该网站支持很多语言，可以嵌入到很多东西中，方便收集错误，但是不建议长期放在网站上，感觉会影响性能</p><h2 id="添加二次元人物"><a href="#添加二次元人物" class="headerlink" title="添加二次元人物"></a>添加二次元人物</h2><p>安装插件 <code>npm install -save hexo-helper-live2d</code></p><p>在站点配置文件 <code>_config.yml</code> 中添加:</p><pre class="line-numbers language-stylus"><code class="language-stylus">## live2d<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//github.com/EYHN/hexo-helper-live2d</span>live2d<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">enable</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">scriptFrom</span><span class="token punctuation">:</span> local</span>  <span class="token property-declaration"><span class="token property">pluginRootPath</span><span class="token punctuation">:</span> live2dw<span class="token operator">/</span></span>  <span class="token property-declaration"><span class="token property">model</span><span class="token punctuation">:</span>    use<span class="token punctuation">:</span> live2d_models<span class="token operator">/</span>live2d-widget-model-izumi </span><span class="token comment" spellcheck="true">// 加载本地 model 文件</span>    <span class="token property-declaration"><span class="token property">scale</span><span class="token punctuation">:</span> <span class="token number">1</span></span>    <span class="token property-declaration"><span class="token property">hHeadPos</span><span class="token punctuation">:</span> <span class="token number">0.5</span></span>    <span class="token property-declaration"><span class="token property">vHeadPos</span><span class="token punctuation">:</span> <span class="token number">0.618</span></span>  display<span class="token punctuation">:</span>    <span class="token property-declaration"><span class="token property">position</span><span class="token punctuation">:</span> right</span>    <span class="token property-declaration"><span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100</span></span>    <span class="token property-declaration"><span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">200</span></span>    <span class="token property-declaration"><span class="token property">hOffset</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">50</span></span>    <span class="token property-declaration"><span class="token property">vOffset</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">85</span></span>  <span class="token property-declaration"><span class="token property">mobile</span><span class="token punctuation">:</span>    show<span class="token punctuation">:</span> <span class="token boolean">false</span></span>  react<span class="token punctuation">:</span>    <span class="token property-declaration"><span class="token property">opacityDefault</span><span class="token punctuation">:</span> <span class="token number">0.9</span></span>    <span class="token property-declaration"><span class="token property">opacityOnHover</span><span class="token punctuation">:</span> <span class="token number">0.3</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="更换图片背景为动态背景"><a href="#更换图片背景为动态背景" class="headerlink" title="更换图片背景为动态背景"></a>更换图片背景为动态背景</h2><p>在 <code>layout.ejs</code> 文件中的 left-col 和 mid-col 之间插入</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/javascript"</span> src<span class="token operator">=</span><span class="token string">"https://cdn.jsdelivr.net/npm/bubbly-bg@1.0.0/dist/bubbly-bg.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span>  <span class="token keyword">var</span> userAgent <span class="token operator">=</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">;</span>  <span class="token function">bubbly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    blur<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    bubbleFunc<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">></span> <span class="token template-string"><span class="token string">`hsla(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, 100%, 50%, .3)`</span></span><span class="token punctuation">,</span>    bubbles<span class="token punctuation">:</span> userAgent<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/AppleWebKit.*Mobile.*/</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">15</span> <span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>    colorStart<span class="token punctuation">:</span> <span class="token string">"#fff4e6"</span><span class="token punctuation">,</span>    colorStop<span class="token punctuation">:</span> <span class="token string">"#ffe9e4"</span><span class="token punctuation">,</span>    compose<span class="token punctuation">:</span> <span class="token string">"source-over"</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后把 <code>after-footer</code> 文件中的 <code>&lt;%- partial(&#39;_partial/background&#39;) %&gt;</code> 删掉</p><h2 id="添加-Valine-评论系统"><a href="#添加-Valine-评论系统" class="headerlink" title="添加 Valine 评论系统"></a>添加 Valine 评论系统</h2><p><a href="https://blog.wangriyu.wang/2018/03-valine.html">https://blog.wangriyu.wang/2018/03-valine.html</a></p><h2 id="添加隐藏侧边栏按钮"><a href="#添加隐藏侧边栏按钮" class="headerlink" title="添加隐藏侧边栏按钮"></a>添加隐藏侧边栏按钮</h2><p>目标文件: themes/yelee/layout/layout.ejs</p><pre class="line-numbers language-diff"><code class="language-diff">    ...<span class="token inserted">+   &lt;div class="hide-left-col" title="隐藏侧栏"></span><span class="token inserted">+     &lt;i class="fa fa-angle-double-left">&lt;/i></span><span class="token inserted">+   &lt;/div></span>    &lt;div class="mid-col">      &lt;%- partial('_partial/mobile-nav', null, {cache: !config.relative_link}) %>      &lt;div class="body-wrap">&lt;%- body %>&lt;/div>      &lt;%- partial('_partial/footer') %>    &lt;/div><span class="token inserted">+   &lt;script type="application/javascript"></span><span class="token inserted">+     var hide = false, leftWidth = &lt;%- theme.left_col_width %>;</span><span class="token inserted">+     function hideLeftCol() {</span><span class="token inserted">+       if (hide) {</span><span class="token inserted">+         $(".left-col").width(leftWidth);</span><span class="token inserted">+         $(".left-col .intrude-less").css('display', '');</span><span class="token inserted">+         $("#tocButton").css('display', '');</span><span class="token inserted">+         ($('#switch-btn').css('display') === 'block' &amp;&amp; $('#switch-area').css('display') === 'block') || $('#toc').slideDown(320);</span><span class="token inserted">+         $(".hide-left-col").css("left", leftWidth).html('&lt;i class="fa fa-angle-double-left">&lt;/i>');</span><span class="token inserted">+         $(".mid-col").css("left", leftWidth)</span><span class="token inserted">+         $("#post-nav-button").css("left", leftWidth)</span><span class="token inserted">+         $("#post-nav-button > a:nth-child(2)").css("display", "block")</span><span class="token inserted">+         hide = false</span><span class="token inserted">+       } else {</span><span class="token inserted">+         $(".left-col").width(0);</span><span class="token inserted">+         $(".left-col .intrude-less").css('display', 'none');</span><span class="token inserted">+         $("#toc").css('display', 'none');</span><span class="token inserted">+         $("#tocButton").css('display', 'none');</span><span class="token inserted">+         $(".hide-left-col").css("left", 0).html('&lt;i class="fa fa-angle-double-right">&lt;/i>');</span><span class="token inserted">+         $(".mid-col").css("left", 0)</span><span class="token inserted">+         $("#post-nav-button").css("left", 0)</span><span class="token inserted">+         $("#post-nav-button > a:nth-child(2)").css("display", "none")</span><span class="token inserted">+         if ($(".post-list").is(":visible")) {</span><span class="token inserted">+           $("#post-nav-button .fa-bars,#post-nav-button .fa-times").toggle();</span><span class="token inserted">+           $(".post-list").toggle();</span><span class="token inserted">+         }</span><span class="token inserted">+         hide = true</span><span class="token inserted">+       }</span><span class="token inserted">+     }</span><span class="token inserted">+     $(".hide-left-col").click(function() {</span><span class="token inserted">+       hideLeftCol()</span><span class="token inserted">+     });</span><span class="token inserted">+   &lt;/script></span>    &lt;%- partial('_partial/after-footer') %>  &lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>目标文件: themes/yelee/source/css/_partial/main.styl</p><pre class="line-numbers language-diff"><code class="language-diff">.left-col {  ...}<span class="token inserted">+.hide-left-col {</span><span class="token inserted">+   z-index: 999;</span><span class="token inserted">+   cursor: pointer;</span><span class="token inserted">+   transition:all .2s ease-in;</span><span class="token inserted">+   position: fixed;</span><span class="token inserted">+   top: 0;</span><span class="token inserted">+   left: left-col-width;</span><span class="token inserted">+   text-align: center;</span><span class="token inserted">+   line-height: 30px;</span><span class="token inserted">+   display: block;</span><span class="token inserted">+   width: 30px;</span><span class="token inserted">+   height: 30px;</span><span class="token inserted">+   font-size: 28px;</span><span class="token inserted">+   background: none;</span><span class="token inserted">+   .fa {</span><span class="token inserted">+       color: rgb(255, 255, 255, .5);</span><span class="token inserted">+   }</span><span class="token inserted">+   &amp;:hover {</span><span class="token inserted">+       background: rgba(147, 181, 224, .3) !important;</span><span class="token inserted">+       .fa {</span><span class="token inserted">+           color: white;</span><span class="token inserted">+       }</span><span class="token inserted">+   }</span><span class="token inserted">+}</span>.mid-col {  ...}...@media screen and (max-width:768px) {<span class="token inserted">+   .hide-left-col {</span><span class="token inserted">+       display: none;</span><span class="token inserted">+   }</span>    @import "_partial/mobile"}...#post-nav-button {    left: left-col-width;    top: 61.8%;<span class="token inserted">+   transition: left .2s ease-in;</span>    a {        border-bottom-color: transparent;        background: none;        cursor: pointer;        .fa-times {            display: none;        }    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>目标文件: themes/yelee/source/css/_partial/mobile.styl</p><pre class="line-numbers language-diff"><code class="language-diff">.left-col {<span class="token deleted">-   display: none;</span><span class="token inserted">+   display: none !important;</span>}.mid-col {<span class="token deleted">-   left: 0;</span><span class="token inserted">+   left: 0 !important;</span>}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="使用-prism-代码高亮"><a href="#使用-prism-代码高亮" class="headerlink" title="使用 prism 代码高亮"></a>使用 prism 代码高亮</h2><p>安装插件 <code>npm i -S hexo-prism-plugin</code></p><p>将根目录 _config.yml 中 highlight 部分均设为 fasle，并添加 prism 配置项:</p><pre class="line-numbers language-diff"><code class="language-diff">highlight:<span class="token deleted">- enable: true</span><span class="token inserted">+ enable: false</span>  line_number: false  auto_detect: false  tab_replace:# prism# https://prismjs.com/#languages-list<span class="token inserted">+ prism_plugin:</span><span class="token inserted">+   mode: 'preprocess'   # realtime/preprocess</span><span class="token inserted">+   theme: 'a11y-dark'   # https://github.com/PrismJS/prism-themes#available-themes</span><span class="token inserted">+   line_number: true    # default false</span><span class="token inserted">+   custom_css:          # optional</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将主题的 _config.yml 的 highlight_style 删掉</p><pre class="line-numbers language-diff"><code class="language-diff"><span class="token deleted">-highlight_style:</span><span class="token deleted">-  on: false</span><span class="token deleted">-  inline_code: 3  # Value: 0 - 9 可选</span><span class="token deleted">-  code_block: 4  # Value: 0 - 4</span><span class="token deleted">-  # Set inline_code to style highlight text</span><span class="token deleted">-  # Chose a highlight theme for code block</span><span class="token deleted">-  # 通过 inline_code 切换内置文本高亮样式</span><span class="token deleted">-  # 通过 code_block 切换内置代码高亮配色主题</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>删除 themes/yelee/source/css/_partial/customise/ 下的 code-block.styl 和 inline-code.styl</p><p>删除 themes/yelee/source/css/_partial/highlight.styl</p><p>修改 mobile.styl:</p><pre class="line-numbers language-diff"><code class="language-diff">    .article-entry{        padding-left: 0;        padding-right: 0;<span class="token deleted">-       .highlight {</span><span class="token deleted">-           padding .35em .6em</span><span class="token deleted">-       }</span>    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改 themes/yelee/source/css/style.styl:</p><pre class="line-numbers language-diff"><code class="language-diff">@import "_partial/archive"@import "_partial/article"@import "_partial/archive"<span class="token deleted">- @import "_partial/highlight"</span>@import "_partial/footer"if share@ -117,4 +116,14 @@ if search@import "_partial/customise/color-scheme"if sidebar  @import "_partial/sidebar"  @import "_partial/sidebar"<span class="token inserted">+ .article-entry code</span><span class="token inserted">+   color gray</span><span class="token inserted">+   padding .05em .3em</span><span class="token inserted">+   border-radius 3px</span><span class="token inserted">+   box-shadow 1px 1px 1px rgba(0,0,0, .08)</span><span class="token inserted">+   background rgba(255, 250, 165, .7)</span><span class="token inserted">+ .article-entry pre code</span><span class="token inserted">+   padding 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>⚠️ 注意使用此插件时所有代码块都需要指定语言，否则无法加载高亮效果</p><p>语言列表 <a href="https://prismjs.com/#languages-list" target="_blank" rel="noopener">https://prismjs.com/#languages-list</a></p></blockquote><h2 id="升级-fancybox-图片浏览插件"><a href="#升级-fancybox-图片浏览插件" class="headerlink" title="升级 fancybox 图片浏览插件"></a>升级 fancybox 图片浏览插件</h2><p>修改主题的 _config.yml 中的 CDN:</p><pre class="line-numbers language-diff"><code class="language-diff">...<span class="token deleted">-  fancybox_js: //cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js</span><span class="token deleted">-  fancybox_css: //cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css</span><span class="token inserted">+  fancybox_js: //cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js</span><span class="token inserted">+  fancybox_css: //cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css</span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改 themes/yelee/source/js/main.js:</p><pre class="line-numbers language-diff"><code class="language-diff">// fancyBoxif(!!yiliaConfig.fancybox){    require([yiliaConfig.fancybox_js], function(pc){        var isFancy = $(".isFancy");        if(isFancy.length != 0){            var imgArr = $(".article-inner img");            for(var i=0,len=imgArr.length;i&lt;len;i++){                var src = imgArr.eq(i).attr("src");                var title = imgArr.eq(i).attr("alt");                if(typeof(title) == "undefined"){                    var title = imgArr.eq(i).attr("title");                }                var width = imgArr.eq(i).attr("width");                var height = imgArr.eq(i).attr("height");<span class="token deleted">-               imgArr.eq(i).replaceWith("&lt;a href='"+src+"' title='"+title+"' rel='fancy-group' class='fancy-ctn fancybox'>&lt;img src='"+src+"' width="+width+" height="+height+" title='"+title+"' alt='"+title+"'>&lt;/a>");</span><span class="token inserted">+               imgArr.eq(i).replaceWith("&lt;a class='fancy-ctn' href='"+src+"' title='"+title+"' data-fancybox='images' data-caption='"+src.substring(src.lastIndexOf("/")+1)+"'>&lt;img src='"+src+"' width="+width+" height="+height+" title='"+title+"' alt='"+title+"'>&lt;/a>");</span>            }<span class="token deleted">-           $(".article-inner .fancy-ctn").fancybox({ type: "image" });</span><span class="token inserted">+           $(".article-inner .fancy-ctn").fancybox({</span><span class="token inserted">+             loop: true,</span><span class="token inserted">+             touch: false,</span><span class="token inserted">+             toolbar: true,</span><span class="token inserted">+             wheel: false,</span><span class="token inserted">+             buttons: [</span><span class="token inserted">+               "fullScreen",</span><span class="token inserted">+               "thumbs",</span><span class="token inserted">+               "close"</span><span class="token inserted">+             ],</span><span class="token inserted">+           });</span>        }    })}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改 themes/yelee/source/css/style.styl，在最后面插入:</p><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token selector">....fancybox-image</span>  <span class="token property-declaration"><span class="token property">background</span> <span class="token hexcode">#ffffff</span></span><span class="token selector">#live2dcanvas</span>  <span class="token property-declaration"><span class="token property">z-index</span> <span class="token number">999</span> <span class="token important">!important</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="我的配置"><a href="#我的配置" class="headerlink" title="我的配置"></a>我的配置</h2><p>根目录配置 _config.yml:</p><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>highlight<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">enable</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">line_number</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">auto_detect</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">tab_replace</span><span class="token punctuation">:</span><span class="token operator">...</span></span><span class="token property-declaration"><span class="token property">archive_generator</span><span class="token punctuation">:</span>  per_page<span class="token punctuation">:</span> <span class="token number">25</span> ## 归档页面文章数量，如果值为 <span class="token number">0</span> 不分页</span># Extensions## Plugins<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//hexo.io/plugins/</span>### hexo_all_minifier<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//github.com/chenzhutian/hexo-all-minifier</span><span class="token property-declaration"><span class="token property">all_minifier</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>html_minifier<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">enable</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">ignore_error</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">silent</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>css_minifier<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">enable</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">silent</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">exclude</span><span class="token punctuation">:</span>    <span class="token operator">-</span> <span class="token string">'*.min.css'</span></span>js_minifier<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">enable</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">mangle</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">silent</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">exclude</span><span class="token punctuation">:</span>    <span class="token operator">-</span> <span class="token string">'*.min.js'</span></span>image_minifier<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">enable</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">interlaced</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">multipass</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">optimizationLevel</span><span class="token punctuation">:</span> <span class="token number">3</span></span>  <span class="token property-declaration"><span class="token property">pngquant</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">progressive</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">silent</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>## sitemap<span class="token property-declaration"><span class="token property">sitemap</span><span class="token punctuation">:</span>  path<span class="token punctuation">:</span> sitemap<span class="token operator">.</span>xml</span>## baidusitemap<span class="token property-declaration"><span class="token property">baidusitemap</span><span class="token punctuation">:</span>  path<span class="token punctuation">:</span> baidusitemap<span class="token operator">.</span>xml</span># RSSfeed<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">type</span><span class="token punctuation">:</span> rss2</span>  <span class="token property-declaration"><span class="token property">path</span><span class="token punctuation">:</span> atom<span class="token operator">.</span>xml</span>  <span class="token property-declaration"><span class="token property">limit</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">hub</span><span class="token punctuation">:</span>  content<span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">content_limit</span><span class="token punctuation">:</span>  content_limit_delim<span class="token punctuation">:</span></span>## https<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//github.com/huiwang/hexo-baidu-url-submit</span>baidu_url_submit<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">count</span><span class="token punctuation">:</span> <span class="token number">10</span> ## 提交最新链接</span>  <span class="token property-declaration"><span class="token property">host</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span></span><span class="token comment" spellcheck="true">//example.com ## 在百度站长平台中注册的域名</span>  <span class="token property-declaration"><span class="token property">token</span><span class="token punctuation">:</span> XXXXXXXXXXX ## 请注意这是您的秘钥， 所以请不要把博客源代码发布在公众仓库里<span class="token operator">!</span></span>  <span class="token property-declaration"><span class="token property">path</span><span class="token punctuation">:</span> baidu_urls<span class="token operator">.</span>txt ## 文本文档的地址， 新链接会保存在此文本文档里</span>## Themes<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//hexo.io/themes/</span><span class="token property-declaration"><span class="token property">theme</span><span class="token punctuation">:</span> Yelee</span># prism# https<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//prismjs.com/#languages-list</span>prism_plugin<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">mode</span><span class="token punctuation">:</span> <span class="token string">'preprocess'</span>   # realtime<span class="token operator">/</span>preprocess</span>  <span class="token property-declaration"><span class="token property">theme</span><span class="token punctuation">:</span> <span class="token string">'a11y-dark'</span>   # https<span class="token punctuation">:</span></span><span class="token comment" spellcheck="true">//github.com/PrismJS/prism-themes#available-themes</span>  <span class="token property-declaration"><span class="token property">line_number</span><span class="token punctuation">:</span> <span class="token boolean">true</span>    # default <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">custom_css</span><span class="token punctuation">:</span>          # optional</span>## live2d<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//github.com/EYHN/hexo-helper-live2d</span>live2d<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">enable</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">scriptFrom</span><span class="token punctuation">:</span> local</span>  <span class="token property-declaration"><span class="token property">pluginRootPath</span><span class="token punctuation">:</span> live2dw<span class="token operator">/</span></span>  model<span class="token punctuation">:</span>    <span class="token property-declaration"><span class="token property">use</span><span class="token punctuation">:</span> live2d_models<span class="token operator">/</span>live2d-widget-model-izumi</span>    <span class="token property-declaration"><span class="token property">scale</span><span class="token punctuation">:</span> <span class="token number">1</span></span>    <span class="token property-declaration"><span class="token property">hHeadPos</span><span class="token punctuation">:</span> <span class="token number">0.5</span></span>    <span class="token property-declaration"><span class="token property">vHeadPos</span><span class="token punctuation">:</span> <span class="token number">0.618</span></span>  display<span class="token punctuation">:</span>    <span class="token property-declaration"><span class="token property">position</span><span class="token punctuation">:</span> right</span>    <span class="token property-declaration"><span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100</span></span>    <span class="token property-declaration"><span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">200</span></span>    <span class="token property-declaration"><span class="token property">hOffset</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">50</span></span>    <span class="token property-declaration"><span class="token property">vOffset</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">85</span></span>  <span class="token property-declaration"><span class="token property">mobile</span><span class="token punctuation">:</span>    show<span class="token punctuation">:</span> <span class="token boolean">false</span></span>  react<span class="token punctuation">:</span>    <span class="token property-declaration"><span class="token property">opacityDefault</span><span class="token punctuation">:</span> <span class="token number">0.9</span></span>    <span class="token property-declaration"><span class="token property">opacityOnHover</span><span class="token punctuation">:</span> <span class="token number">0.3</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>主题配置 _config.yml:</p><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span># Link to your avatar | 填写头像地址<span class="token property-declaration"><span class="token property">avatar</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//example.com/avatar.jpg</span># 左栏背景<span class="token property-declaration"><span class="token property">left_col_bg</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//example.com/yule.jpg</span># >>> Conments 评论系统 &lt;&lt;&lt;# Chose ONE as your comment system and keep others disable<span class="token punctuation">.</span># 选一个作为网站评论系统，其他保持禁用。<span class="token property-declaration"><span class="token property">preload_comment</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>## false<span class="token punctuation">:</span> 当点击评论条等区域时再加载评论模块## false<span class="token punctuation">:</span> load comment's section until u click/hover on the bar/icon<span class="token property-declaration"><span class="token property">show_count</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>## 是否在主页文章标题旁显示评论数（多说、Disqus）## Add comment count after article titledisqus<span class="token punctuation">:</span>   <span class="token property-declaration"><span class="token property">on</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">shortname</span><span class="token punctuation">:</span> wangriyu</span>  # https<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//help.disqus.com/customer/en/portal/articles/466208-what-s-a-shortname-</span>  # It is unnecessary to enable disqus here if   # you have set <span class="token string">"disqus_shortname"</span> in your site's <span class="token string">"_config.yml"</span> duoshuo<span class="token punctuation">:</span>   <span class="token property-declaration"><span class="token property">on</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">domain</span><span class="token punctuation">:</span>   # 是否开启多说评论，http<span class="token punctuation">:</span></span><span class="token comment" spellcheck="true">//duoshuo.com/create-site/</span>  # 使用上面网址登陆你的多说，然后创建站点，在 domain 中填入你设定的域名前半部分  # http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//&lt;要填的部分>.duoshuo.com (domain只填上&lt;>里的内容，不要填整个网址)</span>youyan<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">on</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">id</span><span class="token punctuation">:</span>   # 是否开启友言评论，http<span class="token punctuation">:</span></span><span class="token comment" spellcheck="true">//www.uyan.cc/index.php</span>  # id 中填写你的友言用户数字ID，注册后进入后台管理即可查看  # 友言服务在 Web 环境下运行，普通本地环境无法查看，请部署后在线上测试。valine<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">on</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">appid</span><span class="token punctuation">:</span> XXXXXXXXX</span>  <span class="token property-declaration"><span class="token property">appkey</span><span class="token punctuation">:</span> XXXXXXXXXX</span>  <span class="token property-declaration"><span class="token property">verify</span><span class="token punctuation">:</span> <span class="token boolean">false</span> #验证码</span>  <span class="token property-declaration"><span class="token property">notify</span><span class="token punctuation">:</span> <span class="token boolean">true</span> #评论回复提醒</span>  <span class="token property-declaration"><span class="token property">avatar</span><span class="token punctuation">:</span> retro #评论列表头像样式：<span class="token string">''</span><span class="token operator">/</span>mm<span class="token operator">/</span>identicon<span class="token operator">/</span>monsterid<span class="token operator">/</span>wavatar<span class="token operator">/</span>retro<span class="token operator">/</span>hide</span>  <span class="token property-declaration"><span class="token property">placeholder</span><span class="token punctuation">:</span> Just do it <span class="token operator">!</span> #评论框占位符</span><span class="token property-declaration"><span class="token property">wildfire</span><span class="token punctuation">:</span>  on<span class="token punctuation">:</span> <span class="token boolean">false</span></span># >>> Style Customisation 样式自定义 &lt;&lt;&lt;# Background | 背景## <span class="token string">"5"</span><span class="token punctuation">:</span> show images form bg-1<span class="token punctuation">.</span>jpg to bg-5<span class="token punctuation">.</span>jpg in `/yelee/source/background/`## <span class="token string">"5"</span><span class="token punctuation">:</span> 显示`/yelee/source/background/`文件夹中 bg-1<span class="token punctuation">.</span>jpg 到 bg-5<span class="token punctuation">.</span>jpg 这5张图片## <span class="token string">"0"</span><span class="token punctuation">:</span> white-gray background | 淳朴灰白背景<span class="token property-declaration"><span class="token property">background_image</span><span class="token punctuation">:</span> <span class="token number">4</span></span># Base Font Size | 字号调节<span class="token property-declaration"><span class="token property">base_font_size</span><span class="token punctuation">:</span> <span class="token number">16</span>  #px<span class="token punctuation">,</span> <span class="token number">16</span> <span class="token operator">-</span> <span class="token number">24</span></span># 自定义文章「引用部分」的样式blockquote_style<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">on</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">blockquote</span><span class="token punctuation">:</span> <span class="token number">3</span>  # Value<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token operator">-</span> <span class="token number">7</span> 可选</span># Headings Style | 标题风格## 0-Yelee, 1-Yilia, 2-GitHub<span class="token property-declaration"><span class="token property">heading_style</span><span class="token punctuation">:</span> <span class="token number">0</span> # Value<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token operator">-</span> <span class="token number">2</span></span>## List style type <span class="token punctuation">(</span>ul<span class="token punctuation">)</span> | 无序列表项标记样式<span class="token property-declaration"><span class="token property">list_style</span><span class="token punctuation">:</span> <span class="token number">2</span>  # value<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token operator">-</span> <span class="token number">12</span> 可选</span># 左边栏宽度 px<span class="token property-declaration"><span class="token property">left_col_width</span><span class="token punctuation">:</span> <span class="token number">300</span></span># Copyright info<span class="token punctuation">.</span> of post | 文末版权信息<span class="token property-declaration"><span class="token property">copyright</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span># Table of contents | 文章目录toc<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">on</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">list_number</span><span class="token punctuation">:</span> <span class="token boolean">false</span> # 目录序号</span>  <span class="token property-declaration"><span class="token property">max_depth</span><span class="token punctuation">:</span> <span class="token number">6</span>  # <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">6</span> <span class="token punctuation">(</span>h1-h6<span class="token punctuation">)</span> 目录最大级数</span>  <span class="token property-declaration"><span class="token property">nowrap</span><span class="token punctuation">:</span> <span class="token boolean">true</span> # Keep title on same line | 目录标题不换行</span># Load jQuery UI to style tooltips# 工具提示框样式美化<span class="token property-declaration"><span class="token property">jquery_ui</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span># Max width of right cloumn | 限制右侧内容的宽带 limit_article_width<span class="token punctuation">:</span>   <span class="token property-declaration"><span class="token property">on</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">max_width</span><span class="token punctuation">:</span> <span class="token number">60</span> # em</span># >>> Small features | 小功能设置 &lt;&lt;&lt;# 是否开启边栏多标签切换# Birdhouse button in left column<span class="token property-declaration"><span class="token property">tagcloud</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span># Open link in a new tab | 是否在新窗口打开链接## `global` 0<span class="token punctuation">:</span> Set separately, 1<span class="token punctuation">:</span> Open all in new 2<span class="token punctuation">:</span> Open all in current## `global` 0<span class="token punctuation">:</span> 分开设置, 1<span class="token punctuation">:</span> 全部在新标签打开, 2<span class="token punctuation">:</span> 全部在<span class="token string">"当前"</span>标签打开open_in_new<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">global</span><span class="token punctuation">:</span> <span class="token number">0</span> # <span class="token number">0</span><span class="token operator">-</span><span class="token number">2</span></span>  <span class="token property-declaration"><span class="token property">title</span><span class="token punctuation">:</span> <span class="token boolean">false</span> # article title <span class="token operator">in</span> homepage 主页文章标题</span>  <span class="token property-declaration"><span class="token property">post</span><span class="token punctuation">:</span> <span class="token boolean">true</span> # link within post<span class="token operator">/</span>page 正文中的链接</span>  <span class="token property-declaration"><span class="token property">article_nav</span><span class="token punctuation">:</span> <span class="token boolean">false</span> # 导航</span>  <span class="token property-declaration"><span class="token property">mini_archives</span><span class="token punctuation">:</span> fasle # 迷你归档</span>  <span class="token property-declaration"><span class="token property">tags</span><span class="token punctuation">:</span> <span class="token boolean">false</span> # 标签</span>  <span class="token property-declaration"><span class="token property">categories</span><span class="token punctuation">:</span> <span class="token boolean">false</span> # 分类</span>  <span class="token property-declaration"><span class="token property">archives</span><span class="token punctuation">:</span> <span class="token boolean">false</span> # 归档</span>  <span class="token property-declaration"><span class="token property">menu</span><span class="token punctuation">:</span> <span class="token boolean">false</span> # 边栏菜单</span>  <span class="token property-declaration"><span class="token property">friends</span><span class="token punctuation">:</span> <span class="token boolean">true</span>  # 友情链接</span>  <span class="token property-declaration"><span class="token property">socail</span><span class="token punctuation">:</span> <span class="token boolean">true</span> # 社交图标</span># >>> Vendors | 第三方工具 &amp; 服务 &lt;&lt;&lt;# Local Site Search | 本地站内搜索## Insatall below plugin to take effect | 使用搜索需先安装对应插件## https<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//github.com/PaicHyperionDev/hexo-generator-search</span>search<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">on</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">onload</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  ## true<span class="token punctuation">:</span> get search<span class="token punctuation">.</span>xml file when the page has loaded  ## false<span class="token punctuation">:</span> get the file when search box gets focus# images viewer | 图片浏览器## http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//www.fancyapps.com/fancybox/</span><span class="token property-declaration"><span class="token property">fancybox</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span># Display <span class="token func"><span class="token function">Math</span><span class="token punctuation">(</span>LaTeX<span class="token punctuation">,</span> MathML<span class="token operator">...</span><span class="token punctuation">)</span> | 数学公式支持</span>## https<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//www.mathjax.org/</span><span class="token property-declaration"><span class="token property">mathjax</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span># Social Share | 是否开启分享share<span class="token punctuation">:</span>   <span class="token property-declaration"><span class="token property">on</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">spongebob</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">baidu</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">addthis</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">addthis_pubid</span><span class="token punctuation">:</span> <span class="token string">"ra-5992865c5fd0cfd1"</span></span>  ## Go to www<span class="token punctuation">.</span>addthis<span class="token punctuation">.</span>com/dashboard to get your pubid <span class="token punctuation">(</span>in src of Code<span class="token punctuation">)</span>  ## and customize AddThis share buttons# 不蒜子网站计数设置# http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//ibruce.info/2015/04/04/busuanzi/</span>visit_counter<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">on</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">site_visit</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">page_visit</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span># GitHub Repo Widget# https<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//github.com/hustcc/GitHub-Repo-Widget.js</span><span class="token property-declaration"><span class="token property">github_widget</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span># Progress Bar | 页面加载进度条# Demo<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//github.hubspot.com/pace/docs/welcome/</span># type<span class="token punctuation">:</span> barber-shop|big-counter|bounce|center-atom|center-circle|#       center-radar|center-simple|corner-indicator|flash|flat-top|#       loading-bar|mac-osx|minimal# color<span class="token punctuation">:</span> black|blue|green|orange|pink|purple|red|silver|white|yellow|progressBar<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">on</span><span class="token punctuation">:</span> <span class="token boolean">false</span></span>  <span class="token property-declaration"><span class="token property">type</span><span class="token punctuation">:</span> <span class="token string">"minimal"</span>  # Keep Quotes | 保留引号避免出错</span>  <span class="token property-declaration"><span class="token property">color</span><span class="token punctuation">:</span> orange</span># 打赏# 将on改为false去掉打赏donate<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">on</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span>  <span class="token property-declaration"><span class="token property">multipay</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//example.com/multipay.png</span><span class="token property-declaration"><span class="token property">CDN</span><span class="token punctuation">:</span>  jquery<span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//cdn.bootcss.com/jquery/2.2.4/jquery.min.js</span>  <span class="token property-declaration"><span class="token property">require</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//cdn.bootcss.com/require.js/2.2.0/require.min.js</span>  <span class="token property-declaration"><span class="token property">fontawesome</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css</span>  <span class="token property-declaration"><span class="token property">fancybox_js</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js</span>  <span class="token property-declaration"><span class="token property">fancybox_css</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css</span>  <span class="token property-declaration"><span class="token property">jquery_ui_js</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js</span>  <span class="token property-declaration"><span class="token property">jquery_ui_css</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css</span>  <span class="token property-declaration"><span class="token property">pace_js</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//cdn.bootcss.com/pace/1.0.2/pace.min.js</span>  <span class="token property-declaration"><span class="token property">mathjax</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//cdn.bootcss.com/mathjax/2.7.4/MathJax.js</span>  <span class="token property-declaration"><span class="token property">aplayer</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//example.com/lib/Aplayer/1.10.1/APlayer.min.js</span>  <span class="token property-declaration"><span class="token property">aplayer_css</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//example.com/lib/Aplayer/1.10.1/APlayer.min.css</span>  <span class="token property-declaration"><span class="token property">aos_css</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//example.com/lib/aos/2.2.0/aos.css</span>  <span class="token property-declaration"><span class="token property">aos_js</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//example.com/lib/aos/2.2.0/aos.js</span>  <span class="token property-declaration"><span class="token property">bubbly_bg</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//example.com/lib/bubbly-bg/1.0.0/bubbly-bg.js</span>  <span class="token property-declaration"><span class="token property">valine</span><span class="token punctuation">:</span> </span><span class="token comment" spellcheck="true">//example.com/lib/Valine/1.2.0/Valine.min.js</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>package.json 依赖项:</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"hexo"</span><span class="token operator">:</span> <span class="token string">"^3.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-all-minifier"</span><span class="token operator">:</span> <span class="token string">"^0.5.2"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-baidu-url-submit"</span><span class="token operator">:</span> <span class="token string">"0.0.5"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-deployer-git"</span><span class="token operator">:</span> <span class="token string">"^0.3.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-archive"</span><span class="token operator">:</span> <span class="token string">"^0.1.4"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-category"</span><span class="token operator">:</span> <span class="token string">"^0.1.3"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-feed"</span><span class="token operator">:</span> <span class="token string">"^1.2.2"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-index"</span><span class="token operator">:</span> <span class="token string">"^0.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-search"</span><span class="token operator">:</span> <span class="token string">"^2.2.5"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-sitemap"</span><span class="token operator">:</span> <span class="token string">"^1.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-tag"</span><span class="token operator">:</span> <span class="token string">"^0.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-helper-live2d"</span><span class="token operator">:</span> <span class="token string">"^3.0.2"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-prism-plugin"</span><span class="token operator">:</span> <span class="token string">"^2.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-renderer-ejs"</span><span class="token operator">:</span> <span class="token string">"^0.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-renderer-marked"</span><span class="token operator">:</span> <span class="token string">"^0.2.10"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-renderer-stylus"</span><span class="token operator">:</span> <span class="token string">"^0.3.1"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-server"</span><span class="token operator">:</span> <span class="token string">"^0.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-wordcount"</span><span class="token operator">:</span> <span class="token string">"^3.0.2"</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"hexo-generator-baidu-sitemap"</span><span class="token operator">:</span> <span class="token string">"^0.1.2"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>全部的目录结构:</p><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token selector">├── _config.yml├── live2d_models│   └── live2d-widget-model-izumi│       ├── assets│       │   ├── exp/│       │   ├── izumi.model.json│       │   ├── izumi.physics.json│       │   ├── moc│       │   │   ├── izumi_illust.1024│       │   │   │   ├── texture_00.png│       │   │   │   ├── texture_01.png│       │   │   │   ├── texture_02.png│       │   │   │   └── texture_03.png│       │   │   └── izumi_illust.moc│       │   ├── mtn/│       │   └── snd/│       ├── package-lock.json│       └── package.json├── node_modules├── package-lock.json├── package.json├── public├── source│   ├── 404│   │   └── index.md│   ├── _posts│   │   └── HellWorld.md│   ├── about│   │   ├── index.md│   │   └── resume.pdf│   ├── CNAME│   ├── images│   ├── pages│   │   ├── donate│   │   │   └── index.html│   │   ├── wildfire.html│   │   └── yun.html│   ├── robots.txt│   └── tags│       └── index.md└── themes</span>    <span class="token selector">└── yelee</span>        <span class="token selector">├── _config.yml        ├── languages/        ├── layout/        ├── package.json        ├── README.md        └── source</span>            ├── apple-touch-icon<span class="token punctuation">.</span>png            ├── background/            ├── css/            ├── favicon<span class="token punctuation">.</span>ico            ├── img/            ├── js/            └── share/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>我的所有修改都可以在仓库里找到：<a href="https://github.com/wangriyu/hexo-theme-yelee" title=" 点击访问 " target="_blank" rel="noopener">wangriyu/hexo-theme-yelee</a></p></blockquote>]]></content>
      
      <categories>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Yelee </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>浏览器本地存储</title>
      <link href="/2017/08-Storage.html"/>
      <url>/2017/08-Storage.html</url>
      <content type="html"><![CDATA[<h2 id="intro">前言</h2><blockquote><p>浏览器存储数据的几种方式</p></blockquote><ul><li>Cookies</li><li>Local Storage &amp; Session Storage</li><li>WebSQL &amp; IndexedDB</li></ul><a id="more"></a><h2 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h2><p>HTTP Cookie（也叫 Web cookie 或者浏览器 Cookie）是服务器发送到用户浏览器并保存在浏览器上的一块数据，它会在浏览器下一次发起请求时被携带并发送到服务器上。比较经典的，可以它用来确定两次请求是否来自于同一个浏览器，从而能够确认和保持用户的登录状态（类似 token）。对于购物网站而言，cookie 是非常重要的，为了实现购物车功能，把已选物品加入 cookie，可以实现不同页面之间数据的同步，同时在提交订单的时候又会把这些 cookie 传到后台。</p><p>Cookie 主要用在以下三个方面:</p><ul><li>会话状态管理（如用户登录状态、购物车）</li><li>个性化设置（如用户自定义设置）</li><li>浏览器行为跟踪（如跟踪分析用户行为）</li></ul><h3 id="1-创建-cookie"><a href="#1-创建-cookie" class="headerlink" title="1. 创建 cookie"></a>1. 创建 cookie</h3><p>当服务器收到 HTTP 请求（request）时，可以在响应头（headers）里面增加一个 Set-Cookie 头部。浏览器收到响应（response）之后会取出 Cookie 信息并保存，之后对该服务器每一次请求中都通过 Cookie 请求头部将 Cookie 信息发送给服务器。另外，Cookie 的过期时间、域、路径、有效期、站点都可以根据需要来指定<br>格式：</p><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token property-declaration"><span class="token property">Set-Cookie</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>cookie 名称<span class="token operator">></span> <span class="token operator">=</span> <span class="token operator">&lt;</span>cookie 值 <span class="token operator">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>服务器告诉客户端要保存 Cookie 信息， 响应的数据里面应该包含 Set-Cookie 头，浏览器收到之后会将 Cookie 保存，比如：</p><pre class="line-numbers language-http"><code class="language-http"><span class="token response-status">HTTP/1.0 <span class="token property">200 OK</span></span><span class="token header-name keyword">Content-type:</span> text/html<span class="token header-name keyword">Set-Cookie:</span> yummy_cookie = choco<span class="token header-name keyword">Set-Cookie:</span> tasty_cookie = strawberry<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>对该服务器发起的每一次新的请求，浏览器都会将之前保存的 Cookie 信息通过 Cookie 请求头发送给服务器</p><pre class="line-numbers language-http"><code class="language-http">GET /sample_page.html HTTP/1.1<span class="token header-name keyword">Host:</span> www.example.org<span class="token header-name keyword">Cookie:</span> yummy_cookie = choco; tasty_cookie = strawberry<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="2-类型"><a href="#2-类型" class="headerlink" title="2. 类型"></a>2. 类型</h3><ul><li>会话期 Cookie （session cookie）<br>会话期 Cookie 是最简单的 Cookie：浏览器关闭之后它会被自动删除</li><li>持久 Cookie<br>持久 Cookie 可以指定一个特定的过期时间（Expires）或者有效期（Max-Age）</li></ul><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token property-declaration"><span class="token property">Set-Cookie</span><span class="token punctuation">:</span> name <span class="token operator">=</span> SmartestEE<span class="token punctuation">;</span> expires <span class="token operator">=</span> Sat<span class="token punctuation">,</span> <span class="token number">02</span> May <span class="token number">2017</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">38</span><span class="token punctuation">:</span><span class="token number">25</span> GMT </span><span class="token comment" spellcheck="true">// max-age = 3600 * 72</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>安全类型 Cookie<br>安全类型可以设置 secure 选项，该选项只是一个标记而没有值。只有在使用 SLL 和 HTTPS 协议向服务器发起请求时，才能确保 Cookie 被安全地发送到服务器。</li></ul><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token property-declaration"><span class="token property">Set-Cookie</span><span class="token punctuation">:</span> name <span class="token operator">=</span> Nicholas<span class="token punctuation">;</span> secure</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>HttpOnly 类型 Cookie<br>HttpOnly 类型可以设置 HttpOnly 选项，HTTP-only 类型的 Cookie 不能使用 Javascript 通过 Document.cookie 属性来访问，从而能够在一定程度上阻止跨域脚本攻击（XSS）。HttpOnly 标志并没有给你提供额外的加密或者安全性上的能力，当整个机器暴露在不安全的环境时，切记绝不能通过 HTTP Cookie 存储、传输机密或者敏感信息。JavaScript 可以通过跨站脚本攻击（XSS）的方式来窃取 Cookie</li></ul><pre class="line-numbers language-stylus"><code class="language-stylus"><span class="token property-declaration"><span class="token property">Set-Cookie</span><span class="token punctuation">:</span> name <span class="token operator">=</span> Nicholas<span class="token punctuation">;</span> HttpOnly</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-Cookie-的作用域"><a href="#3-Cookie-的作用域" class="headerlink" title="3. Cookie 的作用域"></a>3. Cookie 的作用域</h3><p>Domain 和 Path 指令定义了 Cookie 的作用域，即需要发送 Cookie 的 URL 集合。</p><ul><li><p>Domain 指令规定了需要发送 Cookie 的主机名。如果没有指定，默认为当前的文档地址上的主机名（但是不包含子域名）。如果指定了 Domain，则一般包含子域名。</p><p>如果设置了 Domain=mozilla.org，则 Cookie 包含在子域名中（如 developer.mozilla.org）。</p></li><li><p>Path 指令表明需要发送 Cookie 的 URL 路径。字符 %x2F (即 “/“) 用做文件夹分隔符，子文件夹也会被匹配到。</p><p>如设置 Path=/docs，则下面这些地址都将匹配到：”/docs”，”/docs/Web/“，”/docs/Web/HTTP”</p></li></ul><h3 id="4-JavaScript-通过-Document-cookies-访问设置-Cookie"><a href="#4-JavaScript-通过-Document-cookies-访问设置-Cookie" class="headerlink" title="4. JavaScript 通过 Document.cookies 访问设置 Cookie"></a>4. JavaScript 通过 Document.cookies 访问设置 Cookie</h3><p>通过 Document.cookie 属性可以来创建新的 Cookie，也能够通过该属性来访问未被指定 HttpOnly 标志的 Cookie。</p><pre class="line-numbers language-javascript"><code class="language-javascript">document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token string">"yummy_cookie=choco"</span><span class="token punctuation">;</span>document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token string">"tasty_cookie=strawberry"</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// logs "yummy_cookie=choco; tasty_cookie=strawberry"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/cookie" target="_blank" rel="noopener">一个完整支持 unicode 的 cookie 读取 / 写入器</a></p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> docCookies <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// docCookies.getItem(name), 读取一个 cookie。如果 cookie 不存在返回 null</span>  <span class="token comment" spellcheck="true">// encodeURIComponent 转义除了字母、数字、(、)、. 、! 、~ 、* 、' 、- 和 _ 之外的所有字符</span>  getItem<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>sKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">"(?:(?:^|.*;)\\s*"</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>sKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[\-\.\+\*]/g</span><span class="token punctuation">,</span> <span class="token string">"\\$&amp;"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\\s*\\=\\s*([^;]*).*$)|^.*$"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"$1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// docCookies.setItem(name, value, [end], [path], [domain], [secure]), 创建或覆盖一个 cookie</span>  <span class="token comment" spellcheck="true">// end (可选) 最大时间的秒数 (一年为 31536e3， 永不过期的 cookie 为 Infinity) ，或者过期时间的 GMTString 格式或 Date 对象; 如果没有定义则会在会话结束时过期 (number – 有限的或 Infinity – string, Date object or null)。</span>  setItem<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>sKey<span class="token punctuation">,</span> sValue<span class="token punctuation">,</span> vEnd<span class="token punctuation">,</span> sPath<span class="token punctuation">,</span> sDomain<span class="token punctuation">,</span> bSecure<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sKey <span class="token operator">||</span> <span class="token regex">/^(?:expires|max\-age|path|domain|secure)$/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>sKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> sExpires <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">switch</span> <span class="token punctuation">(</span>vEnd<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> Number<span class="token punctuation">:</span>          sExpires <span class="token operator">=</span> vEnd <span class="token operator">===</span> <span class="token number">Infinity</span> <span class="token operator">?</span> <span class="token string">"; expires=Fri, 31 Dec 9999 23:59:59 GMT"</span> <span class="token punctuation">:</span> <span class="token string">"; max-age="</span> <span class="token operator">+</span> vEnd<span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> String<span class="token punctuation">:</span>          sExpires <span class="token operator">=</span> <span class="token string">"; expires="</span> <span class="token operator">+</span> vEnd<span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> Date<span class="token punctuation">:</span>          sExpires <span class="token operator">=</span> <span class="token string">"; expires="</span> <span class="token operator">+</span> vEnd<span class="token punctuation">.</span><span class="token function">toUTCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>sKey<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>sValue<span class="token punctuation">)</span> <span class="token operator">+</span> sExpires <span class="token operator">+</span> <span class="token punctuation">(</span>sDomain <span class="token operator">?</span> <span class="token string">"; domain="</span> <span class="token operator">+</span> sDomain <span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>sPath <span class="token operator">?</span><span class="token string">"; path="</span><span class="token operator">+</span> sPath <span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>bSecure <span class="token operator">?</span> <span class="token string">"; secure"</span> <span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// docCookies.removeItem(name, [path], domain), 删除一个 cookie</span>  removeItem<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>sKey<span class="token punctuation">,</span> sPath<span class="token punctuation">,</span> sDomain<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sKey <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasItem</span><span class="token punctuation">(</span>sKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>sKey<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"</span> <span class="token operator">+</span> <span class="token punctuation">(</span> sDomain <span class="token operator">?</span> <span class="token string">"; domain="</span> <span class="token operator">+</span> sDomain <span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span> sPath <span class="token operator">?</span><span class="token string">"; path="</span><span class="token operator">+</span> sPath <span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// docCookies.hasItem(name), 检查一个 cookie 是否存在</span>  hasItem<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>sKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">"(?:^|;\\s*)"</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>sKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[\-\.\+\*]/g</span><span class="token punctuation">,</span> <span class="token string">"\\$&amp;"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\\s*\\="</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// docCookies.keys(), 返回一个这个路径所有可读的 cookie 的数组</span>  keys<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> aKeys <span class="token operator">=</span> document<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\s*(?:\=[^;]*)?;\s*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> nIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> nIdx <span class="token operator">&lt;</span> aKeys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> nIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      aKeys<span class="token punctuation">[</span>nIdx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>aKeys<span class="token punctuation">[</span>nIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> aKeys<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>用法示例：</p><pre class="line-numbers language-javascript"><code class="language-javascript">docCookies<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"test0"</span><span class="token punctuation">,</span> <span class="token string">"Hello world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>docCookies<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"test3"</span><span class="token punctuation">,</span> <span class="token string">"Hello world!"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">2027</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"/blog"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>docCookies<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"test5"</span><span class="token punctuation">,</span> <span class="token string">"Hello world!"</span><span class="token punctuation">,</span> <span class="token string">"Tue, 06 Dec 2022 13:11:07 GMT"</span><span class="token punctuation">,</span> <span class="token string">"/home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>docCookies<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"test6"</span><span class="token punctuation">,</span> <span class="token string">"Hello world!"</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>docCookies<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"test7"</span><span class="token punctuation">,</span> <span class="token string">"Hello world!"</span><span class="token punctuation">,</span> <span class="token number">245</span><span class="token punctuation">,</span> <span class="token string">"/content"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>docCookies<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"test8"</span><span class="token punctuation">,</span> <span class="token string">"Hello world!"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"example.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>docCookies<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"test9"</span><span class="token punctuation">,</span> <span class="token string">"Hello world!"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>docCookies<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"test1;="</span><span class="token punctuation">,</span> <span class="token string">"Safe character test;="</span><span class="token punctuation">,</span> <span class="token number">Infinity</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-cookie-缺陷"><a href="#5-cookie-缺陷" class="headerlink" title="5. cookie 缺陷"></a>5. cookie 缺陷</h3><ul><li>cookie 会随着每次 HTTP 请求头信息一起发送，无形中增加了网络流量</li><li>cookie 能存储的数据容量有限，根据浏览器类型不同而不同，通常只有 4KB。所有超出该限制的 cookie 都会被截掉并且不会发送至服务器</li><li>每个域名下的 cookie 数量也有限制，根据浏览器类型不同而不同</li></ul><h2 id="HTML5-的-DOM-存储分成两种：SessionStorage-和-LocalStorage"><a href="#HTML5-的-DOM-存储分成两种：SessionStorage-和-LocalStorage" class="headerlink" title="HTML5 的 DOM 存储分成两种：SessionStorage 和 LocalStorage"></a>HTML5 的 DOM 存储分成两种：SessionStorage 和 LocalStorage</h2><p>DOM 存储的机制是通过存储字符串类型的键 / 值对。</p><ul><li>SessionStorage 是一种会话级别的缓存，关闭浏览器会数据会被清除。它的作用域是窗口级别的，也就是说不同窗口间的 sessionStorage 数据不能共享的。</li><li>LocalStorage 是持久化存储，不会自动删除</li></ul><table><thead><tr><th style="text-align:left">属性方法</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left">.length</td><td style="text-align:left">返回 storage 中的键值对个数</td></tr><tr><td style="text-align:left">.key(n)</td><td style="text-align:left">返回 storage 中第 n 个元素对的键值（第一个元素是 0）</td></tr><tr><td style="text-align:left">.getItem(key)</td><td style="text-align:left">返回键值 key 对应的值</td></tr><tr><td style="text-align:left">.key</td><td style="text-align:left">返回键值 key 对应的值</td></tr><tr><td style="text-align:left">.setItem(key, value)</td><td style="text-align:left">添加数据，键值为 key，值为 value</td></tr><tr><td style="text-align:left">.removeItem(key)</td><td style="text-align:left">移除键值为 key 的数据</td></tr><tr><td style="text-align:left">.clear()</td><td style="text-align:left">清除所有数据</td></tr></tbody></table><p>特点：</p><ul><li>Storage 提供几 MB 的空间，根据浏览器类型不同而不同，chrome 为 5MB。</li><li>键值对为文本类型，存储对象时要配合 JSON.stringify() 和 JSON.parse() 使用。</li><li>不同于 cookie，Storage 的访问限制更高一些，只有当前设定 Storage 的域名下才能访问。<br>SessionStorage 是以 tab 为级别的 session，刷新页面可以访问到之前的 sessionStorage，关闭再打开页面，无法访问到之前的 sessionStorage。<br>LocalStorage 两种情况下都可以访问，而且下次再打开浏览器仍可以访问</li><li>低版本浏览器不支持。</li></ul><h2 id="WebSQL-amp-IndexedDB"><a href="#WebSQL-amp-IndexedDB" class="headerlink" title="WebSQL &amp; IndexedDB"></a>WebSQL &amp; IndexedDB</h2><p>websql 的标准，官方已经不打算维护了，转而维护了新的 indexeddb，但是 websql 兼容性好，而且是移动端几乎完全可用。indexeddb 的兼容性没那么好，android4.4 之前以及 ios7 以前都无法直接使用，但可以用 polyfill 脚本做移动端兼容。</p><p><a href="http://caniuse.com/#feat=indexeddb" target="_blank" rel="noopener">各浏览器兼容性</a></p><p>websql 更像是关系型数据库，并且使用 sql 语句进行操作。</p><p>indexeddb 更像是 nosql（非关系型数据库），直接使用 js 的方法操作数据即可。</p><ul><li>也是永久存储</li><li>访问限制性：indexeddb 和 websql 均是在创建数据库的域名下才能访问。而且不能指定访问域名。</li><li>两种存储的方式是没有大小限制的</li></ul><h3 id="WebSQL-三个核心方法："><a href="#WebSQL-三个核心方法：" class="headerlink" title="WebSQL 三个核心方法："></a>WebSQL 三个核心方法：</h3><ul><li>openDatabase：这个方法使用现有的数据库或者新建的数据库创建一个数据库对象</li><li>transaction：控制一个事务，以及基于这种情况执行提交或者回滚</li><li>executeSql：执行实际的 SQL 查询</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> db <span class="token operator">=</span> <span class="token function">openDatabase</span><span class="token punctuation">(</span><span class="token string">' 数据库名称 '</span><span class="token punctuation">,</span> <span class="token string">'版本号 '</span><span class="token punctuation">,</span> <span class="token string">'描述文本 '</span><span class="token punctuation">,</span> 数据库大小<span class="token punctuation">,</span> <span class="token punctuation">[</span>创建回调<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>例子：</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> db <span class="token operator">=</span> <span class="token function">openDatabase</span><span class="token punctuation">(</span><span class="token string">'mydb'</span><span class="token punctuation">,</span> <span class="token string">'1.0'</span><span class="token punctuation">,</span> <span class="token string">'Test DB'</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> msg<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 插入</span>db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    tx<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">'CREATE TABLE IF NOT EXISTS LOGS (id unique, log)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tx<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO LOGS (id, log) VALUES (1,"SmartestEE")'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 更新</span>db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token punctuation">{</span>    tx<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">'UPDATE LOGS SET log=\'test\'WHERE id=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 读取</span>db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>tx<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM LOGS'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> results<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> len <span class="token operator">=</span> results<span class="token punctuation">.</span>rows<span class="token punctuation">.</span>length<span class="token punctuation">,</span> i<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        msg <span class="token operator">=</span> <span class="token string">"&lt;p>&lt;b>"</span> <span class="token operator">+</span> results<span class="token punctuation">.</span>rows<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>log <span class="token operator">+</span> <span class="token string">"&lt;/b>&lt;/p>"</span><span class="token punctuation">;</span>        document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#status'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">+</span><span class="token operator">=</span>  msg<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 删除</span>db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    tx<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">'DELETE FROM LOGS  WHERE id=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="IndexedDB"><a href="#IndexedDB" class="headerlink" title="IndexedDB"></a>IndexedDB</h3><p>特点：</p><ol><li>键值对储存。内部采用对象空间（object store）存放数据，支持所有 js 类型的数据</li><li>异步。IndexedDB 操作时不会锁死浏览器，用户依然可以进行其他操作，这与 LocalStorage 形成对比，后者的操作是同步的</li><li>支持事务。事务中一步出错整个事务都会回滚</li><li>同域限制。只能自身域名创建的 indexedDB 才可以访问</li><li>储存空间大。单个域名下的数据库超过 50M 的时候浏览器会弹窗向用户请求，不影响之后继续存储。</li><li>支持二进制储存。也就是可以存储图片和文件，<a href="https://hacks.mozilla.org/2012/02/storing-images-and-files-in-indexeddb/" target="_blank" rel="noopener">用 IndexedDB 存储图片和文件</a></li></ol><ul><li>判断是否可用</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> indexedDB <span class="token operator">=</span> window<span class="token punctuation">.</span>indexedDB <span class="token operator">||</span> window<span class="token punctuation">.</span>mozIndexedDB <span class="token operator">||</span> window<span class="token punctuation">.</span>webkitIndexedDB <span class="token operator">||</span> window<span class="token punctuation">.</span>msIndexedDB <span class="token operator">||</span> window<span class="token punctuation">.</span>shimIndexedDB<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>indexedDB<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'indexedDB 不可用 '</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>打开数据库</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> local <span class="token operator">=</span> indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">' 数据库名 '</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>版本号<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> db<span class="token punctuation">;</span>local<span class="token punctuation">.</span>onerror <span class="token operator">=</span> <span class="token punctuation">(</span>ect<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 打开错误</span><span class="token punctuation">}</span>local<span class="token punctuation">.</span>onsuccess <span class="token operator">=</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 打开成功，定义一个数据库对象</span>  db <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 也可以 db = local.result</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>创建和更新数据库版本号<br>要更新数据库的 schema，也就是创建或者删除对象存储空间，需要实现 onupgradeneeded 处理程序，这个处理程序将会作为一个允许你处理对象存储空间的 versionchange 事务的一部分被调用。</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">local<span class="token punctuation">.</span>onupgradeneeded <span class="token operator">=</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  db <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>  db<span class="token punctuation">.</span><span class="token function">createObjectStore</span><span class="token punctuation">(</span><span class="token string">'objectStore'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> keyPath<span class="token punctuation">:</span> <span class="token string">"chatID"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 创建一个对象空间，keyPath 指定唯一的 key，再加上 autoIncrement: true 自动增加 key</span>  objectStore<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> unique<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// createIndex 方法创建索引, 配合 index() 方法实用方便查询</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在数据库第一次被打开时或者当指定的版本号高于当前被持久化的数据库的版本号时，这个 versionchange 事务将被创建。版本号是一个 unsigned long long 数字, 不能用浮点数。</p><ul><li>操作数据<br>操作数据前都得定义一个事务，第一个参数数组指定这个事务跨越哪些对象存储空间，第二个参数指定模式（不加默认只读），事务具有三种模式（只读，读写，和版本变更），只读事务可以并发运行 。</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">transaction<span class="token punctuation">.</span>oncomplete <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 当所有的数据都操作完成时执行一些操作</span><span class="token punctuation">}</span><span class="token punctuation">;</span>transaction<span class="token punctuation">.</span>onerror <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 错误处理！</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>增</li></ol><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> request <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"objectStore"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"readwrite"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token string">"objectStore"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>chatID<span class="token punctuation">:</span> chatID<span class="token punctuation">,</span> messageList<span class="token punctuation">:</span> list<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>request<span class="token punctuation">.</span>onerror <span class="token operator">=</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>request<span class="token punctuation">.</span>onsuccess <span class="token operator">=</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>删</li></ol><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> store <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"objectStore"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"readwrite"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token string">"objectStore"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> request <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// delete(key) 删除指定数据，store.clear() 清空整个对象空间，db.deleteObjectStore('objectStore') 删除对象空间 (得在 onupgradeneeded 方法中使用)，indexedDB.deleteDatabase(" 数据库名称 ") 删库</span>request<span class="token punctuation">.</span>onsuccess <span class="token operator">=</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>查</li></ol><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> request <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"objectStore"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"readwrite"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token string">"objectStore"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>request<span class="token punctuation">.</span>onerror <span class="token operator">=</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 错误处理</span><span class="token punctuation">}</span><span class="token punctuation">;</span>request<span class="token punctuation">.</span>onsuccess <span class="token operator">=</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 对 request.result 或者 evt.target.result 做些操作！</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>改</li></ol><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> store <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"objectStore"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"readwrite"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token string">"objectStore"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> request <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>request<span class="token punctuation">.</span>onerror <span class="token operator">=</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 错误处理</span><span class="token punctuation">}</span><span class="token punctuation">;</span>request<span class="token punctuation">.</span>onsuccess <span class="token operator">=</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 对 request.result 或者 evt.target.result 做些操作！</span>  <span class="token keyword">let</span> data <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>  data<span class="token punctuation">.</span>messageList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>chatID<span class="token punctuation">:</span> <span class="token string">'123456'</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token string">'hello guys'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>遍历</li></ol><p>openCursor 方法，它在当前对象仓库里面建立一个读取光标（cursor）。</p><p>openCursor 方法还可以接受第二个参数，表示遍历方向，默认值为 next，其他可能的值为 prev、nextunique 和 prevunique。后两个值表示如果遇到重复值，会自动跳过。</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> t <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"test"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"readonly"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> store <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> cursor <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">openCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cursor<span class="token punctuation">.</span>onsuccess <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> res <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Key"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span><span class="token string">"Data"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        res<span class="token punctuation">.</span><span class="token keyword">continue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>关闭数据库</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">db<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="用于一个-react-聊天项目的本地消息记录存储的-IndexedDB-使用示例"><a href="#用于一个-react-聊天项目的本地消息记录存储的-IndexedDB-使用示例" class="headerlink" title="用于一个 react 聊天项目的本地消息记录存储的 IndexedDB 使用示例"></a>用于一个 react 聊天项目的本地消息记录存储的 IndexedDB 使用示例</h2><blockquote><p>封装的函数用法跟 localStorage 的属性方法类似</p></blockquote><p>IndexedDB.js</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">var</span> indexedDB <span class="token operator">=</span> window<span class="token punctuation">.</span>indexedDB <span class="token operator">||</span> window<span class="token punctuation">.</span>mozIndexedDB <span class="token operator">||</span> window<span class="token punctuation">.</span>webkitIndexedDB <span class="token operator">||</span> window<span class="token punctuation">.</span>msIndexedDB <span class="token operator">||</span> window<span class="token punctuation">.</span>shimIndexedDB<span class="token punctuation">;</span><span class="token keyword">var</span> userID <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'userID'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> db<span class="token punctuation">;</span>indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'LocalMessageDataBase'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>onupgradeneeded <span class="token operator">=</span> evt <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// console.log('establish database');</span>  db <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>  db<span class="token punctuation">.</span><span class="token function">createObjectStore</span><span class="token punctuation">(</span>userID<span class="token punctuation">,</span> <span class="token punctuation">{</span> keyPath<span class="token punctuation">:</span> <span class="token string">'chatID'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getLocalData</span><span class="token punctuation">(</span>chatID<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> localDB <span class="token operator">=</span> indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'LocalMessageDataBase'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    localDB<span class="token punctuation">.</span>onsuccess <span class="token operator">=</span> evt <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// console.log('open database to getdata');</span>      db <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>chatID<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> request <span class="token operator">=</span> db          <span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">[</span>userID<span class="token punctuation">]</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>chatID<span class="token punctuation">)</span><span class="token punctuation">;</span>        request<span class="token punctuation">.</span>onerror <span class="token operator">=</span> evt <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get error:'</span><span class="token punctuation">,</span> evt<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">reject</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        request<span class="token punctuation">.</span>onsuccess <span class="token operator">=</span> evt <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// console.log('get data:', evt.target.result);</span>          data <span class="token operator">=</span> request<span class="token punctuation">.</span>result <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setLocalData</span><span class="token punctuation">(</span>chatID<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> localDB <span class="token operator">=</span> indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'LocalMessageDataBase'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  localDB<span class="token punctuation">.</span>onsuccess <span class="token operator">=</span> evt <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// console.log('open database to setdata');</span>    db <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>    <span class="token keyword">let</span> store <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">[</span>userID<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'readwrite'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> request <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>chatID<span class="token punctuation">)</span><span class="token punctuation">;</span>    request<span class="token punctuation">.</span>onerror <span class="token operator">=</span> evt <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">throw</span> evt<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    request<span class="token punctuation">.</span>onsuccess <span class="token operator">=</span> evt <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> data <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// console.log('update data');</span>        data<span class="token punctuation">.</span>messageList <span class="token operator">=</span> list<span class="token punctuation">;</span>        store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// console.log('add data');</span>        store<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span> chatID<span class="token punctuation">:</span> chatID<span class="token punctuation">,</span> messageList<span class="token punctuation">:</span> list <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">deleteLocalData</span><span class="token punctuation">(</span>chatID<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> localDB <span class="token operator">=</span> indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'LocalMessageDataBase'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  localDB<span class="token punctuation">.</span>onsuccess <span class="token operator">=</span> evt <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    db <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>    <span class="token keyword">let</span> request <span class="token operator">=</span> db      <span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">[</span>userID<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'readwrite'</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>chatID<span class="token punctuation">)</span><span class="token punctuation">;</span>    request<span class="token punctuation">.</span>onerror <span class="token operator">=</span> evt <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'delete error'</span><span class="token punctuation">,</span> evt<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    request<span class="token punctuation">.</span>onsuccess <span class="token operator">=</span> evt <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'delete data'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>调用函数只需引入 IndexedDB.js</strong></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span>getLocalData<span class="token punctuation">,</span> setLocalData<span class="token punctuation">,</span> deleteLocaldata<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">'path/IndexedDB'</span><span class="token punctuation">;</span><span class="token function">getLocalData</span><span class="token punctuation">(</span>chatID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 获取聊天记录</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token function">setLocalData</span><span class="token punctuation">(</span>chatID<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 存入新的聊天消息记录</span><span class="token function">deleteLocaldata</span><span class="token punctuation">(</span>chatID<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 删除指定对象的消息记录</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      <categories>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 浏览器本地存储 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>系统 I/O</title>
      <link href="/2017/08-SystemIO.html"/>
      <url>/2017/08-SystemIO.html</url>
      <content type="html"><![CDATA[<p><strong>输入输出（I/O）是主存和外部设备设备（磁盘驱动器、终端、网络等）之间复制数据的过程。</strong></p><a id="more"></a><h2 id="Unix-I-O-是系统底层数据操作"><a href="#Unix-I-O-是系统底层数据操作" class="headerlink" title="Unix I/O 是系统底层数据操作"></a>Unix I/O 是系统底层数据操作</h2><p><img src="https://src.wangriyu.wang/images/blog/io/IO.png" alt="img"></p><p>open() 和 close() 来打开和关闭文件，使用 read() 和 write() 来读写文件，或者利用 lseek() 来设定读取的偏移量</p><ul><li>文件类型：</li></ul><ol><li>普通文件：包含任意数据</li><li>目录：相关一组文件的索引</li><li>套接字 Socket：和另一台机器上的进程通信的类型</li></ol><p>目录包含一个链接 (link) 数组，并且每个目录至少包含两条记录：<br>./ 当前目录<br>../ 上一层目录</p><p>相对路径和绝对路径</p><ul><li><p>打开文件</p><p>open 函数（返回的文件描述符一定是最小的且没有被用过的数值）</p></li></ul><pre class="line-numbers language-clike"><code class="language-clike">int <span class="token function">open</span><span class="token punctuation">(</span>const char <span class="token operator">*</span>pathname<span class="token punctuation">,</span> int flags<span class="token punctuation">,</span> mode_t mode<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// flags 用于指定文件的打开 / 创建模式, 第三个参数仅当创建新文件时才使用，用于指定文件的访问权限位（access permission bits）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>flags:<br>O_RDONLY 只读模式<br>O_WRONLY 只写模式<br>O_RDWR 读写模式<br>. . .</p><p>modes:<br>S_IRWXU00700 权限，代表该文件所有者具有可读、可写及可执行的权限。<br>S_IRUSR 或 S_IREAD，00400 权限，代表该文件所有者具有可读取的权限。<br>S_IWUSR 或 S_IWRITE，00200 权限，代表该文件所有者具有可写入的权限。<br>S_IXUSR 或 S_IEXEC，00100 权限，代表该文件所有者具有可执行的权限<br>. . .</p><pre class="line-numbers language-clike"><code class="language-clike">int fd<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 文件描述符</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/etc/hosts"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 返回值等于 -1 则说明发生了错误</span><span class="token punctuation">{</span>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>关闭文件<br>close 函数用于关闭已打开的文件, 关闭一个已关闭的描述符会出错</li></ul><pre class="line-numbers language-clike"><code class="language-clike">int <span class="token function">close</span><span class="token punctuation">(</span>int fd<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-clike"><code class="language-clike">int fd<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 文件描述符</span>int retval<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 返回值</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>retval <span class="token operator">=</span> <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>读取文件<br>实际上就是把文件中对应的字节复制到内存中</li></ul><pre class="line-numbers language-clike"><code class="language-clike">ssize_t <span class="token function">read</span><span class="token punctuation">(</span>int fd<span class="token punctuation">,</span> void <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t count<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 成功执行时，返回所读取的数据量，如果读到文件的末尾 EOF 则返回 0。失败的时候返回 - 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>buf: 所要读取到的数据的内存缓冲<br>count：需要读取的数据量</p><pre class="line-numbers language-clike"><code class="language-clike">char buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>int fd<span class="token punctuation">;</span>int nbytes<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 打开文件描述符，并从中读取 512 字节的数据</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nbytes <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>写入文件</li></ul><pre class="line-numbers language-clike"><code class="language-clike">ssize_t <span class="token function">write</span><span class="token punctuation">(</span>int fd<span class="token punctuation">,</span> const void <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t nbytes<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// write 函数将 buf 中的 nbytes 字节内容写入文件描述符 fd. 成功时返回写的字节数. 失败时返回 - 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-clike"><code class="language-clike">char buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>int fd<span class="token punctuation">;</span>int nbytes<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 打开文件描述符，并向其写入 512 字节的数据</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nbytes <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>tips：x86-64 系统中，size-t 被定义为 unsigned long，而 ssize-t（有符号）被定义为 long，因为函数返回值可能为 - 1</p></blockquote><ul><li>lseek 函数<br>为一个打开的文件设置其偏移量</li></ul><pre class="line-numbers language-clike"><code class="language-clike">off_t <span class="token function">lseek</span><span class="token punctuation">(</span>int fd<span class="token punctuation">,</span> off_t offset<span class="token punctuation">,</span> int whence<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Offset：偏移量，每一读写操作所需要移动的距离，单位是字节的数量，可正可负（向前，向后）</p><p>whence: SEEK_SET / SEEK_CUR / SEEK_END (依次为 0，1，2）.</p><p>SEEK_SET 将读写位置指向文件头后再增加 offset 个位移量。</p><p>SEEK_CUR 以目前的读写位置往后增加 offset 个位移量。</p><p>SEEK_END 将读写位置指向文件尾后再增加 offset 个位移量。</p><p>当 whence 值为 SEEK_CUR 或 SEEK_END 时，参数 offet 允许负值的出现</p><p>当调用成功时则返回目前的读写位置，也就是距离文件开头多少个字节。若有错误则返回 - 1，errno 会存放错误代码</p><ul><li>元数据<br>元数据是用来描述数据的结构，由内核维护，可以通过 stat 和 fstat 函数来访问</li></ul><pre class="line-numbers language-clike"><code class="language-clike">int <span class="token function">stat</span><span class="token punctuation">(</span>const char <span class="token operator">*</span>filename<span class="token punctuation">,</span> struct stat <span class="token operator">*</span>buf<span class="token punctuation">)</span>int <span class="token function">fstat</span><span class="token punctuation">(</span>int fd<span class="token punctuation">,</span> struct stat <span class="token operator">*</span>buf<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>函数结果是填充一个 stat 结构：</p><pre class="line-numbers language-clike"><code class="language-clike">struct stat<span class="token punctuation">{</span>    dev_t           st_dev<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// Device</span>    ino_t           st_ino<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// inode</span>    mode_t          st_mode<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Protection &amp; file type</span>    nlink_t         st_nlink<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// Number of hard links</span>    uid_t           st_uid<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// User ID of owner</span>    gid_t           st_gid<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// Group ID of owner</span>    dev_t           st_rdev<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Device type (if inode device)</span>    off_t           st_size<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Total size, in bytes</span>    unsigned long   st_blksize<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Blocksize for filesystem I/O</span>    unsigned long   st_blocks<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Number of blocks allocated</span>    time_t          st_atime<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// Time of last access</span>    time_t          st_mtime<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// Time of last modification</span>    time_t          st_ctime<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// Time of last change</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-clike"><code class="language-clike">int <span class="token function">main</span> <span class="token punctuation">(</span>int argc<span class="token punctuation">,</span> char <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">{</span>    struct stat stat<span class="token punctuation">;</span>    char <span class="token operator">*</span>type<span class="token punctuation">,</span> <span class="token operator">*</span>readok<span class="token punctuation">;</span>    <span class="token function">Stat</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISREG</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 确定文件类型，S_ISREG(m) 判断普通文件，</span>        type <span class="token operator">=</span> <span class="token string">"regular"</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISDIR</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// S_ISDIR(m) 判断目录文件</span>        type <span class="token operator">=</span> <span class="token string">"directory"</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token comment" spellcheck="true">// S_ISSOCK(m) 判断网络套接字</span>        type <span class="token operator">=</span> <span class="token string">"other"</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> S_IRUSR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 检查读权限</span>        readok <span class="token operator">=</span> <span class="token string">"yes"</span><span class="token punctuation">;</span>    <span class="token keyword">else</span>        readok <span class="token operator">=</span> <span class="token string">"no"</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"type: %s, read: %s\n"</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> readok<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>读取目录内容</li></ul><pre class="line-numbers language-clike"><code class="language-clike">int <span class="token function">main</span><span class="token punctuation">(</span>int argc<span class="token punctuation">,</span> char <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">{</span>  DIR <span class="token operator">*</span>streamp<span class="token punctuation">;</span>  struct dirent <span class="token operator">*</span>dep<span class="token punctuation">;</span>  streamp <span class="token operator">=</span> <span class="token function">Opendir</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  errno <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>streamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" 找到文件：%s\n"</span><span class="token punctuation">,</span> dep <span class="token operator">-</span><span class="token operator">></span> d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"readdir 失败 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">CloseDir</span><span class="token punctuation">(</span>streamp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="标准输入输出"><a href="#标准输入输出" class="headerlink" title="标准输入输出"></a>标准输入输出</h2><p>C 标准库中包含一系列高层的标准 IO 函数</p><ul><li>打开和关闭文件: fopen, fclose</li><li>读取和写入字节: fread, fwrite</li><li>读取和写入行: fgets, fputs</li><li>格式化读取和写入: fscanf, fprintf</li></ul><p>Standard C I/O: fopen, fdopen, fread, fwrite, fscanf, fprintf, sscanf, sprintf, fgets, fputs, fflush, fseek, fclose</p><h2 id="Node-js-文件系统-fs-模块"><a href="#Node-js-文件系统-fs-模块" class="headerlink" title="Node.js 文件系统 fs 模块"></a>Node.js 文件系统 fs 模块</h2><p>Node.js 提供一组类似 UNIX（POSIX）标准的文件操作 API。 Node 导入文件系统模块 (fs) 语法如下所示</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Node.js 文件系统（fs 模块）模块中的方法均有异步和同步版本，例如读取文件内容的函数有异步的 fs.readFile() 和同步的 fs.readFileSync()。<br>异步的方法函数最后一个参数为回调函数，回调函数的第一个参数包含了错误信息 (error)。<br>建议大家是用异步方法，比起同步，异步方法性能更高，速度更快，而且没有阻塞</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 异步读取</span>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./hello.txt'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 同步读取</span><span class="token keyword">var</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./hello.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>打开文件</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> flags<span class="token punctuation">[</span><span class="token punctuation">,</span> mode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// fd 是返回的文件描述符</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>获取文件信息</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> stats<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// stats 是 fs.Stats 对象</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><p>stats 类</p><p>查询文件信息</p></li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> stats<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>一个 stats 类对象的内容</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  dev<span class="token operator">:</span> <span class="token number">16777220</span><span class="token punctuation">,</span>   // 文件或目录所在的设备 I<span class="token punctuation">,</span> 该属性值在 UNIX 系统下有效  mode<span class="token operator">:</span> <span class="token number">33188</span><span class="token punctuation">,</span>     // 文件或目录的权限标志，采用数值形式表示  nlink<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        // 文件或目录的的硬连接数量  uid<span class="token operator">:</span> <span class="token number">501</span><span class="token punctuation">,</span>        // 文件或目录的所有者的用户 ID<span class="token punctuation">,</span> 该属性值在 UNIX 系统下有效  gid<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>         // 文件或目录的所有者的用户组 ID<span class="token punctuation">,</span> 该属性值在 UNIX 系统下有效  rdev<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>         // 字符设备文件或块设备文件所在设备 ID<span class="token punctuation">,</span> 该属性值在 UNIX 系统下有效  blksize<span class="token operator">:</span> <span class="token number">4096</span><span class="token punctuation">,</span>   // 块大小  ino<span class="token operator">:</span> <span class="token number">78808297</span><span class="token punctuation">,</span>   // 文件或目录的索引编号<span class="token punctuation">,</span> 该属性值仅在 UNIX 系统下有效  size<span class="token operator">:</span> <span class="token number">244</span><span class="token punctuation">,</span>       // 文件的字节数  blocks<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>       // 块数  atime<span class="token operator">:</span> Wed May <span class="token number">27</span> <span class="token number">2015</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">43</span> GMT+<span class="token number">0800</span> (CST<span class="token punctuation">)</span><span class="token punctuation">,</span>  // 文件或目录的访问时间  mtime<span class="token operator">:</span> Wed May <span class="token number">27</span> <span class="token number">2015</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">25</span> GMT+<span class="token number">0800</span> (CST<span class="token punctuation">)</span><span class="token punctuation">,</span>  // 文件或目录的最后修改时间  ctime<span class="token operator">:</span> Wed May <span class="token number">27</span> <span class="token number">2015</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">25</span> GMT+<span class="token number">0800</span> (CST<span class="token punctuation">)</span><span class="token punctuation">,</span>  // 文件或目录状态的最后修改时间  birthtime<span class="token operator">:</span> Mon<span class="token punctuation">,</span> <span class="token number">10</span> Oct <span class="token number">2011</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">11</span> GMT<span class="token punctuation">,</span>        // 文件创建时间  atimeMs<span class="token operator">:</span> <span class="token number">1318289051000.1</span><span class="token punctuation">,</span>      // 以单位为毫秒保存相对应时间的数字  mtimeMs<span class="token operator">:</span> <span class="token number">1318289051000.1</span><span class="token punctuation">,</span>  ctimeMs<span class="token operator">:</span> <span class="token number">1318289051000.1</span><span class="token punctuation">,</span>  birthtimeMs<span class="token operator">:</span> <span class="token number">1318289051000.1</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>stats 类的方法</p><ol><li>stats.isFile() 如果是标准文件，返回 true。是目录、套接字、符号连接、或设备等返回 false</li><li>stats. isDirectory() 如果是目录，返回 true</li><li>stats. isBlockDevice() 如果是块设备，返回 true，大多数情况下类 UNIX 系统的块设备都位于 / dev 目录下</li><li>stats. isCharacterDevice() 如果是字符设备，返回 true</li><li>stats. isSymbolicLink() 如果是符号连接，返回 true。（fs.lstat() 方法返回的 stats 对象才有此方法）</li><li>stats.isFIFO() 如果是 FIFO（FIFO 是 UNIX 中的一种特殊类型的命令管道），返回 true。FIFO 是 UNIX 中的一种特殊类型的命令管道</li><li>stats. isSocket() 如果是 UNIX 套接字（socket），返回 true</li></ol><ul><li>检查文件是否存在</li></ul><ol><li>fs.stat()，如果 stats 对象存在且 stats.isFile() 为 true 才能确认要修改或删除的文件存在</li></ol><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">'/xxx'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> stat<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>stat <span class="token operator">&amp;&amp;</span> stat<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">' 文件存在 '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">' 文件不存在或不是标准文件 '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>fs.access(), 检查到指定 path 路径的目录或文件的访问权限</li></ol><pre class="line-numbers language-javascript"><code class="language-javascript">fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token punctuation">,</span> mode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 检查文件是否存在</span><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">'/etc/passwd'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err <span class="token operator">?</span> <span class="token string">'文件存在'</span> <span class="token punctuation">:</span> <span class="token string">'文件不存在 '</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 检查是否对文件是否有读写权限</span><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">'/etc/passwd'</span><span class="token punctuation">,</span> fs<span class="token punctuation">.</span>R_OK <span class="token operator">|</span> fs<span class="token punctuation">.</span>W_OK<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err <span class="token operator">?</span> <span class="token string">'不可操作!'</span> <span class="token punctuation">:</span> <span class="token string">'可以读 / 写 '</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>fs.F_OK - 文件是对于进程是否可见，可以用来检查文件是否存在。也是 mode 的默认值<br>fs.R_OK - 文件对于进程是否可读<br>fs.W_OK - 文件对于进程是否可写<br>fs.X_OK - 文件对于进程是否可执行。（Windows 系统不可用，执行效果等同 fs.F_OK）</p><ul><li>写入文件</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token punctuation">,</span> options<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol><li>fd - 通过 fs.open() 方法返回的文件描述符。</li><li>buffer - 数据写入的缓冲区。</li><li>offset - 缓冲区写入的写入偏移量。</li><li>length - 要从文件中读取的字节数。</li><li>position - 文件读取的起始位置，如果 position 的值为 null，则会从当前文件指针的位置读取。</li><li>callback - 回调函数，有三个参数 err, bytesRead, buffer，err 为错误信息， bytesRead 表示读取的字节数，buffer 为缓冲区对象</li></ol><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">' 准备打开已存在的文件！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'input.txt'</span><span class="token punctuation">,</span> <span class="token string">'r+'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">' 文件打开成功！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">' 准备读取文件：'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  fs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bytes <span class="token operator">+</span> <span class="token string">' 字节被读取 '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 仅输出读取的字节</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// fs.write(fd, buffer, offset, length[, position], callback)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>关闭文件</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>截取文件</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">fs<span class="token punctuation">.</span><span class="token function">ftruncate</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>删除文件</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>创建目录</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">fs<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token punctuation">,</span> mode<span class="token punctuation">]</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>读取目录</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> files<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// files 为目录下的文件数组列表</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>删除目录</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">fs<span class="token punctuation">.</span><span class="token function">rmdir</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>检测给定的路径是否存在</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 异步版本已无效</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>追加文件内容</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript">fs<span class="token punctuation">.</span><span class="token function">appendFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token punctuation">,</span> options<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="几条查询目录信息终端命令"><a href="#几条查询目录信息终端命令" class="headerlink" title="几条查询目录信息终端命令"></a>几条查询目录信息终端命令</h2><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">find</span> 路径 -type f<span class="token operator">|</span><span class="token function">wc</span> -l // 统计文件数$ <span class="token function">find</span> 路径 -type d<span class="token operator">|</span><span class="token function">wc</span> -l // 统计目录数$ <span class="token function">du</span> -sh 路径 // 统计大小$ <span class="token function">df</span> -h /    // 查询磁盘使用量$ <span class="token function">ls</span> -lR 路径 <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"^d"</span><span class="token operator">|</span><span class="token function">wc</span> -l // 统计目录数$ <span class="token function">ls</span> -lR 路径 <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"^-"</span><span class="token operator">|</span><span class="token function">wc</span> -l // 统计文件数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      <categories>
          
          <category> READ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 深入理解计算机 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>0611-JS 笔记</title>
      <link href="/2017/06-JSNote3.html"/>
      <url>/2017/06-JSNote3.html</url>
      <content type="html"><![CDATA[<h2 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h2><h3 id="使用-this-对象的方法作为回调函数时的问题"><a href="#使用-this-对象的方法作为回调函数时的问题" class="headerlink" title="使用 this 对象的方法作为回调函数时的问题"></a>使用 this 对象的方法作为回调函数时的问题</h3><p>如果回调函数被传递给一个全局函数，this 对象指向全局 window 对象（在浏览器中）</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> clientData <span class="token operator">=</span> <span class="token punctuation">{</span>  id<span class="token punctuation">:</span> <span class="token number">094545</span><span class="token punctuation">,</span>  fullName<span class="token punctuation">:</span> <span class="token string">'Not Set'</span><span class="token punctuation">,</span>  setUserName<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 这指向了对象中的 fullName 属性</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>fullName <span class="token operator">=</span> firstName <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> lastName<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">getUserInput</span><span class="token punctuation">(</span>firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 在这做些什么来确认 firstName/lastName</span>  <span class="token comment" spellcheck="true">// 现在存储 names</span>  <span class="token function">callback</span><span class="token punctuation">(</span>firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">getUserInput</span><span class="token punctuation">(</span><span class="token string">'Wang'</span><span class="token punctuation">,</span> <span class="token string">'RiYu'</span><span class="token punctuation">,</span> clientData<span class="token punctuation">.</span>setUserName<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>clientData<span class="token punctuation">.</span>fullName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Not Set</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fullName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Wang RiYu</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当 clientData.setUsername 被执行时，this.fullName 并没有设置 clientData 对象中的 fullName 属性。</p><p>相反，它将设置 window 对象中的 fullName 属性，因为 getUserInput 是一个全局函数。</p><p>这是因为全局函数中的 this 对象指向 window 对象。</p><h3 id="修复上面出现的问题"><a href="#修复上面出现的问题" class="headerlink" title="修复上面出现的问题"></a>修复上面出现的问题</h3><p><strong>使用 Call 和 Apply 函数保存 this</strong></p><ul><li><p>call 接收的第一个参数为被用来在函数内部当做 this 的对象，传递给函数的参数被挨个传递（当然使用逗号分开）</p></li><li><p>apply 函数的第一个参数也是在函数内部作为 this 的对象，然而最后一个参数确是传递给函数的值的数组</p></li></ul><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">getUserInput</span><span class="token punctuation">(</span>firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> callback<span class="token punctuation">.</span> callbackObj<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 在这里做些什么来确认名字</span>  callback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbackObj<span class="token punctuation">,</span> <span class="token punctuation">[</span>firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用 Apply 函数正确设置了 this 对象，我们现在正确的执行了 callback 并在 clientData 对象中正确设置了 fullName 属性</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 我们将 clientData.setUserName 方法和 clientData 对象作为参数</span><span class="token comment" spellcheck="true">//clientData 对象会被 Apply 方法使用来设置 this 对象</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token string">'Barack'</span><span class="token punctuation">,</span> <span class="token string">'Obama'</span><span class="token punctuation">,</span> clientData<span class="token punctuation">.</span>setUserName<span class="token punctuation">,</span> clientData<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//clientData 中的 fullName 属性被正确的设置</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>clientUser<span class="token punctuation">.</span>fullName<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="回调函数特点"><a href="#回调函数特点" class="headerlink" title="回调函数特点"></a>回调函数特点</h3><ul><li>回调函数是一段可执行的代码段，它作为一个参数传递给其他的代码，其作用是在需要的时候方便调用这段（回调函数）代码</li><li>不会立刻执行, 调用 add 时才会执行 print</li><li>回调函数是一个闭包，也就是说它能访问到其外层定义的变量</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span>num1<span class="token punctuation">,</span> num2<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> sum <span class="token operator">=</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">;</span>  <span class="token function">callback</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">print</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> print<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 在执行回调函数前最好确认其是一个函数</span><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span>num1<span class="token punctuation">,</span> num2<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> sum <span class="token operator">=</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">callback</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="注意在回调函数调用时-this-的执行上下文并不是回调函数定义时的那个上下文，而是调用它的函数所在的上下文"><a href="#注意在回调函数调用时-this-的执行上下文并不是回调函数定义时的那个上下文，而是调用它的函数所在的上下文" class="headerlink" title="注意在回调函数调用时 this 的执行上下文并不是回调函数定义时的那个上下文，而是调用它的函数所在的上下文"></a>注意在回调函数调用时 this 的执行上下文并不是回调函数定义时的那个上下文，而是调用它的函数所在的上下文</h3><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  sum<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>  add<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>num1<span class="token punctuation">,</span> num2<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>sum <span class="token operator">=</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span>num1<span class="token punctuation">,</span> num2<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">callback</span><span class="token punctuation">(</span>num1<span class="token punctuation">,</span> num2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//0</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上述代码调用回调函数的时候是在全局环境下，因此 this 指向的是 window，所以 sum 的值是赋值给 windows 的</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> rand <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rand<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> num <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>rand <span class="token operator">*</span> <span class="token punctuation">(</span>arg2 <span class="token operator">-</span> arg1<span class="token punctuation">)</span> <span class="token operator">+</span> arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">callback</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Callback called! Num:'</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 结果为 10 和 20 之间的随机数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> clientData <span class="token operator">=</span> <span class="token punctuation">{</span>  id<span class="token punctuation">:</span> <span class="token number">094545</span><span class="token punctuation">,</span>  fullName<span class="token punctuation">:</span> <span class="token string">'Not Set'</span><span class="token punctuation">,</span>  setUserName<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 这指向了对象中的 fullName 属性</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>fullName <span class="token operator">=</span> firstName <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> lastName<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">getUserInput</span><span class="token punctuation">(</span>firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 在这做些什么来确认 firstName/lastName</span>  <span class="token comment" spellcheck="true">// 现在存储 names</span>  <span class="token function">callback</span><span class="token punctuation">(</span>firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">getUserInput</span><span class="token punctuation">(</span><span class="token string">'Wang'</span><span class="token punctuation">,</span> <span class="token string">'RiYu'</span><span class="token punctuation">,</span> clientData<span class="token punctuation">.</span>setUserName<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>clientData<span class="token punctuation">.</span>fullName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Not Set</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fullName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Wang RiYu</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h2><h3 id="闭包作用，一个是可以读取函数内部的变量，另一个就是让这些变量的值始终保持在内存中"><a href="#闭包作用，一个是可以读取函数内部的变量，另一个就是让这些变量的值始终保持在内存中" class="headerlink" title="闭包作用，一个是可以读取函数内部的变量，另一个就是让这些变量的值始终保持在内存中"></a>闭包作用，一个是可以读取函数内部的变量，另一个就是让这些变量的值始终保持在内存中</h3><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">plus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    counter <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">plus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span><span class="token comment" spellcheck="true">/*-------------------------------------------*/</span><span class="token keyword">var</span> add <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">(</span>counter <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">makeFunc1</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> x<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">makeFunc1</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">makeFunc1</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">makeFunc1</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 0</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2</span><span class="token comment" spellcheck="true">/*-------------------------------*/</span><span class="token keyword">function</span> <span class="token function">makeFunc2</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">makeFunc2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">makeFunc2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">makeFunc2</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 0</span>b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span>  nAdd <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    n <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> f2<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 999</span><span class="token function">nAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1000</span><span class="token comment" spellcheck="true">/*-----------------------*/</span><span class="token keyword">function</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span>  mAdd <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    n <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 999</span><span class="token function">mAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 999</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    a <span class="token operator">*</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> f <span class="token operator">=</span> <span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//return 20.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//return 40.</span><span class="token comment" spellcheck="true">/*-------------------------*/</span><span class="token keyword">function</span> <span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    a <span class="token operator">*</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//return 20.</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//return 20.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      <categories>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaScript </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>0507-JS 笔记</title>
      <link href="/2017/05-JSNote2.html"/>
      <url>/2017/05-JSNote2.html</url>
      <content type="html"><![CDATA[<h2 id="splice-和-slice"><a href="#splice-和-slice" class="headerlink" title="splice 和 slice"></a>splice 和 slice</h2><h3 id="splice-方法通过删除现有元素和-或添加新元素来更改数组的内容"><a href="#splice-方法通过删除现有元素和-或添加新元素来更改数组的内容" class="headerlink" title="splice() 方法通过删除现有元素和 / 或添加新元素来更改数组的内容"></a>splice() 方法通过删除现有元素和 / 或添加新元素来更改数组的内容</h3><pre class="line-numbers language-javascript"><code class="language-javascript">array<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>array<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> deleteCount<span class="token punctuation">)</span>array<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> deleteCount<span class="token punctuation">,</span> item1<span class="token punctuation">,</span> item2<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>start<br>指定修改的开始位置（从 0 计数）。如果超出了数组的长度，则从数组末尾开始添加内容；如果是负值，则表示从数组末位开始的第几位（从 1 计数）。</li><li>deleteCount （可选）<br>整数，表示要移除的数组元素的个数。如果 deleteCount 是 0，则不移除元素。这种情况下，至少应添加一个新元素。如果 deleteCount 大于 start 之后的元素的总数，则从 start 后面的元素都将被删除（含第 start 位）。<br>如果 deleteCount 被省略，则其相当于 (arr.length - start)。</li><li>item1, item2, … （可选）<br>要添加进数组的元素, 从 start 位置开始。如果不指定，则 splice() 将只删除数组元素。</li></ul><h3 id="splice-返回值"><a href="#splice-返回值" class="headerlink" title="splice() 返回值"></a>splice() 返回值</h3><p>由被删除的元素组成的一个数组。如果只删除了一个元素，则返回只包含一个元素的数组。如果没有删除元素，则返回空数组</p><blockquote><p>tips：splice() 方法与 slice() 方法的作用是不同的，splice() 方法会直接对数组进行修改</p></blockquote><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> removed <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//array --> ["a","b","e","c","d"]</span><span class="token comment" spellcheck="true">//removed --> []</span>removed <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//array --> ["a","b","e","d"]</span><span class="token comment" spellcheck="true">//removed --> ["c"]</span>removed <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'f'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//array --> ["a","b","f","d"]</span><span class="token comment" spellcheck="true">//removed --> ["e"]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="slice-方法返回一个从开始到结束（不包括结束）选择的数组的一部分浅拷贝到一个新数组对象-不改变原数组"><a href="#slice-方法返回一个从开始到结束（不包括结束）选择的数组的一部分浅拷贝到一个新数组对象-不改变原数组" class="headerlink" title="slice() 方法返回一个从开始到结束（不包括结束）选择的数组的一部分浅拷贝到一个新数组对象, 不改变原数组"></a>slice() 方法返回一个从开始到结束（不包括结束）选择的数组的一部分浅拷贝到一个新数组对象, 不改变原数组</h3><pre class="line-numbers language-javascript"><code class="language-javascript">array<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>array<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>begin<span class="token punctuation">)</span><span class="token punctuation">;</span>array<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>begin （可选）<br>从该索引处开始提取原数组中的元素（从 0 开始）。<br>如果该参数为负数，则表示从原数组中的倒数第几个元素开始提取，slice(-2) 表示提取原数组中的倒数第二个元素到最后一个元素（包含最后一个元素）。<br>如果省略 begin，则 slice 从索引 0 开始。</li><li>end （可选）<br>在该索引处结束提取原数组元素（从 0 开始）。slice 会提取原数组中索引从 begin 到 end 的所有元素（包含 begin，但不包含 end）。<br>slice(1,4) 提取原数组中的第二个元素开始直到第四个元素的所有元素 （索引为 1, 2, 3 的元素）。<br>如果该参数为负数， 则它表示在原数组中的倒数第几个元素结束抽取。 slice(-2,-1) 表示抽取了原数组中的倒数第二个元素到最后一个元素（不包含最后一个元素，也就是只有倒数第二个元素）。<br>如果 end 被省略，则 slice 会一直提取到原数组末尾。<br>如果 end 大于数组长度，slice 也会一直提取到原数组末尾。</li></ul><h3 id="slice-返回值"><a href="#slice-返回值" class="headerlink" title="slice() 返回值"></a>slice() 返回值</h3><p>array 下标 <strong>begin &lt;= copy &lt; end</strong> 的数组拷贝</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> sliced <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//array --> ["a", "b", "c", "d"]</span><span class="token comment" spellcheck="true">//sliced --> ["b", "c"]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="调用-Object-属性"><a href="#调用-Object-属性" class="headerlink" title="调用 Object 属性"></a>调用 Object 属性</h2><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span>  name0<span class="token punctuation">:</span> <span class="token string">'abc'</span><span class="token punctuation">,</span>  name1<span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">}</span><span class="token punctuation">;</span>object<span class="token punctuation">.</span>name0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 等同于 object["name0"], 输出 "abc"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="创建函数的几种方法"><a href="#创建函数的几种方法" class="headerlink" title="创建函数的几种方法"></a>创建函数的几种方法</h2><h3 id="三种基础方法"><a href="#三种基础方法" class="headerlink" title="三种基础方法"></a>三种基础方法</h3><ul><li>function foo(arg) { statements }</li><li>var foo = function(arg) { statements }</li><li>var foo = new Function(“a”,”b”,”console.log(a+b)”) // 等同于 function foo(a,b){ console.log(a+b); }</li></ul><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// --> 123</span><span class="token comment" spellcheck="true">// 上面的代码可以简写成下面这个</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// --> 123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ES6-引入箭头函数"><a href="#ES6-引入箭头函数" class="headerlink" title="ES6 引入箭头函数"></a>ES6 引入箭头函数</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="noopener">MDN 箭头函数语法</a></p><p><a href="https://www.kancloud.cn/kancloud/es6-in-depth/47781" target="_blank" rel="noopener">深入浅出 ES6 箭头函数</a></p><pre class="line-numbers language-javascript"><code class="language-javascript">x <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 等同于下面这个方法</span><span class="token keyword">function</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> foo <span class="token operator">=</span> x <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// --> 25</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数只有一个可以省略括号，其他情况如下:</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 两个参数:</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">*</span> x <span class="token operator">+</span> y <span class="token operator">*</span> y<span class="token comment" spellcheck="true">// 无参数:</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">3.14</span><span class="token comment" spellcheck="true">// 可变参数:</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">...</span>rest<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> i<span class="token punctuation">,</span> sum <span class="token operator">=</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>rest<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        sum <span class="token operator">+</span><span class="token operator">=</span> rest<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> sum<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="箭头函数改变了-this-指向"><a href="#箭头函数改变了-this-指向" class="headerlink" title="箭头函数改变了 this 指向"></a>箭头函数改变了 this 指向</h4><p>原有函数写法与箭头函数写法下的 this 指向:</p><p><img src="https://src.wangriyu.wang/images/blog/javaScript/this.png" alt="image"></p><p>箭头函数内部的 this 是词法作用域，由上下文确定。</p><p>由于 JavaScript 函数对 this 绑定的错误处理，下面的例子无法得到预期结果：</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  birth<span class="token punctuation">:</span> <span class="token number">1990</span><span class="token punctuation">,</span>  getAge<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>birth<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1990</span>    <span class="token keyword">var</span> fn <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>birth<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// this 指向 window 或 undefined</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>obj<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// --> NaN</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>箭头函数完全修复了 this 的指向，this 总是指向词法作用域，也就是外层调用者 obj</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  birth<span class="token punctuation">:</span> <span class="token number">1990</span><span class="token punctuation">,</span>  getAge<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>birth<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1990</span>    <span class="token keyword">var</span> fn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>birth<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// this 指向 obj 对象</span>    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>obj<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 27</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果使用箭头函数，以前的那种 hack 写法：<br>var that = this;<br>就不再需要了。</p><p>由于 this 在箭头函数中已经按照词法作用域绑定了，所以，用 call() 或者 apply() 调用箭头函数时，无法对 this 进行绑定，即传入的第一个参数被忽略</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  birth<span class="token punctuation">:</span> <span class="token number">1990</span><span class="token punctuation">,</span>  getAge<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>birth<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1990</span>    <span class="token keyword">var</span> fn <span class="token operator">=</span> y <span class="token operator">=</span><span class="token operator">></span> y <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>birth<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// this.birth 仍是 1990</span>    <span class="token keyword">return</span> fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span> birth<span class="token punctuation">:</span> <span class="token number">2000</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> year<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>obj<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token number">2017</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 27</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Javascript-闭包（Closure）"><a href="#Javascript-闭包（Closure）" class="headerlink" title="Javascript 闭包（Closure）"></a>Javascript 闭包（Closure）</h2><h3 id="变量的作用域"><a href="#变量的作用域" class="headerlink" title="变量的作用域"></a>变量的作用域</h3><p>变量的作用域无非就两种：全局变量和局部变量。</p><p>Javascript 函数内部可以直接读取全局变量</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// --> 123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在函数外部无法读取函数内的局部变量</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//ReferenceError: a is not defined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里有一个地方需要注意，函数内部声明变量的时候，一定要使用 var 命令。如果不用的话，你实际上声明了一个全局变量！</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  a <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// --> 123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="如何从外部读取局部变量？"><a href="#如何从外部读取局部变量？" class="headerlink" title="如何从外部读取局部变量？"></a>如何从外部读取局部变量？</h3><p>出于种种原因，我们有时候需要得到函数内的局部变量。但是，前面已经说过了，正常情况下，这是办不到的，只有通过变通方法才能实现。</p><p>那就是在函数的内部，再定义一个函数:</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// --> 123</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在上面的代码中，函数 f2 就被包括在函数 f1 内部，这时 f1 内部的所有局部变量，对 f2 都是可见的。但是反过来就不行，f2 内部的局部变量，对 f1 就是不可见的。这就是 Javascript 语言特有的 “ 链式作用域 “ 结构（chain scope），子对象会一级一级地向上寻找所有父对象的变量。所以，父对象的所有变量，对子对象都是可见的，反之则不成立。</p><p>既然 f2 可以读取 f1 中的局部变量，那么只要把 f2 作为返回值，我们不就可以在 f1 外部读取它的内部变量了吗！</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> f2<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// --> 123</span><span class="token comment" spellcheck="true">// 也可以这样</span><span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">f2</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> f2<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">456</span><span class="token punctuation">;</span><span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="闭包的概念"><a href="#闭包的概念" class="headerlink" title="闭包的概念"></a>闭包的概念</h3><p>上一节代码中的 f2 函数，就是闭包。</p><p>简单理解闭包就是能够读取其他函数内部变量的函数。</p><p>由于在 Javascript 语言中，只有函数内部的子函数才能读取局部变量，因此可以把闭包简单理解成 “ 定义在一个函数内部的函数 “。</p><p>所以，在本质上，闭包就是将函数内部和函数外部连接起来的一座桥梁。</p><h3 id="闭包的用途"><a href="#闭包的用途" class="headerlink" title="闭包的用途"></a>闭包的用途</h3><p>闭包可以用在许多地方。它的最大用处有两个，一个是前面提到的可以读取函数内部的变量，另一个就是让这些变量的值始终保持在内存中。</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span>  nAdd <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    n <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> f2<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 999</span><span class="token function">nAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在这段代码中，result 实际上就是闭包 f2 函数。它一共运行了两次，第一次的值是 999，第二次的值是 1000。这证明了，函数 f1 中的局部变量 n 一直保存在内存中，并没有在 f1 调用后被自动清除。</p><p>为什么会这样呢？原因就在于 f1 是 f2 的父函数，而 f2 被赋给了一个全局变量，这导致 f2 始终在内存中，而 f2 的存在依赖于 f1，因此 f1 也始终在内存中，不会在调用结束后，被垃圾回收机制（garbage collection）回收。</p><p>这段代码中另一个值得注意的地方，就是 “nAdd=function(){n+=1}” 这一行，首先在 nAdd 前面没有使用 var 关键字，因此 nAdd 是一个全局变量，而不是局部变量。其次，nAdd 的值是一个匿名函数（anonymous function），而这个匿名函数本身也是一个闭包，所以 nAdd 相当于是一个 setter，可以在函数外部对函数内部的局部变量进行操作。</p><h3 id="使用闭包的注意点"><a href="#使用闭包的注意点" class="headerlink" title="使用闭包的注意点"></a>使用闭包的注意点</h3><p>1）由于闭包会使得函数中的变量都被保存在内存中，内存消耗很大，所以不能滥用闭包，否则会造成网页的性能问题，在 IE 中可能导致内存泄露。解决方法是，在退出函数之前，将不使用的局部变量全部删除。</p><p>2）闭包会在父函数外部，改变父函数内部变量的值。所以，如果你把父函数当作对象（object）使用，把闭包当作它的公用方法（Public Method），把内部变量当作它的私有属性（private value），这时一定要小心，不要随便改变父函数内部变量的值。</p>]]></content>
      
      <categories>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaScript </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>0423-JS 笔记</title>
      <link href="/2017/04-JSNote1.html"/>
      <url>/2017/04-JSNote1.html</url>
      <content type="html"><![CDATA[<h2 id="一、var、let、const-区别与联系"><a href="#一、var、let、const-区别与联系" class="headerlink" title="一、var、let、const 区别与联系"></a>一、var、let、const 区别与联系</h2><h3 id="JavaScript-是弱类型语言，var-可以定义各种数据类型和对象"><a href="#JavaScript-是弱类型语言，var-可以定义各种数据类型和对象" class="headerlink" title="JavaScript 是弱类型语言，var 可以定义各种数据类型和对象"></a>JavaScript 是弱类型语言，var 可以定义各种数据类型和对象</h3><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token punctuation">;</span><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token punctuation">{</span> name0<span class="token punctuation">:</span> value0<span class="token punctuation">,</span> name1<span class="token punctuation">:</span> value1 <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// var x = ["abc", 123, true]</span><span class="token keyword">var</span> y<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//undefined</span><span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//null</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="var-可以重复声明并赋值同一变量，后者覆盖前者-但-let-声明的变量在同一块级作用域中不能重复"><a href="#var-可以重复声明并赋值同一变量，后者覆盖前者-但-let-声明的变量在同一块级作用域中不能重复" class="headerlink" title="var 可以重复声明并赋值同一变量，后者覆盖前者; 但 let 声明的变量在同一块级作用域中不能重复"></a>var 可以重复声明并赋值同一变量，后者覆盖前者; 但 let 声明的变量在同一块级作用域中不能重复</h3><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//var 作用域是全局的或者函数级的</span><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//let 作用域是块级的{}内</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 0</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="循环体中，第一个例子循环本身及三次-timeout-回调均共享唯一的变量-i-。当循环结束执行时，i-的值变为-3，当第一个-timeout-执行时，调用的-i-值为-3-；第二个人例子每次循环-let-声明的-i-均不一样，输出自然不一样。而的第二个才是我们想要的结果，所以循环体条件中很多情况用-let-更好"><a href="#循环体中，第一个例子循环本身及三次-timeout-回调均共享唯一的变量-i-。当循环结束执行时，i-的值变为-3，当第一个-timeout-执行时，调用的-i-值为-3-；第二个人例子每次循环-let-声明的-i-均不一样，输出自然不一样。而的第二个才是我们想要的结果，所以循环体条件中很多情况用-let-更好" class="headerlink" title="循环体中，第一个例子循环本身及三次 timeout 回调均共享唯一的变量 i 。当循环结束执行时，i 的值变为 3，当第一个 timeout 执行时，调用的 i 值为 3 ；第二个人例子每次循环 let 声明的 i 均不一样，输出自然不一样。而的第二个才是我们想要的结果，所以循环体条件中很多情况用 let 更好"></a>循环体中，第一个例子循环本身及三次 timeout 回调均共享唯一的变量 i 。当循环结束执行时，i 的值变为 3，当第一个 timeout 执行时，调用的 i 值为 3 ；第二个人例子每次循环 let 声明的 i 均不一样，输出自然不一样。而的第二个才是我们想要的结果，所以循环体条件中很多情况用 let 更好</h3><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 输出 3 个 3</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 输出 0，1，2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="let-是更完美的-var"><a href="#let-是更完美的-var" class="headerlink" title="let 是更完美的 var"></a>let 是更完美的 var</h3><ul><li>let 声明的变量拥有块级作用域</li><li>let 声明的全局变量不是全局对象的属性</li><li>形如 for (let i…) 的循环在每次迭代时都为 i 创建新的绑定</li><li>用 let 重定义变量会抛出一个语法错误（SyntaxError）</li></ul><h3 id="const-是-ES6-引入的新的声明类关键词，用来定义常量，不可改变常量的值"><a href="#const-是-ES6-引入的新的声明类关键词，用来定义常量，不可改变常量的值" class="headerlink" title="const 是 ES6 引入的新的声明类关键词，用来定义常量，不可改变常量的值"></a>const 是 ES6 引入的新的声明类关键词，用来定义常量，不可改变常量的值</h3><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">const</span> MAX_CAT_SIZE_KG <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 正确</span>MAX_CAT_SIZE_KG <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 语法错误（SyntaxError）</span>MAX_CAT_SIZE_KG<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 仍然会导致语法错误</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="二、循环"><a href="#二、循环" class="headerlink" title="二、循环"></a>二、循环</h2><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// for 循环</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// more statements</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//while 循环</span><span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  n<span class="token operator">++</span><span class="token punctuation">;</span>  x <span class="token operator">+</span><span class="token operator">=</span> n<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//do-while 循环</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="for…in-语句以任意顺序遍历一个对象的可枚举属性。对于每个不同的属性，语句都会被执行。"><a href="#for…in-语句以任意顺序遍历一个对象的可枚举属性。对于每个不同的属性，语句都会被执行。" class="headerlink" title="for…in 语句以任意顺序遍历一个对象的可枚举属性。对于每个不同的属性，语句都会被执行。"></a>for…in 语句以任意顺序遍历一个对象的可枚举属性。对于每个不同的属性，语句都会被执行。</h3><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> c<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> prop <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'obj.'</span> <span class="token operator">+</span> prop <span class="token operator">+</span> <span class="token string">' = '</span> <span class="token operator">+</span> obj<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//obj.a = 1</span><span class="token comment" spellcheck="true">//obj.b = 2</span><span class="token comment" spellcheck="true">//obj.c = 3</span><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> c<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//a</span><span class="token comment" spellcheck="true">//b</span><span class="token comment" spellcheck="true">//c</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="for…of-语句在可迭代对象-包括-Array-Map-Set-String-TypedArray，arguments-对象等等-上创建一个迭代循环，对每个不同属性的属性值-调用一个自定义的有执行语句的迭代挂钩"><a href="#for…of-语句在可迭代对象-包括-Array-Map-Set-String-TypedArray，arguments-对象等等-上创建一个迭代循环，对每个不同属性的属性值-调用一个自定义的有执行语句的迭代挂钩" class="headerlink" title="for…of 语句在可迭代对象 (包括 Array, Map, Set, String, TypedArray，arguments 对象等等) 上创建一个迭代循环，对每个不同属性的属性值, 调用一个自定义的有执行语句的迭代挂钩."></a>for…of 语句在可迭代对象 (包括 Array, Map, Set, String, TypedArray，arguments 对象等等) 上创建一个迭代循环，对每个不同属性的属性值, 调用一个自定义的有执行语句的迭代挂钩.</h3><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 遍历 Array:</span><span class="token keyword">let</span> iterable <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> value <span class="token keyword">of</span> iterable<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 10</span><span class="token comment" spellcheck="true">// 20</span><span class="token comment" spellcheck="true">// 30</span><span class="token comment" spellcheck="true">// 遍历 String:</span><span class="token keyword">let</span> iterable <span class="token operator">=</span> <span class="token string">'boo'</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> value <span class="token keyword">of</span> iterable<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// "b"</span><span class="token comment" spellcheck="true">// "o"</span><span class="token comment" spellcheck="true">// "o"</span><span class="token comment" spellcheck="true">// 遍历 TypedArray:</span><span class="token keyword">let</span> iterable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> value <span class="token keyword">of</span> iterable<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 0</span><span class="token comment" spellcheck="true">// 255</span><span class="token comment" spellcheck="true">// 遍历 Map:</span><span class="token comment" spellcheck="true">// Map 对象就是简单的键 / 值映射。其中键和值可以是任意值 (对象或者原始值)，键值不能重复</span><span class="token keyword">let</span> iterable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> entry <span class="token keyword">of</span> iterable<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// [a, 1]</span><span class="token comment" spellcheck="true">// [b, 2]</span><span class="token comment" spellcheck="true">// [c, 3]</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> iterable<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 1</span><span class="token comment" spellcheck="true">// 2</span><span class="token comment" spellcheck="true">// 3</span><span class="token comment" spellcheck="true">// 遍历 Set:</span><span class="token comment" spellcheck="true">// 集合（Set）对象允许你存储任意类型的唯一值（不能重复），无论它是原始值或者是对象引用</span><span class="token keyword">let</span> iterable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> value <span class="token keyword">of</span> iterable<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 1</span><span class="token comment" spellcheck="true">// 2</span><span class="token comment" spellcheck="true">// 3</span><span class="token comment" spellcheck="true">// 遍历 DOM 集合...</span><span class="token comment" spellcheck="true">// 遍历生成器...</span><span class="token comment" spellcheck="true">// 遍历另外的可遍历对象:</span><span class="token comment" spellcheck="true">// 您也可以遍历一个已经明确的可遍历（可迭代）协议。</span><span class="token comment" spellcheck="true">// ES6 语法中 Symbol 是一种特殊的、不可变的数据类型，可以作为对象属性的标识符使用。Symbol 对象是一个 symbol primitive data type 的隐式对象包装器。</span><span class="token keyword">var</span> iterable <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      i<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>i<span class="token operator">++</span><span class="token punctuation">,</span> done<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span> done<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> value <span class="token keyword">of</span> iterable<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 0</span><span class="token comment" spellcheck="true">// 1</span><span class="token comment" spellcheck="true">// 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="for…of-与-for…in-的区别"><a href="#for…of-与-for…in-的区别" class="headerlink" title="for…of 与 for…in 的区别"></a>for…of 与 for…in 的区别</h3><ul><li>for…in 循环会遍历一个 object 所有的可枚举属性。</li><li>for…of 语法是为各种 collection 对象专门定制的，并不适用于所有的 object. 它会以这种方式迭代出任何拥有 [Symbol.iterator] 属性的 collection 对象的每个元素。</li></ul><p>下面的例子演示了 for…of 循环和 for…in 循环的区别。for…in 遍历（当前对象及其原型上的）每一个属性名称, 而 for…of 遍历（当前对象上的）每一个属性值:</p><pre class="line-numbers language-javascript"><code class="language-javascript">Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>objCustom <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>arrCustom <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">let</span> iterable <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>iterable<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">in</span> iterable<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// logs 0, 1, 2, "foo", "arrCustom", "objCustom"</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">of</span> iterable<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// logs 3, 5, 7</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="三、数组"><a href="#三、数组" class="headerlink" title="三、数组"></a>三、数组</h2><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank" rel="noopener">Array 对象 -MDN</a></p><h3 id="遍历数组："><a href="#遍历数组：" class="headerlink" title="遍历数组："></a>遍历数组：</h3><p><strong>普通方法遍历</strong></p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// for 循环</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> myArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myArray<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// for-of 循环</span><span class="token comment" spellcheck="true">// 与 forEach() 不同的是，它可以正确响应 break、continue 和 return 语句</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> value <span class="token keyword">of</span> myArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>forEach 遍历</strong></p><pre class="line-numbers language-javascript"><code class="language-javascript">对数组的遍历，参数是一个回调函数<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token string">'.'</span><span class="token operator">+</span>x<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//x：数组中遍历到的每一个元素，i：相对应的下标</span><span class="token comment" spellcheck="true">// 0.a</span><span class="token comment" spellcheck="true">// 1.b</span><span class="token comment" spellcheck="true">// 2.c</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>map 遍历</strong></p><p>对数组的遍历，参数是一个回调函数，与 forEach 不同的是，map 函数返回一个数组</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> i <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> x<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//x：数组中遍历到的每一个元素，i：相对应的下标</span><span class="token comment" spellcheck="true">// [ '0.a', '1.b', '2.c' ]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>every 遍历</strong></p><p>检查数组里的每一个元素的类型，参数是一个回调函数</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span>  <span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//x：数组中遍历到的每一个元素</span>  <span class="token punctuation">[</span>    <span class="token comment" spellcheck="true">// true</span>    <span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="四、浮点型"><a href="#四、浮点型" class="headerlink" title="四、浮点型"></a>四、浮点型</h2><p>IEEE 754<br>JavaScript 中的浮点数采用 IEEE-754 格式的规定。更具体的说是一个双精度格式，这意味着每个浮点数占 64 位。虽然它不是二进制表示浮点数的唯一途径，但它是目前最广泛使用的格式。该格式用 64 位二进制表示像下面这样：<br><img src="http://yanhaijing.com/blog/75.png" alt="image"><br>你可能注意到机器表示的方法和约定俗成的书面表示一点不同。在 64 位中，1 位用于标志位——用来表示一个数是正数还是负数。11 位用于指数–这允许指数最大到 1024。剩下的 52 位代表的尾数。如果你曾经好奇为什么 JavaScript 中的某些东西如 +0 和 -0，标志位说明一切——JavaScript 中的所有数字都有符号位。Infinity 和 NaN 也被编码进浮点数——2047 作为一个特殊的指数。如果尾数是 0，它是一个正无穷或负无限。如果不是，那么它是 NaN。</p><p><a href="https://www.cnblogs.com/snandy/p/4943138.html" target="_blank" rel="noopener">JS 数字精度丢失的一些典型问题</a></p><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案:"></a>解决方案:</h3><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">/** * floatTool 包含加减乘除四个方法，能确保浮点数运算不丢失精度 * * 我们知道计算机编程语言里浮点数计算会存在精度丢失问题（或称舍入误差），其根本原因是二进制和实现位数限制有些数无法有限表示 * 以下是十进制小数对应的二进制表示 *      0.1 >> 0.0001 1001 1001 1001…（1001 无限循环） *      0.2 >> 0.0011 0011 0011 0011…（0011 无限循环） * 计算机里每种数据类型的存储是一个有限宽度，比如 JavaScript 使用 64 位存储数字类型，因此超出的会舍去。舍去的部分就是精度丢失的部分。 * * ** method ** *  add / subtract / multiply /divide * * ** explame ** *  0.1 + 0.2 == 0.30000000000000004 （多了 0.00000000000004） *  0.2 + 0.4 == 0.6000000000000001  （多了 0.0000000000001） *  19.9 * 100 == 1989.9999999999998 （少了 0.0000000000002） * * floatObj.add(0.1, 0.2) >> 0.3 * floatObj.multiply(19.9, 100) >> 1990 * */</span><span class="token keyword">var</span> floatTool <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/*     * 判断 obj 是否为一个整数     */</span>  <span class="token keyword">function</span> <span class="token function">isInteger</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> obj<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/*     * 将一个浮点数转成整数，返回整数和倍数。如 3.14 >> 314，倍数是 100     * @param floatNum {number} 小数     * @return {object}     *   {times:100, num: 314}     */</span>  <span class="token keyword">function</span> <span class="token function">toInteger</span><span class="token punctuation">(</span>floatNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> ret <span class="token operator">=</span> <span class="token punctuation">{</span> times<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> num<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInteger</span><span class="token punctuation">(</span>floatNum<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      ret<span class="token punctuation">.</span>num <span class="token operator">=</span> floatNum<span class="token punctuation">;</span>      <span class="token keyword">return</span> ret<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> strfi <span class="token operator">=</span> floatNum <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> dotPos <span class="token operator">=</span> strfi<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> len <span class="token operator">=</span> strfi<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>dotPos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">var</span> times <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> intNum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>floatNum <span class="token operator">*</span> times <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ret<span class="token punctuation">.</span>times <span class="token operator">=</span> times<span class="token punctuation">;</span>    ret<span class="token punctuation">.</span>num <span class="token operator">=</span> intNum<span class="token punctuation">;</span>    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/*     * 核心方法，实现加减乘除运算，确保不丢失精度     * 思路：把小数放大为整数（乘），进行算术运算，再缩小为小数（除）     *     * @param a {number} 运算数 1     * @param b {number} 运算数 2     * @param digits {number} 精度，保留的小数点数，比如 2, 即保留为两位小数     * @param op {string} 运算类型，有加减乘除（add/subtract/multiply/divide）     *     */</span>  <span class="token keyword">function</span> <span class="token function">operation</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> op<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> o1 <span class="token operator">=</span> <span class="token function">toInteger</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> o2 <span class="token operator">=</span> <span class="token function">toInteger</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> n1 <span class="token operator">=</span> o1<span class="token punctuation">.</span>num<span class="token punctuation">;</span>    <span class="token keyword">var</span> n2 <span class="token operator">=</span> o2<span class="token punctuation">.</span>num<span class="token punctuation">;</span>    <span class="token keyword">var</span> t1 <span class="token operator">=</span> o1<span class="token punctuation">.</span>times<span class="token punctuation">;</span>    <span class="token keyword">var</span> t2 <span class="token operator">=</span> o2<span class="token punctuation">.</span>times<span class="token punctuation">;</span>    <span class="token keyword">var</span> max <span class="token operator">=</span> t1 <span class="token operator">></span> t2 <span class="token operator">?</span> t1 <span class="token punctuation">:</span> t2<span class="token punctuation">;</span>    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">case</span> <span class="token string">'add'</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>t1 <span class="token operator">===</span> t2<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// 两个小数位数相同</span>          result <span class="token operator">=</span> n1 <span class="token operator">+</span> n2<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t1 <span class="token operator">></span> t2<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// o1 小数位 大于 o2</span>          result <span class="token operator">=</span> n1 <span class="token operator">+</span> n2 <span class="token operator">*</span> <span class="token punctuation">(</span>t1 <span class="token operator">/</span> t2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// o1 小数位 小于 o2</span>          result <span class="token operator">=</span> n1 <span class="token operator">*</span> <span class="token punctuation">(</span>t2 <span class="token operator">/</span> t1<span class="token punctuation">)</span> <span class="token operator">+</span> n2<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> result <span class="token operator">/</span> max<span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token string">'subtract'</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>t1 <span class="token operator">===</span> t2<span class="token punctuation">)</span> <span class="token punctuation">{</span>          result <span class="token operator">=</span> n1 <span class="token operator">-</span> n2<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t1 <span class="token operator">></span> t2<span class="token punctuation">)</span> <span class="token punctuation">{</span>          result <span class="token operator">=</span> n1 <span class="token operator">-</span> n2 <span class="token operator">*</span> <span class="token punctuation">(</span>t1 <span class="token operator">/</span> t2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          result <span class="token operator">=</span> n1 <span class="token operator">*</span> <span class="token punctuation">(</span>t2 <span class="token operator">/</span> t1<span class="token punctuation">)</span> <span class="token operator">-</span> n2<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> result <span class="token operator">/</span> max<span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token string">'multiply'</span><span class="token punctuation">:</span>        result <span class="token operator">=</span> <span class="token punctuation">(</span>n1 <span class="token operator">*</span> n2<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>t1 <span class="token operator">*</span> t2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token string">'divide'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">var</span> r1 <span class="token operator">=</span> n1 <span class="token operator">/</span> n2<span class="token punctuation">;</span>          <span class="token keyword">var</span> r2 <span class="token operator">=</span> t2 <span class="token operator">/</span> t1<span class="token punctuation">;</span>          <span class="token keyword">return</span> <span class="token function">operation</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> <span class="token string">'multiply'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 加减乘除的四个接口</span>  <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">operation</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token string">'add'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">subtract</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">operation</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token string">'subtract'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">multiply</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">operation</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token string">'multiply'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">operation</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token string">'divide'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// exports</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    add<span class="token punctuation">:</span> add<span class="token punctuation">,</span>    subtract<span class="token punctuation">:</span> subtract<span class="token punctuation">,</span>    multiply<span class="token punctuation">:</span> multiply<span class="token punctuation">,</span>    divide<span class="token punctuation">:</span> divide  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      <categories>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaScript </tag>
            
        </tags>
      
    </entry>
    
  
  
</search>
